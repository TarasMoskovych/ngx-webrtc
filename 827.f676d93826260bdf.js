(self.webpackChunkngx_webrtc=self.webpackChunkngx_webrtc||[]).push([[827],{827:function(is,Fl,Bl){var y=Bl(293).default;is.exports=function(){"use strict";var cr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Wt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var te=function(t){try{return!!t()}catch{return!0}},fi=!te(function(){var t=function(){}.bind();return"function"!=typeof t||t.hasOwnProperty("prototype")}),ki=fi,Mi=Function.prototype,Kr=Mi.call,jl=ki&&Mi.bind.bind(Kr,Kr),Te=ki?jl:function(t){return function(){return Kr.apply(t,arguments)}},on=Te({}.isPrototypeOf),td=function(t){return t&&t.Math==Math&&t},Ae=td("object"==typeof globalThis&&globalThis)||td("object"==typeof window&&window)||td("object"==typeof self&&self)||td("object"==typeof cr&&cr)||function(){return this}()||cr||Function("return this")(),hf=Function.prototype,_f=hf.apply,Ef=hf.call,ed="object"==typeof Reflect&&Reflect.apply||(fi?Ef.bind(_f):function(){return Ef.apply(_f,arguments)}),mf=Te,_N=mf({}.toString),EN=mf("".slice),Yr=function(t){return EN(_N(t),8,-1)},mN=Yr,fN=Te,ba=function(t){if("Function"===mN(t))return fN(t)},Gl="object"==typeof document&&document.all,nd={all:Gl,IS_HTMLDDA:void 0===Gl&&void 0!==Gl},gN=nd.all,Le=nd.IS_HTMLDDA?function(t){return"function"==typeof t||t===gN}:function(t){return"function"==typeof t},Oa={},Yn=!te(function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]}),rd=Function.prototype.call,Be=fi?rd.bind(rd):function(){return rd.apply(rd,arguments)},id={},ff={}.propertyIsEnumerable,gf=Object.getOwnPropertyDescriptor,SN=gf&&!ff.call({1:2},1);id.f=SN?function(t){var e=gf(this,t);return!!e&&e.enumerable}:ff;var Ui,od,xi=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},RN=te,vN=Yr,Wl=Object,yN=Te("".split),sd=RN(function(){return!Wl("z").propertyIsEnumerable(0)})?function(t){return"String"==vN(t)?yN(t,""):Wl(t)}:Wl,ss=function(t){return null==t},CN=ss,IN=TypeError,as=function(t){if(CN(t))throw IN("Can't call method on "+t);return t},AN=sd,bN=as,Vi=function(t){return AN(bN(t))},Tf=Le,ON=nd.all,Ln=nd.IS_HTMLDDA?function(t){return"object"==typeof t?null!==t:Tf(t)||t===ON}:function(t){return"object"==typeof t?null!==t:Tf(t)},qn={},Hl=qn,Kl=Ae,wN=Le,Sf=function(t){return wN(t)?t:void 0},Cn=function(t,e){return arguments.length<2?Sf(Hl[t])||Sf(Kl[t]):Hl[t]&&Hl[t][e]||Kl[t]&&Kl[t][e]},Fi=typeof navigator<"u"&&String(navigator.userAgent)||"",Yl=Fi,vf=Ae.process,yf=Ae.Deno,Cf=vf&&vf.versions||yf&&yf.version,If=Cf&&Cf.v8;If&&(od=(Ui=If.split("."))[0]>0&&Ui[0]<4?1:+(Ui[0]+Ui[1])),!od&&Yl&&(!(Ui=Yl.match(/Edge\/(\d+)/))||Ui[1]>=74)&&(Ui=Yl.match(/Chrome\/(\d+)/))&&(od=+Ui[1]);var Ro=od,Af=Ro,DN=Ae.String,cs=!!Object.getOwnPropertySymbols&&!te(function(){var t=Symbol();return!DN(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&Af&&Af<41}),bf=cs&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,PN=Cn,LN=Le,kN=on,MN=Object,wa=bf?function(t){return"symbol"==typeof t}:function(t){var e=PN("Symbol");return LN(e)&&kN(e.prototype,MN(t))},UN=String,ds=function(t){try{return UN(t)}catch{return"Object"}},xN=Le,VN=ds,FN=TypeError,zn=function(t){if(xN(t))return t;throw FN(VN(t)+" is not a function")},BN=zn,jN=ss,ad=function(t,e){var n=t[e];return jN(n)?void 0:BN(n)},ql=Be,zl=Le,Jl=Ln,GN=TypeError,Of={exports:{}},wf=Ae,WN=Object.defineProperty,Nf="__core-js_shared__",Xl=Ae[Nf]||function(t,e){try{WN(wf,t,{value:e,configurable:!0,writable:!0})}catch{wf[t]=e}return e}(Nf,{}),Df=Xl;(Of.exports=function(t,e){return Df[t]||(Df[t]=void 0!==e?e:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"\xa9 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var us=Of.exports,KN=as,YN=Object,qr=function(t){return YN(KN(t))},qN=qr,zN=Te({}.hasOwnProperty),ze=Object.hasOwn||function(t,e){return zN(qN(t),e)},JN=Te,XN=0,QN=Math.random(),ZN=JN(1..toString),Ql=function(t){return"Symbol("+(void 0===t?"":t)+")_"+ZN(++XN+QN,36)},Pf=ze,tD=Ql,eD=cs,nD=bf,ls=Ae.Symbol,Zl=us("wks"),rD=nD?ls.for||ls:ls&&ls.withoutSetter||tD,he=function(t){return Pf(Zl,t)||(Zl[t]=eD&&Pf(ls,t)?ls[t]:rD("Symbol."+t)),Zl[t]},iD=Be,Lf=Ln,kf=wa,oD=ad,aD=TypeError,cD=he("toPrimitive"),dD=function(t,e){if(!Lf(t)||kf(t))return t;var n,r=oD(t,cD);if(r){if(void 0===e&&(e="default"),n=iD(r,t,e),!Lf(n)||kf(n))return n;throw aD("Can't convert object to primitive value")}return void 0===e&&(e="number"),function(t,e){var n,r;if("string"===e&&zl(n=t.toString)&&!Jl(r=ql(n,t))||zl(n=t.valueOf)&&!Jl(r=ql(n,t))||"string"!==e&&zl(n=t.toString)&&!Jl(r=ql(n,t)))return r;throw GN("Can't convert object to primitive value")}(t,e)},uD=wa,cd=function(t){var e=dD(t,"string");return uD(e)?e:e+""},Mf=Ln,$l=Ae.document,lD=Mf($l)&&Mf($l.createElement),tp=function(t){return lD?$l.createElement(t):{}},pD=tp,Uf=!Yn&&!te(function(){return 7!=Object.defineProperty(pD("div"),"a",{get:function(){return 7}}).a}),_D=Be,ED=id,mD=xi,fD=Vi,gD=cd,TD=ze,SD=Uf,xf=Object.getOwnPropertyDescriptor;Oa.f=Yn?xf:function(t,e){if(t=fD(t),e=gD(e),SD)try{return xf(t,e)}catch{}if(TD(t,e))return mD(!_D(ED.f,t,e),t[e])};var RD=te,vD=Le,yD=/#|\.prototype\./,Na=function(t,e){var n=ID[CD(t)];return n==bD||n!=AD&&(vD(e)?RD(e):!!e)},CD=Na.normalize=function(t){return String(t).replace(yD,".").toLowerCase()},ID=Na.data={},AD=Na.NATIVE="N",bD=Na.POLYFILL="P",Vf=Na,OD=zn,wD=fi,ND=ba(ba.bind),Bi=function(t,e){return OD(t),void 0===e?t:wD?ND(t,e):function(){return t.apply(e,arguments)}},dr={},Ff=Yn&&te(function(){return 42!=Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype}),DD=Ln,PD=String,LD=TypeError,fn=function(t){if(DD(t))return t;throw LD(PD(t)+" is not an object")},MD=Uf,dd=fn,Bf=cd,xD=TypeError,ep=Object.defineProperty,VD=Object.getOwnPropertyDescriptor,np="enumerable",rp="configurable",ip="writable";dr.f=Yn?Ff?function(t,e,n){if(dd(t),e=Bf(e),dd(n),"function"==typeof t&&"prototype"===e&&"value"in n&&ip in n&&!n[ip]){var r=VD(t,e);r&&r[ip]&&(t[e]=n.value,n={configurable:rp in n?n[rp]:r[rp],enumerable:np in n?n[np]:r[np],writable:!1})}return ep(t,e,n)}:ep:function(t,e,n){if(dd(t),e=Bf(e),dd(n),MD)try{return ep(t,e,n)}catch{}if("get"in n||"set"in n)throw xD("Accessors not supported");return"value"in n&&(t[e]=n.value),t};var FD=dr,BD=xi,ji=Yn?function(t,e,n){return FD.f(t,e,BD(1,n))}:function(t,e,n){return t[e]=n,t},ud=Ae,jD=ed,GD=ba,WD=Le,HD=Oa.f,KD=Vf,ps=qn,YD=Bi,hs=ji,jf=ze,qD=function(t){var e=function(n,r,i){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,i)}return jD(t,this,arguments)};return e.prototype=t.prototype,e},Lt=function(t,e){var n,r,i,o,s,a,c,d,u,l=t.target,p=t.global,h=t.stat,S=t.proto,m=p?ud:h?ud[l]:(ud[l]||{}).prototype,f=p?ps:ps[l]||hs(ps,l,{})[l],g=f.prototype;for(o in e)r=!(n=KD(p?o:l+(h?".":"#")+o,t.forced))&&m&&jf(m,o),a=f[o],r&&(c=t.dontCallGetSet?(u=HD(m,o))&&u.value:m[o]),s=r&&c?c:e[o],r&&typeof a==typeof s||(d=t.bind&&r?YD(s,ud):t.wrap&&r?qD(s):S&&WD(s)?GD(s):s,(t.sham||s&&s.sham||a&&a.sham)&&hs(d,"sham",!0),hs(f,o,d),S&&(jf(ps,i=l+"Prototype")||hs(ps,i,{}),hs(ps[i],o,s),t.real&&g&&(n||!g[o])&&hs(g,o,s)))},zD=Math.ceil,JD=Math.floor,QD=Math.trunc||function(t){var e=+t;return(e>0?JD:zD)(e)},op=function(t){var e=+t;return e!=e||0===e?0:QD(e)},ZD=op,$D=Math.max,tP=Math.min,sp=function(t,e){var n=ZD(t);return n<0?$D(n+e,0):tP(n,e)},eP=op,nP=Math.min,Gf=function(t){return t>0?nP(eP(t),9007199254740991):0},rP=Gf,gi=function(t){return rP(t.length)},iP=Vi,oP=sp,sP=gi,Wf=function(t){return function(e,n,r){var i,o=iP(e),s=sP(o),a=oP(r,s);if(t&&n!=n){for(;s>a;)if((i=o[a++])!=i)return!0}else for(;s>a;a++)if((t||a in o)&&o[a]===n)return t||a||0;return!t&&-1}},ap={includes:Wf(!0),indexOf:Wf(!1)},aP=ap.includes;Lt({target:"Array",proto:!0,forced:te(function(){return!Array(1).includes()})},{includes:function(t){return aP(this,t,arguments.length>1?arguments[1]:void 0)}});var cP=qn,ur=function(t){return cP[t+"Prototype"]},dP=ur("Array").includes,uP=Ln,lP=Yr,pP=he("match"),Hf=function(t){var e;return uP(t)&&(void 0!==(e=t[pP])?!!e:"RegExp"==lP(t))},hP=Hf,_P=TypeError,Kf={};Kf[he("toStringTag")]="z";var cp="[object z]"===String(Kf),EP=cp,mP=Le,ld=Yr,fP=he("toStringTag"),gP=Object,TP="Arguments"==ld(function(){return arguments}()),zr=EP?ld:function(t){var e,n,r;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(n=function(i,o){try{return i[o]}catch{}}(e=gP(t),fP))?n:TP?ld(e):"Object"==(r=ld(e))&&mP(e.callee)?"Arguments":r},SP=zr,RP=String,Jn=function(t){if("Symbol"===SP(t))throw TypeError("Cannot convert a Symbol value to a string");return RP(t)},vP=he("match"),yP=Lt,IP=as,Yf=Jn,bP=Te("".indexOf);yP({target:"String",proto:!0,forced:!function(t){var e=/./;try{"/./"[t](e)}catch{try{return e[vP]=!1,"/./"[t](e)}catch{}}return!1}("includes")},{includes:function(t){return!!~bP(Yf(IP(this)),Yf(function(t){if(hP(t))throw _P("The method doesn't accept regular expressions");return t}(t)),arguments.length>1?arguments[1]:void 0)}});var OP=ur("String").includes,qf=on,wP=dP,NP=OP,dp=Array.prototype,up=String.prototype,W=Wt(function(t){var e=t.includes;return t===dp||qf(dp,t)&&e===dp.includes?wP:"string"==typeof t||t===up||qf(up,t)&&e===up.includes?NP:e}),PP=zn,LP=qr,kP=sd,MP=gi,UP=TypeError,zf=function(t){return function(e,n,r,i){PP(n);var o=LP(e),s=kP(o),a=MP(o),c=t?a-1:0,d=t?-1:1;if(r<2)for(;;){if(c in s){i=s[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw UP("Reduce of empty array with no initial value")}for(;t?c>=0:a>c;c+=d)c in s&&(i=n(i,s[c],c,o));return i}},xP={left:zf(!1),right:zf(!0)},VP=te,pd=function(t,e){var n=[][t];return!!n&&VP(function(){n.call(null,e||function(){return 1},1)})},_s=typeof process<"u"&&"process"==Yr(process),FP=xP.left;Lt({target:"Array",proto:!0,forced:!_s&&Ro>79&&Ro<83||!pd("reduce")},{reduce:function(t){var e=arguments.length;return FP(this,t,e,e>1?arguments[1]:void 0)}});var BP=ur("Array").reduce,jP=on,GP=BP,lp=Array.prototype,Jf=function(t){var e=t.reduce;return t===lp||jP(lp,t)&&e===lp.reduce?GP:e},Nr=Wt(Jf);let Xf=!0,Qf=!0;function hd(t,e,n){const r=t.match(e);return r&&r.length>=n&&parseInt(r[n],10)}function vo(t,e,n){if(!t.RTCPeerConnection)return;const r=t.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(s,a){if(s!==e)return i.apply(this,arguments);const c=d=>{const u=n(d);u&&(a.handleEvent?a.handleEvent(u):a(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),i.apply(this,[s,c])};const o=r.removeEventListener;r.removeEventListener=function(s,a){if(s!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(a))return o.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),0===this._eventMap[e].size&&delete this._eventMap[e],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[s,c])},Object.defineProperty(r,"on"+e,{get(){return this["_on"+e]},set(s){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),s&&this.addEventListener(e,this["_on"+e]=s)},enumerable:!0,configurable:!0})}function HP(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(Xf=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function KP(t){return"boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(Qf=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function Zf(){if("object"==typeof window){if(Xf)return;typeof console<"u"&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function pp(t,e){Qf&&console.warn(t+" is deprecated, please use "+e+" instead.")}function $f(t){return"[object Object]"===Object.prototype.toString.call(t)}function tg(t){var e;return $f(t)?Nr(e=Object.keys(t)).call(e,function(n,r){const i=$f(t[r]),o=i?tg(t[r]):t[r],s=i&&!Object.keys(o).length;return void 0===o||s?n:Object.assign(n,{[r]:o})},{}):t}function hp(t,e,n){e&&!n.has(e.id)&&(n.set(e.id,e),Object.keys(e).forEach(r=>{r.endsWith("Id")?hp(t,t.get(e[r]),n):r.endsWith("Ids")&&e[r].forEach(i=>{hp(t,t.get(i),n)})}))}function eg(t,e,n){const r=n?"outbound-rtp":"inbound-rtp",i=new Map;if(null===e)return i;const o=[];return t.forEach(s=>{"track"===s.type&&s.trackIdentifier===e.id&&o.push(s)}),o.forEach(s=>{t.forEach(a=>{a.type===r&&a.trackId===s.id&&hp(t,a,i)})}),i}var YP=Ql,ng=us("keys"),_d=function(t){return ng[t]||(ng[t]=YP(t))},qP=!te(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),zP=ze,JP=Le,XP=qr,QP=qP,rg=_d("IE_PROTO"),_p=Object,ZP=_p.prototype,Ep=QP?_p.getPrototypeOf:function(t){var e=XP(t);if(zP(e,rg))return e[rg];var n=e.constructor;return JP(n)&&e instanceof n?n.prototype:e instanceof _p?ZP:null},$P=Te,tL=zn,eL=Le,nL=String,rL=TypeError,oL=fn,aL=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,n={};try{(t=function(t,e,n){try{return $P(tL(Object.getOwnPropertyDescriptor(t,e)[n]))}catch{}}(Object.prototype,"__proto__","set"))(n,[]),e=n instanceof Array}catch{}return function(r,i){return oL(r),function(t){if("object"==typeof t||eL(t))return t;throw rL("Can't set "+nL(t)+" as a prototype")}(i),e?t(r,i):r.__proto__=i,r}}():void 0),Ed={},md={},mp=ze,cL=Vi,dL=ap.indexOf,uL=md,ig=Te([].push),og=function(t,e){var n,r=cL(t),i=0,o=[];for(n in r)!mp(uL,n)&&mp(r,n)&&ig(o,n);for(;e.length>i;)mp(r,n=e[i++])&&(~dL(o,n)||ig(o,n));return o},fp=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],lL=og,pL=fp.concat("length","prototype");Ed.f=Object.getOwnPropertyNames||function(t){return lL(t,pL)};var Da={};Da.f=Object.getOwnPropertySymbols;var hL=Cn,_L=Ed,EL=Da,mL=fn,fL=Te([].concat),gL=hL("Reflect","ownKeys")||function(t){var e=_L.f(mL(t)),n=EL.f;return n?fL(e,n(t)):e},sg=ze,TL=gL,SL=Oa,RL=dr,gp={},vL=og,yL=fp,fd=Object.keys||function(t){return vL(t,yL)},AL=dr,bL=fn,OL=Vi,wL=fd;gp.f=Yn&&!Ff?Object.defineProperties:function(t,e){bL(t);for(var n,r=OL(e),i=wL(e),o=i.length,s=0;o>s;)AL.f(t,n=i[s++],r[n]);return t};var gd,ag=Cn("document","documentElement"),NL=fn,DL=gp,cg=fp,PL=md,LL=ag,kL=tp,Tp="prototype",Sp="script",dg=_d("IE_PROTO"),Rp=function(){},ug=function(t){return"<script>"+t+"</"+Sp+">"},lg=function(t){t.write(ug("")),t.close();var e=t.parentWindow.Object;return t=null,e},Td=function(){try{gd=new ActiveXObject("htmlfile")}catch{}var t,e;Td=typeof document<"u"?document.domain&&gd?lg(gd):((e=kL("iframe")).style.display="none",LL.appendChild(e),e.src=String("javascript:"),(t=e.contentWindow.document).open(),t.write(ug("document.F=Object")),t.close(),t.F):lg(gd);for(var r=cg.length;r--;)delete Td[Tp][cg[r]];return Td()};PL[dg]=!0;var Pa=Object.create||function(t,e){var n;return null!==t?(Rp[Tp]=NL(t),n=new Rp,Rp[Tp]=null,n[dg]=t):n=Td(),void 0===e?n:DL.f(n,e)},ML=Ln,UL=ji,pg=Error,xL=Te("".replace),VL=String(pg("zxcasd").stack),hg=/\n\s*at [^:]*:[^\n]*/,FL=hg.test(VL),BL=xi,jL=!te(function(){var t=Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",BL(1,7)),7!==t.stack)}),GL=ji,HL=jL,_g=Error.captureStackTrace,yo={},KL=yo,YL=he("iterator"),qL=Array.prototype,Eg=function(t){return void 0!==t&&(KL.Array===t||qL[YL]===t)},zL=zr,mg=ad,JL=ss,XL=yo,QL=he("iterator"),Sd=function(t){if(!JL(t))return mg(t,QL)||mg(t,"@@iterator")||XL[zL(t)]},ZL=Be,$L=zn,tk=fn,ek=ds,nk=Sd,rk=TypeError,vp=function(t,e){var n=arguments.length<2?nk(t):e;if($L(n))return tk(ZL(n,t));throw rk(ek(t)+" is not iterable")},ik=Be,fg=fn,ok=ad,gg=function(t,e,n){var r,i;fg(t);try{if(!(r=ok(t,"return"))){if("throw"===e)throw n;return n}r=ik(r,t)}catch(o){i=!0,r=o}if("throw"===e)throw n;if(i)throw r;return fg(r),n},sk=Bi,ak=Be,ck=fn,dk=ds,uk=Eg,lk=gi,Tg=on,pk=vp,hk=Sd,Sg=gg,_k=TypeError,Rd=function(t,e){this.stopped=t,this.result=e},Rg=Rd.prototype,La=function(t,e,n){var r,i,o,s,a,c,d,l=!(!n||!n.AS_ENTRIES),p=!(!n||!n.IS_RECORD),h=!(!n||!n.IS_ITERATOR),S=!(!n||!n.INTERRUPTED),m=sk(e,n&&n.that),f=function(R){return r&&Sg(r,"normal",R),new Rd(!0,R)},g=function(R){return l?(ck(R),S?m(R[0],R[1],f):m(R[0],R[1])):S?m(R,f):m(R)};if(p)r=t.iterator;else if(h)r=t;else{if(!(i=hk(t)))throw _k(dk(t)+" is not iterable");if(uk(i)){for(o=0,s=lk(t);s>o;o++)if((a=g(t[o]))&&Tg(Rg,a))return a;return new Rd(!1)}r=pk(t,i)}for(c=p?t.next:r.next;!(d=ak(c,r)).done;){try{a=g(d.value)}catch(R){Sg(r,"throw",R)}if("object"==typeof a&&a&&Tg(Rg,a))return a}return new Rd(!1)},Ek=Jn,mk=Lt,fk=on,gk=Ep,vd=aL,vg=Pa,yp=ji,Cp=xi,Rk=function(t,e,n,r){HL&&(_g?_g(t,e):GL(t,"stack",function(t,e){if(FL&&"string"==typeof t&&!pg.prepareStackTrace)for(;e--;)t=xL(t,hg,"");return t}(n,r)))},vk=La,Ck=he("toStringTag"),yd=Error,Ik=[].push,Es=function(t,e){var n,r=fk(Ip,this);vd?n=vd(yd(),r?gk(this):Ip):(n=r?this:vg(Ip),yp(n,Ck,"Error")),void 0!==e&&yp(n,"message",function(t,e){return void 0===t?arguments.length<2?"":e:Ek(t)}(e)),Rk(n,Es,n.stack,1),arguments.length>2&&function(t,e){ML(e)&&"cause"in e&&UL(t,"cause",e.cause)}(n,arguments[2]);var i=[];return vk(t,Ik,{that:i}),yp(n,"errors",i),n};vd?vd(Es,yd):function(t,e,n){for(var r=TL(e),i=RL.f,o=SL.f,s=0;s<r.length;s++){var a=r[s];sg(t,a)||n&&sg(n,a)||i(t,a,o(e,a))}}(Es,yd,{name:!0});var Ip=Es.prototype=vg(yd.prototype,{constructor:Cp(1,Es),message:Cp(1,""),name:Cp(1,"AggregateError")});mk({global:!0,constructor:!0,arity:2},{AggregateError:Es});var Cd,ka,Id,yg=Ae.WeakMap,bk=Le(yg)&&/native code/.test(String(yg)),Ok=Ln,wk=ji,Ap=ze,Nk=_d,Dk=md,Ig="Object already initialized",Op=Ae.TypeError;if(bk||Xl.state){var Jr=Xl.state||(Xl.state=new(0,Ae.WeakMap));Jr.get=Jr.get,Jr.has=Jr.has,Jr.set=Jr.set,Cd=function(t,e){if(Jr.has(t))throw Op(Ig);return e.facade=t,Jr.set(t,e),e},ka=function(t){return Jr.get(t)||{}},Id=function(t){return Jr.has(t)}}else{var ms=Nk("state");Dk[ms]=!0,Cd=function(t,e){if(Ap(t,ms))throw Op(Ig);return e.facade=t,wk(t,ms,e),e},ka=function(t){return Ap(t,ms)?t[ms]:{}},Id=function(t){return Ap(t,ms)}}var Co,Ag,bg,Io={set:Cd,get:ka,has:Id,enforce:function(t){return Id(t)?ka(t):Cd(t,{})},getterFor:function(t){return function(e){var n;if(!Ok(e)||(n=ka(e)).type!==t)throw Op("Incompatible receiver, "+t+" required");return n}}},wp=Yn,Og=Function.prototype,kk=wp&&Object.getOwnPropertyDescriptor,Np=ze(Og,"name"),wg={EXISTS:Np,PROPER:Np&&"something"===function(){}.name,CONFIGURABLE:Np&&(!wp||wp&&kk(Og,"name").configurable)},Mk=ji,Gi=function(t,e,n,r){return r&&r.enumerable?t[e]=n:Mk(t,e,n),t},Uk=te,xk=Le,Vk=Ln,Fk=Pa,Ng=Ep,Bk=Gi,Dp=he("iterator"),Dg=!1;[].keys&&("next"in(bg=[].keys())?(Ag=Ng(Ng(bg)))!==Object.prototype&&(Co=Ag):Dg=!0);var jk=!Vk(Co)||Uk(function(){var t={};return Co[Dp].call(t)!==t});xk((Co=jk?{}:Fk(Co))[Dp])||Bk(Co,Dp,function(){return this});var Pg={IteratorPrototype:Co,BUGGY_SAFARI_ITERATORS:Dg},Gk=zr,Hk=cp,Kk=dr.f,Yk=ji,qk=ze,zk=cp?{}.toString:function(){return"[object "+Gk(this)+"]"},Lg=he("toStringTag"),Wi=function(t,e,n,r){if(t){var i=n?t:t.prototype;qk(i,Lg)||Kk(i,Lg,{configurable:!0,value:e}),r&&!Hk&&Yk(i,"toString",zk)}},Jk=Pg.IteratorPrototype,Xk=Pa,Qk=xi,Zk=Wi,$k=yo,t1=function(){return this},Pp=function(t,e,n,r){var i=e+" Iterator";return t.prototype=Xk(Jk,{next:Qk(+!r,n)}),Zk(t,i,!1,!0),$k[i]=t1,t},e1=Lt,n1=Be,i1=Pp,o1=Ep,s1=Wi,kg=Gi,Mg=yo,c1=wg.PROPER,Ad=Pg.BUGGY_SAFARI_ITERATORS,Lp=he("iterator"),bd="values",xg="entries",d1=function(){return this},Vg=function(t,e,n,r,i,o,s){i1(n,e,r);var a,c,d,u=function(g){if(g===i&&m)return m;if(!Ad&&g in h)return h[g];switch(g){case"keys":case bd:case xg:return function(){return new n(this,g)}}return function(){return new n(this)}},l=e+" Iterator",p=!1,h=t.prototype,S=h[Lp]||h["@@iterator"]||i&&h[i],m=!Ad&&S||u(i),f="Array"==e&&h.entries||S;if(f&&(a=o1(f.call(new t)))!==Object.prototype&&a.next&&(s1(a,l,!0,!0),Mg[l]=d1),c1&&i==bd&&S&&S.name!==bd&&(p=!0,m=function(){return n1(S,this)}),i)if(c={values:u(bd),keys:o?m:u("keys"),entries:u(xg)},s)for(d in c)(Ad||p||!(d in h))&&kg(h,d,c[d]);else e1({target:e,proto:!0,forced:Ad||p},c);return s&&h[Lp]!==m&&kg(h,Lp,m,{name:i}),Mg[e]=m,c},kp=function(t,e){return{value:t,done:e}},u1=Vi,Fg=yo,l1=Vg,jg=kp,Gg="Array Iterator",p1=Io.set,h1=Io.getterFor(Gg);l1(Array,"Array",function(t,e){p1(this,{type:Gg,target:u1(t),index:0,kind:e})},function(){var t=h1(this),e=t.target,n=t.kind,r=t.index++;return!e||r>=e.length?(t.target=void 0,jg(void 0,!0)):jg("keys"==n?r:"values"==n?e[r]:[r,e[r]],!1)},"values"),Fg.Arguments=Fg.Array;var _1=dr,Od=function(t,e,n){return _1.f(t,e,n)},E1=Cn,m1=Od,f1=Yn,Wg=he("species"),g1=on,T1=TypeError,Mp=function(t,e){if(g1(e,t))return t;throw T1("Incorrect invocation")},S1=Le,Up=Xl,R1=Te(Function.toString);S1(Up.inspectSource)||(Up.inspectSource=function(t){return R1(t)});var Hg=Up.inspectSource,v1=Te,y1=te,Kg=Le,C1=zr,I1=Hg,Yg=function(){},A1=[],qg=Cn("Reflect","construct"),xp=/^\s*(?:class|function)\b/,b1=v1(xp.exec),O1=!xp.exec(Yg),Ma=function(t){if(!Kg(t))return!1;try{return qg(Yg,A1,t),!0}catch{return!1}},zg=function(t){if(!Kg(t))return!1;switch(C1(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return O1||!!b1(xp,I1(t))}catch{return!0}};zg.sham=!0;var Ua,fs,Jg,Vp,wd=!qg||y1(function(){var t;return Ma(Ma.call)||!Ma(Object)||!Ma(function(){t=!0})||t})?zg:Ma,w1=wd,N1=ds,D1=TypeError,Xg=fn,L1=ss,k1=he("species"),Fp=function(t,e){var n,r=Xg(t).constructor;return void 0===r||L1(n=Xg(r)[k1])?e:function(t){if(w1(t))return t;throw D1(N1(t)+" is not a constructor")}(n)},Nd=Te([].slice),M1=TypeError,gs=function(t,e){if(t<e)throw M1("Not enough arguments");return t},Qg=/(?:ipad|iphone|ipod).*applewebkit/i.test(Fi),Xn=Ae,U1=ed,x1=Bi,Zg=Le,V1=ze,$g=te,tT=ag,F1=Nd,eT=tp,B1=gs,j1=Qg,G1=_s,Bp=Xn.setImmediate,jp=Xn.clearImmediate,W1=Xn.process,Gp=Xn.Dispatch,H1=Xn.Function,nT=Xn.MessageChannel,K1=Xn.String,Wp=0,xa={},rT="onreadystatechange";$g(function(){Ua=Xn.location});var Hp=function(t){if(V1(xa,t)){var e=xa[t];delete xa[t],e()}},Kp=function(t){return function(){Hp(t)}},iT=function(t){Hp(t.data)},oT=function(t){Xn.postMessage(K1(t),Ua.protocol+"//"+Ua.host)};Bp&&jp||(Bp=function(t){B1(arguments.length,1);var e=Zg(t)?t:H1(t),n=F1(arguments,1);return xa[++Wp]=function(){U1(e,void 0,n)},fs(Wp),Wp},jp=function(t){delete xa[t]},G1?fs=function(t){W1.nextTick(Kp(t))}:Gp&&Gp.now?fs=function(t){Gp.now(Kp(t))}:nT&&!j1?(Vp=(Jg=new nT).port2,Jg.port1.onmessage=iT,fs=x1(Vp.postMessage,Vp)):Xn.addEventListener&&Zg(Xn.postMessage)&&!Xn.importScripts&&Ua&&"file:"!==Ua.protocol&&!$g(oT)?(fs=oT,Xn.addEventListener("message",iT,!1)):fs=rT in eT("script")?function(t){tT.appendChild(eT("script"))[rT]=function(){tT.removeChild(this),Hp(t)}}:function(t){setTimeout(Kp(t),0)});var Dd={set:Bp,clear:jp},sT=function(){this.head=null,this.tail=null};sT.prototype={add:function(t){var e={item:t,next:null},n=this.tail;n?n.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return null===(this.head=t.next)&&(this.tail=null),t.item}};var Ts,Yp,qp,zp,aT,cT=sT,Y1=/ipad|iphone|ipod/i.test(Fi)&&typeof Pebble<"u",q1=/web0s(?!.*chrome)/i.test(Fi),Ao=Ae,dT=Bi,Jp=Dd.set,J1=cT,X1=Qg,Q1=Y1,Z1=q1,Xp=_s,uT=Ao.MutationObserver||Ao.WebKitMutationObserver,lT=Ao.document,pT=Ao.process,Pd=Ao.Promise,hT=(0,Oa.f)(Ao,"queueMicrotask"),Qp=hT&&hT.value;if(!Qp){var Ld=new J1,kd=function(){var t,e;for(Xp&&(t=pT.domain)&&t.exit();e=Ld.get();)try{e()}catch(n){throw Ld.head&&Ts(),n}t&&t.enter()};X1||Xp||Z1||!uT||!lT?!Q1&&Pd&&Pd.resolve?((zp=Pd.resolve(void 0)).constructor=Pd,aT=dT(zp.then,zp),Ts=function(){aT(kd)}):Xp?Ts=function(){pT.nextTick(kd)}:(Jp=dT(Jp,Ao),Ts=function(){Jp(kd)}):(Yp=!0,qp=lT.createTextNode(""),new uT(kd).observe(qp,{characterData:!0}),Ts=function(){qp.data=Yp=!Yp}),Qp=function(t){Ld.head||Ts(),Ld.add(t)}}var _T=Qp,Ss=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},bo=Ae.Promise,ET="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,$1=!ET&&!_s&&"object"==typeof window&&"object"==typeof document,tM=Ae,Va=bo,eM=Le,nM=Vf,rM=Hg,oM=$1,sM=ET,Zp=Ro,mT=Va&&Va.prototype,aM=he("species"),fT=!1,gT=eM(tM.PromiseRejectionEvent),Fa={CONSTRUCTOR:nM("Promise",function(){var t=rM(Va),e=t!==String(Va);if(!e&&66===Zp||!mT.catch||!mT.finally)return!0;if(!Zp||Zp<51||!/native code/.test(t)){var n=new Va(function(i){i(1)}),r=function(i){i(function(){},function(){})};if((n.constructor={})[aM]=r,!(fT=n.then(function(){})instanceof r))return!0}return!e&&(oM||sM)&&!gT}),REJECTION_EVENT:gT,SUBCLASSING:fT},Xr={},TT=zn,dM=TypeError,uM=function(t){var e,n;this.promise=new t(function(r,i){if(void 0!==e||void 0!==n)throw dM("Bad Promise constructor");e=r,n=i}),this.resolve=TT(e),this.reject=TT(n)};Xr.f=function(t){return new uM(t)};var $p,ST,lM=Lt,Md=_s,Hi=Ae,Ba=Be,pM=Gi,hM=Wi,EM=zn,th=Le,mM=Ln,fM=Mp,gM=Fp,RT=Dd.set,eh=_T,SM=Ss,RM=cT,vT=Io,nh=bo,CT=Xr,Ud="Promise",IT=Fa.CONSTRUCTOR,vM=Fa.REJECTION_EVENT,rh=vT.getterFor(Ud),yM=vT.set,ja=nh,ih=nh&&nh.prototype,AT=Hi.TypeError,oh=Hi.document,sh=Hi.process,ah=CT.f,IM=ah,AM=!!(oh&&oh.createEvent&&Hi.dispatchEvent),bT="unhandledrejection",OT=function(t){var e;return!(!mM(t)||!th(e=t.then))&&e},wT=function(t,e){var n,r,i,o=e.value,s=1==e.state,a=s?t.ok:t.fail,c=t.resolve,d=t.reject,u=t.domain;try{a?(s||(2===e.rejection&&OM(e),e.rejection=1),!0===a?n=o:(u&&u.enter(),n=a(o),u&&(u.exit(),i=!0)),n===t.promise?d(AT("Promise-chain cycle")):(r=OT(n))?Ba(r,n,c,d):c(n)):d(o)}catch(l){u&&!i&&u.exit(),d(l)}},NT=function(t,e){t.notified||(t.notified=!0,eh(function(){for(var n,r=t.reactions;n=r.get();)wT(n,t);t.notified=!1,e&&!t.rejection&&bM(t)}))},DT=function(t,e,n){var r,i;AM?((r=oh.createEvent("Event")).promise=e,r.reason=n,r.initEvent(t,!1,!0),Hi.dispatchEvent(r)):r={promise:e,reason:n},!vM&&(i=Hi["on"+t])?i(r):t===bT&&function(t,e){try{1==arguments.length?console.error(t):console.error(t,e)}catch{}}("Unhandled promise rejection",n)},bM=function(t){Ba(RT,Hi,function(){var e,n=t.facade,r=t.value;if(PT(t)&&(e=SM(function(){Md?sh.emit("unhandledRejection",r,n):DT(bT,n,r)}),t.rejection=Md||PT(t)?2:1,e.error))throw e.value})},PT=function(t){return 1!==t.rejection&&!t.parent},OM=function(t){Ba(RT,Hi,function(){var e=t.facade;Md?sh.emit("rejectionHandled",e):DT("rejectionhandled",e,t.value)})},Rs=function(t,e,n){return function(r){t(e,r,n)}},vs=function(t,e,n){t.done||(t.done=!0,n&&(t=n),t.value=e,t.state=2,NT(t,!0))},ch=function(t,e,n){if(!t.done){t.done=!0,n&&(t=n);try{if(t.facade===e)throw AT("Promise can't be resolved itself");var r=OT(e);r?eh(function(){var i={done:!1};try{Ba(r,e,Rs(ch,i,t),Rs(vs,i,t))}catch(o){vs(i,o,t)}}):(t.value=e,t.state=1,NT(t,!1))}catch(i){vs({done:!1},i,t)}}};IT&&(ih=(ja=function(t){fM(this,ih),EM(t),Ba($p,this);var e=rh(this);try{t(Rs(ch,e),Rs(vs,e))}catch(n){vs(e,n)}}).prototype,($p=function(t){yM(this,{type:Ud,done:!1,notified:!1,parent:!1,reactions:new RM,rejection:!1,state:0,value:void 0})}).prototype=pM(ih,"then",function(t,e){var n=rh(this),r=ah(gM(this,ja));return n.parent=!0,r.ok=!th(t)||t,r.fail=th(e)&&e,r.domain=Md?sh.domain:void 0,0==n.state?n.reactions.add(r):eh(function(){wT(r,n)}),r.promise}),ST=function(){var t=new $p,e=rh(t);this.promise=t,this.resolve=Rs(ch,e),this.reject=Rs(vs,e)},CT.f=ah=function(t){return t===ja||void 0===t?new ST(t):IM(t)}),lM({global:!0,constructor:!0,wrap:!0,forced:IT},{Promise:ja}),hM(ja,Ud,!1,!0),function(t){var e=E1(t);f1&&e&&!e[Wg]&&m1(e,Wg,{configurable:!0,get:function(){return this}})}(Ud);var LT=he("iterator"),kT=!1;try{var wM=0,MT={next:function(){return{done:!!wM++}},return:function(){kT=!0}};MT[LT]=function(){return this},Array.from(MT,function(){throw 2})}catch{}var NM=bo,xd=Fa.CONSTRUCTOR||!function(t,e){if(!e&&!kT)return!1;var n=!1;try{var r={};r[LT]=function(){return{next:function(){return{done:n=!0}}}},t(r)}catch{}return n}(function(t){NM.all(t).then(void 0,function(){})}),PM=Be,LM=zn,kM=Xr,MM=Ss,UM=La;Lt({target:"Promise",stat:!0,forced:xd},{all:function(t){var e=this,n=kM.f(e),r=n.resolve,i=n.reject,o=MM(function(){var s=LM(e.resolve),a=[],c=0,d=1;UM(t,function(u){var l=c++,p=!1;d++,PM(s,e,u).then(function(h){p||(p=!0,a[l]=h,--d||r(a))},i)}),--d||r(a)});return o.error&&i(o.value),n.promise}}),Lt({target:"Promise",proto:!0,forced:Fa.CONSTRUCTOR,real:!0},{catch:function(t){return this.then(void 0,t)}});var FM=Be,BM=zn,jM=Xr,GM=Ss,WM=La;Lt({target:"Promise",stat:!0,forced:xd},{race:function(t){var e=this,n=jM.f(e),r=n.reject,i=GM(function(){var o=BM(e.resolve);WM(t,function(s){FM(o,e,s).then(n.resolve,r)})});return i.error&&r(i.value),n.promise}});var HM=Be,KM=Xr;Lt({target:"Promise",stat:!0,forced:Fa.CONSTRUCTOR},{reject:function(t){var e=KM.f(this);return HM(e.reject,void 0,t),e.promise}});var YM=fn,qM=Ln,zM=Xr,UT=function(t,e){if(YM(t),qM(e)&&e.constructor===t)return e;var n=zM.f(t);return(0,n.resolve)(e),n.promise},JM=Lt,XM=bo,QM=Fa.CONSTRUCTOR,ZM=UT,$M=Cn("Promise"),tU=!QM;JM({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return ZM(tU&&this===$M?XM:this,t)}});var eU=Be,nU=zn,rU=Xr,iU=Ss,oU=La;Lt({target:"Promise",stat:!0,forced:xd},{allSettled:function(t){var e=this,n=rU.f(e),r=n.resolve,i=n.reject,o=iU(function(){var s=nU(e.resolve),a=[],c=0,d=1;oU(t,function(u){var l=c++,p=!1;d++,eU(s,e,u).then(function(h){p||(p=!0,a[l]={status:"fulfilled",value:h},--d||r(a))},function(h){p||(p=!0,a[l]={status:"rejected",reason:h},--d||r(a))})}),--d||r(a)});return o.error&&i(o.value),n.promise}});var sU=Be,aU=zn,cU=Cn,dU=Xr,uU=Ss,lU=La,xT="No one promise resolved";Lt({target:"Promise",stat:!0,forced:xd},{any:function(t){var e=this,n=cU("AggregateError"),r=dU.f(e),i=r.resolve,o=r.reject,s=uU(function(){var a=aU(e.resolve),c=[],d=0,u=1,l=!1;lU(t,function(p){var h=d++,S=!1;u++,sU(a,e,p).then(function(m){S||l||(l=!0,i(m))},function(m){S||l||(S=!0,c[h]=m,--u||o(new n(c,xT)))})}),--u||o(new n(c,xT))});return s.error&&o(s.value),r.promise}});var _U=Cn,EU=Le,mU=Fp,VT=UT,fU=bo&&bo.prototype;Lt({target:"Promise",proto:!0,real:!0,forced:!!bo&&te(function(){fU.finally.call({then:function(){}},function(){})})},{finally:function(t){var e=mU(this,_U("Promise")),n=EU(t);return this.then(n?function(r){return VT(e,t()).then(function(){return r})}:t,n?function(r){return VT(e,t()).then(function(){throw r})}:t)}});var uh=Te,gU=op,TU=Jn,SU=as,RU=uh("".charAt),FT=uh("".charCodeAt),vU=uh("".slice),BT=function(t){return function(e,n){var r,i,o=TU(SU(e)),s=gU(n),a=o.length;return s<0||s>=a?t?"":void 0:(r=FT(o,s))<55296||r>56319||s+1===a||(i=FT(o,s+1))<56320||i>57343?t?RU(o,s):r:t?vU(o,s,s+2):i-56320+(r-55296<<10)+65536}},lh={codeAt:BT(!1),charAt:BT(!0)},yU=lh.charAt,CU=Jn,IU=Vg,GT=kp,WT="String Iterator",AU=Io.set,bU=Io.getterFor(WT);IU(String,"String",function(t){AU(this,{type:WT,string:CU(t),index:0})},function(){var t,e=bU(this),n=e.string,r=e.index;return r>=n.length?GT(void 0,!0):(t=yU(n,r),e.index+=t.length,GT(t,!1))});var OU=qn.Promise,NU=Ae,DU=zr,PU=ji,HT=yo,KT=he("toStringTag");for(var ph in{CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}){var YT=NU[ph],hh=YT&&YT.prototype;hh&&DU(hh)!==KT&&PU(hh,KT,ph),HT[ph]=HT.Array}var qT=OU,H=Wt(qT);const zT=Zf;function JT(t,e){const n=t&&t.navigator;if(!n.mediaDevices)return;const r=function(s){if("object"!=typeof s||s.mandatory||s.optional)return s;const a={};return Object.keys(s).forEach(c=>{if("require"===c||"advanced"===c||"mediaSource"===c)return;const d="object"==typeof s[c]?s[c]:{ideal:s[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);const u=function(l,p){return l?l+p.charAt(0).toUpperCase()+p.slice(1):"deviceId"===p?"sourceId":p};if(void 0!==d.ideal){a.optional=a.optional||[];let l={};"number"==typeof d.ideal?(l[u("min",c)]=d.ideal,a.optional.push(l),l={},l[u("max",c)]=d.ideal,a.optional.push(l)):(l[u("",c)]=d.ideal,a.optional.push(l))}void 0!==d.exact&&"number"!=typeof d.exact?(a.mandatory=a.mandatory||{},a.mandatory[u("",c)]=d.exact):["min","max"].forEach(l=>{void 0!==d[l]&&(a.mandatory=a.mandatory||{},a.mandatory[u(l,c)]=d[l])})}),s.advanced&&(a.optional=(a.optional||[]).concat(s.advanced)),a},i=function(s,a){if(e.version>=61)return a(s);if((s=JSON.parse(JSON.stringify(s)))&&"object"==typeof s.audio){const c=function(d,u,l){u in d&&!(l in d)&&(d[l]=d[u],delete d[u])};c((s=JSON.parse(JSON.stringify(s))).audio,"autoGainControl","googAutoGainControl"),c(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=r(s.audio)}if(s&&"object"==typeof s.video){let c=s.video.facingMode;c=c&&("object"==typeof c?c:{ideal:c});const d=e.version<66;if(c&&("user"===c.exact||"environment"===c.exact||"user"===c.ideal||"environment"===c.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d)){let u;if(delete s.video.facingMode,"environment"===c.exact||"environment"===c.ideal?u=["back","rear"]:"user"!==c.exact&&"user"!==c.ideal||(u=["front"]),u)return n.mediaDevices.enumerateDevices().then(l=>{let p=(l=l.filter(h=>"videoinput"===h.kind)).find(h=>u.some(S=>{var m;return W(m=h.label.toLowerCase()).call(m,S)}));return!p&&l.length&&W(u).call(u,"back")&&(p=l[l.length-1]),p&&(s.video.deviceId=c.exact?{exact:p.deviceId}:{ideal:p.deviceId}),s.video=r(s.video),zT("chrome: "+JSON.stringify(s)),a(s)})}s.video=r(s.video)}return zT("chrome: "+JSON.stringify(s)),a(s)},o=function(s){return e.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(s,a,c){i(s,d=>{n.webkitGetUserMedia(d,a,u=>{c&&c(o(u))})})}.bind(n),n.mediaDevices.getUserMedia){const s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(a){return i(a,c=>s(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(u=>{u.stop()}),new DOMException("","NotFoundError");return d},d=>H.reject(o(d))))}}}function XT(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function QT(t){if("object"==typeof t&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",r=>{let i;i=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===r.track.id):{track:r.track};const o=new Event("track");o.track=r.track,o.receiver=i,o.transceiver={receiver:i},o.streams=[n.stream],this.dispatchEvent(o)}),n.stream.getTracks().forEach(r=>{let i;i=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===r.id):{track:r};const o=new Event("track");o.track=r,o.receiver=i,o.transceiver={receiver:i},o.streams=[n.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else vo(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function ZT(t){if("object"==typeof t&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(i,o){return{track:o,get dtmf(){return void 0===this._dtmf&&(this._dtmf="audio"===o.kind?i.createDTMFSender(o):null),this._dtmf},_pc:i}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,a){let c=i.apply(this,arguments);return c||(c=e(this,s),this._senders.push(c)),c};const o=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){o.apply(this,arguments);const a=this._senders.indexOf(s);-1!==a&&this._senders.splice(a,1)}}const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(i){this._senders=this._senders||[],n.apply(this,[i]),i.getTracks().forEach(o=>{this._senders.push(e(this,o))})};const r=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(i){this._senders=this._senders||[],r.apply(this,[i]),i.getTracks().forEach(o=>{const s=this._senders.find(a=>a.track===o);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if("object"==typeof t&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&(this._dtmf="audio"===this.track.kind?this._pc.createDTMFSender(this.track):null),this._dtmf}})}}function $T(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[n,r,i]=arguments;if(arguments.length>0&&"function"==typeof n)return e.apply(this,arguments);if(0===e.length&&(0===arguments.length||"function"!=typeof n))return e.apply(this,[]);const o=function(a){const c={};return a.result().forEach(d=>{const u={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(l=>{u[l]=d.stat(l)}),c[u.id]=u}),c},s=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};return arguments.length>=2?e.apply(this,[function(c){r(s(o(c)))},n]):new H((a,c)=>{e.apply(this,[function(d){a(s(o(d)))},c])}).then(r,i)}}function tS(t){if(!("object"==typeof t&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){const i=n.apply(this,[]);return i.forEach(o=>o._pc=this),i});const r=t.RTCPeerConnection.prototype.addTrack;r&&(t.RTCPeerConnection.prototype.addTrack=function(){const i=r.apply(this,arguments);return i._pc=this,i}),t.RTCRtpSender.prototype.getStats=function(){const i=this;return this._pc.getStats().then(o=>eg(o,i.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){const r=n.apply(this,[]);return r.forEach(i=>i._pc=this),r}),vo(t,"track",r=>(r.receiver._pc=r.srcElement,r)),t.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(i=>eg(i,r.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const n=arguments[0];let r,i,o;return this.getSenders().forEach(s=>{s.track===n&&(r?o=!0:r=s)}),this.getReceivers().forEach(s=>(s.track===n&&(i?o=!0:i=s),s.track===n)),o||r&&i?H.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():H.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function eS(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,s){if(!s)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=e.apply(this,arguments);return this._shimmedLocalStreams[s.id]?-1===this._shimmedLocalStreams[s.id].indexOf(a)&&this._shimmedLocalStreams[s.id].push(a):this._shimmedLocalStreams[s.id]=[s,a],a};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(c=>{if(this.getSenders().find(u=>u.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});const s=this.getSenders();n.apply(this,arguments);const a=this.getSenders().filter(c=>-1===s.indexOf(c));this._shimmedLocalStreams[o.id]=[o].concat(a)};const r=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],r.apply(this,arguments)};const i=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(s=>{const a=this._shimmedLocalStreams[s].indexOf(o);-1!==a&&this._shimmedLocalStreams[s].splice(a,1),1===this._shimmedLocalStreams[s].length&&delete this._shimmedLocalStreams[s]}),i.apply(this,arguments)}}function nS(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return eS(t);const n=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const c=n.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};const r=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(l=>l.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){const d=new t.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}r.apply(this,[c])};const i=t.RTCPeerConnection.prototype.removeStream;function o(c,d){let u=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(l=>{const p=c._reverseStreams[l];u=u.replace(new RegExp(c._streams[p.id].id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:u})}t.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},t.RTCPeerConnection.prototype.addTrack=function(c,d){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const u=[].slice.call(arguments,1);if(1!==u.length||!u[0].getTracks().find(h=>h===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(h=>h.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const p=this._streams[d.id];if(p)p.addTrack(c),H.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const h=new t.MediaStream([c]);this._streams[d.id]=h,this._reverseStreams[h.id]=d,this.addStream(h)}return this.getSenders().find(h=>h.track===c)},["createOffer","createAnswer"].forEach(function(c){const d=t.RTCPeerConnection.prototype[c],u={[c](){const l=arguments;return arguments.length&&"function"==typeof arguments[0]?d.apply(this,[p=>{const h=o(this,p);l[0].apply(null,[h])},p=>{l[1]&&l[1].apply(null,p)},arguments[2]]):d.apply(this,arguments).then(p=>o(this,p))}};t.RTCPeerConnection.prototype[c]=u[c]});const s=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let u=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(l=>{const p=c._reverseStreams[l],h=c._streams[p.id];u=u.replace(new RegExp(p.id,"g"),h.id)}),new RTCSessionDescription({type:d.type,sdp:u})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const c=a.get.apply(this);return""===c.type?c:o(this,c)}}),t.RTCPeerConnection.prototype.removeTrack=function(c){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(u=>{this._streams[u].getTracks().find(l=>c.track===l)&&(d=this._streams[u])}),d&&(1===d.getTracks().length?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function _h(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const r=t.RTCPeerConnection.prototype[n],i={[n](){return arguments[0]=new("addIceCandidate"===n?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};t.RTCPeerConnection.prototype[n]=i[n]})}function rS(t,e){vo(t,"negotiationneeded",n=>{const r=n.target;if(!(e.version<72||r.getConfiguration&&"plan-b"===r.getConfiguration().sdpSemantics)||"stable"===r.signalingState)return n})}var iS=Object.freeze({__proto__:null,fixNegotiationNeeded:rS,shimAddTrackRemoveTrack:nS,shimAddTrackRemoveTrackWithNative:eS,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&("function"==typeof e?t.navigator.mediaDevices.getDisplayMedia=function(n){return e(n).then(r=>{const i=n.video&&n.video.width,o=n.video&&n.video.height;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:n.video&&n.video.frameRate||3}},i&&(n.video.mandatory.maxWidth=i),o&&(n.video.mandatory.maxHeight=o),t.navigator.mediaDevices.getUserMedia(n)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:ZT,shimGetStats:$T,shimGetUserMedia:JT,shimMediaStream:XT,shimOnTrack:QT,shimPeerConnection:_h,shimSenderReceiverGetStats:tS});function oS(t,e){const n=t&&t.navigator,r=t&&t.MediaStreamTrack;if(n.getUserMedia=function(i,o,s){pp("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(i).then(o,s)},!(e.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const i=function(s,a,c){a in s&&!(c in s)&&(s[c]=s[a],delete s[a])},o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(s){return"object"==typeof s&&"object"==typeof s.audio&&(s=JSON.parse(JSON.stringify(s)),i(s.audio,"autoGainControl","mozAutoGainControl"),i(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},r&&r.prototype.getSettings){const s=r.prototype.getSettings;r.prototype.getSettings=function(){const a=s.apply(this,arguments);return i(a,"mozAutoGainControl","autoGainControl"),i(a,"mozNoiseSuppression","noiseSuppression"),a}}if(r&&r.prototype.applyConstraints){const s=r.prototype.applyConstraints;r.prototype.applyConstraints=function(a){return"audio"===this.kind&&"object"==typeof a&&(a=JSON.parse(JSON.stringify(a)),i(a,"autoGainControl","mozAutoGainControl"),i(a,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[a])}}}}function sS(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Eh(t,e){if("object"!=typeof t||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const o=t.RTCPeerConnection.prototype[i],s={[i](){return arguments[0]=new("addIceCandidate"===i?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};t.RTCPeerConnection.prototype[i]=s[i]});const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[i,o,s]=arguments;return r.apply(this,[i||null]).then(a=>{if(e.version<53&&!o)try{a.forEach(c=>{c.type=n[c.type]||c.type})}catch(c){if("TypeError"!==c.name)throw c;a.forEach((d,u)=>{a.set(u,Object.assign({},d,{type:n[d.type]||d.type}))})}return a}).then(o,s)}}function aS(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(i=>i._pc=this),r});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const r=n.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):H.resolve(new Map)}}function cS(t){if("object"!=typeof t||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n}),vo(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function dS(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){pp("removeStream","removeTrack"),this.getSenders().forEach(n=>{var r;n.track&&W(r=e.getTracks()).call(r,n.track)&&this.removeTrack(n)})})}function uS(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function lS(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;void 0===n&&(n=[]),n=[...n];const r=n.length>0;r&&n.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const i=e.apply(this,arguments);if(r){const{sender:o}=i,s=o.getParameters();(!("encodings"in s)||1===s.encodings.length&&0===Object.keys(s.encodings[0]).length)&&(s.encodings=n,o.sendEncodings=n,this.setParametersPromises.push(o.setParameters(s).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return i})}function pS(t){if("object"!=typeof t||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const n=e.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function hS(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?H.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function _S(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?H.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var ES=Object.freeze({__proto__:null,shimAddTransceiver:lS,shimCreateAnswer:_S,shimCreateOffer:hS,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,H.reject(r)}return!0===n.video?n.video={mediaSource:e}:n.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:pS,shimGetUserMedia:oS,shimOnTrack:sS,shimPeerConnection:Eh,shimRTCDataChannel:uS,shimReceiverGetStats:cS,shimRemoveStream:dS,shimSenderGetStats:aS});function mS(t){if("object"==typeof t&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(n){var r;this._localStreams||(this._localStreams=[]),W(r=this._localStreams).call(r,n)||this._localStreams.push(n),n.getAudioTracks().forEach(i=>e.call(this,i,n)),n.getVideoTracks().forEach(i=>e.call(this,i,n))},t.RTCPeerConnection.prototype.addTrack=function(n){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return i&&i.forEach(s=>{var a;this._localStreams?W(a=this._localStreams).call(a,s)||this._localStreams.push(s):this._localStreams=[s]}),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(e);if(-1===n)return;this._localStreams.splice(n,1);const r=e.getTracks();this.getSenders().forEach(i=>{W(r).call(r,i.track)&&this.removeTrack(i)})})}}function fS(t){if("object"==typeof t&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=r=>{r.streams.forEach(i=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),W(o=this._remoteStreams).call(o,i))return;this._remoteStreams.push(i);const s=new Event("addstream");s.stream=i,this.dispatchEvent(s)})})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(i=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(i)>=0)return;n._remoteStreams.push(i);const o=new Event("addstream");o.stream=i,n.dispatchEvent(o)})}),e.apply(n,arguments)}}}function gS(t){if("object"!=typeof t||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,n=e.createOffer,r=e.createAnswer,i=e.setLocalDescription,o=e.setRemoteDescription,s=e.addIceCandidate;e.createOffer=function(c,d){const l=n.apply(this,[arguments.length>=2?arguments[2]:arguments[0]]);return d?(l.then(c,d),H.resolve()):l},e.createAnswer=function(c,d){const l=r.apply(this,[arguments.length>=2?arguments[2]:arguments[0]]);return d?(l.then(c,d),H.resolve()):l};let a=function(c,d,u){const l=i.apply(this,[c]);return u?(l.then(d,u),H.resolve()):l};e.setLocalDescription=a,a=function(c,d,u){const l=o.apply(this,[c]);return u?(l.then(d,u),H.resolve()):l},e.setRemoteDescription=a,a=function(c,d,u){const l=s.apply(this,[c]);return u?(l.then(d,u),H.resolve()):l},e.addIceCandidate=a}function TS(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const n=e.mediaDevices,r=n.getUserMedia.bind(n);e.mediaDevices.getUserMedia=i=>r(SS(i))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=function(n,r,i){e.mediaDevices.getUserMedia(n).then(r,i)}.bind(e))}function SS(t){return t&&void 0!==t.video?Object.assign({},t,{video:tg(t.video)}):t}function RS(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(n,r){if(n&&n.iceServers){const i=[];for(let o=0;o<n.iceServers.length;o++){let s=n.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(pp("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,i.push(s)):i.push(n.iceServers[o])}n.iceServers=i}return new e(n,r)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function vS(t){"object"==typeof t&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function yS(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(n){if(n){void 0!==n.offerToReceiveAudio&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const r=this.getTransceivers().find(o=>"audio"===o.receiver.track.kind);!1===n.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==n.offerToReceiveAudio||r||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==n.offerToReceiveVideo&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const i=this.getTransceivers().find(o=>"video"===o.receiver.track.kind);!1===n.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==n.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function CS(t){"object"!=typeof t||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var t,IS=Object.freeze({__proto__:null,shimAudioContext:CS,shimCallbacksAPI:gS,shimConstraints:SS,shimCreateOfferLegacy:yS,shimGetUserMedia:TS,shimLocalStreamsAPI:mS,shimRTCIceServerUrls:RS,shimRemoteStreamsAPI:fS,shimTrackEventTransceiver:vS}),AS="\t\n\v\f\r \xa0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029\ufeff",LU=as,kU=Jn,mh=AS,bS=Te("".replace),MU=RegExp("^["+mh+"]+"),UU=RegExp("(^|[^"+mh+"])["+mh+"]+$"),fh=function(t){return function(e){var n=kU(LU(e));return 1&t&&(n=bS(n,MU,"")),2&t&&(n=bS(n,UU,"$1")),n}},xU={start:fh(1),end:fh(2),trim:fh(3)},VU=wg.PROPER,OS=AS,BU=xU.trim;Lt({target:"String",proto:!0,forced:(t="trim",te(function(){return!!OS[t]()||"\u200b\x85\u180e"!=="\u200b\x85\u180e"[t]()||VU&&OS[t].name!==t}))},{trim:function(){return BU(this)}});var jU=ur("String").trim,GU=on,WU=jU,gh=String.prototype,$e=Wt(function(t){var e=t.trim;return"string"==typeof t||t===gh||GU(gh,t)&&e===gh.trim?WU:e}),wS={exports:{}};!function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(n){return n.trim().split("\n").map(r=>r.trim())},e.splitSections=function(n){return n.split("\nm=").map((r,i)=>(i>0?"m="+r:r).trim()+"\r\n")},e.getDescription=function(n){const r=e.splitSections(n);return r&&r[0]},e.getMediaSections=function(n){const r=e.splitSections(n);return r.shift(),r},e.matchPrefix=function(n,r){return e.splitLines(n).filter(i=>0===i.indexOf(r))},e.parseCandidate=function(n){let r;r=0===n.indexOf("a=candidate:")?n.substring(12).split(" "):n.substring(10).split(" ");const i={foundation:r[0],component:{1:"rtp",2:"rtcp"}[r[1]]||r[1],protocol:r[2].toLowerCase(),priority:parseInt(r[3],10),ip:r[4],address:r[4],port:parseInt(r[5],10),type:r[7]};for(let o=8;o<r.length;o+=2)switch(r[o]){case"raddr":i.relatedAddress=r[o+1];break;case"rport":i.relatedPort=parseInt(r[o+1],10);break;case"tcptype":i.tcpType=r[o+1];break;case"ufrag":i.ufrag=r[o+1],i.usernameFragment=r[o+1];break;default:void 0===i[r[o]]&&(i[r[o]]=r[o+1])}return i},e.writeCandidate=function(n){const r=[];r.push(n.foundation);const i=n.component;r.push("rtp"===i?1:"rtcp"===i?2:i),r.push(n.protocol.toUpperCase()),r.push(n.priority),r.push(n.address||n.ip),r.push(n.port);const o=n.type;return r.push("typ"),r.push(o),"host"!==o&&n.relatedAddress&&n.relatedPort&&(r.push("raddr"),r.push(n.relatedAddress),r.push("rport"),r.push(n.relatedPort)),n.tcpType&&"tcp"===n.protocol.toLowerCase()&&(r.push("tcptype"),r.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(r.push("ufrag"),r.push(n.usernameFragment||n.ufrag)),"candidate:"+r.join(" ")},e.parseIceOptions=function(n){return n.substring(14).split(" ")},e.parseRtpMap=function(n){let r=n.substring(9).split(" ");const i={payloadType:parseInt(r.shift(),10)};return r=r[0].split("/"),i.name=r[0],i.clockRate=parseInt(r[1],10),i.channels=3===r.length?parseInt(r[2],10):1,i.numChannels=i.channels,i},e.writeRtpMap=function(n){let r=n.payloadType;void 0!==n.preferredPayloadType&&(r=n.preferredPayloadType);const i=n.channels||n.numChannels||1;return"a=rtpmap:"+r+" "+n.name+"/"+n.clockRate+(1!==i?"/"+i:"")+"\r\n"},e.parseExtmap=function(n){const r=n.substring(9).split(" ");return{id:parseInt(r[0],10),direction:r[0].indexOf("/")>0?r[0].split("/")[1]:"sendrecv",uri:r[1],attributes:r.slice(2).join(" ")}},e.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&"sendrecv"!==n.direction?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+"\r\n"},e.parseFmtp=function(n){const r={};let i;const o=n.substring(n.indexOf(" ")+1).split(";");for(let s=0;s<o.length;s++)i=o[s].trim().split("="),r[i[0].trim()]=i[1];return r},e.writeFmtp=function(n){let r="",i=n.payloadType;if(void 0!==n.preferredPayloadType&&(i=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const o=[];Object.keys(n.parameters).forEach(s=>{o.push(void 0!==n.parameters[s]?s+"="+n.parameters[s]:s)}),r+="a=fmtp:"+i+" "+o.join(";")+"\r\n"}return r},e.parseRtcpFb=function(n){const r=n.substring(n.indexOf(" ")+1).split(" ");return{type:r.shift(),parameter:r.join(" ")}},e.writeRtcpFb=function(n){let r="",i=n.payloadType;return void 0!==n.preferredPayloadType&&(i=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{r+="a=rtcp-fb:"+i+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+"\r\n"}),r},e.parseSsrcMedia=function(n){const r=n.indexOf(" "),i={ssrc:parseInt(n.substring(7,r),10)},o=n.indexOf(":",r);return o>-1?(i.attribute=n.substring(r+1,o),i.value=n.substring(o+1)):i.attribute=n.substring(r+1),i},e.parseSsrcGroup=function(n){const r=n.substring(13).split(" ");return{semantics:r.shift(),ssrcs:r.map(i=>parseInt(i,10))}},e.getMid=function(n){const r=e.matchPrefix(n,"a=mid:")[0];if(r)return r.substring(6)},e.parseFingerprint=function(n){const r=n.substring(14).split(" ");return{algorithm:r[0].toLowerCase(),value:r[1].toUpperCase()}},e.getDtlsParameters=function(n,r){return{role:"auto",fingerprints:e.matchPrefix(n+r,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(n,r){let i="a=setup:"+r+"\r\n";return n.fingerprints.forEach(o=>{i+="a=fingerprint:"+o.algorithm+" "+o.value+"\r\n"}),i},e.parseCryptoLine=function(n){const r=n.substring(9).split(" ");return{tag:parseInt(r[0],10),cryptoSuite:r[1],keyParams:r[2],sessionParams:r.slice(3)}},e.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+("object"==typeof n.keyParams?e.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+"\r\n"},e.parseCryptoKeyParams=function(n){if(0!==n.indexOf("inline:"))return null;const r=n.substring(7).split("|");return{keyMethod:"inline",keySalt:r[0],lifeTime:r[1],mkiValue:r[2]?r[2].split(":")[0]:void 0,mkiLength:r[2]?r[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},e.getCryptoParameters=function(n,r){return e.matchPrefix(n+r,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(n,r){const i=e.matchPrefix(n+r,"a=ice-ufrag:")[0],o=e.matchPrefix(n+r,"a=ice-pwd:")[0];return i&&o?{usernameFragment:i.substring(12),password:o.substring(10)}:null},e.writeIceParameters=function(n){let r="a=ice-ufrag:"+n.usernameFragment+"\r\na=ice-pwd:"+n.password+"\r\n";return n.iceLite&&(r+="a=ice-lite\r\n"),r},e.parseRtpParameters=function(n){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=e.splitLines(n)[0].split(" ");r.profile=i[2];for(let s=3;s<i.length;s++){const a=i[s],c=e.matchPrefix(n,"a=rtpmap:"+a+" ")[0];if(c){const d=e.parseRtpMap(c),u=e.matchPrefix(n,"a=fmtp:"+a+" ");switch(d.parameters=u.length?e.parseFmtp(u[0]):{},d.rtcpFeedback=e.matchPrefix(n,"a=rtcp-fb:"+a+" ").map(e.parseRtcpFb),r.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(d.name.toUpperCase())}}}e.matchPrefix(n,"a=extmap:").forEach(s=>{r.headerExtensions.push(e.parseExtmap(s))});const o=e.matchPrefix(n,"a=rtcp-fb:* ").map(e.parseRtcpFb);return r.codecs.forEach(s=>{o.forEach(a=>{s.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||s.rtcpFeedback.push(a)})}),r},e.writeRtpDescription=function(n,r){let i="";i+="m="+n+" ",i+=r.codecs.length>0?"9":"0",i+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=r.codecs.map(s=>void 0!==s.preferredPayloadType?s.preferredPayloadType:s.payloadType).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach(s=>{i+=e.writeRtpMap(s),i+=e.writeFmtp(s),i+=e.writeRtcpFb(s)});let o=0;return r.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime)}),o>0&&(i+="a=maxptime:"+o+"\r\n"),r.headerExtensions&&r.headerExtensions.forEach(s=>{i+=e.writeExtmap(s)}),i},e.parseRtpEncodingParameters=function(n){const r=[],i=e.parseRtpParameters(n),o=-1!==i.fecMechanisms.indexOf("RED"),s=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=e.matchPrefix(n,"a=ssrc:").map(p=>e.parseSsrcMedia(p)).filter(p=>"cname"===p.attribute),c=a.length>0&&a[0].ssrc;let d;const u=e.matchPrefix(n,"a=ssrc-group:FID").map(p=>p.substring(17).split(" ").map(h=>parseInt(h,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(d=u[0][1]),i.codecs.forEach(p=>{if("RTX"===p.name.toUpperCase()&&p.parameters.apt){let h={ssrc:c,codecPayloadType:parseInt(p.parameters.apt,10)};c&&d&&(h.rtx={ssrc:d}),r.push(h),o&&(h=JSON.parse(JSON.stringify(h)),h.fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},r.push(h))}}),0===r.length&&c&&r.push({ssrc:c});let l=e.matchPrefix(n,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,r.forEach(p=>{p.maxBitrate=l})),r},e.parseRtcpParameters=function(n){const r={},i=e.matchPrefix(n,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>"cname"===a.attribute)[0];i&&(r.cname=i.value,r.ssrc=i.ssrc);const o=e.matchPrefix(n,"a=rtcp-rsize");r.reducedSize=o.length>0,r.compound=0===o.length;const s=e.matchPrefix(n,"a=rtcp-mux");return r.mux=s.length>0,r},e.writeRtcpParameters=function(n){let r="";return n.reducedSize&&(r+="a=rtcp-rsize\r\n"),n.mux&&(r+="a=rtcp-mux\r\n"),void 0!==n.ssrc&&n.cname&&(r+="a=ssrc:"+n.ssrc+" cname:"+n.cname+"\r\n"),r},e.parseMsid=function(n){let r;const i=e.matchPrefix(n,"a=msid:");if(1===i.length)return r=i[0].substring(7).split(" "),{stream:r[0],track:r[1]};const o=e.matchPrefix(n,"a=ssrc:").map(s=>e.parseSsrcMedia(s)).filter(s=>"msid"===s.attribute);return o.length>0?(r=o[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},e.parseSctpDescription=function(n){const r=e.parseMLine(n),i=e.matchPrefix(n,"a=max-message-size:");let o;i.length>0&&(o=parseInt(i[0].substring(19),10)),isNaN(o)&&(o=65536);const s=e.matchPrefix(n,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:r.fmt,maxMessageSize:o};const a=e.matchPrefix(n,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},e.writeSctpDescription=function(n,r){let i=[];return i="DTLS/SCTP"!==n.protocol?["m="+n.kind+" 9 "+n.protocol+" "+r.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+r.port+"\r\n"]:["m="+n.kind+" 9 "+n.protocol+" "+r.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+r.port+" "+r.protocol+" 65535\r\n"],void 0!==r.maxMessageSize&&i.push("a=max-message-size:"+r.maxMessageSize+"\r\n"),i.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(n,r,i){let o;const s=void 0!==r?r:2;return o=n||e.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+o+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},e.getDirection=function(n,r){const i=e.splitLines(n);for(let o=0;o<i.length;o++)switch(i[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[o].substring(2)}return r?e.getDirection(r):"sendrecv"},e.getKind=function(n){return e.splitLines(n)[0].split(" ")[0].substring(2)},e.isRejected=function(n){return"0"===n.split(" ",2)[1]},e.parseMLine=function(n){const r=e.splitLines(n)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(n){const r=e.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(n){if("string"!=typeof n||0===n.length)return!1;const r=e.splitLines(n);for(let i=0;i<r.length;i++)if(r[i].length<2||"="!==r[i].charAt(1))return!1;return!0},t.exports=e}(wS);var NS=wS.exports,ys=Wt(NS),KU=function os(t,e){return e.forEach(function(n){n&&"string"!=typeof n&&!Array.isArray(n)&&Object.keys(n).forEach(function(r){if("default"!==r&&!(r in t)){var i=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(t,r,i.get?i:{enumerable:!0,get:function(){return n[r]}})}})}),Object.freeze(t)}({__proto__:null,default:ys},[NS]);function Vd(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(n){if("object"==typeof n&&n.candidate&&0===n.candidate.indexOf("a=")&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){const r=new e(n),i=ys.parseCandidate(n.candidate),o=Object.assign(r,i);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(n)},t.RTCIceCandidate.prototype=e.prototype,vo(t,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new t.RTCIceCandidate(n.candidate),writable:"false"}),n))}function Th(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||vo(t,"icecandidate",e=>{if(e.candidate){const n=ys.parseCandidate(e.candidate.candidate);"relay"===n.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return e})}function Fd(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const s=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===e.browser&&e.version>=76){const{sdpSemantics:a}=this.getConfiguration();"plan-b"===a&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(a){if(!a||!a.sdp)return!1;const c=ys.splitSections(a.sdp);return c.shift(),c.some(d=>{const u=ys.parseMLine(d);return u&&"application"===u.kind&&-1!==u.protocol.indexOf("SCTP")})}(arguments[0])){const a=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===c||c.length<2)return-1;const d=parseInt(c[1],10);return d!=d?-1:d}(arguments[0]),c=function(a){let c=65536;return"firefox"===e.browser&&(c=e.version<57?-1===a?16384:2147483637:e.version<60?57===e.version?65535:65536:2147483637),c}(a),d=function(a,c){let d=65536;"firefox"===e.browser&&57===e.version&&(d=65535);const u=ys.matchPrefix(a.sdp,"a=max-message-size:");return u.length>0?d=parseInt(u[0].substr(19),10):"firefox"===e.browser&&-1!==c&&(d=2147483637),d}(arguments[0],a);let u;u=0===c&&0===d?Number.POSITIVE_INFINITY:0===c||0===d?Math.max(c,d):Math.min(c,d);const l={};Object.defineProperty(l,"maxMessageSize",{get:()=>u}),this._sctp=l}return s.apply(this,arguments)}}function Bd(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(r,i){const o=r.send;r.send=function(){const s=arguments[0];if("open"===r.readyState&&i.sctp&&(s.length||s.size||s.byteLength)>i.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+i.sctp.maxMessageSize+" bytes)");return o.apply(r,arguments)}}const n=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const r=n.apply(this,arguments);return e(r,this),r},vo(t,"datachannel",r=>(e(r.channel,r.target),r))}function Sh(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{const r=e[n];e[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=i=>{const o=i.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const s=new Event("connectionstatechange",i);o.dispatchEvent(s)}return i},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function Rh(t,e){if(!t.RTCPeerConnection||"chrome"===e.browser&&e.version>=71||"safari"===e.browser&&e.version>=605)return;const n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&-1!==r.sdp.indexOf("\na=extmap-allow-mixed")){const i=r.sdp.split("\n").filter(o=>"a=extmap-allow-mixed"!==$e(o).call(o)).join("\n");t.RTCSessionDescription&&r instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:r.type,sdp:i}):r.sdp=i}return n.apply(this,arguments)}}function jd(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype.addIceCandidate;n&&0!==n.length&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===e.browser&&e.version<78||"firefox"===e.browser&&e.version<68||"safari"===e.browser)&&arguments[0]&&""===arguments[0].candidate?H.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),H.resolve())})}function Gd(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype.setLocalDescription;n&&0!==n.length&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if("object"!=typeof r||r.type&&r.sdp)return n.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer"}return r.sdp||"offer"!==r.type&&"answer"!==r.type?n.apply(this,[r]):("offer"===r.type?this.createOffer:this.createAnswer).apply(this).then(i=>n.apply(this,[i]))})}var YU=Object.freeze({__proto__:null,removeExtmapAllowMixed:Rh,shimAddIceCandidateNullOrEmpty:jd,shimConnectionState:Sh,shimMaxMessageSize:Fd,shimParameterlessSetLocalDescription:Gd,shimRTCIceCandidate:Vd,shimRTCIceCandidateRelayProtocol:Th,shimSendThrowTypeError:Bd});!function(){let{window:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=Zf,r=function(o){const s={browser:null,version:null};if(void 0===o||!o.navigator)return s.browser="Not a browser.",s;const{navigator:a}=o;if(a.mozGetUserMedia)s.browser="firefox",s.version=hd(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||!1===o.isSecureContext&&o.webkitRTCPeerConnection)s.browser="chrome",s.version=hd(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!o.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return s.browser="Not a supported browser.",s;s.browser="safari",s.version=hd(a.userAgent,/AppleWebKit\/(\d+)\./,1),s.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype}return s}(t),i={browserDetails:r,commonShim:YU,extractVersion:hd,disableLog:HP,disableWarnings:KP,sdp:KU};switch(r.browser){case"chrome":if(!iS||!_h||!e.shimChrome)return n("Chrome shim is not included in this adapter release."),i;if(null===r.version)return n("Chrome shim can not determine version, not shimming."),i;n("adapter.js shimming chrome."),i.browserShim=iS,jd(t,r),Gd(t),JT(t,r),XT(t),_h(t,r),QT(t),nS(t,r),ZT(t),$T(t),tS(t),rS(t,r),Vd(t),Th(t),Sh(t),Fd(t,r),Bd(t),Rh(t,r);break;case"firefox":if(!ES||!Eh||!e.shimFirefox)return n("Firefox shim is not included in this adapter release."),i;n("adapter.js shimming firefox."),i.browserShim=ES,jd(t,r),Gd(t),oS(t,r),Eh(t,r),sS(t),dS(t),aS(t),cS(t),uS(t),lS(t),pS(t),hS(t),_S(t),Vd(t),Sh(t),Fd(t,r),Bd(t);break;case"safari":if(!IS||!e.shimSafari)return n("Safari shim is not included in this adapter release."),i;n("adapter.js shimming safari."),i.browserShim=IS,jd(t,r),Gd(t),RS(t),yS(t),gS(t),mS(t),fS(t),vS(t),TS(t),CS(t),Vd(t),Th(t),Fd(t,r),Bd(t),Rh(t,r);break;default:n("Unsupported browser!")}}({window:typeof window>"u"?void 0:window});var qU=ur("Array").keys,zU=zr,JU=ze,XU=on,QU=qU,vh=Array.prototype,ZU={DOMTokenList:!0,NodeList:!0},kn=Wt(function(t){var e=t.keys;return t===vh||XU(vh,t)&&e===vh.keys||JU(ZU,zU(t))?QU:e}),DS=ds,t2=TypeError,e2=cd,n2=dr,r2=xi,Wd=function(t,e,n){var r=e2(e);r in t?n2.f(t,r,r2(0,n)):t[r]=n},PS=sp,i2=gi,o2=Wd,s2=Array,a2=Math.max,yh=function(t,e,n){for(var r=i2(t),i=PS(e,r),o=PS(void 0===n?r:n,r),s=s2(a2(o-i,0)),a=0;i<o;i++,a++)o2(s,a,t[i]);return s.length=a,s},LS=yh,c2=Math.floor,Ch=function(t,e){var n=t.length,r=c2(n/2);return n<8?d2(t,e):u2(t,Ch(LS(t,0,r),e),Ch(LS(t,r),e),e)},d2=function(t,e){for(var n,r,i=t.length,o=1;o<i;){for(r=o,n=t[o];r&&e(t[r-1],n)>0;)t[r]=t[--r];r!==o++&&(t[r]=n)}return t},u2=function(t,e,n,r){for(var i=e.length,o=n.length,s=0,a=0;s<i||a<o;)t[s+a]=s<i&&a<o?r(e[s],n[a])<=0?e[s++]:n[a++]:s<i?e[s++]:n[a++];return t},kS=Ch,MS=Fi.match(/firefox\/(\d+)/i),l2=!!MS&&+MS[1],p2=/MSIE|Trident/.test(Fi),US=Fi.match(/AppleWebKit\/(\d+)\./),_2=Lt,xS=Te,E2=zn,m2=qr,VS=gi,f2=function(t,e){if(!delete t[e])throw t2("Cannot delete property "+DS(e)+" of "+DS(t))},FS=Jn,Ih=te,g2=kS,T2=pd,BS=l2,S2=p2,jS=Ro,GS=!!US&&+US[1],Ki=[],WS=xS(Ki.sort),R2=xS(Ki.push),v2=Ih(function(){Ki.sort(void 0)}),y2=Ih(function(){Ki.sort(null)}),C2=T2("sort"),HS=!Ih(function(){if(jS)return jS<70;if(!(BS&&BS>3)){if(S2)return!0;if(GS)return GS<603;var t,e,n,r,i="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(r=0;r<47;r++)Ki.push({k:e+r,v:n})}for(Ki.sort(function(o,s){return s.v-o.v}),r=0;r<Ki.length;r++)e=Ki[r].k.charAt(0),i.charAt(i.length-1)!==e&&(i+=e);return"DGBEFHACIJK"!==i}});_2({target:"Array",proto:!0,forced:v2||!y2||!C2||!HS},{sort:function(t){void 0!==t&&E2(t);var e=m2(this);if(HS)return void 0===t?WS(e):WS(e,t);var n,r,i=[],o=VS(e);for(r=0;r<o;r++)r in e&&R2(i,e[r]);for(g2(i,function(s){return function(a,c){return void 0===c?-1:void 0===a?1:void 0!==s?+s(a,c)||0:FS(a)>FS(c)?1:-1}}(t)),n=VS(i),r=0;r<n;)e[r]=i[r++];for(;r<o;)f2(e,r++);return e}});var I2=ur("Array").sort,A2=on,b2=I2,Ah=Array.prototype,Ga=Wt(function(t){var e=t.sort;return t===Ah||A2(Ah,t)&&e===Ah.sort?b2:e}),bh={exports:{}};!function(t,e){!function(n,r){var i="function",o="undefined",s="object",a="string",c="major",d="model",u="name",l="type",p="vendor",h="version",S="architecture",m="console",f="mobile",g="tablet",R="smarttv",C="wearable",b="embedded",w="Amazon",D="Apple",V="ASUS",U="BlackBerry",k="Browser",Z="Chrome",$="Firefox",Rt="Google",Yt="Microsoft",wr="Motorola",M="Opera",B="Samsung",J="Sharp",st="Sony",yt="Xiaomi",G="Zebra",E="Facebook",I="Chromium OS",O="Mac OS",F=function(le){for(var ve={},qt=0;qt<le.length;qt++)ve[le[qt].toUpperCase()]=le[qt];return ve},at=function(le,ve){return typeof le===a&&-1!==Pt(ve).indexOf(Pt(le))},Pt=function(le){return le.toLowerCase()},Oe=function(le,ve){if(typeof le===a)return le=le.replace(/^\s\s*/,""),typeof ve===o?le:le.substring(0,350)},vn=function(le,ve){for(var qt,Pn,mi,pe,Ct,yn,So=0;So<ve.length&&!Ct;){var Hr=ve[So],uN=ve[So+1];for(qt=Pn=0;qt<Hr.length&&!Ct&&Hr[qt];)if(Ct=Hr[qt++].exec(le))for(mi=0;mi<uN.length;mi++)yn=Ct[++Pn],typeof(pe=uN[mi])===s&&pe.length>0?2===pe.length?this[pe[0]]=typeof pe[1]==i?pe[1].call(this,yn):pe[1]:3===pe.length?this[pe[0]]=typeof pe[1]!==i||pe[1].exec&&pe[1].test?yn?yn.replace(pe[1],pe[2]):r:yn?pe[1].call(this,yn,pe[2]):r:4===pe.length&&(this[pe[0]]=yn?pe[3].call(this,yn.replace(pe[1],pe[2])):r):this[pe]=yn||r;So+=2}},Li=function(le,ve){for(var qt in ve)if(typeof ve[qt]===s&&ve[qt].length>0){for(var Pn=0;Pn<ve[qt].length;Pn++)if(at(ve[qt][Pn],le))return"?"===qt?r:qt}else if(at(ve[qt],le))return"?"===qt?r:qt;return le},xl={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Vl={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[h,[u,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[h,[u,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[u,h],[/opios[\/ ]+([\w\.]+)/i],[h,[u,M+" Mini"]],[/\bopr\/([\w\.]+)/i],[h,[u,M]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[u,h],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[h,[u,"UC"+k]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[h,[u,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[h,[u,"WeChat"]],[/konqueror\/([\w\.]+)/i],[h,[u,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[h,[u,"IE"]],[/yabrowser\/([\w\.]+)/i],[h,[u,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[u,/(.+)/,"$1 Secure "+k],h],[/\bfocus\/([\w\.]+)/i],[h,[u,$+" Focus"]],[/\bopt\/([\w\.]+)/i],[h,[u,M+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[h,[u,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[h,[u,"Dolphin"]],[/coast\/([\w\.]+)/i],[h,[u,M+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[h,[u,"MIUI "+k]],[/fxios\/([-\w\.]+)/i],[h,[u,$]],[/\bqihu|(qi?ho?o?|360)browser/i],[[u,"360 "+k]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[u,/(.+)/,"$1 "+k],h],[/(comodo_dragon)\/([\w\.]+)/i],[[u,/_/g," "],h],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[u,h],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[u],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[u,E],h],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[u,h],[/\bgsa\/([\w\.]+) .*safari\//i],[h,[u,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[h,[u,Z+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[u,Z+" WebView"],h],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[h,[u,"Android "+k]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[u,h],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[h,[u,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[h,u],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[u,[h,Li,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[u,h],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[u,"Netscape"],h],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[h,[u,$+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[u,h],[/(cobalt)\/([\w\.]+)/i],[u,[h,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[S,"amd64"]],[/(ia32(?=;))/i],[[S,Pt]],[/((?:i[346]|x)86)[;\)]/i],[[S,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[S,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[S,"armhf"]],[/windows (ce|mobile); ppc;/i],[[S,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[S,/ower/,"",Pt]],[/(sun4\w)[;\)]/i],[[S,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[S,Pt]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[p,B],[l,g]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[p,B],[l,f]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[p,D],[l,f]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[p,D],[l,g]],[/(macintosh);/i],[d,[p,D]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[p,J],[l,f]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[p,"Huawei"],[l,g]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[p,"Huawei"],[l,f]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[p,yt],[l,f]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[p,yt],[l,g]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[p,"OPPO"],[l,f]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[p,"Vivo"],[l,f]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[p,"Realme"],[l,f]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[p,wr],[l,f]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[p,wr],[l,g]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[p,"LG"],[l,g]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[p,"LG"],[l,f]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[p,"Lenovo"],[l,g]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[p,"Nokia"],[l,f]],[/(pixel c)\b/i],[d,[p,Rt],[l,g]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[p,Rt],[l,f]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[p,st],[l,f]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[p,st],[l,g]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[p,"OnePlus"],[l,f]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[p,w],[l,g]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[p,w],[l,f]],[/(playbook);[-\w\),; ]+(rim)/i],[d,p,[l,g]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[p,U],[l,f]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[p,V],[l,g]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[p,V],[l,f]],[/(nexus 9)/i],[d,[p,"HTC"],[l,g]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[p,[d,/_/g," "],[l,f]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[p,"Acer"],[l,g]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[p,"Meizu"],[l,f]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[p,d,[l,f]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[p,d,[l,g]],[/(surface duo)/i],[d,[p,Yt],[l,g]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[p,"Fairphone"],[l,f]],[/(u304aa)/i],[d,[p,"AT&T"],[l,f]],[/\bsie-(\w*)/i],[d,[p,"Siemens"],[l,f]],[/\b(rct\w+) b/i],[d,[p,"RCA"],[l,g]],[/\b(venue[\d ]{2,7}) b/i],[d,[p,"Dell"],[l,g]],[/\b(q(?:mv|ta)\w+) b/i],[d,[p,"Verizon"],[l,g]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[p,"Barnes & Noble"],[l,g]],[/\b(tm\d{3}\w+) b/i],[d,[p,"NuVision"],[l,g]],[/\b(k88) b/i],[d,[p,"ZTE"],[l,g]],[/\b(nx\d{3}j) b/i],[d,[p,"ZTE"],[l,f]],[/\b(gen\d{3}) b.+49h/i],[d,[p,"Swiss"],[l,f]],[/\b(zur\d{3}) b/i],[d,[p,"Swiss"],[l,g]],[/\b((zeki)?tb.*\b) b/i],[d,[p,"Zeki"],[l,g]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[p,"Dragon Touch"],d,[l,g]],[/\b(ns-?\w{0,9}) b/i],[d,[p,"Insignia"],[l,g]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[p,"NextBook"],[l,g]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[p,"Voice"],d,[l,f]],[/\b(lvtel\-)?(v1[12]) b/i],[[p,"LvTel"],d,[l,f]],[/\b(ph-1) /i],[d,[p,"Essential"],[l,f]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[p,"Envizen"],[l,g]],[/\b(trio[-\w\. ]+) b/i],[d,[p,"MachSpeed"],[l,g]],[/\btu_(1491) b/i],[d,[p,"Rotor"],[l,g]],[/(shield[\w ]+) b/i],[d,[p,"Nvidia"],[l,g]],[/(sprint) (\w+)/i],[p,d,[l,f]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[p,Yt],[l,f]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[p,G],[l,g]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[p,G],[l,f]],[/smart-tv.+(samsung)/i],[p,[l,R]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[p,B],[l,R]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[p,"LG"],[l,R]],[/(apple) ?tv/i],[p,[d,D+" TV"],[l,R]],[/crkey/i],[[d,Z+"cast"],[p,Rt],[l,R]],[/droid.+aft(\w)( bui|\))/i],[d,[p,w],[l,R]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[p,J],[l,R]],[/(bravia[\w ]+)( bui|\))/i],[d,[p,st],[l,R]],[/(mitv-\w{5}) bui/i],[d,[p,yt],[l,R]],[/Hbbtv.*(technisat) (.*);/i],[p,d,[l,R]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[p,Oe],[d,Oe],[l,R]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[l,R]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[p,d,[l,m]],[/droid.+; (shield) bui/i],[d,[p,"Nvidia"],[l,m]],[/(playstation [345portablevi]+)/i],[d,[p,st],[l,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[p,Yt],[l,m]],[/((pebble))app/i],[p,d,[l,C]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[p,D],[l,C]],[/droid.+; (glass) \d/i],[d,[p,Rt],[l,C]],[/droid.+; (wt63?0{2,3})\)/i],[d,[p,G],[l,C]],[/(quest( 2| pro)?)/i],[d,[p,E],[l,C]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[p,[l,b]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[l,f]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[l,g]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[l,g]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[l,f]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[p,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[h,[u,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[h,[u,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[u,h],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[h,u]],os:[[/microsoft (windows) (vista|xp)/i],[u,h],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[u,[h,Li,xl]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[u,"Windows"],[h,Li,xl]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[h,/_/g,"."],[u,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[u,O],[h,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[h,u],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[u,h],[/\(bb(10);/i],[h,[u,U]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[h,[u,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[h,[u,$+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[h,[u,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[h,[u,"watchOS"]],[/crkey\/([\d\.]+)/i],[h,[u,Z+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[u,I],h],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[u,h],[/(sunos) ?([\w\.\d]*)/i],[[u,"Solaris"],h],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[u,h]]},ar=function(le,ve){if(typeof le===s&&(ve=le,le=r),!(this instanceof ar))return new ar(le,ve).getResult();var qt=typeof n!==o&&n.navigator?n.navigator:r,Pn=le||(qt&&qt.userAgent?qt.userAgent:""),mi=qt&&qt.userAgentData?qt.userAgentData:r,pe=ve?function(Ct,yn){var So={};for(var Hr in Ct)So[Hr]=yn[Hr]&&yn[Hr].length%2==0?yn[Hr].concat(Ct[Hr]):Ct[Hr];return So}(Vl,ve):Vl;return this.getBrowser=function(){var yn,Ct={};return Ct[u]=r,Ct[h]=r,vn.call(Ct,Pn,pe.browser),Ct[c]=typeof(yn=Ct[h])===a?yn.replace(/[^\d\.]/g,"").split(".")[0]:r,qt&&qt.brave&&typeof qt.brave.isBrave==i&&(Ct[u]="Brave"),Ct},this.getCPU=function(){var Ct={};return Ct[S]=r,vn.call(Ct,Pn,pe.cpu),Ct},this.getDevice=function(){var Ct={};return Ct[p]=r,Ct[d]=r,Ct[l]=r,vn.call(Ct,Pn,pe.device),!Ct[l]&&mi&&mi.mobile&&(Ct[l]=f),"Macintosh"==Ct[d]&&qt&&typeof qt.standalone!==o&&qt.maxTouchPoints&&qt.maxTouchPoints>2&&(Ct[d]="iPad",Ct[l]=g),Ct},this.getEngine=function(){var Ct={};return Ct[u]=r,Ct[h]=r,vn.call(Ct,Pn,pe.engine),Ct},this.getOS=function(){var Ct={};return Ct[u]=r,Ct[h]=r,vn.call(Ct,Pn,pe.os),!Ct[u]&&mi&&"Unknown"!=mi.platform&&(Ct[u]=mi.platform.replace(/chrome os/i,I).replace(/macos/i,O)),Ct},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Pn},this.setUA=function(Ct){return Pn=typeof Ct===a&&Ct.length>350?Oe(Ct,350):Ct,this},this.setUA(Pn),this};ar.VERSION="0.7.34",ar.BROWSER=F([u,h,c]),ar.CPU=F([S]),ar.DEVICE=F([d,p,l,m,f,R,g,C,b]),ar.ENGINE=ar.OS=F([u,h]),t.exports&&(e=t.exports=ar),e.UAParser=ar;var To=typeof n!==o&&(n.jQuery||n.Zepto);if(To&&!To.ua){var Ia=new ar;To.ua=Ia.getResult(),To.ua.get=function(){return Ia.getUA()},To.ua.set=function(le){Ia.setUA(le);var ve=Ia.getResult();for(var qt in ve)To.ua[qt]=ve[qt]}}}("object"==typeof window?window:cr)}(bh,bh.exports);var w2=Wt(bh.exports),N2=zr,D2=ze,P2=ss,L2=yo,k2=he("iterator"),M2=Object,x2=Wt(function(t){if(P2(t))return!1;var e=M2(t);return void 0!==e[k2]||"@@iterator"in e||D2(L2,N2(e))});Lt({global:!0,forced:Ae.globalThis!==Ae},{globalThis:Ae});var KS=Wt(Ae),YS=Dd.clear;Lt({global:!0,bind:!0,enumerable:!0,forced:Ae.clearImmediate!==YS},{clearImmediate:YS});var V2="function"==typeof Bun&&Bun&&"string"==typeof Bun.version,qS=Ae,F2=ed,B2=Le,j2=V2,W2=Nd,H2=gs,K2=qS.Function,Y2=/MSIE .\./.test(Fi)||j2&&function(){var t=qS.Bun.version.split(".");return t.length<3||0==t[0]&&(t[1]<3||3==t[1]&&0==t[2])}(),q2=Lt,zS=Ae,JS=Dd.set,XS=zS.setImmediate?function(t,e){var n=e?2:1;return Y2?function(r,i){var o=H2(arguments.length,1)>n,s=B2(r)?r:K2(r),a=o?W2(arguments,n):[],c=o?function(){F2(s,this,a)}:s;return e?t(c,i):t(c)}:t}(JS,!1):JS;q2({global:!0,bind:!0,enumerable:!0,forced:zS.setImmediate!==XS},{setImmediate:XS});var QS=Wt(qn.setImmediate),X2=_T,Q2=zn,Z2=gs,$2=_s,tx=Ae.process;Lt({global:!0,enumerable:!0,dontCallGetSet:!0},{queueMicrotask:function(t){Z2(arguments.length,1),Q2(t);var e=$2&&tx.domain;X2(e?e.bind(t):t)}});var ZS=Wt(qn.queueMicrotask);function $S(t,e){return function(){return t.apply(e,arguments)}}const{toString:ex}=Object.prototype,{getPrototypeOf:wh}=Object,Hd=(Nh=Object.create(null),t=>{const e=ex.call(t);return Nh[e]||(Nh[e]=e.slice(8,-1).toLowerCase())});var Nh;const Dr=t=>(t=t.toLowerCase(),e=>Hd(e)===t),Kd=t=>e=>typeof e===t,{isArray:Cs}=Array,Wa=Kd("undefined"),tR=Dr("ArrayBuffer"),nx=Kd("string"),Qn=Kd("function"),eR=Kd("number"),Yd=t=>null!==t&&"object"==typeof t,qd=t=>{if("object"!==Hd(t))return!1;const e=wh(t);return!(null!==e&&e!==Object.prototype&&null!==Object.getPrototypeOf(e)||Symbol.toStringTag in t||x2(t))},rx=Dr("Date"),ix=Dr("File"),ox=Dr("Blob"),sx=Dr("FileList"),ax=Dr("URLSearchParams"),[cx,dx,ux,lx]=["ReadableStream","Request","Response","Headers"].map(Dr);function Ha(t,e){let n,r,{allOwnKeys:i=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null!=t)if("object"!=typeof t&&(t=[t]),Cs(t))for(n=0,r=t.length;n<r;n++)e.call(null,t[n],n,t);else{const o=i?Object.getOwnPropertyNames(t):Object.keys(t),s=o.length;let a;for(n=0;n<s;n++)a=o[n],e.call(null,t[a],a,t)}}function nR(t,e){e=e.toLowerCase();const n=Object.keys(t);let r,i=n.length;for(;i-- >0;)if(r=n[i],e===r.toLowerCase())return r;return null}const Oo=void 0!==KS?KS:typeof self<"u"?self:typeof window<"u"?window:global,rR=t=>!Wa(t)&&t!==Oo,px=(Dh=typeof Uint8Array<"u"&&wh(Uint8Array),t=>Dh&&t instanceof Dh);var Dh;const hx=Dr("HTMLFormElement"),iR=(t=>{let{hasOwnProperty:e}=t;return(n,r)=>e.call(n,r)})(Object.prototype),_x=Dr("RegExp"),oR=(t,e)=>{const n=Object.getOwnPropertyDescriptors(t),r={};Ha(n,(i,o)=>{let s;!1!==(s=e(i,o,t))&&(r[o]=s||i)}),Object.defineProperties(t,r)},Ph="abcdefghijklmnopqrstuvwxyz",sR="0123456789",aR={DIGIT:sR,ALPHA:Ph,ALPHA_DIGIT:Ph+Ph.toUpperCase()+sR},Ex=Dr("AsyncFunction"),cR=(dR="function"==typeof QS,uR=Qn(Oo.postMessage),dR?QS:uR?(Lh="axios@".concat(Math.random()),zd=[],Oo.addEventListener("message",t=>{let{source:e,data:n}=t;e===Oo&&n===Lh&&zd.length&&zd.shift()()},!1),t=>{zd.push(t),Oo.postMessage(Lh,"*")}):t=>setTimeout(t));var dR,uR,Lh,zd;const mx=void 0!==ZS?ZS.bind(Oo):typeof process<"u"&&process.nextTick||cR;var j={isArray:Cs,isArrayBuffer:tR,isBuffer:function(t){return null!==t&&!Wa(t)&&null!==t.constructor&&!Wa(t.constructor)&&Qn(t.constructor.isBuffer)&&t.constructor.isBuffer(t)},isFormData:t=>{let e;return t&&("function"==typeof FormData&&t instanceof FormData||Qn(t.append)&&("formdata"===(e=Hd(t))||"object"===e&&Qn(t.toString)&&"[object FormData]"===t.toString()))},isArrayBufferView:function(t){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&tR(t.buffer),e},isString:nx,isNumber:eR,isBoolean:t=>!0===t||!1===t,isObject:Yd,isPlainObject:qd,isReadableStream:cx,isRequest:dx,isResponse:ux,isHeaders:lx,isUndefined:Wa,isDate:rx,isFile:ix,isBlob:ox,isRegExp:_x,isFunction:Qn,isStream:t=>Yd(t)&&Qn(t.pipe),isURLSearchParams:ax,isTypedArray:px,isFileList:sx,forEach:Ha,merge:function t(){const{caseless:e}=rR(this)&&this||{},n={},r=(i,o)=>{const s=e&&nR(n,o)||o;n[s]=qd(n[s])&&qd(i)?t(n[s],i):qd(i)?t({},i):Cs(i)?i.slice():i};for(let i=0,o=arguments.length;i<o;i++)arguments[i]&&Ha(arguments[i],r);return n},extend:function(t,e,n){let{allOwnKeys:r}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return Ha(e,(i,o)=>{t[o]=n&&Qn(i)?$S(i,n):i},{allOwnKeys:r}),t},trim:t=>$e(t)?$e(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(65279===t.charCodeAt(0)&&(t=t.slice(1)),t),inherits:(t,e,n,r)=>{t.prototype=Object.create(e.prototype,r),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},toFlatObject:(t,e,n,r)=>{let i,o,s;const a={};if(e=e||{},null==t)return e;do{for(i=Object.getOwnPropertyNames(t),o=i.length;o-- >0;)s=i[o],r&&!r(s,t,e)||a[s]||(e[s]=t[s],a[s]=!0);t=!1!==n&&wh(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},kindOf:Hd,kindOfTest:Dr,endsWith:(t,e,n)=>{t=String(t),(void 0===n||n>t.length)&&(n=t.length);const r=t.indexOf(e,n-=e.length);return-1!==r&&r===n},toArray:t=>{if(!t)return null;if(Cs(t))return t;let e=t.length;if(!eR(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},forEachEntry:(t,e)=>{const n=(t&&t[Symbol.iterator]).call(t);let r;for(;(r=n.next())&&!r.done;){const i=r.value;e.call(t,i[0],i[1])}},matchAll:(t,e)=>{let n;const r=[];for(;null!==(n=t.exec(e));)r.push(n);return r},isHTMLForm:hx,hasOwnProperty:iR,hasOwnProp:iR,reduceDescriptors:oR,freezeMethods:t=>{oR(t,(e,n)=>{if(Qn(t)&&-1!==["arguments","caller","callee"].indexOf(n))return!1;Qn(t[n])&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))})},toObjectSet:(t,e)=>{const n={},r=i=>{i.forEach(o=>{n[o]=!0})};return Cs(t)?r(t):r(String(t).split(e)),n},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,n,r){return n.toUpperCase()+r}),noop:()=>{},toFiniteNumber:(t,e)=>null!=t&&Number.isFinite(t=+t)?t:e,findKey:nR,global:Oo,isContextDefined:rR,ALPHABET:aR,generateString:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:aR.ALPHA_DIGIT,n="";const{length:r}=e;for(;t--;)n+=e[Math.random()*r|0];return n},isSpecCompliantForm:function(t){return!!(t&&Qn(t.append)&&"FormData"===t[Symbol.toStringTag]&&t[Symbol.iterator])},toJSONObject:t=>{const e=new Array(10),n=(r,i)=>{if(Yd(r)){if(e.indexOf(r)>=0)return;if(!("toJSON"in r)){e[i]=r;const o=Cs(r)?[]:{};return Ha(r,(s,a)=>{const c=n(s,i+1);!Wa(c)&&(o[a]=c)}),e[i]=void 0,o}}return r};return n(t,0)},isAsyncFn:Ex,isThenable:t=>t&&(Yd(t)||Qn(t))&&Qn(t.then)&&Qn(t.catch),setImmediate:cR,asap:mx};function kt(t,e,n,r,i){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),r&&(this.request=r),i&&(this.response=i,this.status=i.status?i.status:null)}j.inherits(kt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:j.toJSONObject(this.config),code:this.code,status:this.status}}});const lR=kt.prototype,pR={};function kh(t){return j.isPlainObject(t)||j.isArray(t)}function hR(t){return j.endsWith(t,"[]")?t.slice(0,-2):t}function _R(t,e,n){return t?t.concat(e).map(function(r,i){return r=hR(r),!n&&i?"["+r+"]":r}).join(n?".":""):e}["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{pR[t]={value:t}}),Object.defineProperties(kt,pR),Object.defineProperty(lR,"isAxiosError",{value:!0}),kt.from=(t,e,n,r,i,o)=>{const s=Object.create(lR);return j.toFlatObject(t,s,function(a){return a!==Error.prototype},a=>"isAxiosError"!==a),kt.call(s,t.message,e,n,r,i),s.cause=t,s.name=t.name,o&&Object.assign(s,o),s};const fx=j.toFlatObject(j,{},null,function(t){return/^is[A-Z]/.test(t)});function Jd(t,e,n){if(!j.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;const r=(n=j.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(p,h){return!j.isUndefined(h[p])})).metaTokens,i=n.visitor||d,o=n.dots,s=n.indexes,a=(n.Blob||typeof Blob<"u"&&Blob)&&j.isSpecCompliantForm(e);if(!j.isFunction(i))throw new TypeError("visitor must be a function");function c(p){if(null===p)return"";if(j.isDate(p))return p.toISOString();if(!a&&j.isBlob(p))throw new kt("Blob is not supported. Use a Buffer instead.");return j.isArrayBuffer(p)||j.isTypedArray(p)?a&&"function"==typeof Blob?new Blob([p]):Buffer.from(p):p}function d(p,h,S){let m=p;if(p&&!S&&"object"==typeof p)if(j.endsWith(h,"{}"))h=r?h:h.slice(0,-2),p=JSON.stringify(p);else if(j.isArray(p)&&j.isArray(f=p)&&!f.some(kh)||(j.isFileList(p)||j.endsWith(h,"[]"))&&(m=j.toArray(p)))return h=hR(h),m.forEach(function(f,g){!j.isUndefined(f)&&null!==f&&e.append(!0===s?_R([h],g,o):null===s?h:h+"[]",c(f))}),!1;var f;return!!kh(p)||(e.append(_R(S,h,o),c(p)),!1)}const u=[],l=Object.assign(fx,{defaultVisitor:d,convertValue:c,isVisitable:kh});if(!j.isObject(t))throw new TypeError("data must be an object");return function p(h,S){if(!j.isUndefined(h)){if(-1!==u.indexOf(h))throw Error("Circular reference detected in "+S.join("."));u.push(h),j.forEach(h,function(m,f){!0===(!(j.isUndefined(m)||null===m)&&i.call(e,m,j.isString(f)?$e(f).call(f):f,S,l))&&p(m,S?S.concat(f):[f])}),u.pop()}}(t),e}function ER(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function Mh(t,e){this._pairs=[],t&&Jd(t,this,e)}const mR=Mh.prototype;function gx(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function fR(t,e,n){if(!e)return t;const r=n&&n.encode||gx,i=n&&n.serialize;let o;if(o=i?i(e,n):j.isURLSearchParams(e)?e.toString():new Mh(e,n).toString(r),o){const s=t.indexOf("#");-1!==s&&(t=t.slice(0,s)),t+=(-1===t.indexOf("?")?"?":"&")+o}return t}mR.append=function(t,e){this._pairs.push([t,e])},mR.toString=function(t){const e=t?function(n){return t.call(this,n,ER)}:ER;return this._pairs.map(function(n){return e(n[0])+"="+e(n[1])},"").join("&")};var gR=class{constructor(){this.handlers=[]}use(t,e,n){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){j.forEach(this.handlers,function(e){null!==e&&t(e)})}},TR={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},SR={exports:{}},RR=dr.f;Lt({target:"Object",stat:!0,forced:Object.defineProperty!==RR,sham:!Yn},{defineProperty:RR});var vR=qn.Object,Rx=SR.exports=function(t,e,n){return vR.defineProperty(t,e,n)};vR.defineProperty.sham&&(Rx.sham=!0);var yR=Wt(SR.exports),vx=Yr,Ka=Array.isArray||function(t){return"Array"==vx(t)},yx=TypeError,CR=Ka,Cx=wd,Ix=Ln,Ax=he("species"),IR=Array,AR=function(t,e){return new(function(t){var e;return CR(t)&&(Cx(e=t.constructor)&&(e===IR||CR(e.prototype))||Ix(e)&&null===(e=e[Ax]))&&(e=void 0),void 0===e?IR:e}(t))(0===e?0:e)},Ox=te,wx=Ro,Nx=he("species"),bR=function(t){return wx>=51||!Ox(function(){var e=[];return(e.constructor={})[Nx]=function(){return{foo:1}},1!==e[t](Boolean).foo})},Dx=Lt,Px=te,Lx=Ka,kx=Ln,Mx=qr,Ux=gi,OR=function(t){if(t>9007199254740991)throw yx("Maximum allowed index exceeded");return t},wR=Wd,xx=AR,Vx=bR,Fx=Ro,NR=he("isConcatSpreadable"),Bx=Fx>=51||!Px(function(){var t=[];return t[NR]=!1,t.concat()[0]!==t}),jx=function(t){if(!kx(t))return!1;var e=t[NR];return void 0!==e?!!e:Lx(t)};Dx({target:"Array",proto:!0,arity:1,forced:!Bx||!Vx("concat")},{concat:function(t){var e,n,r,i,o,s=Mx(this),a=xx(s,0),c=0;for(e=-1,r=arguments.length;e<r;e++)if(jx(o=-1===e?s:arguments[e]))for(i=Ux(o),OR(c+i),n=0;n<i;n++,c++)n in o&&wR(a,c,o[n]);else OR(c+1),wR(a,c++,o);return a.length=c,a}});var DR={},Gx=Yr,Wx=Vi,PR=Ed.f,Hx=yh,LR="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];DR.f=function(t){return LR&&"Window"==Gx(t)?function(e){try{return PR(e)}catch{return Hx(LR)}}(t):PR(Wx(t))};var Is={};Is.f=he;var kR=qn,Yx=ze,qx=Is,zx=dr.f,je=function(t){var e=kR.Symbol||(kR.Symbol={});Yx(e,t)||zx(e,t,{value:qx.f(t)})},Jx=Be,Xx=Cn,Qx=he,Zx=Gi,MR=function(){var t=Xx("Symbol"),e=t&&t.prototype,n=e&&e.valueOf,r=Qx("toPrimitive");e&&!e[r]&&Zx(e,r,function(i){return Jx(n,this)},{arity:1})},$x=Bi,tV=sd,eV=qr,nV=gi,rV=AR,UR=Te([].push),Yi=function(t){var e=1==t,n=2==t,r=3==t,i=4==t,o=6==t,s=7==t,a=5==t||o;return function(c,d,u,l){for(var p,h,S=eV(c),m=tV(S),f=$x(d,u),g=nV(m),R=0,C=l||rV,b=e?C(c,g):n||s?C(c,0):void 0;g>R;R++)if((a||R in m)&&(h=f(p=m[R],R,S),t))if(e)b[R]=h;else if(h)switch(t){case 3:return!0;case 5:return p;case 6:return R;case 2:UR(b,p)}else switch(t){case 4:return!1;case 7:UR(b,p)}return o?-1:r||i?i:b}},xR={forEach:Yi(0),map:Yi(1),filter:Yi(2),some:Yi(3),every:Yi(4),find:Yi(5),findIndex:Yi(6),filterReject:Yi(7)},Xd=Lt,Uh=Ae,xh=Be,iV=Te,As=Yn,bs=cs,oV=te,sn=ze,sV=on,Vh=fn,Qd=Vi,Fh=cd,aV=Jn,Bh=xi,Ya=Pa,VR=fd,cV=Ed,FR=DR,dV=Da,BR=Oa,jR=dr,uV=gp,GR=id,WR=Gi,lV=Od,jh=us,HR=md,KR=Ql,pV=he,hV=Is,_V=je,EV=MR,mV=Wi,YR=Io,Zd=xR.forEach,Mn=_d("hidden"),$d="Symbol",qa="prototype",fV=YR.set,qR=YR.getterFor($d),Pr=Object[qa],wo=Uh.Symbol,tu=wo&&wo[qa],gV=Uh.TypeError,Gh=Uh.QObject,zR=BR.f,No=jR.f,JR=FR.f,TV=GR.f,XR=iV([].push),Ti=jh("symbols"),za=jh("op-symbols"),SV=jh("wks"),Wh=!Gh||!Gh[qa]||!Gh[qa].findChild,Hh=As&&oV(function(){return 7!=Ya(No({},"a",{get:function(){return No(this,"a",{value:7}).a}})).a})?function(t,e,n){var r=zR(Pr,e);r&&delete Pr[e],No(t,e,n),r&&t!==Pr&&No(Pr,e,r)}:No,Kh=function(t,e){var n=Ti[t]=Ya(tu);return fV(n,{type:$d,tag:t,description:e}),As||(n.description=e),n},eu=function(t,e,n){t===Pr&&eu(za,e,n),Vh(t);var r=Fh(e);return Vh(n),sn(Ti,r)?(n.enumerable?(sn(t,Mn)&&t[Mn][r]&&(t[Mn][r]=!1),n=Ya(n,{enumerable:Bh(0,!1)})):(sn(t,Mn)||No(t,Mn,Bh(1,{})),t[Mn][r]=!0),Hh(t,r,n)):No(t,r,n)},Yh=function(t,e){Vh(t);var n=Qd(e),r=VR(n).concat(tv(n));return Zd(r,function(i){As&&!xh(QR,n,i)||eu(t,i,n[i])}),t},QR=function(t){var e=Fh(t),n=xh(TV,this,e);return!(this===Pr&&sn(Ti,e)&&!sn(za,e))&&(!(n||!sn(this,e)||!sn(Ti,e)||sn(this,Mn)&&this[Mn][e])||n)},ZR=function(t,e){var n=Qd(t),r=Fh(e);if(n!==Pr||!sn(Ti,r)||sn(za,r)){var i=zR(n,r);return!i||!sn(Ti,r)||sn(n,Mn)&&n[Mn][r]||(i.enumerable=!0),i}},$R=function(t){var e=JR(Qd(t)),n=[];return Zd(e,function(r){sn(Ti,r)||sn(HR,r)||XR(n,r)}),n},tv=function(t){var e=t===Pr,n=JR(e?za:Qd(t)),r=[];return Zd(n,function(i){!sn(Ti,i)||e&&!sn(Pr,i)||XR(r,Ti[i])}),r};bs||(wo=function(){if(sV(tu,this))throw gV("Symbol is not a constructor");var t=arguments.length&&void 0!==arguments[0]?aV(arguments[0]):void 0,e=KR(t),n=function(r){this===Pr&&xh(n,za,r),sn(this,Mn)&&sn(this[Mn],e)&&(this[Mn][e]=!1),Hh(this,e,Bh(1,r))};return As&&Wh&&Hh(Pr,e,{configurable:!0,set:n}),Kh(e,t)},WR(tu=wo[qa],"toString",function(){return qR(this).tag}),WR(wo,"withoutSetter",function(t){return Kh(KR(t),t)}),GR.f=QR,jR.f=eu,uV.f=Yh,BR.f=ZR,cV.f=FR.f=$R,dV.f=tv,hV.f=function(t){return Kh(pV(t),t)},As&&lV(tu,"description",{configurable:!0,get:function(){return qR(this).description}})),Xd({global:!0,constructor:!0,wrap:!0,forced:!bs,sham:!bs},{Symbol:wo}),Zd(VR(SV),function(t){_V(t)}),Xd({target:$d,stat:!0,forced:!bs},{useSetter:function(){Wh=!0},useSimple:function(){Wh=!1}}),Xd({target:"Object",stat:!0,forced:!bs,sham:!As},{create:function(t,e){return void 0===e?Ya(t):Yh(Ya(t),e)},defineProperty:eu,defineProperties:Yh,getOwnPropertyDescriptor:ZR}),Xd({target:"Object",stat:!0,forced:!bs},{getOwnPropertyNames:$R}),EV(),mV(wo,$d),HR[Mn]=!0;var ev=cs&&!!Symbol.for&&!!Symbol.keyFor,RV=Lt,vV=Cn,yV=ze,CV=Jn,nv=us,IV=ev,qh=nv("string-to-symbol-registry"),AV=nv("symbol-to-string-registry");RV({target:"Symbol",stat:!0,forced:!IV},{for:function(t){var e=CV(t);if(yV(qh,e))return qh[e];var n=vV("Symbol")(e);return qh[e]=n,AV[n]=e,n}});var bV=Lt,OV=ze,wV=wa,NV=ds,DV=ev,rv=us("symbol-to-string-registry");bV({target:"Symbol",stat:!0,forced:!DV},{keyFor:function(t){if(!wV(t))throw TypeError(NV(t)+" is not a symbol");if(OV(rv,t))return rv[t]}});var iv=Ka,PV=Le,ov=Yr,LV=Jn,sv=Te([].push),kV=Lt,av=Cn,cv=ed,MV=Be,Ja=Te,dv=te,uv=Le,lv=wa,pv=Nd,xV=cs,VV=String,qi=av("JSON","stringify"),nu=Ja(/./.exec),hv=Ja("".charAt),FV=Ja("".charCodeAt),BV=Ja("".replace),jV=Ja(1..toString),GV=/[\uD800-\uDFFF]/g,_v=/^[\uD800-\uDBFF]$/,Ev=/^[\uDC00-\uDFFF]$/,mv=!xV||dv(function(){var t=av("Symbol")();return"[null]"!=qi([t])||"{}"!=qi({a:t})||"{}"!=qi(Object(t))}),fv=dv(function(){return'"\\udf06\\ud834"'!==qi("\udf06\ud834")||'"\\udead"'!==qi("\udead")}),WV=function(t,e){var n=pv(arguments),r=function(t){if(PV(t))return t;if(iv(t)){for(var e=t.length,n=[],r=0;r<e;r++){var i=t[r];"string"==typeof i?sv(n,i):"number"!=typeof i&&"Number"!=ov(i)&&"String"!=ov(i)||sv(n,LV(i))}var o=n.length,s=!0;return function(a,c){if(s)return s=!1,c;if(iv(this))return c;for(var d=0;d<o;d++)if(n[d]===a)return c}}}(e);if(uv(r)||void 0!==t&&!lv(t))return n[1]=function(i,o){if(uv(r)&&(o=MV(r,this,VV(i),o)),!lv(o))return o},cv(qi,null,n)},HV=function(t,e,n){var r=hv(n,e-1),i=hv(n,e+1);return nu(_v,t)&&!nu(Ev,i)||nu(Ev,t)&&!nu(_v,r)?"\\u"+jV(FV(t,0),16):t};qi&&kV({target:"JSON",stat:!0,arity:3,forced:mv||fv},{stringify:function(t,e,n){var r=pv(arguments),i=cv(mv?WV:qi,null,r);return fv&&"string"==typeof i?BV(i,GV,HV):i}});var gv=Da,KV=qr;Lt({target:"Object",stat:!0,forced:!cs||te(function(){gv.f(1)})},{getOwnPropertySymbols:function(t){var e=gv.f;return e?e(KV(t)):[]}}),je("asyncIterator"),je("hasInstance"),je("isConcatSpreadable"),je("iterator"),je("match"),je("matchAll"),je("replace"),je("search"),je("species"),je("split");var YV=MR;je("toPrimitive"),YV();var qV=Cn,zV=Wi;je("toStringTag"),zV(qV("Symbol"),"Symbol"),je("unscopables"),Wi(Ae.JSON,"JSON",!0);var JV=qn.Symbol,QV=dr.f,Tv=he("metadata"),Sv=Function.prototype;void 0===Sv[Tv]&&QV(Sv,Tv,{value:null}),je("dispose"),je("metadata");var ZV=JV;je("asyncDispose");var $V=Te,zh=Cn("Symbol"),tF=zh.keyFor,eF=$V(zh.prototype.valueOf),Rv=zh.isRegisteredSymbol||function(t){try{return void 0!==tF(eF(t))}catch{return!1}};Lt({target:"Symbol",stat:!0},{isRegisteredSymbol:Rv});for(var nF=us,vv=Cn,rF=Te,iF=wa,oF=he,ru=vv("Symbol"),yv=ru.isWellKnownSymbol,Cv=vv("Object","getOwnPropertyNames"),sF=rF(ru.prototype.valueOf),Iv=nF("wks"),Jh=0,Av=Cv(ru),aF=Av.length;Jh<aF;Jh++)try{var bv=Av[Jh];iF(ru[bv])&&oF(bv)}catch{}var Ov=function(t){if(yv&&yv(t))return!0;try{for(var e=sF(t),n=0,r=Cv(Iv),i=r.length;n<i;n++)if(Iv[r[n]]==e)return!0}catch{}return!1};Lt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Ov}),je("matcher"),je("observable"),Lt({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:Rv}),Lt({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Ov}),je("metadataKey"),je("patternMatch"),je("replaceAll");var Os=Wt(ZV),wv=Wt(Is.f("iterator"));function Xa(t){return(Xa="function"==typeof Os&&"symbol"==typeof wv?function(e){return typeof e}:function(e){return e&&"function"==typeof Os&&e.constructor===Os&&e!==Os.prototype?"symbol":typeof e})(t)}var cF=Wt(Is.f("toPrimitive"));function T(t,e,n){return(e=function dF(t){var e=function(n){if("object"!==Xa(n)||null===n)return n;var i=n[cF];if(void 0!==i){var o=i.call(n,"string");if("object"!==Xa(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(n)}(t);return"symbol"===Xa(e)?e:String(e)}(e))in t?yR(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var uF=te,lF=he("iterator"),Xh=!uF(function(){var t=new URL("b?a=1&b=2&c=3","http://a"),e=t.searchParams,n=new URLSearchParams("a=1&a=2"),r="";return t.pathname="c%20d",e.forEach(function(i,o){e.delete("b"),r+=o+i}),n.delete("a",2),!t.toJSON||!n.has("a",1)||n.has("a",2)||!e.size&&!0||!e.sort||"http://a/c%20d?a=1&c=3"!==t.href||"3"!==e.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!e[lF]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://\u0442\u0435\u0441\u0442").host||"#%D0%B1"!==new URL("http://a#\u0431").hash||"a1c3"!==r||"x"!==new URL("http://x",void 0).host}),pF=Gi,Qh=Lt,ws=Ae,iu=Be,Qr=Te,Ns=Yn,Nv=Xh,Dv=Gi,hF=Od,EF=Wi,mF=Pp,Zh=Io,Pv=Mp,$h=Le,fF=ze,gF=Bi,TF=zr,SF=fn,Lv=Ln,In=Jn,RF=Pa,kv=xi,t_=vp,vF=Sd,Ds=gs,yF=kS,CF=he("iterator"),Qa="URLSearchParams",Mv=Qa+"Iterator",Uv=Zh.set,lr=Zh.getterFor(Qa),IF=Zh.getterFor(Mv),AF=Object.getOwnPropertyDescriptor,e_=function(t){if(!Ns)return ws[t];var e=AF(ws,t);return e&&e.value},xv=e_("fetch"),ou=e_("Request"),Za=e_("Headers"),n_=ou&&ou.prototype,Vv=Za&&Za.prototype,bF=ws.RegExp,OF=ws.TypeError,Fv=ws.decodeURIComponent,wF=ws.encodeURIComponent,NF=Qr("".charAt),Bv=Qr([].join),Do=Qr([].push),r_=Qr("".replace),DF=Qr([].shift),jv=Qr([].splice),Gv=Qr("".split),PF=Qr("".slice),LF=/\+/g,Wv=Array(4),kF=function(t){return Wv[t-1]||(Wv[t-1]=bF("((?:%[\\da-f]{2}){"+t+"})","gi"))},MF=function(t){try{return Fv(t)}catch{return t}},Hv=function(t){var e=r_(t,LF," "),n=4;try{return Fv(e)}catch{for(;n;)e=r_(e,kF(n--),MF);return e}},UF=/[!'()~]|%20/g,xF={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},VF=function(t){return xF[t]},Kv=function(t){return r_(wF(t),UF,VF)},i_=mF(function(t,e){Uv(this,{type:Mv,iterator:t_(lr(t).entries),kind:e})},"Iterator",function(){var t=IF(this),e=t.kind,n=t.iterator.next(),r=n.value;return n.done||(n.value="keys"===e?r.key:"values"===e?r.value:[r.key,r.value]),n},!0),Yv=function(t){this.entries=[],this.url=null,void 0!==t&&(Lv(t)?this.parseObject(t):this.parseQuery("string"==typeof t?"?"===NF(t,0)?PF(t,1):t:In(t)))};Yv.prototype={type:Qa,bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var e,n,r,i,o,s,a,c=vF(t);if(c)for(n=(e=t_(t,c)).next;!(r=iu(n,e)).done;){if(o=(i=t_(SF(r.value))).next,(s=iu(o,i)).done||(a=iu(o,i)).done||!iu(o,i).done)throw OF("Expected sequence with length 2");Do(this.entries,{key:In(s.value),value:In(a.value)})}else for(var d in t)fF(t,d)&&Do(this.entries,{key:d,value:In(t[d])})},parseQuery:function(t){if(t)for(var e,n,r=Gv(t,"&"),i=0;i<r.length;)(e=r[i++]).length&&(n=Gv(e,"="),Do(this.entries,{key:Hv(DF(n)),value:Hv(Bv(n,"="))}))},serialize:function(){for(var t,e=this.entries,n=[],r=0;r<e.length;)t=e[r++],Do(n,Kv(t.key)+"="+Kv(t.value));return Bv(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var su=function(){Pv(this,Ps);var t=Uv(this,new Yv(arguments.length>0?arguments[0]:void 0));Ns||(this.size=t.entries.length)},Ps=su.prototype;if(function(t,e,n){for(var r in e)n&&n.unsafe&&t[r]?t[r]=e[r]:pF(t,r,e[r],n)}(Ps,{append:function(t,e){var n=lr(this);Ds(arguments.length,2),Do(n.entries,{key:In(t),value:In(e)}),Ns||this.length++,n.updateURL()},delete:function(t){for(var e=lr(this),n=Ds(arguments.length,1),r=e.entries,i=In(t),o=n<2?void 0:arguments[1],s=void 0===o?o:In(o),a=0;a<r.length;){var c=r[a];if(c.key!==i||void 0!==s&&c.value!==s)a++;else if(jv(r,a,1),void 0!==s)break}Ns||(this.size=r.length),e.updateURL()},get:function(t){var e=lr(this).entries;Ds(arguments.length,1);for(var n=In(t),r=0;r<e.length;r++)if(e[r].key===n)return e[r].value;return null},getAll:function(t){var e=lr(this).entries;Ds(arguments.length,1);for(var n=In(t),r=[],i=0;i<e.length;i++)e[i].key===n&&Do(r,e[i].value);return r},has:function(t){for(var e=lr(this).entries,n=Ds(arguments.length,1),r=In(t),i=n<2?void 0:arguments[1],o=void 0===i?i:In(i),s=0;s<e.length;){var a=e[s++];if(a.key===r&&(void 0===o||a.value===o))return!0}return!1},set:function(t,e){var n=lr(this);Ds(arguments.length,1);for(var r,i=n.entries,o=!1,s=In(t),a=In(e),c=0;c<i.length;c++)(r=i[c]).key===s&&(o?jv(i,c--,1):(o=!0,r.value=a));o||Do(i,{key:s,value:a}),Ns||(this.size=i.length),n.updateURL()},sort:function(){var t=lr(this);yF(t.entries,function(e,n){return e.key>n.key?1:-1}),t.updateURL()},forEach:function(t){for(var e,n=lr(this).entries,r=gF(t,arguments.length>1?arguments[1]:void 0),i=0;i<n.length;)r((e=n[i++]).value,e.key,this)},keys:function(){return new i_(this,"keys")},values:function(){return new i_(this,"values")},entries:function(){return new i_(this,"entries")}},{enumerable:!0}),Dv(Ps,CF,Ps.entries,{name:"entries"}),Dv(Ps,"toString",function(){return lr(this).serialize()},{enumerable:!0}),Ns&&hF(Ps,"size",{get:function(){return lr(this).entries.length},configurable:!0,enumerable:!0}),EF(su,Qa),Qh({global:!0,constructor:!0,forced:!Nv},{URLSearchParams:su}),!Nv&&$h(Za)){var FF=Qr(Vv.has),BF=Qr(Vv.set),qv=function(t){if(Lv(t)){var e,n=t.body;if(TF(n)===Qa)return e=t.headers?new Za(t.headers):new Za,FF(e,"content-type")||BF(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),RF(t,{body:kv(0,In(n)),headers:kv(0,e)})}return t};if($h(xv)&&Qh({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return xv(t,arguments.length>1?qv(arguments[1]):{})}}),$h(ou)){var o_=function(t){return Pv(this,n_),new ou(t,arguments.length>1?qv(arguments[1]):{})};n_.constructor=o_,o_.prototype=n_,Qh({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:o_})}}var jF={URLSearchParams:su,getState:lr},zv=Wt(qn.URLSearchParams),GF={isBrowser:!0,classes:{URLSearchParams:void 0!==zv?zv:Mh,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const s_=typeof window<"u"&&typeof document<"u",a_="object"==typeof navigator&&navigator||void 0,WF=s_&&(!a_||["ReactNative","NativeScript","NS"].indexOf(a_.product)<0),HF=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,KF=s_&&window.location.href||"http://localhost";function Jv(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Xv(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Jv(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Jv(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}var Un=Xv(Xv({},Object.freeze({__proto__:null,hasBrowserEnv:s_,hasStandardBrowserEnv:WF,hasStandardBrowserWebWorkerEnv:HF,navigator:a_,origin:KF})),GF),YF=fn,qF=Be,zF=ze,JF=on,XF=function(){var t=YF(this),e="";return t.hasIndices&&(e+="d"),t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.unicodeSets&&(e+="v"),t.sticky&&(e+="y"),e},Qv=RegExp.prototype,Zv=function(t){var e=t.flags;return void 0!==e||"flags"in Qv||zF(t,"flags")||!JF(Qv,t)?e:qF(XF,t)},QF=lh.charAt,$v=Be,ZF=fn,$F=Le,tB=Yr,eB=/./.exec,nB=TypeError,rB=Lt,ty=Be,ey=ba,iB=Pp,au=kp,ny=as,ry=Gf,$a=Jn,oB=fn,sB=ss,aB=Yr,cB=Hf,iy=Zv,dB=ad,uB=te,lB=Fp,oy=Io,_B=he("matchAll"),sy="RegExp String",ay=sy+" Iterator",EB=oy.set,mB=oy.getterFor(ay),fB=TypeError,c_=ey("".indexOf),cu=ey("".matchAll),d_=!!cu&&!uB(function(){cu("a",/./)}),gB=iB(function(t,e,n,r){EB(this,{type:ay,regexp:t,string:e,global:n,unicode:r,done:!1})},sy,function(){var t=mB(this);if(t.done)return au(void 0,!0);var e=t.regexp,n=t.string,r=function(t,e){var n=t.exec;if($F(n)){var r=$v(n,t,e);return null!==r&&ZF(r),r}if("RegExp"===tB(t))return $v(eB,t,e);throw nB("RegExp#exec called on incompatible receiver")}(e,n);return null===r?(t.done=!0,au(void 0,!0)):t.global?(""===$a(r[0])&&(e.lastIndex=function(t,e,n){return e+(n?QF(t,e).length:1)}(n,ry(e.lastIndex),t.unicode)),au(r,!1)):(t.done=!0,au(r,!1))}),cy=function(t){var e,n,r,i=oB(this),o=$a(t),s=lB(i,RegExp),a=$a(iy(i));return e=new s(s===RegExp?i.source:i,a),n=!!~c_(a,"g"),r=!!~c_(a,"u"),e.lastIndex=ry(i.lastIndex),new gB(e,o,n,r)};rB({target:"String",proto:!0,forced:d_},{matchAll:function(t){var e,n,r,i,o=ny(this);if(sB(t)){if(d_)return cu(o,t)}else{if(cB(t)&&(e=$a(ny(iy(t))),!~c_(e,"g")))throw fB("`.matchAll` does not allow non-global regexes");if(d_)return cu(o,t);if(void 0===(r=dB(t,_B))&&"RegExp"==aB(t)&&(r=cy),r)return ty(r,t,o)}return n=$a(o),i=new RegExp(t,"g"),ty(cy,i,n)}});var TB=ur("String").matchAll,SB=on,RB=TB,u_=String.prototype,yB=Wt(function(t){var e=t.matchAll;return"string"==typeof t||t===u_||SB(u_,t)&&e===u_.matchAll?RB:e});function dy(t){function e(n,r,i,o){let s=n[o++];if("__proto__"===s)return!0;const a=Number.isFinite(+s),c=o>=n.length;return s=!s&&j.isArray(i)?i.length:s,c?(i[s]=j.hasOwnProp(i,s)?[i[s],r]:r,!a):(i[s]&&j.isObject(i[s])||(i[s]=[]),e(n,r,i[s],o)&&j.isArray(i[s])&&(i[s]=function(d){const u={},l=Object.keys(d);let p;const h=l.length;let S;for(p=0;p<h;p++)S=l[p],u[S]=d[S];return u}(i[s])),!a)}if(j.isFormData(t)&&j.isFunction(t.entries)){const n={};return j.forEachEntry(t,(r,i)=>{var o;e((o=r,yB(j).call(j,/\w+|\[(\w*)]/g,o).map(s=>"[]"===s[0]?"":s[1]||s[0])),i,n,0)}),n}return null}const l_={transitional:TR,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){const n=e.getContentType()||"",r=n.indexOf("application/json")>-1,i=j.isObject(t);if(i&&j.isHTMLForm(t)&&(t=new FormData(t)),j.isFormData(t))return r?JSON.stringify(dy(t)):t;if(j.isArrayBuffer(t)||j.isBuffer(t)||j.isStream(t)||j.isFile(t)||j.isBlob(t)||j.isReadableStream(t))return t;if(j.isArrayBufferView(t))return t.buffer;if(j.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let o;if(i){if(n.indexOf("application/x-www-form-urlencoded")>-1)return(s=t,a=this.formSerializer,Jd(s,new Un.classes.URLSearchParams,Object.assign({visitor:function(c,d,u,l){return Un.isNode&&j.isBuffer(c)?(this.append(d,c.toString("base64")),!1):l.defaultVisitor.apply(this,arguments)}},a))).toString();if((o=j.isFileList(t))||n.indexOf("multipart/form-data")>-1){const s=this.env&&this.env.FormData;return Jd(o?{"files[]":t}:t,s&&new s,this.formSerializer)}}var s,a;return i||r?(e.setContentType("application/json",!1),function(s){if(j.isString(s))try{return(0,JSON.parse)(s),$e(j).call(j,s)}catch(d){if("SyntaxError"!==d.name)throw d}return(0,JSON.stringify)(s)}(t)):t}],transformResponse:[function(t){const e=this.transitional||l_.transitional,n=e&&e.forcedJSONParsing,r="json"===this.responseType;if(j.isResponse(t)||j.isReadableStream(t))return t;if(t&&j.isString(t)&&(n&&!this.responseType||r)){const i=!(e&&e.silentJSONParsing)&&r;try{return JSON.parse(t)}catch(o){if(i)throw"SyntaxError"===o.name?kt.from(o,kt.ERR_BAD_RESPONSE,this,null,this.response):o}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Un.classes.FormData,Blob:Un.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};j.forEach(["delete","get","head","post","put","patch"],t=>{l_.headers[t]={}});var p_=l_;const CB=j.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),uy=Symbol("internals");function tc(t){var e;return t&&$e(e=String(t)).call(e).toLowerCase()}function du(t){return!1===t||null==t?t:j.isArray(t)?t.map(du):String(t)}function h_(t,e,n,r,i){return j.isFunction(r)?r.call(this,e,n):(i&&(e=n),j.isString(e)?j.isString(r)?-1!==e.indexOf(r):j.isRegExp(r)?r.test(e):void 0:void 0)}class uu{constructor(e){e&&this.set(e)}set(e,n,r){const i=this;function o(c,d,u){const l=tc(d);if(!l)throw new Error("header name must be a non-empty string");const p=j.findKey(i,l);(!p||void 0===i[p]||!0===u||void 0===u&&!1!==i[p])&&(i[p||d]=du(c))}const s=(c,d)=>j.forEach(c,(u,l)=>o(u,l,d));if(j.isPlainObject(e)||e instanceof this.constructor)s(e,n);else if(j.isString(e)&&(e=$e(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test($e(a=e).call(a)))s((c=>{const d={};let u,l,p;return c&&c.split("\n").forEach(function(h){var S,m;p=h.indexOf(":"),u=$e(S=h.substring(0,p)).call(S).toLowerCase(),l=$e(m=h.substring(p+1)).call(m),!u||d[u]&&CB[u]||("set-cookie"===u?d[u]?d[u].push(l):d[u]=[l]:d[u]=d[u]?d[u]+", "+l:l)}),d})(e),n);else if(j.isHeaders(e))for(const[c,d]of e.entries())o(d,c,r);else null!=e&&o(n,e,r);var a;return this}get(e,n){if(e=tc(e)){const r=j.findKey(this,e);if(r){const i=this[r];if(!n)return i;if(!0===n)return function(o){const s=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let c;for(;c=a.exec(o);)s[c[1]]=c[2];return s}(i);if(j.isFunction(n))return n.call(this,i,r);if(j.isRegExp(n))return n.exec(i);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=tc(e)){const r=j.findKey(this,e);return!(!r||void 0===this[r]||n&&!h_(0,this[r],r,n))}return!1}delete(e,n){const r=this;let i=!1;function o(s){if(s=tc(s)){const a=j.findKey(r,s);!a||n&&!h_(0,r[a],a,n)||(delete r[a],i=!0)}}return j.isArray(e)?e.forEach(o):o(e),i}clear(e){const n=Object.keys(this);let r=n.length,i=!1;for(;r--;){const o=n[r];e&&!h_(0,this[o],o,e,!0)||(delete this[o],i=!0)}return i}normalize(e){const n=this,r={};return j.forEach(this,(i,o)=>{var s;const a=j.findKey(r,o);if(a)return n[a]=du(i),void delete n[o];const c=e?$e(d=o).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,(u,l,p)=>l.toUpperCase()+p):$e(s=String(o)).call(s);var d;c!==o&&delete n[o],n[c]=du(i),r[c]=!0}),this}concat(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return this.constructor.concat(this,...n)}toJSON(e){const n=Object.create(null);return j.forEach(this,(r,i)=>{null!=r&&!1!==r&&(n[i]=e&&j.isArray(r)?r.join(", "):r)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(e=>{let[n,r]=e;return n+": "+r}).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){const n=new this(e);for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return i.forEach(s=>n.set(s)),n}static accessor(e){const n=(this[uy]=this[uy]={accessors:{}}).accessors,r=this.prototype;function i(o){const s=tc(o);n[s]||(function(a,c){const d=j.toCamelCase(" "+c);["get","set","has"].forEach(u=>{Object.defineProperty(a,u+d,{value:function(l,p,h){return this[u].call(this,c,l,p,h)},configurable:!0})})}(r,o),n[s]=!0)}return j.isArray(e)?e.forEach(i):i(e),this}}uu.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),j.reduceDescriptors(uu.prototype,(t,e)=>{let{value:n}=t,r=e[0].toUpperCase()+e.slice(1);return{get:()=>n,set(i){this[r]=i}}}),j.freezeMethods(uu);var Lr=uu;function __(t,e){const n=this||p_,r=e||n,i=Lr.from(r.headers);let o=r.data;return j.forEach(t,function(s){o=s.call(n,o,i.normalize(),e?e.status:void 0)}),i.normalize(),o}function ly(t){return!(!t||!t.__CANCEL__)}function Ls(t,e,n){kt.call(this,t??"canceled",kt.ERR_CANCELED,e,n),this.name="CanceledError"}function py(t,e,n){const r=n.config.validateStatus;n.status&&r&&!r(n.status)?e(new kt("Request failed with status code "+n.status,[kt.ERR_BAD_REQUEST,kt.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):t(n)}j.inherits(Ls,kt,{__CANCEL__:!0});const lu=function(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=0;const i=function(o,s){o=o||10;const a=new Array(o),c=new Array(o);let d,u=0,l=0;return s=void 0!==s?s:1e3,function(p){const h=Date.now(),S=c[l];d||(d=h),a[u]=p,c[u]=h;let m=l,f=0;for(;m!==u;)f+=a[m++],m%=o;if(u=(u+1)%o,u===l&&(l=(l+1)%o),h-d<s)return;const g=S&&h-S;return g?Math.round(1e3*f/g):void 0}}(50,250);return function(o,s){let a,c,d=0,u=1e3/s;const l=function(p){d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now(),a=null,c&&(clearTimeout(c),c=null),o.apply(null,p)};return[function(){const p=Date.now(),h=p-d;for(var S=arguments.length,m=new Array(S),f=0;f<S;f++)m[f]=arguments[f];h>=u?l(m,p):(a=m,c||(c=setTimeout(()=>{c=null,l(a)},u-h)))},()=>a&&l(a)]}(o=>{const s=o.loaded,a=o.lengthComputable?o.total:void 0,c=s-r,d=i(c);r=s,t({loaded:s,total:a,progress:a?s/a:void 0,bytes:c,rate:d||void 0,estimated:d&&a&&s<=a?(a-s)/d:void 0,event:o,lengthComputable:null!=a,[e?"download":"upload"]:!0})},n)},hy=(t,e)=>{const n=null!=t;return[r=>e[0]({lengthComputable:n,total:t,loaded:r}),e[1]]},_y=t=>function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return j.asap(()=>t(...n))};var IB=Un.hasStandardBrowserEnv?function(){const t=Un.navigator&&/(msie|trident)/i.test(Un.navigator.userAgent),e=document.createElement("a");let n;function r(i){let o=i;return t&&(e.setAttribute("href",o),o=e.href),e.setAttribute("href",o),{href:e.href,protocol:e.protocol?e.protocol.replace(/:$/,""):"",host:e.host,search:e.search?e.search.replace(/^\?/,""):"",hash:e.hash?e.hash.replace(/^#/,""):"",hostname:e.hostname,port:e.port,pathname:"/"===e.pathname.charAt(0)?e.pathname:"/"+e.pathname}}return n=r(window.location.href),function(i){const o=j.isString(i)?r(i):i;return o.protocol===n.protocol&&o.host===n.host}}():function(){return!0},AB=Un.hasStandardBrowserEnv?{write(t,e,n,r,i,o){const s=[t+"="+encodeURIComponent(e)];j.isNumber(n)&&s.push("expires="+new Date(n).toGMTString()),j.isString(r)&&s.push("path="+r),j.isString(i)&&s.push("domain="+i),!0===o&&s.push("secure"),document.cookie=s.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function Ey(t,e){return t&&!/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)?(n=t,(r=e)?n.replace(/\/?\/$/,"")+"/"+r.replace(/^\/+/,""):n):e;var n,r}function my(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}const fy=t=>t instanceof Lr?function(e){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?my(Object(r),!0).forEach(function(i){T(e,i,r[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):my(Object(r)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(r,i))})}return e}({},t):t;function Po(t,e){e=e||{};const n={};function r(d,u,l){return j.isPlainObject(d)&&j.isPlainObject(u)?j.merge.call({caseless:l},d,u):j.isPlainObject(u)?j.merge({},u):j.isArray(u)?u.slice():u}function i(d,u,l){return j.isUndefined(u)?j.isUndefined(d)?void 0:r(void 0,d,l):r(d,u,l)}function o(d,u){if(!j.isUndefined(u))return r(void 0,u)}function s(d,u){return j.isUndefined(u)?j.isUndefined(d)?void 0:r(void 0,d):r(void 0,u)}function a(d,u,l){return l in e?r(d,u):l in t?r(void 0,d):void 0}const c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(d,u)=>i(fy(d),fy(u),!0)};return j.forEach(Object.keys(Object.assign({},t,e)),function(d){const u=c[d]||i,l=u(t[d],e[d],d);j.isUndefined(l)&&u!==a||(n[d]=l)}),n}var gy=t=>{const e=Po({},t);let n,{data:r,withXSRFToken:i,xsrfHeaderName:o,xsrfCookieName:s,headers:a,auth:c}=e;if(e.headers=a=Lr.from(a),e.url=fR(Ey(e.baseURL,e.url),t.params,t.paramsSerializer),c&&a.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),j.isFormData(r))if(Un.hasStandardBrowserEnv||Un.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if(!1!==(n=a.getContentType())){const[d,...u]=n?n.split(";").map(l=>$e(l).call(l)).filter(Boolean):[];a.setContentType([d||"multipart/form-data",...u].join("; "))}if(Un.hasStandardBrowserEnv&&(i&&j.isFunction(i)&&(i=i(e)),i||!1!==i&&IB(e.url))){const d=o&&s&&AB.read(s);d&&a.set(o,d)}return e},bB=typeof XMLHttpRequest<"u"&&function(t){return new H(function(e,n){const r=gy(t);let i=r.data;const o=Lr.from(r.headers).normalize();let s,a,c,d,u,{responseType:l,onUploadProgress:p,onDownloadProgress:h}=r;function S(){d&&d(),u&&u(),r.cancelToken&&r.cancelToken.unsubscribe(s),r.signal&&r.signal.removeEventListener("abort",s)}let m=new XMLHttpRequest;function f(){if(!m)return;const R=Lr.from("getAllResponseHeaders"in m&&m.getAllResponseHeaders());py(function(C){e(C),S()},function(C){n(C),S()},{data:l&&"text"!==l&&"json"!==l?m.response:m.responseText,status:m.status,statusText:m.statusText,headers:R,config:t,request:m}),m=null}m.open(r.method.toUpperCase(),r.url,!0),m.timeout=r.timeout,"onloadend"in m?m.onloadend=f:m.onreadystatechange=function(){m&&4===m.readyState&&(0!==m.status||m.responseURL&&0===m.responseURL.indexOf("file:"))&&setTimeout(f)},m.onabort=function(){m&&(n(new kt("Request aborted",kt.ECONNABORTED,t,m)),m=null)},m.onerror=function(){n(new kt("Network Error",kt.ERR_NETWORK,t,m)),m=null},m.ontimeout=function(){let R=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";r.timeoutErrorMessage&&(R=r.timeoutErrorMessage),n(new kt(R,(r.transitional||TR).clarifyTimeoutError?kt.ETIMEDOUT:kt.ECONNABORTED,t,m)),m=null},void 0===i&&o.setContentType(null),"setRequestHeader"in m&&j.forEach(o.toJSON(),function(R,C){m.setRequestHeader(C,R)}),j.isUndefined(r.withCredentials)||(m.withCredentials=!!r.withCredentials),l&&"json"!==l&&(m.responseType=r.responseType),h&&([c,u]=lu(h,!0),m.addEventListener("progress",c)),p&&m.upload&&([a,d]=lu(p),m.upload.addEventListener("progress",a),m.upload.addEventListener("loadend",d)),(r.cancelToken||r.signal)&&(s=R=>{m&&(n(!R||R.type?new Ls(null,t,m):R),m.abort(),m=null)},r.cancelToken&&r.cancelToken.subscribe(s),r.signal&&(r.signal.aborted?s():r.signal.addEventListener("abort",s)));const g=function(R){const C=/^([-+\w]{1,25})(:?\/\/|:)/.exec(R);return C&&C[1]||""}(r.url);g&&-1===Un.protocols.indexOf(g)?n(new kt("Unsupported protocol "+g+":",kt.ERR_BAD_REQUEST,t)):m.send(i||null)})},OB=(t,e)=>{const{length:n}=t=t?t.filter(Boolean):[];if(e||n){let r,i=new AbortController;const o=function(d){if(!r){r=!0,a();const u=d instanceof Error?d:this.reason;i.abort(u instanceof kt?u:new Ls(u instanceof Error?u.message:u))}};let s=e&&setTimeout(()=>{s=null,o(new kt("timeout ".concat(e," of ms exceeded"),kt.ETIMEDOUT))},e);const a=()=>{t&&(s&&clearTimeout(s),s=null,t.forEach(d=>{d.unsubscribe?d.unsubscribe(o):d.removeEventListener("abort",o)}),t=null)};t.forEach(d=>d.addEventListener("abort",o));const{signal:c}=i;return c.unsubscribe=()=>j.asap(a),c}},wB=qT,NB=Xr;Lt({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var t=NB.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var DB=Xr,PB=Ss;Lt({target:"Promise",stat:!0,forced:!0},{try:function(t){var e=DB.f(this),n=PB(t);return(n.error?e.reject:e.resolve)(n.value),e.promise}});var E_=Wt(wB),Ty=Is.f("asyncIterator"),LB=Wt(Ty);function m_(t,e){this.v=t,this.k=e}function ec(t){var e,n;function r(o,s){try{var a=t[o](s),c=a.value,d=c instanceof m_;E_.resolve(d?c.v:c).then(function(u){if(d){var l="return"===o?"return":"next";if(!c.k||u.done)return r(l,u);u=t[l](u).value}i(a.done?"return":"normal",u)},function(u){r("throw",u)})}catch(u){i("throw",u)}}function i(o,s){switch(o){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1})}(e=e.next)?r(e.key,e.arg):n=null}this._invoke=function(o,s){return new E_(function(a,c){var d={key:o,arg:s,resolve:a,reject:c,next:null};n?n=n.next=d:(e=n=d,r(o,s))})},"function"!=typeof t.return&&(this.return=void 0)}function Zn(t){return function(){return new ec(t.apply(this,arguments))}}function mt(t){return new m_(t,0)}function pu(t){var e={},n=!1;function r(i,o){return n=!0,{done:!1,value:new m_(o=new E_(function(s){s(t[i](o))}),1)}}return e[void 0!==Os&&wv||"@@iterator"]=function(){return this},e.next=function(i){return n?(n=!1,i):r("next",i)},"function"==typeof t.throw&&(e.throw=function(i){if(n)throw n=!1,i;return r("throw",i)}),"function"==typeof t.return&&(e.return=function(i){return n?(n=!1,i):r("return",i)}),e}ec.prototype["function"==typeof Os&&LB||"@@asyncIterator"]=function(){return this},ec.prototype.next=function(t){return this._invoke("next",t)},ec.prototype.throw=function(t){return this._invoke("throw",t)},ec.prototype.return=function(t){return this._invoke("return",t)};var f_=Wt(Ty);function g_(t){var e,n,r,i=2;for(typeof Symbol<"u"&&(n=f_,r=Symbol.iterator);i--;){if(n&&null!=(e=t[n]))return e.call(t);if(r&&null!=(e=t[r]))return new hu(e.call(t));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function hu(t){function e(n){if(Object(n)!==n)return H.reject(new TypeError(n+" is not an object."));var r=n.done;return H.resolve(n.value).then(function(i){return{value:i,done:r}})}return(hu=function(n){this.s=n,this.n=n.next}).prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return void 0===r?H.resolve({value:n,done:!0}):e(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return void 0===r?H.reject(n):e(r.apply(this.s,arguments))}},new hu(t)}const kB=function*(t,e){let n=t.byteLength;if(!e||n<e)return void(yield t);let r,i=0;for(;i<n;)r=i+e,yield t.slice(i,r),i=r},MB=function(){var t=Zn(function*(e,n){var r,i=!1,o=!1;try{for(var s,a=g_(UB(e));i=!(s=yield mt(a.next())).done;i=!1){const c=s.value;yield*pu(g_(kB(c,n)))}}catch(c){o=!0,r=c}finally{try{i&&null!=a.return&&(yield mt(a.return()))}finally{if(o)throw r}}});return function(e,n){return t.apply(this,arguments)}}(),UB=function(){var t=Zn(function*(e){if(e[f_])return void(yield*pu(g_(e)));const n=e.getReader();try{for(;;){const{done:r,value:i}=yield mt(n.read());if(r)break;yield i}}finally{yield mt(n.cancel())}});return function(e){return t.apply(this,arguments)}}(),Sy=(t,e,n,r)=>{const i=MB(t,e);let o,s=0,a=c=>{o||(o=!0,r&&r(c))};return new ReadableStream({pull:c=>y(function*(){try{const{done:d,value:u}=yield i.next();if(d)return a(),void c.close();if(n){let p=s+=u.byteLength;n(p)}c.enqueue(new Uint8Array(u))}catch(d){throw a(d),d}})(),cancel:c=>(a(c),i.return())},{highWaterMark:2})};function Ry(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function vy(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Ry(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ry(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const _u="function"==typeof fetch&&"function"==typeof Request&&"function"==typeof Response,yy=_u&&"function"==typeof ReadableStream,xB=_u&&("function"==typeof TextEncoder?(Cy=new TextEncoder,t=>Cy.encode(t)):function(){var t=y(function*(e){return new Uint8Array(yield new Response(e).arrayBuffer())});return function(e){return t.apply(this,arguments)}}());var Cy;const Iy=function(t){try{for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return!!t(...n)}catch{return!1}},VB=yy&&Iy(()=>{let t=!1;const e=new Request(Un.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),T_=yy&&Iy(()=>j.isReadableStream(new Response("").body)),Eu={stream:T_&&(t=>t.body)};var Ay;_u&&(Ay=new Response,["text","arrayBuffer","blob","formData","stream"].forEach(t=>{!Eu[t]&&(Eu[t]=j.isFunction(Ay[t])?e=>e[t]():(e,n)=>{throw new kt("Response type '".concat(t,"' is not supported"),kt.ERR_NOT_SUPPORT,n)})}));const FB=function(){var t=y(function*(e,n){return j.toFiniteNumber(e.getContentLength())??(i=y(function*(o){return null==o?0:j.isBlob(o)?o.size:j.isSpecCompliantForm(o)?(yield new Request(Un.origin,{method:"POST",body:o}).arrayBuffer()).byteLength:j.isArrayBufferView(o)||j.isArrayBuffer(o)?o.byteLength:(j.isURLSearchParams(o)&&(o+=""),j.isString(o)?(yield xB(o)).byteLength:void 0)}),function(o){return i.apply(this,arguments)})(n);var i});return function(n,r){return t.apply(this,arguments)}}();var BB=_u&&function(){var t=y(function*(e){let{url:n,method:r,data:i,signal:o,cancelToken:s,timeout:a,onDownloadProgress:c,onUploadProgress:d,responseType:u,headers:l,withCredentials:p="same-origin",fetchOptions:h}=gy(e);u=u?(u+"").toLowerCase():"text";let S,m=OB([o,s&&s.toAbortSignal()],a);const f=m&&m.unsubscribe&&(()=>{m.unsubscribe()});let g;try{if(d&&VB&&"get"!==r&&"head"!==r&&0!==(g=yield FB(l,i))){let D,V=new Request(n,{method:"POST",body:i,duplex:"half"});if(j.isFormData(i)&&(D=V.headers.get("content-type"))&&l.setContentType(D),V.body){const[U,k]=hy(g,lu(_y(d)));i=Sy(V.body,65536,U,k)}}j.isString(p)||(p=p?"include":"omit");const R="credentials"in Request.prototype;S=new Request(n,vy(vy({},h),{},{signal:m,method:r.toUpperCase(),headers:l.normalize().toJSON(),body:i,duplex:"half",credentials:R?p:void 0}));let C=yield fetch(S);const b=T_&&("stream"===u||"response"===u);if(T_&&(c||b&&f)){const D={};["status","statusText","headers"].forEach(Z=>{D[Z]=C[Z]});const V=j.toFiniteNumber(C.headers.get("content-length")),[U,k]=c&&hy(V,lu(_y(c),!0))||[];C=new Response(Sy(C.body,65536,U,()=>{k&&k(),f&&f()}),D)}u=u||"text";let w=yield Eu[j.findKey(Eu,u)||"text"](C,e);return!b&&f&&f(),yield new H((D,V)=>{py(D,V,{data:w,headers:Lr.from(C.headers),status:C.status,statusText:C.statusText,config:e,request:S})})}catch(R){throw f&&f(),R&&"TypeError"===R.name&&/fetch/i.test(R.message)?Object.assign(new kt("Network Error",kt.ERR_NETWORK,e,S),{cause:R.cause||R}):kt.from(R,R&&R.code,e,S)}});return function(e){return t.apply(this,arguments)}}();const S_={http:null,xhr:bB,fetch:BB};j.forEach(S_,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const by=t=>"- ".concat(t),jB=t=>j.isFunction(t)||null===t||!1===t;var Oy_getAdapter=t=>{t=j.isArray(t)?t:[t];const{length:e}=t;let n,r;const i={};for(let o=0;o<e;o++){let s;if(n=t[o],r=n,!jB(n)&&(r=S_[(s=String(n)).toLowerCase()],void 0===r))throw new kt("Unknown adapter '".concat(s,"'"));if(r)break;i[s||"#"+o]=r}if(!r){const o=Object.entries(i).map(s=>{let[a,c]=s;return"adapter ".concat(a," ")+(!1===c?"is not supported by the environment":"is not available in the build")});throw new kt("There is no suitable adapter to dispatch the request "+(e?o.length>1?"since :\n"+o.map(by).join("\n"):" "+by(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r};function R_(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Ls(null,t)}function wy(t){return R_(t),t.headers=Lr.from(t.headers),t.data=__.call(t,t.transformRequest),-1!==["post","put","patch"].indexOf(t.method)&&t.headers.setContentType("application/x-www-form-urlencoded",!1),Oy_getAdapter(t.adapter||p_.adapter)(t).then(function(e){return R_(t),e.data=__.call(t,t.transformResponse,e),e.headers=Lr.from(e.headers),e},function(e){return ly(e)||(R_(t),e&&e.response&&(e.response.data=__.call(t,t.transformResponse,e.response),e.response.headers=Lr.from(e.response.headers))),H.reject(e)})}const v_={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{v_[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}});const Dy={};v_.transitional=function(t,e,n){function r(i,o){return"[Axios v1.7.7] Transitional option '"+i+"'"+o+(n?". "+n:"")}return(i,o,s)=>{if(!1===t)throw new kt(r(o," has been removed"+(e?" in "+e:"")),kt.ERR_DEPRECATED);return e&&!Dy[o]&&(Dy[o]=!0,console.warn(r(o," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(i,o,s)}};var y_={assertOptions:function(t,e,n){if("object"!=typeof t)throw new kt("options must be an object",kt.ERR_BAD_OPTION_VALUE);const r=Object.keys(t);let i=r.length;for(;i-- >0;){const o=r[i],s=e[o];if(s){const a=t[o],c=void 0===a||s(a,o,t);if(!0!==c)throw new kt("option "+o+" must be "+c,kt.ERR_BAD_OPTION_VALUE)}else if(!0!==n)throw new kt("Unknown option "+o,kt.ERR_BAD_OPTION)}},validators:v_};const zi=y_.validators;let mu=class{constructor(t){this.defaults=t,this.interceptors={request:new gR,response:new gR}}request(t,e){var n=this;return y(function*(){try{return yield n._request(t,e)}catch(r){if(r instanceof Error){let i;Error.captureStackTrace?Error.captureStackTrace(i={}):i=new Error;const o=i.stack?i.stack.replace(/^.+\n/,""):"";try{r.stack?o&&!String(r.stack).endsWith(o.replace(/^.+\n.+\n/,""))&&(r.stack+="\n"+o):r.stack=o}catch{}}throw r}})()}_request(t,e){"string"==typeof t?(e=e||{}).url=t:e=t||{},e=Po(this.defaults,e);const{transitional:n,paramsSerializer:r,headers:i}=e;void 0!==n&&y_.assertOptions(n,{silentJSONParsing:zi.transitional(zi.boolean),forcedJSONParsing:zi.transitional(zi.boolean),clarifyTimeoutError:zi.transitional(zi.boolean)},!1),null!=r&&(j.isFunction(r)?e.paramsSerializer={serialize:r}:y_.assertOptions(r,{encode:zi.function,serialize:zi.function},!0)),e.method=(e.method||this.defaults.method||"get").toLowerCase();let o=i&&j.merge(i.common,i[e.method]);i&&j.forEach(["delete","get","head","post","put","patch","common"],h=>{delete i[h]}),e.headers=Lr.concat(o,i);const s=[];let a=!0;this.interceptors.request.forEach(function(h){"function"==typeof h.runWhen&&!1===h.runWhen(e)||(a=a&&h.synchronous,s.unshift(h.fulfilled,h.rejected))});const c=[];let d;this.interceptors.response.forEach(function(h){c.push(h.fulfilled,h.rejected)});let u,l=0;if(!a){const h=[wy.bind(this),void 0];for(h.unshift.apply(h,s),h.push.apply(h,c),u=h.length,d=H.resolve(e);l<u;)d=d.then(h[l++],h[l++]);return d}u=s.length;let p=e;for(l=0;l<u;){const h=s[l++],S=s[l++];try{p=h(p)}catch(m){S.call(this,m);break}}try{d=wy.call(this,p)}catch(h){return H.reject(h)}for(l=0,u=c.length;l<u;)d=d.then(c[l++],c[l++]);return d}getUri(t){return fR(Ey((t=Po(this.defaults,t)).baseURL,t.url),t.params,t.paramsSerializer)}};j.forEach(["delete","get","head","options"],function(t){mu.prototype[t]=function(e,n){return this.request(Po(n||{},{method:t,url:e,data:(n||{}).data}))}}),j.forEach(["post","put","patch"],function(t){function e(n){return function(r,i,o){return this.request(Po(o||{},{method:t,headers:n?{"Content-Type":"multipart/form-data"}:{},url:r,data:i}))}}mu.prototype[t]=e(),mu.prototype[t+"Form"]=e(!0)});var fu=mu;class C_{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let n;this.promise=new H(function(i){n=i});const r=this;this.promise.then(i=>{if(!r._listeners)return;let o=r._listeners.length;for(;o-- >0;)r._listeners[o](i);r._listeners=null}),this.promise.then=i=>{let o;const s=new H(a=>{r.subscribe(a),o=a}).then(i);return s.cancel=function(){r.unsubscribe(o)},s},e(function(i,o,s){r.reason||(r.reason=new Ls(i,o,s),n(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);-1!==n&&this._listeners.splice(n,1)}toAbortSignal(){const e=new AbortController,n=r=>{e.abort(r)};return this.subscribe(n),e.signal.unsubscribe=()=>this.unsubscribe(n),e.signal}static source(){let e;return{token:new C_(function(n){e=n}),cancel:e}}}var GB=C_;const I_={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(I_).forEach(t=>{let[e,n]=t;I_[n]=e});var WB=I_;const Ze=function t(e){const n=new fu(e),r=$S(fu.prototype.request,n);return j.extend(r,fu.prototype,n,{allOwnKeys:!0}),j.extend(r,n,null,{allOwnKeys:!0}),r.create=function(i){return t(Po(e,i))},r}(p_);Ze.Axios=fu,Ze.CanceledError=Ls,Ze.CancelToken=GB,Ze.isCancel=ly,Ze.VERSION="1.7.7",Ze.toFormData=Jd,Ze.AxiosError=kt,Ze.Cancel=Ze.CanceledError,Ze.all=function(t){return H.all(t)},Ze.spread=function(t){return function(e){return t.apply(null,e)}},Ze.isAxiosError=function(t){return j.isObject(t)&&!0===t.isAxiosError},Ze.mergeConfig=Po,Ze.AxiosHeaders=Lr,Ze.formToJSON=t=>dy(j.isHTMLForm(t)?new FormData(t):t),Ze.getAdapter=Oy_getAdapter,Ze.HttpStatusCode=WB,Ze.default=Ze;var hn=Ze;const HB=()=>{};function nc(){const t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:HB};return t.promise=new H((e,n)=>{t.resolve=r=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(r),t.value=r)},t.reject=r=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,n(r))}}),t}const gu=new Map,Tu=new Map,Zr=new Map;let we=function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t}({}),It=function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t}({});const A_=new w2;let kr=A_.getResult(),b_=null;function Tt(t){if(!b_){t&&A_.setUA(t),kr=A_.getResult();const e=function(a){if("Blink"===a.engine.name&&"WeChat"!==a.browser.name)return It.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return It.CHROME;case"Safari":case"Mobile Safari":return It.SAFARI;case"Edge":return It.EDGE;case"Firefox":return It.FIREFOX;case"QQ":case"QQBrowser":return It.QQ;case"Opera":return It.OPERA;case"WeChat":return It.WECHAT;default:return a.browser.name||""}}(kr),n=Py(kr),r="Windows"===(a=kr).os.name?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||"",i=kr.os.version,o=Py(kr,!1),s=kr.device.type;if(!(e&&n&&r&&i))return{name:e,version:n,os:r,osVersion:i,browserVersion:o,deviceType:s};b_={name:e,version:n,os:r,osVersion:i,browserVersion:o,deviceType:s}}var a;return b_}function Py(t){let e;return e="Blink"===t.engine.name?t.engine.version||"":t.browser.version||"",arguments.length>1&&void 0!==arguments[1]&&!arguments[1]?e:e.split(".")[0]}function Su(){return Tt().os}function Ly(){const t=Tt();return"".concat(t.os," ").concat(t.osVersion)}function Ru(){const t=Tt();return!!("WebKit"===kr.engine.name&&t.os===we.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==It.SAFARI||an()&&t.name!==It.SAFARI)}function Ji(){return Tt().name===It.CHROME}function Ge(){return Tt().name===It.SAFARI}function ky(){return Tt().name===It.EDGE}function ee(){return Tt().name===It.FIREFOX}function an(){return Tt().os===we.IOS}function O_(t){const e=Tt();return!(e.name!==It.CHROME||!e.osVersion)&&Number(e.version)>=t}function My(t){const e=Tt();return!(e.name!==It.CHROME||!e.osVersion)&&Number(e.version)<t}function Uy(t){const e=Tt();return!(e.name!==It.EDGE||!e.osVersion)&&Number(e.version)>=t}function xy(t){const e=Tt();return!(e.name!==It.SAFARI||!e.osVersion)&&Number(e.version)>=t}function Vy(t,e,n){const r=Tt();if(r.os!==we.IOS||!r.osVersion)return!1;const i=r.osVersion.split(".");return n?e&&Number(i[0])===t&&Number(i[1])<e||Number(i[0])<t:e?Number(i[0])===t&&Number(i[1])<=e||Number(i[0])<t:Number(i[0])<=t}function Fy(t,e,n){const r=Tt();if(r.name!==It.SAFARI||!r.osVersion||!r.browserVersion)return!1;const i=r.browserVersion.split(".");return n?e&&Number(i[0])===t&&Number(i[1])<e||Number(i[0])<t:e?Number(i[0])===t&&Number(i[1])<=e||Number(i[0])<t:Number(i[0])<=t}function By(t){const e=Tt();return!(e.name!==It.OPERA||!e.osVersion)&&Number(e.version)>=t}function jy(){const t=Tt();if(t.os!==we.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])<14||14===Number(e[0])&&Number(e[1])<=6}function ks(){const t=Tt();if(t.os!==we.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 15===Number(e[0])}function w_(){const t=Tt();if(t.os!==we.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 16===Number(e[0])}function Gy(){const t=Tt();if(t.os!==we.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return 15===Number(e[0])&&Number(e[1])>=1}function pr(){return Ge()&&navigator.maxTouchPoints>0}function Wy(){return Tt().name===It.WECHAT}function Hy(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function N_(){const t=Su();return function(){const{deviceType:e}=Tt();return"mobile"===e||"tablet"===e}()||t===we.ANDROID||t===we.IOS||t===we.HARMONY_OS}function Xi(){const t=Tt();return t.name!==It.EDGE&&t.name!==It.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function vu(){return Su()===we.ANDROID}function rc(){const t=Tt();return vu()&&(t.name===It.CHROME||t.name===It.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function Ht(t,e,n){return(e="symbol"==typeof(i=function(o){if("object"!=typeof o||!o)return o;var a=o[Symbol.toPrimitive];if(void 0!==a){var c=a.call(o,"string");if("object"!=typeof c)return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(e))?i:i+"")in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t;var i}function Ky(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function X(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Ky(Object(n),!0).forEach(function(r){Ht(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ky(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let v=function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t}({}),P=class extends Error{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(e),Ht(this,"code",void 0),Ht(this,"message",void 0),Ht(this,"data",void 0),Ht(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=n}toString(){return this.data?"".concat(this.message,"\ndata: ").concat(JSON.stringify(this.data)):this.message}print(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return"error"===t&&(e||console).error(this.toString()),"warning"===t&&(e||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}};function Si(t,e){if("boolean"!=typeof t)throw new P(v.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function be(t,e,n){if(!W(n).call(n,t))throw new P(v.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(n)))}function Mt(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;if(t<n||t>r||(!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&("number"!=typeof(i=t)||i%1!=0))throw new P(v.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(n,", ").concat(r,"]. integer only"));var i}function D_(t,e){if("number"!=typeof t){if(!(t.min||t.max||t.ideal||t.exact))throw new P(v.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));void 0!==t.min&&Mt(t.min,"".concat(e,".min"),0,1/0),void 0!==t.max&&Mt(t.max,"".concat(e,".max"),1,1/0),void 0!==t.exact&&Mt(t.exact,"".concat(e,".exact"),1,1/0),void 0!==t.ideal&&Mt(t.ideal,"".concat(e,".ideal"),1,1/0)}else Mt(t,e,1,1/0)}function ke(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==t)throw new P(v.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!Yy(t,n,r,i))throw new P(v.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(n,",").concat(r,"].").concat(i?" ASCII characters only.":""))}function Ri(t,e){if(!Array.isArray(t))throw new P(v.INVALID_PARAMS,"".concat(e," should be an array"))}function Qt(t){return null==t}function Yy(t){return"string"==typeof t&&t.length<=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:255)&&t.length>=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:1)&&(!(!(arguments.length>3&&void 0!==arguments[3])||arguments[3])||function(i){if("string"!=typeof i)return!1;for(let o=0;o<i.length;o+=1){const s=i.charCodeAt(o);if(s<0||s>255)return!1}return!0}(t))}var ic=function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t}(ic||{}),P_=function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t}(P_||{});const qy=new class{constructor(){Ht(this,"_clientSize",null),Ht(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),Ht(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),Ht(this,"getStyle",t=>window.getComputedStyle(t,null)),Ht(this,"checkCssVisibleProperty",t=>{var e;let n=!0;const r=this.getStyle(t),{display:i,visibility:o,opacity:s,filter:a}=r;return("none"===i||W(e=["hidden","collapse"]).call(e,o)||Number(s)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter(c=>{var d;const u=c.split("(")[0];return W(d=["brightness","blur","opacity"]).call(d,u)}).map(c=>{const[d,u]=c.split(/\(|\)/);return[d,Number(u.match(/^[0-9\.]+/))]}).forEach(c=>{const[d,u]=c;switch(d){case"brightness":(u<.1||u>3)&&(n=!1);break;case"blur":u>3&&(n=!1);break;case"opacity":u<.1&&(n=!1)}}),n)}),Ht(this,"checkPropertyUpToAllParentNodes",(t,e)=>{let n=!0,r=!0;let o=t;for(;o&&r;)e(o)||(n=!1,r=!1),o=o.parentElement,o||(r=!1);return n}),Ht(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),Ht(this,"getSizeAboutClient",t=>{const{width:e,height:n,left:r,right:i,top:o,bottom:s}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:n,left:r,right:i,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),Ht(this,"checkActualSize",()=>{const{width:t,height:e,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(t,e,n)}),Ht(this,"elementFromPoint",(t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null),Ht(this,"checkCoverForAPoint",(t,e,n)=>{const r=this.elementFromPoint(t,e);return null!==r&&r!==n}),Ht(this,"getPointPositionList",()=>{const{width:t,height:e,left:n,top:r}=this._clientSize,i=t/6,o=e/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++)s.push({x:(n*a+(0===c?.1:4===c?(i*c*a-1e5)/a:i*c)*a)/a,y:(r*a+(0===d?.1:4===d?(o*d*a-1e5)/a:o*d)*a)/a});return[...s]}),Ht(this,"checkElementCover",t=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,t)).filter(e=>!!e).length>6),Ht(this,"checkSizeIsVisible",(t,e,n)=>(t>50||n/t<=10)&&(e>50||n/e<=10)),Ht(this,"checkSizeOfPartInClient",()=>{const{left:t,right:e,top:n,bottom:r,clientHeight:i,clientWidth:o,clientMin:s}=this._clientSize;let a,c,d,u;if(t<0)a=0;else{if(!(t<o))return!1;a=t}if(e<0)return!1;if(c=e<o?e:o,n<0)d=0;else{if(!(n<i))return!1;d=n}return!(r<0)&&(u=r<i?r:i,this.checkSizeIsVisible(c-a,u-d,s))}),Ht(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),Ht(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(ic.COVERED);{const e=this.checkActualSize(),n=this.checkSizeOfPartInClient();return e&&!n?this.returnHiddenResult(ic.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(ic.SIZE)}}return this.returnHiddenResult(ic.STYLE)}return this.returnHiddenResult(P_.UNMOUNTED)}return this.returnHiddenResult(P_.INVALID_HTML_ELEMENT)}),Ht(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,e=>"HTML"!==e.nodeName.toUpperCase()?null!==e.parentElement:!!document.documentElement))}};function L_(t){return(new TextEncoder).encode(t)}const zy=function(t,e){const n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n},k_=function(){var t=y(function*(e){return function(n){let i="";return new Uint8Array(n).forEach(o=>{i+=o.toString(16).padStart(2,"0")}),i}(yield crypto.subtle.digest("SHA-256",L_(e)))});return function(n){return t.apply(this,arguments)}}();class Zt{constructor(){Ht(this,"_events",{}),Ht(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(n=>n.listener):[]}on(e,n){this._events[e]||(this._events[e]=[]);const r=this._events[e];-1===this._indexOfListener(r,n)&&r.push({listener:n,once:!1})}once(e,n){this._events[e]||(this._events[e]=[]);const r=this._events[e];-1===this._indexOfListener(r,n)&&r.push({listener:n,once:!0})}off(e,n){if(!this._events[e])return;const r=this._events[e],i=this._indexOfListener(r,n);-1!==i&&r.splice(i,1),0===this._events[e].length&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const n=this._events[e].map(s=>s);for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];for(let s=0;s<n.length;s+=1){const a=n[s];a.once&&this.off(e,a.listener),a.listener.apply(this,i||[])}}safeEmit(e){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];[...this._events[e]||[]].forEach(o=>{o.once&&this.off(e,o.listener);try{o.listener.apply(this,r)}catch(s){console.error("safeEmit event:".concat(e," error ").concat(s?.toString()))}})}_indexOfListener(e,n){let r=e.length;for(;r--;)if(e[r].listener===n)return r;return-1}}let oc=null;function Jy(){if(oc)return oc;if(window.electron)return oc=window.electron;if(!window.require)return null;try{return oc=window.require("electron"),oc}catch{return null}}let ye=function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t}({}),ne=function(t){return t.TRACER="tracer",t}({});function Xy(t){return Mt(t.timeout,"config.timeout",0,1e5),Mt(t.timeoutFactor,"config.timeoutFactor",0,100,!1),Mt(t.maxRetryCount,"config.maxRetryConfig",0,1/0),Mt(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let KB=function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t}({}),Ot=function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.FALLBACK="FALLBACK",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t}({});function yu(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function Qy(t){return ke(t.turnServerURL,"turnServerURL"),ke(t.username,"username"),ke(t.password,"password"),t.udpport&&Mt(t.udpport,"udpport",1,99999,!0),t.forceturn&&Si(t.forceturn,"forceturn"),t.security&&Si(t.security,"security"),t.tcpport&&Mt(t.tcpport,"tcpport",1,99999,!0),!0}function Zy(t){return void 0!==t.level&&be(t.level,"level",[1,2,3]),void 0!==t.delay&&Mt(t.delay,"delay",0,3e3,!0),!0}let ht=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t}({}),We=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t}({}),An=function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({}),Ms=function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({});function He(t,e){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return 0===t.getListeners(e).length?H.reject(new P(v.UNEXPECTED_ERROR,"can not emit promise")):new H((o,s)=>{t.emit(e,...r,o,s)})}function xt(t,e){if(0===t.getListeners(e).length)return H.resolve();for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return He(t,e,...r)}function $n(t,e){if(0===t.getListeners(e).length)return null;for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return sc(t,e,...r)}function sc(t,e){let n=null,r=null;for(var i=arguments.length,o=new Array(i>2?i-2:0),s=2;s<i;s++)o[s-2]=arguments[s];if(t.emit(e,...o,a=>{n=a},a=>{r=a}),null!==r)throw r;if(null===n)throw new P(v.UNEXPECTED_ERROR,"handler is not sync");return n}const _e=new class extends Zt{set networkState(t){this.emit(Ms.NETWORK_STATE_CHANGE,t,this._networkState),t===An.ONLINE?this.emit(Ms.ONLINE):t===An.OFFLINE&&(this.onlineWaiter=new H(e=>{this.once(Ms.ONLINE,()=>{this.onlineWaiter=void 0,e(An.ONLINE)})}),this.emit(Ms.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===An.ONLINE}constructor(){super(),Ht(this,"_moduleName","network-indicator"),Ht(this,"_networkState",An.ONLINE),Ht(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=An.ONLINE}),window.addEventListener("offline",()=>{this.networkState=An.OFFLINE})}};function Cu(t,e){const n=t.indexOf(e);-1!==n&&t.splice(n,1)}function Us(t){const e=[];return t.forEach(n=>{-1===e.indexOf(n)&&e.push(n)}),e}function Iu(t){void 0!==H?H.resolve().then(t):setTimeout(t,0)}function ae(t){return JSON.parse(JSON.stringify(t))}function Lo(t){try{return ae(t)}catch{return t}}const $y={};function Qi(t,e){$y[e]||($y[e]=!0,t())}function ko(t){const e=window.atob(t),n=new Uint8Array(new ArrayBuffer(e.length));for(let r=0;r<e.length;r+=1)n[r]=e.charCodeAt(r);return n}function Zi(t){let e="";for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return window.btoa(e)}function tC(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,n=(new TextEncoder).encode(t);if(n.length>e)n=n.slice(0,e);else if(n.length<e){const r=new Uint8Array(e);r.set(n),n=r}return n}function eC(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=Nr(e).call(e,(s,a)=>s+a.length,0),i=new Uint8Array(new ArrayBuffer(r));let o=0;return e.forEach(s=>{i.set(s,o),o+=s.length}),i}function $r(t){return window.TextEncoder?(new TextEncoder).encode(t).length:t.length}function nC(t){let e=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach(n=>{e+="string"==typeof n?$r(n):n.size}),e+138}function YB(t){const e=new P(v.TIMEOUT,"timeout");return new H((n,r)=>{window.setTimeout(()=>r(e),t)})}function Me(t){return new H(e=>{window.setTimeout(e,t)})}function Ft(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,t).toLowerCase();return n.length===t?"".concat(e).concat(n):"".concat(e).concat(n)+Ft(t-n.length,"")}function xs(){return Ft(32,"").toUpperCase()}const Au=()=>{},rC=new class{constructor(){Ht(this,"fnMap",new Map)}throttleByKey(t,e,n,r){for(var i=arguments.length,o=new Array(i>4?i-4:0),s=4;s<i;s++)o[s-4]=arguments[s];if(this.fnMap.has(e)){const a=this.fnMap.get(e);if(a.threshold!==n){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout(()=>{const d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:t,threshold:n,timer:c,args:o,skipFn:r})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,X(X({},a),{},{fn:t,args:o,skipFn:r}))}else{const a=window.setTimeout(()=>{const c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e)},n);this.fnMap.set(e,{fn:t,threshold:n,timer:a,args:o,skipFn:r})}}},iC=rC.throttleByKey.bind(rC);function oC(t){return"object"==typeof t&&null!==t&&!(t instanceof RegExp)}function M_(t,e){if(!oC(t)||!oC(e)||Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){const n=[...t];for(let r=0;r<e.length;r++)n[r]=M_(t[r],e[r]);return n}{const n=X({},t);for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=Object.prototype.hasOwnProperty.call(t,r)?M_(t[r],e[r]):e[r]);return n}}function sC(t,e){let n=[0];if(e&&(n=new Array(e).fill(0)),0===t)return n;let r=0;for(;t>0&&(n[r]=255&t,t>>=8,r++,!e||r!==e););return n}function U_(t){return"number"==typeof t?t:t.exact||t.ideal||t.max||t.min||0}function aC(t){const e="0123456789abcdef";function n(C){let b,w="";for(b=0;b<=3;b++)w+=e.charAt(C>>8*b+4&15)+e.charAt(C>>8*b&15);return w}function r(C,b){const w=(65535&C)+(65535&b);return(C>>16)+(b>>16)+(w>>16)<<16|65535&w}function i(C,b,w,D,V,U){return r((k=r(r(b,C),r(D,U)))<<(Z=V)|k>>>32-Z,w);var k,Z}function o(C,b,w,D,V,U,k){return i(b&w|~b&D,C,b,V,U,k)}function s(C,b,w,D,V,U,k){return i(b&D|w&~D,C,b,V,U,k)}function a(C,b,w,D,V,U,k){return i(b^w^D,C,b,V,U,k)}function c(C,b,w,D,V,U,k){return i(w^(b|~D),C,b,V,U,k)}const d=function(C){let b;const w=1+(C.length+8>>6),D=new Array(16*w);for(b=0;b<16*w;b++)D[b]=0;for(b=0;b<C.length;b++)D[b>>2]|=C.charCodeAt(b)<<b%4*8;return D[b>>2]|=128<<b%4*8,D[16*w-2]=8*C.length,D}(t);let u,l,p,h,S,m=1732584193,f=-271733879,g=-1732584194,R=271733878;for(u=0;u<d.length;u+=16)l=m,p=f,h=g,S=R,m=o(m,f,g,R,d[u+0],7,-680876936),R=o(R,m,f,g,d[u+1],12,-389564586),g=o(g,R,m,f,d[u+2],17,606105819),f=o(f,g,R,m,d[u+3],22,-1044525330),m=o(m,f,g,R,d[u+4],7,-176418897),R=o(R,m,f,g,d[u+5],12,1200080426),g=o(g,R,m,f,d[u+6],17,-1473231341),f=o(f,g,R,m,d[u+7],22,-45705983),m=o(m,f,g,R,d[u+8],7,1770035416),R=o(R,m,f,g,d[u+9],12,-1958414417),g=o(g,R,m,f,d[u+10],17,-42063),f=o(f,g,R,m,d[u+11],22,-1990404162),m=o(m,f,g,R,d[u+12],7,1804603682),R=o(R,m,f,g,d[u+13],12,-40341101),g=o(g,R,m,f,d[u+14],17,-1502002290),f=o(f,g,R,m,d[u+15],22,1236535329),m=s(m,f,g,R,d[u+1],5,-165796510),R=s(R,m,f,g,d[u+6],9,-1069501632),g=s(g,R,m,f,d[u+11],14,643717713),f=s(f,g,R,m,d[u+0],20,-373897302),m=s(m,f,g,R,d[u+5],5,-701558691),R=s(R,m,f,g,d[u+10],9,38016083),g=s(g,R,m,f,d[u+15],14,-660478335),f=s(f,g,R,m,d[u+4],20,-405537848),m=s(m,f,g,R,d[u+9],5,568446438),R=s(R,m,f,g,d[u+14],9,-1019803690),g=s(g,R,m,f,d[u+3],14,-187363961),f=s(f,g,R,m,d[u+8],20,1163531501),m=s(m,f,g,R,d[u+13],5,-1444681467),R=s(R,m,f,g,d[u+2],9,-51403784),g=s(g,R,m,f,d[u+7],14,1735328473),f=s(f,g,R,m,d[u+12],20,-1926607734),m=a(m,f,g,R,d[u+5],4,-378558),R=a(R,m,f,g,d[u+8],11,-2022574463),g=a(g,R,m,f,d[u+11],16,1839030562),f=a(f,g,R,m,d[u+14],23,-35309556),m=a(m,f,g,R,d[u+1],4,-1530992060),R=a(R,m,f,g,d[u+4],11,1272893353),g=a(g,R,m,f,d[u+7],16,-155497632),f=a(f,g,R,m,d[u+10],23,-1094730640),m=a(m,f,g,R,d[u+13],4,681279174),R=a(R,m,f,g,d[u+0],11,-358537222),g=a(g,R,m,f,d[u+3],16,-722521979),f=a(f,g,R,m,d[u+6],23,76029189),m=a(m,f,g,R,d[u+9],4,-640364487),R=a(R,m,f,g,d[u+12],11,-421815835),g=a(g,R,m,f,d[u+15],16,530742520),f=a(f,g,R,m,d[u+2],23,-995338651),m=c(m,f,g,R,d[u+0],6,-198630844),R=c(R,m,f,g,d[u+7],10,1126891415),g=c(g,R,m,f,d[u+14],15,-1416354905),f=c(f,g,R,m,d[u+5],21,-57434055),m=c(m,f,g,R,d[u+12],6,1700485571),R=c(R,m,f,g,d[u+3],10,-1894986606),g=c(g,R,m,f,d[u+10],15,-1051523),f=c(f,g,R,m,d[u+1],21,-2054922799),m=c(m,f,g,R,d[u+8],6,1873313359),R=c(R,m,f,g,d[u+15],10,-30611744),g=c(g,R,m,f,d[u+6],15,-1560198380),f=c(f,g,R,m,d[u+13],21,1309151649),m=c(m,f,g,R,d[u+4],6,-145523070),R=c(R,m,f,g,d[u+11],10,-1120210379),g=c(g,R,m,f,d[u+2],15,718787259),f=c(f,g,R,m,d[u+9],21,-343485551),m=r(m,l),f=r(f,p),g=r(g,h),R=r(R,S);return n(m)+n(f)+n(g)+n(R)}let qB=1,cC=console,Je=class{static setLogger(t){cC=t}constructor(t,e){Ht(this,"id",void 0),Ht(this,"lockingPromise",H.resolve()),Ht(this,"locks",0),Ht(this,"name",""),Ht(this,"lockId",void 0),this.lockId=qB++,t&&(this.name=t),e&&(this.id=e),this.logger("created")}logger(t,e){const n=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),r="created"===t?"is ".concat(t,"."):"is ".concat(t,", current queue ").concat(this.locks,". ").concat(e??"");cC.debug("".concat(n," ").concat(r))}setId(t){this.id=t}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,this.logger("locked",t);const n=new H(i=>{e=()=>{this.locks-=1,this.logger("unlocked",t),i()}}),r=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>n),r}};function Vs(t,e){return function(n,r,i){const o=i.value;if("function"!=typeof o)throw new Error("Cannot use mutex on object property.");return i.value=y(function*(){const s=this[e];if(!s)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));const a=yield s.lock("From ".concat(t,".").concat(r));try{for(var c=arguments.length,d=new Array(c),u=0;u<c;u++)d[u]=arguments[u];return yield o.apply(this,d)}finally{a()}}),i}}const Se={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function x_(t,e){const n=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,n)}function Mr(t,e,n,r){const i=Object.assign({},Se,r);let o=i.timeout;const s=function(){var d=y(function*(){var u;yield(u=o,new H(l=>{window.setTimeout(l,u)})),o*=i.timeoutFactor,o=Math.min(i.maxRetryTimeout,o)});return function(){return d.apply(this,arguments)}}();let a=!1;const c=new H(function(){var d=y(function*(u,l){e=e||(()=>!1),n=n||(()=>!0);for(let p=0;p<i.maxRetryCount;p+=1){if(a)return l(new P(v.OPERATION_ABORTED));try{const h=yield t();if(!e(h,p)||p+1===i.maxRetryCount)return u(h);yield s()}catch(h){if(!n(h,p)||p+1===i.maxRetryCount)return l(h);yield s()}}});return function(u,l){return d.apply(this,arguments)}}());return c.cancel=()=>a=!0,c}class dC{constructor(e){Ht(this,"input",[]),Ht(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return 0===this.input.length?0:Nr(e=this.input).call(e,(n,r)=>n+r)/this.input.length}}let bu,Ou=0,V_=0;function F_(t,e,n,r){return new H((i,o)=>{e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),Ou+=$r(e.data)):n&&(e.data.size?Ou+=e.data.size:e.data instanceof FormData?Ou+=nC(e.data):Ou+=$r(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,hn.request(e).then(s=>{"string"==typeof s.data?V_+=$r(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?V_+=s.data.byteLength:V_+=$r(JSON.stringify(s.data)),r&&i({data:s.data,headers:s.headers}),i(s.data)}).catch(s=>{hn.isCancel(s)?o(new P(v.OPERATION_ABORTED,"cancel token canceled")):o("ECONNABORTED"===s.code?new P(v.NETWORK_TIMEOUT,s.message):s.response?new P(v.NETWORK_RESPONSE_ERROR,s.response.status):new P(v.NETWORK_ERROR,s.message))})})}function zB(t,e){return B_.apply(this,arguments)}function B_(){return B_=y(function*(t,e){const n=new Blob([e.data],{type:"buffer"});return yield F_(t,X(X({},e),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}),B_.apply(this,arguments)}const uC=()=>void 0!==window.isSecureContext,tr=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(e&&e[1]&&e[2]){const r=e[2];return"".concat(e[1],".").concat(r)}return"4.0.0.999"}("4.22.2"),j_=function(){try{return!0===JSON.parse("true")}catch{return!0}}();let Mo=function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t}({});const Ke=function(){const t="us".concat("erna","me"),e="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const r=n.join(""),i=[];for(let a=0;a<6;a++)i.push("1");const o=i.join(""),s={};return s[t]=r,s[e]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Ke;const G_={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},W_="v4.22.2-0-g4caa29bb(10/28/2024, 2:37:34 PM)",ce=X(X({PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:G_,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,CUSTOM_ADAPTATION_DEFAULT_MODE:"",ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,ENABLE_PRELOAD:!0,DISABLE_SCREEN_SHARE_REMB:!1},{ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,USE_PUB_RTX:!0,USE_SUB_RTX:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_DATASTREAM_2:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,USE_XR:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,ENABLE_PREALLOC_PC:!1,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:2,ENABLE_PRE_SUB:!1,ENABLE_AUT_FEEDBACK:!1}),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"]});function Ut(t,e,n){var r,i,o;W(r=Object.keys(ce)).call(r,t)&&(!n&&W(i=Object.keys($i)).call(i,t)||(ce[t]=e,"ENABLE_VIDEO_SEI"===t&&!0===e&&(ce.ENABLE_ENCODED_TRANSFORM=!0),"USE_NEW_NETWORK_CONFIG"===t&&e&&(ce.USE_NEW_NETWORK_CONFIG=o=!!e,o&&(ce.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],ce.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],ce.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ce.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],ce.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",ce.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",ce.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),"ENABLE_PRE_SUB"===t&&e&&(ce.ENABLE_INSTANT_VIDEO=!0,ce.ENABLE_PREALLOC_PC=!0),"ENABLE_SVC"===t&&e&&(ce.ENABLE_AUT_CC=!0)))}function A(t){return ce[t]}j_||(ce.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],ce.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],ce.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],ce.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ce.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],ce.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],ce.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",ce.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",ce.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",ce.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",ce.AREAS=["NORTH_AMERICA","OVERSEA"]);const $i={};var lt=function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.AVOID_JOIN_START="AVOID_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t}(lt||{});class JB{constructor(e,n,r,i){Ht(this,"state",void 0),this.state={codec:e,audioCodec:n,mode:r,clientId:i,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:Mo.Default}}dispatch(e){this.state=function(n,r){switch(r.type){case lt.SET_SESSION_ID:return X(X({},n),{},{sessionId:r.sessionId});case lt.SET_P2P_ID:return X(X({},n),{},{p2pId:r.p2pId});case lt.SET_UID:return X(X({},n),{},{uid:r.uid});case lt.SET_INT_UID:return X(X({},n),{},{intUid:r.intUid});case lt.SET_PUB_ID:return X(X({},n),{},{pubId:r.pubId});case lt.KEY_METRIC_CLIENT_CREATED:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{clientCreated:r.metric})});case lt.KEY_METRIC_JOIN_START:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{joinStart:r.metric})});case lt.AVOID_JOIN_START:return X(X({},n),{},{avoidJoinStart:r.avoidJoinStart});case lt.KEY_METRIC_JOIN_END:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{joinEnd:r.metric})});case lt.KEY_METRIC_REQUEST_AP_START:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{requestAPStart:r.metric})});case lt.KEY_METRIC_REQUEST_AP_END:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{requestAPEnd:r.metric})});case lt.KEY_METRIC_JOIN_GATEWAY_START:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{joinGatewayStart:r.metric})});case lt.KEY_METRIC_JOIN_GATEWAY_END:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{joinGatewayEnd:r.metric})});case lt.KEY_METRIC_PEER_CONNECTION_START:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{peerConnectionStart:r.metric})});case lt.KEY_METRIC_PEER_CONNECTION_END:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{peerConnectionEnd:r.metric})});case lt.KEY_METRIC_DESCRIPTION_START:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{descriptionStart:r.metric})});case lt.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{signalChannelOpen:r.metric})});case lt.KEY_METRIC_ICE_CONNECTION_END:return X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{iceConnectionEnd:r.metric})});case lt.KEY_METRIC_PUBLISH:{const i=n.keyMetrics.publish,o=i.findIndex(s=>s.trackId===r.metric.trackId);return-1!==o?(i[o]=X(X({},i[o]),r.metric),X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{publish:[...i]})})):X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{publish:[...n.keyMetrics.publish,r.metric]})})}case lt.KEY_METRIC_SUBSCRIBE:{const i=n.keyMetrics.subscribe,o=i.findIndex(s=>s.userId===r.metric.userId&&s.type===r.metric.type);return-1!==o?(i[o]=X(X({},i[o]),r.metric),X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{subscribe:[...i]})})):X(X({},n),{},{keyMetrics:X(X({},n.keyMetrics),{},{subscribe:[...n.keyMetrics.subscribe,r.metric]})})}case lt.SET_CLOUD_PROXY_SERVER_MODE:return n.cloudProxyServerMode=r.mode,n;case lt.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof r.index?n.joinChannelServiceRecords=[...n.joinChannelServiceRecords,r.record]:(n.joinChannelServiceRecords[r.index]=X(X({},n.joinChannelServiceRecords[r.index]),r.record),n.joinChannelServiceRecords=[...n.joinChannelServiceRecords]),n;case lt.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return n.joinChannelServiceRecords=[],n;case lt.RESET_KEY_METRICS:return n.keyMetrics={publish:[],subscribe:[]},n;case lt.SET_USE_P2P:return X(X({},n),{},{useP2P:r.val});case lt.SET_TRANSPORT_TYPE:return X(X({},n),{},{p2pTransport:r.val});default:return n}}(this.state,e)}set sessionId(e){this.dispatch({type:lt.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:lt.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:lt.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:lt.SET_UID,uid:e})}get uid(){return this.state.uid}set intUid(e){this.dispatch({type:lt.SET_INT_UID,intUid:e})}get intUid(){return this.state.intUid}set pubId(e){this.dispatch({type:lt.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:lt.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(e){this.dispatch({type:lt.SET_USE_P2P,val:e})}get useP2P(){return this.state.useP2P}set p2pTransport(e){this.dispatch({type:lt.SET_TRANSPORT_TYPE,val:e})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:lt.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:lt.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:lt.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:lt.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:lt.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:lt.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:lt.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:lt.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:lt.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:lt.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:lt.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:lt.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,n,r,i){this.dispatch({type:lt.KEY_METRIC_PUBLISH,metric:X(X({trackId:e,type:n},r&&{publishStart:r}),i&&{publishEnd:i})})}subscribe(e,n,r,i,o,s,a){this.dispatch({type:lt.KEY_METRIC_SUBSCRIBE,metric:X(X(X(X(X({userId:e,type:n},r&&{subscribeStart:r}),i&&{subscribeEnd:i}),o&&{firstFrame:o}),s&&{streamAdded:s}),a&&{firstDecoded:a})})}massSubscribe(e,n,r,i){e.forEach(o=>{this.dispatch({type:lt.KEY_METRIC_SUBSCRIBE,metric:X(X(X({userId:o.userId,type:o.type},n&&{subscribeStart:n}),r&&{subscribeEnd:r}),i&&{firstFrame:i})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,n){"gateway"===e.service&&Array.isArray(e.urls)&&(e.urls=e.urls.map(r=>r.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return"number"!=typeof n?(this.dispatch({type:lt.RECORD_JOIN_CHANNEL_SERVICE,record:X(X({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(n<0||n>=this.state.joinChannelServiceRecords.length||this.dispatch({type:lt.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:n}),n)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:lt.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:lt.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:lt.AVOID_JOIN_START,avoidJoinStart:e})}}let wu=function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t}({});!function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"}({});let QB=0;function re(t,e,n){return(e="symbol"==typeof(i=function(o){if("object"!=typeof o||!o)return o;var a=o[Symbol.toPrimitive];if(void 0!==a){var c=a.call(o,"string");if("object"!=typeof c)return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(e))?i:i+"")in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t;var i}function hC(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function dt(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?hC(Object(n),!0).forEach(function(r){re(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):hC(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const _C=new class extends Zt{constructor(){super(...arguments),re(this,"currentUploadLogID",0)}reportLogUploadError(t){const{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class ZB{constructor(e){re(this,"logger",void 0),re(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];this.logger.debug(...this.prefixLists,...n)}info(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];this.logger.info(...this.prefixLists,...n)}warning(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];this.logger.warning(...this.prefixLists,...n)}error(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];this.logger.error(...this.prefixLists,...n)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function H_(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function EC(){const t=new Date,e=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return e?e?.[0]+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const er={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Nu=Date.now(),ac=t=>{for(const e in er)if(Object.prototype.hasOwnProperty.call(er,e)&&er[e]===t)return e;return"DEFAULT"},_=new class{constructor(){re(this,"proxyServerURL",void 0),re(this,"logLevel",er.DEBUG),re(this,"uploadState","collecting"),re(this,"uploadLogWaitingList",[]),re(this,"uploadLogUploadingList",[]),re(this,"uploadErrorCount",0),re(this,"currentLogID",0),re(this,"url",void 0),re(this,"extLog",(t,e)=>{this.appendLogToWaitingList(t,...e)})}debug(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[er.DEBUG].concat(e);this.log.apply(this,r)}info(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[er.INFO].concat(e);this.log.apply(this,r)}warning(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[er.WARNING].concat(e);this.log.apply(this,r)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[er.ERROR].concat(e);this.log.apply(this,r)}upload(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const r=[er.DEBUG].concat(e);this.uploadLog.apply(this,r)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){Ut("UPLOAD_LOG",!0)}disableLogUpload(){Ut("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new ZB(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-Nu<100)return void setTimeout(()=>{this.log(...e)},Date.now()-Nu);const r=Math.max(0,Math.min(4,e[0]));if(e[0]=H_()+" Agora-SDK [".concat(ac(r),"]:"),this.appendLogToWaitingList(r,...e),r<this.logLevel)return;const i=H_()+" %cAgora-SDK [".concat(ac(r),"]:");let o=[];if(!A("USE_NEW_LOG"))switch(r){case er.DEBUG:o=[i,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case er.INFO:o=[i,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case er.WARNING:o=[i,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case er.ERROR:o=[i,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-Nu<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-Nu);const r=Math.max(0,Math.min(4,e[0]));e[0]=H_()+" Agora-SDK [".concat(ac(r),"]:"),this.appendLogToWaitingList(r,...e)}appendLogToWaitingList(t){if(!A("UPLOAD_LOG"))return;for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];Array.isArray(n[0])?n[0][0]=EC()+" Agora-SDK [".concat(ac(t),"]:"):n[0]=EC()+" Agora-SDK [".concat(ac(t),"]:");let i="";n.forEach(o=>{"object"==typeof o&&(o=JSON.stringify(o)),i+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:i,log_level:t,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}uploadLogs(){var t=this;return y(function*(){const e=t.uploadLogUploadingList,n={sdk_version:tr,process_id:A("PROCESS_ID"),payload:JSON.stringify(e)};return Mr(y(function*(){const r=yield hn.post(t.url||(t.proxyServerURL?"https://".concat(t.proxyServerURL,"/ls/?h=").concat(A("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(A("LOG_UPLOAD_SERVER"),"/upload/v1")),n,{responseType:"text"});if("OK"!==r.data){const i=new Error("unexpected upload log response");throw i.response=r,i}}),()=>(t.uploadLogUploadingList=[],!1),r=>{const i={status:-1,message:r.message,errorRange:e.map(o=>o.log_item_id)};return r.response?(i.status=r.response.status,i.data=r.response.data,i.headers=r.response.headers):r.request&&(i.status=r.request.status),_C.reportLogUploadError(i),!0},{timeout:A("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:A("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})})()}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,A("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var mC;function $B(t){return ke(t.reportId,"params.reportId",0,100,!1),ke(t.category,"params.category",0,100,!1),ke(t.event,"params.event",0,100,!1),ke(t.label,"params.label",0,100,!1),Mt(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(mC={}).FREE="free",mC.UPLOADING="uploading",function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}({});const tj={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let Ue=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t}({}),$t=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t}({});!function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}({});let ej=function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t}({});function et(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(e,n,r){const i=r.value;if("function"==typeof i){const o=t.className||e.__className__||("AgoraRTCClient"===e.constructor.name?"Client":e.constructor.name);r.value=function(){for(var s,a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];let u=c;if(t.argsMap)try{u=t.argsMap(this,...c)}catch(p){_.warning(p),u=[]}try{JSON.stringify(u)}catch{_.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),u=[]}const l=(t.report||Q).reportApiInvoke(this._sessionId||null,{id:this._clientId||(null===(s=this.store)||void 0===s?void 0:s.clientId)||this._ID,name:"".concat(o,".").concat(String(n)),options:u,tag:ne.TRACER,reportResult:t.reportResult},t.throttleTime);try{const p=i.apply(this,c);return p instanceof H?p.then(h=>(l.onSuccess(t.reportResult&&h),h)).catch(h=>{throw l.onError(h),h}):(l.onSuccess(t.reportResult&&p),p)}catch(p){throw l.onError(p),p}}}return r}}const Q=new class{constructor(){var t=this;re(this,"baseInfoMap",new Map),re(this,"proxyServer",void 0),re(this,"eventUploadTimer",void 0),re(this,"setSessionIdTimer",void 0),re(this,"url",void 0),re(this,"sids",new Set),re(this,"backupUrl",void 0),re(this,"_appId",void 0),re(this,"keyEventUploadPendingItems",[]),re(this,"normalEventUploadPendingItems",[]),re(this,"apiInvokeUploadPendingItems",[]),re(this,"apiInvokeCount",0),re(this,"apiInvokeLoggedCount",0),re(this,"ltsList",[]),re(this,"lastSendNormalEventTime",Date.now()),re(this,"customReportCounterTimer",void 0),re(this,"customReportCount",0),re(this,"extApiInvoke",function(){var e=y(function*(n){for(const r of n){const i=dt(dt({},r),{},{sid:null,invokeId:++t.apiInvokeCount,tag:ne.TRACER});t.sendApiInvoke(i)}});return function(n){return e.apply(this,arguments)}}()),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),A("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),A("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}setAppId(t){this._appId=t}reportApiInvoke(t,e,n){e.timeout=e.timeout||6e4,e.reportResult=void 0===e.reportResult||e.reportResult;const r=Date.now();this.apiInvokeCount+=1;const i=this.apiInvokeCount,o=!!A("SHOW_REPORT_INVOKER_LOG"),s=!!A("SHOW_REPORT_USER_INVOKER_LOG"),a=o||s&&e.id;a&&(this.apiInvokeLoggedCount+=1);const c=this.apiInvokeLoggedCount;function d(h,S){if(a){let m="[apiInvoke-".concat(c,"]");e.id&&(m+="[".concat(e.id,"]")),e.name&&(m+="[".concat(e.name,"]")),_.info("".concat(m," ").concat(h),"start"===h?e.options:S||"")}}const u=()=>({tag:e.tag,invokeId:i,sid:t,name:e.name,apiInvokeTime:r,options:e.options,states:e.states||null});d("start");let l=!1;Me(e.timeout).then(()=>{l||(this.sendApiInvoke(dt(dt({},u()),{},{error:v.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))});const p=new P(v.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:h=>{const S=()=>{if(l)throw p;return l=!0,this.sendApiInvoke(dt(dt({},u()),{},{success:!0},e.reportResult&&{result:h})),d("onSuccess"),h};return n?iC(S,e.name+"Success",n,()=>l=!0):S()},onError:h=>{const S=()=>{if(l)throw h;l=!0,this.sendApiInvoke(dt(dt({},u()),{},{success:!1,error:h})),d("onFailure",h.toString())};return n?iC(S,e.name+"Error",n,()=>l=!0):S()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const n=Date.now(),r=this.createBaseInfo(t,n);r.cname=e.cname;const i=Object.assign({},{willUploadConsoleLog:A("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:j_?"global":"oversea",areas:A("AREAS")&&A("AREAS").join(",")},e.extend),{stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:u}=e,l=Date.now(),p=dt(dt({},r),{},{eventType:Ue.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:W_,lts:l,elapse:l-n,extend:JSON.stringify(i),mode:e.mode,process:A("PROCESS_ID"),appType:A("APP_TYPE"),success:!0,version:tr,stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientType:W(h=window.navigator.userAgent).call(h,"AgoraWebView")?42:20,clientRole:u,serviceId:A("PROCESS_ID"),extensionID:A("PLUGIN_INFO").join(",")||""});var h;this.send({type:$t.SESSION,data:p},!0)}joinChooseServer(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt({},r),{},{eventType:Ue.JOIN_CHOOSE_SERVER,lts:i,eventElapse:e.elapse||i-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:i-n.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3,corssRegionTagReq:e.corssRegionTagReq||void 0,corssRegionTagRes:e.corssRegionTagRes||void 0});this.send({type:$t.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt({},r),{},{eventType:Ue.REQ_USER_ACCOUNT,lts:i,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||i-n.startTime,eventElapse:i-e.lts,extend:JSON.stringify(e.extend)});this.send({type:$t.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info;e.vid&&(r.vid=e.vid),r.uid=e.uid,r.cid=e.cid;const i=Date.now(),{firstSuccess:o,avoidJoinStartTime:s}=e,a=i-(o&&s?s:n.startTime),c=dt(dt({},r),{},{eventType:Ue.JOIN_GATEWAY,lts:i,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,errorMsg:e.errorMsg||"",elapse:a,eventElapse:i-e.lts,firstSuccess:o,signalChannel:e.signalChannel,preload:e.preload?1:0});e.succ&&(n.lastJoinSuccessTime=i),this.send({type:$t.JOIN_GATEWAY,data:c},!0)}joinChannelTimeout(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=Date.now(),i=dt(dt({},n.info),{},{lts:r,timeout:e,elapse:r-n.startTime});this.send({type:$t.JOIN_CHANNEL_TIMEOUT,data:i},!0)}publish(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt({},r),{},{eventType:Ue.PUBLISH,lts:i,eventElapse:e.eventElapse,elapse:i-n.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:$t.PUBLISH,data:o},!0)}subscribe(t,e,n){const r=this.baseInfoMap.get(t);if(!r)return;const i=r.info,o=Date.now(),s=dt(dt({},i),{},{eventType:Ue.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-r.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid,preSsrc:e.preSsrc?1:0},n&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof e.peerid?s.peerSuid=e.peerid:s.peer=e.peerid,this.send({type:$t.SUBSCRIBE,data:s},!0)}wsCompressorInit(t){var e;const n=[...kn(e=this.baseInfoMap).call(e)],i=this.baseInfoMap.get(n.length?n[0]:"UnableToGetSid");if(!i)return;const o=i.info,s=Date.now(),a=dt(dt({},o),{},{eventType:Ue.WS_COMPRESSOR_INIT,lts:s,eventElapse:t.eventElapse,elapse:s-i.startTime,status:t.status?1:2});this.send({type:$t.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(t,e,n,r){const i=this.baseInfoMap.get(t);if(!i)return;const o=i.info,s=Date.now(),a=dt(dt(dt({},o),r),{},{elapse:s-i.startTime,eventType:e,lts:s,firstDecodeFrame:Math.max((r.firstFrame||s)-i.startTime,0),apEnd:Math.max(r.apEnd-i.startTime,0),apStart:Math.max(r.apStart-i.startTime,0),joinGwEnd:Math.max(r.joinGwEnd-i.startTime,0),joinGwStart:Math.max(r.joinGwStart-i.startTime,0),pcEnd:Math.max(r.pcEnd-i.startTime,0),pcStart:Math.max(r.pcStart-i.startTime,0),subscriberEnd:Math.max(r.subscriberEnd-i.startTime,0),subscriberStart:Math.max(r.subscriberStart-i.startTime,0),videoAddNotify:Math.max(r.videoAddNotify-i.startTime,0)});this.send({type:n,data:a},!0)}firstRemoteFrame(t,e,n,r){const i=this.baseInfoMap.get(t);if(!i)return;const o=i.info,s=Date.now(),a=dt(dt(dt({},o),r),{},{elapse:s-i.startTime,eventType:e,lts:s});this.send({type:n,data:a},!0)}pcStats(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt(dt({},r),e),{},{vid:void 0===r.vid?0:Number(r.vid),elapse:i-n.startTime,eventType:Ue.PC_STATS,lts:i,preallocation:e.preallocation?1:0});this.send({type:$t.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(t,e){if(t){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt(dt({},r),e),{},{vid:void 0===r.vid?0:Number(r.vid),eventType:Ue.UPDATE_REMOTE_RTPCAPABILITIES,lts:i});this.send({type:$t.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(t,e,n,r){const i=this.baseInfoMap.get(t);if(!i)return;const o=i.info,s=Date.now(),a=dt(dt(dt({},o),r),{},{eventType:e,lts:s});this.send({type:n,data:a},!0)}streamSwitch(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt({},r),{},{eventType:Ue.STREAM_SWITCH,lts:i,isDual:e.isdual,elapse:i-n.startTime,success:e.succ});this.send({type:$t.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt({},r),{},{eventType:Ue.REQUEST_PROXY_APPCENTER,lts:i,eventElapse:i-e.lts,elapse:i-n.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:$t.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt({},r),{},{eventType:Ue.REQUEST_PROXY_WORKER_MANAGER,lts:i,eventElapse:i-e.lts,elapse:i-n.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:$t.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,_.debug(t?"reportProxyServerurl: ".concat(t):"disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt({},r),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:i,elapse:i-n.startTime,joinChannelSuccessElapse:i-(n.lastJoinSuccessTime||i),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:$t.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now();(function(o,s){const c=o[s];if(!c||"string"!=typeof c)return[o];o[s]="";const d=$r(JSON.stringify(o));let u=0;const l=[];let p=0;for(let h=0;h<c.length;h++)p+=c.charCodeAt(h)<=127?1:3,p<=1300-d||(l[l.length]=X(X({},o),{},{[s]:c.substring(u,h)}),u=h,p=c.charCodeAt(h)<=127?1:3);return u!==c.length-1&&(l[l.length]=X(X({},o),{},{[s]:c.substring(u)})),l})(dt(dt(dt({},r),e),{},{elapse:i-n.startTime,lts:i,productType:"WebRTC"}),"payload").forEach(o=>this.send({type:$t.WORKER_EVENT,data:o},!0))}apworkerEvent(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt(dt({},r),e),{},{elapse:i-n.startTime,lts:i});this.send({type:$t.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt(dt({},r),e),{},{elapse:i-n.startTime,lts:i,extend:e.extend||void 0});this.send({type:$t.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),o=dt(dt(dt({},r),e),{},{elapse:i-n.startTime,lts:i});this.send({type:$t.WEBSOCKET_QUIT,data:o},!0)}sendCustomReportMessage(t,e){var n=this;return y(function*(){if(n.customReportCount+=e.length,n.customReportCount>A("CUSTOM_REPORT_LIMIT"))throw new P(v.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);n.customReportCounterTimer||(n.customReportCounterTimer=window.setInterval(()=>{n.customReportCount=0},5e3));const r=Date.now(),i=e.map(o=>({type:$t.USER_ANALYTICS,data:dt(dt({sid:t},o),{},{lts:r})}));try{A("NEW_REPORT_SERVER")?yield n.postDataToStatsCollector2(i):yield n.postDataToStatsCollector(i)}catch(o){throw _.error("send custom report message failed",o.toString()),new P(v.CUSTOM_REPORT_SEND_FAILED,o.message)}})()}sendApiInvoke(t){const e=A("NOT_REPORT_EVENT");if(t.tag&&W(e)&&W(e).call(e,t.tag))return!1;if(null===t.sid)return this.apiInvokeUploadPendingItems.push(t),!1;const n=this.baseInfoMap.get(t.sid);if(!n)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:r,uid:i,cid:o}=n.info;let s;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof P){const{code:c,message:d}=t.error;s=c||d||t.error.toString()}else s=t.error.toString();const a={invokeId:t.invokeId,sid:t.sid,cname:r,cid:o,uid:i,lts:t.lts,success:t.success,elapse:t.lts-n.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?s:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:$t.API_INVOKE,data:a},!1),!0}addSid(t){this.sids.add(t)}removeSid(t){this.sids.delete(t)}appendSessionId(){const t=this.apiInvokeUploadPendingItems;if(0===t.length)return;const e=Array.from(this.sids).find(n=>null!==n);e&&t.forEach(n=>{n&&(n.sid=e,this.sendApiInvoke(Object.assign({},n)))}),t.length=0}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>A("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const n=[],r=[];for(;t.length;){const o=t.shift();n.length<20?n.push(o):r.push(o)}t.push(...r);for(const o of[...n]){var i;-1!==this.ltsList.indexOf(o.data.lts)?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),Ga(i=this.ltsList).call(i,(s,a)=>s-a))}return e||(this.lastSendNormalEventTime=Date.now()),A("ENABLE_EVENT_REPORT")&&n.length&&(A("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((o=>s=>{A("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>A("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-A("NORMAL_EVENT_QUEUE_CAPACITY")),_.warning("report: drop normal events"))))})(n)),t}postDataToStatsCollector2(t){var e=this;return y(function*(){_e.networkState===An.OFFLINE&&(yield H.race([_e.onlineWaiter,Me(2*Se.maxRetryTimeout)]));const n=o=>{let s=new Uint8Array;return o.forEach(a=>{const c=L_(JSON.stringify(a.data)),d=new ArrayBuffer(5),u=(p=>{let h=0;return Object.entries($t).forEach(S=>{let[m,f]=S;f===p.type&&(h=ej[m])}),h})(a),l=new DataView(d);l.setUint16(0,c.byteLength,!0),l.setUint8(2,255&u),l.setUint8(3,u>>>8&255),l.setUint8(4,u>>>16&255),s=zy(s,new Uint8Array(d)),s=zy(s,c)}),s},r="event";let i=e.proxyServer?"https://".concat(e.proxyServer,"/rs/?h=").concat(A("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(r):"https://".concat(A("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(r);for(let o=0;o<2;o+=1){1===o&&(i=e.proxyServer?"https://".concat(e.proxyServer,"/rs/?h=").concat(A("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(r):"https://".concat(A("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(r));try{yield F_(i,{timeout:1e4,data:n(t),headers:dt(dt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},e._appId&&{appid:e._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(s){if(1===o)throw s;continue}return}})()}postDataToStatsCollector(t){var e=arguments,n=this;return y(function*(){let r=e.length>1&&void 0!==e[1]&&e[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(a=>JSON.stringify(a)),vid:(a=>{const c=a&&a.data.sid&&n.baseInfoMap.get(a.data.sid);return c&&c.info.vid&&+c.info.vid||0})(t[0])};_e.networkState===An.OFFLINE&&(yield H.race([_e.onlineWaiter,Me(2*Se.maxRetryTimeout)]));const o=r?"/events/proto-raws":"/events/messages";let s=n.url||(n.proxyServer?"https://".concat(n.proxyServer,"/rs/?h=").concat(A("EVENT_REPORT_DOMAIN"),"&p=").concat(A("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(A("EVENT_REPORT_DOMAIN"),":").concat(A("STATS_COLLECTOR_PORT")).concat(o));for(let a=0;a<2;a+=1){1===a&&(s=n.backupUrl||(n.proxyServer?"https://".concat(n.proxyServer,"/rs/?h=").concat(A("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(A("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(A("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(A("STATS_COLLECTOR_PORT")).concat(o)));try{r?yield zB(s,{timeout:1e4,data:i}):yield F_(s,{timeout:1e4,data:i})}catch(c){if(1===a)throw c;continue}return}})()}createBaseInfo(t,e){const n=Object.assign({},tj);return n.sid=t,this.baseInfoMap.set(t,{info:n,startTime:e}),n}reportResourceTiming(t,e){const n=performance.getEntriesByName(t),r=n[n.length-1];r&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:r,tag:ne.TRACER}).onSuccess()}};_C.on("REPORT_LOG_UPLOAD",t=>{t.networkState=_e.networkState,Q.reportApiInvoke(null,{name:"logUploadError",options:t,tag:ne.TRACER}).onSuccess("logUploadError")});class N extends P{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),re(this,"name","AgoraRTCException")}print(){return super.print(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",_)}throw(){super.throw(_)}}const nj=["CHINA","GLOBAL"],fC=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Uo=[];function xo(t,e){return!!e&&Uo.some(n=>n.uid===t&&n.channelName===e)}var rj=xR.forEach,gC=pd("forEach")?[].forEach:function(t){return rj(this,t,arguments.length>1?arguments[1]:void 0)};Lt({target:"Array",proto:!0,forced:[].forEach!=gC},{forEach:gC});var ij=ur("Array").forEach,oj=zr,sj=ze,aj=on,cj=ij,K_=Array.prototype,dj={DOMTokenList:!0,NodeList:!0},lj=Wt(function(t){var e=t.forEach;return t===K_||aj(K_,t)&&e===K_.forEach||sj(dj,oj(t))?cj:e}),pj=qr,TC=fd;Lt({target:"Object",stat:!0,forced:te(function(){TC(1)})},{keys:function(t){return TC(pj(t))}});var SC=Wt(qn.Object.keys),hj=Wt(Jf),_j=Lt,Ej=Ka,mj=Te([].reverse),RC=[1,2];_j({target:"Array",proto:!0,forced:String(RC)===String(RC.reverse())},{reverse:function(){return Ej(this)&&(this.length=this.length),mj(this)}});var fj=ur("Array").reverse,gj=on,Tj=fj,Y_=Array.prototype,vC=function(t){var e=t.reverse;return t===Y_||gj(Y_,t)&&e===Y_.reverse?Tj:e},Rj=Wt(vC),vj=Lt,yC=Ka,yj=wd,Cj=Ln,CC=sp,Ij=gi,Aj=Vi,bj=Wd,Oj=he,wj=Nd,Nj=bR("slice"),Dj=Oj("species"),q_=Array,Pj=Math.max;vj({target:"Array",proto:!0,forced:!Nj},{slice:function(t,e){var n,r,i,o=Aj(this),s=Ij(o),a=CC(t,s),c=CC(void 0===e?s:e,s);if(yC(o)&&((yj(n=o.constructor)&&(n===q_||yC(n.prototype))||Cj(n)&&null===(n=n[Dj]))&&(n=void 0),n===q_||void 0===n))return wj(o,a,c);for(r=new(void 0===n?q_:n)(Pj(c-a,0)),i=0;a<c;a++,i++)a in o&&bj(r,i,o[a]);return r.length=i,r}});var Lj=ur("Array").slice,kj=on,Mj=Lj,z_=Array.prototype,xj=Wt(function(t){var e=t.slice;return t===z_||kj(z_,t)&&e===z_.slice?Mj:e});function z(t,e,n,r,i){var o,s,a,c={};return lj(o=SC(r)).call(o,function(d){c[d]=r[d]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=hj(s=Rj(a=xj(n).call(n)).call(a)).call(s,function(d,u){return u(t,e,d)||d},c),i&&void 0!==c.initializer&&(c.value=c.initializer?c.initializer.call(i):void 0,c.initializer=void 0),void 0===c.initializer&&(yR(t,e,c),c=null),c}let J_=function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L1T3_KEY="L1T3_KEY",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t}({}),xn=function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t}({}),Du=function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t}({}),X_=function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t}({}),hr=function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t}({}),cn=function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t}({}),tt=function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t}({}),jt=function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t}({}),ot=function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.PRE_CONNECT_PC="pre_connect_pc",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t.RECOVER_NOTIFICATION="recover_notification",t}({}),it=function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t}({}),cc=function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t}({}),pt=function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t}({}),dn=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({}),ct=function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t}({});function Pu(t){if("string"!=typeof t||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw _.error("Invalid Channel Name ".concat(t)),new N(v.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Lu(t){if(!("number"==typeof(e=t)&&Math.floor(e)===e&&0<=e&&e<=4294967295||Yy(t,1,255)))throw new N(v.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;"string"==typeof t&&_.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let ti=function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t}({});const Vj={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Q_={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Z_(t,e){ke(t.url,"".concat(e,".url"),1,1e3,!1),Qt(t.x)||Mt(t.x,"".concat(e,".x"),0,1e4),Qt(t.y)||Mt(t.y,"".concat(e,".y"),0,1e4),Qt(t.width)||Mt(t.width,"".concat(e,".width"),0,1e4),Qt(t.height)||Mt(t.height,"".concat(e,".height"),0,1e4),Qt(t.zOrder)||Mt(t.zOrder,"".concat(e,".zOrder"),0,255),Qt(t.alpha)||Mt(t.alpha,"".concat(e,".alpha"),0,1,!1)}const Fj={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let to=function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t}({}),$_=function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t}({}),Ce=function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t}({});function IC(t){if(!t.channelName)throw new N(v.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof t.uid)throw new N(v.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&ke(t.token,"info.token",1,2047),Lu(t.uid),Pu(t.channelName),!0}let un=function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t}({}),vi=function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t}({}),gn=function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t}({}),Bs=function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t}({}),At=function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t}({}),Ye=function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.PRE_CONNECT_PC="pre-connect_pc",t}({}),ku=function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t}({}),Ne=function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t}({}),vt=function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t}({});const AC=[vt.AFRICA,vt.ASIA,vt.CHINA,vt.EUROPE,vt.GLOBAL,vt.INDIA,vt.JAPAN,vt.NORTH_AMERICA,vt.OCEANIA,vt.OVERSEA,vt.SOUTH_AMERICA];let Xe=function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t}({});const Mu={CHINA:{},ASIA:{CODE:Xe.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Xe.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Xe.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Xe.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Xe.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Xe.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Xe.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Xe.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Xe.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Xe.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Xe.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Xe.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Xe.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};j_&&(Mu.CHINA={CODE:Xe.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let tE=function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t}({});class bC extends Zt{constructor(e,n){super(),T(this,"onICEConnectionStateChange",void 0),T(this,"onConnectionStateChange",void 0),T(this,"onDTLSTransportStateChange",void 0),T(this,"onDTLSTransportError",void 0),T(this,"onICETransportStateChange",void 0),T(this,"onFirstAudioReceived",void 0),T(this,"onFirstVideoReceived",void 0),T(this,"onFirstAudioDecoded",void 0),T(this,"onFirstVideoDecoded",void 0),T(this,"onFirstVideoDecodedTimeout",void 0),T(this,"onSelectedLocalCandidateChanged",void 0),T(this,"onSelectedRemoteCandidateChanged",void 0),T(this,"getLocalVideoStats",void 0)}}class OC extends bC{constructor(e,n){super(e,n),T(this,"establishPromise",void 0)}}let q=function(t){return t.VIDEO="video",t.AUDIO="audio",t}({}),bn=function(t){return t[t.UDP=0]="UDP",t[t.TCP=1]="TCP",t[t.RELAY=2]="RELAY",t}({}),yi=function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.TCP_RESTART=1]="TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t}({}),x=function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t}({}),bt=function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t}({}),nt=function(t){return t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t}({}),_r=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Er=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),De=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),wC=function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t.PRE_CONNECT_PC="transmitter:pre_connect_pc",t}({}),ei=function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t}({}),nr=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Ur=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),js=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),de=function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t}({}),Gs=function(t){return t.ABORT="abort",t}({}),eo=function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t}({}),Bj=function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t}({});const jj={[Du.ACCESS_POINT]:{[cn.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[cn.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[cn.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[cn.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[cn.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[cn.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[cn.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Du.UNILBS]:{[hr.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[hr.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[hr.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[hr.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[hr.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[hr.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[hr.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[hr.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[hr.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[hr.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[hr.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[hr.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Du.STRING_UID_ALLOCATOR]:{[X_.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[X_.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[X_.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Ws(t){const e=jj[Math.floor(t/1e4)];if(!e)return{desc:"unknown error",retry:!1};const n=e[t%1e4];if(!n){if(Math.floor(t/1e4)===Du.ACCESS_POINT){const r=t%1e4;if("1"===r.toString()[0])return{desc:t.toString(),retry:!1};if("2"===r.toString()[0])return{desc:t.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const Gj={[tt.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[tt.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[tt.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[tt.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[tt.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[tt.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[tt.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[tt.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[tt.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[tt.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[tt.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[tt.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[tt.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[tt.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[tt.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[tt.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[tt.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[tt.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[tt.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[tt.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[tt.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[tt.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[tt.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[tt.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[tt.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[tt.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[tt.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[tt.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[tt.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[tt.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[tt.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[tt.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[tt.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[tt.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[tt.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[tt.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[tt.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[tt.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[tt.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[tt.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[tt.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[tt.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[tt.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[tt.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[tt.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[tt.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[tt.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[tt.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[tt.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[tt.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[tt.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[tt.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[tt.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[tt.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[tt.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[tt.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[tt.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[tt.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[tt.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[tt.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[tt.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[tt.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[tt.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function dc(t){return Gj[t]||{desc:"UNKNOWN_ERROR_".concat(t),action:"failed"}}function NC(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function eE(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?NC(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):NC(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function DC(t){return t.every(e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)}function PC(t,e){if("string"==typeof t)return t;const{proxy:n,host:r,port:i}=t;if(e){const o=A("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===o?"wss://".concat(r,"/ws/?p=").concat(Number(i)+150):"wss://".concat(r,":").concat(o,"/ws/?p=").concat(Number(i)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(r,"&p=").concat(i):"wss://".concat(r,":").concat(i)}const Wj=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,Hj=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,Kj=/wss:\/\/(.+):([0-9]+)\/?/,Yj=/wss:\/\/(.[^\/]+)\/?/;let qj=0;class zj{constructor(e,n){T(this,"id",0),T(this,"store",void 0),T(this,"recordIndex",void 0),T(this,"websockets",[]),T(this,"try443PortDuration",2e3),T(this,"forceCloseWSDuration",5e3),T(this,"try443PortTimeout",null),T(this,"forceCloseTimeout",null),T(this,"isTry443PortFailed",!1),T(this,"isNormalPortFailed",!1),T(this,"useDoubleDomain",!1),T(this,"useProxy",!1),T(this,"startTime",Date.now()),this.id=++qj,this.try443PortDuration=A("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const n=Date.now()-this.startTime;for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];_.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...i)}createWebSocket(e,n,r){this.logger("createWebSocket:",e,{isTry443Port:n,hasTimeoutDetection:r});const i=A("GATEWAY_DOMAINS"),o=Date.now(),s=[],a=i.find(u=>{var l;return W(l=e.host).call(l,u)});a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)i.forEach(u=>{c.push(PC(eE(eE({},e),{},{host:e.host.replace(a,u)}),n))});else{const u=eE({},e);if(n&&a){const l=i.find(p=>p!==a);l&&(u.host=u.host.replace(a,l))}c.push(PC(u,n))}try{c.forEach(u=>{const l=new WebSocket(u);l.binaryType="arraybuffer",s.push(l),this.logger("ws is connecting:",l.url)})}catch(u){if(this.logger("ws create failed"),s.forEach(l=>l.close()),s.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,n,r);if(!n&&443!==Number(e.port))return this.createWebSocket(e,!0,r);throw new N(v.WS_ERR,"init websocket failed! Error: ".concat(u.toString()))}const d=nc();return this.store&&this.store.recordJoinChannelService({urls:s.map(u=>u.url),service:"gateway"},this.recordIndex),s.forEach(u=>{u.onopen=()=>{this.logger("onopen: ws ".concat(u.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(l=>{l!==u&&(l.onopen=null,l.onclose=null,l.onmessage=null,l.close(),this.logger("close backup websocket: ".concat(l.url)))}),this.websockets.length=0,d.resolve(u)},u.onclose=l=>{this.logger("onclose: ws ".concat(u.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(u.readyState)),n?this.isTry443PortFailed=DC(s):this.isNormalPortFailed=DC(s),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(n&&this.isTry443PortFailed||!n&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(l.reason)),d.reject({code:l.code,reason:ku.A_ROUND_WS_FAILED}))},u.onmessage=l=>this.logger("".concat(u.url," onmessage: ").concat(l.data))}),this.websockets.push(...s),r||(()=>{const u=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.websockets.forEach(l=>l.readyState!==WebSocket.OPEN&&l.close())};if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(u,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",d.isResolved),d.isResolved)return u();Tt().os===we.MAC_OS&&ee()&&u(),this.createWebSocket(e,!0,!0).then(l=>d.resolve(l)).catch(l=>{this.isNormalPortFailed&&d.reject(l),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(u,this.forceCloseWSDuration)},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(e,n,r,i){return this.useDoubleDomain=!!n,"string"==typeof e&&(e=function(o){let s,a,c;return[,s,a,c]=o.match(Wj)||[],s||([,a,c]=o.match(Hj)||[]),a&&c||([,a,c]=o.match(Kj)||[]),a&&c||([,a]=o.match(Yj)||[]),a||_.warning("un-destructible url: ",o),{proxy:s,host:a,port:c||"443"}}(e)),this.recordIndex=i,this.useProxy=!!e.proxy,r&&this.useProxy&&(_.warn("cannot use 443 only when use proxy"),r=!1),this.createWebSocket(e,!!r,!1).finally(()=>this.clearTimeout())}}function LC(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}class kC extends Zt{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;W(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(ct.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(ct.CONNECTED):"closed"===this._state?this.emit(ct.CLOSED):"failed"===this._state&&this.emit(ct.FAILED))}resetReconnectCount(e){_.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,n){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5?arguments[5]:void 0;super(),T(this,"connectionID",0),T(this,"currentURLIndex",0),T(this,"urls",[]),T(this,"_reconnectMode","tryNext"),T(this,"reconnectReason",void 0),T(this,"_initMutex",void 0),T(this,"name",void 0),T(this,"_state","closed"),T(this,"reconnectInterrupter",void 0),T(this,"websocket",void 0),T(this,"retryConfig",void 0),T(this,"reconnectCount",0),T(this,"forceCloseTimeout",5e3),T(this,"onlineReconnectListener",void 0),T(this,"useCompress",void 0),T(this,"tryDoubleDomain",!1),T(this,"use443PortOnly",!1),T(this,"wsInflateLength",0),T(this,"wsDeflateLength",0),T(this,"closeEstablishingWs",()=>{}),T(this,"store",void 0),T(this,"joinGatewayRecordIndex",void 0),this.store=s,this.name=e,this.retryConfig=function(l){for(var p=1;p<arguments.length;p++){var h=null!=arguments[p]?arguments[p]:{};p%2?LC(Object(h),!0).forEach(function(S){T(l,S,h[S])}):Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(h)):LC(Object(h)).forEach(function(S){Object.defineProperty(l,S,Object.getOwnPropertyDescriptor(h,S))})}return l}({},n),this.useCompress=r,this.tryDoubleDomain=i,this.use443PortOnly=o,this._initMutex=new Je("websocket",s?s.clientId:void 0);const{timeout:a,timeoutFactor:c}=n,d=Math.max(300,Math.floor(3*a/5)),u=Math.max(1.2,Math.floor(8*c)/10);An.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=u),_e.on(Ms.NETWORK_STATE_CHANGE,(l,p)=>{l!==p&&(this.resetReconnectCount("network state change: ".concat(p," -> ").concat(l)),l===An.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=u):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}init(e){var n=arguments,r=this;return y(function*(){let i=n.length>1&&void 0!==n[1]?n[1]:5e3;const o=yield r._initMutex.lock();r.forceCloseTimeout=i,r.urls=e,r.state="connecting";try{const s=nc(),a=r.urls[r.currentURLIndex];A("ENABLE_PREALLOC_PC")&&r.emit(wC.PRE_CONNECT_PC),r.createWebSocketConnection(a).then(s.resolve).catch(s.reject),r.once(ct.CLOSED,()=>{s.reject(new P(v.WS_DISCONNECT))}),r.once(ct.CONNECTED,s.resolve),yield s.promise}catch{}finally{o()}})()}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const r=this.websocket;n?setTimeout(()=>r.close(),500):r.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,n){if(!this.websocket)return void _.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),_.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const r=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),r&&r.bind(this.websocket)({code:9999,reason:n})}sendMessage(e){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new P(v.WS_ABORT,"websocket is not ready");try{n||(e=JSON.stringify(e)),this.websocket.send(e)}catch(r){throw new P(v.WS_ERR,"send websocket message error"+r.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}createWebSocketConnection(e){var n=this;return y(function*(){var r;const i=nc();n.connectionID+=1,n.joinGatewayRecordIndex=void 0;const o=l=>{var p;null===(p=n.store)||void 0===p||p.signalChannelOpen(),_.debug("[".concat(n.name,"] websocket opened:"),l),n.reconnectMode="retry",n.state="connected",n.resetReconnectCount("opened"),i.resolve()},s=function(){var l=y(function*(p){var h;if(_.debug("[".concat(n.name,"] websocket close ").concat(null===(h=n.websocket)||void 0===h?void 0:h.url,", code: ").concat(p.code,", reason: ").concat(p.reason,", current mode: ").concat(n.reconnectMode)),n.reconnectCount>=n.retryConfig.maxRetryCount)i.reject(new P(v.WS_DISCONNECT,"websocket close: ".concat(p.code))),n.close();else{"connected"===n.state&&(n.reconnectReason=p.reason,n.state="reconnecting");const S=$n(n,ct.WILL_RECONNECT,n.reconnectMode,p.reason)||n.reconnectMode,m=yield n.reconnectWithAction(S);if("closed"===n.state)return void _.debug("[".concat(n.connectionID,"] ws is closed, no need to reconnect"));if(!m)return i.reject(new P(v.WS_DISCONNECT,"websocket reconnect failed: ".concat(p.code))),n.close(!0);i.resolve()}});return function(h){return l.apply(this,arguments)}}(),a=l=>{n.emit(ct.ON_MESSAGE,l)},c=l=>{_.warn("[".concat(n.connectionID,"] ws open error ").concat(l))};n.websocket&&(n.websocket.onclose=null,n.websocket.close()),A("GATEWAY_WSS_ADDRESS")&&n.name.startsWith("gateway")&&(e=A("GATEWAY_WSS_ADDRESS")),_.debug("[".concat(n.name,"] start connect, url:"),e);const d=null===(r=n.store)||void 0===r?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var u;const l=yield n.chooseBestWebsocketConnection(e);n.websocket=l,o&&o(n.websocket.url),n.websocket.onclose=s,n.websocket.onmessage=a,n.websocket.onerror=c,null===(u=n.store)||void 0===u||u.recordJoinChannelService({endTs:Date.now(),status:"success"},d),n.joinGatewayRecordIndex=d}catch(l){const p="closed"===n.state,h=l instanceof P,S=h&&l.code===v.WS_ABORT,m=h&&l.code===v.WS_ERR,f=h?l.message:l&&(l.reason||l.toString());_.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(f)),n.store&&n.store.recordJoinChannelService({endTs:Date.now(),status:S?"aborted":"error",errors:[l]},d),p||m?(i.reject(p?new P(v.WS_DISCONNECT,"websocket is closed: ".concat(f)):new P(v.WS_ERR,"init websocket failed: ".concat(f))),m&&_.error("[".concat(n.name,"] init websocket failed: ").concat(f))):s&&s(l)}return i.promise})()}reconnectWithAction(e){var n=arguments,r=this;return y(function*(){let i=!(n.length>1&&void 0!==n[1])||n[1];if(r.reconnectCount>=r.retryConfig.maxRetryCount||0===r.urls.length||"closed"===r.state)return!1;_.warning("[choose-best-ws] action: =>",e),r.onlineReconnectListener||_e.isOnline||!_e.onlineWaiter||(r.onlineReconnectListener=_e.onlineWaiter.then(()=>{r.onlineReconnectListener=void 0}));let o=!0;if(r.reconnectInterrupter=()=>o=!1,i){const c=x_(r.reconnectCount,r.retryConfig);_.debug("[".concat(r.name,"] wait ").concat(c,"ms to reconnect websocket, mode: ").concat(e)),yield H.race([Me(c),r.onlineReconnectListener||new H(()=>{})])}if("closed"===r._state||!o)return!1;r.reconnectCount+=1;const s=function(){var c=y(function*(d,u){r.emit(ct.RECONNECT_CREATE_CONNECTION,u),yield r.createWebSocketConnection(d)});return function(u,l){return c.apply(this,arguments)}}();try{if("retry"===e)yield s(r.urls[r.currentURLIndex],e);else if("tryNext"===e){if(r.currentURLIndex+=1,r.currentURLIndex>=r.urls.length)return r.reconnectWithAction("recover",!1);_.debug("[".concat(r.name,"] websocket url length: ").concat(r.urls.length," current index: ").concat(r.currentURLIndex)),yield s(r.urls[r.currentURLIndex],e)}else"recover"===e&&(_.debug("[".concat(r.name,"] request new urls")),r.resetReconnectCount("recover mode"),r.urls=yield He(r,ct.REQUEST_NEW_URLS),r.currentURLIndex=0,yield s(r.urls[r.currentURLIndex],e))}catch(c){var a;_.error("[".concat(r.name,"] reconnect failed ").concat(c&&c.toString()));const d=null==c||null===(a=c.data)||void 0===a?void 0:a.desc;return Array.isArray(d)&&W(d).call(d,"dynamic key expired")?(r.emit(ct.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):r.reconnectWithAction(e,i)}return!0})()}}class nE extends kC{constructor(e,n){super(e,n,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}chooseBestWebsocketConnection(e,n){var r=this;return y(function*(){const i=nc(),o=new zj(r.forceCloseTimeout,r.store);r.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),o.closeAllWebsockets(),i.reject(new P(v.WS_ABORT,"choose best websocket aborted"))};const s=A("GATEWAY_DOMAINS");return _.debug("[choose-best-ws] currentDomain: ",e,", domains: ",s,"total: ".concat(r.urls.length),"current: ".concat(r.currentURLIndex+1)),o.chooseBestWebsocket(e,r.tryDoubleDomain,r.use443PortOnly,n).then(i.resolve).catch(i.reject),i.promise.finally(()=>{r.closeEstablishingWs=void 0})})()}}class uc extends kC{constructor(e,n){super(e,n,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}chooseBestWebsocketConnection(e,n){var r=this;return y(function*(){return new H((i,o)=>{let s=!1;const a=[];r.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),a.forEach(m=>{m.onclose=null,m.onopen=null,m.onmessage=null,m.close()}),o(new P(v.WS_ABORT,"choose best websocket aborted"))};const c=A("GATEWAY_DOMAINS");let d;const u=e.indexOf("?h="),l=c.find(m=>-1!==u?W(e).call(e,m,u):W(e).call(e,m));_.debug("[choose-best-ws] currentDomain: ",l,", domains: ",c);let p=!r.tryDoubleDomain||!l;if(!p&&l){var h;const m=Date.now();try{c.forEach(f=>{const g=-1===u?e.replace(l,f):e.substr(0,u)+e.substr(u).replace(l,f),R=new WebSocket(g);R.binaryType="arraybuffer",a.push(R),_.debug("[choose-best-ws] ws is connecting:",R.url)})}catch{for(_.debug("[choose-best-ws] ws create failed, fallback to single url"),a.forEach(g=>g.close());a.length;)a.pop();p=!0}null===(h=r.store)||void 0===h||h.recordJoinChannelService({urls:a.map(f=>f.url),service:"gateway"},n),a.forEach(f=>{f.onopen=()=>{if(s)return;const g=Date.now()-m;_.debug("[choose-best-ws] ws open cost ".concat(g,"ms")),a.filter(R=>R!==f).forEach(R=>{_.debug("[choose-best-ws]close backup websocket: ".concat(R.url)),R.close()}),s=!0,i(f)},f.onclose=g=>{d=g,!s&&(a.find(R=>!(R.readyState===WebSocket.CLOSED||R.readyState===WebSocket.CLOSING))||(_.debug("[choose-best-ws] all websocket is closed"),s=!0,o(d)))},f.onmessage=g=>{_.debug("[choose-best-ws]".concat(f.url," onmessage: ").concat(g.data))}}),Me(r.forceCloseTimeout).then(()=>{a.forEach(f=>{f.readyState!==WebSocket.OPEN&&f.close()})})}if(p){var S;let m;_.debug("[choose-best-ws] use single url: ",e),null===(S=r.store)||void 0===S||S.recordJoinChannelService({urls:[e],service:"gateway"},n);try{m=new WebSocket(e),a.push(m),m.binaryType="arraybuffer"}catch(f){const g=new P(v.WS_ERR,"init websocket failed! Error: ".concat(f.toString()));return _.error("[".concat(r.name,"]").concat(g)),void o(g)}m.onopen=()=>{i(m)},m.onclose=f=>{o(f)},m.onmessage=f=>{_.debug("[choose-best-ws]".concat(m.url," onmessage: ").concat(f.data))},Me(r.forceCloseTimeout).then(()=>{m&&m.readyState!==WebSocket.OPEN&&m.close()})}}).then(i=>(r.closeEstablishingWs=void 0,i)).catch(i=>{throw r.closeEstablishingWs=void 0,i})})()}}class Jj extends Zt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===jt.CONNECTED?this.emit(ot.WS_CONNECTED):e===jt.RECONNECTING?this.emit(ot.WS_RECONNECTING,this._websocketReconnectReason):e===jt.CLOSED&&this.emit(ot.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),T(this,"_disconnectedReason",void 0),T(this,"_websocketReconnectReason",void 0),T(this,"_connectionState",jt.CLOSED),T(this,"reconnectToken",void 0),T(this,"websocket",void 0),T(this,"openConnectionTime",void 0),T(this,"clientId",void 0),T(this,"lastMsgTime",Date.now()),T(this,"uploadCache",[]),T(this,"uploadCacheInterval",void 0),T(this,"rttRolling",new dC(5)),T(this,"pingpongTimer",void 0),T(this,"wsInflateDataTimer",void 0),T(this,"pingpongTimeoutCount",0),T(this,"joinResponse",void 0),T(this,"multiIpOption",void 0),T(this,"initError",void 0),T(this,"spec",void 0),T(this,"store",void 0),T(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(ot.ON_BINARY_DATA,r.data);const i=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const o="res-@".concat(i._id);this.emit(o,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){if(this.emit(i._type,i._message),i._type===pt.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===pt.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(Ot.UID_BANNED);break;case 15:this.close(Ot.IP_BANNED);break;case 16:this.close(Ot.CHANNEL_BANNED)}if(i._type===pt.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case tt.ERR_LICENSE_MISSING:this.close(Ot.LICENSE_MISSING);break;case tt.ERR_LICENSE_EXPIRED:this.close(Ot.LICENSE_EXPIRED);break;case tt.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ot.LICENSE_MINUTES_EXCEEDED);break;case tt.ERR_LICENSE_PERIOD_INVALID:this.close(Ot.LICENSE_PERIOD_INVALID);break;case tt.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ot.LICENSE_MULTIPLE_SDK_SERVICE);break;case tt.ERR_LICENSE_ILLEGAL:this.close(Ot.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new nE("gateway-".concat(this.clientId),this.spec.retryConfig,!0,A("JOIN_GATEWAY_USE_DUAL_DOMAIN"),A("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===jt.CONNECTED&&this.reconnect("retry",We.OFFLINE)})}request(e,n,r,i){var o=this;return y(function*(){const s=Ft(6,""),a={_id:s,_type:e,_message:n},c=o.websocket.connectionID,d=()=>new H((m,f)=>{if(o.connectionState===jt.CONNECTED)return m();const g=()=>{o.off(ot.WS_CLOSED,R),m()},R=()=>{o.off(ot.WS_CONNECTED,g),f(new N(v.WS_ABORT))};o.once(ot.WS_CONNECTED,g),o.once(ot.WS_CLOSED,R),e!==it.PUBLISH&&e!==it.PUBLISH_DATASTREAM&&e!==it.SUBSCRIBE&&e!==it.SUBSCRIBE_DATASTREAM&&e!==it.UNSUBSCRIBE&&e!==it.UNSUBSCRIBE_DATASTREAM&&e!==it.UNPUBLISH&&e!==it.UNPUBLISH_DATASTREAM&&e!==it.CONTROL&&e!==it.RESTART_ICE||o.once(ot.DISCONNECT_P2P,()=>{f(new N(v.DISCONNECT_P2P))}),e!==it.PUBLISH&&e!==it.RESTART_ICE||o.once(ot.ABORT_P2P_EXECUTION,()=>{f(new N(v.DISCONNECT_P2P))})});if(o.connectionState!==jt.CONNECTING&&o.connectionState!==jt.RECONNECTING||e===it.JOIN||e===it.REJOIN||(yield d()),o.websocket.sendMessage(a,!0),i)return;const u=new H((m,f)=>{let g=!1;const R=(b,w)=>{g=!0,m({isSuccess:"success"===b,message:w||{}}),o.off(ot.WS_CLOSED,C),o.off(ot.WS_RECONNECTING,C),o.emit(ot.REQUEST_SUCCESS,e,n)};o.once("res-@".concat(s),R);const C=()=>{f(new N(v.WS_ABORT,"type: ".concat(e))),o.off(ot.WS_CLOSED,C),o.off(ot.WS_RECONNECTING,C),o.off("res-@".concat(s),R)};o.once(ot.WS_CLOSED,C),o.once(ot.WS_RECONNECTING,C),Me(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{o.websocket.connectionID!==c||g||(_.warning("[".concat(o.clientId,"] ws request timeout, type: ").concat(e)),o.emit(ot.REQUEST_TIMEOUT,e,n))})});let l=null;try{l=yield u}catch(m){if(o.connectionState===jt.CLOSED||e===it.LEAVE)throw new N(v.WS_ABORT);return!o.spec.forceWaitGatewayResponse||r?m.throw():e===it.JOIN||e===it.REJOIN?null:(yield d(),yield o.request(e,n))}if(l.isSuccess)return l.message;const p=Number(l.message.error_code||l.message.code),h=dc(p),S=new N(v.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:p,data:l.message,desc:h.desc});return"success"===h.action?l.message:(_.warning("[".concat(o.clientId,"] [").concat(o.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(p,", message: ").concat(h.desc,", action: ").concat(h.action)),p===tt.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(o.initError=S,o.close()),S.throw()):"failed"===h.action?S.throw():"quit"===h.action?(o.initError=S,o.close(),S.throw()):(p===tt.ERR_JOIN_BY_MULTI_IP?(o.multiIpOption=l.message.option,_.warning("[".concat(o.clientId,"] detect multi ip, recover")),o.reconnect("recover",We.MULTI_IP)):o.reconnect(h.action,We.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:yield o.request(e,n)))})()}waitMessage(e,n){return new H(r=>{const i=o=>{(!n||n(o))&&(this.off(e,i),r(o))};this.on(e,i)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(cc.WRTC_STATS,n)}upload(e,n){const r={_type:e,_message:n};try{this.websocket.sendMessage(r)}catch{const o=A("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==jt.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},A("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){this.websocket.sendMessage({_type:e,_message:n})}init(e,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new H((r,i)=>{this.once(ot.WS_CONNECTED,()=>r(this.joinResponse)),this.once(ot.WS_CLOSED,()=>i(this.initError||new N(v.WS_ABORT))),this.connectionState=jt.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Ot.LEAVE,this.connectionState=jt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}join(){var e=this;return y(function*(){if(!e.joinResponse){e.emit(ot.ABORT_P2P_EXECUTION);const n=yield He(e,ot.REQUEST_JOIN_INFO),r=yield e.request(it.JOIN,n);if(!r)return e.emit(ot.REPORT_JOIN_GATEWAY,ku.TIMEOUT,e.url||""),!1;e.joinResponse=r,e.emit(ot.JOIN_RESPONSE,e.joinResponse),e.reconnectToken=e.joinResponse.rejoin_token}return e.connectionState=jt.CONNECTED,e.pingpongTimer&&window.clearInterval(e.pingpongTimer),e.pingpongTimer=window.setInterval(e.handlePingPong.bind(e),3e3),!0})()}rejoin(){var e=this;return y(function*(){if(!e.reconnectToken)throw new N(v.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const n=sc(e,ot.REQUEST_REJOIN_INFO);n.token=e.reconnectToken;const r=yield e.request(it.REJOIN,n);return!!r&&(e.connectionState=jt.CONNECTED,e.pingpongTimer&&window.clearInterval(e.pingpongTimer),e.pingpongTimer=window.setInterval(e.handlePingPong.bind(e),3e3),r.peers&&r.peers.forEach(i=>{e.emit(pt.ON_USER_ONLINE,{uid:i.uid}),i.audio&&e.emit(pt.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&e.emit(pt.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),e.emit(i.audio_mute?pt.MUTE_AUDIO:pt.UNMUTE_AUDIO,{uid:i.uid}),e.emit(i.video_mute?pt.MUTE_VIDEO:pt.UNMUTE_VIDEO,{uid:i.uid}),e.emit(i.audio_enable_local?pt.ENABLE_LOCAL_AUDIO:pt.DISABLE_LOCAL_AUDIO,{uid:i.uid}),e.emit(i.video_enable_local?pt.ENABLE_LOCAL_VIDEO:pt.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||e.emit(pt.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)})()}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);const n=dc(e.code);if(28===e.code&&"detail"in e&&(_.info("[".concat(this.clientId,"] receive recover notification: "),e.detail),this.emit(ot.RECOVER_NOTIFICATION,e.detail)),"success"!==n.action){if("failed"!==n.action)return"quit"===n.action?("ERR_REPEAT_JOIN_CHANNEL"===n.desc&&this.close(Ot.UID_BANNED),void this.close()):void this.reconnect(n.action,We.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=A("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>A("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",We.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-n;this.rttRolling.add(r),A("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:n}=this.websocket.getWsInflateData();0!==e&&0!==n&&this.upload(cc.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(ct.RECONNECT_CREATE_CONNECTION,e=>{this.emit(ot.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(ct.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ct.CLOSED,()=>{this.connectionState=jt.CLOSED}),this.websocket.on(ct.FAILED,()=>{this._disconnectedReason=Ot.NETWORK_ERROR,this.connectionState=jt.CLOSED}),this.websocket.on(ct.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState=this.connectionState===jt.CONNECTED?jt.RECONNECTING:jt.CONNECTING}),this.websocket.on(ct.WILL_RECONNECT,(e,n,r)=>{const i=sc(this,ot.IS_P2P_DISCONNECTED),o=i||"retry"!==e;i&&"retry"===e&&(_.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",n=ku.P2P_DISCONNECTED),o&&(_.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(ot.REPORT_JOIN_GATEWAY,n||ku.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(ot.DISCONNECT_P2P)),r(e)}),this.websocket.on(ct.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",We.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(ot.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof N){if(e.code===v.UNEXPECTED_RESPONSE&&e.data.code===tt.ERR_NO_AUTHORIZED)return this.initError=new N(v.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),_.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",We.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",We.SERVER_ERROR):(this.initError=e,this.close())}})}),this.websocket.on(ct.REQUEST_NEW_URLS,(e,n)=>{He(this,ot.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(ct.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(wC.PRE_CONNECT_PC,()=>{this.emit(ot.PRE_CONNECT_PC)})}}let Ee=function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t}({});function MC(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Uu(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?MC(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):MC(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function Hs(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(A("TURN_DOMAIN")):(_.debug("Cannot recognized as ip address: ".concat(t,", use as host")),t)}function rE(t,e){t.addresses||(t.addresses=[]);const n=function(a,c){if(A("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return a.map(l=>{let{ip:p,port:h}=l;return{address:"".concat(p,":").concat(h)}});const d=A("GATEWAY_DOMAINS");let u=d[1]&&W(c).call(c,d[1])?1:0;return a.map(l=>{let{domain_prefix:p,port:h,ip:S}=l;if(p)return{address:"".concat(p,".").concat(d[u++%d.length],":").concat(h)};const m=/^[\.\:\d]+$/.test(S),f=m?"".concat(S.replace(/[^\d]/g,"-"),".").concat(d[u++%d.length],":").concat(h):"".concat(S,":").concat(h);return m||_.debug("Cannot recognized as ip address: ".concat(S,", use as host")),{ip:S,port:h,address:f}})}(t.addresses,e),r=Array.isArray(t.detail)&&t.detail[18];if(r&&"string"==typeof r){const a=r.split(";");for(let c=0;c<a.length;c++){var i;const d=$e(i=a[c]).call(i);n[c]&&d&&(n[c].ip6=d)}}const o=t.detail&&t.detail.candidate;let s;if(o){const[a,c]=o.split(":");a&&c&&(s={port:Number(c),ip:a,address:"".concat(a,":").concat(c)})}return{gatewayAddrs:n,apGatewayAddress:s,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function On(t){return"number"==typeof t?t:t.exact||t.ideal||t.max||t.min||0}function UC(t){const e=t._encoderConfig;if(!e)return{};const n={resolution:e.width&&e.height?"".concat(On(e.width),"x").concat(On(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return"number"==typeof e.frameRate?(n.maxFrameRate=e.frameRate,n.minFrameRate=e.frameRate):e.frameRate&&(n.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,n.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),n}function xC(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function lc(t,e){let n,r,i;switch(e){case Ee.CHOOSE_SERVER:r=4096,i="choose server";break;case Ee.CLOUD_PROXY:r=1048576,i="proxy";break;case Ee.CLOUD_PROXY_5:r=4194304,i="proxy5";break;case Ee.CLOUD_PROXY_FALLBACK:r=4194310,i="proxy fallback";break;default:throw new N(v.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(o=>{o.buffer&&o.buffer.flag===r&&(n={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>Uu(Uu({},s),{},{ticket:o.buffer.cert})),server_ts:t.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:Uu(Uu({},o.buffer.detail),t.detail),flag:o.buffer.flag,opid:t.opid,cert:o.buffer.cert})}),!n)throw new N(v.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(i," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return n}function VC(t,e){return iE.apply(this,arguments)}function iE(){return iE=y(function*(t,e){return yield H.all(t.addresses.map(function(){var n=y(function*(r){return{address:Hs(r.ip),tcpport:r.port,udpport:r.port,username:e&&A("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():Ke.username,password:e&&A("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?yield k_(e.toString()):Ke.password}});return function(r){return n.apply(this,arguments)}}()))}),iE.apply(this,arguments)}function oE(t,e){const n=e.getMediaStreamTrack(!0).getSettings(),r=e.videoHeight||n.height,i=e.videoWidth||n.width;return r&&i?Math.max(Math.min(r,i)/Math.min(On(t.height),On(t.width)),1):(_.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function no(t){let{candidateType:e,relayProtocol:n,type:r,address:i,port:o,protocol:s}=t;const a={candidateType:e,relayProtocol:n,protocol:s};if("local-candidate"!==r){const c=i.split(".");c.length>=4&&(c[1]="*",c[2]="*"),a.address=c.join("."),a.port=o}return a}var mr,Xj=Wt(vC),Qj=ur("Array").values,Zj=zr,$j=ze,tG=on,eG=Qj,sE=Array.prototype,nG={DOMTokenList:!0,NodeList:!0},Ci=Wt(function(t){var e=t.values;return t===sE||tG(sE,t)&&e===sE.values||$j(nG,Zj(t))?eG:e}),FC=Yn,oG=Be,sG=te,aE=fd,aG=Da,cG=id,dG=qr,uG=sd,Ks=Object.assign,BC=Object.defineProperty,lG=Te([].concat),pG=!Ks||sG(function(){if(FC&&1!==Ks({b:1},Ks(BC({},"a",{enumerable:!0,get:function(){BC(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var t={},e={},n=Symbol(),r="abcdefghijklmnopqrst";return t[n]=7,r.split("").forEach(function(i){e[i]=i}),7!=Ks({},t)[n]||aE(Ks({},e)).join("")!=r})?function(t,e){for(var n=dG(t),r=arguments.length,i=1,o=aG.f,s=cG.f;r>i;)for(var a,c=uG(arguments[i++]),d=o?lG(aE(c),o(c)):aE(c),u=d.length,l=0;u>l;)a=d[l++],FC&&!oG(s,c,a)||(n[a]=c[a]);return n}:Ks,hG=fn,_G=gg,EG=Bi,mG=Be,fG=qr,gG=function(t,e,n,r){try{return r?e(hG(n)[0],n[1]):e(n)}catch(i){_G(t,"throw",i)}},TG=Eg,SG=wd,RG=gi,jC=Wd,vG=vp,yG=Sd,GC=Array,Vo=Te,cE=2147483647,CG=/[^\0-\u007E]/,WC=/[.\u3002\uFF0E\uFF61]/g,HC="Overflow: input needs wider integers to process",KC=RangeError,IG=Vo(WC.exec),Ys=Math.floor,dE=String.fromCharCode,YC=Vo("".charCodeAt),qC=Vo([].join),ro=Vo([].push),AG=Vo("".replace),bG=Vo("".split),OG=Vo("".toLowerCase),zC=function(t){return t+22+75*(t<26)},wG=function(t,e,n){var r=0;for(t=n?Ys(t/700):t>>1,t+=Ys(t/e);t>455;)t=Ys(t/35),r+=36;return Ys(r+36*t/(t+38))},NG=function(t){var n,r,e=[],i=(t=function(g){for(var R=[],C=0,b=g.length;C<b;){var w=YC(g,C++);if(w>=55296&&w<=56319&&C<b){var D=YC(g,C++);56320==(64512&D)?ro(R,((1023&w)<<10)+(1023&D)+65536):(ro(R,w),C--)}else ro(R,w)}return R}(t)).length,o=128,s=0,a=72;for(n=0;n<t.length;n++)(r=t[n])<128&&ro(e,dE(r));var c=e.length,d=c;for(c&&ro(e,"-");d<i;){var u=cE;for(n=0;n<t.length;n++)(r=t[n])>=o&&r<u&&(u=r);var l=d+1;if(u-o>Ys((cE-s)/l))throw KC(HC);for(s+=(u-o)*l,o=u,n=0;n<t.length;n++){if((r=t[n])<o&&++s>cE)throw KC(HC);if(r==o){for(var p=s,h=36;;){var S=h<=a?1:h>=a+26?26:h-a;if(p<S)break;var m=p-S,f=36-S;ro(e,dE(zC(S+m%f))),p=Ys(m/f),h+=36}ro(e,dE(zC(p))),a=wG(s,l,d==c),s=0,d++}}s++,o++}return qC(e,"")},DG=Lt,uE=Yn,PG=Xh,lE=Ae,JC=Bi,fr=Te,xu=Gi,gr=Od,LG=Mp,pE=ze,hE=pG,qs=function(t){var e=fG(t),n=SG(this),r=arguments.length,i=r>1?arguments[1]:void 0,o=void 0!==i;o&&(i=EG(i,r>2?arguments[2]:void 0));var s,a,c,d,u,l,p=yG(e),h=0;if(!p||this===GC&&TG(p))for(s=RG(e),a=n?new this(s):GC(s);s>h;h++)l=o?i(e[h],h):e[h],jC(a,h,l);else for(u=(d=vG(e,p)).next,a=n?new this:[];!(c=mG(u,d)).done;h++)l=o?gG(d,i,[c.value,h],!0):c.value,jC(a,h,l);return a.length=h,a},xr=yh,kG=lh.codeAt,Ii=Jn,UG=Wi,xG=gs,XC=jF,VG=Io.set,Vu=Io.getterFor("URL"),FG=XC.URLSearchParams,BG=XC.getState,pc=lE.URL,_E=lE.TypeError,Fu=lE.parseInt,jG=Math.floor,ZC=Math.pow,Tr=fr("".charAt),Vr=fr(/./.exec),hc=fr([].join),GG=fr(1..toString),WG=fr([].pop),zs=fr([].push),EE=fr("".replace),HG=fr([].shift),KG=fr("".split),_c=fr("".slice),Bu=fr("".toLowerCase),YG=fr([].unshift),mE="Invalid scheme",Fo="Invalid host",$C="Invalid port",tI=/[a-z]/i,qG=/[\d+-.a-z]/i,fE=/\d/,zG=/^0x/i,JG=/^[0-7]+$/,XG=/^\d+$/,eI=/^[\da-f]+$/i,QG=/[\0\t\n\r #%/:<>?@[\\\]^|]/,ZG=/[\0\t\n\r #/:<>?@[\\\]^|]/,$G=/^[\u0000-\u0020]+/,t3=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,e3=/[\t\n\r]/g,Ec=function(t){var e,n,r,i;if("number"==typeof t){for(e=[],n=0;n<4;n++)YG(e,t%256),t=jG(t/256);return hc(e,".")}if("object"==typeof t){for(e="",r=function(o){for(var s=null,a=1,c=null,d=0,u=0;u<8;u++)0!==o[u]?(d>a&&(s=c,a=d),c=null,d=0):(null===c&&(c=u),++d);return d>a&&(s=c,a=d),s}(t),n=0;n<8;n++)i&&0===t[n]||(i&&(i=!1),r===n?(e+=n?":":"::",i=!0):(e+=GG(t[n],16),n<7&&(e+=":")));return"["+e+"]"}return t},ju={},nI=hE({},ju,{" ":1,'"':1,"<":1,">":1,"`":1}),rI=hE({},nI,{"#":1,"?":1,"{":1,"}":1}),gE=hE({},rI,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),io=function(t,e){var n=kG(t,0);return n>32&&n<127&&!pE(e,t)?t:encodeURIComponent(t)},Gu={ftp:21,file:null,http:80,https:443,ws:80,wss:443},mc=function(t,e){var n;return 2==t.length&&Vr(tI,Tr(t,0))&&(":"==(n=Tr(t,1))||!e&&"|"==n)},iI=function(t){var e;return t.length>1&&mc(_c(t,0,2))&&(2==t.length||"/"===(e=Tr(t,2))||"\\"===e||"?"===e||"#"===e)},n3=function(t){return"."===t||"%2e"===Bu(t)},TE={},oI={},SE={},sI={},aI={},RE={},cI={},dI={},Wu={},Hu={},vE={},yE={},CE={},IE={},uI={},AE={},Js={},ni={},lI={},Bo={},Ai={},bE=function(t,e,n){var r,i,o,s=Ii(t);if(e){if(i=this.parse(s))throw _E(i);this.searchParams=null}else{if(void 0!==n&&(r=new bE(n,!0)),i=this.parse(s,null,r))throw _E(i);(o=BG(new FG)).bindURL(this),this.searchParams=o}};bE.prototype={type:"URL",parse:function(t,e,n){var r,i,o,s,a,c=this,d=e||TE,u=0,l="",p=!1,h=!1,S=!1;for(t=Ii(t),e||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,t=EE(t,$G,""),t=EE(t,t3,"$1")),t=EE(t,e3,""),r=qs(t);u<=r.length;){switch(i=r[u],d){case TE:if(!i||!Vr(tI,i)){if(e)return mE;d=SE;continue}l+=Bu(i),d=oI;break;case oI:if(i&&(Vr(qG,i)||"+"==i||"-"==i||"."==i))l+=Bu(i);else{if(":"!=i){if(e)return mE;l="",d=SE,u=0;continue}if(e&&(c.isSpecial()!=pE(Gu,l)||"file"==l&&(c.includesCredentials()||null!==c.port)||"file"==c.scheme&&!c.host))return;if(c.scheme=l,e)return void(c.isSpecial()&&Gu[c.scheme]==c.port&&(c.port=null));l="","file"==c.scheme?d=IE:c.isSpecial()&&n&&n.scheme==c.scheme?d=sI:c.isSpecial()?d=dI:"/"==r[u+1]?(d=aI,u++):(c.cannotBeABaseURL=!0,zs(c.path,""),d=lI)}break;case SE:if(!n||n.cannotBeABaseURL&&"#"!=i)return mE;if(n.cannotBeABaseURL&&"#"==i){c.scheme=n.scheme,c.path=xr(n.path),c.query=n.query,c.fragment="",c.cannotBeABaseURL=!0,d=Ai;break}d="file"==n.scheme?IE:RE;continue;case sI:if("/"!=i||"/"!=r[u+1]){d=RE;continue}d=Wu,u++;break;case aI:if("/"==i){d=Hu;break}d=ni;continue;case RE:if(c.scheme=n.scheme,i==mr)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=xr(n.path),c.query=n.query;else if("/"==i||"\\"==i&&c.isSpecial())d=cI;else if("?"==i)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=xr(n.path),c.query="",d=Bo;else{if("#"!=i){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=xr(n.path),c.path.length--,d=ni;continue}c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=xr(n.path),c.query=n.query,c.fragment="",d=Ai}break;case cI:if(!c.isSpecial()||"/"!=i&&"\\"!=i){if("/"!=i){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,d=ni;continue}d=Hu}else d=Wu;break;case dI:if(d=Wu,"/"!=i||"/"!=Tr(l,u+1))continue;u++;break;case Wu:if("/"!=i&&"\\"!=i){d=Hu;continue}break;case Hu:if("@"==i){p&&(l="%40"+l),p=!0,o=qs(l);for(var m=0;m<o.length;m++){var f=o[m];if(":"!=f||S){var g=io(f,gE);S?c.password+=g:c.username+=g}else S=!0}l=""}else if(i==mr||"/"==i||"?"==i||"#"==i||"\\"==i&&c.isSpecial()){if(p&&""==l)return"Invalid authority";u-=qs(l).length+1,l="",d=vE}else l+=i;break;case vE:case yE:if(e&&"file"==c.scheme){d=AE;continue}if(":"!=i||h){if(i==mr||"/"==i||"?"==i||"#"==i||"\\"==i&&c.isSpecial()){if(c.isSpecial()&&""==l)return Fo;if(e&&""==l&&(c.includesCredentials()||null!==c.port))return;if(s=c.parseHost(l))return s;if(l="",d=Js,e)return;continue}"["==i?h=!0:"]"==i&&(h=!1),l+=i}else{if(""==l)return Fo;if(s=c.parseHost(l))return s;if(l="",d=CE,e==yE)return}break;case CE:if(!Vr(fE,i)){if(i==mr||"/"==i||"?"==i||"#"==i||"\\"==i&&c.isSpecial()||e){if(""!=l){var R=Fu(l,10);if(R>65535)return $C;c.port=c.isSpecial()&&R===Gu[c.scheme]?null:R,l=""}if(e)return;d=Js;continue}return $C}l+=i;break;case IE:if(c.scheme="file","/"==i||"\\"==i)d=uI;else{if(!n||"file"!=n.scheme){d=ni;continue}if(i==mr)c.host=n.host,c.path=xr(n.path),c.query=n.query;else if("?"==i)c.host=n.host,c.path=xr(n.path),c.query="",d=Bo;else{if("#"!=i){iI(hc(xr(r,u),""))||(c.host=n.host,c.path=xr(n.path),c.shortenPath()),d=ni;continue}c.host=n.host,c.path=xr(n.path),c.query=n.query,c.fragment="",d=Ai}}break;case uI:if("/"==i||"\\"==i){d=AE;break}n&&"file"==n.scheme&&!iI(hc(xr(r,u),""))&&(mc(n.path[0],!0)?zs(c.path,n.path[0]):c.host=n.host),d=ni;continue;case AE:if(i==mr||"/"==i||"\\"==i||"?"==i||"#"==i){if(!e&&mc(l))d=ni;else if(""==l){if(c.host="",e)return;d=Js}else{if(s=c.parseHost(l))return s;if("localhost"==c.host&&(c.host=""),e)return;l="",d=Js}continue}l+=i;break;case Js:if(c.isSpecial()){if(d=ni,"/"!=i&&"\\"!=i)continue}else if(e||"?"!=i)if(e||"#"!=i){if(i!=mr&&(d=ni,"/"!=i))continue}else c.fragment="",d=Ai;else c.query="",d=Bo;break;case ni:if(i==mr||"/"==i||"\\"==i&&c.isSpecial()||!e&&("?"==i||"#"==i)){if(".."===(a=Bu(a=l))||"%2e."===a||".%2e"===a||"%2e%2e"===a?(c.shortenPath(),"/"==i||"\\"==i&&c.isSpecial()||zs(c.path,"")):n3(l)?"/"==i||"\\"==i&&c.isSpecial()||zs(c.path,""):("file"==c.scheme&&!c.path.length&&mc(l)&&(c.host&&(c.host=""),l=Tr(l,0)+":"),zs(c.path,l)),l="","file"==c.scheme&&(i==mr||"?"==i||"#"==i))for(;c.path.length>1&&""===c.path[0];)HG(c.path);"?"==i?(c.query="",d=Bo):"#"==i&&(c.fragment="",d=Ai)}else l+=io(i,rI);break;case lI:"?"==i?(c.query="",d=Bo):"#"==i?(c.fragment="",d=Ai):i!=mr&&(c.path[0]+=io(i,ju));break;case Bo:e||"#"!=i?i!=mr&&("'"==i&&c.isSpecial()?c.query+="%27":c.query+="#"==i?"%23":io(i,ju)):(c.fragment="",d=Ai);break;case Ai:i!=mr&&(c.fragment+=io(i,nI))}u++}},parseHost:function(t){var e,n,r;if("["==Tr(t,0)){if("]"!=Tr(t,t.length-1)||!(e=function(i){var o,s,a,c,d,u,l,p=[0,0,0,0,0,0,0,0],h=0,S=null,m=0,f=function(){return Tr(i,m)};if(":"==f()){if(":"!=Tr(i,1))return;m+=2,S=++h}for(;f();){if(8==h)return;if(":"!=f()){for(o=s=0;s<4&&Vr(eI,f());)o=16*o+Fu(f(),16),m++,s++;if("."==f()){if(0==s||(m-=s,h>6))return;for(a=0;f();){if(c=null,a>0){if(!("."==f()&&a<4))return;m++}if(!Vr(fE,f()))return;for(;Vr(fE,f());){if(d=Fu(f(),10),null===c)c=d;else{if(0==c)return;c=10*c+d}if(c>255)return;m++}p[h]=256*p[h]+c,2!=++a&&4!=a||h++}if(4!=a)return;break}if(":"==f()){if(m++,!f())return}else if(f())return;p[h++]=o}else{if(null!==S)return;m++,S=++h}}if(null!==S)for(u=h-S,h=7;0!=h&&u>0;)l=p[h],p[h--]=p[S+u-1],p[S+--u]=l;else if(8!=h)return;return p}(_c(t,1,-1))))return Fo;this.host=e}else if(this.isSpecial()){if(t=function(t){var e,n,r=[],i=bG(AG(OG(t),WC,"."),".");for(e=0;e<i.length;e++)ro(r,IG(CG,n=i[e])?"xn--"+NG(n):n);return qC(r,".")}(t),Vr(QG,t)||null===(e=function(i){var o,s,a,c,d,u,l,p=KG(i,".");if(p.length&&""==p[p.length-1]&&p.length--,(o=p.length)>4)return i;for(s=[],a=0;a<o;a++){if(""==(c=p[a]))return i;if(d=10,c.length>1&&"0"==Tr(c,0)&&(d=Vr(zG,c)?16:8,c=_c(c,8==d?1:2)),""===c)u=0;else{if(!Vr(10==d?XG:8==d?JG:eI,c))return i;u=Fu(c,d)}zs(s,u)}for(a=0;a<o;a++)if(u=s[a],a==o-1){if(u>=ZC(256,5-o))return null}else if(u>255)return null;for(l=WG(s),a=0;a<s.length;a++)l+=s[a]*ZC(256,3-a);return l}(t)))return Fo;this.host=e}else{if(Vr(ZG,t))return Fo;for(e="",n=qs(t),r=0;r<n.length;r++)e+=io(n[r],ju);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||"file"==this.scheme},includesCredentials:function(){return""!=this.username||""!=this.password},isSpecial:function(){return pE(Gu,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||"file"==this.scheme&&1==e&&mc(t[0],!0)||t.length--},serialize:function(){var t=this,e=t.scheme,n=t.username,r=t.password,i=t.host,o=t.port,s=t.path,a=t.query,c=t.fragment,d=e+":";return null!==i?(d+="//",t.includesCredentials()&&(d+=n+(r?":"+r:"")+"@"),d+=Ec(i),null!==o&&(d+=":"+o)):"file"==e&&(d+="//"),d+=t.cannotBeABaseURL?s[0]:s.length?"/"+hc(s,"/"):"",null!==a&&(d+="?"+a),null!==c&&(d+="#"+c),d},setHref:function(t){var e=this.parse(t);if(e)throw _E(e);this.searchParams.update()},getOrigin:function(){var t=this.scheme,e=this.port;if("blob"==t)try{return new Xs(t.path[0]).origin}catch{return"null"}return"file"!=t&&this.isSpecial()?t+"://"+Ec(this.host)+(null!==e?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(Ii(t)+":",TE)},getUsername:function(){return this.username},setUsername:function(t){var e=qs(Ii(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<e.length;n++)this.username+=io(e[n],gE)}},getPassword:function(){return this.password},setPassword:function(t){var e=qs(Ii(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<e.length;n++)this.password+=io(e[n],gE)}},getHost:function(){var t=this.host,e=this.port;return null===t?"":null===e?Ec(t):Ec(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,vE)},getHostname:function(){var t=this.host;return null===t?"":Ec(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,yE)},getPort:function(){var t=this.port;return null===t?"":Ii(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||(""==(t=Ii(t))?this.port=null:this.parse(t,CE))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+hc(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,Js))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){""==(t=Ii(t))?this.query=null:("?"==Tr(t,0)&&(t=_c(t,1)),this.query="",this.parse(t,Bo)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){""!=(t=Ii(t))?("#"==Tr(t,0)&&(t=_c(t,1)),this.fragment="",this.parse(t,Ai)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Xs=function(t){var e=LG(this,wn),n=xG(arguments.length,1)>1?arguments[1]:void 0,r=VG(e,new bE(t,!1,n));uE||(e.href=r.serialize(),e.origin=r.getOrigin(),e.protocol=r.getProtocol(),e.username=r.getUsername(),e.password=r.getPassword(),e.host=r.getHost(),e.hostname=r.getHostname(),e.port=r.getPort(),e.pathname=r.getPathname(),e.search=r.getSearch(),e.searchParams=r.getSearchParams(),e.hash=r.getHash())},wn=Xs.prototype,Sr=function(t,e){return{get:function(){return Vu(this)[t]()},set:e&&function(n){return Vu(this)[e](n)},configurable:!0,enumerable:!0}};if(uE&&(gr(wn,"href",Sr("serialize","setHref")),gr(wn,"origin",Sr("getOrigin")),gr(wn,"protocol",Sr("getProtocol","setProtocol")),gr(wn,"username",Sr("getUsername","setUsername")),gr(wn,"password",Sr("getPassword","setPassword")),gr(wn,"host",Sr("getHost","setHost")),gr(wn,"hostname",Sr("getHostname","setHostname")),gr(wn,"port",Sr("getPort","setPort")),gr(wn,"pathname",Sr("getPathname","setPathname")),gr(wn,"search",Sr("getSearch","setSearch")),gr(wn,"searchParams",Sr("getSearchParams")),gr(wn,"hash",Sr("getHash","setHash"))),xu(wn,"toJSON",function(){return Vu(this).serialize()},{enumerable:!0}),xu(wn,"toString",function(){return Vu(this).serialize()},{enumerable:!0}),pc){var pI=pc.createObjectURL,hI=pc.revokeObjectURL;pI&&xu(Xs,"createObjectURL",JC(pI,pc)),hI&&xu(Xs,"revokeObjectURL",JC(hI,pc))}UG(Xs,"URL"),DG({global:!0,constructor:!0,forced:!PG,sham:!uE},{URL:Xs});var r3=Lt,i3=te,o3=gs,_I=Jn,s3=Xh,EI=Cn("URL");r3({target:"URL",stat:!0,forced:!(s3&&i3(function(){EI.canParse()}))},{canParse:function(t){var e=o3(arguments.length,1),n=_I(t),r=e<2||void 0===arguments[1]?void 0:_I(arguments[1]);try{return!!new EI(n,r)}catch{return!1}}});var mI=Wt(qn.URL);const xe={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function St(){return xe}function fI(){return"setSinkId"in HTMLAudioElement.prototype&&(!A("RESTRICTION_SET_PLAYBACK_DEVICE")||(Ji()||ky())&&!N_())}function gI(){return!xe.supportUnifiedPlan||A("CHROME_FORCE_PLAN_B")&&Xi()}let Ve=function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t}({});function Qs(t,e,n){return{sampleRate:t,stereo:e,bitrate:n}}function ft(t,e,n,r,i){return{width:t,height:e,frameRate:n,bitrateMin:r,bitrateMax:i}}function Rr(t,e,n,r,i){return{width:{max:t},height:{max:e},frameRate:n,bitrateMin:r,bitrateMax:i}}function OE(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}const a3={"90p":ft(160,90),"90p_1":ft(160,90),"120p":ft(160,120,15,30,65),"120p_1":ft(160,120,15,30,65),"120p_3":ft(120,120,15,30,50),"120p_4":ft(212,120),"180p":ft(320,180,15,30,140),"180p_1":ft(320,180,15,30,140),"180p_3":ft(180,180,15,30,100),"180p_4":ft(240,180,15,30,120),"240p":ft(320,240,15,40,200),"240p_1":ft(320,240,15,40,200),"240p_3":ft(240,240,15,40,140),"240p_4":ft(424,240,15,40,220),"360p":ft(640,360,15,80,400),"360p_1":ft(640,360,15,80,400),"360p_3":ft(360,360,15,80,260),"360p_4":ft(640,360,30,80,600),"360p_6":ft(360,360,30,80,400),"360p_7":ft(480,360,15,80,320),"360p_8":ft(480,360,30,80,490),"360p_9":ft(640,360,15,80,800),"360p_10":ft(640,360,24,80,800),"360p_11":ft(640,360,24,80,1e3),"480p":ft(640,480,15,100,500),"480p_1":ft(640,480,15,100,500),"480p_2":ft(640,480,30,100,1e3),"480p_3":ft(480,480,15,100,400),"480p_4":ft(640,480,30,100,750),"480p_6":ft(480,480,30,100,600),"480p_8":ft(848,480,15,100,610),"480p_9":ft(848,480,30,100,930),"480p_10":ft(640,480,10,100,400),"720p":ft(1280,720,15,120,1130),"720p_auto":ft(1280,720,30,900,3e3),"720p_1":ft(1280,720,15,120,1130),"720p_2":ft(1280,720,30,120,2e3),"720p_3":ft(1280,720,30,120,1710),"720p_5":ft(960,720,15,120,910),"720p_6":ft(960,720,30,120,1380),"1080p":ft(1920,1080,15,120,2080),"1080p_1":ft(1920,1080,15,120,2080),"1080p_2":ft(1920,1080,30,120,3e3),"1080p_3":ft(1920,1080,30,120,3150),"1080p_5":ft(1920,1080,60,120,4780),"1440p":ft(2560,1440,30,120,4850),"1440p_1":ft(2560,1440,30,120,4850),"1440p_2":ft(2560,1440,60,120,7350),"4k":ft(3840,2160,30,120,8910),"4k_1":ft(3840,2160,30,120,8910),"4k_3":ft(3840,2160,60,120,13500)},c3={"480p":Rr(640,480,5),"480p_1":Rr(640,480,5),"480p_2":Rr(640,480,30),"480p_3":Rr(640,480,15),"720p":Rr(1280,720,5),"720p_auto":ft(1280,720,30,900,3e3),"720p_1":Rr(1280,720,5),"720p_2":Rr(1280,720,30),"720p_3":Rr(1280,720,15),"1080p":Rr(1920,1080,5),"1080p_1":Rr(1920,1080,5),"1080p_2":Rr(1920,1080,30),"1080p_3":Rr(1920,1080,15)},d3={"1SL1TL":OE(1,1),"3SL3TL":OE(3,3),"2SL3TL":OE(2,3)};function ri(t){return t||(t="480p_1"),"string"==typeof t?Object.assign({},a3[t]):t}function wE(t){return"string"==typeof t?Object.assign({},c3[t]):t}function Ku(t){return"string"==typeof t?Object.assign({},d3[t]):t}const u3={speech_low_quality:Qs(16e3,!1),speech_standard:Qs(32e3,!1,18),music_standard:Qs(48e3,!1),standard_stereo:Qs(48e3,!0,56),high_quality:Qs(48e3,!1,128),high_quality_stereo:Qs(48e3,!0,192)};function Yu(t){return"string"==typeof t?Object.assign({},u3[t]):t}const Zs=[];function TI(t){return be(t,"mediaSource",["screen","window","application"]),!0}let Y=function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t}({}),Bt=function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t.SCREEN_LOW_TRACK="screen_low_track",t}({}),$s=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),l3=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",t}({}),p3=function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t[t.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",t}({}),jo=function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t}({}),ta=function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t}({}),ea=function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t}({}),na=function(t){return t.AUDIO="audio",t.VIDEO="video",t.DATA="data",t}({}),Vn=function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t}({});const NE={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},DE={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},SI={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},h3={uplinkNetworkQuality:0,downlinkNetworkQuality:0},RI={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let ln=function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t}({}),Fn=function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t}({}),fc=function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t}({}),Go=function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t}({}),tn=function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t}({}),ii=function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t}({});const PE={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let qu=function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t}({});function gt(t,e,n,r,i){var o,s,a={};return Object.keys(r).forEach(function(c){a[c]=r[c]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=Nr(o=Xj(s=n.slice()).call(s)).call(o,function(c,d){return d(t,e,c)||c},a),i&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(i):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(t,e,a),a=null),a}function L(t,e,n){return(e="symbol"==typeof(i=function(o){if("object"!=typeof o||!o)return o;var a=o[Symbol.toPrimitive];if(void 0!==a){var c=a.call(o,"string");if("object"!=typeof c)return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(e))?i:i+"")in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t;var i}function vI(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function zt(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?vI(Object(n),!0).forEach(function(r){L(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):vI(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class yI extends Zt{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(jo.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,n){super(),L(this,"trackMediaType",void 0),L(this,"_ID",void 0),L(this,"_rtpTransceiver",void 0),L(this,"_lowRtpTransceiver",void 0),L(this,"_hints",[]),L(this,"_isClosed",!1),L(this,"_originMediaStreamTrack",void 0),L(this,"mediaStreamTrack",void 0),L(this,"_external",{}),this._ID=n||Ft(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,W(Zs).call(Zs,this)||Zs.push(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||Qi(()=>{var n;Q.reportApiInvoke(null,{name:ye.GET_MEDIA_STREAM_TRACK,options:[],tag:ne.TRACER}).onSuccess((null===(n=this._mediaStreamTrack)||void 0===n?void 0:n.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===$s.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const n=Zs.indexOf(e);-1!==n&&Zs.splice(n,1)}(this),this.emit(ta.CLOSED),this.removeAllListeners(jo.SEI_RECEIVED)}_updateRtpTransceiver(e,n){if(n===$s.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(jo.TRANSCEIVER_UPDATED,e,n)}}class ra extends yI{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,n){super(e,n),L(this,"_enabled",!0),L(this,"_muted",!1),L(this,"_isExternalTrack",!1),L(this,"_isClosed",!1),L(this,"_enabledMutex",void 0),L(this,"processor",void 0),L(this,"_processorContext",void 0),L(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Je("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,n;return null!==(e=null===(n=this._originMediaStreamTrack)||void 0===n?void 0:n.label)&&void 0!==e?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,_.debug("[".concat(this.getTrackId(),"] close")),this.emit(Y.NEED_CLOSE),super.close())}_updateOriginMediaStreamTrack(e,n){var r=arguments,i=this;return y(function*(){i._isExternalTrack=r.length>2&&void 0!==r[2]&&r[2],e!==i._originMediaStreamTrack&&(i._originMediaStreamTrack&&(i._originMediaStreamTrack.removeEventListener("ended",i._handleTrackEnded),n&&i._originMediaStreamTrack.stop()),e.addEventListener("ended",i._handleTrackEnded),i._originMediaStreamTrack=e,i._muted&&(i._originMediaStreamTrack.enabled=!1),i._mediaStreamTrack=i._originMediaStreamTrack,i._updatePlayerSource(),yield xt(i,Y.NEED_REPLACE_TRACK,i),i.processor&&i._processorContext&&i.processor.updateInput({track:i._originMediaStreamTrack,context:i._processorContext}))})()}_getDefaultPlayerConfig(){return{}}onTrackEnded(){_.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ta.TRACK_ENDED)}stateCheck(e,n){if(_.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(n,"]")),Si(n,e),this._enabled&&this._muted&&"enabled"===e&&!1===n)throw new P(v.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",_);if(!this._enabled&&!this._muted&&"muted"===e&&!0===n)throw new P(v.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",_)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():H.resolve([])}}const CI=window.AudioContext||window.webkitAudioContext;let Bn=null;const Dt=new class extends Zt{constructor(){var t;super(...arguments),t=this,L(this,"prevState",void 0),L(this,"curState",void 0),L(this,"currentTime",void 0),L(this,"currentTimeStuckAt",void 0),L(this,"interruptDetectorTrack",void 0),L(this,"onLocalAudioTrackMute",()=>{_.info("ios15-interruption-start"),this.emit(Ve.IOS_15_16_INTERRUPTION_START)}),L(this,"onLocalAudioTrackUnmute",y(function*(){_.info("ios15-interruption-end"),"running"!==t.curState||t.duringInterruption?_.info("ios15-interruption-end-canceled"):(Bn&&(yield Bn.suspend()),t.emit(Ve.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(t){_.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){_.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function ia(){if(!Bn){if(function(){if(!CI)return void _.error("your browser is not support web audio");_.info("create audio context");const t=zt({},A("WEBAUDIO_INIT_OPTIONS"));var e;_.debug("audio context init option:",JSON.stringify(t)),Bn=new CI(t),Dt.curState=Bn.state,Bn.onstatechange=()=>{Dt.prevState=Dt.curState,Dt.curState=Bn?Bn.state:void 0;const{prevState:e,curState:n}=Dt,r="running"===n,i="interrupted"===n,o="running"===e,s="suspended"===e,a="interrupted"===e,c=Tt().osVersion;(an()||pr())&&o&&i&&(_.info("ios".concat(c,"-interruption-start")),Dt.emit(Ve.IOS_INTERRUPTION_START)),(an()||pr())&&(s||a)&&r&&(_.info("ios".concat(c,"-interruption-end")),Dt.emit(Ve.IOS_INTERRUPTION_END)),e!==n&&Dt.emit(Ve.STATE_CHANGE,n,e)},setInterval(()=>{var e;const n=null===(e=Bn)||void 0===e?void 0:e.currentTime;Dt.currentTime!==n?(Dt.currentTimeStuckAt&&(_.debug("AudioContext current time resume at ".concat(n)),Dt.currentTimeStuckAt=void 0),Dt.currentTime=n):(n!==Dt.currentTimeStuckAt&&(Q.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:ne.TRACER}).onSuccess(),_.warning("AudioContext current time stuck at ".concat(n))),Dt.currentTimeStuckAt=n)},5e3),(e=y(function*(n){const r=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,o=!1,s=!1,a=!1;function c(f){"running"===n.state?d(!1):an()||pr()?"suspended"===n.state&&(d(!0),f&&n.resume().then(u,u)):"closed"!==n.state&&(d(!0),f&&n.resume().then(u,u))}function d(f){if(o!==f){o=f;for(let g=0,R=r;g<R.length;g+=1){const C=R[g];f?window.addEventListener(C,l,{capture:!0,passive:!0}):window.removeEventListener(C,l,{capture:!0,passive:!0})}}}function u(){c(!1)}function l(){c(!0)}function p(f){if(!a)if(i.paused)if(f){let g;h(!1),a=!0;try{g=i.play(),g?g.then(S,S):(i.addEventListener("playing",S),i.addEventListener("abort",S),i.addEventListener("error",S))}catch{S()}}else h(!0);else h(!1)}function h(f){if(s!==f){s=f;for(let g=0,R=r;g<R.length;g++){const C=R[g];f?window.addEventListener(C,m,{capture:!0,passive:!0}):window.removeEventListener(C,m,{capture:!0,passive:!0})}}}function S(){i.removeEventListener("playing",S),i.removeEventListener("abort",S),i.removeEventListener("error",S),a=!1,p(!1)}function m(){p(!0)}if(an()){const f=n.createMediaStreamDestination(),g=document.createElement("div");g.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=g.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=f.stream,p(!0)}Dt.on(Ve.STATE_CHANGE,function(){c(!0)}),c(!1)}),function(n){return e.apply(this,arguments)})(Bn)}(),!Bn)throw new P(v.NOT_SUPPORTED,"can not create audio context");return Bn}return Bn}function Wo(t){if(function(){if(null!==LE)return LE;const r=ia(),i=r.createBufferSource(),o=r.createGain(),s=r.createGain();i.connect(o),i.connect(s),i.disconnect(o);let a=!1;try{i.disconnect(o)}catch{a=!0}return i.disconnect(),LE=a,a}())return;const e=t.connect,n=t.disconnect;t.connect=(r,i,o)=>{var s;return t._inputNodes||(t._inputNodes=[]),W(s=t._inputNodes).call(s,r)||(r instanceof AudioNode?(t._inputNodes.push(r),e.call(t,r,i,o)):e.call(t,r,i)),t},t.disconnect=(r,i,o)=>{n.call(t),r?Cu(t._inputNodes,r):t._inputNodes=[];for(const s of t._inputNodes)e.call(t,s)}}let LE=null;function kE(t,e){let n=!1;const r=1/e;if(A("DISABLE_WEBAUDIO")){const i=window.setInterval(()=>{n?window.clearInterval(i):t(performance.now()/1e3)},1e3*r)}else{const i=ia();let o=i.createGain();o.gain.value=0,o.connect(i.destination);const s=()=>{if(n)return void(o=null);const a=i.createOscillator();a.onended=s,a.connect(o),a.start(0),a.stop(i.currentTime+r),t(i.currentTime)};s()}return()=>{n=!0}}class II{constructor(){L(this,"context",void 0),L(this,"analyserNode",void 0),L(this,"sourceNode",void 0),this.context=ia(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e?.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||an()||pr()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode))return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const r=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(r);for(let i=0;i<e.length;++i)e[i]=r[i]/128-1}const n=Nr(e).call(e,(r,i)=>r+i*i,0)/e.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,n;null===(e=this.sourceNode)||void 0===e||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(n=this.sourceNode)||void 0===n||n.connect(this.analyserNode)}catch{_.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class AI extends Zt{get processSourceNode(){return this.sourceNode}set processedNode(e){var n;if(!this.isDestroyed&&this._processedNode!==e){try{var r;null===(r=this.sourceNode)||void 0===r||r.disconnect(this.outputNode)}catch{}null===(n=this._processedNode)||void 0===n||n.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),L(this,"outputNode",void 0),L(this,"outputTrack",void 0),L(this,"isPlayed",!1),L(this,"sourceNode",void 0),L(this,"context",void 0),L(this,"audioBufferNode",void 0),L(this,"destNode",void 0),L(this,"audioOutputLevel",0),L(this,"volumeLevelAnalyser",void 0),L(this,"_processedNode",void 0),L(this,"playNode",void 0),L(this,"isDestroyed",!1),L(this,"onNoAudioInput",void 0),L(this,"isNoAudioInput",!1),L(this,"_noAudioInputCount",0),this.context=ia(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Wo(this.outputNode),this.volumeLevelAnalyser=new II}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(Vn.ON_AUDIO_BUFFER,function(r){for(let i=0;i<r.outputBuffer.numberOfChannels;i+=1){const o=r.outputBuffer.getChannelData(i);for(let s=0;s<o.length;s+=1)o[s]=0}return r.inputBuffer}(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!St().webAudioMediaStreamDest)throw new P(v.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){"running"!==this.context.state&&Iu(()=>{Dt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}checkHasAudioInput(){var e=arguments,n=this;return y(function*(){let r=e.length>0&&void 0!==e[0]?e[0]:0;if(r>5)return n.isNoAudioInput=!0,n.onNoAudioInput&&n.onNoAudioInput(),!1;an()||pr()?"suspended"===n.context.state&&n.context.resume():"running"!==n.context.state&&n.context.resume();const i=n.volumeLevelAnalyser.getAnalyserNode();let o;i.getFloatTimeDomainData?(o=new Float32Array(i.fftSize),i.getFloatTimeDomainData(o)):(o=new Uint8Array(i.fftSize),i.getByteTimeDomainData(o));let s=!1;for(let a=0;a<o.length;a++)0!==o[a]&&(s=!0);return s?(n.isNoAudioInput=!1,!0):(yield Me(200),(yield n.checkHasAudioInput(r?r+1:1))&&s)})()}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,n;null===(e=this.processedNode)||void 0===e||e.disconnect(),null===(n=this.sourceNode)||void 0===n||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?null===(e=this.processedNode)||void 0===e||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class bI extends AI{get isFreeze(){return!1}constructor(e,n,r){var i,o;if(super(),i=this,L(this,"sourceNode",void 0),L(this,"track",void 0),L(this,"clonedTrack",void 0),L(this,"audioElement",void 0),L(this,"isCurrentTrackCloned",!1),L(this,"isRemoteTrack",!1),L(this,"originVolumeLevelAnalyser",void 0),L(this,"rebuildWebAudio",y(function*(){if(_.debug("ready to rebuild web audio, state:",i.context.state),i.isNoAudioInput&&(yield i.checkHasAudioInput()),!i.isNoAudioInput||i.isDestroyed)return document.body.removeEventListener("click",i.rebuildWebAudio,!0),void _.debug("rebuild web audio success, current volume status",i.getAccurateVolumeLevel());i.context.resume().then(()=>_.info("resume success")),_.debug("rebuild web audio because of ios 12 bugs"),i.disconnect();const c=i.track;i.track=i.track.clone(),i.isCurrentTrackCloned?c.stop():i.isCurrentTrackCloned=!0;const d=new MediaStream([i.track]);i.sourceNode=i.context.createMediaStreamSource(d),Wo(i.sourceNode),i.volumeLevelAnalyser.rebuildAnalyser();const u=i.outputNode.gain.value;i.outputNode=i.context.createGain(),i.outputNode.gain.setValueAtTime(u,i.context.currentTime),Wo(i.outputNode),i.emit(Vn.UPDATE_SOURCE),i.connect(),i.audioElement.srcObject=d,i.isPlayed&&i.play(i.playNode),i.checkHasAudioInput()})),"audio"!==e.kind)throw new P(v.UNEXPECTED_ERROR);this.track=e;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(s),Wo(this.sourceNode),r){const c=r.clone();c.enabled=!0,this.clonedTrack=c,_.debug("create an unmuted track ".concat(c.id," from the original track ").concat(r.id," to get the volume"));const d=this.context.createMediaStreamSource(new MediaStream([c]));Wo(d),this.originVolumeLevelAnalyser=new II,this.originVolumeLevelAnalyser.updateSource(d)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const a=Tt();n&&a.os===we.IOS&&Number(null===(o=a.osVersion)||void 0===o?void 0:o.split(".")[0])<15&&(Dt.on(Ve.STATE_CHANGE,()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(c=>{c||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const n=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(n),Wo(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Vn.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Dt.off("state-change",this.rebuildWebAudio),null===(e=this.originVolumeLevelAnalyser)||void 0===e||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const n=e.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),_.debug("create an unmuted track ".concat(n.id," from the original track ").concat(e.id," to get the volume"));const r=this.context.createMediaStreamSource(new MediaStream([n]));Wo(r),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(r)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}function OI(t,e,n){return ME.apply(this,arguments)}function ME(){return ME=y(function*(t,e,n){const r=(o,s)=>o?"number"!=typeof o?o.max||o.exact||o.ideal||o.min||s:o:s,i={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:r(e.height,1080),maxWidth:r(e.width,1920)}}};return e.frameRate&&"number"!=typeof e.frameRate?(i.video.mandatory.maxFrameRate=e.frameRate.max,i.video.mandatory.minFrameRate=e.frameRate.min):"number"==typeof e.frameRate&&(i.video.mandatory.maxFrameRate=e.frameRate),yield navigator.mediaDevices.getUserMedia(i)}),ME.apply(this,arguments)}function UE(){return UE=y(function*(t,e){const n=yield wI(t.mediaSource),{sourceId:r,audio:i}=yield function(o){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new H((a,c)=>{const d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const u=document.createElement("div");u.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const l=document.createElement("div");l.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",l.setAttribute("style","height: 12%;");const p=document.createElement("div");p.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const h=document.createElement("div");h.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const S=document.createElement("button");S.innerHTML="cancel",S.setAttribute("style","width: 85px;"),S.onclick=()=>{document.body.removeChild(g);const R=new Error("NotAllowedError");R.name="NotAllowedError",c(R)};let m=s;const f=document.createElement("div");if(s){const R=document.createElement("input");R.setAttribute("type","checkbox");const C=document.createElement("span");R.setAttribute("style","margin-right: 6px;"),C.innerText="Share audio",R.checked=m,R.onchange=()=>{m=R.checked},f.appendChild(R),f.appendChild(C)}h.appendChild(f),h.appendChild(S),u.appendChild(l),u.appendChild(p),u.appendChild(h);const g=document.createElement("div");g.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),g.appendChild(d),g.appendChild(u),document.body.appendChild(g),o.map(R=>{if(R.id){const C=document.createElement("div");C.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let b=R.thumbnail;try{const{width:w}=b.getSize();w>1920&&(b=b.resize({width:1920}))}catch(w){throw w&&w.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),w}C.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+b.toDataURL()+' /></div><span style="\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+R.name.replace(/[\u00A0-\u9999<>\&]/g,function(w){return"&#"+w.charCodeAt(0)+";"})+"</span>",C.onclick=()=>{document.body.removeChild(g),a({sourceId:R.id,audio:m})},p.appendChild(C)}})})}(n,e);return yield OI(r,t,i)}),UE.apply(this,arguments)}function wI(t){return xE.apply(this,arguments)}function xE(){return xE=y(function*(t){let e=["window","screen"];"application"!==t&&"window"!==t||(e=["window"]),"screen"===t&&(e=["screen"]);const n=Jy();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new P(v.ELECTRON_IS_NULL);let r=null;try{var i;r=(null===(i=n.desktopCapturer)||void 0===i?void 0:i.getSources({types:e}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{r=null}r&&r.then||(r=new H((o,s)=>{n.desktopCapturer.getSources({types:e},(a,c)=>{a?s(a):o(c)})}));try{return yield r}catch(o){throw new P(v.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}),xE.apply(this,arguments)}const VE=new Je("safari");let NI=!1,DI=!1;function jn(t,e){return FE.apply(this,arguments)}function FE(){return FE=y(function*(t,e){let n=0,r=null;for(;n<2;)try{r=yield E3(t,e,n>0);break}catch(i){if(i instanceof P)throw _.error("[".concat(e,"] ").concat(i.toString())),i;const o=zu(i.name||i.code||i,i.message);if(o.code===v.MEDIA_OPTION_INVALID){_.debug("[".concat(e,"] detect media option invalid, retry")),n+=1,yield Me(500);continue}throw _.error("[".concat(e,"] ").concat(o.toString())),o}if(!r)throw new P(v.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return r}),FE.apply(this,arguments)}function E3(t,e,n){return BE.apply(this,arguments)}function BE(){return BE=y(function*(t,e,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new P(v.NOT_SUPPORTED,"can not find getUserMedia");n&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const r=St(),i=new MediaStream;if(t.audioSource&&i.addTrack(t.audioSource),t.videoSource&&i.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return _.debug("Using Video Source/ Audio Source"),i;if(t.screen)if(Jy())oa(i,t.screen.sourceId?yield OI(t.screen.sourceId,t.screen,!!t.screenAudio):yield function _3(t,e){return UE.apply(this,arguments)}(t.screen,!!t.screenAudio));else if(Ji()&&t.screen.extensionId&&t.screen.mandatory){if(!r.getStreamFromExtension)throw new P(v.NOT_SUPPORTED,"This browser does not support screen sharing");_.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const p=yield(s=t.screen.extensionId,a=e,new H((h,S)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},m=>{if(!m||!m.streamId)return _.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),m),void S(new P(v.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));h(m.streamId)})}catch(m){_.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),m.toString()),S(new P(v.CHROME_PLUGIN_NOT_INSTALL))}}));t.screen.mandatory.chromeMediaSourceId=p,oa(i,yield navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(r.getDisplayMedia){var o;t.screen.mediaSource&&TI(t.screen.mediaSource);const p={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:null!==(o=t.screen.displaySurface)&&void 0!==o?o:"screen"===t.screen.mediaSource?"monitor":t.screen.mediaSource},{selfBrowserSurface:h,surfaceSwitching:S,systemAudio:m}=t.screen,f={selfBrowserSurface:h,surfaceSwitching:S,systemAudio:m};!h&&delete f.selfBrowserSurface,!S&&delete f.surfaceSwitching,!m&&delete f.systemAudio,_.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:p,audio:t.screenAudio,controls:f})),oa(i,yield navigator.mediaDevices.getDisplayMedia(zt({video:p,audio:t.screenAudio},f)))}else{if(!ee())throw _.error("[".concat(e,"] This browser does not support screenSharing")),new P(v.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&TI(t.screen.mediaSource);const p={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};_.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(p))),oa(i,yield navigator.mediaDevices.getUserMedia(p))}}var s,a;if(!t.video&&!t.audio)return i;let c={video:t.video,audio:t.audio},d=A("MEDIA_DEVICE_CONSTRAINTS");if(d)try{"string"==typeof d&&(d=JSON.parse(d)),c=M_(c,d)}catch{}_.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),Tt();let u,l=null;(Ge()||an()||Ru())&&(l=yield VE.lock());try{u=yield navigator.mediaDevices.getUserMedia(c)}catch(p){throw l&&l(),p}return c.audio&&(NI=!0),c.video&&(DI=!0),oa(i,u),l&&l(),i}),BE.apply(this,arguments)}function zu(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new P(v.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new P(v.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new P(v.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new P(v.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new P(v.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new P(v.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return _.error("getUserMedia unexpected error",t),new P(v.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function oa(t,e){const n=t.getVideoTracks()[0],r=t.getAudioTracks()[0],i=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(r&&t.removeTrack(r),t.addTrack(o)),i&&(n&&t.removeTrack(n),t.addTrack(i))}const Gn=new class extends Zt{get state(){return this._state}set state(t){t!==this._state&&(this.emit(Go.STATE_CHANGE,t),this._state=t)}constructor(){super(),L(this,"_state",fc.IDLE),L(this,"isAccessMicrophonePermission",!1),L(this,"isAccessCameraPermission",!1),L(this,"lastAccessMicrophonePermission",!1),L(this,"lastAccessCameraPermission",!1),L(this,"checkdeviceMatched",!1),L(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(A("ENUMERATE_DEVICES_INTERVAL")||(vu()||Su()===we.HARMONY_OS)&&Xi())&&this.updateDevicesInfo()},A("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>_.error(t.toString()))}enumerateDevices(t,e){var n=arguments,r=this;return y(function*(){let i=n.length>2&&void 0!==n[2]&&n[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new P(v.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const o=yield navigator.mediaDevices.enumerateDevices(),s=r.checkMediaDeviceInfoIsOk(o);let a=!r.isAccessMicrophonePermission&&t,c=!r.isAccessCameraPermission&&e;s.audio&&(a=!1),s.video&&(c=!1);let d=null,u=null,l=null;if(!i&&(a||c)){if(VE.isLocked&&(_.debug("[device manager] wait GUM lock"),(yield VE.lock())(),_.debug("[device manager] GUM unlock")),NI&&(a=!1,r.isAccessMicrophonePermission=!0),DI&&(c=!1,r.isAccessCameraPermission=!0),_.debug("[device manager] check media device permissions",t,e,a,c),a&&c){try{l=yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(p){const h=zu(p.name||p.code||p,p.message);if(h.code===v.PERMISSION_DENIED)throw h;_.warning("getUserMedia failed in getDevices",h)}r.isAccessCameraPermission=!0,r.isAccessMicrophonePermission=!0}else if(a){try{d=yield navigator.mediaDevices.getUserMedia({audio:t})}catch(p){const h=zu(p.name||p.code||p,p.message);if(h.code===v.PERMISSION_DENIED)throw h;_.warning("getUserMedia failed in getDevices",h)}r.isAccessMicrophonePermission=!0}else if(c){try{u=yield navigator.mediaDevices.getUserMedia({video:e})}catch(p){const h=zu(p.name||p.code||p,p.message);if(h.code===v.PERMISSION_DENIED)throw h;_.warning("getUserMedia failed in getDevices",h)}r.isAccessCameraPermission=!0}_.debug("[device manager] mic permission",t,"cam permission",e)}try{const p=yield navigator.mediaDevices.enumerateDevices();return d&&d.getTracks().forEach(h=>h.stop()),u&&u.getTracks().forEach(h=>h.stop()),l&&l.getTracks().forEach(h=>h.stop()),d=null,u=null,l=null,p}catch(p){return d&&d.getTracks().forEach(h=>h.stop()),u&&u.getTracks().forEach(h=>h.stop()),l&&l.getTracks().forEach(h=>h.stop()),d=null,u=null,l=null,new P(v.ENUMERATE_DEVICES_FAILED,p.toString()).throw()}})()}getRecordingDevices(){var t=arguments,e=this;return y(function*(){let n=t.length>0&&void 0!==t[0]&&t[0];return(yield e.enumerateDevices(!0,!1,n)).filter(r=>"audioinput"===r.kind)})()}getCamerasDevices(){var t=arguments,e=this;return y(function*(){let n=t.length>0&&void 0!==t[0]&&t[0];return(yield e.enumerateDevices(!1,!0,n)).filter(r=>"videoinput"===r.kind)})()}getSpeakers(){var t=arguments,e=this;return y(function*(){let n=t.length>0&&void 0!==t[0]&&t[0];return(yield e.enumerateDevices(!0,!1,n)).filter(r=>"audiooutput"===r.kind)})()}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach(n=>{n.device.label===t&&(e=n.device.deviceId)}),e}getDeviceById(t){var e=this;return y(function*(){const n=(yield e.enumerateDevices(!0,!0,!0)).find(r=>r.deviceId===t);if(!n)throw new P(v.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return n})()}init(){var t=this;return y(function*(){t.state=fc.INITING;try{yield t.updateDevicesInfo(),t.state=fc.INITEND}catch(e){throw _.warning("Device Detection functionality cannot start properly.",e.toString()),t.state=fc.IDLE,("boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname)||new P(v.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),e}})()}updateDevicesInfo(){var t=this;return y(function*(){const e=yield t.enumerateDevices(!0,!0,!0),n=Date.now(),r=[];if(e[0]&&e[0].label&&!1===t.checkdeviceMatched){t.checkdeviceMatched=!0;const o=e.find(a=>"audioinput"===a.kind&&"default"===a.deviceId),s=e.find(a=>"audiooutput"===a.kind&&"default"===a.deviceId);_.debug(o&&s?s.groupId===o.groupId?"[device-check] default input ".concat(o.label," and output ").concat(s.label," is the same group"):"[device-check] default input ".concat(o.label," and output ").concat(s.label," is not the same group"):"[device-check] default input or output not found")}const i=t.checkMediaDeviceInfoIsOk(e);if(e.forEach(o=>{if(!o.deviceId)return;const s=t.deviceInfoMap.get("".concat(o.kind,"_").concat(o.deviceId));if("ACTIVE"!==(s?s.state:"INACTIVE")){const a={initAt:n,updateAt:n,device:o,state:"ACTIVE"};t.deviceInfoMap.set("".concat(o.kind,"_").concat(o.deviceId),a),r.push(a)}s&&(s.updateAt=n)}),t.deviceInfoMap.forEach((o,s)=>{"ACTIVE"===o.state&&o.updateAt!==n&&(o.state="INACTIVE",r.push(o))}),t.state!==fc.INITEND)return i.audio&&(t.lastAccessMicrophonePermission=!0,t.isAccessMicrophonePermission=!0),void(i.video&&(t.lastAccessCameraPermission=!0,t.isAccessCameraPermission=!0));r.forEach(o=>{switch(o.device.kind){case"audioinput":t.lastAccessMicrophonePermission&&t.isAccessMicrophonePermission&&t.emit(Go.RECORDING_DEVICE_CHANGED,o);break;case"videoinput":t.lastAccessCameraPermission&&t.isAccessCameraPermission&&t.emit(Go.CAMERA_DEVICE_CHANGED,o);break;case"audiooutput":t.lastAccessMicrophonePermission&&t.isAccessMicrophonePermission&&t.emit(Go.PLAYOUT_DEVICE_CHANGED,o)}}),i.audio&&(t.lastAccessMicrophonePermission=!0,t.isAccessMicrophonePermission=!0),i.video&&(t.lastAccessCameraPermission=!0,t.isAccessCameraPermission=!0)})()}checkMediaDeviceInfoIsOk(t){const e=t.filter(i=>"audioinput"===i.kind),n=t.filter(i=>"videoinput"===i.kind),r={audio:!1,video:!1};for(const i of e)if(i.label&&i.deviceId){r.audio=!0;break}for(const i of n)if(i.label&&i.deviceId){r.video=!0;break}return r}};let jE=!1;const Wn=new class extends Zt{constructor(){super(...arguments),L(this,"onAutoplayFailed",void 0),L(this,"onAudioAutoplayFailed",void 0)}};function PI(){if(Tt(),!jE){const t=e=>{e.preventDefault(),jE=!1,rc()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};jE=!0,rc()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),_.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Wn.onAutoplayFailed?Wn.onAutoplayFailed():_.warning(Wn.onAudioAutoplayFailed?"AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .":"We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),Wn.emit("autoplay-failed")}}function LI(t,e,n,r){if(!t)return;const i=Q.getBaseInfoBySessionId(t);if(!i)return;const o=i.info,s=Date.now(),a=zt(zt({},o),{},{vid:void 0===o.vid?0:Number(o.vid),lts:s,elapse:s-i.startTime,cbRegistered:Wn.onAutoplayFailed||Wn.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:e,trackId:r,extend:void 0});Q.send({type:$t.AUTOPLAY_FAILED,data:a},!0)}const m3=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],_n=new class{constructor(){L(this,"onAutoplayFailed",void 0),L(this,"elementMap",new Map),L(this,"elementStateMap",new Map),L(this,"elementsNeedToResume",[]),L(this,"sinkIdMap",new Map),L(this,"autoResumeAfterInterruption",t=>{Array.from(this.elementMap.entries()).forEach(e=>{let[n,r]=e;const i=this.elementStateMap.get(n),o=r.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(_.debug("resume after interrupted, ele: ".concat(i," audio: ").concat(s," ").concat(t)),"live"===s){if(t)return r.pause(),void r.play();if("running"===Dt.curState)return ks()?(r.pause(),void r.play()):void(i&&"paused"===i&&r.play())}})}),L(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,n]=t;const r=n.srcObject.getAudioTracks()[0];r&&"live"===r.readyState&&(_.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())})}),this.autoResumeAudioElement(),Dt.on(Ve.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Dt.on(Ve.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Dt.on(Ve.STATE_CHANGE,()=>{an()&&"suspended"===Dt.prevState&&"running"===Dt.curState&&this.autoResumeAfterInterruption()})}setSinkID(t,e){var n=this;return y(function*(){const r=n.elementMap.get(t);if(n.sinkIdMap.set(t,e),r)try{yield r.setSinkId(e)}catch(i){throw new P(v.PERMISSION_DENIED,"can not set sink id: "+i.toString())}})()}play(t,e,n,r){if(this.elementMap.has(e))return;const i=document.createElement("audio");i.autoplay=!0,i.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,i),this.elementMap.set(e,i),this.elementStateMap.set(e,tn.INIT),this.setVolume(e,n);const o=this.sinkIdMap.get(e);if(o)try{i.setSinkId(o).catch(a=>{_.warning("[".concat(e,"] set sink id failed"),a.toString())})}catch(a){_.warning("[".concat(e,"] set sink id failed"),a.toString())}const s=i.play();s&&s.then&&s.catch(a=>{r&&LI(r,"audio",a.message,e),_.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&"NotAllowedError"===a.name&&(_.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(i),Iu(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),PI()}))})}updateTrack(t,e){const n=this.elementMap.get(t);n&&(n.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&"playing"===this.elementStateMap.get(t)}setVolume(t,e){const n=this.elementMap.get(t);n&&(e=Math.max(0,Math.min(100,e)),n.volume=e/100)}stop(t){const e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;const n=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(n,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){m3.forEach(n=>{e.addEventListener(n,r=>{const i=this.elementStateMap.get(t),o="pause"===r.type?"paused":r.type;if(_.debug("[".concat(t,"] audio-element-status change ").concat(i," => ").concat(o)),"error"===r.type){const s=e?.error;s&&_.error("[".concat(t,"] media error, code: ").concat(s.code,", message: ").concat(s.message))}this.elementStateMap.set(t,o)})})}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(n=>{_.debug("Auto resume audio element success")}).catch(n=>{_.warning("Auto resume audio element failed!",n)})}),this.elementsNeedToResume=[]};new H(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{rc()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))})}};function ue(){return function(t,e,n){const r=n.value;return"function"==typeof r&&(n.value=function(){this._isClosed&&new P(v.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",_);for(var i=arguments.length,o=new Array(i),s=0;s<i;s++)o[s]=arguments[s];const a=r.apply(this,o);return a instanceof H?new H((c,d)=>{a.then(c).catch(d)}):a}),n}}class kI extends Zt{constructor(e){super(),L(this,"name","VideoProcessorDestination"),L(this,"ID","0"),L(this,"_source",void 0),L(this,"videoContext",void 0),L(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new P(v.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new P(v.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(ln.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(ln.ON_TRACK,void 0)}}class MI extends Zt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n){super(),L(this,"constraintsMap",new Map),L(this,"statsRegistry",[]),L(this,"usageRegistry",[]),L(this,"trackId",void 0),L(this,"direction",void 0),L(this,"_chained",!1),this.trackId=e,this.direction=n}getConstraints(){var e=this;return y(function*(){return yield He(e,Fn.REQUEST_CONSTRAINTS)})()}requestApplyConstraints(e,n){var r=this;return y(function*(){var i;return _.info("processor ".concat(n.name," requestApplyConstraints for ").concat(r.trackId)),e&&r.constraintsMap.set(n,e),xt(r,Fn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Ci(i=r.constraintsMap).call(i)))})()}requestRevertConstraints(e){var n=this;return y(function*(){var r;if(n.constraintsMap.has(e))return _.info("processor ".concat(e.name," requestRevertConstraints for ").concat(n.trackId)),n.constraintsMap.delete(e),xt(n,Fn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Ci(r=n.constraintsMap).call(r)))})()}registerStats(e,n,r){this.statsRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:r})}unregisterStats(e,n){const r=this.statsRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===n);-1!==r&&this.statsRegistry.splice(r,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:r,type:i,cb:o}of this.statsRegistry)try{const s=o();e.push({processorID:n,processorName:r,type:i,stats:s})}catch(s){_.error(new P(v.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,n){this.usageRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name);-1!==n&&this.usageRegistry.splice(n,1)}gatherUsage(){var e=this;return y(function*(){const n=[];if(!e.chained)return[];for(const{cb:r}of e.usageRegistry)try{let i=r();i instanceof H&&(i=yield i),n.push(zt(zt({},i),{},{direction:e.direction}))}catch(i){_.error("gather extension usage error",i)}return n})()}getDirection(){return this.direction}}class UI extends Zt{constructor(e){super(),L(this,"name","AudioProcessorDestination"),L(this,"ID","0"),L(this,"inputTrack",void 0),L(this,"inputNode",void 0),L(this,"audioProcessorContext",void 0),L(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new P(v.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new P(v.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(ln.ON_TRACK,void 0),this.emit(ln.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(ln.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(ln.ON_NODE,this.inputNode))}}class xI extends Zt{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n,r){super(),L(this,"constraintsMap",new Map),L(this,"statsRegistry",[]),L(this,"audioContext",void 0),L(this,"trackId",void 0),L(this,"direction",void 0),L(this,"usageRegistry",[]),L(this,"_chained",!1),this.audioContext=e,this.trackId=n,this.direction=r}getConstraints(){var e=this;return y(function*(){return He(e,Fn.REQUEST_CONSTRAINTS)})()}getAudioContext(){return this.audioContext}requestApplyConstraints(e,n){var r=this;return y(function*(){var i;return _.info("processor ".concat(n.name," requestApplyConstraints for ").concat(r.trackId)),e&&r.constraintsMap.set(n,e),xt(r,Fn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Ci(i=r.constraintsMap).call(i)))})()}requestRevertConstraints(e){var n=this;return y(function*(){var r;if(n.constraintsMap.has(e))return n.constraintsMap.delete(e),xt(n,Fn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Ci(r=n.constraintsMap).call(r)))})()}registerStats(e,n,r){this.statsRegistry.find(i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===n)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:r})}unregisterStats(e,n){const r=this.statsRegistry.findIndex(i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===n);-1!==r&&this.statsRegistry.splice(r,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:r,type:i,cb:o}of this.statsRegistry)try{const s=o();e.push({processorID:n,processorName:r,type:i,stats:s})}catch(s){_.error(new P(v.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,n){this.usageRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name);-1!==n&&this.usageRegistry.splice(n,1)}gatherUsage(){var e=this;return y(function*(){const n=[];if(!e.chained)return[];for(const{cb:r}of e.usageRegistry)try{let i=r();i instanceof H&&(i=yield i),n.push(zt(zt({},i),{},{direction:e.direction}))}catch(i){_.error("gather extension usage error",i)}return n})()}getDirection(){return this.direction}}class GE extends Zt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),L(this,"context",void 0),L(this,"processSourceNode",void 0),L(this,"outputTrack",void 0),L(this,"processedNode",void 0),L(this,"clonedTrack",void 0),L(this,"outputNode",void 0),this.outputNode=new f3}setVolume(){}createOutputTrack(){throw new P(v.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class f3{disconnect(){}connect(){}}function VI(t){return new H((e,n)=>{let r=!1;const i=document.createElement("video");i.setAttribute("autoplay",""),i.setAttribute("muted",""),i.muted=!0,i.autoplay=!0,i.setAttribute("playsinline",""),i.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(i);const o=an()?"canplay":"playing";i.addEventListener(o,()=>{const s=i.videoWidth,a=i.videoHeight;!s&&ee()||(r=!0,i.srcObject=null,i.remove(),e([s,a]))}),i.srcObject=new MediaStream([t]),i.play().catch(Au),setTimeout(()=>{r||(i.srcObject=null,i.remove(),e([i.videoWidth,i.videoHeight]))},4e3)})}function Ju(t){const e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});const n=ri(t.encoderConfig);return null!=n.width&&(e.width=n.width),null!=n.height&&(e.height=n.height),!Hy()&&n.frameRate&&(e.frameRate=n.frameRate),ky()&&"object"==typeof e.frameRate&&(e.frameRate.max=60),ee()&&(e.frameRate={ideal:30,max:30}),e}function FI(t){const e={};return Hy()||(void 0!==t.AGC&&(e.autoGainControl=t.AGC),void 0!==t.AEC&&(e.echoCancellation=t.AEC),void 0!==t.ANS&&(e.noiseSuppression=t.ANS,Ji()&&t.ANS&&(e.googHighpassFilter=t.ANS))),e}function BI(t){const e=FI(t);if(t.encoderConfig){const n=Yu(t.encoderConfig);e.channelCount=n.stereo?2:1,e.sampleRate=n.sampleRate,e.sampleSize=n.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),vu()&&(e.sampleRate=void 0),e}const jI=function(){var t=y(function*(e,n,r){return yield(i=y(function*(o,s,a){const c=function(l){const p=[];for(let h=0;h<l.length;h+=2)p.push(parseInt(l.slice(h,h+2),16));return Uint8Array.from(p)}(aC(""+s+a)).slice(0,16),d=c.slice(0,12),u=yield window.crypto.subtle.importKey("raw",c,"AES-GCM",!0,["encrypt"]);return new Uint8Array(yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:d},u,o))}),function(o,s,a){return i.apply(this,arguments)})(e.buffer,n,r);var i});return function(n,r,i){return t.apply(this,arguments)}}(),WE=t=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new H((n,r)=>{e.toBlob(function(){var i=y(function*(o){if(e.remove(),o){const s=yield GI(o);n({buffer:s,width:e.width,height:e.height})}else r(new P(v.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))});return function(o){return i.apply(this,arguments)}}(),t,1)})},GI=function(){var t=y(function*(e){const n=yield e.arrayBuffer();return new Uint8Array(n)});return function(n){return t.apply(this,arguments)}}();var WI,HI,KI,YI,qI,zI,JI,XI,QI,ZI,$I,tA,eA,nA,rA,iA,oA,sA,Xt,aA,cA,dA,uA,lA,pA,oi,hA,_A,EA,mA,fA,gA,TA,SA,RA,vA,yA,CA,IA,qe;let ie=(WI=et({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),HI=et({argsMap:(t,e)=>[t.getTrackId(),e]}),KI=ue(),YI=Vs("LocalAudioTrack","_enabledMutex"),qI=et({argsMap:(t,e)=>[t.getTrackId(),e]}),zI=ue(),JI=Vs("LocalAudioTrack","_enabledMutex"),XI=et({argsMap:(t,e)=>[t.getTrackId(),e]}),QI=ue(),ZI=ue(),$I=ue(),tA=et({argsMap:t=>[t.getTrackId()]}),eA=ue(),nA=et({argsMap:t=>[t.getTrackId()]}),rA=ue(),iA=et({argsMap:t=>[t.getTrackId()]}),oA=et({argsMap:(t,e)=>[t.getTrackId(),e.name]}),sA=et({argsMap:t=>[t.getTrackId()]}),gt((Xt=class extends ra{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?_n.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,n,r){super(t,n),L(this,"trackMediaType",na.AUDIO),L(this,"_encoderConfig",void 0),L(this,"_trackSource",void 0),L(this,"_enabled",!0),L(this,"_volume",100),L(this,"_useAudioElement",!0),L(this,"_bypassWebAudio",!1),L(this,"processor",void 0),L(this,"_processorContext",void 0),L(this,"_processorDestination",void 0),L(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!r,this._trackSource=new GE,A("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),A("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Ge()&&!Bn?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(t){Mt(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&_n.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void _.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,xt(this,Y.NEED_REPLACE_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(n=>{_.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}setPlaybackDevice(t){var e=this;return y(function*(){if(!e._useAudioElement||!fI())throw new P(v.NOT_SUPPORTED,"your browser does not support setting the audio output device");yield _n.setSinkID(e.getTrackId(),t)})()}setEnabled(t,e,n){var r=this;return y(function*(){return r._setEnabled(t,e,n)})()}_setEnabled(t,e,n){var r=this;return y(function*(){if(!n){if(t===r._enabled)return;r.stateCheck("enabled",t)}if(_.info("[".concat(r.getTrackId(),"] start setEnabled"),t),t){r._originMediaStreamTrack.enabled=!0;try{n||(r._enabled=!0),yield xt(r,Y.NEED_ENABLE_TRACK,r),_.info("[".concat(r.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(i){throw n||(r._enabled=!1),_.error("[".concat(r.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else{r._originMediaStreamTrack.enabled=!1,n||(r._enabled=!1);try{yield xt(r,Y.NEED_DISABLE_TRACK,r)}catch(i){throw n||(r._enabled=!0),_.error("[".concat(r.getTrackId(),"] setEnabled to false error"),i.toString()),i}}})()}setMuted(t){var e=this;return y(function*(){t!==e._muted&&(e.stateCheck("muted",t),e._muted=t,e._originMediaStreamTrack.enabled=!t,_.debug("[".concat(e.getTrackId(),"] start set muted: ").concat(t)),t?yield xt(e,Y.NEED_MUTE_TRACK,e):yield xt(e,Y.NEED_UNMUTE_TRACK,e))})()}getStats(){return Qi(()=>{_.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),$n(this,Y.GET_STATS)||zt({},NE)}setAudioFrameCallback(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Vn.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Vn.ON_AUDIO_BUFFER),this._source.on(Vn.ON_AUDIO_BUFFER,n=>t(n))}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] start audio playback in element")),_n.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?_n.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&_n.updateTrack(this.getTrackId(),this._mediaStreamTrack)}_updateOriginMediaStreamTrack(t,e){var n=this;return y(function*(){n._originMediaStreamTrack!==t&&(n._originMediaStreamTrack&&(n._originMediaStreamTrack.removeEventListener("ended",n._handleTrackEnded),e&&n._originMediaStreamTrack.stop()),t.addEventListener("ended",n._handleTrackEnded),n._originMediaStreamTrack=t,n._muted&&(n._originMediaStreamTrack.enabled=!1),n.processor&&n._processorContext&&n.processor.updateInput({track:t,context:n._processorContext}),n._mediaStreamTrack!==n._source.outputTrack?(n._mediaStreamTrack=n._originMediaStreamTrack,n._updatePlayerSource(),yield xt(n,Y.NEED_REPLACE_TRACK,n)):n._source.updateTrack(n._originMediaStreamTrack),n._getOriginVolumeLevel&&n._source.updateOriginTrack(t))})()}renewMediaStreamTrack(t){return H.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new P(v.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new P(v.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;null===(t=this._source.processSourceNode)||void 0===t||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(t){var e=this;t.on(ln.ON_TRACK,function(){var n=y(function*(r){r?r!==e._mediaStreamTrack&&(e._mediaStreamTrack=r,e._updatePlayerSource(!1),e._source.processedNode=e._source.createMediaStreamSourceNode(r),yield xt(e,Y.NEED_REPLACE_TRACK,e)):e._mediaStreamTrack!==e._originMediaStreamTrack&&(e._mediaStreamTrack=e._originMediaStreamTrack,e._updatePlayerSource(),yield xt(e,Y.NEED_REPLACE_TRACK,e))});return function(r){return n.apply(this,arguments)}}()),t.on(ln.ON_NODE,n=>{this._source.processedNode=n})}unbindProcessorDestinationEvents(t){t.removeAllListeners(ln.ON_TRACK),t.removeAllListeners(ln.ON_NODE)}bindProcessorContextEvents(t){var e=this;t.on(Fn.REQUEST_CONSTRAINTS,function(){var n=y(function*(r){r(e._originMediaStreamTrack.getSettings())});return function(r){return n.apply(this,arguments)}}())}unbindProcessorContextEvents(t){t.removeAllListeners(Fn.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof GE&&(this._trackSource=new bI(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const t=new xI(this._source.context,this.getTrackId(),"local"),e=new UI(t);return this._processorContext=t,this._processorDestination=e,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(e),this._source.on(Vn.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(_n.stop(this.getTrackId()),this._source.play()),xt(this,Y.NEED_REPLACE_MIXING_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(n=>{_.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)})),{processorContext:t,processorDestination:e}}}).prototype,"setVolume",[WI],Object.getOwnPropertyDescriptor(Xt.prototype,"setVolume"),Xt.prototype),gt(Xt.prototype,"setPlaybackDevice",[HI,KI],Object.getOwnPropertyDescriptor(Xt.prototype,"setPlaybackDevice"),Xt.prototype),gt(Xt.prototype,"setEnabled",[YI,qI,zI],Object.getOwnPropertyDescriptor(Xt.prototype,"setEnabled"),Xt.prototype),gt(Xt.prototype,"setMuted",[JI,XI,QI],Object.getOwnPropertyDescriptor(Xt.prototype,"setMuted"),Xt.prototype),gt(Xt.prototype,"getStats",[ZI],Object.getOwnPropertyDescriptor(Xt.prototype,"getStats"),Xt.prototype),gt(Xt.prototype,"setAudioFrameCallback",[$I],Object.getOwnPropertyDescriptor(Xt.prototype,"setAudioFrameCallback"),Xt.prototype),gt(Xt.prototype,"play",[tA,eA],Object.getOwnPropertyDescriptor(Xt.prototype,"play"),Xt.prototype),gt(Xt.prototype,"stop",[nA,rA],Object.getOwnPropertyDescriptor(Xt.prototype,"stop"),Xt.prototype),gt(Xt.prototype,"close",[iA],Object.getOwnPropertyDescriptor(Xt.prototype,"close"),Xt.prototype),gt(Xt.prototype,"pipe",[oA],Object.getOwnPropertyDescriptor(Xt.prototype,"pipe"),Xt.prototype),gt(Xt.prototype,"unpipe",[sA],Object.getOwnPropertyDescriptor(Xt.prototype,"unpipe"),Xt.prototype),Xt),Xu=(aA=et({argsMap:(t,e)=>[t.getTrackId(),e]}),cA=ue(),dA=Vs("MicrophoneAudioTrack","_enabledMutex"),uA=et({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),lA=ue(),pA=et({argsMap:t=>[t.getTrackId()]}),gt((oi=class extends ie{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,n,r){super(t,e.encoderConfig?Yu(e.encoderConfig):{},r,A("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),L(this,"_config",void 0),L(this,"_deviceName","default"),L(this,"_constraints",void 0),L(this,"_originalConstraints",void 0),L(this,"_enabled",!0),this._config=e,this._constraints=n,this._originalConstraints=n,this._deviceName=t.label,"boolean"==typeof e.bypassWebAudio&&(this._bypassWebAudio=e.bypassWebAudio),(ks()||w_())&&Dt.bindInterruptDetectorTrack(this)}setDevice(t){var e=this;return y(function*(){if(_.info("[".concat(e.getTrackId(),"] start set device to ").concat(t)),e._enabled)try{const n=yield Gn.getDeviceById(t),r={};r.audio=zt({},e._constraints),r.audio.deviceId={exact:t},e._originMediaStreamTrack.stop();let i=null;try{i=yield jn(r,e.getTrackId())}catch(o){throw _.error("[".concat(e.getTrackId(),"] setDevice failed"),o.toString()),i=yield jn({audio:e._constraints},e.getTrackId()),yield e._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),o}yield e._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),e._deviceName=n.label,e._config.microphoneId=t,e._constraints.deviceId={exact:t}}catch(n){throw _.error("[".concat(e.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=yield Gn.getDeviceById(t);e._deviceName=n.label,e._config.microphoneId=t,e._constraints.deviceId={exact:t}}catch(n){throw _.error("[".concat(e.getTrackId(),"] setDevice error"),n.toString()),n}_.info("[".concat(e.getTrackId(),"] set device to ").concat(t," success"))})()}setEnabled(t,e,n){var r=()=>super._setEnabled,i=this;return y(function*(){if(e)return _.debug("[".concat(i.getTrackId(),"] setEnabled false (do not close microphone)")),yield r().call(i,t);if(!n){if(t===i._enabled)return;i.stateCheck("enabled",t)}if(_.info("[".concat(i.getTrackId(),"] start setEnabled"),t),A("AUTO_RESET_AUDIO_ROUTE")&&(an()||pr())){const c=navigator.audioSession;c&&(t||(c.type="playback"),c.type="auto")}if(!t){var o;i._originMediaStreamTrack.onended=null,i._originMediaStreamTrack.stop(),null===(o=i._source.clonedTrack)||void 0===o||o.stop(),n||(i._enabled=!1);try{yield xt(i,Y.NEED_DISABLE_TRACK,i)}catch(c){throw _.error("[".concat(i.getTrackId(),"] setEnabled false failed"),c.toString()),c}return}const s=zt({},i._constraints),a=Gn.searchDeviceIdByName(i._deviceName);a&&!s.deviceId&&(s.deviceId=a);try{n||(i._enabled=!0);const c=yield jn({audio:i._constraints},i.getTrackId());yield i._updateOriginMediaStreamTrack(c.getAudioTracks()[0],!1),yield xt(i,Y.NEED_ENABLE_TRACK,i)}catch(c){throw n||(i._enabled=!1),_.error("[".concat(i.getTrackId(),"] setEnabled true failed"),c.toString()),c}_.info("[".concat(i.getTrackId(),"] setEnabled success"))})()}close(){super.close(),(ks()||w_())&&Dt.unbindInterruptDetectorTrack(this)}onTrackEnded(){var t=this;if((an()||pr())&&this._enabled&&!this._isClosed&&Dt.duringInterruption){const e=function(){var n=y(function*(){Dt.off(Ve.IOS_INTERRUPTION_END,e),t._enabled&&!t._isClosed&&(_.debug("[".concat(t.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),yield t.setEnabled(!1),yield t.setEnabled(!0))});return function(){return n.apply(this,arguments)}}();Dt.on(Ve.IOS_INTERRUPTION_END,e)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ta.TRACK_ENDED)}renewMediaStreamTrack(t){var e=this;return y(function*(){const n=t||e._constraints,r=Gn.searchDeviceIdByName(e._deviceName);if(r&&!n.deviceId&&(n.deviceId=r),e._constraints=n,e._enabled){e._originMediaStreamTrack.stop();const i=yield jn({audio:e._constraints},e.getTrackId());yield e._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0)}})()}bindProcessorContextEvents(t){var e=this;super.bindProcessorContextEvents(t),t.on(Fn.REQUEST_UPDATE_CONSTRAINTS,function(){var n=y(function*(r,i,o){try{const s=Object.assign({},e._originalConstraints,...r);yield e.renewMediaStreamTrack(s),i()}catch(s){o(s)}});return function(r,i,o){return n.apply(this,arguments)}}())}unbindProcessorContextEvents(t){super.unbindProcessorContextEvents(t),t.removeAllListeners(Fn.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[aA,cA],Object.getOwnPropertyDescriptor(oi.prototype,"setDevice"),oi.prototype),gt(oi.prototype,"setEnabled",[dA,uA,lA],Object.getOwnPropertyDescriptor(oi.prototype,"setEnabled"),oi.prototype),gt(oi.prototype,"close",[pA],Object.getOwnPropertyDescriptor(oi.prototype,"close"),oi.prototype),oi),T3=(hA=et({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),_A=ue(),EA=et({argsMap:t=>[t.getTrackId()]}),mA=ue(),fA=et({argsMap:t=>[t.getTrackId()]}),gA=ue(),TA=et({argsMap:t=>[t.getTrackId()]}),SA=ue(),RA=et({argsMap:t=>[t.getTrackId()]}),vA=ue(),yA=et({argsMap:t=>[t.getTrackId()]}),CA=et({argsMap:t=>[t.getTrackId()]}),IA=ue(),gt((qe=class extends ie{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,n,r){super(e.createOutputTrack(),n,r),L(this,"source",void 0),L(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=e,this._bufferSource.on(Vn.AUDIO_SOURCE_STATE_CHANGE,i=>{this.safeEmit(ta.SOURCE_STATE_CHANGE,i)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){Mt(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[hA,_A],Object.getOwnPropertyDescriptor(qe.prototype,"startProcessAudioBuffer"),qe.prototype),gt(qe.prototype,"pauseProcessAudioBuffer",[EA,mA],Object.getOwnPropertyDescriptor(qe.prototype,"pauseProcessAudioBuffer"),qe.prototype),gt(qe.prototype,"seekAudioBuffer",[fA,gA],Object.getOwnPropertyDescriptor(qe.prototype,"seekAudioBuffer"),qe.prototype),gt(qe.prototype,"resumeProcessAudioBuffer",[TA,SA],Object.getOwnPropertyDescriptor(qe.prototype,"resumeProcessAudioBuffer"),qe.prototype),gt(qe.prototype,"stopProcessAudioBuffer",[RA,vA],Object.getOwnPropertyDescriptor(qe.prototype,"stopProcessAudioBuffer"),qe.prototype),gt(qe.prototype,"close",[yA],Object.getOwnPropertyDescriptor(qe.prototype,"close"),qe.prototype),gt(qe.prototype,"setAudioBufferPlaybackSpeed",[CA,IA],Object.getOwnPropertyDescriptor(qe.prototype,"setAudioBufferPlaybackSpeed"),qe.prototype),qe);class Ie extends ie{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=ia().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,Ft(8,"track-mix-")),L(this,"trackList",void 0),L(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return-1!==this.trackList.indexOf(e)}addAudioTrack(e){-1===this.trackList.indexOf(e)?(_.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):_.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(-1!==this.trackList.indexOf(e)){_.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}Cu(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach(n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(n=>{n instanceof Ie?n.emit(jo.TRANSCEIVER_UPDATED,e):n._updateRtpTransceiver(e)}))}}class S3 extends AI{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(Vn.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),L(this,"audioBuffer",void 0),L(this,"sourceNode",void 0),L(this,"startPlayTime",0),L(this,"startPlayOffset",0),L(this,"pausePlayTime",0),L(this,"options",void 0),L(this,"currentLoopCount",0),L(this,"currentPlaybackSpeed",100),L(this,"_currentState","stopped"),this.audioBuffer=e,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?"stopped"===this.currentState?0:"paused"===this.currentState?this.pausePlayTime:(this.playbackSpeed/100*(this.context.currentTime-this.startPlayTime)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){"stopped"===this.currentState?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):_.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&"playing"===this.currentState&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,"playing"===this.currentState&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),"playing"===this.currentState?(this.startPlayOffset=e,this.startSourceNode()):"paused"===this.currentState&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){"paused"===this.currentState&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&("playing"===this.currentState&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const AA=new Map;class HE{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){const n=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/(this.renderStats.curTs-this.renderStats.lastTs);return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,n}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(_.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var n;e!==this._videoState&&(this._videoState=e,null===(n=this.onVideoStateChanged)||void 0===n||n.call(this,this.videoState))}constructor(e){L(this,"trackId",void 0),L(this,"config",void 0),L(this,"onFirstVideoFrameDecoded",void 0),L(this,"onVideoStateChanged",void 0),L(this,"freezeTimeCounterList",[]),L(this,"renderFreezeAccTime",0),L(this,"isKeepLastFrame",!1),L(this,"timeUpdatedCount",0),L(this,"freezeTime",0),L(this,"playbackTime",0),L(this,"lastTimeUpdatedTime",0),L(this,"autoplayFailed",!1),L(this,"videoTrack",void 0),L(this,"videoElement",void 0),L(this,"cacheVideoElement",void 0),L(this,"renderStats",void 0),L(this,"_videoState",ii.VideoStateStopped),L(this,"videoElementCheckInterval",void 0),L(this,"videoElementFreezeTimeout",void 0),L(this,"_videoElementStatus",tn.NONE),L(this,"isGettingVideoDimensions",!1),L(this,"startGetVideoDimensions",()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return _.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()}),L(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===Dt.curState&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Ly())),Gy()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),L(this,"handleVideoEvents",n=>{switch(n.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=tn.PLAYING;break;case"loadeddata":if(this.videoState=ii.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=tn.CANPLAY;break;case"stalled":this.videoElementStatus=tn.STALLED;break;case"suspend":this.videoElementStatus=tn.SUSPEND;break;case"pause":this.videoElementStatus=tn.PAUSED,an()||pr()||Ge()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=tn.WAITING;break;case"abort":this.videoElementStatus=tn.ABORT;break;case"ended":this.videoElementStatus=tn.ENDED;break;case"emptied":this.videoElementStatus=tn.EMPTIED;break;case"error":{const r=this.videoElement.error;r&&(this.videoElementStatus=tn.ERROR,_.error("[".concat(this.trackId,"] media error: ").concat(r.message," (").concat(r.code,")")));break}case"timeupdate":{const r=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=r);const i=r-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=r,bi.lastVisibleTime<bi.lastHiddenTime||o<bi.lastHiddenTime||o<bi.lastVisibleTime)return;for(i>A("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=i),this.playbackTime+=i;this.playbackTime>=6e3;){this.playbackTime-=6e3;const s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),L(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Ly())),Gy()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,this.videoElement=e.element instanceof HTMLVideoElement?e.element:document.createElement("video"),Dt.on(Ve.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Dt.on(Ve.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return null!==(e=this.videoElement.parentElement)&&void 0!==e?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const n=this.videoElement.play();n&&n.catch&&n.catch(i=>{e&&LI(e,"video",i.message,this.trackId),"NotAllowedError"===i.name?(_.warning("detected video element autoplay failed",i),this.autoplayFailed=!0,this.handleAutoPlayFailed()):_.warning("[".concat(this.trackId,"] play warning: "),i)});const r=Tt();if(("Safari"===r.name&&15===Number(r.version)||ks())&&n&&n.then){const i=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(i).catch(i)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const n=e.getContext("2d");if(!n)return _.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,e.width,e.height);const r=n.getImageData(0,0,e.width,e.height);return e.remove(),r}getCurrentFrameToUint8Array(e){var n=arguments,r=this;return y(function*(){let i=n.length>1&&void 0!==n[1]?n[1]:1;const o=document.createElement("canvas");o.width=r.videoElement.videoWidth,o.height=r.videoElement.videoHeight;const s=o.getContext("2d");return s?(s.drawImage(r.videoElement,0,0,o.width,o.height),new H((a,c)=>{o.toBlob(function(){var d=y(function*(u){if(o.remove(),u){const l=yield GI(u);a({buffer:l,width:o.width,height:o.height})}else c(new P(v.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))});return function(u){return d.apply(this,arguments)}}(),e,i<0?.1:i>1?1:i)})):yield WE(e)})()}destroy(){this.renderStats=void 0,Dt.off(Ve.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Dt.off(Ve.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=ii.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=tn.INIT,!this.videoElementCheckInterval&&(bA.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{var o;(o=this.videoElement)!==document.body&&document.body.contains(o)||(this.videoElementStatus=tn.DESTROYED)},1e3),A("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,n;let o;const s=()=>{"visible"===document.visibilityState&&(document.removeEventListener("visibilitychange",s),this.videoElementFreezeTimeout=window.setTimeout(a,A("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===ii.VideoStateDecoding&&("visible"===document.visibilityState?this.videoState=ii.VideoStateFrozen:document.addEventListener("visibilitychange",s))},c=(d,u)=>{if(this.videoElementStatus===tn.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=u.mediaTime):this.renderStats={lastTs:u.mediaTime,curTs:u.mediaTime,lastRenderNum:0,renderNum:0},o){const h=u.presentationTime-o.presentationTime;this.videoState===ii.VideoStateStarting&&(this.videoState=ii.VideoStateDecoding),this.videoState===ii.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,A("VIDEO_FREEZE_DURATION"))),h<A("VIDEO_FREEZE_DURATION")&&this.videoState===ii.VideoStateFrozen&&(this.videoState=ii.VideoStateDecoding),h>A("VIDEO_FREEZE_DURATION")&&bi.lastVisibleTime>=bi.lastHiddenTime&&o.timestamp>bi.lastVisibleTime&&o.timestamp>bi.lastHiddenTime&&(this.renderFreezeAccTime+=h)}o=zt(zt({},u),{},{timestamp:d})}var l,p;A("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(l=(p=this.videoElement).requestVideoFrameCallback)||void 0===l||l.call(p,c))};null===(e=(n=this.videoElement).requestVideoFrameCallback)||void 0===e||e.call(n,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),vu()&&!A("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const r=Tt();"Safari"===r.name&&15===Number(r.version)||ks()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.videoElement.style.objectFit=this.config.fit?this.config.fit:"cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ee()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,ee()&&this.videoElement.load());const i=this.videoElement.play();void 0!==i&&i.catch(o=>{_.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){bA.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=tn.NONE}handleAutoPlayFailed(){const e=n=>{n.preventDefault(),this.videoElement.play().then(()=>{_.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(r=>{_.error(r)}),this.autoplayFailed=!1,rc()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};rc()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),PI()}}const bA=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class OA extends HE{constructor(e){super(e),L(this,"container",void 0),L(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const n=e.element;n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var n;null!==(n=this.container)&&void 0!==n&&n.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}getCurrentFrameToUint8Array(e){var n=arguments,r=()=>super.getCurrentFrameToUint8Array,i=this;return y(function*(){var o;let s=n.length>1&&void 0!==n[1]?n[1]:1;return null!==(o=i.container)&&void 0!==o&&o.contains(i.videoElement)?yield r().call(i,e,s):yield WE(e)})()}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",A("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if(null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var wA,NA,DA,PA,LA,kA,MA,UA,xA,VA,FA,BA,jA,GA,WA,HA,KA,YA,qA,zA,JA,XA,QA,ZA,_t,$A,tb,eb,nb,rb,ib,ob,sb,Hn;let Kt=(wA=et({argsMap:(t,e,n)=>[t.getTrackId(),"string"==typeof e?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),NA=ue(),DA=et({argsMap:t=>[t.getTrackId()]}),PA=Vs("LocalVideoTrack","_enabledMutex"),LA=et({argsMap:(t,e)=>[t.getTrackId(),e]}),kA=ue(),MA=Vs("LocalVideoTrack","_enabledMutex"),UA=et({argsMap:(t,e)=>[t.getTrackId(),e]}),xA=ue(),VA=et({argsMap:(t,e)=>[t.getTrackId(),e]}),FA=ue(),BA=ue(),jA=et({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),GA=ue(),WA=ue(),HA=ue(),KA=ue(),YA=ue(),qA=ue(),zA=ue(),JA=et({argsMap:(t,e)=>[t.getTrackId(),e.name]}),XA=et({argsMap:t=>[t.getTrackId()]}),QA=et({argsMap:t=>[t.getTrackId()]}),ZA=et({argsMap:(t,e,n)=>[t.getTrackId(),e.label,n]}),_t=class lN extends ra{get videoHeight(){if(Ge()){const{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(Ge()){const{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==tn.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,n,r,i,o,s){if(super(e,o),L(this,"trackMediaType",na.VIDEO),L(this,"_player",void 0),L(this,"isUseScaleResolutionDownBy",!1),L(this,"_videoVisibleTimer",null),L(this,"_previousVideoVisibleStatus",void 0),L(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),L(this,"_encoderConfig",void 0),L(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),L(this,"_optimizationMode",void 0),L(this,"_videoHeight",void 0),L(this,"_videoWidth",void 0),L(this,"_forceBitrateLimit",void 0),L(this,"_enabled",!0),L(this,"_processorDestination",void 0),L(this,"_processorContext",void 0),Ge()){const{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=n,this._scalabilityMode=r,this._optimizationMode=i,this._hints=s||[],-1===this._hints.indexOf(Bt.SCREEN_TRACK))this.updateBitrateFromProfile();else if(function(a){const u=Tt();return!(u.name!==a||!u.osVersion)&&115===Number(u.version)}(It.CHROME)&&-1!==Su().indexOf("Windows")){const a=function(c){if("VideoFrame"in window&&"TransformStream"in window&&St().supportWebRTCInsertableStream){const u=new MediaStreamTrackProcessor(c),l=new MediaStreamTrackGenerator({kind:"video"});let p,h,S=Date.now();const m=()=>{f&&(clearInterval(f),f=void 0),p&&(p.close(),p=void 0),c.stop(),h=void 0,l.removeEventListener("ended",m)};let f=window.setInterval(()=>{if(h&&p&&Date.now()-S>1e3)try{"live"===l.readyState?h.enqueue(p.clone()):m()}catch{m()}},1e3);const g=new TransformStream({transform:(R,C)=>{"live"===l.readyState?(h=C,S=Date.now(),void 0===p?(p=R,C.enqueue(R.clone())):(C.enqueue(p),p=R)):R.close()}});return l.addEventListener("ended",m),u.readable.pipeThrough(g).pipeTo(l.writable),l}}(e);a&&(_.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}n&&-1!==this._hints.indexOf(Bt.CUSTOM_TRACK)&&this.setEncoderConfiguration(n),this._processorContext=new MI(this.getTrackId(),"local"),this._processorDestination=new kI(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const i=document.getElementById(e);i?e=i:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const r=zt(zt(zt({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(r):(this._player=e instanceof HTMLVideoElement?new HE(r):new OA(r),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const i=this.getVideoElementVisibleStatus();this.safeEmit(ta.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}},A("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}setEnabled(e,n){var r=this;return y(function*(){if(!n){if(e===r._enabled)return;r.stateCheck("enabled",e)}if(_.info("[".concat(r.getTrackId(),"] start setEnabled"),e),!e){r._originMediaStreamTrack.enabled=!1;try{yield xt(r,Y.NEED_DISABLE_TRACK,r)}catch(i){throw _.error("[".concat(r.getTrackId(),"] setEnabled to false error"),i.toString()),i}return n||(r._enabled=!1),void _.info("[".concat(r.getTrackId(),"] setEnabled to false success"))}r._originMediaStreamTrack.enabled=!0;try{yield xt(r,Y.NEED_ENABLE_TRACK,r)}catch(i){throw _.error("[".concat(r.getTrackId(),"] setEnabled to true error"),i.toString()),i}_.info("[".concat(r.getTrackId(),"] setEnabled to true success")),n||(r._enabled=!0)})()}setMuted(e){var n=this;return y(function*(){e!==n._muted&&(n.stateCheck("muted",e),n._muted=e,n._originMediaStreamTrack.enabled=!e,_.debug("[".concat(n.getTrackId(),"] start set muted: ").concat(e)),e?yield xt(n,Y.NEED_MUTE_TRACK,n):yield xt(n,Y.NEED_UNMUTE_TRACK,n))})()}setEncoderConfiguration(e,n){var r=this;return y(function*(){if(!r._enabled)throw new P(v.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=ri(e),r._forceBitrateLimit&&(e.bitrateMax=r._forceBitrateLimit.max_bitrate?r._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=r._forceBitrateLimit.min_bitrate?r._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const i=Ju({encoderConfig:e});(Ge()||an()||pr())&&(i.deviceId=void 0),_.debug("[".concat(r.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{yield r._originMediaStreamTrack.applyConstraints(i),r.updateMediaStreamTrackResolution()}catch(o){const s=new P(v.UNEXPECTED_ERROR,o.toString());throw _.error("[".concat(r.getTrackId(),"] applyConstraints error"),s.toString()),s}}r._encoderConfig=e,-1===r._hints.indexOf(Bt.SCREEN_TRACK)&&r.updateBitrateFromProfile();try{yield xt(r,Y.NEED_UPDATE_VIDEO_ENCODER,r)}catch(i){return i.throw(_)}})()}getStats(){return Qi(()=>{_.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),$n(this,Y.GET_STATS)||zt({},DE)}setBeautyEffect(e){return y(function*(){_.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")})()}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}getCurrentFrameImage(e){var n=arguments,r=this;return y(function*(){return r._player?r._player.getCurrentFrameToUint8Array(e,n.length>1&&void 0!==n[1]?n[1]:1):yield WE(e)})()}setBitrateLimit(e){var n=this;return y(function*(){if(_.debug("[".concat(n.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){n._forceBitrateLimit=e,n._encoderConfig&&(n._encoderConfig.bitrateMax=n._encoderConfig.bitrateMax&&n._encoderConfig.bitrateMax<e.max_bitrate?n._encoderConfig.bitrateMax:e.max_bitrate,n._encoderConfig.bitrateMin=e.min_bitrate);try{yield xt(n,Y.NEED_UPDATE_VIDEO_ENCODER,n)}catch(r){return r.throw(_)}}})()}setOptimizationMode(e){var n=this;return y(function*(){if("motion"!==e&&"detail"!==e&&"balanced"!==e)return void _.error(v.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const r=n._optimizationMode;try{n._optimizationMode=e,yield xt(n,Y.NEED_UPDATE_VIDEO_SEND_PARAMETERS,n)}catch(i){throw n._optimizationMode=r,_.error("[".concat(n.getTrackId(),"] set optimization mode failed"),i.toString()),i}_.info("[".concat(n.getTrackId(),"] set optimization mode success (").concat(e,")"))})()}setScalabiltyMode(e){if(1===e.numSpatialLayers&&1!==e.numTemporalLayers)return _.error(v.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,_.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){VI(this._originMediaStreamTrack).then(e=>{let[n,r]=e;this._videoHeight=r,this._videoWidth=n}).catch(Au)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}setSenderConfiguration(e){var n=this;return y(function*(){if(!n._enabled)throw new P(v.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");_.debug("[".concat(n.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=ri(e),n._forceBitrateLimit&&(e.bitrateMax=n._forceBitrateLimit.max_bitrate?n._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=n._forceBitrateLimit.min_bitrate?n._forceBitrateLimit.min_bitrate:e.bitrateMin),n._encoderConfig=e,-1===n._hints.indexOf(Bt.SCREEN_TRACK)&&n.updateBitrateFromProfile();try{yield xt(n,Y.NEED_UPDATE_VIDEO_ENCODER,n)}catch(r){return r.throw(_)}})()}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:n,frameRate:r}=this.getMediaStreamTrackSettings();if(!e||!n||!r)return;const{bitrateMax:i,bitrateMin:o}=this._encoderConfig;if(null==o||null==i){const{max:s,min:a}=function(c,d,u,l,p){const h=A("BITRATE_ADAPTER_TYPE");if("DEFAULT_BITRATE"===h)return{min:l,max:p};if(void 0===p){var S;const f=Math.floor(200*Math.pow(u/15,.6)*Math.pow(c*d/640/360,.75));p="STANDARD_BITRATE"===h?4*f:2*f,l=null!==(S=l)&&void 0!==S?S:f}else{var m;l=null!==(m=l)&&void 0!==m?m:Math.floor(p/10)}return{min:l,max:p}}(e,n,r,o,i);this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=s,_.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(r,"] => [brMax: ").concat(s,", brMin: ").concat(a,"]"))}}getVideoElementVisibleStatus(){try{var e,n;const r=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),i={track:this,element:null==this||null===(n=this._player)||void 0===n?void 0:n.getVideoElement(),slot:r?.parentElement},{element:o,slot:s}=i;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){const a=qy.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;Q.reportApiInvoke(null,{tag:ne.TRACER,name:ye.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]}).onSuccess(c.visible?"Video is visible":"Invisible because of ".concat(c.reason))}return c}return}catch(r){throw new P(v.GET_VIDEO_ELEMENT_VISIBLE_ERROR,r.message)}}renewMediaStreamTrack(e){return y(function*(){})()}pipe(e){if(this.processor===e)return e;if(e._source)throw new P(v.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=this._encoderConfig;e&&(r=zt(zt({},r),ri(e))),r=Lo(r);const i=Ft(8,"track-video-cloned-"),o=new lN(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,r,Lo(this._scalabilityMode),this._optimizationMode,i,Lo(this._hints));return e&&r&&o.setEncoderConfiguration(r),_.debug("clone video track from ".concat(this.getTrackId()," to ").concat(i,", clone ").concat(n)),o}replaceTrack(e,n){var r=this;return y(function*(){if(!(e instanceof MediaStreamTrack))throw new P(v.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==e.kind)throw new P(v.INVALID_PARAMS,"track should be a video MediaStreamTrack");yield r._updateOriginMediaStreamTrack(e,n,!0),r.updateMediaStreamTrackResolution()})()}sendSeiData(e){if(Qi(()=>{Q.reportApiInvoke(null,{name:ye.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:ne.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!A("ENABLE_VIDEO_SEI")||!A("ENABLE_ENCODED_TRANSFORM"))return void _.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new P(v.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void _.warning("Video track is not published, SEI can not be send");const r=n.sender.getParameters();if(0===r.codecs.length)return;const i=r.codecs[0].mimeType.toLocaleLowerCase();"video/h264"===i?this.safeEmit("sei-to-send",e):_.warning("SEI is not supported by ".concat(i))}bindProcessorDestinationEvents(){var e=this;this.processorDestination.on(ln.ON_TRACK,function(){var n=y(function*(r){r?r!==e._mediaStreamTrack&&(e._mediaStreamTrack=r,e._updatePlayerSource(),yield xt(e,Y.NEED_REPLACE_TRACK,e)):e._mediaStreamTrack!==e._originMediaStreamTrack&&(e._mediaStreamTrack=e._originMediaStreamTrack,e._updatePlayerSource(),yield xt(e,Y.NEED_REPLACE_TRACK,e))});return function(r){return n.apply(this,arguments)}}())}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ln.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Fn.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Fn.REQUEST_CONSTRAINTS)}},gt(_t.prototype,"play",[wA,NA],Object.getOwnPropertyDescriptor(_t.prototype,"play"),_t.prototype),gt(_t.prototype,"stop",[DA],Object.getOwnPropertyDescriptor(_t.prototype,"stop"),_t.prototype),gt(_t.prototype,"setEnabled",[PA,LA,kA],Object.getOwnPropertyDescriptor(_t.prototype,"setEnabled"),_t.prototype),gt(_t.prototype,"setMuted",[MA,UA,xA],Object.getOwnPropertyDescriptor(_t.prototype,"setMuted"),_t.prototype),gt(_t.prototype,"setEncoderConfiguration",[VA,FA],Object.getOwnPropertyDescriptor(_t.prototype,"setEncoderConfiguration"),_t.prototype),gt(_t.prototype,"getStats",[BA],Object.getOwnPropertyDescriptor(_t.prototype,"getStats"),_t.prototype),gt(_t.prototype,"setBeautyEffect",[jA,GA],Object.getOwnPropertyDescriptor(_t.prototype,"setBeautyEffect"),_t.prototype),gt(_t.prototype,"getCurrentFrameData",[WA],Object.getOwnPropertyDescriptor(_t.prototype,"getCurrentFrameData"),_t.prototype),gt(_t.prototype,"getCurrentFrameImage",[HA],Object.getOwnPropertyDescriptor(_t.prototype,"getCurrentFrameImage"),_t.prototype),gt(_t.prototype,"setBitrateLimit",[KA],Object.getOwnPropertyDescriptor(_t.prototype,"setBitrateLimit"),_t.prototype),gt(_t.prototype,"setOptimizationMode",[YA],Object.getOwnPropertyDescriptor(_t.prototype,"setOptimizationMode"),_t.prototype),gt(_t.prototype,"setScalabiltyMode",[qA],Object.getOwnPropertyDescriptor(_t.prototype,"setScalabiltyMode"),_t.prototype),gt(_t.prototype,"updateMediaStreamTrackResolution",[zA],Object.getOwnPropertyDescriptor(_t.prototype,"updateMediaStreamTrackResolution"),_t.prototype),gt(_t.prototype,"pipe",[JA],Object.getOwnPropertyDescriptor(_t.prototype,"pipe"),_t.prototype),gt(_t.prototype,"unpipe",[XA],Object.getOwnPropertyDescriptor(_t.prototype,"unpipe"),_t.prototype),gt(_t.prototype,"close",[QA],Object.getOwnPropertyDescriptor(_t.prototype,"close"),_t.prototype),gt(_t.prototype,"replaceTrack",[ZA],Object.getOwnPropertyDescriptor(_t.prototype,"replaceTrack"),_t.prototype),_t),KE=($A=et({argsMap:(t,e)=>[t.getTrackId(),e]}),tb=ue(),eb=Vs("CameraVideoTrack","_enabledMutex"),nb=et({argsMap:(t,e)=>[t.getTrackId(),e]}),rb=ue(),ib=et({argsMap:(t,e)=>[t.getTrackId(),e]}),ob=ue(),sb=et({argsMap:t=>[t.getTrackId()]}),Hn=class pN extends Kt{get __className__(){return"CameraVideoTrack"}constructor(e,n,r,i,o,s){var a;super(e,ri(n.encoderConfig),i,o,s),a=this,L(this,"_config",void 0),L(this,"_originalConstraints",void 0),L(this,"_constraints",void 0),L(this,"_enabled",!0),L(this,"_deviceName","default"),L(this,"tryResumeVideoForIOS15_16WeChat",y(function*(){(ks()||w_())&&!function(){const c=Tt();if(c.os!==we.IOS||!c.osVersion)return!1;const d=c.osVersion.split(".");return 15===Number(d[0])&&Number(d[1])>=2}()&&Wy()&&a._enabled&&!a._isClosed&&(_.debug("[".concat(a.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),yield a.renewMediaStreamTrack())})),this._config=n,this._originalConstraints=r,this._constraints=r,this._deviceName=e.label,this._encoderConfig=ri(this._config.encoderConfig),Dt.on(Ve.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Dt.on(Ve.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}setDevice(e){var n=this;return y(function*(){return"string"==typeof e?n._setDeviceById(e):e.deviceId?n._setDeviceById(e.deviceId):e.facingMode?n._setDeviceByFacingModel(e.facingMode):void 0})()}_setDeviceById(e){var n=this;return y(function*(){if(_.info("[".concat(n.getTrackId(),"] set device to ").concat(e)),n._enabled)try{const r=yield Gn.getDeviceById(e),i={};i.video=zt({},n._constraints),i.video.deviceId={exact:e},i.video.facingMode=void 0,n._originMediaStreamTrack.stop();let o=null;try{o=yield jn(i,n.getTrackId())}catch(s){throw _.error("[".concat(n.getTrackId(),"] setDevice failed"),s.toString()),o=yield jn({video:n._constraints},n.getTrackId()),yield n._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1),s}yield n._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!1),n.updateMediaStreamTrackResolution(),n._deviceName=r.label,n._config.cameraId=e,n._constraints.deviceId={exact:e}}catch(r){throw _.error("[".concat(n.getTrackId(),"] setDevice error"),r.toString()),r}else try{const r=yield Gn.getDeviceById(e);n._deviceName=r.label,n._config.cameraId=e,n._constraints.deviceId={exact:e}}catch(r){throw _.error("[".concat(n.getTrackId(),"] setDevice error"),r.toString()),r}_.info("[".concat(n.getTrackId(),"] setDevice success"))})()}_setDeviceByFacingModel(e){var n=this;return y(function*(){_.info("[".concat(n.getTrackId(),"] set facingMode ").concat(e));const r={video:zt(zt({},n._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(n._enabled){n._originMediaStreamTrack.stop();let i=null;try{i=yield jn(r,n.getTrackId())}catch(o){throw _.error("[".concat(n.getTrackId(),"] setDeviceByFacingModel failed"),o.toString()),i=yield jn({video:n._constraints},n.getTrackId()),yield n._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),o}yield n._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),n.updateMediaStreamTrackResolution()}n._deviceName="",n._config.facingMode=e,n._config.cameraId=void 0,n._constraints=zt({},r.video),_.info("[".concat(n.getTrackId(),"] setDeviceByFacingModel success"))})()}setEnabled(e,n){var r=this;return y(function*(){if(!n){if(e===r._enabled)return;r.stateCheck("enabled",e)}if(_.info("[".concat(r.getTrackId(),"] start setEnabled"),e),e){try{if(r.isExternalTrack)r._originMediaStreamTrack.enabled=!0;else{const i=yield jn({video:r._constraints},r.getTrackId());yield r._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}yield xt(r,Y.NEED_ENABLE_TRACK,r)}catch(i){throw _.error("[".concat(r.getTrackId(),"] setEnabled true error"),i.toString()),i}r.updateMediaStreamTrackResolution(),_.info("[".concat(r.getTrackId(),"] setEnabled to true success")),n||(r._enabled=!0)}else{r.isExternalTrack?r._originMediaStreamTrack.enabled=!1:(r._originMediaStreamTrack.onended=null,r._originMediaStreamTrack.stop()),n||(r._enabled=!1);try{yield xt(r,Y.NEED_DISABLE_TRACK,r)}catch(i){throw _.error("[".concat(r.getTrackId(),"] setEnabled to false error"),i.toString()),i}_.info("[".concat(r.getTrackId(),"] setEnabled to false success"))}})()}setEncoderConfiguration(e,n){var r=this;return y(function*(){if(!r._enabled)throw new P(v.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e=ri(e),r._forceBitrateLimit&&(e.bitrateMax=r._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=r._forceBitrateLimit.min_bitrate||e.bitrateMin);const i=ae(r._config);i.encoderConfig=e;const o=Ju(i);(Ge()||an()||pr())&&(o.deviceId=void 0),_.debug("[".concat(r.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(o));try{yield r._originMediaStreamTrack.applyConstraints(o),r.updateMediaStreamTrackResolution()}catch(s){const a=new P(v.UNEXPECTED_ERROR,s.toString());throw _.error("[".concat(r.getTrackId(),"] applyConstraints error"),a.toString()),a}r._config=i,r._constraints=o,r._originalConstraints=o,r._encoderConfig=e,-1===r._hints.indexOf(Bt.SCREEN_TRACK)&&r.updateBitrateFromProfile();try{yield xt(r,Y.NEED_UPDATE_VIDEO_ENCODER,r)}catch(s){return s.throw(_)}})()}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){var e=this;if((an()||pr())&&this._enabled&&!this._isClosed&&Dt.duringInterruption){const n=function(){var r=y(function*(){Dt.off(Ve.IOS_INTERRUPTION_END,n),e._enabled&&!e._isClosed&&(_.debug("[".concat(e.getTrackId(),"] try capture camera media device for interrupted iOS device.")),yield e.setEnabled(!1),yield e.setEnabled(!0))});return function(){return r.apply(this,arguments)}}();Dt.on(Ve.IOS_INTERRUPTION_END,n)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ta.TRACK_ENDED)}renewMediaStreamTrack(e){var n=this;return y(function*(){const r=e||n._constraints,i=Gn.searchDeviceIdByName(n._deviceName);if(i&&!r.deviceId&&(r.deviceId={exact:i}),n._enabled){const o=yield jn({video:r},n.getTrackId());n._constraints=r,yield n._updateOriginMediaStreamTrack(o.getVideoTracks()[0],!0),n.updateMediaStreamTrackResolution()}})()}close(){super.close(),Dt.off(Ve.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Dt.off(Ve.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=this._encoderConfig;e&&(r=zt(zt({},r),ri(e))),r=Lo(r);const i=Ft(8,"track-cam-cloned-"),o=new pN(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,Lo(zt(zt({},this._config),{},{encoderConfig:r})),Lo(this._constraints),Lo(this._scalabilityMode),this._optimizationMode,i);return e&&r&&o.setEncoderConfiguration(r),_.debug("clone track from ".concat(this.getTrackId()," to ").concat(i,", clone ").concat(n)),o}bindProcessorContextEvents(){var e=this;this.processorContext.on(Fn.REQUEST_UPDATE_CONSTRAINTS,function(){var n=y(function*(r,i,o){try{const s=Object.assign({},e._originalConstraints,...r);yield e.renewMediaStreamTrack(s),i()}catch(s){o(s)}});return function(r,i,o){return n.apply(this,arguments)}}()),this.processorContext.on(Fn.REQUEST_CONSTRAINTS,function(){var n=y(function*(r){r(e._originMediaStreamTrack.getSettings())});return function(r){return n.apply(this,arguments)}}())}},gt(Hn.prototype,"setDevice",[$A,tb],Object.getOwnPropertyDescriptor(Hn.prototype,"setDevice"),Hn.prototype),gt(Hn.prototype,"setEnabled",[eb,nb,rb],Object.getOwnPropertyDescriptor(Hn.prototype,"setEnabled"),Hn.prototype),gt(Hn.prototype,"setEncoderConfiguration",[ib,ob],Object.getOwnPropertyDescriptor(Hn.prototype,"setEncoderConfiguration"),Hn.prototype),gt(Hn.prototype,"close",[sb],Object.getOwnPropertyDescriptor(Hn.prototype,"close"),Hn.prototype),Hn);function YE(t,e,n,r){n.optimizationMode&&(r&&r.width&&r.height?(n.encoderConfig=zt(zt({},r),{},{bitrateMin:r.bitrateMin,bitrateMax:r.bitrateMax}),"motion"!==n.optimizationMode&&"detail"!==n.optimizationMode||(e.contentHint=n.optimizationMode,e.contentHint===n.optimizationMode?_.debug("[".concat(t,"] set content hint to"),n.optimizationMode):_.debug("[".concat(t,"] set content hint failed")))):_.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}var ab,cb,db,ub,rr,lb,pb,hb,_b,Eb,mb,en;class fb extends yI{getUserId(){return this._userId}constructor(e,n,r,i){super(e,"track-".concat(e.kind,"-").concat(n,"-").concat(i.clientId,"_").concat(Ft(5,""))),L(this,"_userId",void 0),L(this,"_uintId",void 0),L(this,"_isDestroyed",!1),L(this,"store",void 0),L(this,"processor",void 0),L(this,"processorContext",void 0),this._userId=n,this._uintId=r,this.store=i}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,_.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let sa=(ab=et({argsMap:(t,e,n)=>[t.getTrackId(),"string"==typeof e?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),cb=et({argsMap:t=>[t.getTrackId()]}),db=et({argsMap:(t,e)=>[t.getTrackId(),e.name]}),ub=et({argsMap:t=>[t.getTrackId()]}),gt((rr=class extends fb{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==tn.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,n,r){super(t,e,n,r),L(this,"_videoVisibleTimer",null),L(this,"_previousVideoVisibleStatus",void 0),L(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),L(this,"trackMediaType",na.VIDEO),L(this,"_videoWidth",void 0),L(this,"_videoHeight",void 0),L(this,"_player",void 0),L(this,"processorDestination",void 0),L(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new MI(this.getTrackId(),"remote"),this.processorDestination=new kI(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Qi(()=>{_.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),$n(this,Y.GET_STATS)||zt({},RI)}play(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t){const r=document.getElementById(t);r?t=r:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const n=zt(zt({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(n):(this._player=t instanceof HTMLVideoElement?new HE(n):new OA(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(ea.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=r=>{this.safeEmit(ea.VIDEO_STATE_CHANGED,r)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(ea.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},A("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){VI(this._originMediaStreamTrack).then(t=>{let[e,n]=t;this._videoHeight=n,this._videoWidth=e}).catch(Au)}_updatePlayerSource(){_.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const n=null==this||null===(t=this._player)||void 0===t?void 0:t.getContainerElement(),r={track:this,element:null==this||null===(e=this._player)||void 0===e?void 0:e.getVideoElement(),slot:n?.parentElement},{element:i,slot:o}=r;if(this.isPlaying&&i instanceof HTMLVideoElement&&o instanceof HTMLElement){const s=qy.checkOneElementVisible(i),a=Object.assign({},s);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;Q.reportApiInvoke(null,{tag:ne.TRACER,name:ye.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]}).onSuccess(a.visible?"Video is visible":"Invisible because of ".concat(a.reason))}return a}return}catch(n){throw new P(v.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new P(v.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){var t=this;this.processorDestination.on(ln.ON_TRACK,function(){var e=y(function*(n){n?n!==t._mediaStreamTrack&&(t._mediaStreamTrack=n,t._updatePlayerSource()):t._mediaStreamTrack!==t._originMediaStreamTrack&&(t._mediaStreamTrack=t._originMediaStreamTrack,t._updatePlayerSource())});return function(n){return e.apply(this,arguments)}}())}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ln.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(t){this.emit(jo.SEI_RECEIVED,t)}}).prototype,"play",[ab],Object.getOwnPropertyDescriptor(rr.prototype,"play"),rr.prototype),gt(rr.prototype,"stop",[cb],Object.getOwnPropertyDescriptor(rr.prototype,"stop"),rr.prototype),gt(rr.prototype,"pipe",[db],Object.getOwnPropertyDescriptor(rr.prototype,"pipe"),rr.prototype),gt(rr.prototype,"unpipe",[ub],Object.getOwnPropertyDescriptor(rr.prototype,"unpipe"),rr.prototype),rr),aa=(lb=et({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),pb=et({argsMap:(t,e)=>[t.getTrackId(),e]}),hb=et({argsMap:t=>[t.getTrackId()]}),_b=et({argsMap:t=>[t.getTrackId()]}),Eb=et({argsMap:(t,e)=>[t.getTrackId(),e.name]}),mb=et({argsMap:t=>[t.getTrackId()]}),gt((en=class extends fb{get isPlaying(){return this._useAudioElement?_n.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,n,r){super(t,e,n,r),L(this,"trackMediaType",na.AUDIO),L(this,"_source",void 0),L(this,"_useAudioElement",!0),L(this,"_volume",100),L(this,"processorContext",void 0),L(this,"processorDestination",void 0),L(this,"_played",!1),L(this,"_bypassWebAudio",!1),A("DISABLE_WEBAUDIO")?(this._source=new GE,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new bI(t,!0),A("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Vn.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(ea.FIRST_FRAME_DECODED)}),this.processorContext=new xI(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new UI(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Vn.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!t)return this._source.removeAllListeners(Vn.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(Vn.ON_AUDIO_BUFFER),this._source.on(Vn.ON_AUDIO_BUFFER,n=>t(n))}setVolume(t){this._volume=t,this._useAudioElement?_n.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}setPlaybackDevice(t){var e=this;return y(function*(){if(!e._useAudioElement||!fI())throw new P(v.NOT_SUPPORTED,"your browser does not support setting the audio output device");yield _n.setSinkID(e.getTrackId(),t)})()}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Qi(()=>{_.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),$n(this,Y.GET_STATS)||zt({},SI)}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] use audio element to play")),_n.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?_n.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&_n.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new P(v.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new P(v.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new P(v.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;null===(t=this._source.processSourceNode)||void 0===t||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){var t=this;this.processorDestination.on(ln.ON_TRACK,function(){var e=y(function*(n){n?n!==t._mediaStreamTrack&&(t._mediaStreamTrack=n,t._updatePlayerSource(!1),t._source.processedNode=t._source.createMediaStreamSourceNode(n)):t._mediaStreamTrack!==t._originMediaStreamTrack&&(t._mediaStreamTrack=t._originMediaStreamTrack,t._updatePlayerSource())});return function(n){return e.apply(this,arguments)}}()),this.processorDestination.on(ln.ON_NODE,e=>{this._source.processedNode=e;const n=!e;this._useAudioElement!==n&&(this._played?(this.stop(),this._useAudioElement=n,this.play()):this._useAudioElement=n)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ln.ON_TRACK),this.processorDestination.removeAllListeners(ln.ON_NODE)}}).prototype,"setVolume",[lb],Object.getOwnPropertyDescriptor(en.prototype,"setVolume"),en.prototype),gt(en.prototype,"setPlaybackDevice",[pb],Object.getOwnPropertyDescriptor(en.prototype,"setPlaybackDevice"),en.prototype),gt(en.prototype,"play",[hb],Object.getOwnPropertyDescriptor(en.prototype,"play"),en.prototype),gt(en.prototype,"stop",[_b],Object.getOwnPropertyDescriptor(en.prototype,"stop"),en.prototype),gt(en.prototype,"pipe",[Eb],Object.getOwnPropertyDescriptor(en.prototype,"pipe"),en.prototype),gt(en.prototype,"unpipe",[mb],Object.getOwnPropertyDescriptor(en.prototype,"unpipe"),en.prototype),en);const bi=new class extends Zt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),L(this,"_lastHiddenTime",0),L(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),_.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};class gb extends Zt{constructor(e,n){super(),L(this,"trackMediaType",na.DATA),L(this,"_version",1),L(this,"_type",3),L(this,"_config",void 0),L(this,"_originDataChannel",void 0),L(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),L(this,"_dataStreamPacketHandler",{serialize:r=>r,deserialize:r=>r}),L(this,"_datachannelEventMap",new Map),this._config=e,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader()}useDataStream(e){this._dataStreamPacketHandler=e}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return A("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,n;return null!==(e=null===(n=this._originDataChannel)||void 0===n?void 0:n.readyState)&&void 0!==e?e:"connecting"}get _originDataChannelId(){var e,n;return null!==(e=null===(n=this._originDataChannel)||void 0===n?void 0:n.id)&&void 0!==e?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}_waitTillOpen(){var e=this;return y(function*(){return new H((n,r)=>{if(e._originDataChannel){"open"===e._originDataChannel.readyState&&n();const i=setTimeout(()=>{var o;r(new P(v.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat(null===(o=e._originDataChannel)||void 0===o?void 0:o.id)))},1e4);e._originDataChannel.onopen=()=>{clearTimeout(i),e._originDataChannel&&e._bandDataChannelEvents(e._originDataChannel),n()},e._originDataChannel.onerror=()=>{throw clearTimeout(i),new P(v.DATACHANNEL_CONNECTION_TIMEOUT)}}else r(new P(v.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})})()}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[qu.OPEN,qu.CLOSE,qu.ERROR].forEach(n=>{const r=()=>{this.emit(n)};this._datachannelEventMap.set(n,r),e.addEventListener(n,r)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(n=>{let[r,i]=n;e.removeEventListener(r,i)}),this._datachannelEventMap.clear()}}class R3 extends gb{constructor(e){super(e),L(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const r=n.data.slice(0,this._dataStreamPacketHeader.byteLength),i=new DataView(r).getUint8(3);if(i!==this.id)return void(A("SHOW_DATASTREAM2_LOG")&&_.debug("invalid datachannel id: ".concat(i," !== ").concat(this.id)));let o=n.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit(qu.MESSAGE,o)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class v3 extends gb{send(e){if(this._originDataChannel){let n=e;n=this._dataStreamPacketHandler.serialize(e);const r=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);r.set(new Uint8Array(this._dataStreamPacketHeader),0),r.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(r.buffer)}}}function Qu(){const t=new Blob([atob("ZnVuY3Rpb24gZShlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLGE9W10sbz0wO2Zvcig7YS5sZW5ndGg8bjspbyszPG4mJjA9PT1yW29dJiYwPT09cltvKzFdJiYzPT09cltvKzJdJiYoMD09PXJbbyszXXx8MT09PXJbbyszXXx8Mj09PXJbbyszXXx8Mz09PXJbbyszXSk/KGEucHVzaChyW29dLHJbbysxXSxyW28rM10pLG8rPTQpOihhLnB1c2gocltvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYSl9ZnVuY3Rpb24gdChlLHQpe2NvbnN0IG49ZnVuY3Rpb24oZSl7Y29uc3QgdD1lLmxlbmd0aDtsZXQgbj1bXSxyPTA7Zm9yKDtyPHQ7KXIrMjx0JiYwPT09ZVtyXSYmMD09PWVbcisxXSYmKDA9PT1lW3IrMl18fDE9PT1lW3IrMl18fDI9PT1lW3IrMl18fDM9PT1lW3IrMl0pPyhuLnB1c2goZVtyXSxlW3IrMV0sMyxlW3IrMl0pLHIrPTMpOihuLnB1c2goZVtyXSkscisrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobil9KHQpLHI9bi5sZW5ndGgsYT1NYXRoLmZsb29yKHIvMjU1KSxvPXIlMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNithKzErcitlLmJ5dGVMZW5ndGgpO3NbMF09MCxzWzFdPTAsc1syXT0wLHNbM109MSxzWzRdPTYsc1s1XT0xMDE7bGV0IGk9MDtmb3IoO2k8YTspc1s2K2ldPTI1NSxpKys7cmV0dXJuIHNbNitpXT1vLGkrKyxzLnNldChuLDYraSkscy5zZXQobmV3IFVpbnQ4QXJyYXkoZSksNitpK3IpLHMuYnVmZmVyfW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiU2FmYXJpIik+LTEmJi0xPT09bmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJDaHJvbWUiKSYmKHNlbGYub25ydGN0cmFuc2Zvcm09bj0+e2NvbnN0IHI9bi50cmFuc2Zvcm1lcjtsZXQgYT1bXTtyLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9ZT0+e2UuZGF0YS5zZWkmJmEucHVzaChlLmRhdGEuc2VpKX0sc2VsZi5wb3N0TWVzc2FnZSgic3RhcnRlZCIpO2NvbnN0IG89ci5yZWFkYWJsZS5nZXRSZWFkZXIoKSxzPXIud3JpdGFibGUuZ2V0V3JpdGVyKCk7InJ4Ij09PXIub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQobil7by5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1mdW5jdGlvbih0KXtjb25zdCBuPW5ldyBEYXRhVmlldyh0LmRhdGEpO2xldCByPTA7Zm9yKDtyKzQ8dC5kYXRhLmJ5dGVMZW5ndGg7KXtpZigwPT09bi5nZXRVaW50OChyKzApJiYwPT09bi5nZXRVaW50OChyKzEpJiYwPT09bi5nZXRVaW50OChyKzIpJiYxPT09bi5nZXRVaW50OChyKzMpJiY2PT09bi5nZXRVaW50OChyKzQpKXtsZXQgYT1yKzYsbz0wLHM9MDtmb3IoOzI1NT09PShzPW4uZ2V0VWludDgoYSsrKSk7KW8rPTI1NTtvKz1zO2NvbnN0IGk9ZSh0LmRhdGEsYSxvKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkoaSl9cisrfXJldHVybiBudWxsfShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7by5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1hLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>mI.revokeObjectURL(t),0),new Worker(mI.createObjectURL(t))}const Zu=new Map,$u=new Map;function y3(t,e,n){let r=new Uint8Array(t,e,n),i=[],o=0;for(;i.length<n;)o+3<n&&0===r[o]&&0===r[o+1]&&3===r[o+2]&&(0===r[o+3]||1===r[o+3]||2===r[o+3]||3===r[o+3])?(i.push(r[o],r[o+1],r[o+3]),o+=4):(i.push(r[o]),o++);return new Uint8Array(i)}const tl=new Map;function qE(){return qE=y(function*(t,e){if(!St().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(tl.has(t)||!t.track)return;const n={track:t.track};if(Ji()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let i=null;try{i=t.createEncodedStreams()}catch(a){return void _.error("create video-encoded-streams error",a&&a.message)}let o=[];e.on("sei-to-send",a=>{o.push(a)});const s=new TransformStream({transform(a,c){n.controller||(n.controller=c),t.track&&t.track.id!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r));const d=o.shift();d&&(a.data=function(u,l){const p=function(R){const C=R.length;let b=[],w=0;for(;w<C;)w+2<C&&0===R[w]&&0===R[w+1]&&(0===R[w+2]||1===R[w+2]||2===R[w+2]||3===R[w+2])?(b.push(R[w],R[w+1],3,R[w+2]),w+=3):(b.push(R[w]),w++);return new Uint8Array(b)}(l),h=p.length,S=Math.floor(h/255),m=h%255,f=new Uint8Array(6+S+1+h+u.byteLength);f[0]=0,f[1]=0,f[2]=0,f[3]=1,f[4]=6,f[5]=101;let g=0;for(;g<S;)f[6+g]=255,g++;return f[6+g]=m,g++,f.set(p,6+g),f.set(new Uint8Array(u),6+g+h),f.buffer}(a.data,d)),c.enqueue(a)}});i.readable.pipeThrough(s).pipeTo(i.writable)}else{if(!Ge())return;{if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const i=Qu(),o=new MessageChannel;yield new H(a=>i.onmessage=c=>{"registered"===c.data&&a(void 0)});const s=new RTCRtpScriptTransform(i,{name:"tx",port:o.port2},[o.port2]);t.transform=s,yield new H(a=>i.onmessage=c=>{"started"===c.data&&a(void 0)}),e.on("sei-to-send",a=>{o.port1.postMessage({sei:a})}),o.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&(null===(c=t.track)||void 0===c?void 0:c.id)!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r))},n.worker=i}}function r(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",r)}const i=tl.get(t);if(i){tl.delete(t);try{var o,s;null===(o=i.controller)||void 0===o||o.terminate(),null===(s=i.worker)||void 0===s||s.terminate()}catch(a){_.warning(a&&a.message)}}}tl.set(t,n),t.track.addEventListener("ended",r)}),qE.apply(this,arguments)}const gc=new Map;!function(){const t=Tt();xe.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),xe.getStreamFromExtension=t.name===It.CHROME&&Number(t.version)>34,xe.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let n=!1;try{e.addTransceiver("audio"),n=!0}catch{}return e.close(),n}(),xe.supportMinBitrate=t.name===It.CHROME||t.name===It.EDGE,xe.supportSetRtpSenderParameters=function(){const e=Tt();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Xi()||!(!Ge()&&!Ru())||e.name===It.FIREFOX&&Number(e.version)>=64)}(),t.name===It.SAFARI&&(xe.supportDualStream=Number(t.version)>=14),xe.webAudioMediaStreamDest=function(){const e=Tt();return!(e.name===It.SAFARI&&Number(e.version)<12)}(),xe.supportReplaceTrack=!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack,xe.supportWebGL=typeof WebGLRenderingContext<"u",xe.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Xi()||(xe.webAudioWithAEC=!0),xe.supportShareAudio=function(){const e=Tt();return(e.os===we.WIN_10||e.os===we.WIN_81||e.os===we.WIN_7||e.os===we.LINUX||e.os===we.MAC_OS||e.os===we.CHROMIUM_OS)&&e.name===It.CHROME&&Number(e.version)>=74}(),xe.supportDataChannel=!!(O_(76)||function(){const n=Tt();return!(n.name!==It.FIREFOX||!n.osVersion)&&Number(n.version)>=68}()||xy(14)),xe.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!ee()&&!!e&&e.prototype.setConfiguration instanceof Function}(),xe.supportWebRTCEncodedTransform=function(){const e=Tt();return"Chrome"===e.name&&Number(e.version)>=86||"Safari"===e.name&&Number(e.version)>=15}(),xe.supportWebRTCInsertableStream=function(){const e=Tt();return(e.name===It.CHROME||e.name===It.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),xe.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,xe.supportWebCrypto=typeof window<"u"&&void 0!==window.crypto&&void 0!==window.crypto.subtle,Iu(()=>{xe.supportDualStreamEncoding=function(){const e=Tt();return!!A("DISABLE_WEBAUDIO")||"Safari"===e.name&&Number(e.version)>=14||!!("Chrome"===e.name&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&A("CHROME_DUAL_STREAM_USE_ENCODING"))}(),_.debug("browser ua: ",navigator.userAgent),_.info("browser info: ",t),_.info("browser compatibility: ",xe)})}();class Ho extends Zt{constructor(e,n){super(),T(this,"signal",void 0),T(this,"token",void 0),T(this,"tokenTimeout",void 0),T(this,"tokenInterval",void 0),T(this,"_sequence",0),T(this,"userMap",new Map),T(this,"encoder",new TextEncoder),this.signal=e,this.token=n;const r=()=>{this.signal.connectionState===jt.CONNECTED&&this.check(),this.tokenInterval=0===this.userMap.size?window.setTimeout(r,1e3):window.setTimeout(r,3*A("P2P_TOKEN_INTERVAL"))};r()}send(e,n,r,i,o){var s=this;return y(function*(){var a,c,d;if(0===s.userMap.size)return;const u=Array.from(Ci(a=s.userMap).call(a))[0].token;"string"!=typeof n&&(n=JSON.stringify(n)),i=null!==(c=i)&&void 0!==c?c:Ft(6,""),o=null!==(d=o)&&void 0!==d?d:s._sequence++;const l={_id:i,_type:e,_seq:o,_message:n,token:"".concat(s.token,"_").concat(u)};A("SHOW_P2P_LOG")&&_.debug("send message",l,"noNeedResponse : ".concat(r)),s.splitMessage(JSON.stringify(l)).forEach(h=>{s.signal.request(it.DATA_STREAM,{payload:Zi(s.encoder.encode(h))})});const p=new H((h,S)=>{const m=window.setTimeout(()=>{s.off("res-@".concat(i,"_ack"),f),s.off("res-@".concat(i),R),s.off(Gs.ABORT,g),_.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(i)),S(new P(0===s.userMap.size?v.INVALID_REMOTE_USER:v.TIMEOUT))},A("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),f=()=>{m&&window.clearTimeout(m),s.off(Gs.ABORT,g),r&&h()},g=()=>{m&&window.clearTimeout(m),s.off("res-@".concat(i,"_ack"),f),s.off("res-@".concat(i),R),S(new P(v.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(i)))};s.once(Gs.ABORT,g),s.once("res-@".concat(i,"_ack"),f);const R=(b,w)=>{C=!0,m&&window.clearTimeout(m),s.off("res-@".concat(i,"_ack"),f),s.off(Gs.ABORT,g),"success"===b?h(w):S(new P(v.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(i)))};let C=!1;r||(s.once("res-@".concat(i),R),Me(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{C||_.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(i,", ").concat(l))}))});try{return yield p}catch(h){if(h.code===v.TIMEOUT)return yield s.send(e,n,r,i,o);throw h}})()}onMessage(e){var n;const{_uid:r}=e;let i,o=this.userMap.get(r);if(o)i=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==de.CHECK)return;const{token:d}=e;i=new Map,o={uid:r,isStart:!0,token:d,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(r,o),this.signal.emit(pt.ON_USER_ONLINE,{uid:r}),this.handleUserOnline()}if("id"in e&&"total"in e){var s;const{id:d,total:u}=e,l=null!==(s=i.get(d))&&void 0!==s?s:[];if(l.push(e),i.has(d)||i.set(d,l),l.length!==u)return;{const p=Ga(l).call(l,(h,S)=>h.index-S.index).map(h=>h.payload).join("");i.delete(d),(e=JSON.parse(p))._uid=r}}const{_type:a,token:c}=e;if(W(n=[de.ACK,de.CHECK]).call(n,a))return a===de.CHECK&&this.handleCheckToken(o,c),void this.receiveMessage(e);c==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(e):_.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(o.token,"_").concat(this.token),e)}check(){const e={_id:Ft(6,""),token:this.token,_type:de.CHECK};A("SHOW_P2P_LOG")&&_.debug("send message",e),this.signal.request(it.DATA_STREAM,{payload:Zi(this.encoder.encode(JSON.stringify(e)))})}ack(e){const n={_id:e,_type:de.ACK,token:this.token};A("SHOW_P2P_LOG")&&_.debug("send message",n),this.signal.request(it.DATA_STREAM,{payload:Zi(this.encoder.encode(JSON.stringify(n)))})}response(e,n,r){this.send(de.RESPONSE,JSON.stringify({success:!r,message:n}),!0,e)}handleReceivedMessage(e){const n=()=>{this.userMap.forEach(d=>{const{receivedMessagesMap:u,nextExpectedSequenceNumber:l}=d;for(;u.has(l);){const p=u.get(l);u.delete(l),this.receiveMessage(p),d.nextExpectedSequenceNumber++}})};if(!e)return void n();const{_uid:r,_seq:i}=e,o=this.userMap.get(r),{receivedMessagesMap:s,isStart:a,nextExpectedSequenceNumber:c}=o;if(i<c)return this.ack(e._id),void _.debug("[external-signal] receive old message, seq: ".concat(i,", ").concat(e._message));s.set(i,e),a&&i===c&&(this.receiveMessage(e),s.delete(c),o.nextExpectedSequenceNumber++,n())}receiveMessage(e){const{_id:n,_type:r,_message:i,_uid:o}=e;if(A("SHOW_P2P_LOG")&&_.debug("receive message",e),n){let s;switch(e._type!==de.ACK&&(i&&(s=JSON.parse(i)),this.ack(e._id)),e._type){case de.CANDIDATE:case de.CONTROL:this.signal.emit(r,s,o);break;case de.PUBLISH:case de.UNPUBLISH:case de.RESTART_ICE:case de.CALL:s.uid=o,He(this.signal,r,s).then(a=>{this.response(e._id,a)}).catch(()=>{this.response(e._id,void 0,!0)});break;case de.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case de.RESPONSE:{const{success:a,message:c}=s;this.emit("res-@".concat(n),a?"success":"failed",c);break}}}}splitMessage(e){if(e.length<Ho.MAX_MESSAGE_SIZE)return[e];const n=[],{remoteToken:r}=JSON.parse(e),i=Ft(6,"");let o=0,s=800;const a=Math.ceil(e.length/s);for(;e.length>0;){o++;const c={id:i,index:o,total:a,payload:e.slice(0,s),token:"".concat(this.token,"_").concat(r)};JSON.stringify(c).length>Ho.MAX_MESSAGE_SIZE?s-=50:(n.push(c),e=e.slice(s))}return n.map(c=>JSON.stringify(c))}handleCheckToken(e,n){return e.token!==n?(_.debug("token changed, from ".concat(e.token," to ").concat(n)),this.reset(e.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{_.debug("token timeout, ".concat(n)),this.reset(e.uid)},A("MAX_P2P_TIMEOUT")),!0)}handleUserOnline(){var e=this;return y(function*(){const n=yield He(e.signal,de.CALL,void 0),r=yield e.send(de.CALL,n);e.signal.emit(ot.P2P_CONNECTION,r,!0)})()}reset(e,n){var r=this;return y(function*(){const i=r.userMap.get(e);i&&(r.emit(Gs.ABORT),r.signal.emit(pt.ON_USER_OFFLINE,{uid:i.uid,reason:Bj.P2P_TOKEN_CHANGED}),r._sequence=0,r.userMap.clear(),n||(_.debug("change local token from ".concat(n," to ").concat(n)),r.token=Ft(6,"")))})()}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Gs.ABORT)}}T(Ho,"MAX_SIZE",1),T(Ho,"MAX_MESSAGE_SIZE",1024);class Tb extends Zt{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===jt.CONNECTED?this.emit(ot.WS_CONNECTED):e===jt.RECONNECTING?this.emit(ot.WS_RECONNECTING,this._websocketReconnectReason):e===jt.CLOSED&&this.emit(ot.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),T(this,"_disconnectedReason",void 0),T(this,"_websocketReconnectReason",void 0),T(this,"_connectionState",jt.CLOSED),T(this,"reconnectToken",void 0),T(this,"p2pToken",void 0),T(this,"websocket",void 0),T(this,"openConnectionTime",void 0),T(this,"clientId",void 0),T(this,"lastMsgTime",Date.now()),T(this,"uploadCache",[]),T(this,"uploadCacheInterval",void 0),T(this,"rttRolling",new dC(5)),T(this,"pingpongTimer",void 0),T(this,"pingpongTimeoutCount",0),T(this,"joinResponse",void 0),T(this,"multiIpOption",void 0),T(this,"initError",void 0),T(this,"spec",void 0),T(this,"store",void 0),T(this,"_external_signal",void 0),T(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(ot.ON_BINARY_DATA,r.data);const i=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const o="res-@".concat(i._id);this.emit(o,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){switch(i._type){case pt.ON_DATA_STREAM:return void this.handleDataStream(i._message);case pt.MUTE_AUDIO:case pt.MUTE_VIDEO:case pt.ON_P2P_LOST:case pt.ON_USER_ONLINE:return;case pt.ON_USER_OFFLINE:const{uid:o}=i._message;return _.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(i._type,i._message),i._type===pt.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===pt.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(Ot.UID_BANNED);break;case 15:this.close(Ot.IP_BANNED);break;case 16:this.close(Ot.CHANNEL_BANNED)}if(i._type===pt.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case tt.ERR_LICENSE_MISSING:this.close(Ot.LICENSE_MISSING);break;case tt.ERR_LICENSE_EXPIRED:this.close(Ot.LICENSE_EXPIRED);break;case tt.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ot.LICENSE_MINUTES_EXCEEDED);break;case tt.ERR_LICENSE_PERIOD_INVALID:this.close(Ot.LICENSE_PERIOD_INVALID);break;case tt.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ot.LICENSE_MULTIPLE_SDK_SERVICE);break;case tt.ERR_LICENSE_ILLEGAL:this.close(Ot.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new nE("gateway-".concat(this.clientId),this.spec.retryConfig,!0,A("JOIN_GATEWAY_USE_DUAL_DOMAIN"),A("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===jt.CONNECTED&&this.reconnect("retry",We.OFFLINE)}),this.p2pToken=Ft(6,""),this._external_signal=new Ho(this,this.p2pToken)}request(e,n,r,i){var o=this;return y(function*(){const s=Ft(6,""),a={_id:s,_type:e,_message:n},c=o.websocket.connectionID,d=()=>new H((m,f)=>{if(o.connectionState===jt.CONNECTED)return m();const g=()=>{o.off(ot.WS_CLOSED,R),m()},R=()=>{o.off(ot.WS_CONNECTED,g),f(new P(v.WS_ABORT))};o.once(ot.WS_CONNECTED,g),o.once(ot.WS_CLOSED,R)});if(o.connectionState!==jt.CONNECTING&&o.connectionState!==jt.RECONNECTING||e===it.JOIN||e===it.REJOIN||(yield d()),o.websocket.sendMessage(a,!0),i)return;const u=new H((m,f)=>{let g=!1;const R=(b,w)=>{g=!0,m({isSuccess:"success"===b,message:w||{}}),o.off(ot.WS_CLOSED,C),o.off(ot.WS_RECONNECTING,C),o.emit(ot.REQUEST_SUCCESS,e,n)};o.once("res-@".concat(s),R);const C=()=>{f(new P(v.WS_ABORT,"type: ".concat(e))),o.off(ot.WS_CLOSED,C),o.off(ot.WS_RECONNECTING,C),o.off("res-@".concat(s),R)};o.once(ot.WS_CLOSED,C),o.once(ot.WS_RECONNECTING,C),Me(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{o.websocket.connectionID!==c||g||(_.warning("[".concat(o.clientId,"] ws request timeout, type: ").concat(e)),o.emit(ot.REQUEST_TIMEOUT,e,n))})});let l=null;try{l=yield u}catch(m){if(o.connectionState===jt.CLOSED||e===it.LEAVE)throw new P(v.WS_ABORT);return!o.spec.forceWaitGatewayResponse||r?m.throw():e===it.JOIN||e===it.REJOIN?null:(yield d(),yield o.request(e,n))}if(l.isSuccess)return l.message;const p=Number(l.message.error_code||l.message.code),h=dc(p),S=new P(v.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:p,data:l.message,desc:h.desc});return"success"===h.action?l.message:(_.warning("[".concat(o.clientId,"] [").concat(o.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(p,", message: ").concat(h.desc,", action: ").concat(h.action)),p===tt.ERR_TOO_MANY_BROADCASTERS?((e===it.JOIN||e===it.REJOIN)&&(o.initError=S,o.close()),S.throw()):"failed"===h.action?S.throw():"quit"===h.action?(o.initError=S,o.close(),S.throw()):(p===tt.ERR_JOIN_BY_MULTI_IP?(o.multiIpOption=l.message.option,_.warning("[".concat(o.clientId,"] detect multi ip, recover")),o.reconnect("recover",We.MULTI_IP)):o.reconnect(h.action,We.SERVER_ERROR),e===it.JOIN||e===it.REJOIN?null:yield o.request(e,n)))})()}waitMessage(e,n){return new H(r=>{const i=o=>{(!n||n(o))&&(this.off(e,i),r(o))};this.on(e,i)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(cc.WRTC_STATS,n)}upload(e,n){const r={_type:e,_message:n};try{this.websocket.sendMessage(r)}catch{const o=A("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==jt.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},A("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){this.websocket.sendMessage({_type:e,_message:n})}sendExtensionMessage(e,n,r){var i=this;return y(function*(){return yield i._external_signal.send(e,n,r)})()}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new H((n,r)=>{this.once(ot.WS_CONNECTED,()=>n(this.joinResponse)),this.once(ot.WS_CLOSED,()=>r(this.initError||new P(v.WS_ABORT))),this.connectionState=jt.CONNECTING,this.websocket.init(e).catch(r)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||Ot.LEAVE,this.connectionState=jt.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=Ft(6,""),this._external_signal.clear(),this._external_signal=new Ho(this,this.p2pToken)}join(){var e=this;return y(function*(){if(!e.joinResponse){e.emit(ot.ABORT_P2P_EXECUTION);const n=yield He(e,ot.REQUEST_JOIN_INFO),r=yield e.request(it.JOIN,n);if(!r)return e.emit(ot.REPORT_JOIN_GATEWAY,v.TIMEOUT,e.url||""),!1;e.joinResponse=r,e.emit(ot.JOIN_RESPONSE,e.joinResponse),e.reconnectToken=e.joinResponse.rejoin_token}return e.connectionState=jt.CONNECTED,e.pingpongTimer&&window.clearInterval(e.pingpongTimer),e.pingpongTimer=window.setInterval(e.handlePingPong.bind(e),3e3),!0})()}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}handleDataStream(e){try{var n;const r=ko(e.payload),i=(new TextDecoder).decode(r),o=JSON.parse(i);"total"in o&&"id"in o||W(n=Object.values(de)).call(n,o._type)?(o._uid=e.uid,this._external_signal.onMessage(o)):this.emit(pt.ON_DATA_STREAM,e)}catch{this.emit(pt.ON_DATA_STREAM,e)}}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);const n=dc(e.code);if("success"!==n.action){if("failed"!==n.action)return"quit"===n.action?("ERR_REPEAT_JOIN_CHANNEL"===n.desc&&this.close(Ot.UID_BANNED),void this.close()):void this.reconnect(n.action,We.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=A("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>A("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",We.TIMEOUT):this.request(it.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-n;this.rttRolling.add(r),A("REPORT_STATS")&&this.send(it.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWebsocketEvents(){this.websocket.on(ct.RECONNECT_CREATE_CONNECTION,e=>{this.emit(ot.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(ct.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ct.CLOSED,()=>{this.connectionState=jt.CLOSED}),this.websocket.on(ct.FAILED,()=>{this._disconnectedReason=Ot.NETWORK_ERROR,this.connectionState=jt.CLOSED}),this.websocket.on(ct.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState=this.connectionState===jt.CONNECTED?jt.RECONNECTING:jt.CONNECTING}),this.websocket.on(ct.WILL_RECONNECT,(e,n,r)=>{"retry"!==e?(_.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):_.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),r(e)}),this.websocket.on(ct.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(ot.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof P&&e.code===v.UNEXPECTED_RESPONSE&&e.data.code===tt.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",We.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",We.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(ct.REQUEST_NEW_URLS,(e,n)=>{He(this,ot.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)}),this.websocket.on(ct.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}var Sb={exports:{}};!function(t){t.exports=(()=>{var n={8:(o,s,a)=>{a.r(s),a.d(s,{Parser:()=>$,Printer:()=>wr,parse:()=>st,print:()=>yt});const c="\n",d="".concat("\r").concat(c),u=" ";let l;function p(G){return G>="0"&&G<="9"}function h(G){return G>="!"&&G<="~"}function S(G){return h(G)||G>="\x80"&&G<="\xff"}function m(G){return"!"===G||G>="#"&&G<="'"||G>="*"&&G<="+"||G>="-"&&G<="."||G>="0"&&G<="9"||G>="A"&&G<="Z"||G>="^"&&G<="~"}function f(G){return G>="1"&&G<="9"}function g(G){return G>="A"&&G<="Z"||G>="a"&&G<="z"}function R(G){return"d"===G||"h"===G||"m"===G||"s"===G}function C(G){return G>"\x01"&&G<"\t"||G>"\v"&&G<"\f"||G>"\x0e"&&G<"\xff"}function b(G){return g(G)||p(G)||"+"===G||"/"===G}function w(G){return p(G)||g(G)||"+"===G||"/"===G||"-"===G||"_"===G}function D(G){return g(G)||p(G)||"+"===G||"/"===G}function V(G,E){var I=Object.keys(G);if(Object.getOwnPropertySymbols){var O=Object.getOwnPropertySymbols(G);E&&(O=O.filter(function(F){return Object.getOwnPropertyDescriptor(G,F).enumerable})),I.push.apply(I,O)}return I}function U(G){for(var E=1;E<arguments.length;E++){var I=null!=arguments[E]?arguments[E]:{};E%2?V(Object(I),!0).forEach(function(O){k(G,O,I[O])}):Object.getOwnPropertyDescriptors?Object.defineProperties(G,Object.getOwnPropertyDescriptors(I)):V(Object(I)).forEach(function(O){Object.defineProperty(G,O,Object.getOwnPropertyDescriptor(I,O))})}return G}function k(G,E,I){return E in G?Object.defineProperty(G,E,{value:I,enumerable:!0,configurable:!0,writable:!0}):G[E]=I,G}var G;(G=l||(l={})).VERSION="v",G.ORIGIN="o",G.SESSION_NAME="s",G.INFORMATION="i",G.URI="u",G.EMAIL="e",G.PHONE="p",G.CONNECTION="c",G.BANDWIDTH="b",G.TIME="t",G.REPEAT="r",G.ZONE_ADJUSTMENTS="z",G.KEY="k",G.ATTRIBUTE="a",G.MEDIA="m";class Z{consumeText(E,I){let O=I;for(;O<E.length;){const F=E[O];if("\0"===F||"\r"===F||F===c)break;O+=1}if(O-I==0)throw new Error("Invalid text, at ".concat(E));return O}consumeUnicastAddress(E,I,O){return this.consumeTill(E,I,u)}consumeOneOrMore(E,I,O){let F=I;for(;O(E[F]);)F++;if(F-I==0)throw new Error("Invalid rule at ".concat(I,"."));return F}consumeSpace(E,I){if(E[I]===u)return I+1;throw new Error("Invalid space at ".concat(I,"."))}consumeIP4Address(E,I){let O=I;for(let F=0;F<4;F++)if(O=this.consumeDecimalUChar(E,O),3!==F){if("."!==E[O])throw new Error("Invalid IP4 address.");O++}return O}consumeDecimalUChar(E,I){let O=I;for(let at=0;at<3&&p(E[O]);at++,O++);if(O-I==0)throw new Error("Invalid decimal uchar.");const F=parseInt(E.slice(I,O));if(F>=0&&F<=255)return O;throw new Error("Invalid decimal uchar")}consumeIP6Address(E,I){let O=this.consumeHexpart(E,I);return":"===E[O]&&(O+=1,O=this.consumeIP4Address(E,O)),O}consumeHexpart(E,I){let O=I;if(":"===E[O]&&":"===E[O+1]){O+=2;try{O=this.consumeHexseq(E,O)}catch{}return O}if(O=this.consumeHexseq(E,O),":"===E[O]&&":"===E[O+1]){O+=2;try{O=this.consumeHexseq(E,O)}catch{}return O}return O}consumeHexseq(E,I){let O=I;for(;O=this.consumeHex4(E,O),":"===E[O]&&":"!==E[O+1];)O+=1;return O}consumeHex4(E,I){let O=0;for(;O<4;O++)if(!((F=E[I+O])>="0"&&F<="9"||F>="a"&&F<="f"||F>="A"&&F<="F")){if(0===O)throw new Error("Invalid hex 4");break}var F;return I+O}consumeFQDN(E,I){let O=I;for(;p(E[O])||g(E[O])||"-"===E[O]||"."===E[O];)O+=1;if(O-I<4)throw new Error("Invalid FQDN");return O}consumeExtnAddr(E,I){return this.consumeOneOrMore(E,I,S)}consumeMulticastAddress(E,I,O){switch(O){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(E,I);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(E,I);default:try{return this.consumeFQDN(E,I)}catch{return this.consumeExtnAddr(E,I)}}}consumeIP6MulticastAddress(E,I){const O=this.consumeHexpart(E,I);return"/"===E[O]?this.consumeInteger(E,O+1):O}consumeIP4MulticastAddress(E,I){let O=I+3;const F=E.slice(I,O),at=parseInt(F);if(at<224||at>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Pt=0;Pt<3;Pt++){if("."!==E[O])throw new Error("Invalid IP4 multicast address.");O+=1,O=this.consumeDecimalUChar(E,O)}return"/"===E[O]&&(O+=1),O=this.consumeTTL(E,O),"/"===E[O]&&(O=this.consumeInteger(E,O)),O}consumeInteger(E,I){if(!f(E[I]))throw new Error("Invalid integer.");for(I+=1;p(E[I]);)I+=1;return I}consumeTTL(E,I){if("0"===E[I])return I+1;if(!f(E[I]))throw new Error("Invalid TTL.");I+=1;for(let O=0;O<2&&p(E[I]);O++)I+=1;return I}consumeToken(E,I){return this.consumeOneOrMore(E,I,m)}consumeTime(E,I){let O=I;if("0"===E[O])return O+1;for(f(E[O])&&(O+=1);p(E[O]);)O++;if(O-I<10)throw new Error("Invalid time");return O}consumeAddress(E,I){return this.consumeTill(E,I,u)}consumeTypedTime(E,I){let O=I;return O=this.consumeOneOrMore(E,O,p),R(E[O])?O+1:O}consumeRepeatInterval(E,I){if(!f(E[I]))throw new Error("Invalid repeat interval");for(I+=1;p(E[I]);)I+=1;return R(E[I])&&(I+=1),I}consumePort(E,I){return this.consumeOneOrMore(E,I,p)}consume(E,I,O){for(let F=0;F<O.length;F++){if(I+F>=E.length)throw new Error("consume exceeding value length");if(E[I+F]!==O[F])throw new Error("consume ".concat(O," failed at ").concat(F))}return I+O.length}consumeTill(E,I,O){let F=I;for(;F<E.length&&("string"!=typeof O||E[F]!==O)&&("function"!=typeof O||!O(E[F]));)F++;return F}}class $ extends Z{constructor(){super(),k(this,"records",[]),k(this,"currentLine",0)}parse(E){const I=this.probeEOL(E);this.records=E.split(I).filter(ve=>!!$e(ve).call(ve)).map(this.parseLine),this.currentLine=0;const O=this.parseVersion(),F=this.parseOrigin(),at=this.parseSessionName(),Pt=this.parseInformation(),Oe=this.parseUri(),vn=this.parseEmail(),Li=this.parsePhone(),xl=this.parseConnection(),Vl=this.parseBandWidth(),ar=this.parseTimeFields(),To=this.parseKey(),Ia=this.parseSessionAttribute(),le=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:O,origin:F,sessionName:at,information:Pt,uri:Oe,emails:vn,phones:Li,connection:xl,bandwidths:Vl,timeFields:ar,key:To,attributes:Ia,mediaDescriptions:le}}getCurrentRecord(){const E=this.records[this.currentLine];if(!E)throw new Error("Record doesn't exit.");return E}probeEOL(E){for(let I=0;I<E.length;I++)if(E[I]===c)return"\r"===E[I-1]?d:c;throw new Error("Invalid newline character.")}parseLine(E,I){if(E.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const O=E[0];if("="!==E[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:O,value:E.slice(2),line:I,cur:0}}parseSessionAttribute(){const E=new Nt;for(;this.currentLine<this.records.length;){const I=this.getCurrentRecord();if(I.type!==l.ATTRIBUTE)break;const O={attField:this.extractOneOrMore(I,F=>m(F)&&":"!==F),_cur:0};":"===I.value[I.cur]&&(I.cur+=1,O.attValue=this.extractOneOrMore(I,C)),E.parse(O),this.currentLine++}return E.digest()}parseMediaAttributes(E){const I=new oe(E);for(;this.currentLine<this.records.length;){const O=this.getCurrentRecord();if(O.type!==l.ATTRIBUTE)break;const F={attField:this.extractOneOrMore(O,at=>m(at)&&":"!==at),_cur:0};":"===O.value[O.cur]&&(O.cur+=1,F.attValue=this.extractOneOrMore(O,C)),I.parse(F),this.currentLine++}return I.digest()}parseKey(){const E=this.getCurrentRecord();if(E.type===l.KEY){if("prompt"===E.value||"clear:"===E.value||"base64:"===E.value||"uri:"===E.value)return E.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const E=this.getCurrentRecord();if(E.type===l.ZONE_ADJUSTMENTS){const I=[];for(;;)try{const O=this.extract(E,this.consumeTime);this.consumeSpaceForRecord(E);let F=!1;"-"===E.value[E.cur]&&(F=!0,E.cur+=1);const at=this.extract(E,this.consumeTypedTime);I.push({time:O,typedTime:at,back:F})}catch{break}if(0===I.length)throw new Error("Invalid zone adjustments");return this.currentLine++,I}return[]}parseRepeat(){const E=[];for(;;){const I=this.getCurrentRecord();if(I.type!==l.REPEAT)break;{const O=this.extract(I,this.consumeRepeatInterval),F=this.parseTypedTime(I);E.push({repeatInterval:O,typedTimes:F}),this.currentLine++}}return E}parseTypedTime(E){const I=[];for(;;)try{this.consumeSpaceForRecord(E),I.push(this.extract(E,this.consumeTypedTime))}catch{break}if(0===I.length)throw new Error("Invalid typed time.");return I}parseTime(){const E=this.getCurrentRecord(),I=this.extract(E,this.consumeTime);this.consumeSpaceForRecord(E);const O=this.extract(E,this.consumeTime);return this.currentLine++,{startTime:I,stopTime:O}}parseBandWidth(){const E=[];for(;this.currentLine<this.records.length;){const I=this.getCurrentRecord();if(I.type!==l.BANDWIDTH)break;{const O=this.extractOneOrMore(I,m);if(":"!==I.value[I.cur])throw new Error("Invalid bandwidth field.");I.cur++;const F=this.extractOneOrMore(I,p);E.push({bwtype:O,bandwidth:F}),this.currentLine++}}return E}parseVersion(){const E=this.getCurrentRecord();if(E.type!==l.VERSION)throw new Error("first sdp record must be version");const I=E.value.slice(0,this.consumeOneOrMore(E.value,0,p));if(I.length!==E.value.length)throw new Error('invalid proto version, "v='.concat(E.value,'"'));return this.currentLine++,I}parseOrigin(){const E=this.getCurrentRecord();if(E.type!==l.ORIGIN)throw new Error("second line of sdp must be origin");const I=this.extractOneOrMore(E,S);this.consumeSpaceForRecord(E);const O=this.extractOneOrMore(E,p);this.consumeSpaceForRecord(E);const F=this.extractOneOrMore(E,p);this.consumeSpaceForRecord(E);const at=this.extractOneOrMore(E,m);this.consumeSpaceForRecord(E);const Pt=this.extractOneOrMore(E,m);this.consumeSpaceForRecord(E);const Oe=this.extract(E,this.consumeUnicastAddress);return this.currentLine++,{username:I,sessId:O,sessVersion:F,nettype:at,addrtype:Pt,unicastAddress:Oe}}parseSessionName(){const E=this.getCurrentRecord();if(E.type===l.SESSION_NAME){const I=this.extract(E,this.consumeText);return this.currentLine++,I}}parseInformation(){const E=this.getCurrentRecord();if(E.type!==l.INFORMATION)return;const I=this.extract(E,this.consumeText);return this.currentLine++,I}parseUri(){const E=this.getCurrentRecord();if(E.type===l.URI)return this.currentLine++,E.value}parseEmail(){const E=[];for(;;){const I=this.getCurrentRecord();if(I.type!==l.EMAIL)break;E.push(I.value),this.currentLine++}return E}parsePhone(){const E=[];for(;;){const I=this.getCurrentRecord();if(I.type!==l.PHONE)break;E.push(I.value),this.currentLine++}return E}parseConnection(){const E=this.getCurrentRecord();if(E.type===l.CONNECTION){const I=this.extractOneOrMore(E,m);this.consumeSpaceForRecord(E);const O=this.extractOneOrMore(E,m);this.consumeSpaceForRecord(E);const F=this.extract(E,this.consumeAddress);return this.currentLine++,{nettype:I,addrtype:O,address:F}}}parseMedia(){const E=this.getCurrentRecord(),I=this.extract(E,this.consumeToken);this.consumeSpaceForRecord(E);let O=this.extract(E,this.consumePort);"/"===E.value[E.cur]&&(E.cur+=1,O+=this.extract(E,this.consumeInteger)),this.consumeSpaceForRecord(E);const F=[];for(F.push(this.extract(E,this.consumeToken));"/"===E.value[E.cur];)E.cur+=1,F.push(this.extract(E,this.consumeToken));if(0===F.length)throw new Error("Invalid proto");const at=this.parseFmt(E);return this.currentLine++,{mediaType:I,port:O,protos:F,fmts:at}}parseTimeFields(){const E=[];for(;this.getCurrentRecord().type===l.TIME;){const I=this.parseTime(),O=this.parseRepeat(),F=this.parseZone();E.push({time:I,repeats:O,zones:F})}return E}parseMediaDescription(){const E=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.MEDIA;){const I=this.parseMedia(),O=this.parseInformation(),F=this.parseConnections(),at=this.parseBandWidth(),Pt=this.parseKey(),Oe=this.parseMediaAttributes(I);E.push({media:I,information:O,connections:F,bandwidths:at,key:Pt,attributes:Oe})}return E}parseConnections(){const E=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===l.CONNECTION;)E.push(this.parseConnection());return E}parseFmt(E){const I=[];for(;;)try{this.consumeSpaceForRecord(E),I.push(this.extract(E,this.consumeToken))}catch{break}if(0===I.length)throw new Error("Invalid fmts");return I}extract(E,I){for(var O=arguments.length,F=new Array(O>2?O-2:0),at=2;at<O;at++)F[at-2]=arguments[at];const Pt=I.call(this,E.value,E.cur,...F),Oe=E.value.slice(E.cur,Pt);return E.cur=Pt,Oe}extractOneOrMore(E,I){const O=this.consumeOneOrMore(E.value,E.cur,I),F=E.value.slice(E.cur,O);return E.cur=O,F}consumeSpaceForRecord(E){if(E.value[E.cur]!==u)throw new Error("Invalid space at ".concat(E.cur,"."));E.cur+=1}}class Rt extends Z{constructor(){super(...arguments),k(this,"attributes",void 0),k(this,"digested",!1)}extractOneOrMore(E,I,O){const F=this.consumeOneOrMore(E.attValue,E._cur,I),at=E.attValue.slice(E._cur,F),[Pt,Oe]=O||[];if("number"==typeof Pt&&at.length<Pt)throw new Error("error in length, should be more or equal than ".concat(Pt," characters."));if("number"==typeof Oe&&at.length>Oe)throw new Error("error in length, should be less or equal than ".concat(Oe," characters."));return E._cur=F,at}consumeAttributeSpace(E){if(E.attValue[E._cur]!==u)throw new Error("Invalid space at ".concat(E._cur,"."));E._cur+=1}extract(E,I){if(!E.attValue)throw new Error("Nothing to extract from attValue.");for(var O=arguments.length,F=new Array(O>2?O-2:0),at=2;at<O;at++)F[at-2]=arguments[at];const Pt=I.call(this,E.attValue,E._cur,...F),Oe=E.attValue.slice(E._cur,Pt);return E._cur=Pt,Oe}atEnd(E){if(!E.attValue)throw new Error;return E._cur>=E.attValue.length}peekChar(E){if(!E.attValue)throw new Error;return E.attValue[E._cur]}peek(E,I){if(!E.attValue)throw new Error;for(let O=0;O<I.length;O++)if(I[O]!==E.attValue[E._cur+O])return!1;return!0}parseIceUfrag(E){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(E,b,[4,256])}parseIcePwd(E){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(E,b,[22,256])}parseIceOptions(E){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const I=[];for(;!this.atEnd(E);){I.push(this.extractOneOrMore(E,b));try{this.consumeAttributeSpace(E)}catch(O){if(this.atEnd(E))break;throw O}}this.attributes.iceOptions=I}parseFingerprint(E){const I=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const O=this.extract(E,this.consumeTill);this.attributes.fingerprints.push({hashFunction:I,fingerprint:O})}parseExtmap(E){const I=this.extractOneOrMore(E,p);let O;"/"===this.peekChar(E)&&(this.extract(E,this.consume,"/"),O=this.extract(E,this.consumeToken)),this.consumeAttributeSpace(E);const F=this.extract(E,this.consumeTill,u),at=U(U({entry:parseInt(I,10)},O&&{direction:O}),{},{extensionName:F});this.peekChar(E)===u&&(this.consumeAttributeSpace(E),at.extensionAttributes=this.extract(E,this.consumeTill)),this.attributes.extmaps.push(at)}parseSetup(E){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const I=this.extract(E,this.consumeTill);if("active"!==I&&"passive"!==I&&"actpass"!==I&&"holdconn"!==I)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=I}}class Nt extends Rt{constructor(){super(...arguments),k(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(E){if(this.digested)throw new Error("already digested");try{switch(E.attField){case"group":this.parseGroup(E);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(E);break;case"ice-pwd":this.parseIcePwd(E);break;case"ice-options":this.parseIceOptions(E);break;case"fingerprint":this.parseFingerprint(E);break;case"setup":this.parseSetup(E);break;case"tls-id":this.parseTlsId(E);break;case"identity":this.parseIdentity(E);break;case"extmap":this.parseExtmap(E);break;case"msid-semantic":this.parseMsidSemantic(E);break;default:E.ignored=!0,this.attributes.unrecognized.push(E)}}catch(I){throw console.error("parsing session attribute ".concat(E.attField,' error, "a=').concat(E.attField,":").concat(E.attValue,'"')),I}if(!E.ignored&&E.attValue&&!this.atEnd(E))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(E){const I=this.extract(E,this.consumeToken),O=[];for(;!this.atEnd(E)&&this.peekChar(E)===u;)this.consumeAttributeSpace(E),O.push(this.extract(E,this.consumeToken));this.attributes.groups.push({semantic:I,identificationTag:O})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(E){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(E,w)}parseIdentity(E){const I=this.extractOneOrMore(E,D),O=[];for(;!this.atEnd(E)&&this.peekChar(E)===u;){this.consumeAttributeSpace(E);const F=this.extract(E,this.consumeToken);this.extract(E,this.consume,"=");const at=this.extractOneOrMore(E,Pt=>Pt!==u&&C(Pt));O.push({name:F,value:at})}this.attributes.identities.push({assertionValue:I,extensions:O})}parseMsidSemantic(E){this.peekChar(E)===u&&this.consumeAttributeSpace(E);const I={semantic:this.extract(E,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(E)}catch{break}if("*"===this.peekChar(E)){this.extract(E,this.consume,"*"),I.applyForAll=!0;break}{const O=this.extract(E,this.consumeTill,u);I.identifierList.push(O)}}this.attributes.msidSemantic=I}}class oe extends Rt{constructor(E){super(),k(this,"attributes",void 0),-1!==E.protos.indexOf("RTP")||E.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(E){if(this.digested)throw new Error("already digested");try{switch(E.attField){case"extmap":this.parseExtmap(E);break;case"setup":this.parseSetup(E);break;case"ice-ufrag":this.parseIceUfrag(E);break;case"ice-pwd":this.parseIcePwd(E);break;case"ice-options":this.parseIceOptions(E);break;case"candidate":this.parseCandidate(E);break;case"remote-candidate":this.parseRemoteCandidate(E);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(E);break;case"rtpmap":this.parseRtpmap(E);break;case"ptime":this.parsePtime(E);break;case"maxptime":this.parseMaxPtime(E);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(E);break;case"ssrc":this.parseSSRC(E);break;case"fmtp":this.parseFmtp(E);break;case"rtcp-fb":this.parseRtcpFb(E);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(E);break;case"mid":this.parseMid(E);break;case"msid":this.parseMsid(E);break;case"imageattr":this.parseImageAttr(E);break;case"rid":this.parseRid(E);break;case"simulcast":this.parseSimulcast(E);break;case"sctp-port":this.parseSctpPort(E);break;case"max-message-size":this.parseMaxMessageSize(E);break;case"ssrc-group":this.parseSSRCGroup(E);break;default:E.ignored=!0,this.attributes.unrecognized.push(E)}}catch(I){throw console.error("parsing media attribute ".concat(E.attField,' error, "a=').concat(E.attField,":").concat(E.attValue,'"')),I}if(!E.ignored&&E.attValue&&!this.atEnd(E))throw new Error("attribute parsing error")}parseCandidate(E){const I=this.extractOneOrMore(E,b,[1,32]);this.consumeAttributeSpace(E);const O=this.extractOneOrMore(E,p,[1,5]);this.consumeAttributeSpace(E);const F=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const at=this.extractOneOrMore(E,p,[1,10]);this.consumeAttributeSpace(E);const Pt=this.extract(E,this.consumeAddress);this.consumeAttributeSpace(E);const Oe=this.extract(E,this.consumePort);this.consumeAttributeSpace(E),this.extract(E,this.consume,"typ"),this.consumeAttributeSpace(E);const vn={foundation:I,componentId:O,transport:F,priority:at,connectionAddress:Pt,port:Oe,type:this.extract(E,this.consumeToken),extension:{}};for(this.peek(E," raddr")&&(this.extract(E,this.consume," raddr"),this.consumeAttributeSpace(E),vn.relAddr=this.extract(E,this.consumeAddress)),this.peek(E," rport")&&(this.extract(E,this.consume," rport"),this.consumeAttributeSpace(E),vn.relPort=this.extract(E,this.consumePort));this.peekChar(E)===u;){this.consumeAttributeSpace(E);const Li=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E),vn.extension[Li]=this.extractOneOrMore(E,h)}this.attributes.candidates.push(vn)}parseRemoteCandidate(E){const I=[];for(;;){const O=this.extractOneOrMore(E,p,[1,5]);this.consumeAttributeSpace(E);const F=this.extract(E,this.consumeAddress);this.consumeAttributeSpace(E);const at=this.extract(E,this.consumePort);I.push({componentId:O,connectionAddress:F,port:at});try{this.consumeAttributeSpace(E)}catch{break}}this.attributes.remoteCandidatesList.push(I)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(E){const I=this.extract(E,this.consumeToken);this.consumeAttributeSpace(E);const O=this.extract(E,this.consumeTill,"/");this.extract(E,this.consume,"/");const F={encodingName:O,clockRate:this.extractOneOrMore(E,p)};this.atEnd(E)||"/"!==this.peekChar(E)||(this.extract(E,this.consume,"/"),F.encodingParameters=parseInt(this.extract(E,this.consumeTill),10));const at=this.attributes.payloads.find(Pt=>Pt.payloadType===parseInt(I,10));at?at.rtpMap=F:this.attributes.payloads.push({payloadType:parseInt(I,10),rtpMap:F,rtcpFeedbacks:[]})}parsePtime(E){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(E,this.consumeTill)}parseMaxPtime(E){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(E,this.consumeTill)}parseDirection(E){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=E.attField}parseSSRC(E){const I=this.extractOneOrMore(E,p);this.consumeAttributeSpace(E);const O=this.extract(E,this.consumeTill,":");let F;":"===this.peekChar(E)&&(this.extract(E,this.consume,":"),F=this.extract(E,this.consumeTill));const at=this.attributes.ssrcs.find(Pt=>Pt.ssrcId===parseInt(I,10));at?at.attributes[O]=F:this.attributes.ssrcs.push({ssrcId:parseInt(I,10),attributes:{[O]:F}})}parseFmtp(E){const I=this.extract(E,this.consumeTill,u);this.consumeAttributeSpace(E);const O=this.extract(E,this.consumeTill),F={};O.split(";").forEach(Pt=>{let[Oe,vn]=Pt.split("=");Oe=$e(Oe).call(Oe);const Li="string"==typeof vn?$e(vn).call(vn):null;"string"==typeof Oe&&Oe.length>0&&(F[Oe]=Li)});const at=this.attributes.payloads.find(Pt=>Pt.payloadType===parseInt(I,10));at?at.fmtp={parameters:F}:this.attributes.payloads.push({payloadType:parseInt(I,10),rtcpFeedbacks:[],fmtp:{parameters:F}})}parseFmtParameters(E){const I={},O=this.extract(E,this.consumeTill,"=");E._cur++;const F=this.extract(E,this.consumeTill,";");for(I[O]=F;";"===E.attValue[E._cur];){const at=this.extract(E,this.consumeTill,"=");E._cur++;const Pt=this.extract(E,this.consumeTill,";");I[at]=Pt}return I}parseRtcpFb(E){let I="";I="*"===this.peekChar(E)?this.extract(E,this.consume,"*"):this.extract(E,this.consumeTill,u),this.consumeAttributeSpace(E);const O=this.extract(E,this.consumeTill,u);let F;if("trr-int"===O)F={type:O,interval:this.extract(E,this.consumeTill)};else{const at={type:O};this.peekChar(E)===u&&(this.consumeAttributeSpace(E),at.parameter=this.extract(E,this.consumeToken),this.peekChar(E)===u&&(at.additional=this.extract(E,this.consumeTill))),F=at}if("*"===I)this.attributes.rtcpFeedbackWildcards.push(F);else{const at=this.attributes.payloads.find(Pt=>Pt.payloadType===parseInt(I,10));at?at.rtcpFeedbacks.push(F):this.attributes.payloads.push({payloadType:parseInt(I,10),rtcpFeedbacks:[F]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(E){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const I={port:this.extract(E,this.consumePort)};this.peekChar(E)===u&&(this.consumeAttributeSpace(E),I.netType=this.extractOneOrMore(E,m),this.consumeAttributeSpace(E),I.addressType=this.extractOneOrMore(E,m),this.consumeAttributeSpace(E),I.address=this.extract(E,this.consumeAddress)),this.attributes.rtcp=I}parseMsid(E){const I={id:this.extractOneOrMore(E,m,[1,64])};this.peekChar(E)===u&&(this.consumeAttributeSpace(E),I.appdata=this.extractOneOrMore(E,m,[1,64])),this.attributes.msids.push(I)}parseImageAttr(E){this.attributes.imageattr.push(E.attValue)}parseRid(E){const I=this.extractOneOrMore(E,F=>g(F)||p(F)||"_"===F||"-"===F);this.consumeAttributeSpace(E);const O={id:I,direction:this.extract(E,this.consumeToken),params:[]};if(this.peekChar(E)===u){if(this.consumeAttributeSpace(E),this.peek(E,"pt=")){this.extract(E,this.consume,"pt=");const F=[];for(;;){const at=this.extract(E,this.consumeToken);F.push(at);try{this.extract(E,this.consume,",")}catch{break}}O.payloads=F,this.peekChar(E)===u&&this.extract(E,this.consume,u)}for(;;){const F=this.extract(E,this.consumeToken);switch(F){case"depend":{const at={type:F,rids:this.extract(E,this.consume,"=").split(",")};O.params.push(at);break}default:{const at={type:F};"="===this.peekChar(E)&&(this.extract(E,this.consume,"="),at.val=this.extract(E,this.consumeTill,";")),O.params.push(at)}}try{this.extract(E,this.consume,";")}catch{break}}}this.attributes.rids.push(O)}parseSimulcast(E){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=E.attValue,this.extract(E,this.consumeTill)}parseSctpPort(E){this.attributes.sctpPort=this.extractOneOrMore(E,p,[1,5])}parseMaxMessageSize(E){this.attributes.maxMessageSize=this.extractOneOrMore(E,p,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(E){this.attributes.mid=this.extract(E,this.consumeToken)}parseSSRCGroup(E){const I=this.extract(E,this.consumeToken),O=[];for(;;)try{this.consumeAttributeSpace(E);const F=this.extract(E,this.consumeInteger);O.push(parseInt(F,10))}catch{break}this.attributes.ssrcGroups.push({semantic:I,ssrcIds:O})}}function Yt(G,E,I){return E in G?Object.defineProperty(G,E,{value:I,enumerable:!0,configurable:!0,writable:!0}):G[E]=I,G}class wr{constructor(){Yt(this,"eol",d)}print(E,I){let O="";return I&&(this.eol=I),O+=this.printVersion(E.version),O+=this.printOrigin(E.origin),O+=this.printSessionName(E.sessionName),O+=this.printInformation(E.information),O+=this.printUri(E.uri),O+=this.printEmail(E.emails),O+=this.printPhone(E.phones),O+=this.printConnection(E.connection),O+=this.printBandwidth(E.bandwidths),O+=this.printTimeFields(E.timeFields),O+=this.printKey(E.key),O+=this.printSessionAttributes(E.attributes),O+=this.printMediaDescription(E.mediaDescriptions),O}printVersion(E){return"v=".concat(E).concat(this.eol)}printOrigin(E){return"o=".concat(E.username," ").concat(E.sessId," ").concat(E.sessVersion," ").concat(E.nettype," ").concat(E.addrtype," ").concat(E.unicastAddress).concat(this.eol)}printSessionName(E){return E?"s=".concat(E).concat(this.eol):""}printInformation(E){return E?"i=".concat(E).concat(this.eol):""}printUri(E){return E?"u=".concat(E).concat(this.eol):""}printEmail(E){let I="";for(const O of E)I+="e=".concat(O).concat(this.eol);return I}printPhone(E){let I="";for(const O of E)I+="e=".concat(O).concat(this.eol);return I}printConnection(E){return E?"c=".concat(E.nettype," ").concat(E.addrtype," ").concat(E.address).concat(this.eol):""}printBandwidth(E){let I="";for(const O of E)I+="b=".concat(O.bwtype,":").concat(O.bandwidth).concat(this.eol);return I}printTimeFields(E){let I="";for(const O of E){I+="t=".concat(O.time.startTime," ").concat(O.time.startTime).concat(this.eol);for(const F of O.repeats)I+="r=".concat(F.repeatInterval," ").concat(F.typedTimes.join(" ")).concat(this.eol);O.zoneAdjustments&&(I+="z=",I+="z=".concat(O.zoneAdjustments.map(F=>"".concat(F.time," ").concat(F.back?"-":""," ").concat(F.typedTime)).join(" ")).concat(this.eol),I+=this.eol)}return I}printKey(E){return E?"k=".concat(E).concat(this.eol):""}printAttributes(E){let I="";for(const O of E)I+="a=".concat(O.attField).concat(O.attValue?":".concat(O.attValue):"").concat(this.eol);return I}printMediaDescription(E){let I="";for(const O of E)I+=this.printMedia(O.media),I+=this.printInformation(O.information),I+=this.printConnections(O.connections),I+=this.printBandwidth(O.bandwidths),I+=this.printKey(O.key),I+=this.printMediaAttributes(O);return I}printConnections(E){let I="";for(const O of E)I+=this.printConnection(O);return I}printMedia(E){return"m=".concat(E.mediaType," ").concat(E.port," ").concat(E.protos.join("/")," ").concat(E.fmts.join(" ")).concat(this.eol)}printSessionAttributes(E){return new B(this.eol).print(E)}printMediaAttributes(E){return new J(this.eol).print(E)}}class M{constructor(E){Yt(this,"eol",void 0),this.eol=E}printIceUfrag(E){return void 0===E?"":"a=ice-ufrag:".concat(E).concat(this.eol)}printIcePwd(E){return void 0===E?"":"a=ice-pwd:".concat(E).concat(this.eol)}printIceOptions(E){return void 0===E?"":"a=ice-options:".concat(E.join(u)).concat(this.eol)}printFingerprints(E){return E.length>0?E.map(I=>"a=fingerprint:".concat(I.hashFunction).concat(u).concat(I.fingerprint)).join(this.eol)+this.eol:""}printExtmap(E){return E.map(I=>"a=extmap:".concat(I.entry).concat(I.direction?"/".concat(I.direction):"").concat(u).concat(I.extensionName).concat(I.extensionAttributes?"".concat(u).concat(I.extensionAttributes):"").concat(this.eol)).join("")}printSetup(E){return void 0===E?"":"a=setup:".concat(E).concat(this.eol)}printUnrecognized(E){return E.map(I=>"a=".concat(I.attField).concat(I.attValue?":".concat(I.attValue):"").concat(this.eol)).join("")}}class B extends M{print(E){let I="";return I+=this.printGroups(E.groups),I+=this.printMsidSemantic(E.msidSemantic),I+=this.printIceLite(E.iceLite),I+=this.printIceUfrag(E.iceUfrag),I+=this.printIcePwd(E.icePwd),I+=this.printIceOptions(E.iceOptions),I+=this.printFingerprints(E.fingerprints),I+=this.printSetup(E.setup),I+=this.printTlsId(E.tlsId),I+=this.printIdentity(E.identities),I+=this.printExtmap(E.extmaps),I+=this.printUnrecognized(E.unrecognized),I}printGroups(E){let I="";return E.length>0&&(I+=E.map(O=>"a=group:".concat(O.semantic).concat(O.identificationTag.map(F=>"".concat(u).concat(F)).join("")).concat(this.eol)).join("")),I}printIceLite(E){return void 0===E?"":"a=ice-lite"+this.eol}printTlsId(E){return E?"a=tls-id:".concat(E).concat(this.eol):""}printIdentity(E){return 0===E.length?"":E.map(I=>"a=identity:".concat(I.assertionValue).concat(I.extensions.map(O=>"".concat(u).concat(O.name).concat(O.value?"=".concat(O.value):"")))).join(this.eol)+this.eol}printMsidSemantic(E){if(!E)return"";let I="a=msid-semantic:".concat(E.semantic);return E.applyForAll?I+="".concat(u,"*"):E.identifierList.length>0&&(I+=E.identifierList.map(O=>"".concat(u).concat(O))),I+this.eol}}class J extends M{print(E){const I=E.attributes;let O="";return O+=this.printRTCP(I.rtcp),O+=this.printIceUfrag(I.iceUfrag),O+=this.printIcePwd(I.icePwd),O+=this.printIceOptions(I.iceOptions),O+=this.printCandidates(I.candidates),O+=this.printRemoteCandidatesList(I.remoteCandidatesList),O+=this.printEndOfCandidates(I.endOfCandidates),O+=this.printFingerprints(I.fingerprints),O+=this.printSetup(I.setup),O+=this.printMid(I.mid),O+=this.printExtmap(I.extmaps),O+=this.printRTPRelated(I),O+=this.printPtime(I.ptime),O+=this.printMaxPtime(I.maxPtime),O+=this.printDirection(I.direction),O+=this.printSSRCGroups(I.ssrcGroups),O+=this.printSSRC(I.ssrcs),O+=this.printRTCPMux(I.rtcpMux),O+=this.printRTCPMuxOnly(I.rtcpMuxOnly),O+=this.printRTCPRsize(I.rtcpRsize),O+=this.printMSId(I.msids),O+=this.printImageattr(I.imageattr),O+=this.printRid(I.rids),O+=this.printSimulcast(I.simulcast),O+=this.printSCTPPort(I.sctpPort),O+=this.printMaxMessageSize(I.maxMessageSize),O+=this.printUnrecognized(I.unrecognized),O}printCandidates(E){return E.map(I=>"a=candidate:".concat(I.foundation).concat(u).concat(I.componentId).concat(u).concat(I.transport).concat(u).concat(I.priority).concat(u).concat(I.connectionAddress).concat(u).concat(I.port).concat(u,"typ").concat(u).concat(I.type).concat(I.relAddr?"".concat(u,"raddr").concat(u).concat(I.relAddr):"").concat(I.relPort?"".concat(u,"rport").concat(u).concat(I.relPort):"").concat(Object.keys(I.extension).map(O=>"".concat(u).concat(O).concat(u).concat(I.extension[O])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(E){return E.map(I=>"a=remote-candidates:".concat(I.join(u)).concat(this.eol)).join("")}printEndOfCandidates(E){return void 0===E?"":"a=end-of-candidates"+this.eol}printRTPRelated(E){if(!E.payloads)return"";const I=E.payloads;let O="";O+=E.rtcpFeedbackWildcards.map(F=>this.printRTCPFeedback("*",F)).join("");for(const F of I)O+=this.printRtpMap(F.payloadType,F.rtpMap),O+=this.printFmtp(F.payloadType,F.fmtp),O+=F.rtcpFeedbacks.map(at=>this.printRTCPFeedback(F.payloadType,at)).join("");return O}printFmtp(E,I){if(!I)return"";const O=Object.keys(I.parameters);return 1===O.length&&null===I.parameters[O[0]]?"a=fmtp:".concat(E).concat(u).concat(O[0]).concat(this.eol):"a=fmtp:".concat(E).concat(u).concat(Object.keys(I.parameters).map(F=>"".concat(F,"=").concat(I.parameters[F])).join(";")).concat(this.eol)}printRtpMap(E,I){return I?"a=rtpmap:".concat(E).concat(u).concat(I.encodingName,"/").concat(I.clockRate).concat(I.encodingParameters?"/".concat(I.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(E,I){let O="a=rtcp-fb:".concat(E).concat(u),F=I;return"trr-int"===F.type?O+="ttr-int".concat(u).concat(F.interval):(O+="".concat(F.type),F.parameter&&(O+="".concat(u).concat(F.parameter),F.additional&&(O+="".concat(u).concat(F.additional)))),O+this.eol}printPtime(E){return void 0===E?"":"a=ptime:".concat(E).concat(this.eol)}printMaxPtime(E){return void 0===E?"":"a=maxptime:".concat(E).concat(this.eol)}printDirection(E){return void 0===E?"":"a=".concat(E).concat(this.eol)}printSSRC(E){return E.map(I=>Object.keys(I.attributes).map(O=>"a=ssrc:".concat(I.ssrcId.toString(10)).concat(u).concat(O).concat(I.attributes[O]?":".concat(I.attributes[O]):"").concat(this.eol)).join("")).join("")}printRTCPMux(E){return void 0===E?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(E){return void 0===E?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(E){return void 0===E?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(E){if(void 0===E)return"";let I="a=rtcp:".concat(E.port);return E.netType&&(I+="".concat(u).concat(E.netType)),E.addressType&&(I+="".concat(u).concat(E.addressType)),E.address&&(I+="".concat(u).concat(E.address)),I+this.eol}printMSId(E){return E.map(I=>"a=msid:".concat(I.id).concat(I.appdata?"".concat(u).concat(I.appdata):"").concat(this.eol)).join("")}printImageattr(E){return E.map(I=>"a=imageattr:".concat(I).concat(this.eol)).join("")}printRid(E){return E.map(I=>{let O="a=rid:".concat(I.id).concat(u).concat(I.direction);return I.payloads&&(O+="".concat(u,"pt=").concat(I.payloads.join(","))),I.params.length>0&&(O+="".concat(u).concat(I.params.map(F=>"depend"===F.type?"depend=".concat(F.rids.join(",")):"".concat(F.type,"=").concat(F.val)).join(";"))),O+this.eol}).join("")}printSimulcast(E){return void 0===E?"":"a=simulcast:".concat(E).concat(this.eol)}printSCTPPort(E){return void 0===E?"":"a=sctp-port:".concat(E).concat(this.eol)}printMaxMessageSize(E){return void 0===E?"":"a=max-message-size:".concat(E).concat(this.eol)}printMid(E){return void 0===E?"":"a=mid:".concat(E).concat(this.eol)}printSSRCGroups(E){return E.map(I=>"a=ssrc-group:".concat(I.semantic).concat(I.ssrcIds.map(O=>"".concat(u).concat(O.toString(10))).join("")).concat(this.eol)).join("")}}function st(G){return(new $).parse(G)}function yt(G,E){return(new wr).print(G,E)}}},r={};function i(o){if(r[o])return r[o].exports;var s=r[o]={exports:{}};return n[o](s,s.exports,i),s.exports}return i.d=(o,s)=>{for(var a in s)i.o(s,a)&&!i.o(o,a)&&Object.defineProperty(o,a,{enumerable:!0,get:s[a]})},i.o=(o,s)=>Object.prototype.hasOwnProperty.call(o,s),i.r=o=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},i(8)})()}(Sb);var Fe=Sb.exports;function zE(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:A("SVC_MODE");if(A("ENABLE_SVC"))return t in J_?t:J_.L1T3}const Rb={[q.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[q.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function el(t,e,n){e.forEach(r=>{var i;const o=Rb[t].find(a=>{var c;let{key:d}=a;return W(c=r.extensionName).call(c,d)});if(!o)return;const s=n.find(a=>{let{extensionName:c}=a;return W(c).call(c,o.key)});s&&W(i=s.extensionName).call(i,"gdpr_forbidden")&&(r.extensionName=s.extensionName)})}function ca(t,e){e.forEach(n=>{var r;const i=Rb[t].find(o=>{var s;let{key:a}=o;return W(s=n.extensionName).call(s,a)});W(r=n.extensionName).call(r,"gdpr_forbidden")&&i&&(n.extensionName=i.extensionName)})}function vb(t){return"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===t||W(t).call(t,"abs-send-time")}function nl(t){return"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===t||W(t).call(t,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function yb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Cb(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?yb(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):yb(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function Tc(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0;const{filterRTX:i,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c}=e,{useXR:d}=n;let u=[],l=[],p=[],h=[],S=!1,m=!1;if(Fe.parse(t).mediaDescriptions.forEach(g=>{r&&r!==g.attributes.direction||("video"!==g.media.mediaType||S||(l=g.attributes.payloads,h=g.attributes.extmaps,S=!0),"audio"!==g.media.mediaType||m||(u=g.attributes.payloads,p=g.attributes.extmaps,m=!0))}),!h||0===l.length)throw new Error("Cannot get video capabilities from SDP.");if(!p||0===u.length)throw new Error("Cannot get audio capabilities from SDP.");if(l.forEach(g=>{var R;null!==(R=g.rtpMap)&&void 0!==R&&R.clockRate&&(g.rtpMap.clockRate=parseInt(g.rtpMap.clockRate)),d&&g.rtcpFeedbacks.push({type:"rrtr"})}),u.forEach(g=>{var R;null!==(R=g.rtpMap)&&void 0!==R&&R.clockRate&&(g.rtpMap.clockRate=parseInt(g.rtpMap.clockRate)),d&&g.rtcpFeedbacks.push({type:"rrtr"})}),i&&(u=u.filter(g=>{var R;return"rtx"!==(null===(R=g.rtpMap)||void 0===R?void 0:R.encodingName.toLowerCase())}),l=l.filter(g=>{var R;return"rtx"!==(null===(R=g.rtpMap)||void 0===R?void 0:R.encodingName.toLowerCase())})),o&&(l=l.filter(g=>{var R;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(R=g.rtpMap)||void 0===R?void 0:R.encodingName)||"")})),s&&(u=u.filter(g=>{var R;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(R=g.rtpMap)||void 0===R?void 0:R.encodingName)||"")})),a&&a?.length>0&&(u=u.filter(g=>{var R;return W(a).call(a,(null===(R=g.rtpMap)||void 0===R?void 0:R.encodingName.toLowerCase())||"")})),c&&c?.length>0){const g=l.filter(R=>{var C;return W(c).call(c,(null===(C=R.rtpMap)||void 0===C?void 0:C.encodingName.toLowerCase())||"")});l=g.concat(i?[]:ZE(g,l))}const f=A("UNSUPPORTED_VIDEO_CODEC");return f&&f.length>0&&(l=l.filter(g=>!(g.rtpMap&&W(f).call(f,g.rtpMap.encodingName.toLowerCase())))),{audioCodecs:u,videoCodecs:l,audioExtensions:p,videoExtensions:h}}function oo(t){const e=Fe.parse(t);let n,r;for(const i of e.mediaDescriptions){if(!n){const o=i.attributes.iceUfrag,s=i.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:o,icePwd:s}}if(!r){const o=i.attributes.fingerprints;o.length>0&&(r={fingerprints:o})}}if(!r&&e.attributes.fingerprints.length>0&&(r={fingerprints:e.attributes.fingerprints}),!r||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:r}}function Ib(t,e){const n=[],r=t.attributes.ssrcGroups.filter(s=>"FID"===s.semantic),i=t.attributes.ssrcGroups.find(s=>"SIM"===s.semantic),o=t.attributes.ssrcs;if(i)i.ssrcIds.forEach(s=>{var a;const c=null===(a=r.find(d=>d.ssrcIds[0]===s))||void 0===a?void 0:a.ssrcIds[1];n.push({ssrcId:s,rtx:e?c:void 0})});else if(r.length>0)n.push({ssrcId:r[0].ssrcIds[0],rtx:e?r[0].ssrcIds[1]:void 0});else{if(0===o.length)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId})}return n}function Ab(t,e,n){const{cname:r}=t;let i=[];e&&(i=bb(e)),0===i.length&&(i=t.iceParameters.candidates.map(u=>({foundation:u.foundation,componentId:"1",transport:u.protocol,priority:u.priority.toString(),connectionAddress:u.ip,port:u.port.toString(),type:u.type,extension:{}})),_.debug("Using candidates from gateway."));const o={fingerprints:t.dtlsParameters.fingerprints.map(u=>({hashFunction:u.algorithm,fingerprint:u.fingerprint}))},s={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let a;switch(t.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}const c=il(t.rtpCapabilities),d=[];return Array.isArray(n)&&n.length>0&&n.forEach(u=>{d.push({kind:q.VIDEO,ssrcId:u.v,rtx:u.v_rtx,mslabel:"".concat(u.v,"_").concat(u.a)},{kind:q.AUDIO,ssrcId:u.a,mslabel:"".concat(u.v,"_").concat(u.a)})}),{dtlsParameters:o,iceParameters:s,candidates:i,rtpCapabilities:c,setup:a,cname:r,preSSRCs:d}}function bb(t){let e=[];return t.ip&&"number"==typeof t.port&&(e=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(e.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))),e}function Ko(t,e,n){const r=[],i=[];return t.forEach(o=>{let{ssrcId:s,rtx:a}=o;const c=Ft(8,"track-"),d={ssrcId:s,attributes:Cb({label:c,mslabel:n=n||Ft(10,""),msid:"".concat(n," ").concat(c)},e&&{cname:e})};if(r.push(d),void 0!==a){const u={ssrcId:a,attributes:Cb({label:c,mslabel:n,msid:"".concat(n," ").concat(c)},e&&{cname:e})};r.push(u),i.push({semantic:"FID",ssrcIds:[s,a]})}}),t.length>1&&i.push({semantic:"SIM",ssrcIds:t.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:r,ssrcGroups:i}}function da(t,e){e instanceof ie&&t.attributes.payloads.forEach(n=>{var r;const i=null===(r=n.rtpMap)||void 0===r?void 0:r.encodingName.toLowerCase();if(!i||-1===["opus","pcmu","pcma","g722"].indexOf(i))return;n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const o=e._encoderConfig;o&&"pcmu"!==i&&"pcma"!==i&&"g722"!==i&&(o.bitrate&&!ee()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1"))})}function JE(t){const e=t.attributes.unrecognized.findIndex(n=>"x-google-flag"===n.attField&&"conference"===n.attValue);-1!==e&&t.attributes.unrecognized.splice(e,1)}function XE(t,e){var n;if(!(e instanceof Kt&&e._encoderConfig&&-1===e._hints.indexOf(Bt.SCREEN_TRACK)))return;const r=e._encoderConfig;St().supportMinBitrate&&r.bitrateMin&&t.attributes.payloads.forEach(i=>{var o,s;W(o=["h264","h265","vp8","vp9","av1"]).call(o,(null===(s=i.rtpMap)||void 0===s?void 0:s.encodingName.toLowerCase())||"")&&(i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters["x-google-min-bitrate"]="".concat(r.bitrateMin))}),St().supportMinBitrate&&!W(n=e._hints).call(n,Bt.LOW_STREAM)&&r.bitrateMax&&t.attributes.payloads.forEach(i=>{var o,s;W(o=["h264","h265","vp8","vp9","av1"]).call(o,(null===(s=i.rtpMap)||void 0===s?void 0:s.encodingName.toLowerCase())||"")&&(i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters["x-google-start-bitrate"]="".concat(A("X_GOOGLE_START_BITRATE")||Math.floor(r.bitrateMax)))})}function Ob(t){if("video"!==t.media.mediaType)return;const e=Tt();if(e.name!==It.SAFARI&&e.os!==we.IOS)return;const n=t.attributes.extmaps.findIndex(r=>/video-orientation/g.test(r.extensionName));-1!==n&&t.attributes.extmaps.splice(n,1)}function rl(t,e,n){if(!e)return;let r,i;if("video"===t.media.mediaType?(r=n.videoExtensions,i=n.videoCodecs):(r=n.audioExtensions,i=n.audioCodecs),!0===e.twcc){const o=r.find(s=>nl(s.extensionName));if(o){const s=o.extensionName;t.attributes.extmaps.find(c=>nl(c.extensionName))||t.attributes.extmaps.push({entry:o.entry,extensionName:s}),(c=i,d=t.attributes.payloads,d.filter(u=>!!c.find(l=>l.payloadType===u.payloadType&&!!l.rtcpFeedbacks.find(p=>"transport-cc"===p.type)))).forEach(c=>{c.rtcpFeedbacks.find(d=>"transport-cc"===d.type)||c.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(!1===e.twcc){const o=t.attributes.extmaps.findIndex(s=>nl(s.extensionName));-1!==o&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>"transport-cc"===c.type);-1!==a&&s.rtcpFeedbacks.splice(a,1)})}var c,d;if(!0===e.remb){const o=r.find(s=>vb(s.extensionName));if(o){const s=o.extensionName;t.attributes.extmaps.find(c=>c.extensionName===s)||t.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(c,d){return d.filter(u=>!!c.find(l=>l.payloadType===u.payloadType&&!!l.rtcpFeedbacks.find(p=>"goog-remb"===p.type)))}(i,t.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(d=>"goog-remb"===d.type)||c.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(!1===e.remb){const o=t.attributes.extmaps.findIndex(s=>vb(s.extensionName));-1!==o&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>"goog-remb"===c.type);-1!==a&&s.rtcpFeedbacks.splice(a,1)})}}function wb(t,e,n){if(ee()||"video"!==t.media.mediaType||!(e instanceof Kt)||"vp9"!==n&&"vp8"!==n||"vp8"===n&&!A("SIMULCAST")||"vp9"===n&&A("ENABLE_SVC")||void 0===e._scalabilityMode||e._scalabilityMode.numSpatialLayers<=1)return;const r="vp8"===n?2:e._scalabilityMode.numSpatialLayers,i=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find(a=>"FID"===a.semantic&&a.ssrcIds[0]===i.ssrcId),s={semantic:"SIM",ssrcIds:[i.ssrcId]};for(let a=1;a<r;a++)t.attributes.ssrcs.push({ssrcId:i.ssrcId+a,attributes:ae(i.attributes)}),s.ssrcIds.push(i.ssrcId+a),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:ae(i.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[i.ssrcId+a,o.ssrcIds[1]+a]}));t.attributes.ssrcGroups.unshift(s)}function Nb(){return QE.apply(this,arguments)}function QE(){return QE=y(function*(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const r=(yield n.createOffer()).sdp,{send:i,recv:o,sendrecv:s}=function(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const u=Tc(d,a,c,"sendonly"),l=Tc(d,a,c,"recvonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},S={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(vr(u,l,"videoExtensions",p,h,S),vr(u,l,"videoCodecs",p,h,S),vr(u,l,"audioExtensions",p,h,S),vr(u,l,"audioCodecs",p,h,S),A("RAISE_H264_BASELINE_PRIORITY")){const m=[],f=[];S.videoCodecs.forEach((g,R)=>{var C;if("h264"===(null===(C=g.rtpMap)||void 0===C?void 0:C.encodingName.toLocaleLowerCase())){var b,w;const D=S.videoCodecs[R+1],V=D&&Mb(g,D),U=null===(b=g.fmtp)||void 0===b?void 0:b.parameters["profile-level-id"],k=null===(w=g.fmtp)||void 0===w?void 0:w.parameters["packetization-mode"];!U||U!==A("FIRST_H264_PROFILE_LEVEL_ID")||A("FIRST_PACKETIZATION_MODE")&&k!==A("FIRST_PACKETIZATION_MODE")?f.push(V?[g,D]:[g]):m.push(V?[g,D]:[g])}}),m.length>0&&f.length>0&&(_.debug("raising H264 baseline profile priority"),S.videoCodecs.forEach((g,R)=>{var C;if("h264"===(null===(C=g.rtpMap)||void 0===C?void 0:C.encodingName.toLocaleLowerCase())){const b=Mb(g,S.videoCodecs[R+1]),w=m.shift()||f.shift()||[];w.length>0&&(b?S.videoCodecs.splice(R,2,...w):S.videoCodecs.splice(R,1,...w))}}),h.videoCodecs=h.videoCodecs.filter(g=>{var R,C;return!("h264"===(null===(R=g.rtpMap)||void 0===R?void 0:R.encodingName.toLocaleLowerCase())&&(null===(C=g.fmtp)||void 0===C?void 0:C.parameters["profile-level-id"])!==A("FIRST_H264_PROFILE_LEVEL_ID"))}),A("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter(g=>{var R,C;return!("h264"===(null===(R=g.rtpMap)||void 0===R?void 0:R.encodingName.toLocaleLowerCase())&&(null===(C=g.fmtp)||void 0===C?void 0:C.parameters["profile-level-id"])!==A("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:p,recv:h,sendrecv:S}}(t,e,r);try{n.close()}catch{}return{send:i,recv:o,sendrecv:s}}),QE.apply(this,arguments)}function Db(){const t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=Tc(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(vr(t,e,"videoExtensions",n,r,i),vr(t,e,"videoCodecs",n,r,i),vr(t,e,"audioExtensions",n,r,i),vr(t,e,"audioCodecs",n,r,i),A("RAISE_H264_BASELINE_PRIORITY")){const o=i.videoCodecs.findIndex(s=>s.rtpMap&&"h264"===s.rtpMap.encodingName.toLocaleLowerCase()&&s.fmtp&&"42001f"===s.fmtp.parameters["profile-level-id"]);if(-1!==o){const s=i.videoCodecs.findIndex(a=>a.rtpMap&&"h264"===a.rtpMap.encodingName.toLocaleLowerCase());if(s<o){_.debug("raising H264 baseline profile priority");const a=i.videoCodecs[o];i.videoCodecs.splice(o,1),i.videoCodecs.splice(s,0,a)}-1!==s&&(r.videoCodecs=r.videoCodecs.filter(a=>!(a.rtpMap&&"h264"===a.rtpMap.encodingName.toLocaleLowerCase()&&a.fmtp&&"42001f"!==a.fmtp.parameters["profile-level-id"])))}}return{send:n,recv:r,sendrecv:i}}function vr(t,e,n,r,i,o){if("videoExtensions"===n||"audioExtensions"===n){const s=[];return t[n].forEach(a=>{e[n].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return s.push(d),!0})?o[n].push(a):r[n].push(a)}),void e[n].forEach((a,c)=>{-1===s.indexOf(c)&&i[n].push(a)})}if("videoCodecs"===n||"audioCodecs"===n){const s=[];return t[n].forEach(a=>{e[n].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return s.push(d),!0})?o[n].push(a):r[n].push(a)}),void e[n].forEach((a,c)=>{-1===s.indexOf(c)&&i[n].push(a)})}}function il(t){const{send:e,recv:n,sendrecv:r}=t;if(!r){if(!e||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:n}}let i,o;return e?(i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i.audioCodecs=[...e.audioCodecs,...r.audioCodecs],i.videoCodecs=[...e.videoCodecs,...r.videoCodecs],i.audioExtensions=[...e.audioExtensions,...r.audioExtensions],i.videoExtensions=[...e.videoExtensions,...r.videoExtensions]):i=r,n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...r.audioCodecs],o.videoCodecs=[...n.videoCodecs,...r.videoCodecs],o.audioExtensions=[...n.audioExtensions,...r.audioExtensions],o.videoExtensions=[...n.videoExtensions,...r.videoExtensions]):o=r,{send:i,recv:o}}function ua(t){"audio"===t.media.mediaType&&t.attributes.payloads.filter(e=>{var n;return"opus"===(null===(n=e.rtpMap)||void 0===n?void 0:n.encodingName.toLowerCase())}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function Sc(t,e,n,r){let i=[];if(t===q.VIDEO){if(A("H264_PROFILE_LEVEL_ID")&&"h264"===r&&(i=e.videoCodecs.filter(o=>{var s;return W(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,r)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===A("H264_PROFILE_LEVEL_ID")})),!Array.isArray(i)||0===i.length){let o=[];const s=[],a=[],c=[];if(n.videoCodecs.forEach(d=>{const u=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";W(u).call(u,r)?o.push(d):W(u).call(u,"vp9")?s.push(d):W(u).call(u,"vp8")?a.push(d):W(u).call(u,"h264")&&c.push(d)}),0===o.length){let d="";0!==s.length?(o=s,d="vp9"):0!==a.length?(o=a,d="vp8"):0!==c.length&&(o=c,d="h264"),_.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}0!==o.length&&(i=e.videoCodecs.filter(d=>o.some(u=>u.payloadType===d.payloadType)))}if(0===i.length&&(_.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),i=e.videoCodecs),A("USE_PUB_RTX")||A("USE_SUB_RTX")){const o=ZE(i,e.videoCodecs);i=[...i,...o]}}else i=e.audioCodecs.filter(o=>{var s;return W(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,r)}),0===i.length&&(_.warning("codec ".concat(r," not included in rtpCapabilities, fallback to opus")),i=e.audioCodecs.filter(o=>{var s;return W(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,"opus")}));return i}function ZE(t,e){const n=t.map(r=>r.payloadType.toString());return e.filter(r=>r.rtpMap&&"rtx"===r.rtpMap.encodingName&&r.fmtp&&r.fmtp.parameters.apt&&W(n).call(n,r.fmtp&&r.fmtp.parameters.apt))}function ol(t,e,n){return $E.apply(this,arguments)}function $E(){return $E=y(function*(t,e,n){const r=e.toString(),i=Lb(r,"offer","remote","exchangeSDP");yield t.setRemoteDescription({type:"offer",sdp:r});const o=yield t.createAnswer();if(!o.sdp)throw new Error("cannot get answer sdp");let s=o.sdp;s=Pb(s,n||{}),i?.(s||""),yield t.setLocalDescription({type:"answer",sdp:s})}),$E.apply(this,arguments)}function Pb(t,e,n){const r=Fe.parse(t),{useXR:i}=e;return r.mediaDescriptions.forEach(o=>{var s;o.attributes.mid&&(Array.isArray(n)&&!W(n).call(n,o.attributes.mid)||("audio"===o.media.mediaType&&ua(o),i&&W(s=["audio","video"]).call(s,o.media.mediaType)&&o.attributes.payloads.forEach(a=>{-1===a.rtcpFeedbacks.findIndex(c=>"rrtr"===c.type)&&a.rtcpFeedbacks.push({type:"rrtr"})})))}),Fe.print(r)}function Lb(t,e,n,r){if(A("SDP_LOGGING"))return _.upload("exchanging ".concat(n," ").concat(e," SDP during P2PConnection.").concat(r,"\n"),t),"offer"===e?i=>{Lb(i,"answer","local"===n?"remote":"local",r)}:void 0}function kb(t){const e=A("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(e)&&e.length>0)&&e.some(n=>W(t).call(t,n))}function Mb(t,e){try{var n;return(null===(n=t.fmtp)||void 0===n?void 0:n.parameters.apt)===e.payloadType.toString()}catch{return!1}}function si(t,e){return typeof A(t)===e?A(t):void 0}function Ub(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function so(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Ub(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Ub(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const tm=new Map;class I3 extends Zt{get state(){return this._state}set state(e){if(e===this._state)return;const n=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(Ye.CONNECTION_STATE_CHANGE,e,n,this._disconnectedReason):this.emit(Ye.CONNECTION_STATE_CHANGE,e,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){_.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,n){super(),T(this,"store",void 0),T(this,"joinInfo",void 0),T(this,"key",void 0),T(this,"ntpOffset",0),T(this,"signal",void 0),T(this,"role",void 0),T(this,"inChannelInfo",{joinAt:null,duration:0}),T(this,"spec",void 0),T(this,"_state","DISCONNECTED"),T(this,"_statsCollector",void 0),T(this,"_disconnectedReason",void 0),T(this,"isSignalRecover",!1),T(this,"hasChangeBGPAddress",!1),T(this,"trafficStatsInterval",void 0),T(this,"networkQualityInterval",void 0),T(this,"_joinGatewayStartTime",0),T(this,"_signalTimeout",!1),T(this,"_clientRoleOptions",void 0),T(this,"_isProactiveJoin",!1),this.store=e,this.spec=n,this.signal=this.store.useP2P?new Tb(so(so({},n),{},{retryConfig:n.websocketRetryConfig}),e):new Jj(so(so({},n),{},{retryConfig:n.websocketRetryConfig}),e),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}join(e,n,r){var i=this;return y(function*(){i.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(i.hasChangeBGPAddress=!0);const o=Date.now();let s=tm.get(e.cname);if(s||(s=new Map,tm.set(e.cname,s)),i._isProactiveJoin=!0,s.has(e.uid)){const u=new N(v.UID_CONFLICT);throw Q.joinGateway(e.sid,{lts:o,succ:!1,ec:u.code,addr:null,uid:e.uid,cid:e.cid,firstSuccess:i._isProactiveJoin,avoidJoinStartTime:i.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:"0",preload:e.preload}),i._isProactiveJoin=!1,u}s.set(e.uid,!0),i.joinInfo=e,i.key=n;let a=0;i.joinGatewayStartTime=o;const c=e.proxyServer;try{_.debug("[".concat(i.store.clientId,"] use websocket join uid ").concat(a));const u=e.gatewayAddrs.map(l=>{let{address:p}=l;const[h,S]=p.split(":"),m={host:h,port:S};return e.proxyServer&&(m.proxy=e.proxyServer),m});a=(yield i.signal.init(u,r)).uid,_.debug("[".concat(i.store.clientId,"] websocket join uid ").concat(a," cost ").concat(Date.now()-i.joinGatewayStartTime))}catch(u){var d;throw _.error("[".concat(i.store.clientId,"] User join failed"),u.toString()),Q.joinGateway(e.sid,{lts:o,succ:!1,ec:(null===(d=u.data)||void 0===d?void 0:d.desc)||u.code,errorMsg:u.message,addr:i.signal.url,uid:e.uid,cid:e.cid,firstSuccess:i._isProactiveJoin,avoidJoinStartTime:i.store.avoidJoinStart,isProxy:!!c,signalChannel:"0",preload:e.preload}),i._isProactiveJoin=!1,s.delete(e.uid),i.signal.close(),u}return i.state="CONNECTED",i.inChannelInfo.joinAt=Date.now(),_.debug("[".concat(i.store.clientId,"] Connected to gateway server")),i.trafficStatsInterval=window.setInterval(()=>{i.updateTrafficStats().catch(u=>{_.warning("[".concat(i.store.clientId,"] get traffic stats error"),u.toString())})},3e3),i.networkQualityInterval=window.setInterval(()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?i.emit(Ye.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):i.emit(Ye.NETWORK_QUALITY,i._signalTimeout?{downlinkNetworkQuality:5,uplinkNetworkQuality:5}:"CONNECTED"===i.state&&i._statsCollector.trafficStats?{uplinkNetworkQuality:xC(i._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:xC(i._statsCollector.trafficStats.B_dnq)}:{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),i.store.joinGatewayEnd(),a})()}leave(){var e=arguments,n=this;return y(function*(){let r=e.length>0&&void 0!==e[0]&&e[0],i=e.length>1?e[1]:void 0;if("DISCONNECTED"!==n.state){i!==Ot.FALLBACK&&(n.state="DISCONNECTING");try{r||n.signal.connectionState!==jt.CONNECTED||(yield(o=n.signal.request(it.LEAVE,void 0,!0),H.race([o,YB(3e3)])))}catch(o){_.warning("[".concat(n.store.clientId,"] leave request failed, ignore"),o)}n.signal.close(i),i!==Ot.FALLBACK&&(n.state="DISCONNECTED"),n.reset()}var o})()}publish(e,n,r){var i=this;return y(function*(){if("CONNECTED"!==i.state&&"RECONNECTING"!==i.state)throw new N(v.INVALID_OPERATION,"can not publish when connection state is ".concat(i.state));const o={state:"offer",p2p_id:i.store.p2pId,ortc:n,mode:i.spec.mode,extend:A("PUB_EXTEND"),twcc:!!A("PUBLISH_TWCC"),rtx:!!A("USE_PUB_RTX")};try{return(yield i.signal.request(it.PUBLISH,o,!0))._message}catch(s){if(r&&s.data&&s.data.code===tt.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(i.store.clientId,"] receive publish error code, retry"),s.toString()),yield i.tryUnpubBeforeRepub(e,n),i.publish(e,n,!1);throw s}})()}publishDataChannel(e,n,r){var i=this;return y(function*(){var o;if("CONNECTED"!==i.state&&"RECONNECTING"!==i.state)throw new N(v.INVALID_OPERATION,"can not publish when connection state is ".concat(i.state));const s={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:null!==(o=n.maxRetransmits)&&void 0!==o?o:10,channel_id:n.channelId,metadata:n.metadata};try{yield i.signal.request(it.PUBLISH_DATASTREAM,s,!0)}catch(a){if(r&&a.data&&a.data.code===tt.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(i.store.clientId,"] receive publish datachannels error code, retry"),a.toString()),yield i.tryUnpubDataChannelBeforeRepub(e,n),i.publishDataChannel(e,n,!1);throw a}})()}unpublish(e,n){var r=this;return y(function*(){try{if("CONNECTED"!==r.state&&"RECONNECTING"!==r.state)throw new N(v.INVALID_OPERATION,"can not publish when connection state is ".concat(r.state));yield r.signal.request(it.UNPUBLISH,{stream_id:n,ortc:e},!0)}catch(i){_.warning("[".concat(r.store.clientId,"] unpublish warning: "),i)}})()}unpublishDataChannel(e){var n=this;return y(function*(){try{if("CONNECTED"!==n.state&&"RECONNECTING"!==n.state)throw new N(v.INVALID_OPERATION,"can not publish when connection state is ".concat(n.state));yield H.all(e.map(r=>n.signal.request(it.UNPUBLISH_DATASTREAM,{channel_id:r},!0)))}catch(r){_.warning("unpublish datachannels warning: ",r)}})()}presubscribe(e,n,r){var i=this;return y(function*(){if("CONNECTED"!==i.state&&"RECONNECTING"!==i.state)throw new N(v.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(i.state));const o={stream_id:e,stream_type:n,mode:i.spec.mode,codec:i.spec.codec,p2p_id:i.store.p2pId,twcc:!!A("SUBSCRIBE_TWCC"),rtx:!!A("USE_SUB_RTX")||void 0,extend:A("SUB_EXTEND"),svc:Array.isArray(A("SVC"))&&0!==A("SVC").length?A("SVC"):void 0};try{return yield i.signal.request(it.PRE_SUBSCRIBE,o,!0)}catch(s){if(r&&s.data&&s.data.code===tt.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(i.store.clientId,"] pre-subscribe error, retry"),s.toString()),i.presubscribe(e,n,!1);throw s}})()}subscribe(e,n,r){var i=this;return y(function*(){if("CONNECTED"!==i.state&&"RECONNECTING"!==i.state)throw new N(v.INVALID_OPERATION,"can not subscribe when connection state is ".concat(i.state));const o={stream_id:e,stream_type:n.stream_type,mode:i.spec.mode,codec:i.spec.codec,p2p_id:i.store.p2pId,twcc:!!A("SUBSCRIBE_TWCC"),rtx:!!A("USE_SUB_RTX"),extend:A("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(A("SVC"))&&0!==A("SVC").length?A("SVC"):void 0};try{return(yield i.signal.request(it.SUBSCRIBE,o,!0))._message}catch(s){if(r&&s.data&&s.data.code===tt.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(i.store.clientId,"] receiver subscribe error code, retry"),s.toString()),yield i.tryUnsubBeforeResub(e,n),yield i.subscribe(e,n,!1);throw s}})()}subscribeDataChannel(e,n,r){var i=this;return y(function*(){if("CONNECTED"!==i.state&&"RECONNECTING"!==i.state)throw new N(v.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(i.state));const o={uid:e,stream_id:n.id,channel_id:n.datachannelId};try{return void(yield i.signal.request(it.SUBSCRIBE_DATASTREAM,o,!0))}catch(s){if(r&&s.data&&s.data.code===tt.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(i.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),yield i.tryUnsubDataChannelBeforeResub(e,n),yield i.subscribeDataChannel(e,n,!1);throw s}})()}subscribeAll(e,n){var r=this;return y(function*(){if("CONNECTED"!==r.state&&"RECONNECTING"!==r.state)throw new N(v.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(r.state));const i={p2p_id:r.store.p2pId,users:e,dtx:!1,rtx:!!A("USE_SUB_RTX"),twcc:!!A("SUBSCRIBE_TWCC"),svc:Array.isArray(A("SVC"))&&0!==A("SVC").length?A("SVC"):void 0};try{return yield r.signal.request(it.SUBSCRIBE_STREAMS,i,!0)}catch(o){if(n&&o.data&&o.data.code===tt.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(r.store.clientId,"] receiver massSubscribe error code, retry"),o.toString()),yield r.tryMassUnsubBeforeResub(e),yield r.subscribeAll(e,!1);throw o}})()}setVideoProfile(e){var n=this;return y(function*(){const r=function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let o=i.frameRate,s=i.width,a=i.height,c=!0;return"number"!=typeof o&&(o=o.exact||o.ideal||o.max||o.min||0,o||(c=!1)),"number"!=typeof s&&(s=s.exact||s.ideal||s.max||s.min||0,s||(c=!1)),"number"!=typeof a&&(a=a.exact||a.ideal||a.max||a.min||0,o||(c=!1)),c?{stream_type:0,width:s,height:a,fps:o,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0}(e);if(r)return n.signal.request(it.SET_VIDEO_PROFILE,r);_.debug("[".concat(n.store.clientId,"] encoder config is not complete, do not report to gateway"))})()}unsubscribe(e,n){var r=this;return y(function*(){try{yield r.signal.request(it.UNSUBSCRIBE,{p2p_id:r.store.p2pId,ortc:e,stream_id:n},!0)}catch(i){_.warning("[".concat(r.store.clientId,"] unsubscribe warning: "),i)}})()}unsubscribeDataChannel(e,n){var r=this;return y(function*(){try{if("CONNECTED"!==r.state&&"RECONNECTING"!==r.state)throw new N(v.INVALID_OPERATION,"can not publish when connection state is ".concat(r.state));yield H.all(e.map(i=>r.signal.request(it.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:n},!0)))}catch(i){_.warning("unsubscribeDataChannel warning: ",i)}})()}massUnsubscribe(e){var n=this;return y(function*(){try{yield n.signal.request(it.UNSUBSCRIBE_STREAMS,e,!0)}catch(r){_.warning("[".concat(n.store.clientId,"] massUnsubscribeAll warning: "),r)}})()}reconnectPC(e){var n=this;return y(function*(){const{iceParameters:r,dtlsParameters:i,rtpCapabilities:o}=e;return{gatewayEstablishParams:yield n.signal.request(it.CONNECT_PC,{p2p_id:n.store.p2pId,stream_id:n.store.uid,ortc:{iceParameters:r,dtlsParameters:i,rtpCapabilities:o}},!0),gatewayAddress:n.getCurrentGatewayAddress()}})()}getGatewayInfo(){return this.signal.request(it.GATEWAY_INFO)}renewToken(e){var n=this;return y(function*(){yield n.signal.request(it.RENEW_TOKEN,e),n.key=e.token})()}setClientRole(e,n){var r=this;return y(function*(){if(n&&(r._clientRoleOptions=Object.assign({},n)),"CONNECTED"!==r.state)return void(r.role=e);let i,o=0;"audience"===e?r._clientRoleOptions&&r._clientRoleOptions.delay?(i=r._clientRoleOptions.delay,o=1):o=r._clientRoleOptions&&r._clientRoleOptions.level?r._clientRoleOptions.level:2:o=0,yield r.signal.request(it.SET_CLIENT_ROLE,{role:e,level:o,delay:i,client_ts:Date.now()}),r.role=e})()}setRemoteVideoStreamType(e,n){var r=this;return y(function*(){yield r.signal.request(it.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:n})})()}setDefaultRemoteVideoStreamType(e){var n=this;return y(function*(){yield n.signal.request(it.DEFAULT_VIDEO_STREAM,{stream_type:e})})()}setStreamFallbackOption(e,n){var r=this;return y(function*(){yield r.signal.request(it.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:n})})()}pickSVCLayer(e,n){var r=this;return y(function*(){yield r.signal.request(it.PICK_SVC_LAYER,{stream_id:e,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})})()}setRTM2Flag(e){var n=this;return y(function*(){yield n.signal.request(it.SET_RTM2_FLAG,{rtm2_flag:e})})()}sendExtensionMessage(e,n,r){var i=this;return y(function*(){if(i.signal instanceof Tb)return i.signal.sendExtensionMessage(e,n,r)})()}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),so({},this.inChannelInfo)}getGatewayVersion(){var e=this;return y(function*(){return(yield e.signal.request(it.GATEWAY_INFO)).version})()}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=tm.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(n){let r;return r=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),r?{username:Ke.username,password:Ke.password,turnServerURL:r[2],tcpport:parseInt(r[3])+30,udpport:parseInt(r[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(so(so({},Ke),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}updateTrafficStats(){var e=this;return y(function*(){if("CONNECTED"!==e.state)return;const n=yield e.signal.request(it.TRAFFIC_STATS,void 0,!0);n.timestamp=Date.now(),null!=n.ntp_offset&&(e.ntpOffset=n.ntp_offset),n.peer_delay.forEach(r=>{const i=e._statsCollector.trafficStats&&e._statsCollector.trafficStats.peer_delay.find(o=>o.peer_uid===r.peer_uid);i&&i.B_st!==r.B_st&&Iu(()=>{e.emit(Ye.STREAM_TYPE_CHANGE,r.peer_uid,r.B_st)})}),e._statsCollector.updateTrafficStats(n)})()}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new N(v.UNEXPECTED_ERROR,"can not generate join message, no join info");const n=Object.assign({},this.joinInfo.apResponse);let r=A("REPORT_APP_SCENARIO");if("string"!=typeof r)try{r=JSON.stringify(r)}catch{r=void 0}r&&r.length>128&&(r=void 0);const i=!(ee()||My(87)||gI())&&"boolean"==typeof A("ENABLE_PRE_SUB")&&A("ENABLE_PRE_SUB"),o=!gI()&&si("ENABLE_PREALLOC_PC","boolean"),s=so({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:tr,browser:navigator.userAgent,process_id:A("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:n,extend:A("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:r,attributes:{userAttributes:{enablePublishedUserList:A("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:A("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof A("SUBSCRIBE_AUDIO_FILTER_TOPN")?A("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof A("ENABLE_PUBLISH_AUDIO_FILTER")?A("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof A("ENABLE_USER_LICENSE_CHECK")?A("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===A("USE_PUB_RTX")||!0===A("USE_SUB_RTX")||void 0,disableFEC:A("DISABLE_FEC"),enableNTPReport:!!A("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!A("ENABLE_INSTANT_VIDEO")||void 0,enableFulllinkAvSync:!!A("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:si("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!A("ENABLE_AUT_FEEDBACK")||void 0,rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!A("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:si("USE_XR","boolean"),enableLossbasedBwe:si("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!A("ENABLE_AUT_CC")||void 0,enableCCFallback:si("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:o,preSubNum:i?si("PRE_SUB_NUM","number"):void 0,enablePubTWCC:si("PUBLISH_TWCC","boolean"),enableSubTWCC:si("SUBSCRIBE_TWCC","boolean"),enablePubRTX:si("USE_PUB_RTX","boolean"),enableSubRTX:si("USE_SUB_RTX","boolean"),enableSubSVC:A("ENABLE_SVC")?A("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(A("SVC"))&&0!==A("SVC").length?A("SVC"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(s.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(s.aes_mode=this.joinInfo.aesmode,A("ENCRYPT_AES")?(s.aes_secret=this.joinInfo.aespassword,s.aes_encrypt=!0):s.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(s.aes_salt=this.joinInfo.aessalt)),n.addresses[this.signal.websocket.currentURLIndex]&&(s.ap_response.ticket=n.addresses[this.signal.websocket.currentURLIndex].ticket,delete n.addresses),void 0!==this.joinInfo.defaultVideoStream&&(s.default_video_stream=this.joinInfo.defaultVideoStream),s}getRejoinMessage(){if(!this.joinInfo)throw new N(v.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){var e=this;this.signal.on(ot.WS_RECONNECT_CREATE_CONNECTION,n=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(ot.WS_RECONNECTING,n=>{this.joinInfo&&Q.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n||We.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",Q.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(ot.WS_CLOSED,n=>{let r;switch(n){case Ot.LEAVE:r=We.LEAVE;break;case Ot.UID_BANNED:case Ot.IP_BANNED:case Ot.CHANNEL_BANNED:case Ot.SERVER_ERROR:r=We.SERVER_ERROR;break;case Ot.FALLBACK:r=We.FALLBACK;break;case Ot.LICENSE_MISSING:case Ot.LICENSE_EXPIRED:case Ot.LICENSE_MINUTES_EXCEEDED:case Ot.LICENSE_PERIOD_INVALID:case Ot.LICENSE_MULTIPLE_SDK_SERVICE:case Ot.LICENSE_ILLEGAL:case Ot.TOKEN_EXPIRE:r=n;break;default:r=We.NETWORK_ERROR}_.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(r||"undefined -> "+We.NETWORK_ERROR)),this.joinInfo&&Q.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:n===Ot.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:r}),this._disconnectedReason=n,n!==Ot.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(ot.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(_.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),Q.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const n=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!n)return void _.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(n));Ut("EVENT_REPORT_DOMAIN",n[1]),Ut("EVENT_REPORT_BACKUP_DOMAIN",n[1]),Ut("LOG_UPLOAD_SERVER","".concat(n[1],":6444"))}}),this.signal.on(pt.ON_UPLINK_STATS,n=>{this._statsCollector.updateUplinkStats(n)}),this.signal.on(ot.REQUEST_RECOVER,(n,r,i)=>{if(!this.joinInfo)return i(new N(v.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));n&&(this.joinInfo.multiIP=n,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,He(this,Ye.REQUEST_NEW_GATEWAY_LIST).then(r).catch(i)}),this.signal.on(ot.REQUEST_JOIN_INFO,function(){var n=y(function*(r){var i;if(e.updateTurnConfigFromSignal(),e.store.useP2P)return void r(e.getJoinMessage({ortc:{}}));const{iceParameters:o,dtlsParameters:s,rtpCapabilities:a}=yield He(e,Ye.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(i=e.joinInfo)||void 0===i?void 0:i.turnServer});r(e.getJoinMessage({ortc:{iceParameters:o,dtlsParameters:s,rtpCapabilities:a,version:"2"}}))});return function(r){return n.apply(this,arguments)}}()),this.signal.on(ot.REQUEST_REJOIN_INFO,n=>{n(this.getRejoinMessage())}),this.signal.on(ot.REPORT_JOIN_GATEWAY,(n,r)=>{if(!this.joinInfo)return;let i,o="";var s;n instanceof N?(i=(null===(s=n.data)||void 0===s?void 0:s.desc)||n.code,o=n.message):i=n,Q.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:i,errorMsg:o,addr:r,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload}),this._isProactiveJoin=!1}),this.signal.on(ot.IS_P2P_DISCONNECTED,n=>{n(sc(this,Ye.IS_P2P_DISCONNECTED))}),this.signal.on(ot.DISCONNECT_P2P,()=>{this.emit(Ye.DISCONNECT_P2P)}),this.signal.on(ot.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(ot.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(ot.JOIN_RESPONSE,n=>{const r=this.getCurrentGatewayAddress();this.emit(Ye.JOIN_RESPONSE,n,r)}),this.signal.on(ot.PRE_CONNECT_PC,y(function*(){if(e.joinInfo){e.updateTurnConfigFromSignal();const n=e.getCurrentGatewayAddress(),r=A("FINGERPRINT")||e.joinInfo.apResponse.addresses[e.signal.currentURLIndex].fingerprint;if(n&&r){const i=bb(n);e.emit(Ye.PRE_CONNECT_PC,{candidates:i,fingerprint:r})}}})),this.signal.on(ot.RECOVER_NOTIFICATION,n=>{this.joinInfo&&"string"==typeof A("AP_REQUEST_DETAIL")&&(this.joinInfo.apRequestDetail="".concat(A("AP_REQUEST_DETAIL"),";").concat(n))})}tryUnsubBeforeResub(e,n){var r=this;return y(function*(){try{yield r.signal.request(it.UNSUBSCRIBE,{p2p_id:r.store.p2pId,stream_id:e,ortc:[n]},!0)}catch(i){throw _.warning("[".concat(r.store.clientId,"] tryUnsubBeforeResub warning"),i),i}})()}tryUnsubDataChannelBeforeResub(e,n){var r=this;return y(function*(){try{yield r.signal.request(it.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(i){throw _.warning("unsubscribe datachannel warning",i),i}})()}tryUnpubBeforeRepub(e,n){var r=this;return y(function*(){try{yield r.signal.request(it.UNPUBLISH,{stream_id:e,ortc:n},!0)}catch(i){throw _.warning("[".concat(r.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}})()}tryUnpubDataChannelBeforeRepub(e,n){var r=this;return y(function*(){try{yield r.signal.request(it.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(i){throw _.warning("unpublish datastream warning: ",i),i}})()}tryMassUnsubBeforeResub(e){var n=this;return y(function*(){const r={users:e.map(i=>({stream_id:i.stream_id,stream_type:i.stream_type}))};try{yield n.signal.request(it.UNSUBSCRIBE_STREAMS,r,!0)}catch(i){throw _.warning("[".concat(n.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}})()}muteLocal(e,n){var r=this;return y(function*(){const i={action:e.find(o=>o.stream_type===At.Audio)?"mute_local_audio":"mute_local_video",p2p_id:r.store.p2pId,ortc:e,stream_id:n};try{yield r.signal.request(it.CONTROL,i,!0,!0)}catch(o){throw _.warning("[".concat(r.store.clientId,"] gateway muteLocal warning: "),o),o}})()}unmuteLocal(e,n){var r=this;return y(function*(){const i={action:e.find(o=>o.stream_type===At.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:r.store.p2pId,ortc:e,stream_id:n};try{yield r.signal.request(it.CONTROL,i,!0,!0)}catch(o){throw _.warning("[".concat(r.store.clientId,"] gateway unmuteLocal warning: "),o),o}})()}muteRemote(e,n){var r=this;return y(function*(){const i={action:e===q.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:r.store.p2pId,stream_id:n};try{yield r.signal.request(it.CONTROL,i,!0,!0)}catch(o){throw _.warning("[".concat(r.store.clientId,"] gateway muteRemote warning: "),o),o}})()}unmuteRemote(e,n){var r=this;return y(function*(){const i={action:e===q.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:r.store.p2pId,stream_id:n};try{yield r.signal.request(it.CONTROL,i,!0,!0)}catch(o){throw _.warning("[".concat(r.store.clientId,"] gateway unmuteRemote warning: "),o),o}})()}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,n){this.signal.upload(e,n)}getSignalRTT(){return this.signal.rtt}restartICE(e){var n=this;return y(function*(){const r={p2p_id:n.store.p2pId,stream_id:n.store.uid,ortc:e};try{return yield n.signal.request(it.RESTART_ICE,r,!0)}catch(i){throw _.warning("[".concat(n.store.clientId,"] P2PChannel.restartICE warning: "),i),i}})()}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,We.P2P_FAILED)}getCurrentGatewayAddress(){var e,n;if(!A("GATEWAY_WSS_ADDRESS"))return A("USE_CANDIDATE_FROM_AP_DETAIL")&&null!==(e=this.joinInfo)&&void 0!==e&&e.apGatewayAddress?(_.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):null!==(n=this.joinInfo)&&void 0!==n&&n.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}setPublishAudioFilterEnabled(e){var n=this;return y(function*(){yield n.signal.request(it.SET_PARAMETER,{enablePublishAudioFilter:e})})()}}let sl=0,em=0;function Fr(t,e,n,r){return new H((i,o)=>{e.timeout=e.timeout||A("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),sl+=$r(e.data)):n&&(e.data.size?sl+=e.data.size:e.data instanceof FormData?sl+=nC(e.data):sl+=$r(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,hn.request(e).then(s=>{"string"==typeof s.data?em+=$r(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?em+=s.data.byteLength:em+=$r(JSON.stringify(s.data)),r&&i({data:s.data,headers:s.headers}),i(s.data)}).catch(s=>{hn.isCancel(s)?o(new N(v.OPERATION_ABORTED,"cancel token canceled")):o("ECONNABORTED"===s.code?new N(v.NETWORK_TIMEOUT,s.message):s.response?new N(v.NETWORK_RESPONSE_ERROR,s.response.status):new N(v.NETWORK_ERROR,s.message))})})}!function(){var t;function e(M){var B=0;return function(){return B<M.length?{done:!1,value:M[B++]}:{done:!0}}}var r,n="function"==typeof Object.defineProperties?Object.defineProperty:function(M,B,J){return M==Array.prototype||M==Object.prototype||(M[B]=J.value),M},i=function(M){M=["object"==typeof globalThis&&globalThis,M,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof cr&&cr];for(var B=0;B<M.length;++B){var J=M[B];if(J&&J.Math==Math)return J}throw Error("Cannot find global object")}(this);function o(M,B){if(B)t:{var J=i;M=M.split(".");for(var st=0;st<M.length-1;st++){var yt=M[st];if(!(yt in J))break t;J=J[yt]}(B=B(st=J[M=M[M.length-1]]))!=st&&null!=B&&n(J,M,{configurable:!0,writable:!0,value:B})}}function s(M){return(M={next:M})[Symbol.iterator]=function(){return this},M}function a(M){var B=typeof Symbol<"u"&&Symbol.iterator&&M[Symbol.iterator];return B?B.call(M):{next:e(M)}}if(o("Symbol",function(M){function B(yt,G){this.A=yt,n(this,"description",{configurable:!0,writable:!0,value:G})}if(M)return M;B.prototype.toString=function(){return this.A};var J="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",st=0;return function yt(G){if(this instanceof yt)throw new TypeError("Symbol is not a constructor");return new B(J+(G||"")+"_"+st++,G)}}),o("Symbol.iterator",function(M){if(M)return M;M=Symbol("Symbol.iterator");for(var B="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),J=0;J<B.length;J++){var st=i[B[J]];"function"==typeof st&&"function"!=typeof st.prototype[M]&&n(st.prototype,M,{configurable:!0,writable:!0,value:function(){return s(e(this))}})}return M}),"function"==typeof Object.setPrototypeOf)r=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}r=c?function(M,B){if(M.__proto__=B,M.__proto__!==B)throw new TypeError(M+" is not extensible");return M}:null}var u=r;function l(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(M){if(M.m)throw new TypeError("Generator is already running");M.m=!0}function h(M,B){return M.h=3,{value:B}}function S(M){this.g=new l,this.G=M}function m(M,B,J,st){try{var yt=B.call(M.g.j,J);if(!(yt instanceof Object))throw new TypeError("Iterator result "+yt+" is not an object");if(!yt.done)return M.g.m=!1,yt;var G=yt.value}catch(E){return M.g.j=null,M.g.s(E),f(M)}return M.g.j=null,st.call(M.g,G),f(M)}function f(M){for(;M.g.h;)try{var B=M.G(M.g);if(B)return M.g.m=!1,{value:B.value,done:!1}}catch(J){M.g.v=void 0,M.g.s(J)}if(M.g.m=!1,M.g.l){if(B=M.g.l,M.g.l=null,B.F)throw B.D;return{value:B.return,done:!0}}return{value:void 0,done:!0}}function g(M){this.next=function(B){return M.o(B)},this.throw=function(B){return M.s(B)},this.return=function(B){return function(J,st){p(J.g);var yt=J.g.j;return yt?m(J,"return"in yt?yt.return:function(G){return{value:G,done:!0}},st,J.g.return):(J.g.return(st),f(J))}(M,B)},this[Symbol.iterator]=function(){return this}}function R(M,B){return B=new g(new S(B)),u&&M.prototype&&u(B,M.prototype),B}if(l.prototype.o=function(M){this.v=M},l.prototype.s=function(M){this.l={D:M,F:!0},this.h=this.C||this.u},l.prototype.return=function(M){this.l={return:M},this.h=this.u},S.prototype.o=function(M){return p(this.g),this.g.j?m(this,this.g.j.next,M,this.g.o):(this.g.o(M),f(this))},S.prototype.s=function(M){return p(this.g),this.g.j?m(this,this.g.j.throw,M,this.g.o):(this.g.s(M),f(this))},o("Array.prototype.entries",function(M){return M||function(){return function(B,J){B instanceof String&&(B+="");var st=0,yt=!1,G={next:function(){if(!yt&&st<B.length){var E=st++;return{value:J(E,B[E]),done:!1}}return yt=!0,{done:!0,value:void 0}}};return G[Symbol.iterator]=function(){return G},G}(this,function(B,J){return[B,J]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var C=function(M,B){for(var J=0;J<M.length;J++)B(M[J])},b=function(M){return M.replace(/\r?\n|\r/g,"\r\n")},w=function(M,B,J){return B instanceof Blob?(B.name===(J=void 0!==J?J+"":"string"==typeof B.name?B.name:"blob")&&"[object Blob]"!==Object.prototype.toString.call(B)||(B=new File([B],J)),[String(M),B]):[String(M),String(B)]},D=function(M,B){if(M.length<B)throw new TypeError(B+" argument required, but only "+M.length+" present.")},V="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,U=V.FormData,k=V.XMLHttpRequest&&V.XMLHttpRequest.prototype.send,Z=V.Request&&V.fetch,$=V.navigator&&V.navigator.sendBeacon,Rt=V.Element&&V.Element.prototype,Nt=V.Symbol&&Symbol.toStringTag;Nt&&(Blob.prototype[Nt]||(Blob.prototype[Nt]="Blob"),"File"in V&&!File.prototype[Nt]&&(File.prototype[Nt]="File"));try{new File([],"")}catch{V.File=function(B,J,st){return B=new Blob(B,st||{}),Object.defineProperties(B,{name:{value:J},lastModified:{value:+(st&&void 0!==st.lastModified?new Date(st.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Nt&&Object.defineProperty(B,Nt,{value:"File"}),B}}var oe=function(M){return M.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Yt=function(M){this.i=[];var B=this;M&&C(M.elements,function(J){if(J.name&&!J.disabled&&"submit"!==J.type&&"button"!==J.type&&!J.matches("form fieldset[disabled] *"))if("file"===J.type){var st=J.files&&J.files.length?J.files:[new File([],"",{type:"application/octet-stream"})];C(st,function(yt){B.append(J.name,yt)})}else"select-multiple"===J.type||"select-one"===J.type?C(J.options,function(yt){!yt.disabled&&yt.selected&&B.append(J.name,yt.value)}):"checkbox"===J.type||"radio"===J.type?J.checked&&B.append(J.name,J.value):(st="textarea"===J.type?b(J.value):J.value,B.append(J.name,st))})};if((t=Yt.prototype).append=function(M,B,J){D(arguments,2),this.i.push(w(M,B,J))},t.delete=function(M){D(arguments,1);var B=[];M=String(M),C(this.i,function(J){J[0]!==M&&B.push(J)}),this.i=B},t.entries=function M(){var B,J=this;return R(M,function(st){if(1==st.h&&(B=0),3!=st.h)return B<J.i.length?st=h(st,J.i[B]):(st.h=0,st=void 0),st;B++,st.h=2})},t.forEach=function(M,B){D(arguments,1);for(var J=a(this),st=J.next();!st.done;st=J.next()){var yt=a(st.value);st=yt.next().value,yt=yt.next().value,M.call(B,yt,st,this)}},t.get=function(M){D(arguments,1);var B=this.i;M=String(M);for(var J=0;J<B.length;J++)if(B[J][0]===M)return B[J][1];return null},t.getAll=function(M){D(arguments,1);var B=[];return M=String(M),C(this.i,function(J){J[0]===M&&B.push(J[1])}),B},t.has=function(M){D(arguments,1),M=String(M);for(var B=0;B<this.i.length;B++)if(this.i[B][0]===M)return!0;return!1},t.keys=function M(){var B,J,G=this;return R(M,function(E){if(1==E.h&&(B=a(G),J=B.next()),3!=E.h)return J.done?void(E.h=0):h(E,a(J.value).next().value);J=B.next(),E.h=2})},t.set=function(M,B,J){D(arguments,2),M=String(M);var st=[],yt=w(M,B,J),G=!0;C(this.i,function(E){E[0]===M?G&&(G=!st.push(yt)):st.push(E)}),G&&st.push(yt),this.i=st},t.values=function M(){var B,J,yt,G=this;return R(M,function(E){if(1==E.h&&(B=a(G),J=B.next()),3!=E.h)return J.done?void(E.h=0):((yt=a(J.value)).next(),h(E,yt.next().value));J=B.next(),E.h=2})},Yt.prototype._asNative=function(){for(var M=new U,B=a(this),J=B.next();!J.done;J=B.next()){var st=a(J.value);J=st.next().value,st=st.next().value,M.append(J,st)}return M},Yt.prototype._blob=function(){var M="----formdata-polyfill-"+Math.random(),B=[],J="--"+M+'\r\nContent-Disposition: form-data; name="';return this.forEach(function(st,yt){return"string"==typeof st?B.push(J+oe(b(yt))+'"\r\n\r\n'+b(st)+"\r\n"):B.push(J+oe(b(yt))+'"; filename="'+oe(st.name)+'"\r\nContent-Type: '+(st.type||"application/octet-stream")+"\r\n\r\n",st,"\r\n")}),B.push("--"+M+"--"),new Blob(B,{type:"multipart/form-data; boundary="+M})},Yt.prototype[Symbol.iterator]=function(){return this.entries()},Yt.prototype.toString=function(){return"[object FormData]"},Rt&&!Rt.matches&&(Rt.matches=Rt.matchesSelector||Rt.mozMatchesSelector||Rt.msMatchesSelector||Rt.oMatchesSelector||Rt.webkitMatchesSelector||function(M){for(var B=(M=(this.document||this.ownerDocument).querySelectorAll(M)).length;0<=--B&&M.item(B)!==this;);return-1<B}),Nt&&(Yt.prototype[Nt]="FormData"),k){var wr=V.XMLHttpRequest.prototype.setRequestHeader;V.XMLHttpRequest.prototype.setRequestHeader=function(M,B){wr.call(this,M,B),"content-type"===M.toLowerCase()&&(this.B=!0)},V.XMLHttpRequest.prototype.send=function(M){M instanceof Yt?(M=M._blob(),this.B||this.setRequestHeader("Content-Type",M.type),k.call(this,M)):k.call(this,M)}}Z&&(V.fetch=function(M,B){return B&&B.body&&B.body instanceof Yt&&(B.body=B.body._blob()),Z.call(this,M,B)}),$&&(V.navigator.sendBeacon=function(M,B){return B instanceof Yt&&(B=B._asNative()),$.call(this,M,B)}),V.FormData=Yt}}();const Rc=()=>{const t=A("AREAS");return 0===t.length&&t.push(vt.GLOBAL),Nr(t).call(t,(e,n,r)=>{const i=xb(n);return i?0===r?i:"".concat(e,",").concat(i):e},"")},xb=t=>t===vt.OVERSEA?"".concat(Xe.ASIA,",").concat(Xe.EUROPE,",").concat(Xe.AFRICA,",").concat(Xe.NORTH_AMERICA,",").concat(Xe.SOUTH_AMERICA,",").concat(Xe.OCEANIA):Xe[t],A3=t=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map(n=>{const r=Mu[n],i=Object.keys(r);i&&i.map(o=>{"CODE"!==o&&(e[o]=e[o].concat(r[o]))})}),e},al={GLOBAL:{ASIA:[vt.CHINA,vt.JAPAN,vt.INDIA,vt.KOREA,vt.HKMC],EUROPE:[],NORTH_AMERICA:[vt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},cl=Object.keys(al[vt.GLOBAL]),nm=[vt.CHINA,vt.NORTH_AMERICA,vt.EUROPE,vt.ASIA,vt.JAPAN,vt.INDIA,vt.OCEANIA,vt.SOUTH_AMERICA,vt.AFRICA,vt.KOREA,vt.HKMC,vt.US],b3=function(t,e){let n=[];if(W(t).call(t,vt.GLOBAL)){const o=[vt.GLOBAL,vt.OVERSEA],s=Object.keys(Mu);if(e===vt.GLOBAL)throw new N(v.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===vt.CHINA)n=[vt.OVERSEA];else if(i=e,W(cl).call(cl,i)){const a=al[vt.GLOBAL][e]||[],c=[...o,e,...a];n=s.filter(d=>!W(c).call(c,d))}else if(function(a){let c=!1;return cl.forEach(d=>{var u;W(u=al[vt.GLOBAL][d]).call(u,a)&&(c=!0)}),c}(e)){const a=function(d){let u;return cl.forEach(l=>{var p;W(p=al[vt.GLOBAL][l]).call(p,d)&&(u=l)}),u}(e),c=[...o,a,e];n=s.filter(d=>!W(c).call(c,d))}else n=t;n=function(a){const c=[];return nm.forEach(d=>{W(a).call(a,d)&&c.push(d)}),c.concat(a.filter(d=>!W(nm).call(nm,d)))}(n)}else n=t;var i;return n};function Vb(t){var e,n;if(!t&&W(e=A("AREAS")).call(e,vt.EXTENSIONS))return _.debug("update area from ap : reset"),void rm(nj,!0);if(!W(n=A("AREAS")).call(n,vt.GLOBAL)||!t)return;let r=Mu.EXTENSIONS;r&&(r={CODE:xb(vt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},_.debug("update area from ap success: ".concat(t,",config is "),r),Ut("AREAS",[vt.EXTENSIONS],!0),Object.keys(r).map(i=>{Ut(i,"LOG_UPLOAD_SERVER"===i||"EVENT_REPORT_DOMAIN"===i||"EVENT_REPORT_BACKUP_DOMAIN"===i||"PROXY_SERVER_TYPE3"===i?r[i][0]:r[i])}))}function rm(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=Q.reportApiInvoke(null,{name:ye.SET_AREA,options:t,tag:ne.TRACER});try{let r=[];if("string"==typeof t&&(r=[t]),Array.isArray(t)&&(t.forEach(o=>{if(!W(AC).call(AC,o))throw new N(v.INVALID_PARAMS,"invalid area code")}),r=t),"[object Object]"===Object.prototype.toString.call(t)){const{areaCode:o,excludedArea:s}=t;if(!o)throw new N(v.INVALID_PARAMS,"area code is needed");let a=o;"string"==typeof o&&(a=[o]),r=s?b3(a,s):a}if(!e){if($i.AREAS){const o=new N(v.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(o),void _.warning("setArea is prohibited because of config-distribute")}if(W(r).call(r,vt.GLOBAL)&&A("AREAS")===vt.EXTENSIONS){const o=new N(v.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(o),void _.warning("setArea is prohibited because of ap extensions")}}Ut("AREAS",r,e);const i=A3(r);Object.keys(i).map(o=>{Ut(o,"LOG_UPLOAD_SERVER"===o||"EVENT_REPORT_DOMAIN"===o||"EVENT_REPORT_BACKUP_DOMAIN"===o||"PROXY_SERVER_TYPE3"===o?i[o][0]:i[o])}),_.debug("set area success:",r.join(","))}catch(r){throw n.onError(r),r}n.onSuccess()}function Fb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function dl(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Fb(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Fb(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let im=1;let om=1;function Bb(t,e,n,r){let{url:i,areaCode:o}=t;const{clientId:s,sid:a}=e,c=Date.now();let d;const[u,l]=am(e,o,[Ee.CHOOSE_SERVER]);let p=_e.networkState;return Mr(y(function*(){p&&_e.networkState===An.OFFLINE&&_e.onlineWaiter&&(yield H.race([_e.onlineWaiter,Me(r&&r.maxRetryTimeout||Se.maxRetryTimeout)])),p=_e.networkState;const{data:h,headers:S}=yield Fr(i,{data:u,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d="1"===S.http3?1:-1,Q.reportResourceTiming(i,a),Gb(h,i,e,c,[Ee.CHOOSE_SERVER],d);const m=lc(h,Ee.CHOOSE_SERVER);return sm(m),rE(m,i)}),h=>(h&&Q.joinChooseServer(a,{lts:c,succ:!0,csAddr:i,opid:l,serverList:h.gatewayAddrs.map(S=>S.address),ec:null,cid:h.cid.toString(),uid:h.uid.toString(),csIp:h.csIp,unilbsServerIds:[Ee.CHOOSE_SERVER].toString(),isHttp3:d,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:h.res.detail&&h.res.detail[38]}),!1),h=>h.code!==v.OPERATION_ABORTED&&(h.code===v.CAN_NOT_GET_GATEWAY_SERVER?h.data.retry:(Q.joinChooseServer(a,{lts:c,succ:!1,csAddr:i,serverList:null,opid:l,ec:h.code,csIp:h.data&&h.data.csIp,unilbsServerIds:[Ee.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:d,corssRegionTagReq:e.apRequestDetail}),_.warning("[".concat(s||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),h),!0)),r)}function jb(t,e,n,r){let i,{url:o,areaCode:s,serviceIds:a}=t;const c=Date.now(),[d,u]=am(e,s,a);let l;return Mr(y(function*(){l&&_e.networkState===An.OFFLINE&&_e.onlineWaiter&&(yield H.race([_e.onlineWaiter,Me(r&&r.maxRetryTimeout||Se.maxRetryTimeout)])),l=_e.networkState;const{data:p,headers:h}=yield Fr(o,{data:d,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);i="1"===h.http3?1:-1,Q.reportResourceTiming(o,e.sid),Gb(p,o,e,c,a,i);const S=lc(p,Ee.CHOOSE_SERVER),m=lc(p,"proxy5"===e.cloudProxyServer?Ee.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?Ee.CLOUD_PROXY:Ee.CLOUD_PROXY_FALLBACK);return sm(S),{gatewayInfo:rE(S,o),proxyInfo:m,url:o}}),p=>(p.gatewayInfo&&Q.joinChooseServer(e.sid,{lts:c,succ:!0,csAddr:o,serverList:p.gatewayInfo.gatewayAddrs.map(h=>h.address),ec:null,opid:u,cid:p.gatewayInfo.cid.toString(),uid:p.gatewayInfo.uid.toString(),csIp:p.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:i,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:p.gatewayInfo.res.detail&&p.gatewayInfo.res.detail[38]}),p.proxyInfo&&Q.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:p.proxyInfo.addresses.map(h=>h.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1),p=>p.code!==v.OPERATION_ABORTED&&(p.code===v.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(Q.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:p.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:l})}),_.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),p),!0)),r)}const Gb=(t,e,n,r,i,o)=>{const{sid:s,clientId:a,cloudProxyServer:c}=n,d=[],u=l=>{4096===l.flag?Q.joinChooseServer(s,{lts:r,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:l.error.message,csIp:l.error.data&&l.error.data.csIp,unilbsServerIds:i.toString(),isHttp3:o,corssRegionTagReq:n.apRequestDetail}):1048576!==l.flag&&4194304!==l.flag&&4194310!==l.flag||Q.joinWebProxyAP(s,{lts:r,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:l.error.code,eventType:c,unilbsServerIds:i.toString()})};if(t.response_body.forEach(l=>{const p=l.buffer.code;if(23===l.uri&&0===p&&!l.buffer.edges_services)if(4194310===l.buffer.flag)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),l.buffer.edges_services=[];else{const h={error:new N(v.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:l.buffer.flag};d.push(h),u(h)}if(0!==p){const h=Ws(p),S={error:new N(v.CAN_NOT_GET_GATEWAY_SERVER,h.desc,{desc:h.desc,retry:h.retry,csIp:t.detail[502]}),flag:l.buffer.flag};4194310===l.buffer.flag?_.warning(S.error.toString()):d.push(S),u(S)}}),d.length)throw _.warning("[".concat(a||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(d.map(l=>"flag: ".concat(l.flag,", message: ").concat(l.error.message,", retry: ").concat(l.error.data.retry)).join(" | "))),new N(v.CAN_NOT_GET_GATEWAY_SERVER,d.map(l=>"flag: ".concat(l.flag,", message: ").concat(l.error.message)).join(" | "),{retry:!!d.find(l=>l.error.data.retry),csIp:t.detail[502],desc:[...new Set(d.map(l=>{var p;return null==l||null===(p=l.error)||void 0===p||null===(p=p.data)||void 0===p?void 0:p.desc}).filter(l=>!!l))]})},sm=t=>{var e,n,r,i;if(t.addresses&&0===t.addresses.length&&0===t.code)throw new N(v.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(A("AP_AREA")&&(null!==(r=t.detail)&&void 0!==r&&r[23]&&"string"==typeof(null===(i=t.detail)||void 0===i?void 0:i[23])?Vb(t.detail[23].toLowerCase()):Vb()),null!==(e=t.detail)&&void 0!==e&&e[19]&&"string"==typeof(null===(n=t.detail)||void 0===n?void 0:n[19])){const s=t.detail[19],a=s?.split(";");for(let c=0;c<a.length;c++){var o;const d=$e(o=a[c]).call(o);t.addresses[c]&&a&&(t.addresses[c].fingerprint=d)}}if(A("GATEWAY_ADDRESS")&&A("GATEWAY_ADDRESS").length>0){_.debug("assign gateway address to",A("GATEWAY_ADDRESS"));const s=A("GATEWAY_ADDRESS").map(a=>{var c,d;const u=null!==(c=null===(d=t.addresses.find(l=>l.ip===a.ip&&l.port===a.port))||void 0===d?void 0:d.fingerprint)&&void 0!==c?c:"";return{ip:a.ip,port:a.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:u}});t.addresses=s}},w3=(t,e)=>{if(t.response_body&&t.response_body.length){const n=t.response_body[0];if(0!==n.buffer.code){const r=Ws(n.buffer.code);throw new N(v.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(r.desc),{retry:r.retry})}return n.buffer.ticket}throw _.debug("update ticket request received ap response without response body:",e),new N(v.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},am=(t,e,n)=>{const r=Math.floor(1e12*Math.random()),i={appid:t.appId,client_ts:Date.now(),opid:r,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:dl(dl({6:t.stringUid,11:e,12:A("USE_NEW_TOKEN")?"1":void 0,22:e},t.apRequestDetail?{33:t.apRequestDetail}:{}),t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:n,uid:t.uid||0}}]};i.request_bodies.forEach(s=>{t.multiIP&&t.multiIP.gateway_ip&&(s.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))});const o=new FormData;return o.append("request",JSON.stringify(i)),[o,r]},N3=(t,e)=>{const n=Math.floor(1e12*Math.random()),r={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},i=new FormData;return i.append("request",JSON.stringify(r)),[i,n]};let la=0;function pa(t){return H.all(t.map(e=>e.then(n=>{throw n},n=>n))).then(e=>{throw e},e=>e)}const vc=function(){var t=y(function*(e){let{fragementLength:n,referenceList:r,asyncMapHandler:i,allFailedhandler:o,promisesCollector:s}=e,a=0;const c=n;let d,u=0;const l=function(){var p=y(function*(){const h=(()=>{const S=a*c;return r.slice(S,S+c).map(i)})();s&&s.push(...h);try{d=yield pa(h)}catch(S){if(u+=c,a++,!(u>=r.length))return void(yield l());o(S)}h.forEach(S=>S.cancel())});return function(){return p.apply(this,arguments)}}();return yield l(),d});return function(n){return t.apply(this,arguments)}}(),Wb=function(){var t=y(function*(e){let{referenceList:n,asyncMapHandler:r,closeFn:i}=e;const o=n.length;let s=0;const a=function(){var c=y(function*(){const d=r(n.shift());try{return yield d}catch(u){if(s++,s>=o||null!=i&&i(u))throw u;return a()}});return function(){return c.apply(this,arguments)}}();return a()});return function(n){return t.apply(this,arguments)}}();function cm(t,e,n,r){return dm.apply(this,arguments)}function dm(){return dm=y(function*(t,e,n,r){return{gatewayInfo:yield(o=y(function*(s,a,c,d){let u=null;const l=[],p=function(){var S=y(function*(){const m=A("WEBCS_DOMAIN").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(R=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(R+"/api/v2/transpond/webrtc?v=2"):"https://".concat(R,"/api/v2/transpond/webrtc?v=2"),areaCode:Rc()})),f=d.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(R=>R.url)}),g=yield vc({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:R=>(_.debug("[".concat(s.clientId,"] Connect to choose_server:"),R.url),Bb(R,s,a,c)),allFailedhandler:R=>{throw d.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},f),R[0]},promisesCollector:l});return d.recordJoinChannelService({endTs:Date.now(),status:"success"},f),g});return function(){return S.apply(this,arguments)}}(),h=function(){var S=y(function*(){if(yield Me(1e3),null!==u)return u;const m=A("WEBCS_DOMAIN_BACKUP_LIST").map(R=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(R+"/api/v2/transpond/webrtc?v=2"):"https://".concat(R,"/api/v2/transpond/webrtc?v=2"),areaCode:Rc()})),f=d.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:m.map(R=>R.url)}),g=yield vc({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:m,asyncMapHandler:R=>(_.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),R.url),Bb(R,s,a,c)),allFailedhandler:R=>{throw d.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},f),R[0]},promisesCollector:l});return d.recordJoinChannelService({endTs:Date.now(),status:"success"},f),g});return function(){return S.apply(this,arguments)}}();try{return u=yield pa([p(),h()]),l.length&&l.forEach(S=>S.cancel&&"function"==typeof S.cancel&&S.cancel()),u}catch(S){throw S[0]}}),function(s,a,c,d){return o.apply(this,arguments)})(t,e,n,r)};var o}),dm.apply(this,arguments)}function Hb(t,e,n,r,i){return um.apply(this,arguments)}function um(){return um=y(function*(t,e,n,r,i){const o=t.cloudProxyServer;if("disabled"===o){if(!r)return;if(t.useLocalAccessPoint)return yield cm(t,e,n,i);if(A("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:p,proxyInfo:h}=yield qb(t,e,n,i);if(t.turnServer&&"auto"!==t.turnServer.mode)return{gatewayInfo:p};const S=h.map(m=>({turnServerURL:m.address,tcpport:m.tcpport||Ke.tcpport,udpport:m.udpport||Ke.udpport,username:m.username||Ke.username,password:m.password||Ke.password,forceturn:!1,security:!0}));if(i.useP2P){var s;const m=null!==(s=t.uid)&&void 0!==s?s:p.uid,f="glb:".concat(m.toString()),g=yield k_(f),R=h.map(C=>({turnServerURL:C.address,tcpport:C.tcpport||Ke.tcpport,udpport:C.udpport||Ke.udpport,username:f,password:g,forceturn:!1,security:!0}));S.push(...R)}return t.turnServer={mode:"manual",servers:S},{gatewayInfo:p}}return yield cm(t,e,n,i)}const{proxyInfo:a,gatewayInfo:c}=yield qb(t,e,n,i),d={gatewayInfo:c},u=a.map(p=>({turnServerURL:p.address,tcpport:"proxy3"===o?void 0:p.tcpport?p.tcpport:Ke.tcpport,udpport:"proxy4"===o?void 0:p.udpport?p.udpport:Ke.udpport,username:p.username||Ke.username,password:p.password||Ke.password,forceturn:"proxy4"!==o,security:"proxy5"===o}));if(i.useP2P){var l;const p=null!==(l=t.uid)&&void 0!==l?l:c.uid,h="glb:".concat(p.toString()),S=yield k_(h),m=a.map(f=>({turnServerURL:f.address,tcpport:"proxy3"===o?void 0:f.tcpport||Ke.tcpport,udpport:"proxy4"===o?void 0:f.udpport||Ke.udpport,username:h,password:S,forceturn:"proxy4"!==o,security:"proxy5"===o}));u.push(...m)}return t.turnServer={mode:"manual",servers:u},_.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),d}),um.apply(this,arguments)}function Kb(t,e,n,r,i){return lm.apply(this,arguments)}function lm(){return lm=y(function*(t,e,n,r,i){let s=[];s=A("ACCOUNT_REGISTER").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(e.proxyServer?c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1"):c=>"https://".concat(c,"/api/v1"));const a=i?.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{const c=yield(d=y(function*(u,l,p,h,S){const m=Date.now(),f={sid:p.sid,opid:10,appid:p.appId,string_uid:l};let g=u[0];const R=yield Mr(()=>Fr(g+"".concat(-1===g.indexOf("?")?"?":"&","action=stringuid"),{data:f,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(C,b)=>{if(0===C.code){if(C.uid<=0||C.uid>=Math.pow(2,32))throw _.error("Invalid Uint Uid ".concat(l," => ").concat(C.uid),C),Q.reqUserAccount(f.sid,{lts:m,success:!1,serverAddr:g,stringUid:f.string_uid,uid:C.uid,errorCode:v.INVALID_UINT_UID_FROM_STRING_UID,extend:f}),new N(v.INVALID_UINT_UID_FROM_STRING_UID);return Q.reqUserAccount(f.sid,{lts:m,success:!0,serverAddr:g,stringUid:f.string_uid,uid:C.uid,errorCode:null,extend:f}),!1}const w=Ws(C.code);return w.retry&&(g=u[(b+1)%u.length]),Q.reqUserAccount(f.sid,{lts:m,success:!1,serverAddr:g,stringUid:f.string_uid,uid:C.uid,errorCode:w.desc,extend:f}),w.retry},(C,b)=>C.code!==v.OPERATION_ABORTED&&(Q.reqUserAccount(f.sid,{lts:m,success:!1,serverAddr:g,stringUid:f.string_uid,uid:null,errorCode:C.code,extend:f}),g=u[(b+1)%u.length],!0),S);if(0!==R.code){const C=Ws(R.code);throw new N(v.UNEXPECTED_RESPONSE,C.desc)}return R}),function(u,l,p,h,S){return d.apply(this,arguments)})(s,t,e,n,r);return i?.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw i?.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}var d}),lm.apply(this,arguments)}function D3(t,e,n){return pm.apply(this,arguments)}function pm(){return pm=y(function*(t,e,n){let i=[];i=A("ACCOUNT_REGISTER").map(e.proxyServer?o=>"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1"):o=>"https://".concat(o,"/api/v1"));try{return yield Wb({referenceList:i,asyncMapHandler:s=>{return(a=y(function*(c,d,u,l){const p=Date.now(),h={sid:u.sid,opid:10,appid:u.appId,string_uid:d};try{const S=yield Fr(c+"".concat(-1===c.indexOf("?")?"?":"&","action=stringuid"),{data:h,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(0!==S.code){const m=Ws(S.code);throw new N(v.UNEXPECTED_RESPONSE,"preload sua error:".concat(m.desc),m)}if(S.uid<=0||S.uid>=Math.pow(2,32))throw new N(v.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:p,url:c,req:h,uid:S.uid,elapse:Date.now()-p}}catch(S){throw S}}),function(c,d,u,l){return a.apply(this,arguments)})(s,t,e,n);var a},closeFn:s=>s.code===v.OPERATION_ABORTED||s.code===v.UNEXPECTED_RESPONSE&&!s.data.retry})}catch(o){throw o}}),pm.apply(this,arguments)}function hm(){return hm=y(function*(t,e,n){const i=A("CDS_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config")).map(c=>function(d,u,l,p){const h=Tt(),S={flag:64,cipher_method:0,features:{device:h.name,system:h.os,system_general:navigator.userAgent,vendor:u.appId,version:tr,cname:u.cname,sid:u.sid,session_id:u.sid,detail:"",proxyServer:u.proxyServer}};return Mr(()=>Fr(d,{data:S,timeout:1e3,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,m=>m.code!==v.OPERATION_ABORTED,p)}(c,t,e,n));let o=null,s=null,a={};try{o=yield pa(i)}catch(c){if(c.code===v.OPERATION_ABORTED)throw c;s=c}if(i.forEach(c=>c.cancel()),Q.reportApiInvoke(t.sid,{name:ye.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(c){if(!c.test_tags)return{};const d=c.test_tags,u=Object.keys(d),l={};return u.forEach(p=>{var h;const S=$e(h=p.slice(4)).call(h),m=JSON.parse(d[p])[1];l[S]=m}),l}(o)}catch{}return a}),hm.apply(this,arguments)}function Yb(t,e){return _m.apply(this,arguments)}function _m(){return _m=y(function*(t,e){const n=A("WEBCS_DOMAIN").concat(A("WEBCS_DOMAIN_BACKUP_LIST")).map(r=>({url:"https://".concat(r,"/api/v2/transpond/webrtc?v=2"),areaCode:Rc(),serviceIds:[Ee.CHOOSE_SERVER,Ee.CLOUD_PROXY_FALLBACK]}));try{return yield Wb({referenceList:n,asyncMapHandler:i=>{return(o=y(function*(s,a,c){let d,{url:u,areaCode:l,serviceIds:p}=s;const h=Date.now(),[S,m]=am(a,l,p);let f=_e.networkState;try{f&&_e.networkState===An.OFFLINE&&_e.onlineWaiter&&(yield H.race([_e.onlineWaiter,Me(Se.maxRetryTimeout)])),f=_e.networkState;const{data:g,headers:R}=yield Fr(u,{data:S,cancelToken:c,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d="1"===R.http3?1:-1,(D=>{const V=[];if(D.response_body.forEach(U=>{const k=U.buffer.code;if(23===U.uri&&0===k&&!U.buffer.edges_services)if(4194310===U.buffer.flag)U.buffer.edges_services=[];else{const Z={error:new N(v.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:D.detail[502]}),flag:U.buffer.flag};V.push(Z)}if(0!==k){const Z=Ws(k),$={error:new N(v.CAN_NOT_GET_GATEWAY_SERVER,Z.desc,{desc:Z.desc,retry:Z.retry,csIp:D.detail[502]}),flag:U.buffer.flag};4194310===U.buffer.flag?_.warning($.error.toString()):V.push($)}}),V.length)throw new N(v.CAN_NOT_GET_GATEWAY_SERVER,V.map(U=>"flag: ".concat(U.flag,", message: ").concat(U.error.message)).join(" | "),{retry:!!V.find(U=>U.error.data.retry),csIp:D.detail[502],desc:[...new Set(V.map(U=>{var k;return null==U||null===(k=U.error)||void 0===k||null===(k=k.data)||void 0===k?void 0:k.desc}).filter(U=>!!U))]})})(g);const b=lc(g,Ee.CHOOSE_SERVER),w=lc(g,Ee.CLOUD_PROXY_FALLBACK);return sm(b),{gatewayInfo:rE(b,u),proxyInfo:w,opid:m,requestTime:h,url:u,isHttp3:d,elapse:Date.now()-h}}catch(g){throw g}}),function(s,a,c){return o.apply(this,arguments)})(i,t,e);var o},closeFn:i=>i.code===v.OPERATION_ABORTED||i.code===v.CAN_NOT_GET_GATEWAY_SERVER&&!i.data.retry})}catch(r){throw r}}),_m.apply(this,arguments)}function qb(t,e,n,r){return Em.apply(this,arguments)}function Em(){return Em=y(function*(t,e,n,r){const i=A("PROXY_SERVER_TYPE3"),o=(h,S,m)=>{let f=m||i;return Array.isArray(f)&&(f=S%2==0?i[1]:i[0]),"https://".concat(f,"/ap/?url=").concat(h)};let s=null;const a=[],c=function(){var h=y(function*(){const S=A("WEBCS_DOMAIN").slice(0,A("AJAX_REQUEST_CONCURRENT")).map((g,R)=>{let C;return C="disabled"===t.cloudProxyServer&&t.proxyServer?o("".concat(g,"/api/v2/transpond/webrtc?v=2"),R,t.proxyServer):"disabled"===t.cloudProxyServer||"fallback"===t.cloudProxyServer?"https://".concat(g,"/api/v2/transpond/webrtc?v=2"):o("".concat(g,"/api/v2/transpond/webrtc?v=2"),R),{url:C,areaCode:Rc(),serviceIds:[Ee.CHOOSE_SERVER,"proxy5"===t.cloudProxyServer?Ee.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?Ee.CLOUD_PROXY:Ee.CLOUD_PROXY_FALLBACK]}}),m=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:S.map(g=>g.url)}),f=yield vc({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:S,asyncMapHandler:g=>(_.debug("[".concat(t.clientId,"] Connect to choose_server:"),g.url),jb(g,t,e,n)),allFailedhandler:g=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},m),g[0]},promisesCollector:a});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},m),f});return function(){return h.apply(this,arguments)}}(),d=function(){var h=y(function*(){if(yield Me(1e3),null!==s)return s;const S=A("WEBCS_DOMAIN_BACKUP_LIST").map((g,R)=>{let C;return C="disabled"===t.cloudProxyServer&&t.proxyServer?o("".concat(g,"/api/v2/transpond/webrtc?v=2"),R,t.proxyServer):"disabled"===t.cloudProxyServer||"fallback"===t.cloudProxyServer?"https://".concat(g,"/api/v2/transpond/webrtc?v=2"):o("".concat(g,"/api/v2/transpond/webrtc?v=2"),R),{url:C,areaCode:Rc(),serviceIds:[Ee.CHOOSE_SERVER,"proxy5"===t.cloudProxyServer?Ee.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?Ee.CLOUD_PROXY:Ee.CLOUD_PROXY_FALLBACK]}}),m=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:S.map(g=>g.url)}),f=yield vc({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:S,asyncMapHandler:g=>(_.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),g.url),jb(g,t,e,n)),allFailedhandler:g=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},m),g[0]},promisesCollector:a});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},m),f});return function(){return h.apply(this,arguments)}}();let u,l,p;try{({gatewayInfo:u,proxyInfo:l,url:p}=yield pa([c(),d()]))}catch(h){throw h[0]}if(a.length&&a.forEach(h=>h.cancel&&"function"==typeof h.cancel&&h.cancel()),!u||!l)throw new N(v.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=p,"disabled"!==t.cloudProxyServer&&Array.isArray(i)&&p){const h=/^https?:\/\/(.+?)(\/.*)?$/.exec(p)[1];W(i).call(i,h)&&(t.proxyServer=h,_.setProxyServer(h),Q.setProxyServer(h))}return s={gatewayInfo:u,proxyInfo:yield VC(l,u.uid)},s}),Em.apply(this,arguments)}function mm(){return mm=y(function*(t,e,n){const i=A("UAP_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(o=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")).map(o=>function(s,a,c,d){const u={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:tr,cname:a.cname,uid:a.uid.toString(),requestId:om,seq:om};om+=1;const l={service_name:"tele_channel",json_body:JSON.stringify(u)};return Mr(y(function*(){const p=yield Fr(s,{data:l,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==p.code){const S=new N(v.UNEXPECTED_RESPONSE,"cross channel ap error, code"+p.code,{retry:!0});throw _.error(S.toString()),S}const h=JSON.parse(p.json_body);if(200!==h.code){const S=new N(v.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(h.code,", reason: ").concat(h.reason));throw _.error(S.toString()),S}if(!h.servers||0===h.servers.length){const S=new N(v.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw _.error(S.toString()),S}return{vid:h.vid,workerToken:h.workerToken,addressList:(A("CHANNEL_MEDIA_RELAY_SERVERS")||h.servers).map(S=>"wss://".concat(S.address.replace(/\./g,"-"),".").concat(A("WORKER_DOMAIN"),":").concat(S.wss))}}),void 0,p=>!!(p.code!==v.OPERATION_ABORTED&&p.code!==v.UNEXPECTED_RESPONSE||p.data&&p.data.retry),d)}(o,t,e,n));try{const o=yield pa(i);return i.forEach(s=>s.cancel()),o}catch(o){throw o[0]}}),mm.apply(this,arguments)}function fm(){return fm=y(function*(t,e,n){let r=null;const i=[],o=function(){var s=y(function*(a){const c=A(a?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(d=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(d+"/api/v2/transpond/webrtc?v=2"):"https://".concat(d,"/api/v2/transpond/webrtc?v=2"));return a&&(yield Me(1e3),null!==r)?r:yield vc({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:c,asyncMapHandler:d=>(_.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(a?"backup":""," choose_server:"),d),function(u,l,p,h){const[S]=N3(l,[Ee.CHOOSE_SERVER]);let m=_e.networkState;return Mr(y(function*(){m&&_e.networkState===An.OFFLINE&&_e.onlineWaiter&&(yield H.race([_e.onlineWaiter,Me(h&&h.maxRetryTimeout||Se.maxRetryTimeout)])),m=_e.networkState;const f=yield Fr(u,{data:S,cancelToken:p,headers:{"Content-Type":"multipart/form-data;"}},!0);return w3(f,u)}),()=>!1,f=>f.code!==v.OPERATION_ABORTED&&(f.code===v.UPDATE_TICKET_FAILED?f.data.retry:(_.warning("[".concat(l.clientId,"] update ticket network error, retry"),f),!0)),h)}(d,t,e,n)),allFailedhandler:d=>{throw d[0]},promisesCollector:i})});return function(c){return s.apply(this,arguments)}}();try{return r=yield pa([o(!1),o(!0)]),i.length&&i.forEach(s=>s.cancel&&"function"==typeof s.cancel&&s.cancel()),r}catch(s){throw s[0]}}),fm.apply(this,arguments)}function zb(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Jb(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?zb(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):zb(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class M3 extends Zt{get isSuccess(){return!!this.configs}constructor(e){super(),T(this,"configs",void 0),T(this,"joinInfo",void 0),T(this,"cancelToken",void 0),T(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),T(this,"interval",void 0),T(this,"mutex",void 0),T(this,"mutableParamsRead",!1),this.mutex=new Je("config-distribute",e)}startGetConfigDistribute(e,n){this.joinInfo=e,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),A("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},A("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}awaitConfigDistributeComplete(){var e=this;return y(function*(){e.mutex.isLocked&&(yield e.mutex.lock())()})()}updateConfigDistribute(){var e=this;return y(function*(){if(e.mutableParamsRead||(e.mutableParamsRead=!0,Q.reportApiInvoke(null,{options:void 0,name:ye.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:ne.TRACER}).onSuccess(JSON.stringify($i))),!e.joinInfo||!e.cancelToken||!e.retryConfig)return void _.debug("[config-distribute] get config distribute interrupted have no joininfo");let n;const r=yield e.mutex.lock();try{n=yield function P3(t,e,n){return hm.apply(this,arguments)}(e.joinInfo,e.cancelToken,e.retryConfig),_.debug("[config-distribute] get config distribute",JSON.stringify(n)),n.limit_bitrate&&e.handleBitrateLimit(n.limit_bitrate),e.cacheGlobalParameterConfig(n),e.configs=n}catch(i){const o=new N(v.NETWORK_RESPONSE_ERROR,i);_.warning("[config-distribute] ".concat(o.toString()))}finally{r()}})()}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var n;(n=e)&&n.uplink&&n.id&&void 0!==n.uplink.max_bitrate&&void 0!==n.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(tE.UPDATE_BITRATE_LIMIT,e):this.emit(tE.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&Jb({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var n;const r=Ga(n=Object.keys(e).filter(o=>/^webrtc_ng_global_parameter/.test(o))).call(n);for(let o=0;o<r.length;o++)for(let s=r.length-1;s>o;s--){const a=r[s];if("number"==typeof e[a].__priority){const d=r[s-1];if("number"==typeof e[d].__priority){if(!(e[a].__priority>e[d].__priority))continue;{const u=a;r[s]=r[s-1],r[s-1]=u}}else{const u=a;r[s]=r[s-1],r[s-1]=u}}}const i={};r.forEach(o=>{const s=e[o],a=s.__expires;Object.keys(s).forEach(c=>{"__priority"===c||"__expires"===c||Object.prototype.hasOwnProperty.call(i,c)||(i[c]=Jb({value:s[c]},a&&{expires:a}))})});try{!function(a){try{const c=Date.now();Object.keys(a).forEach(d=>{switch(d){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(ce,d)){const{value:u,expires:l}=a[d];if(l&&l<=c)return;$i[d]=u,ce[d]=u,_.debug("Update global parameters from config distribute",d,u)}}})}catch(c){_.error("Error update config immediately: ".concat(a),c.message)}}(i);const o=JSON.stringify(i),s=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",s),_.debug("Caching global parameters ".concat(o))}catch(o){_.error("Error caching global parameters:",o.message)}}}class U3 extends Zt{constructor(){super(...arguments),T(this,"resultStorage",new Map)}setLocalAudioStats(e,n,r){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(r,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(r,n))}setLocalVideoStats(e,n,r){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(r,n)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(r,n)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(r))}setRemoteAudioStats(e,n){const r=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",r,this.checkAudioOutputLevel(n))}setRemoteVideoStats(e,n){const r=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",r,this.checkVideoDecode(n))}record(e,n,r){if(A("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const i=this.resultStorage.get(e);if(i&&(i.result.push(r),i.result.length>=5)){var o;const s=W(o=i.result).call(o,!0);i.isPrevNormal&&!s&&this.emit("exception",Xb[e],e,n),!i.isPrevNormal&&s&&this.emit("exception",Xb[e]+2e3,e+"_RECOVER",n),i.isPrevNormal=s,i.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,n){return n instanceof Ie&&!n.isActive||!!n.muted||0!==e.sendVolumeLevel}checkFramerateInput(e,n){let r=null;n._encoderConfig&&n._encoderConfig.frameRate&&(r=On(n._encoderConfig.frameRate));const i=e.captureFrameRate;return!r||!i||!(r>10&&i<5||r<10&&r>=5&&i<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,n){return!!n.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,n){return n instanceof Ie&&!n.isActive||!!n.muted||0!==e.sendBitrate}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const Xb={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Qe=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(n.length>0){const r=n[n.length-1];return Math.round(performance.now()-r.startTime)}return 0}measureFromPublishStart(t,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(n.length>0){const r=n[n.length-1];return Math.round(performance.now()-r.startTime)}return 0}};var Qb=Wt(qn.Object.getOwnPropertySymbols),x3=Lt,V3=ap.indexOf,F3=pd,gm=ba([].indexOf),Zb=!!gm&&1/gm([1],1,-0)<0;x3({target:"Array",proto:!0,forced:Zb||!F3("indexOf")},{indexOf:function(t){var e=arguments.length>1?arguments[1]:void 0;return Zb?gm(this,t,e)||0:V3(this,t,e)}});var B3=ur("Array").indexOf,j3=on,G3=B3,Tm=Array.prototype,$b=Wt(function(t){var e=t.indexOf;return t===Tm||j3(Tm,t)&&e===Tm.indexOf?G3:e});function yr(t){if(Array.isArray(t))return t.map(n=>n);if(!tO(t))return t;const e={};for(const n in t){const r=t[n];e[n]=tO(r)||Array.isArray(r)?yr(r):r}return e}function tO(t){return!("object"!=typeof t||Array.isArray(t)||!t)}class Sm{constructor(e){T(this,"input",[]),T(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const ai={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},yc={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:ai,remoteCandidate:ai},updateInterval:0},eO={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},nO={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},rO={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},iO={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function oO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function sO(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?oO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):oO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class Rm{constructor(e,n){var r=this;T(this,"onFirstVideoReceived",void 0),T(this,"onFirstVideoDecoded",void 0),T(this,"onFirstAudioReceived",void 0),T(this,"onFirstVideoDecodedTimeout",void 0),T(this,"onFirstAudioDecoded",void 0),T(this,"onSelectedLocalCandidateChanged",void 0),T(this,"onSelectedRemoteCandidateChanged",void 0),T(this,"videoIsReady",!1),T(this,"videoIsReady2",{}),T(this,"pc",void 0),T(this,"options",void 0),T(this,"intervalTimer",void 0),T(this,"stats",yr(yc)),T(this,"isFirstVideoReceived",{}),T(this,"isFirstVideoDecoded",{}),T(this,"isFirstAudioReceived",{}),T(this,"isFirstAudioDecoded",{}),T(this,"isFirstVideoDecodedTimeout",{}),T(this,"lossRateWindowStats",[]),this.pc=e,this.options=n,this.intervalTimer=window.setInterval(y(function*(){r.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new H(e=>{e({local:sO({},ai),remote:sO({},ai)})})}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,n){this.videoIsReady2[e]=n}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const n=this.lossRateWindowStats.length,r=["videoSend","audioSend","videoRecv","audioRecv"];let i=0,o=0,s=0,a=0;for(const c of r)e[c].forEach((d,u)=>{if(!this.lossRateWindowStats[n-1][c][u]||!this.lossRateWindowStats[0][c][u])return;const l=this.lossRateWindowStats[n-1][c][u].packets-this.lossRateWindowStats[0][c][u].packets,p=this.lossRateWindowStats[n-1][c][u].packetsLost-this.lossRateWindowStats[0][c][u].packetsLost;"videoSend"===c||"audioSend"===c?(i+=l,s+=p):(o+=l,a+=p),d.packetLostRate=Number.isNaN(l)||Number.isNaN(l)||l<=0||p<=0?0:p/(l+p)});e.sendPacketLossRate=i<=0||s<=0?0:s/(i+s),e.recvPacketLossRate=o<=0||a<=0?0:a/(o+a)}}function aO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function K3(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?aO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):aO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class Y3 extends Rm{constructor(){super(...arguments),T(this,"_stats",yc),T(this,"lastDecodeVideoReceiverStats",new Map)}updateStats(){var e=this;return y(function*(){const n=yield e._getStats(),r=e.statsResponsesToObjects(n);e._stats=yr(yc);const i=r.filter(s=>"ssrc"===s.type);e.processSSRCStats(i);const o=r.find(s=>"VideoBwe"===s.type);o&&e.processBandwidthStats(o),e._stats.timestamp=Date.now(),e.calcLossRate(e._stats),e.stats=e._stats})()}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(n=>{var r;const i=W(r=n.id).call(r,"send");switch("".concat(n.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const o=yr(nO);o.codec=n.googCodecName,o.adaptionChangeReason="none",n.googCpuLimitedResolution&&(o.adaptionChangeReason="cpu"),n.googBandwidthLimitedResolution&&(o.adaptionChangeReason="bandwidth"),o.avgEncodeMs=Number(n.googAvgEncodeMs),o.inputFrame={width:Number(n.googFrameWidthInput)||Number(n.googFrameWidthSent),height:Number(n.googFrameHeightInput)||Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},o.sentFrame={width:Number(n.googFrameWidthSent),height:Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},o.firsCount=Number(n.googFirReceived),o.nacksCount=Number(n.googNacksReceived),o.plisCount=Number(n.googPlisReceived),o.frameCount=Number(n.framesEncoded),o.bytes=Number(n.bytesSent),o.packets=Number(n.packetsSent),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.rttMs=Number(n.googRtt||0),this._stats.videoSend.push(o),this._stats.rtt=o.rttMs;break}case"video_recv":{const o=yr(eO),s=this.lastDecodeVideoReceiverStats.get(Number(n.ssrc));if(o.codec=n.googCodecName,o.targetDelayMs=Number(n.googTargetDelayMs),o.renderDelayMs=Number(n.googRenderDelayMs),o.currentDelayMs=Number(n.googCurrentDelayMs),o.minPlayoutDelayMs=Number(n.googMinPlayoutDelayMs),o.decodeMs=Number(n.googDecodeMs),o.maxDecodeMs=Number(n.googMaxDecodeMs),o.receivedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateReceived)},o.decodedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateDecoded)},o.decodeFrameRate=Number(n.googFrameRateDecoded),o.outputFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateOutput)},o.jitterBufferMs=Number(n.googJitterBufferMs),o.firsCount=Number(n.googFirsSent),o.nacksCount=Number(n.googNacksSent),o.plisCount=Number(n.googPlisSent),o.framesDecodeCount=Number(n.framesDecoded),o.bytes=Number(n.bytesReceived),o.packets=Number(n.packetsReceived),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.packets>0&&!this.isFirstVideoReceived[o.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(o.ssrc),this.isFirstVideoReceived[o.ssrc]=!0),o.framesDecodeCount>0&&!this.isFirstVideoDecoded[o.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(o.ssrc,o.decodedFrame.width,o.decodedFrame.height),this.isFirstVideoDecoded[o.ssrc]=!0),s){const a=s.stats,c=Date.now()-s.lts;o.framesDecodeFreezeTime=a.framesDecodeFreezeTime,o.framesDecodeInterval=a.framesDecodeInterval,o.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[o.ssrc]?(s.lts=Date.now(),o.framesDecodeInterval=c,o.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(n.ssrc,10))?o.framesDecodeFreezeTime+=o.framesDecodeInterval:this.setVideoIsReady2(parseInt(n.ssrc,10),!0))):o.framesDecodeCount<s.stats.framesDecodeCount&&(o.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(o.ssrc,{stats:K3({},o),lts:Date.now()}),this._stats.videoRecv.push(o);break}case"audio_recv":{const o=yr(iO);o.codec=n.googCodecName,o.outputLevel=Math.abs(Number(n.audioOutputLevel))/32767,o.decodingCNG=Number(n.googDecodingCNG),o.decodingCTN=Number(n.googDecodingCTN),o.decodingCTSG=Number(n.googDecodingCTSG),o.decodingNormal=Number(n.googDecodingNormal),o.decodingPLC=Number(n.googDecodingPLC),o.decodingPLCCNG=Number(n.googDecodingPLCCNG),o.expandRate=Number(n.googExpandRate),o.accelerateRate=Number(n.googAccelerateRate),o.preemptiveExpandRate=Number(n.googPreemptiveExpandRate),o.secondaryDecodedRate=Number(n.googSecondaryDecodedRate),o.speechExpandRate=Number(n.googSpeechExpandRate),o.preferredJitterBufferMs=Number(n.googPreferredJitterBufferMs),o.jitterBufferMs=Number(n.googJitterBufferMs),o.jitterMs=Number(n.googJitterReceived),o.bytes=Number(n.bytesReceived),o.packets=Number(n.packetsReceived),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.receivedFrames=Number(n.googDecodingCTN)||Number(n.packetsReceived),o.droppedFrames=Number(n.googDecodingPLC)+Number(n.googDecodingPLCCNG)||Number(n.packetsLost),o.receivedFrames>0&&!this.isFirstAudioReceived[o.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(o.ssrc),this.isFirstAudioReceived[o.ssrc]=!0),o.decodingNormal>0&&!this.isFirstAudioDecoded[o.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(o.ssrc),this.isFirstAudioDecoded[o.ssrc]=!0),this._stats.audioRecv.push(o);break}case"audio_send":{const o=yr(rO);o.codec=n.googCodecName,o.inputLevel=Math.abs(Number(n.audioInputLevel))/32767,o.aecReturnLoss=Number(n.googEchoCancellationReturnLoss||0),o.aecReturnLossEnhancement=Number(n.googEchoCancellationReturnLossEnhancement||0),o.residualEchoLikelihood=Number(n.googResidualEchoLikelihood||0),o.residualEchoLikelihoodRecentMax=Number(n.googResidualEchoLikelihoodRecentMax||0),o.bytes=Number(n.bytesSent),o.packets=Number(n.packetsSent),o.packetsLost=Number(n.packetsLost),o.ssrc=Number(n.ssrc),o.rttMs=Number(n.googRtt||0),this._stats.rtt=o.rttMs,this._stats.audioSend.push(o);break}}})}_getStats(){return new H((e,n)=>{this.pc.getStats(e,n)})}statsResponsesToObjects(e){const n=[];return e.result().forEach(r=>{const i={id:r.id,timestamp:r.timestamp.valueOf().toString(),type:r.type};r.names().forEach(o=>{i[o]=r.stat(o)}),n.push(i)}),n}}var ha=function(t){return t[t.kNone=1]="kNone",t[t.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",t[t.kBytesToBits=8]="kBytesToBits",t}(ha||{});function Cc(t,e,n,r){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ha.kNone;if(!e)return;const o=Number(e[n]);if("number"!=typeof o)return;const s=Number(e[r]);if("number"!=typeof s)return;if(!t)return s?o/s*i:void 0;const a=Number(t[n]);if("number"!=typeof a)return;const c=Number(t[r]);if("number"!=typeof c)return;const d=s-c;return d?(o-a)/d*i:void 0}function cO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function ao(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?cO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):cO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class dO extends Rm{constructor(){super(...arguments),T(this,"_stats",yc),T(this,"report",void 0),T(this,"lastDecodeVideoReceiverStats",new Map),T(this,"lastVideoFramesRecv",new Map),T(this,"lastVideoFramesSent",new Map),T(this,"lastVideoFramesDecode",new Map),T(this,"lastVideoFramesOutput",new Map),T(this,"lastVideoJBDelay",new Map),T(this,"lastAudioJBDelay",new Map),T(this,"mediaBytesSent",new Map),T(this,"mediaBytesRetransmit",new Map),T(this,"mediaBytesTargetEncode",new Map),T(this,"lastDecodeAudioReceiverStats",new Map),T(this,"lastEncoderMs",new Map)}updateStats(){var e=this;return y(function*(){e.report=yield e.pc.getStats(),e._stats=yr(yc),e.report.forEach(n=>{switch(n.type){case xn.OUTBOUND:case xn.INBOUND:{const r=n.mediaType||n.kind,i=!r&&"frameWidth"in n,o=!r&&!("frameWidth"in n);n.type===xn.OUTBOUND?"audio"===r||o?e.processAudioOutboundStats(n):("video"===r||i)&&e.processVideoOutboundStats(n):n.type===xn.INBOUND&&("audio"===r||o?e.processAudioInboundStats(n):("video"===r||i)&&e.processVideoInboundStats(n));break}case xn.TRANSPORT:{const r=e.report.get(n.selectedCandidatePairId);r&&e.processCandidatePairStats(r);break}case xn.CANDIDATE_PAIR:n.selected&&e.processCandidatePairStats(n)}}),e.updateSendBitrate(),e._stats.updateInterval=Date.now()-e.stats.timestamp,e._stats.timestamp=Date.now(),e.calcLossRate(e._stats),e.stats=e._stats})()}getSelectedCandidatePair(){var e=this;return y(function*(){const n=yield e.pc.getStats(),r={local:ao({},ai),remote:ao({},ai)};return n.forEach(i=>{let o;if(i.type===xn.TRANSPORT&&(o=n.get(i.selectedCandidatePairId)),i.type===xn.CANDIDATE_PAIR&&i.selected&&(o=i),o){const s=(a,c)=>{a.type=c.type,a.id=c.id,c.address&&(a.address=c.address),c.candidateType&&(a.candidateType=c.candidateType),c.port&&(a.port=c.port),c.priority&&(a.priority=c.priority),c.protocol&&(a.protocol=c.protocol),c.relayProtocol&&(a.relayProtocol=c.relayProtocol)};if(o.localCandidateId){const a=n.get(o.localCandidateId);a&&s(r.local,a)}if(o.remoteCandidateId){const a=n.get(o.remoteCandidateId);a&&s(r.remote,a)}}}),r})()}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(n=>{e.currentRoundTripTime&&(n.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(n=>{e.currentRoundTripTime&&(n.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const n=this.report.get(e.localCandidateId);n&&this.processCandidateStats(n)}if(e.remoteCandidateId){const n=this.report.get(e.remoteCandidateId);n&&this.processCandidateStats(n)}}processCandidateStats(e){let n;e.type===xn.LOCAL_CANDIDATE&&(n=this._stats.selectedCandidatePair.localCandidate),e.type===xn.REMOTE_CANDIDATE&&(n=this._stats.selectedCandidatePair.remoteCandidate),n&&(n.type=e.type,n.id=e.id,e.address&&(n.address=e.address),e.candidateType&&(n.candidateType=e.candidateType),e.port&&(n.port=e.port),e.priority&&(n.priority=e.priority),e.protocol&&(n.protocol=e.protocol),e.relayProtocol&&(n.relayProtocol=e.relayProtocol),e.type===xn.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==n.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(ao({},n),ao({},this.stats.selectedCandidatePair.localCandidate)),e.type===xn.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==n.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(ao({},n),ao({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let n=this._stats.audioRecv.find(i=>i.ssrc===e.ssrc);n||(n=yr(iO),this._stats.audioRecv.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsReceived,n.packetsLost=e.packetsLost,n.packetsDiscarded=e.packetsDiscarded,n.bytes=e.bytesReceived,n.jitterMs=1e3*e.jitter,n.retransmittedBytesReceived=e.retransmittedBytesReceived,n.retransmittedPacketsReceived=e.retransmittedPacketsReceived,n.totalProcessingDelay=e.totalProcessingDelay,n.jitterBufferEmittedCount=e.jitterBufferEmittedCount;const r=this.lastDecodeAudioReceiverStats.get(n.ssrc);n.avgProcessingDelayMs=Cc(r,n,"totalProcessingDelay","jitterBufferEmittedCount",ha.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(e,e.trackId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),n.receivedFrames||(n.receivedFrames=e.packetsReceived),n.droppedFrames||(n.droppedFrames=e.packetsLost),n.receivedFrames>0&&!this.isFirstAudioReceived[n.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(n.ssrc),this.isFirstAudioReceived[n.ssrc]=!0),n.outputLevel&&n.outputLevel>0&&!this.isFirstAudioDecoded[n.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(n.ssrc),this.isFirstAudioDecoded[n.ssrc]=!0),"number"==typeof e.concealedSamples&&(n.concealedSamples=e.concealedSamples),this.lastDecodeAudioReceiverStats.set(n.ssrc,ao({},n))}processVideoInboundStats(e){let n=this._stats.videoRecv.find(a=>a.ssrc===e.ssrc);n||(n=yr(eO),this._stats.videoRecv.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsReceived,n.packetsLost=e.packetsLost,n.bytes=e.bytesReceived,n.firsCount=e.firCount,n.nacksCount=e.nackCount,n.plisCount=e.pliCount,n.framesDecodeCount=e.framesDecoded,n.framesDroppedCount=e.framesDropped,n.totalInterFrameDelay=e.totalInterFrameDelay,n.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,n.totalFreezesDuration=e.totalFreezesDuration,n.totalProcessingDelay=e.totalProcessingDelay,n.packetsDiscarded=e.packetsDiscarded,n.framesAssembledFromMultiplePackets=e.framesAssembledFromMultiplePackets,n.totalAssemblyTime=e.totalAssemblyTime,n.keyFramesDecoded=e.keyFramesDecoded,n.retransmittedBytesReceived=e.retransmittedBytesReceived,n.retransmittedPacketsReceived=e.retransmittedPacketsReceived;const r=this.lastDecodeVideoReceiverStats.get(n.ssrc),i=this.lastVideoFramesDecode.get(n.ssrc),o=this.lastVideoFramesOutput.get(n.ssrc),s=Date.now();if(n.framesDecodeCount>0&&!this.isFirstVideoDecoded[n.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(n.ssrc,n.decodedFrame?n.decodedFrame.width:0,n.decodedFrame?n.decodedFrame.height:0),this.isFirstVideoDecoded[n.ssrc]=!0),r){const a=r.stats,c=s-r.lts;n.framesDecodeFreezeTime=a.framesDecodeFreezeTime,n.framesDecodeInterval=a.framesDecodeInterval,!this.isFirstVideoDecoded[n.ssrc]&&c>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[n.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(n.ssrc),this.isFirstVideoDecodedTimeout[n.ssrc]=!0),n.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[n.ssrc]?(r.lts=Date.now(),n.framesDecodeInterval=c,n.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?n.framesDecodeFreezeTime+=n.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):n.framesDecodeCount<a.framesDecodeCount&&(n.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(n.qpSumPerFrame=r.stats.framesDecodeCount>e.framesDecoded?e.qpSum/e.framesDecoded:(e.qpSum-r.qpSum)/(e.framesDecoded-r.stats.framesDecodeCount))}e.totalDecodeTime&&(n.decodeMs=1e3*e.totalDecodeTime,n.avgDecodeMs=Cc(r?.stats,n,"decodeMs","framesDecodeCount")),n.avgProcessingDelayMs=Cc(r?.stats,n,"totalProcessingDelay","framesDecodeCount",ha.kMillisecondsFromSeconds),n.avgFramesAssembledFromMultiplePacketsMs=Cc(r?.stats,n,"totalAssemblyTime","framesAssembledFromMultiplePackets",ha.kMillisecondsFromSeconds),n.avgInterFrameDelayMs=Cc(r?.stats,n,"totalInterFrameDelay","framesDecodeCount",ha.kMillisecondsFromSeconds),i&&s-i.lts>=800?(n.decodeFrameRate=Math.round((n.framesDecodeCount-i.count)/((s-i.lts)/1e3)),this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:s,rate:n.decodeFrameRate})):i?n.decodeFrameRate=i.rate:this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:s,rate:0}),n.framesDroppedCount&&e.framesReceived&&(o&&s-o.lts>=800?(n.outputFrameRate=Math.round((e.framesReceived-n.framesDroppedCount-o.count)/((s-o.lts)/1e3)),this.lastVideoFramesOutput.set(n.ssrc,{count:e.framesReceived-n.framesDroppedCount,lts:s,rate:Math.max(n.outputFrameRate,0)})):o?n.outputFrameRate=o.rate:this.lastVideoFramesOutput.set(n.ssrc,{count:e.framesReceived-n.framesDroppedCount,lts:s,rate:0})),this.processVideoTrackReceiverStats(e,e.trackId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(n.framesRateFirefox=e.framerateMean),n.packets>0&&!this.isFirstVideoReceived[n.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(n.ssrc),this.isFirstVideoReceived[n.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(n.ssrc,{stats:ao({},n),lts:r?r.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let n=this._stats.videoSend.find(i=>i.ssrc===e.ssrc);n||(n=yr(nO),this._stats.videoSend.push(n));const r=this.mediaBytesSent.get(e.ssrc);if(r)r.add(e.bytesSent);else{const i=new Sm(10);i.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,i)}if(void 0!==e.retransmittedBytesSent){const i=this.mediaBytesRetransmit.get(e.ssrc);if(i)i.add(e.retransmittedBytesSent);else{const o=new Sm(10);o.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,o)}}if(e.totalEncodedBytesTarget){const i=this.mediaBytesTargetEncode.get(e.ssrc);if(i)i.add(e.totalEncodedBytesTarget);else{const o=new Sm(10);o.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,o)}}if(n.ssrc=e.ssrc,n.bytes=e.bytesSent,n.packets=e.packetsSent,n.firsCount=e.firCount,n.nacksCount=e.nackCount,n.plisCount=e.pliCount,n.frameCount=e.framesEncoded,n.adaptionChangeReason=e.qualityLimitationReason,n.scalabilityMode=e.scalabilityMode,n.retransmittedBytesSent=e.retransmittedBytesSent,n.retransmittedPacketsSent=e.retransmittedPacketsSent,n.hugeFramesSent=e.hugeFramesSent,n.keyFramesEncoded=e.keyFramesEncoded,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);n.avgEncodeMs=!i||i.lastFrameCount>e.framesEncoded?1e3*e.totalEncodeTime/e.framesEncoded:1e3*(e.totalEncodeTime-i.lastEncoderTime)/(e.framesEncoded-i.lastFrameCount)}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);n.qpSumPerFrame=!i||i.lastFrameCount>e.framesEncoded?e.qpSum/e.framesEncoded:(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,n),this.processVideoTrackSenderStats(e,e.trackId,n),e.remoteId)this.processRemoteInboundStats(e.remoteId,n);else{const i=this.findRemoteStatsId(e.ssrc,xn.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,n)}}processAudioOutboundStats(e){let n=this._stats.audioSend.find(r=>r.ssrc===e.ssrc);if(n||(n=yr(rO),this._stats.audioSend.push(n)),n.ssrc=e.ssrc,n.packets=e.packetsSent,n.bytes=e.bytesSent,n.retransmittedBytesSent=e.retransmittedBytesSent,n.retransmittedPacketsSent=e.retransmittedPacketsSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,n),e.codecId&&(n.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,n),e.remoteId)this.processRemoteInboundStats(e.remoteId,n);else{const r=this.findRemoteStatsId(e.ssrc,xn.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,n)}}findRemoteStatsId(e,n){var r;const i=Array.from(Ci(r=this.report).call(r)).find(o=>o.type===n&&o.ssrc===e);return i?i.id:null}processVideoMediaSource(e,n){const r=this.report.get(e);r&&r.width&&r.height&&r.framesPerSecond&&(n.inputFrame={width:r.width,height:r.height,frameRate:r.framesPerSecond})}processAudioMediaSource(e,n){const r=this.report.get(e);r&&(n.inputLevel=r.audioLevel)}processVideoTrackSenderStats(e,n,r){var i,o,s,a;const c=n?this.report.get(n):void 0,d=null!==(i=c?.framesSent)&&void 0!==i?i:e.framesSent;if("number"!=typeof d)return;let u=null!==(o=c?.frameWidth)&&void 0!==o?o:e.frameWidth,l=null!==(s=c?.frameHeight)&&void 0!==s?s:e.frameHeight,p=null!==(a=c?.framesPerSecond)&&void 0!==a?a:e.framesPerSecond;if("number"==typeof u&&"number"==typeof l||(u=0,l=0),null==p){const h=Date.now(),S=this.lastVideoFramesSent.get(r.ssrc);S&&h-S.lts>=800?(p=Math.round((d-S.count)/((h-S.lts)/1e3)),this.lastVideoFramesSent.set(r.ssrc,{count:d,lts:h,rate:p})):S?p=S.rate:this.lastVideoFramesSent.set(r.ssrc,{count:d,lts:h,rate:0})}r.sentFrame={width:u,height:l,frameRate:Math.max(0,p)}}processVideoTrackReceiverStats(e,n,r){var i,o,s,a,c;const d=n?this.report.get(n):void 0,u=null!==(i=d?.framesReceived)&&void 0!==i?i:e.framesReceived,l=null!==(o=d?.frameWidth)&&void 0!==o?o:e.frameWidth,p=null!==(s=d?.frameHeight)&&void 0!==s?s:e.frameHeight,h=null!==(a=d?.jitterBufferDelay)&&void 0!==a?a:e.jitterBufferDelay,S=null!==(c=d?.jitterBufferEmittedCount)&&void 0!==c?c:e.jitterBufferEmittedCount;if("number"==typeof u){const m=this.lastVideoFramesRecv.get(r.ssrc),f=Date.now();r.framesReceivedCount=u;let g=0;m&&f-m.lts>=800?(g=Math.round((u-m.count)/((f-m.lts)/1e3)),this.lastVideoFramesRecv.set(r.ssrc,{count:u,lts:f,rate:g})):m?g=m.rate:this.lastVideoFramesRecv.set(r.ssrc,{count:u,lts:f,rate:0}),r.receivedFrame={width:l||0,height:p||0,frameRate:g||0},r.decodedFrame={width:l||0,height:p||0,frameRate:r.decodeFrameRate||0},r.outputFrame={width:l||0,height:p||0,frameRate:r.outputFrameRate||r.decodeFrameRate||0}}if(h&&S){const m=this.lastVideoJBDelay.get(r.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let f=m.jitterBufferMs;const g=S-m.jitterBufferEmittedCount;g>0&&(f=1e3*(h-m.jitterBufferDelay)/g),r.jitterBufferMs=f,r.currentDelayMs=Math.round(f),this.lastVideoJBDelay.set(r.ssrc,{jitterBufferDelay:h,jitterBufferEmittedCount:S,jitterBufferMs:r.currentDelayMs})}}processAudioTrackSenderStats(e,n,r){var i,o,s,a;const c=n?this.report.get(n):void 0,d=null!==(i=null!==(o=c?.echoReturnLoss)&&void 0!==o?o:e.echoReturnLoss)&&void 0!==i?i:0,u=null!==(s=null!==(a=c?.echoReturnLossEnhancement)&&void 0!==a?a:e.echoReturnLossEnhancement)&&void 0!==s?s:0;r.aecReturnLoss=d,r.aecReturnLossEnhancement=u}processAudioTrackReceiverStats(e,n,r){var i,o,s,a,c,d,u;const l=n?this.report.get(n):void 0,p=null!==(i=l?.removedSamplesForAcceleration)&&void 0!==i?i:e.removedSamplesForAcceleration,h=null!==(o=l?.totalSamplesReceived)&&void 0!==o?o:e.totalSamplesReceived,S=null!==(s=l?.jitterBufferDelay)&&void 0!==s?s:e.jitterBufferDelay,m=null!==(a=l?.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount,f=null!==(c=l?.audioLevel)&&void 0!==c?c:e?.audioLevel,g=null!==(d=l?.totalSamplesDuration)&&void 0!==d?d:e?.totalSamplesDuration,R=null!==(u=l?.concealedSamples)&&void 0!==u?u:e.concealedSamples;if(p&&h&&(r.accelerateRate=p/h),S&&m){const b=this.lastAudioJBDelay.get(r.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let w=b.jitterBufferMs;const D=m-b.jitterBufferEmittedCount;D>0&&(w=1e3*(S-b.jitterBufferDelay)/D),r.jitterBufferMs=Math.round(w),this.lastAudioJBDelay.set(r.ssrc,{jitterBufferDelay:S,jitterBufferEmittedCount:m,jitterBufferMs:r.jitterBufferMs})}r.outputLevel=f;let C=1920;g&&h&&(C=h/g/50,r.receivedFrames=Math.round(h/C)),R&&(r.droppedFrames=Math.round(R/C))}processRemoteInboundStats(e,n){const r=this.report.get(e);r&&(n.packetsLost=r.packetsLost,r.roundTripTime&&(n.rttMs=1e3*r.roundTripTime),r.jitter&&(n.jitterMs=1e3*r.jitter),r.timestamp&&(n.timestamp=r.timestamp))}getCodecFromCodecStats(e){const n=this.report.get(e);if(!n)return"";const r=n.mimeType.match(/\/(.*)$/);return r&&r[1]?r[1]:""}updateSendBitrate(){let e=0,n=null,r=null;this.mediaBytesSent.forEach(o=>{e+=o.diffMean()}),this.mediaBytesRetransmit.forEach(o=>{n=null===n?o.diffMean():n+o.diffMean()}),this.mediaBytesTargetEncode.forEach(o=>{r=null===r?o.diffMean():r+o.diffMean()}),this._stats.bitrate={actualEncoded:8*(null!==n?e-n:e)/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==n&&(this._stats.bitrate.retransmit=8*n/(this.options.updateInterval/1e3)),null!==r&&(this._stats.bitrate.targetEncoded=8*r/(this.options.updateInterval/1e3))}}class q3 extends Rm{updateStats(){return H.resolve()}}function vm(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const s=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return s&&s[0]?Number(s[0].split("/")[1]):null}();return o?o<76?new Y3(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):new dO(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):function(s){if(!window.RTCStatsReport)return!1;const a=s.getStats();return!(!(a instanceof H)&&(c=a,!c||"object"!=typeof c&&"function"!=typeof c||"function"!=typeof c.then));var c}(t)?new dO(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):new q3(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i})}let uO=class{get localCapabilities(){return ae(this._localCapabilities)}get rtpCapabilities(){return ae(this._rtpCapabilities)}get candidates(){return ae(this._candidates)}get iceParameters(){return ae(this._iceParameters)}get dtlsParameters(){return ae(this._dtlsParameters)}constructor(t){T(this,"sessionDesc",void 0),T(this,"_localCapabilities",void 0),T(this,"_rtpCapabilities",void 0),T(this,"_candidates",void 0),T(this,"_iceParameters",void 0),T(this,"_dtlsParameters",void 0),T(this,"setup",void 0),T(this,"currentMidIndex",void 0),T(this,"cname","o/i14u9pJrxRKAsu"),T(this,"firefoxSsrcMidMap",new Map),t=ae(t);const{remoteIceParameters:e,remoteDtlsParameters:n,candidates:r,remoteRTPCapabilities:i,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:d}=t;let u;this.setup=a,u=Fe.parse(s===dn.RECEIVE_ONLY?"v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n":"v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=i,this._candidates=r,this._iceParameters=e,this._dtlsParameters=n,this._localCapabilities=o;const l=s===dn.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,p=s===dn.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,h=s===dn.RECEIVE_ONLY?i.send.videoCodecs:Sc(q.VIDEO,l,p,c),S=s===dn.RECEIVE_ONLY?i.send.audioCodecs:Sc(q.AUDIO,l,p,d);for(const m of u.mediaDescriptions)m.attributes.iceUfrag=e.iceUfrag,m.attributes.icePwd=e.icePwd,m.attributes.fingerprints=n.fingerprints,m.attributes.candidates=r,m.attributes.setup=this.setup,"application"===m.media.mediaType&&(m.attributes.sctpPort="5000"),"video"===m.media.mediaType&&(m.media.fmts=h.map(f=>f.payloadType.toString(10)),m.attributes.payloads=h,m.attributes.extmaps=l.videoExtensions),"audio"===m.media.mediaType&&(m.media.fmts=S.map(f=>f.payloadType.toString(10)),m.attributes.payloads=S,m.attributes.extmaps=l.audioExtensions,ua(m));this.sessionDesc=u,this.currentMidIndex=u.mediaDescriptions.length-1}toString(){return Fe.print(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===t)}send(t,e,n,r,i){n=n.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:s}=Ko(e,this.cname,A("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(ee()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),i&&(i.twcc||i.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,i),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(t,o,r);let d;return-1===c?(d=this.createOrRecycleSendMedia(t,o,s,"sendonly",r,i),this.updateBundleMids()):(d=ae(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,i)),ee()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&-1!==t.indexOf(n.attributes.mid));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(n=>{n.attributes.ssrcs=[]}),this.updateBundleMids()}receive(t,e,n){const r=[];return t.forEach(i=>{const s=this.findAvailableRecvMediaIndex(i._mediaStreamTrack.kind);let a,c=!1;-1===s?(c=!0,a=this.createOrRecycleRecvMedia(i,[],"recvonly",e,n),this.updateBundleMids()):(a=ae(this.sessionDesc.mediaDescriptions[s]),a.attributes.direction="recvonly"),r.push({mid:a.attributes.mid,needCreateTransceiver:c})}),r}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>-1!==t.indexOf(n.attributes.mid));if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(t){const{foundation:e,protocol:n,address:r,port:i,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(t),d={foundation:e??"",componentId:"1",transport:n??"",priority:c?c+"":"",connectionAddress:r??"",port:i?i+"":"",type:o?o+"":"",relAddr:s??"",relPort:a?a+"":"",extension:{}};this.candidates.some(u=>u.priority===d.priority&&u.connectionAddress===d.connectionAddress&&u.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(u=>{u.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(t,e,n,r,i){const o=t._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=Sc(o,s,this.localCapabilities.send,o===q.AUDIO?i:r),c=o===q.VIDEO?s.videoExtensions:s.audioExtensions,d="".concat(++this.currentMidIndex);let u={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungRecvMediaDsec(u,t);const l=this.findFirstClosedMedia(o);if(l){const p=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>W(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter(n=>W(t).call(t,n.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(n=>{n.attributes.direction="recvonly"})}findAvailableMediaIndex(t,e,n){return this.sessionDesc.mediaDescriptions.findIndex(r=>{const i=r.media.mediaType===t&&"0"!==r.media.port&&("sendonly"===r.attributes.direction||"sendrecv"===r.attributes.direction)&&0===r.attributes.ssrcs.length;if(ee()){if(i){const o=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(o||"0"!==r.attributes.mid&&"1"!==r.attributes.mid)||!(!o||o!==r.attributes.mid)}return!1}return i&&r.attributes.mid===n})}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex(e=>"0"!==e.attributes.mid&&"1"!==e.attributes.mid&&e.media.mediaType===t&&"0"!==e.media.port&&("recvonly"===e.attributes.direction||"sendrecv"===e.attributes.direction))}predictReceivingMids(t){const e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}restartICE(t){t=ae(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}createOrRecycleSendMedia(t,e,n,r,i,o){const s=this.rtpCapabilities.send,a=t===q.VIDEO?s.videoCodecs:s.audioCodecs,c=t===q.VIDEO?s.videoExtensions:s.audioExtensions;ee()&&(i="".concat(++this.currentMidIndex));let d={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(l=>l.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:i}};d=this.mungSendMediaDesc(d,o);const u=this.findFirstClosedMedia(t);if(u){const l=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[l]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(t,e,n){const r=ae(t);return JE(r),da(r,e),XE(r,e),Ob(r),rl(r,n,this.localCapabilities.send),r}mungSendMediaDesc(t,e){const n=ae(t);return rl(n,e,this.localCapabilities.recv),ua(n),n}updateRecvMedia(t,e){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===t);if(-1!==n){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=r}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>"0"!==t.media.port).map(t=>t.attributes.mid)}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var n;return(null===(n=e.attributes)||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId)===t[0].ssrcId})}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>ee()?"0"===e.media.port&&e.media.mediaType===t:"0"===e.media.port)}};const z3=["sdp"];var Gt;function lO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function co(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?lO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):lO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let pO=(Gt=class Aa extends bC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return null!==(e=null===(n=this.peerConnection.getReceivers()[0])||void 0===n||null===(n=n.transport)||void 0===n?void 0:n.state)&&void 0!==e?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,n,r){super(e,n),T(this,"direction",void 0),T(this,"name",void 0),T(this,"store",void 0),T(this,"spec",void 0),T(this,"peerConnection",void 0),T(this,"initialOffer",void 0),T(this,"transport",void 0),T(this,"statsFilter",void 0),T(this,"localCandidateCount",0),T(this,"_isInRestartIce",!1),T(this,"mutex",void 0),T(this,"onLocalCandidate",void 0),T(this,"remoteSDP",void 0),T(this,"pendingCandidates",[]),T(this,"localCapabilities",void 0),T(this,"isReady",!1),T(this,"restartCnt",0),T(this,"curTurnServerIndex",0),this.store=n,this.spec=e,this.mutex=new Je("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Aa.resolvePCConfiguration(e,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=r??dn.SEND_ONLY,this.name=this.direction===dn.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=vm(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,ee()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}establish(e){var n=this;return y(function*(){try{const r=yield Nb();if(n.localCapabilities=il(r),e){const{sdp:i}=e,o=function H3(t,e){if(null==t)return{};var n,r,i=function(s,a){if(null==s)return{};var c,d,u={},l=SC(s);for(d=0;d<l.length;d++)c=l[d],$b(a).call(a,c)>=0||(u[c]=s[c]);return u}(t,e);if(Qb){var o=Qb(t);for(r=0;r<o.length;r++)n=o[r],$b(e).call(e,n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}(e,z3),s=function(){const l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},p=Tc(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},S={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(vr(p,l,"videoExtensions",h,S,m),vr(p,l,"videoCodecs",h,S,m),vr(p,l,"audioExtensions",h,S,m),vr(p,l,"audioCodecs",h,S,m),A("RAISE_H264_BASELINE_PRIORITY")){const f=m.videoCodecs.findIndex(g=>g.rtpMap&&"h264"===g.rtpMap.encodingName.toLocaleLowerCase()&&g.fmtp&&"42001f"===g.fmtp.parameters["profile-level-id"]);if(-1!==f){const g=m.videoCodecs.findIndex(R=>R.rtpMap&&"h264"===R.rtpMap.encodingName.toLocaleLowerCase());if(g<f){_.debug("raising H264 baseline profile priority");const R=m.videoCodecs[f];m.videoCodecs.splice(f,1),m.videoCodecs.splice(g,0,R)}-1!==g&&A("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(R=>!(R.rtpMap&&"h264"===R.rtpMap.encodingName.toLocaleLowerCase()&&R.fmtp&&"42001f"!==R.fmtp.parameters["profile-level-id"])))}}return{send:h,recv:S,sendrecv:m}}({},{},i);n.remoteSDP=new uO({remoteIceParameters:o.iceParameters,remoteDtlsParameters:o.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:n.localCapabilities,direction:n.direction,setup:"actpass",videoCodec:n.store.codec,audioCodec:n.store.audioCodec}),yield n.setRemoteDescription({type:"offer",sdp:n.remoteSDP.toString()}),n.isReady=!0;const a=yield n.peerConnection.createAnswer();if(!a.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const c=oo(a.sdp);yield n.peerConnection.setLocalDescription(a);const d=yield Db({},{},a.sdp);n.localCapabilities=il(d);const u=n.peerConnection.getTransceivers()[0];return null!=u&&u.receiver&&u.receiver.transport&&n.tryBindTransportEvents(u.receiver.transport),co(co({},c),{},{sdp:a.sdp})}{n.peerConnection.addTransceiver("video",{direction:"sendonly"}),n.peerConnection.addTransceiver("audio",{direction:"sendonly"});const i=yield n.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const o=oo(i.sdp);return n.initialOffer=i,co(co({},o),{},{sdp:i.sdp})}}catch(r){throw new P(v.GET_LOCAL_CONNECTION_PARAMS_FAILED,r.toString())}})()}connect(e){var n=this;return y(function*(){try{if(!n.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");yield n.peerConnection.setLocalDescription(n.initialOffer);const{sdp:r,iceParameters:i,dtlsParameters:o}=e,s=yield Db({},{},r);n.remoteSDP=new uO({remoteIceParameters:i,remoteDtlsParameters:o,candidates:[],remoteRTPCapabilities:s,localCapabilities:n.localCapabilities,direction:n.direction,setup:"active",videoCodec:n.store.codec,audioCodec:n.store.audioCodec}),yield n.setRemoteDescription({type:"answer",sdp:n.remoteSDP.toString()});const a=n.peerConnection.getTransceivers()[0];null!=a&&a.sender&&a.sender.transport&&n.tryBindTransportEvents(a.sender.transport)}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(r.toString()))}})()}addRemoteCandidate(e){var n=this;return y(function*(){try{e&&n.pendingCandidates.push(e),n.peerConnection.remoteDescription&&n.isReady&&(n.pendingCandidates.forEach(r=>{n.peerConnection.addIceCandidate(r)}),n.pendingCandidates=[])}catch(r){throw new P(v.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(r.toString()))}})()}send(e,n,r){var i=this;return Zn(function*(){const o=yield mt(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[],a=i.remoteSDP.receive(e,n,r);e.forEach((f,g)=>{if(a[g].needCreateTransceiver){const R=i.peerConnection.addTransceiver(f._mediaStreamTrack,{direction:"sendonly"});s.push(R),f._updateRtpTransceiver(R)}else{const R=i.peerConnection.getTransceivers().find(C=>C.mid===a[g].mid);if(!R)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[g].mid));s.push(R),f._updateRtpTransceiver(R)}}),ee()&&!0===A("SIMULCAST")&&(yield mt(i.applySimulcastForFirefox(s,e)));const c=a.map(f=>f.mid),d=yield mt(i.peerConnection.createOffer()),u=i.mungSendOfferSDP(d.sdp,e,c),l=Fe.parse(u),p=c.map(f=>{const g=l.mediaDescriptions.find(R=>R.attributes.mid===f);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return Ib(g,A("USE_PUB_RTX"))}),h=s.map((f,g)=>({localSSRC:p[g],id:c[g]}));yield mt(i.peerConnection.setLocalDescription({type:"offer",sdp:u}));try{yield h}catch(f){const g=i.remoteSDP.toString();throw yield mt(i.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield mt(i.peerConnection.setRemoteDescription({type:"answer",sdp:g})),yield mt(i.stopSending(c,!0)),f}yield mt(i.applySimulcastEncodings(s,e)),yield mt(i.applySendEncodings(s,e));const S=i.remoteSDP.toString(),m=i.logSDPExchange(u,"offer","local","send");return m?.(S),yield mt(i.setRemoteDescription({type:"answer",sdp:S})),s.map((f,g)=>({localSSRC:p[g],id:c[g]}))}catch(s){throw s instanceof P?s:new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}stopSending(e,n){var r=this;return y(function*(){const i=n?void 0:yield r.mutex.lock("From P2PConnection.stopSending");try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const o=r.peerConnection.getTransceivers().filter(d=>-1!==e.indexOf(d.mid));if(o.length!==e.length)throw new Error("Transceivers' length (".concat(o.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));o.map(d=>{var u;d.direction="inactive",null===(u=d.stop)||void 0===u||u.call(d)});const s=yield r.peerConnection.createOffer(),a=r.logSDPExchange(s.sdp||"","offer","local","stopSending");yield r.peerConnection.setLocalDescription(s),r.remoteSDP.stopReceiving(e);const c=r.remoteSDP.toString();a?.(c),yield r.setRemoteDescription({type:"answer",sdp:c})}catch(o){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(o.toString()))}finally{i&&i()}})()}receive(e,n,r,i){var o=this;return y(function*(){try{if(!o.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:a}=o.remoteSDP.send(e,n,r,i);if(a){const d=o.remoteSDP.toString(),u=o.logSDPExchange(d,"offer","remote","receive");yield o.setRemoteDescription({type:"offer",sdp:d});const l=yield o.peerConnection.createAnswer(),p=o.mungReceiveAnswerSDP(l.sdp,s,e);u?.(p||""),yield o.peerConnection.setLocalDescription({type:"answer",sdp:p}),_.debug("[".concat(o.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else _.debug("[".concat(o.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const c=o.peerConnection.getTransceivers().find(d=>d.mid===s);if(!c||null===c.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,mid:c.mid,transceiver:c}}catch(s){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}})()}mockReceive(e,n,r,i){var o=this;return y(function*(){try{if(!o.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:a}=o.remoteSDP.send(e,n,r,i);if(a){const c=o.remoteSDP.toString(),d=o.logSDPExchange(c,"offer","remote","receive");yield o.setRemoteDescription({type:"offer",sdp:c});const u=yield o.peerConnection.createAnswer(),l=o.mungReceiveAnswerSDP(u.sdp,s,e);d?.(l||""),yield o.peerConnection.setLocalDescription({type:"answer",sdp:l}),_.debug("[".concat(o.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else _.debug("[".concat(o.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(s){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}})()}stopReceiving(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");n.remoteSDP.stopSending(e);const r=n.remoteSDP.toString(),i=n.logSDPExchange(r,"offer","remote","stopReceiving");yield n.setRemoteDescription({type:"offer",sdp:r});const o=yield n.peerConnection.createAnswer();i?.(o.sdp||""),yield n.peerConnection.setLocalDescription(o)}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}})()}restartICE(e){var n=this;return y(function*(){try{if(n.store.p2pTransport===Mo.Auto&&(n.store.p2pTransport=Mo.SdRtn,St().supportPCSetConfiguration&&n.peerConnection.setConfiguration(Aa.resolvePCConfiguration(n.spec,n.store.p2pTransport))),n.restartCnt>3&&(n.restartCnt=0,St().supportPCSetConfiguration&&n.peerConnection.setConfiguration(Aa.resolvePCConfiguration(n.spec,n.store.p2pTransport,++n.curTurnServerIndex))),!e){n.restartCnt++,n.isReady=!1;const r=yield n.peerConnection.createOffer({iceRestart:!0});if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:i}=oo(r.sdp);return n.store.descriptionStart(),n.direction===dn.SEND_ONLY&&(yield n.peerConnection.setLocalDescription(r)),i}if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(n.remoteSDP.restartICE(e),n.store.descriptionStart(),n.direction===dn.RECEIVE_ONLY){n.restartCnt++,yield n.setRemoteDescription({type:"offer",sdp:n.remoteSDP.toString()});const r=yield n.peerConnection.createAnswer();if(!r.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:i}=oo(r.sdp);return yield n.peerConnection.setLocalDescription(r),i}yield n.setRemoteDescription({type:"answer",sdp:n.remoteSDP.toString()}),n.isReady=!0}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}})()}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}updateEncoderConfig(e,n){var r=this;return y(function*(){try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=yield r.peerConnection.createOffer(),o=r.mungSendOfferSDP(i.sdp,[n],[e]);r.remoteSDP.updateRecvMedia(e,n);const s=r.remoteSDP.toString(),a=r.logSDPExchange(o,"offer","local","updateEncoderConfig");yield r.peerConnection.setLocalDescription({type:"offer",sdp:o}),a?.(s),yield r.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new P(v.EXCHANGE_SDP_FAILED,i.toString())}})()}updateSendParameters(e,n){var r=this;return y(function*(){const i=r.peerConnection.getTransceivers().filter(o=>o.mid===e);1===i.length&&(r.isVP8Simulcast(n)?ee()||(yield r.applySimulcastEncodings(i,[n])):yield r.applySendEncodings(i,[n]))})()}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}replaceTrack(e,n){var r=this;return y(function*(){const i=r.peerConnection.getTransceivers().find(o=>o.mid===n);i&&(yield i.sender.replaceTrack(e._mediaStreamTrack))})()}getSelectedCandidatePair(){var e=this;return y(function*(){const n=e.peerConnection.getReceivers();if(n.length>0&&n[0].transport&&n[0].transport.iceTransport&&n[0].transport.iceTransport.getSelectedCandidatePair&&n[0].transport.iceTransport.getSelectedCandidatePair()){const r=n[0].transport.iceTransport,{local:i,remote:o}=r.getSelectedCandidatePair();return{local:co(co({},ai),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:co(co({},ai),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})}}return e.statsFilter.getSelectedCandidatePair()})()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,n;W(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(n=this.onICEConnectionStateChange)||void 0===n||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{var n;e.candidate?(e.candidate.candidate&&(null===(n=this.onLocalCandidate)||void 0===n||n.call(this,e.candidate.toJSON())),this.localCandidateCount+=1):_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i={iceServers:[]};var o;return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(yu(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...Aa.turnServerConfigToIceServers(e.turnServer.servers,n,r)),A("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...Aa.turnServerConfigToIceServers(e.turnServer.serversFromGateway,n,r)),W(o=[Mo.Relay,Mo.SdRtn]).call(o,n)&&(i.iceTransportPolicy="relay"),A("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(s=>{s.forceturn&&(i.iceTransportPolicy="relay")}))),A("ENABLE_ENCODED_TRANSFORM")&&St().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),_.debug("P2PConnection p2pTransport is ".concat(n)),i}static turnServerConfigToIceServers(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i=[],o=e.filter(a=>a.tcpport);_.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(r));const s=o.length>r?o[r]:o[0];switch(n){case Mo.SdRtn:const a=e.filter(d=>{var u;return W(u=d.username).call(u,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>r?a[r]:a[0];c&&(i.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(Hs(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),i.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(Hs(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case Mo.Relay:s&&(i.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),i.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(Hs(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;default:s&&(i.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),i.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(Hs(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}),i.push({username:s.username,credential:s.password,credentialType:"password",urls:"stun:".concat(s.turnServerURL,":").concat(s.tcpport)}))}return i}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var r;null!=e&&e.state&&(null===(r=this.onDTLSTransportStateChange)||void 0===r||r.call(this,e.state))},e.onerror=r=>{var i;null===(i=this.onDTLSTransportError)||void 0===i||i.call(this,"error"in r?r.error:r)};const n=e.iceTransport;n&&(n.onstatechange=()=>{const r=e?.iceTransport.state;var i;r&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,r))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:r,remote:i}=n.getSelectedCandidatePair();_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}updateRtpSenderEncodings(e,n){var r=this;return y(function*(){var i;if(n||(n=r.peerConnection.getSenders().find(l=>l.track===e._mediaStreamTrack)),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(r.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!St().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},s={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;default:o.degradationPreference="balanced"}if(e._encoderConfig){var a;const{bitrateMax:l,frameRate:p,scaleResolutionDownBy:h}=e._encoderConfig;l&&(s.maxBitrate=1e3*l),W(a=e._hints).call(a,Bt.LOW_STREAM)&&(p&&(s.maxFramerate=On(p)),h&&h>=1&&(s.scaleResolutionDownBy=h))}if(A("DSCP_TYPE")&&Xi()){var c;const l=A("DSCP_TYPE");W(c=["very-low","low","medium","high"]).call(c,l)&&(s.networkPriority=l)}const d=n.getParameters(),u=null===(i=d.encodings)||void 0===i?void 0:i[0];ee()&&!u&&(o.encodings=[s]),u&&Object.assign(u,s),Object.assign(d,o),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(d.encodings))),yield n.setParameters(d)})()}applySendEncodings(e,n){var r=this;return y(function*(){try{if(!St().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const o=e[i],s=n[i];s instanceof Kt&&!r.isVP8Simulcast(s)&&(yield r.updateRtpSenderEncodings(s,o.sender))}}catch{_.debug("[".concat(r.store.clientId,"] Apply RTPSendEncodings failed."))}})()}mungSendOfferSDP(e,n,r){const i=Fe.parse(e);return n.forEach((o,s)=>{const a=r[s],c=i.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(da(c,o),wb(c,o,this.store.codec))}),Fe.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;null===(n=this.onFirstAudioReceived)||void 0===n||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;null===(n=this.onFirstVideoReceived)||void 0===n||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;null===(n=this.onFirstAudioDecoded)||void 0===n||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,r)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var r;null===(r=this.onSelectedLocalCandidateChanged)||void 0===r||r.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var r;null===(r=this.onSelectedRemoteCandidateChanged)||void 0===r||r.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;null===(n=this.onFirstVideoDecodedTimeout)||void 0===n||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}applySimulcastForFirefox(e,n){var r=this;return y(function*(){if(e.length===n.length)for(let d=0;d<e.length;d++){var i,o,s,a,c;const u=e[d],l=n[d];if(l instanceof Kt&&!W(i=l._hints).call(i,Bt.LOW_STREAM)&&null!==(o=l._encoderConfig)&&void 0!==o&&o.bitrateMax&&(null===(s=l._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(a=l._scalabilityMode)&&void 0!==a&&a.numSpatialLayers&&(null===(c=l._scalabilityMode)||void 0===c?void 0:c.numSpatialLayers)>1&&"vp8"===r.store.codec){const p={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];const S=u.sender.getParameters();yield u.sender.setParameters(Object.assign(S,p))}}})()}applySimulcastEncodings(e,n){var r=this;return y(function*(){if(!ee()&&e.length===n.length)for(let i=0;i<e.length;i++){const o=n[i];if(o instanceof Kt&&r.isVP8Simulcast(o)){const s=e[i],a={},c={high:1e3*(o._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const d=s.sender.getParameters();yield s.sender.setParameters(Object.assign(d,a))}}})()}isVP8Simulcast(e){var n,r,i,o,s;return!!(e instanceof Kt&&A("SIMULCAST")&&"vp8"===this.store.codec&&!W(n=e._hints).call(n,Bt.LOW_STREAM)&&null!==(r=e._encoderConfig)&&void 0!==r&&r.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(o=e._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,r,i){if(A("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(n," SDP during P2PConnection.").concat(i,"\n"),e),"offer"===n?o=>{this.logSDPExchange(o,"answer","local"===r?"remote":"local",i)}:void 0}muteLocal(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const r=n.peerConnection.getTransceivers().filter(a=>a.mid&&-1!==e.indexOf(a.mid));if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");r.map(a=>{a.direction="inactive"});const i=yield n.peerConnection.createOffer(),o=n.logSDPExchange(i.sdp||"","offer","local","muteLocal");yield n.peerConnection.setLocalDescription(i),n.remoteSDP.muteRemote(e);const s=n.remoteSDP.toString();o?.(s),yield n.setRemoteDescription({type:"answer",sdp:s})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(r.toString()))}})()}unmuteLocal(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const r=n.peerConnection.getTransceivers().filter(a=>a.mid&&-1!==e.indexOf(a.mid));if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");r.map(function(){var a=y(function*(c){c.direction="sendonly"});return function(c){return a.apply(this,arguments)}}());const i=yield n.peerConnection.createOffer(),o=n.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");yield n.peerConnection.setLocalDescription(i),n.remoteSDP.unmuteRemote(e);const s=n.remoteSDP.toString();o?.(s),yield n.setRemoteDescription({type:"answer",sdp:s})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(r.toString()))}})()}getRemoteSSRC(e,n){var r=this;return y(function*(){var i,o;if(n=null!==(i=n)&&void 0!==i?i:null===(o=r.currentRemoteDescription)||void 0===o?void 0:o.sdp){var s;const a=null===(s=Fe.parse(n).mediaDescriptions.find(c=>c.attributes.mid===e))||void 0===s?void 0:s.attributes.ssrcs;return a?.[0].ssrcId}})()}setRemoteDescription(e){var n=this;return y(function*(){var r;yield n.peerConnection.setRemoteDescription(e),W(r=["connected","completed"]).call(r,n.peerConnection.iceConnectionState)||(n.isReady=!0,n.addRemoteCandidate())})()}mungReceiveAnswerSDP(e,n,r){const i=Fe.parse(e),o=i.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&r===q.AUDIO&&"audio"===o.media.mediaType&&ua(o),Fe.print(i)}},z(Gt.prototype,"establish",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"establish"),Gt.prototype),z(Gt.prototype,"connect",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"connect"),Gt.prototype),z(Gt.prototype,"receive",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"receive"),Gt.prototype),z(Gt.prototype,"mockReceive",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"mockReceive"),Gt.prototype),z(Gt.prototype,"stopReceiving",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"stopReceiving"),Gt.prototype),z(Gt.prototype,"restartICE",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"restartICE"),Gt.prototype),z(Gt.prototype,"close",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"close"),Gt.prototype),z(Gt.prototype,"updateEncoderConfig",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"updateEncoderConfig"),Gt.prototype),z(Gt.prototype,"updateSendParameters",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"updateSendParameters"),Gt.prototype),z(Gt.prototype,"replaceTrack",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"replaceTrack"),Gt.prototype),z(Gt.prototype,"muteLocal",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"muteLocal"),Gt.prototype),z(Gt.prototype,"unmuteLocal",[Cr],Object.getOwnPropertyDescriptor(Gt.prototype,"unmuteLocal"),Gt.prototype),Gt);function Cr(t,e,n){const r=t[e];if("function"!=typeof r)throw new Error("Cannot use mutex on object property.");return n.value=y(function*(){const i=this.mutex,o=yield i.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return yield r.apply(this,a)}finally{o()}}),n}function ym(t,e){let n=document.createElement("video"),r=document.createElement("canvas");n.setAttribute("style","display:none"),r.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),r.width=On(e.width),r.height=On(e.height);const i=On(e.framerate||15);document.body.append(n),document.body.append(r);let o=t._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play();const s=r.getContext("2d");if(!s)throw new N(v.UNEXPECTED_ERROR,"can not get canvas context");const a=St(),c=r.captureStream(a.supportRequestFrame?0:i).getVideoTracks()[0];c.canvas||(c.canvas=r),r.startCapture=()=>{if(!n)return r.stopCapture&&r.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const p=r.width*(n.videoHeight/n.videoWidth);Math.abs(p-r.height)>=2&&(_.debug("adjust low stream resolution","".concat(r.width,"x").concat(r.height," -> ").concat(r.width,"x").concat(p)),r.height=p)}s.drawImage(n,0,0,r.width,r.height),c.requestFrame&&c.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,n.srcObject=new MediaStream([o]))},r.stopCapture=kE(()=>r.startCapture&&r.startCapture(),i);const d=c.stop;return c.stop=()=>{d.call(c),n&&(n.remove(),n.srcObject=null,n=null),r&&(r.width=0,r.remove(),r.stopCapture&&r.stopCapture(),r.startCapture=void 0,r.stopCapture=void 0,r=null),_.debug("clean low stream renderer")},c}var ul=function(t){return t[t.HEIGHT=2033]="HEIGHT",t[t.FRAME_RATE=2034]="FRAME_RATE",t[t.WIDTH=2035]="WIDTH",t}(ul||{}),me=function(t){return t[t.FRAME_RATE=2002]="FRAME_RATE",t[t.WIDTH=2003]="WIDTH",t[t.HEIGHT=2004]="HEIGHT",t[t.PACKAGE_LOST=2005]="PACKAGE_LOST",t[t.AVG_ENCODE=2007]="AVG_ENCODE",t[t.NACKS=2009]="NACKS",t[t.PLIS=2010]="PLIS",t[t.FIRS=2011]="FIRS",t[t.BITRATE=2012]="BITRATE",t[t.PACKAGE_RATE=2031]="PACKAGE_RATE",t[t.ADAPTATION=2032]="ADAPTATION",t[t.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",t[t.BANDWIDTH=2061]="BANDWIDTH",t[t.RETRANSMIT=2062]="RETRANSMIT",t[t.TARGET_ENCODED=2064]="TARGET_ENCODED",t[t.TRANSMIT=2066]="TRANSMIT",t[t.FREEZE=2082]="FREEZE",t[t.DISABLED=2095]="DISABLED",t[t.PLAYER_STATUS=2128]="PLAYER_STATUS",t[t.QP_SUM=2143]="QP_SUM",t[t.BYTES_RETRANSMIT=2173]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2172]="PACKAGES_RETRANSMIT",t[t.HUGE_FRAME_SENT=2174]="HUGE_FRAME_SENT",t[t.KEY_FRAMES_ENCODED=2207]="KEY_FRAMES_ENCODED",t}(me||{}),Yo=function(t){return t[t.BITRATE=2069]="BITRATE",t[t.PACKAGE_LOST=2070]="PACKAGE_LOST",t[t.PACKAGE_RATE=2071]="PACKAGE_RATE",t[t.HEIGHT=2073]="HEIGHT",t[t.FRAME_RATE=2075]="FRAME_RATE",t[t.WIDTH=2077]="WIDTH",t}(Yo||{}),fe=function(t){return t[t.JITTER=-1]="JITTER",t[t.PACKAGE_LOST=2014]="PACKAGE_LOST",t[t.WIDTH=2018]="WIDTH",t[t.HEIGHT=2019]="HEIGHT",t[t.FRAME_RATE=2020]="FRAME_RATE",t[t.JITTER_BUFFER=2023]="JITTER_BUFFER",t[t.CURRENT_DELAY=2024]="CURRENT_DELAY",t[t.NACKS=2026]="NACKS",t[t.PLIS=2027]="PLIS",t[t.FIRS=2028]="FIRS",t[t.BITRATE=2029]="BITRATE",t[t.PACKAGE_RATE=2078]="PACKAGE_RATE",t[t.FREEZE=2084]="FREEZE",t[t.DISABLED=2101]="DISABLED",t[t.PLAYER_STATUS=2129]="PLAYER_STATUS",t[t.QP_SUM=2144]="QP_SUM",t[t.I_FRAME_DELAY=2149]="I_FRAME_DELAY",t[t.FRAMES_DROPPED=2181]="FRAMES_DROPPED",t[t.BYTES_RETRANSMIT=2175]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2176]="PACKAGES_RETRANSMIT",t[t.PACKAGES_DISCARDED=2198]="PACKAGES_DISCARDED",t[t.AVG_DECODE=2200]="AVG_DECODE",t[t.AVG_PROCESSING_DELAY=2202]="AVG_PROCESSING_DELAY",t[t.AVG_ASSEMBLY_TIME=2203]="AVG_ASSEMBLY_TIME",t[t.AVG_INTER_FRAME_DELAY=2204]="AVG_INTER_FRAME_DELAY",t[t.KEY_FRAMES_DECODED=2206]="KEY_FRAMES_DECODED",t}(fe||{}),qo=function(t){return t[t.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",t[t.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",t[t.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",t[t.FREEZE_TIME=2109]="FREEZE_TIME",t[t.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",t[t.FREEZE_DURATION=2156]="FREEZE_DURATION",t}(qo||{}),hO=function(t){return t[t.PCM_LEVEL=2104]="PCM_LEVEL",t}(hO||{}),Br=function(t){return t[t.PACKAGE_LOST=-1]="PACKAGE_LOST",t[t.LEVEL=2038]="LEVEL",t[t.BITRATE=2039]="BITRATE",t[t.PACKAGE_RATE=2040]="PACKAGE_RATE",t[t.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",t[t.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",t[t.FREEZE=2081]="FREEZE",t[t.DISABLED=2096]="DISABLED",t[t.BYTES_RETRANSMIT=2179]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2180]="PACKAGES_RETRANSMIT",t}(Br||{}),Tn=function(t){return t[t.BITRATE=2044]="BITRATE",t[t.PACKAGE_LOST=2045]="PACKAGE_LOST",t[t.PACKAGE_RATE=2046]="PACKAGE_RATE",t[t.CURRENT_DELAY=2047]="CURRENT_DELAY",t[t.JITTER_BUFFER=2054]="JITTER_BUFFER",t[t.JITTER=2055]="JITTER",t[t.FREEZE=2083]="FREEZE",t[t.DISABLED=2102]="DISABLED",t[t.PCM_LEVEL=2105]="PCM_LEVEL",t[t.PLAYER_STATUS=2130]="PLAYER_STATUS",t[t.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",t[t.BYTES_RETRANSMIT=2178]="BYTES_RETRANSMIT",t[t.PACKAGES_RETRANSMIT=2177]="PACKAGES_RETRANSMIT",t[t.PACKAGES_DISCARDED=2199]="PACKAGES_DISCARDED",t[t.AVG_PROCESSING_DELAY=2201]="AVG_PROCESSING_DELAY",t}(Tn||{}),_O=function(t){return t[t.FREEZE_TIME=-1]="FREEZE_TIME",t[t.LEVEL=2043]="LEVEL",t}(_O||{}),Nn=function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t[t.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",t}(Nn||{});const Oi=1e3;function rt(t,e,n){null!=n&&Number.isFinite(n)&&(t[e]=Math.round(Math.max(0,n)))}function EO(t){const e={[Nn.CONN_TYPE]:0,[Nn.RTT]:t.rtt,[Nn.STATS_UPDATE_INTERVAL]:t.updateInterval?Math.round(Math.max(0,t.updateInterval)):void 0};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=t.selectedCandidatePair.localCandidate.relayProtocol;"udp"===n&&(e[Nn.CONN_TYPE]=1),"tcp"===n&&(e[Nn.CONN_TYPE]=3),"tls"===n&&(e[Nn.CONN_TYPE]=4);break}case"srflx":e[Nn.CONN_TYPE]=2}return e}function mO(t){let e=0;switch(t){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3}return e}class fO extends Zt{constructor(e){super(),T(this,"store",void 0),T(this,"uploadWRTCStatsTimer",void 0),T(this,"uploadOutboundDenoiserStatsTimer",void 0),T(this,"uploadExtStatsTimer",void 0),T(this,"uploadExtUsageStatsTimer",void 0),T(this,"uploadInboundExtStatsTimer",void 0),T(this,"requestStats",void 0),T(this,"requestTransportStats",void 0),T(this,"requestLocalMedia",void 0),T(this,"requestRemoteMedia",void 0),T(this,"requestAllTracks",void 0),T(this,"requestVideoIsReady",void 0),T(this,"requestUploadStats",void 0),T(this,"requestUpload",void 0),T(this,"uploadOutboundStarted",!1),T(this,"uploadInboundStarted",!1),T(this,"uploadTransportStarted",!1),T(this,"uploadExtensionUsageStarted",!1),T(this,"lastRecvStats",void 0),T(this,"lastSendStats",void 0),T(this,"lastFullRecvStats",void 0),T(this,"lastFullSendStats",void 0),T(this,"needUploadRenderFreezeTime",!0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let n,r;if(this.uploadTransportStarted&&(n=this.requestStats(),this.store.useP2P&&(r=this.requestStats(!0))),!n&&this.uploadOutboundStarted&&(n=this.requestStats()),!r&&this.uploadInboundStarted&&(r=this.requestStats(!0)),n||r){const i={};if(this.uploadTransportStarted&&n){const o=this.getTransportStats(n,r,e);o&&(i.misc=[o])}if(this.uploadOutboundStarted&&n){const o=this.getOutboundStats(n,e?this.lastSendStats:this.lastFullSendStats,e);o&&(i.outbound=[o])}if(this.uploadInboundStarted&&r){const o=this.getInboundStats(r,e?this.lastRecvStats:this.lastFullRecvStats,e);o&&(i.inbound=o)}this.requestUploadStats(i)}this.lastRecvStats=r,this.lastSendStats=n,e||(this.lastFullRecvStats=r,this.lastFullSendStats=n)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(3!==e),4==++e&&(e=1)},Oi)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,n,r){if(!this.requestStats)return;if(r)return null==e.rtt?void 0:{addition:{[Nn.RTT]:e.rtt,[Nn.CONN_TYPE]:void 0,[Nn.STATS_UPDATE_INTERVAL]:e.updateInterval||void 0}};const i=EO(e);if(this.store.useP2P){if(n){const o=EO(n);i[Nn.CONN_TYPE]+=o[Nn.CONN_TYPE]<<3}i[Nn.CONN_TYPE]+=110}else i[Nn.CONN_TYPE]+=100;return{addition:i}}getOutboundStats(e,n,r){if(!this.requestUploadStats||!this.requestLocalMedia)return;const i=this.requestLocalMedia();if(!i||0===i.length)return;let o,s,a;return i.forEach(c=>{let[d,{track:u,ssrcs:l}]=c;switch(d){case x.LocalVideoLowTrack:case x.LocalVideoTrack:if(d===x.LocalVideoTrack){const p=function(m,f,g,R,C){const b=f.videoSend.find(Z=>Z.ssrc===m);if(!b)return;const w={},{sentFrame:D,inputFrame:V}=b;if(V&&D&&(w[me.FREEZE]=function(Rt,Nt){let oe=!0;return oe=!(Rt<=5)&&(Rt<=10?Nt<3:Rt<=20?Nt<4:Nt<5),oe}(V.frameRate,D.frameRate)?1:0),rt(w,me.QP_SUM,b.qpSumPerFrame),C)return w;switch(D&&(rt(w,me.HEIGHT,D.height),rt(w,me.WIDTH,D.width),rt(w,me.FRAME_RATE,D.frameRate)),w[me.DISABLED]=R._originMediaStreamTrack&&!R._originMediaStreamTrack.enabled||R._mediaStreamTrack&&!R._mediaStreamTrack.enabled?1:0,b.adaptionChangeReason){case"none":w[me.ADAPTATION]=0;break;case"cpu":w[me.ADAPTATION]=1;break;case"bandwidth":w[me.ADAPTATION]=2;break;case"other":w[me.ADAPTATION]=3}let U=0;b.adaptionChangeReason&&(U+=mO(b.adaptionChangeReason)),f.qualityLimitationReason&&(U+=mO(f.qualityLimitationReason)<<3),w[me.ADAPTATION]=U,w[me.PLAYER_STATUS]=PE[R._player?R._player.videoElementStatus:"uninit"],rt(w,me.NACKS,b.nacksCount),rt(w,me.PLIS,b.plisCount),rt(w,me.FIRS,b.firsCount),rt(w,me.AVG_ENCODE,b.avgEncodeMs),rt(w,me.HUGE_FRAME_SENT,b.hugeFramesSent),rt(w,me.BYTES_RETRANSMIT,b.retransmittedBytesSent),rt(w,me.PACKAGES_RETRANSMIT,b.retransmittedPacketsSent),rt(w,me.KEY_FRAMES_ENCODED,b.keyFramesEncoded);const k=g&&g.videoSend.find(Z=>Z.ssrc===m);if(k){let Z=C?Oi:3e3;k.timestamp&&b.timestamp&&(Z=b.timestamp-k.timestamp),null!=k.packets&&null!=b.packets&&rt(w,me.PACKAGE_RATE,1e3*(b.packets-k.packets)/Z),null!=b.packetsLost&&null!=k.packetsLost&&rt(w,me.PACKAGE_LOST,b.packetsLost-k.packetsLost),null!=k.bytes&&null!=b.bytes&&rt(w,me.BITRATE,8*(b.bytes-k.bytes)/Z)}return w}(l[0].ssrcId,e,n,u,r),h=r?null:function(m,f,g){const R=f.videoSend.find(U=>U.ssrc===m);if(!R)return null;const C={},b=R.inputFrame,D=b&&b.width||g&&g.videoWidth||0,V=b&&b.frameRate||0;return rt(C,ul.HEIGHT,b&&b.height||g&&g.videoHeight||0),rt(C,ul.WIDTH,D),rt(C,ul.FRAME_RATE,V),C}(l[0].ssrcId,e,u),S=r?null:function(m){const f={};return rt(f,me.RETRANSMIT,m.bitrate.retransmit),rt(f,me.TARGET_ENCODED,m.bitrate.targetEncoded),rt(f,me.ACTUAL_ENCODED,m.bitrate.actualEncoded),rt(f,me.TRANSMIT,m.bitrate.transmit),rt(f,me.BANDWIDTH,m.sendBandwidth),f}(e);s=Object.assign({},p,h,S)}else a=r?void 0:function(p,h,S){const m=h.videoSend.find(R=>R.ssrc===p);if(!m)return;const f={},g=m.sentFrame;if(g&&(rt(f,Yo.HEIGHT,g.height),rt(f,Yo.WIDTH,g.width),rt(f,Yo.FRAME_RATE,g.frameRate)),S){const R=S.videoSend.find(C=>C.ssrc===p);if(R){let C=3e3;R.timestamp&&m.timestamp&&(C=m.timestamp-R.timestamp),null!=R.packets&&null!=m.packets&&rt(f,Yo.PACKAGE_RATE,1e3*(m.packets-R.packets)/C),null!=m.packetsLost&&null!=R.packetsLost&&rt(f,Yo.PACKAGE_LOST,m.packetsLost-R.packetsLost),null!=R.bytes&&null!=m.bytes&&rt(f,Yo.BITRATE,8*(m.bytes-R.bytes)/C)}}return f}(l[0].ssrcId,e,n);break;case x.LocalAudioTrack:o=r?void 0:function(p,h,S,m){const f=h.audioSend.find(w=>w.ssrc===p);if(!f)return;const g={};g[Br.DISABLED]=m._originMediaStreamTrack&&!m._originMediaStreamTrack.enabled||m._mediaStreamTrack&&!m._mediaStreamTrack.enabled?1:0;const R=100*m._source.getAccurateVolumeLevel(),C=f.inputLevel;if(null!=C){const w=Math.ceil(50*Math.log10(100*C+1));rt(g,Br.LEVEL,w)}else rt(g,Br.LEVEL,R);rt(g,hO.PCM_LEVEL,R),rt(g,Br.AEC_RETURN_LOSS,f.aecReturnLoss),rt(g,Br.AEC_RETURN_LOSS_ENH,f.aecReturnLossEnhancement),rt(g,Br.BYTES_RETRANSMIT,f.retransmittedBytesSent),rt(g,Br.PACKAGES_RETRANSMIT,f.retransmittedPacketsSent),g[Br.FREEZE]=0;const b=S&&S.audioSend.find(w=>w.ssrc===p);if(b){let w=3e3;b.timestamp&&f.timestamp&&(w=f.timestamp-b.timestamp),null!=b.bytes&&null!=f.bytes&&rt(g,Br.BITRATE,8*(f.bytes-b.bytes)/w),null!=b.packets&&null!=f.packets&&rt(g,Br.PACKAGE_RATE,1e3*(f.packets-b.packets)/w)}return g}(l[0].ssrcId,e,n,u)}}),{high:s,low:a,audio:o}}getInboundStats(e,n,r){if(!this.requestRemoteMedia)return;const i=this.requestRemoteMedia()||[],o=[];return i.forEach(s=>{let[a,c]=s;const d={peer:a.uid};if(c.has(q.VIDEO)&&a.videoTrack){const u=a._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(a._videoSSRC)||!1,l=a.videoTrack?function(p,h,S,m,f,g,R){var C;const b=h.videoRecv.find($=>$.ssrc===p);if(!b)return;const w={},{receivedFrame:D,outputFrame:V,decodeFrameRate:U}=b,k=S&&S.videoRecv.find($=>$.ssrc===p);if(w[fe.FREEZE]=f&&Ic.isRemoteVideoFreeze(m,b,k)?1:0,rt(w,qo.FRAME_RATE_DECODE,U),rt(w,fe.QP_SUM,b.qpSumPerFrame),b.framesRateFirefox&&rt(w,fe.FRAME_RATE,b.framesRateFirefox),D&&rt(w,fe.FRAME_RATE,D.frameRate),rt(w,fe.FRAMES_DROPPED,b.framesDroppedCount),rt(w,fe.BYTES_RETRANSMIT,b.retransmittedBytesReceived),rt(w,fe.PACKAGES_RETRANSMIT,b.retransmittedPacketsReceived),rt(w,fe.PACKAGES_DISCARDED,b.packetsDiscarded),rt(w,fe.AVG_DECODE,b.avgDecodeMs),rt(w,fe.AVG_PROCESSING_DELAY,b.avgProcessingDelayMs),rt(w,fe.AVG_ASSEMBLY_TIME,b.avgFramesAssembledFromMultiplePacketsMs),rt(w,fe.AVG_INTER_FRAME_DELAY,b.avgInterFrameDelayMs),rt(w,fe.KEY_FRAMES_DECODED,b.keyFramesDecoded),k){const $=h.timestamp-S.timestamp||(R?Oi:3e3);null!=b.packetsLost&&null!=k.packetsLost&&rt(w,fe.PACKAGE_LOST,b.packetsLost-k.packetsLost),null!=k.bytes&&null!=b.bytes&&rt(w,fe.BITRATE,8*(b.bytes-k.bytes)/$),null!=k.packets&&null!=b.packets&&rt(w,fe.PACKAGE_RATE,1e3*(b.packets-k.packets)/$)}if(R)return w;D?(rt(w,fe.HEIGHT,D.height),rt(w,fe.WIDTH,D.width)):m&&(rt(w,fe.HEIGHT,m._videoHeight||0),rt(w,fe.WIDTH,m._videoWidth||0)),V&&rt(w,qo.FRAME_RATE_OUTPUT,V.frameRate);const Z=null===(C=m._player)||void 0===C?void 0:C.rendFrameRate.toFixed(0);if(Z&&rt(w,qo.FRAME_RATE_RENDER,+Z),rt(w,fe.JITTER_BUFFER,b.jitterBufferMs),rt(w,fe.CURRENT_DELAY,b.currentDelayMs),rt(w,fe.FIRS,b.firsCount),rt(w,fe.NACKS,b.nacksCount),rt(w,fe.PLIS,b.plisCount),m){w[fe.DISABLED]=m._originMediaStreamTrack.enabled&&m._mediaStreamTrack.enabled?0:1;const $=m._player;if($){const{freezeTimeCounterList:Rt,renderFreezeAccTime:Nt,videoElementStatus:oe}=$;if(Rt&&Rt.length>0&&rt(w,qo.FREEZE_TIME,Rt.splice(0,1)[0]),g&&"visible"===bi.visibility&&oe===tn.PLAYING&&St().supportRequestVideoFrameCallback){const Yt=Math.min(6e3,Nt);$.renderFreezeAccTime=Math.max(0,Nt-Yt),rt(w,qo.FREEZE_TIME_RENDER,Yt)}"number"==typeof b.totalFreezesDuration&&rt(w,qo.FREEZE_DURATION,1e3*(k&&k.totalFreezesDuration?b.totalFreezesDuration-k.totalFreezesDuration:b.totalFreezesDuration))}}if(w[fe.PLAYER_STATUS]=PE[m._player?m._player.videoElementStatus:"uninit"],k&&void 0!==b.totalInterFrameDelay&&void 0!==b.totalSquaredInterFrameDelay&&void 0!==k.totalInterFrameDelay&&void 0!==k.totalSquaredInterFrameDelay){const $=b.totalInterFrameDelay-k.totalInterFrameDelay,Nt=b.framesDecodeCount-k.framesDecodeCount,oe=$/Nt*1e3,Yt=Math.round(1e3*Math.sqrt((b.totalSquaredInterFrameDelay-k.totalSquaredInterFrameDelay-Math.pow($,2)/Nt)/Nt));!isNaN(Yt)&&oe+Yt>Math.max(3*oe,oe+150)&&(w[fe.I_FRAME_DELAY]=Yt)}return w}(a._videoSSRC,e,n,a.videoTrack,!0===u,this.needUploadRenderFreezeTime,r):void 0;l&&(d.video=l)}if(c.has(q.AUDIO)&&a.audioTrack){const u=a.audioTrack?function(l,p,h,S,m){const f=p.audioRecv.find(k=>k.ssrc===l);if(!f)return;const g={},R=h&&h.audioRecv.find(k=>k.ssrc===l),{receivedFrames:C,droppedFrames:b}=f;var w;if(rt(g,Tn.JITTER,f.jitterMs),rt(g,Tn.BYTES_RETRANSMIT,f.retransmittedBytesReceived),rt(g,Tn.PACKAGES_RETRANSMIT,f.retransmittedPacketsReceived),rt(g,Tn.PACKAGES_DISCARDED,f.packetsDiscarded),rt(g,Tn.AVG_PROCESSING_DELAY,f.avgProcessingDelayMs),null!=C&&null!=b&&(g[Tn.FREEZE]=0===(w=C)||100*b/w>20?1:0),R){const k=p.timestamp-h.timestamp||(m?Oi:3e3);null!=f.packets&&null!=R.packets&&rt(g,Tn.PACKAGE_RATE,1e3*(f.packets-R.packets)/k),null!=R.bytes&&null!=f.bytes&&rt(g,Tn.BITRATE,8*(f.bytes-R.bytes)/k),null!=f.packetsLost&&null!=R.packetsLost&&rt(g,Tn.PACKAGE_LOST,f.packetsLost-R.packetsLost)}if(m)return g;const V=100*S._source.getAccurateVolumeLevel(),U=f.outputLevel;if(null!=U){const k=Math.ceil(50*Math.log10(100*U+1));rt(g,_O.LEVEL,k)}if(rt(g,Tn.PCM_LEVEL,V),S&&(g[Tn.DISABLED]=S._originMediaStreamTrack.enabled&&S._mediaStreamTrack.enabled?0:1),rt(g,Tn.JITTER_BUFFER,f.jitterBufferMs),rt(g,Tn.CURRENT_DELAY,f.jitterBufferMs),g[Tn.PLAYER_STATUS]=PE[_n.getPlayerState(S.getTrackId())],R){const k=f.concealedSamples-R.concealedSamples;k>0&&rt(g,Tn.CONCEALED_SAMPLES,k)}return g}(a._audioSSRC,e,n,a.audioTrack,r):void 0;u&&(d.audio=u)}(d.video||d.audio)&&o.push(d)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find(n=>n instanceof Xu);if(e&&e._external.getDenoiserStats){const n=e._external.getDenoiserStats();n&&this.requestUpload(cc.DENOISER_STATS,n)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[n,r]=e;r.has(q.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)}),r.has(q.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){var e=this;if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const n=new Map;this.uploadExtUsageStatsTimer=window.setInterval(y(function*(){const r=Date.now(),i={connectionInterval:A("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:r};let o=[];const s=e.requestAllTracks&&e.requestAllTracks()||[];for(const u of s)!u.muted&&u.enabled&&(o=o.concat(yield u.getProcessorUsage()));const a=e.requestRemoteMedia&&e.requestRemoteMedia()||[];for(const[u,l]of a)l.has(q.VIDEO)&&u.videoTrack&&(o=o.concat(yield u.videoTrack.getProcessorUsage())),l.has(q.AUDIO)&&u.audioTrack&&(o=o.concat(yield u.audioTrack.getProcessorUsage()));if(0===o.length)return;i.details=function(u,l){const p={};for(const{id:f,value:g,level:R,direction:C}of u){var h;const b=null!==(h=l.get(f))&&void 0!==h?h:0,w=2===g?b+A("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:b;var S,m;l.set(f,w),p[f]?(2===g&&(p[f].value=g),R>p[f].level&&(p[f].level=R),"remote"===C&&(p[f].remoteUidCount+=1),p[f].totalTs=null!==(S=l.get(f))&&void 0!==S?S:0):p[f]={value:g,level:R,remoteUidCount:"local"===C?0:1,totalTs:null!==(m=l.get(f))&&void 0!==m?m:0}}return Object.keys(p).map(f=>{const{level:g,value:R,totalTs:C}=p[f];return{id:f,level:g,value:R,totalTs:C}})}(o,n);const c=Date.now();e.requestUpload&&e.requestUpload(cc.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c>r?c:r+1})}),A("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class uo{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,n){T(this,"uid",void 0),T(this,"_uintid",void 0),T(this,"_trust_in_room_",!0),T(this,"_trust_audio_enabled_state_",!0),T(this,"_trust_video_enabled_state_",!0),T(this,"_trust_audio_mute_state_",!0),T(this,"_trust_video_mute_state_",!0),T(this,"_audio_muted_",!1),T(this,"_video_muted_",!1),T(this,"_audio_enabled_",!0),T(this,"_video_enabled_",!0),T(this,"_audio_added_",!1),T(this,"_video_added_",!1),T(this,"_is_pre_created",!1),T(this,"_video_pre_subscribed",!1),T(this,"_audio_pre_subscribed",!1),T(this,"_trust_video_stream_added_state_",!0),T(this,"_trust_audio_stream_added_state_",!0),T(this,"_audioTrack",void 0),T(this,"_videoTrack",void 0),T(this,"_dataChannels",[]),T(this,"_audioSSRC",void 0),T(this,"_videoSSRC",void 0),T(this,"_audioOrtc",void 0),T(this,"_videoOrtc",void 0),T(this,"_cname",void 0),T(this,"_rtxSsrcId",void 0),T(this,"_videoMid",void 0),T(this,"_audioMid",void 0),this.uid=e,this._uintid=n}}let jr=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({});function J3(t,e){var n;let r;switch(e){case x.LocalAudioTrack:r=At.Audio;break;case x.LocalVideoTrack:r=W(n=t._hints).call(n,Bt.SCREEN_TRACK)?At.Screen:At.High;break;case x.LocalVideoLowTrack:r=At.Low}return r}function Cm(t){const e=St();if(t.some(n=>n._bypassWebAudio))throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function Im(t,e){Cm(t);const n=e||new Ie;return t.forEach(r=>n.addAudioTrack(r)),n}var gO,TO,SO,RO,vO,yO,CO,IO,AO,bO,OO,Jt;function wO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function ll(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?wO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):wO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let Dn=(gO=Gr(jr.SEND_ONLY),TO=Gr(jr.SEND_ONLY),SO=Gr(),RO=Gr(jr.RECEIVE_ONLY),vO=Gr(jr.RECEIVE_ONLY),yO=Gr(jr.RECEIVE_ONLY),CO=Gr(jr.RECEIVE_ONLY),IO=Gr(jr.RECEIVE_ONLY),AO=Gr(jr.RECEIVE_ONLY),bO=Gr(),OO=Gr(jr.RECEIVE_ONLY),Jt=class extends Zt{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(nt.StateChange,e,this._state)}constructor(t,e){var n;super(),n=this,T(this,"isPlanB",!1),T(this,"store",void 0),T(this,"statsUploader",void 0),T(this,"sendConnection",void 0),T(this,"recvConnection",void 0),T(this,"localTrackMap",new Map),T(this,"remoteUserMap",new Map),T(this,"localDataChannels",[]),T(this,"pendingLocalTracks",[]),T(this,"pendingRemoteTracks",[]),T(this,"statsCollector",void 0),T(this,"dtlsFailedCount",0),T(this,"sendMutex",void 0),T(this,"recvMutex",void 0),T(this,"_state",bt.Disconnected),T(this,"_restartStates",["disconnected","failed"]),T(this,"reconnectInterval",void 0),T(this,"uploadUnplinkStarted",!1),T(this,"uploadDownlinkStarted",!1),T(this,"uplinkStateUploadInterval",void 0),T(this,"downlinkStatsUploadInterval",void 0),T(this,"handleMuteLocalTrack",function(){var r=y(function*(i,o,s){const a=yield n.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!n.sendConnection||n.state!==bt.Connected)return void s(new P(v.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const u=n.filterTobeMutedTracks(i);if(0===u.length)return void o();const l=u.find(m=>"videoLowTrack"===m[0]);l&&l[1].track._originMediaStreamTrack.stop(),yield n.sendConnection.muteLocal(u.map(m=>{let[,{id:f}]=m;return f}));let p=!1;var c,d;p="video"===i.trackMediaType?!(null===(c=n.localTrackMap.get(x.LocalAudioTrack))||void 0===c||!c.track._muted):void 0===(null===(d=n.localTrackMap.get(x.LocalVideoTrack))||void 0===d?void 0:d.id);const h=n.createMuteMessage(u);yield xt(n,nt.RequestMuteLocal,h);const S="video"===i.trackMediaType?eo.MUTE_LOCAL_VIDEO:eo.MUTE_LOCAL_AUDIO;yield xt(n,nt.RequestP2PMuteLocal,{action:S,message:h,isMuteAll:p}),o()}catch(u){s(u)}finally{a()}});return function(i,o,s){return r.apply(this,arguments)}}()),T(this,"handleUnmuteLocalTrack",function(){var r=y(function*(i,o,s){const a=yield n.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!n.sendConnection||n.state!==bt.Connected)return void s(new P(v.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const c=n.filterTobeUnmutedTracks(i);if(0===c.length)return void o();yield n.sendConnection.unmuteLocal(c.map(l=>{let[,{id:p}]=l;return p}));const d=n.createUnmuteMessage(c),u="video"===i.trackMediaType?eo.UNMUTE_LOCAL_VIDEO:eo.UNMUTE_LOCAL_AUDIO;yield xt(n,nt.RequestP2PMuteLocal,{action:u,message:d}),o()}catch(c){s(c)}finally{a()}});return function(i,o,s){return r.apply(this,arguments)}}()),T(this,"handleUpdateVideoEncoder",function(){var r=y(function*(i,o,s){const a=yield n.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const c=n.localTrackMap.get(x.LocalVideoTrack);if(!n.sendConnection||!c||c.track!==i||n.state!==bt.Connected)return void o();const{id:d,track:u}=c;d&&(yield n.sendConnection.updateSendParameters(d,u),yield n.sendConnection.updateEncoderConfig(d,u),n.emit(nt.UpdateVideoEncoder,u)),o()}catch(c){s(c)}finally{a()}});return function(i,o,s){return r.apply(this,arguments)}}()),T(this,"handleUpdateVideoSendParameters",function(){var r=y(function*(i,o,s){const a=yield n.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const c=n.localTrackMap.get(x.LocalVideoTrack);if(!n.sendConnection||!c||c.track!==i||n.state!==bt.Connected)return void o();const{id:d,track:u}=c;d&&(yield n.sendConnection.updateSendParameters(d,u)),o()}catch(c){s(c)}finally{a()}});return function(i,o,s){return r.apply(this,arguments)}}()),T(this,"handleReplaceTrack",function(){var r=y(function*(i,o,s,a){let c;_.debug("[".concat(n.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),"boolean"==typeof a&&a||(c=yield n.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var d;const l=Array.from(n.localTrackMap.entries()).find(p=>{let[,{track:h}]=p;return i===h});if(!n.sendConnection||!l||void 0===l[1].id||n.state!==bt.Connected)return void o();if(yield null===(d=n.sendConnection)||void 0===d?void 0:d.replaceTrack(i,l[1].id),l[0]===x.LocalVideoTrack&&St().supportDualStreamEncoding){const p=n.localTrackMap.get(x.LocalVideoLowTrack);if(p){const h=i._mediaStreamTrack.clone();p.track._originMediaStreamTrack.stop(),p.track._mediaStreamTrack=h,p.track._originMediaStreamTrack=h,yield new H((S,m)=>{n.handleReplaceTrack(p.track,S,m,!0)})}}o()}catch(l){s(l)}finally{var u;null===(u=c)||void 0===u||u()}});return function(i,o,s,a){return r.apply(this,arguments)}}()),T(this,"handleGetLocalVideoStats",r=>{r(this.statsCollector.getLocalVideoTrackStats())}),T(this,"handleGetLocalAudioStats",r=>{r(this.statsCollector.getLocalAudioTrackStats())}),T(this,"handleGetRemoteVideoStats",r=>this.statsCollector.getRemoteVideoTrackStats(r.uid)[r.uid]),T(this,"handleGetRemoteAudioStats",r=>this.statsCollector.getRemoteAudioTrackStats(r.uid)[r.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new fO(t),this.bindStatsUploaderEvents(),this.sendMutex=new Je("P2PChannel2-send-mutex",t.clientId),this.recvMutex=new Je("P2PChannel2-recv-mutex",t.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(r=>{r&&("disconnected"!==r.iceConnectionState&&"failed"!==r.iceConnectionState||this.handleDisconnect(r.direction))})},A("ICE_RESTART_INTERVAL"))}startP2PConnection(t,e){return y(function*(){throw new P(v.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")})()}connect(t){return y(function*(){throw new P(v.NOT_SUPPORTED,"p2p mode does not support connect.")})()}startP2P(t,e){var n=this;return y(function*(){let r;try{if(e){n.recvConnection&&(_.warning("[".concat(n.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),n.recvConnection.close(),n.unbindConnectionEvents(n.recvConnection)),r=yield n.recvMutex.lock("From P2PChannel.startP2P"),n.recvConnection=new pO(t,n.store,dn.RECEIVE_ONLY),n.bindConnectionEvents(n.recvConnection);const i=yield n.recvConnection.establish(e);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{n.state=bt.New,n.sendConnection&&(_.warning("[".concat(n.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),n.sendConnection.close(),n.unbindConnectionEvents(n.sendConnection)),r=yield n.sendMutex.lock("From P2PChannel.startP2P"),n.sendConnection=new pO(t,n.store),n.store.peerConnectionStart(),n.bindConnectionEvents(n.sendConnection);const i=yield n.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{r&&r()}})()}p2pConnect(t){var e=this;return y(function*(){if(!e.sendConnection)throw new P(v.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");e.store.peerConnectionStart(),yield e.sendConnection.connect(t),e.statsUploader.startUploadTransportStats(),e.statsUploader.startUploadExtensionUsageStats(),e.state=bt.Connected})()}addRemoteCandidate(t,e){var n=this;return y(function*(){if(e===dn.RECEIVE_ONLY){if(!n.sendConnection)throw new P(v.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");yield n.sendConnection.addRemoteCandidate(t)}else{if(!n.recvConnection)throw new P(v.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");yield n.recvConnection.addRemoteCandidate(t)}})()}publish(t,e,n){var r=this;return Zn(function*(){const i=yield mt(r.sendMutex.lock("From P2PChannel.publish"));try{if(!r.sendConnection||r.state!==bt.Connected){r.throwIfTrackTypeNotMatch(t);const d=t.filter(u=>-1===r.pendingLocalTracks.indexOf(u));return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(d))}r.store.pubId=r.store.pubId+1,Qe.markPublishStart(r.store.clientId,r.store.pubId);const o=r.filterTobePublishedTracks(t,e,n);if(0===o.length)return void(yield mt(r.tryToUnmuteAudio(t)));o.forEach(d=>{let{track:u,type:l}=d;const p=Date.now();r.store.publish(u.getTrackId(),l===x.LocalAudioTrack?"audio":"video",p)}),r.bindLocalTrackEvents(o);const s=yield mt(r.sendConnection.send(o.map(d=>{let{track:u}=d;return u}),r.store.codec,r.store.audioCodec)),a=(yield mt(s.next())).value,c=r.createGatewayPublishMessage(o,a);try{yield c}catch(d){throw s.throw(d),d?.code===v.WS_ABORT&&o.forEach(u=>{let{track:l}=u;-1===r.pendingLocalTracks.indexOf(l)&&r.pendingLocalTracks.push(l)}),r.unbindLocalTrackEvents(o),d}yield mt(s.next()),o.forEach(d=>{let{type:u}=d;r.statsCollector.addLocalStats(u)}),r.statsUploader.startUploadOutboundStats(),r.assignLocalTracks(o,a),o.forEach(d=>{let{track:u,type:l}=d;const p=Date.now();r.store.publish(u.getTrackId(),l===x.LocalAudioTrack?"audio":"video",void 0,p)}),r.startUploadUplinkState()}finally{i()}})()}unpublish(t){var e=this;return y(function*(){if(!e.sendConnection||e.state!==bt.Connected)return void(0===t.length?e.pendingLocalTracks.length=0:e.pendingLocalTracks=e.pendingLocalTracks.filter(o=>!W(t).call(t,o)));const n=e.filterTobeUnpublishedTracks(t);if(0===n.length)return;const r=n.find(o=>"videoLowTrack"===o[0]);r&&r[1].track.close();const i=e.createGatewayUnpublishMessage(n);if(yield e.sendConnection.stopSending(n.map(o=>{let[,{id:s}]=o;return s})),e.withdrawLocalTracks(n),e.unbindLocalTrackEvents(n.map(o=>{let[s,{track:a}]=o;return{type:s,track:a}})),n.forEach(o=>{let[s]=o;e.statsCollector.removeLocalStats(s)}),0===e.localTrackMap.size&&(e.statsUploader.stopUploadOutboundStats(),e.stopUploadUplinkState()),e.sendConnection&&e.state===bt.Connected)return r&&r[1].track.close(),i;t.forEach(o=>{const s=e.pendingLocalTracks.indexOf(o);-1!==s&&e.pendingLocalTracks.splice(s,1)})})()}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const t=()=>{const e=[],n=[];Array.from(this.localTrackMap.entries()).forEach(r=>{let[i,{track:o,ssrcs:s}]=r;const a={stream_type:J3(o,i),ssrcs:s};o._muted||!o._enabled?e.push(a):n.push(a)}),e.length>0&&e.forEach(r=>{xt(this,nt.RequestMuteLocal,[r])}),n.length>0&&n.forEach(r=>{xt(this,nt.RequestUnmuteLocal,[r])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return Zn(function*(){throw new P(v.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}republish(){var t=this;return y(function*(){t.pendingLocalTracks.length>0&&(_.debug("[".concat(t.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),yield He(t,nt.RequestRePublish,t.pendingLocalTracks),t.emit(nt.MediaReconnectEnd,t.store.uid),t.pendingLocalTracks=[])})()}unpublishLowStream(){return y(function*(){throw new P(v.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")})()}subscribe(t,e,n,r){var i=this;return y(function*(){var o;if(!i.recvConnection)throw new P(v.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(o=i.remoteUserMap.get(t))&&void 0!==o&&o.has(e))return;const{track:s,mid:a,transceiver:c}=yield i.recvConnection.receive(e,[{ssrcId:n}],String(t.uid),r);e===q.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(s):(t._audioTrack=new aa(s,t.uid,t._uintid,i.store),_.info("[".concat(i.store.clientId,"] [").concat(i.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),i.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=n,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(s):(t._videoTrack=new sa(s,t.uid,t._uintid,i.store),_.info("[".concat(i.store.clientId,"] [").concat(i.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),i.bindRemoteTrackEvents(t,t._videoTrack));const d=i.remoteUserMap.get(t);d?d.set(e,a):i.remoteUserMap.set(t,new Map([[e,a]])),i.statsCollector.addRemoteStats(t.uid),i.statsUploader.startUploadInboundStats(),i.startUploadDownlinkState();const u=i.pendingRemoteTracks.findIndex(l=>{let{user:p,kind:h}=l;return p.uid===t.uid&&e===h});-1!==u&&(i.pendingRemoteTracks.splice(u,1),i.emit(nt.MediaReconnectEnd,t.uid))})()}mockSubscribe(t,e,n,r){var i=this;return y(function*(){if(!i.recvConnection)throw new P(v.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");yield i.recvConnection.mockReceive(e,[{ssrcId:n}],String(t.uid),r)})()}unsubscribe(t,e,n){var r=this;return y(function*(){const i=r.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return void 0!==e?a.uid===t.uid&&e===c:a.uid===t.uid});if(i.forEach(s=>{const a=r.pendingRemoteTracks.indexOf(s);r.pendingRemoteTracks.splice(a,1)}),r.recvConnection||n||i.forEach(s=>{let{kind:a}=s;var c;if(a===q.AUDIO)null===(c=t._audioTrack)||void 0===c||c._destroy(),t._audioTrack=void 0;else if(a===q.VIDEO){var d;null===(d=t._videoTrack)||void 0===d||d._destroy(),t._videoTrack=void 0}}),!r.recvConnection)return;const o=r.filterTobeUnSubscribedTracks(t,e);0!==o.length&&(yield r.recvConnection.stopReceiving(o.map(s=>{let[,{id:a}]=s;return a})),r.withdrawRemoteTracks(o),0===r.remoteUserMap.size&&(r.statsUploader.stopUploadInboundStats(),r.stopUploadDownlinkState()),o.forEach(s=>{let[a,{kind:c}]=s;var d,u;if(c===q.VIDEO&&a._videoSSRC&&(null===(d=r.recvConnection)||void 0===d||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===q.VIDEO)r.unbindRemoteTrackEvents(a._videoTrack),n||(null===(u=a._videoTrack)||void 0===u||u._destroy(),a._videoTrack=void 0);else if(c===q.AUDIO){var l;r.unbindRemoteTrackEvents(a._audioTrack),!n&&(null===(l=a._audioTrack)||void 0===l||l._destroy(),a._audioTrack=void 0)}}),o.forEach(s=>{let[,{kind:a}]=s;xt(r,nt.RequestP2PMuteRemote,a)}))})()}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,n]=e;[q.VIDEO,q.AUDIO].forEach(r=>{n.has(r)?xt(this,nt.RequestP2PUnmuteRemote,r):xt(this,nt.RequestP2PMuteRemote,r)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}massSubscribe(t){return y(function*(){throw new P(v.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")})()}massSubscribeNoLock(t){return y(function*(){throw new P(v.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")})()}massUnsubscribe(t){return y(function*(){throw new P(v.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")})()}massUnsubscribeNoLock(t){return y(function*(){throw new P(v.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")})()}muteRemote(t,e){var n=this;return y(function*(){if(!n.recvConnection)return;const r=n.remoteUserMap.get(t);if(!r)return void _.warning("[".concat(n.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!r.get(e))return void _.warning("[".concat(n.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const i=e===q.VIDEO?t._videoSSRC:t._audioSSRC;void 0!==i&&n.recvConnection.setStatsRemoteVideoIsReady(i,!1)})()}unmuteRemote(t,e){var n=this;return y(function*(){return n.unmuteRemoteNoLock(t,e)})()}unmuteRemoteNoLock(t,e){var n=this;return y(function*(){if(!n.recvConnection)return;const r=n.remoteUserMap.get(t);r?r.get(e)||_.warning("[".concat(n.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,".")):_.warning("[".concat(n.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."))})()}getAllTracks(t){const e=this.localTrackMap.get(x.LocalAudioTrack);if(e?.track instanceof Ie){const n=e.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[i]=r;return i!==x.LocalAudioTrack}).filter(r=>{let[i]=r;return!(t&&i===x.LocalVideoLowTrack)}).map(r=>{let[,{track:i}]=r;return i}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return!(t&&r===x.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r})}reportPublishEvent(t,e,n,r,i){if(t){const s=this.localTrackMap.get(x.LocalAudioTrack),a=this.localTrackMap.get(r?x.LocalVideoLowTrack:x.LocalVideoTrack);Q.publish(this.store.sessionId,{eventElapse:Qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:-1!==a?.track._hints.indexOf(Bt.SCREEN_TRACK),audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}else{var o;n||(n=[]);const s=n.find(c=>c instanceof ie),a=r?null===(o=this.localTrackMap.get(x.LocalVideoTrack))||void 0===o?void 0:o.track:n.find(c=>c instanceof Kt);Q.publish(this.store.sessionId,{eventElapse:Qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:-1!==a?._hints.indexOf(Bt.SCREEN_TRACK),audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}}reportSubscribeEvent(t,e,n,r){const i=r===q.VIDEO?n._videoSSRC:n._audioSSRC;i&&Q.subscribe(this.store.sessionId,{succ:t,ec:e,video:r===q.VIDEO,audio:r===q.AUDIO,peerid:n.uid,subscribeRequestid:r===q.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Qe.measureFromSubscribeStart(this.store.clientId,i)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Je("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new Je("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(x.LocalAudioTrack);if(t?.track instanceof Ie){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=bt.Disconnected}getStats(t){var e,n;return t?null===(n=this.recvConnection)||void 0===n?void 0:n.getStats():null===(e=this.sendConnection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return(null===(e=this.recvConnection)||void 0===e?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(x.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(x.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof Kt||e&&e.track instanceof ie?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}hasRemoteMediaWithLock(t,e){var n=this;return y(function*(){if(!t)return n.remoteUserMap.size>0;const r=n.remoteUserMap.get(t);return!!r&&(!e||r.has(e))})()}getRemoteMedia(t){var e;const n=Array.from(kn(e=this.remoteUserMap).call(e)).find(r=>r.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[r]=n;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(x.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Ga(t).call(t,(n,r)=>n.level-r.level),t}disconnectForReconnect(){var t=this;return y(function*(){t.sendConnection&&t.recvConnection&&(_.debug("[".concat(t.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),t.state=bt.Reconnecting,A("KEEP_LAST_FRAME")&&0!==t.remoteUserMap.size&&Array.from(t.remoteUserMap.entries()).forEach(e=>{let[n]=e;var r;n._videoTrack&&n._videoTrack._player&&(null===(r=n._videoTrack._player.getVideoElement())||void 0===r||r.pause(),n._videoTrack._player.isKeepLastFrame=!0,n._videoTrack._originMediaStreamTrack.stop())}),t.sendConnection.close(),t.unbindConnectionEvents(t.sendConnection),t.sendConnection=void 0,t.recvConnection.close(),t.unbindConnectionEvents(t.recvConnection),t.recvConnection=void 0,0!==t.localTrackMap.size&&(Array.from(t.localTrackMap.entries()).forEach(e=>{var n;let[r,{track:i}]=e;switch(r){case x.LocalVideoTrack:W(n=i._hints).call(n,Bt.LOW_STREAM)?i.close():t.pendingLocalTracks.push(i);break;case x.LocalAudioTrack:i instanceof Ie?t.pendingLocalTracks=t.pendingLocalTracks.concat(i.trackList):t.pendingLocalTracks.push(i)}}),t.emit(nt.MediaReconnectStart,t.store.uid)),t.unbindLocalTrackEvents(),t.localTrackMap.clear(),0!==t.remoteUserMap.size&&Array.from(t.remoteUserMap.entries()).forEach(e=>{let[n,r]=e;Array.from(kn(r).call(r)).forEach(i=>{t.setPendingRemoteMedia(n,i)}),t.emit(nt.MediaReconnectStart,n.uid)}),t.unbindAllRemoteTrackEvents(),t.remoteUserMap.clear(),t.stopUploadUplinkState(),t.stopUploadDownlinkState(),t.statsUploader.stopUploadOutboundStats(),t.statsUploader.stopUploadInboundStats(),t.statsUploader.stopUploadTransportStats(),_.debug("[".concat(t.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))})()}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:r,kind:i}=n;if((t instanceof uo?t.uid:t)===r.uid&&e===i)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t,e){var n=this;return y(function*(){let r,i;if(t===dn.SEND_ONLY){if(!n.sendConnection)throw new P(v.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");r=yield n.sendMutex.lock("From P2PChannel.restartICE"),i=n.sendConnection}else{if(!n.recvConnection)throw new P(v.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");r=yield n.recvMutex.lock("From P2PChannel.restartICE"),i=n.recvConnection}try{if(e){const o=yield i.restartICE(e);return i.isInRestartIce=!1,o}{const o=yield i.restartICE();if(o){const s=yield He(n,nt.RequestP2PRestartICE,{direction:dn.RECEIVE_ONLY,iceParameter:o});yield i.restartICE(s),i.isInRestartIce=!1}}}finally{r()}})()}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),e=this.localTrackMap.get(x.LocalVideoTrack),n=this.localTrackMap.get(x.LocalAudioTrack),r=t.videoSend.find(h=>{var S;return h.ssrc===(null==e||null===(S=e.ssrcs)||void 0===S?void 0:S[0].ssrcId)}),i=t.audioSend.find(h=>{var S;return h.ssrc===(null==n||null===(S=n.ssrcs)||void 0===S?void 0:S[0].ssrcId)});if(!r||!i)return 1;const o=$n(this,nt.NeedSignalRTT),s=r?r.rttMs:void 0,a=i?i.rttMs:void 0,c=s&&a?(s+a)/2:s||a,u=100*t.sendPacketLossRate*.7/50+.3*((c&&o?(c+o)/2:c||o)||0)/1500,l=u<.17?1:u<.36?2:u<.59?3:u<.1?4:5,p=e?.track;if(p&&p._encoderConfig&&-1===p._hints.indexOf(Bt.SCREEN_TRACK)){const h=p._encoderConfig.bitrateMax,S=t.bitrate.actualEncoded;if(h&&S){const m=(1e3*h-S)/(1e3*h);return fC[m<.15?0:m<.3?1:m<.45?2:m<.6?3:4][l]}}return l}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[r]=n;const i=r._audioSSRC,o=r._videoSSRC,s=t.audioRecv.find(S=>S.ssrc===i),a=t.videoRecv.find(S=>S.ssrc===o);if(!s&&!a)return void(e+=1);const c=$n(this,nt.NeedSignalRTT),d=t.rtt,u=(d&&c?(d+c)/2:d||c)||0,l=s?s.jitterMs:void 0,p=t.recvPacketLossRate;let h=.7*p*100/50+.3*u/1500;l&&(h=.6*p*100/50+.2*u/1500+.2*l/400),e+=h<.1?1:h<.17?2:h<.36?3:h<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}muteLocalTrack(t){var e=this;return y(function*(){return new H((n,r)=>{e.handleMuteLocalTrack(t,n,r)})})()}filterTobePublishedTracks(t,e,n){const r=[],i=St(),o=this.getAllTracks();t=Us(t=t.filter(c=>-1===o.indexOf(c)));let s=!1,a=!1;for(const c of t){if(c instanceof Kt&&(this.localTrackMap.has(x.LocalVideoTrack)||s?new P(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:c,type:x.LocalVideoTrack}),s=!0),e)){const d=this.getLowVideoTrack(c,n);r.push({track:d,type:x.LocalVideoLowTrack})}if(c instanceof ie){const d=this.localTrackMap.get(x.LocalAudioTrack);if(d){if(!(d.track instanceof Ie))throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const u=r.find(l=>{let{type:p}=l;return p===x.LocalAudioTrack});if(!(u.track instanceof Ie))throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(c)}else{if(!i.webAudioMediaStreamDest||c instanceof Ie||c._bypassWebAudio)r.push({track:c,type:x.LocalAudioTrack});else{const u=new Ie;u.addAudioTrack(c),r.push({track:u,type:x.LocalAudioTrack})}a=!0}}}return r}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=Us(t=t.filter(r=>-1!==n.indexOf(r)));for(const r of t){if(r instanceof ie){const i=this.localTrackMap.get(x.LocalAudioTrack);if(!i)continue;i.track instanceof Ie?(i.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),0===i.track.trackList.length&&(e.push([x.LocalAudioTrack,i]),i.track.close())):e.push([x.LocalAudioTrack,i])}if(r instanceof Kt){const i=this.localTrackMap.get(x.LocalVideoTrack);if(!i)continue;e.push([x.LocalVideoTrack,i]);const o=this.localTrackMap.get(x.LocalVideoLowTrack);o&&e.push([x.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:r}=e;switch(r){case x.LocalVideoTrack:n.addListener(Y.GET_STATS,this.handleGetLocalVideoStats),n.addListener(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Y.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(Y.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(Y.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case x.LocalAudioTrack:this.bindLocalAudioTrackEvents(n)}})}bindLocalAudioTrackEvents(t,e){t instanceof Ie?t.trackList.forEach(n=>{n.addListener(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Y.GET_STATS,this.handleGetLocalAudioStats),n.addListener(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(Y.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(Y.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:r}]=e;return{track:r,type:n}})),t.forEach(e=>{let{track:n,type:r}=e;switch(r){case x.LocalVideoTrack:n.off(Y.GET_STATS,this.handleGetLocalVideoStats),n.off(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(Y.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(Y.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(Y.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case x.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n)}})}unbindLocalAudioTrackEvents(t){t instanceof Ie?t.trackList.forEach(e=>{e.off(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Y.GET_STATS,this.handleGetLocalAudioStats),e.off(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(Y.GET_STATS,this.handleGetLocalAudioStats),t.off(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Y.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof sa&&e.addListener(Y.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof aa&&e.addListener(Y.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(Y.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(q.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(q.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,r)=>{var i;let o,{track:s,type:a}=n;switch(a){case x.LocalAudioTrack:o=At.Audio;break;case x.LocalVideoTrack:o=W(i=s._hints).call(i,Bt.SCREEN_TRACK)?At.Screen:At.High;break;case x.LocalVideoLowTrack:o=At.Low}return{kind:a===x.LocalAudioTrack?q.AUDIO:q.VIDEO,stream_type:o,mid:e[r].id,ssrcs:e[r].localSSRC,isMuted:s.muted||!s.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:s,id:a}]=e;switch(i){case x.LocalVideoTrack:r=W(n=o._hints).call(n,Bt.SCREEN_TRACK)?At.Screen:At.High;break;case x.LocalAudioTrack:r=At.Audio;break;case x.LocalVideoLowTrack:r=At.Low}return{stream_type:r,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((n,r)=>{let{track:i,type:o}=n;this.localTrackMap.set(o,{track:i,id:e[r].id,ssrcs:e[r].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){var e=this;t.onConnectionStateChange=function(){var n=y(function*(r){var i;_.info("[".concat(e.store.clientId,"] [p2pId: ").concat(e.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(r,")")),e.emit(nt.PeerConnectionStateChange,r),"connected"!==r||e.store.keyMetrics.peerConnectionEnd||e.store.peerConnectionEnd(),"connected"===r&&(t.isInRestartIce=!1),W(i=e._restartStates).call(i,r)&&!t.isInRestartIce&&("disconnected"===r&&(yield Me(800)),"disconnected"!==t.iceConnectionState&&"failed"!==t.iceConnectionState||e.handleDisconnect(t.direction))});return function(r){return n.apply(this,arguments)}}(),t.onICEConnectionStateChange=n=>{"connected"!==n||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(n,")")),Q.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:n,tag:ne.TRACER}).onSuccess(),this.emit(nt.IceConnectionStateChange,n)},t.onICETransportStateChange=n=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(n,")"))},t.onDTLSTransportStateChange=n=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(n,")"))},t.onDTLSTransportError=n=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(n,")"))},t.onFirstAudioDecoded=n=>{var r;const i=Array.from(kn(r=this.remoteUserMap).call(r)).find(s=>s._audioSSRC===n);var o;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),null===(o=i.audioTrack)||void 0===o||o.emit(ea.FIRST_FRAME_DECODED),Q.firstRemoteFrame(this.store.sessionId,Ue.FIRST_AUDIO_DECODE,$t.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:Qe.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=n=>{var r;const i=Array.from(kn(r=this.remoteUserMap).call(r)).find(o=>o._audioSSRC===n);i&&Q.firstRemoteFrame(this.store.sessionId,Ue.FIRST_AUDIO_RECEIVED,$t.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:Qe.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(n,r,i)=>{this.reportVideoFirstFrameDecoded(n,r,i)},t.onFirstVideoReceived=n=>{var r;const i=Array.from(kn(r=this.remoteUserMap).call(r)).find(o=>o._videoSSRC===n);i&&Q.firstRemoteFrame(this.store.sessionId,Ue.FIRST_VIDEO_RECEIVED,$t.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:Qe.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(n,r)=>{const i="relay"===n.candidateType;"unknown"!==r.candidateType&&i===("relay"===r.candidateType)||this.emit(nt.ConnectionTypeChange,i),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(no(r))," -> ").concat(JSON.stringify(no(n)),")"))},t.onSelectedRemoteCandidateChanged=(n,r)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(no(r))," -> ").concat(JSON.stringify(no(n)),")"))},t.onFirstVideoDecodedTimeout=n=>{this.reportVideoFirstFrameDecoded(n,void 0,void 0,!0)},t.onLocalCandidate=n=>{this.emit(nt.LocalCandidate,{candidate:n,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}handleDisconnect(t){var e=this;return y(function*(){const n=t===dn.SEND_ONLY?e.sendConnection:e.recvConnection;n&&!n.isInRestartIce&&(n.isInRestartIce=!0,_.debug("[".concat(e.store.clientId,"] [P2PChannel-").concat(n.name,"] start use restartICE")),t===dn.SEND_ONLY?e.restartICE(t):He(e,nt.RequestP2PRestartICE,{direction:dn.SEND_ONLY}))})()}filterTobeMutedTracks(t){const e=[];if(-1===this.getAllTracks().indexOf(t))return e;const n=this.localTrackMap.get(x.LocalAudioTrack);if(t instanceof ie&&n?.track instanceof Ie)return n.track.isActive||e.push([x.LocalAudioTrack,n]),e;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return t===o});if(r&&(e.push(r),r[0]===x.LocalVideoTrack)){const i=this.localTrackMap.get(x.LocalVideoLowTrack);i&&e.push([x.LocalVideoLowTrack,i])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(x.LocalAudioTrack);if(t instanceof ie&&n?.track instanceof Ie)return n.track.isActive&&e.push([x.LocalAudioTrack,n]),e;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return t===o});if(r)if(r[0]===x.LocalVideoTrack){e.push(r);const i=this.localTrackMap.get(x.LocalVideoLowTrack);i&&e.push([x.LocalVideoLowTrack,i])}else e.push(r);return e}createMuteMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:s,id:a}]=e;switch(i){case x.LocalAudioTrack:r=At.Audio;break;case x.LocalVideoTrack:r=W(n=o._hints).call(n,Bt.SCREEN_TRACK)?At.Screen:At.High;break;case x.LocalVideoLowTrack:r=At.Low}return{stream_type:r,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:s,id:a}]=e;switch(i){case x.LocalAudioTrack:r=At.Audio;break;case x.LocalVideoTrack:r=W(n=o._hints).call(n,Bt.SCREEN_TRACK)?At.Screen:At.High;break;case x.LocalVideoLowTrack:r=At.Low}return{stream_type:r,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){const n=[],r=this.remoteUserMap.get(t);if(!r)return n;if(e){const i=r.get(e);if(!i)return n;n.push([t,{kind:e,id:i}])}else Array.from(r.entries()).forEach(i=>{let[o,s]=i;n.push([t,{kind:o,id:s}])});return n}createUnsubscribeMessage(t){const e=[];return t.forEach(n=>{let[r,{kind:i}]=n;switch(i){case q.VIDEO:return void(r._videoSSRC&&e.push({stream_type:q.VIDEO,ssrcId:r._videoSSRC}));case q.AUDIO:return void(r._audioSSRC&&e.push({stream_type:q.AUDIO,ssrcId:r._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:r}]=e;const i=this.remoteUserMap.get(n);i&&(i.delete(r),0===Array.from(i.entries()).length&&this.remoteUserMap.delete(n))})}updateBitrateLimit(t){var e=this;return y(function*(){const n=e.localTrackMap.get(x.LocalVideoTrack),r=e.localTrackMap.get(x.LocalVideoLowTrack);n&&(yield n.track.setBitrateLimit(t.uplink)),r&&t.low_stream_uplink&&(yield r.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}))})()}isP2PDisconnected(){return!this.sendConnection||!this.recvConnection||"connected"!==this.sendConnection.peerConnectionState&&"connected"!==this.recvConnection.peerConnectionState}tryToUnmuteAudio(t){var e=this;return y(function*(){for(let n=0;n<t.length;n++)if(t[n]instanceof ie){const r=e.filterTobeUnmutedTracks(t[n]);if(0===r.length)continue;const i=e.createUnmuteMessage(r);return void(yield xt(e,nt.RequestUnmuteLocal,i))}})()}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!(null===(e=this.recvConnection)||void 0===e||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(nt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(nt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}requestReconnect(){var t=this;return y(function*(){t.dtlsFailedCount+=1,yield Me(x_(t.dtlsFailedCount,Se)),t.emit(nt.RequestReconnect)})()}reconnectP2P(){return y(function*(){})()}canPublishLowStream(){return this.localTrackMap.has(x.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof Kt)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof Kt).length>1)throw new P(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof ie).length>1&&(t.some(e=>e instanceof ie&&e._bypassWebAudio)||!St().webAudioMediaStreamDest))throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof Kt&&this.pendingLocalTracks.some(n=>n instanceof Kt))throw new P(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ie&&this.pendingLocalTracks.some(n=>n instanceof ie)&&(!St().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof ie&&n._bypassWebAudio)))throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const n=!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding,r=ll(ll({},{width:160,height:120,framerate:15,bitrate:50}),e);let i;i=n?t._mediaStreamTrack.clone():ym(t,r);const o=Ft(8,"track-low-"),s=new Kt(i,ll(ll({},n&&{scaleResolutionDownBy:oE(r,t)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return s.on(jo.TRANSCEIVER_UPDATED,a=>{t._updateRtpTransceiver(a,$s.LOW_STREAM)}),s._hints.push(Bt.LOW_STREAM),t.addListener(Y.NEED_CLOSE,()=>{s.close()}),s}globalLock(){var t=this;return y(function*(){return t.recvMutex.lock("From P2PChannel2.globalLock")})()}reportVideoFirstFrameDecoded(t,e,n,r){var i;const o=Array.from(kn(i=this.remoteUserMap).call(i)).find(s=>s._videoSSRC===t);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&"video"===c.type);Q.firstRemoteVideoDecode(this.store.sessionId,Ue.FIRST_VIDEO_DECODE,$t.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:Qe.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:r?1:0})}}remoteMediaSsrcChanged(t,e,n){var r=this;return y(function*(){if(!r.recvConnection)return!1;const i=r.remoteUserMap.get(t);if(!i)return!1;const o=i.get(e);if(!o)return!1;const s=yield r.recvConnection.getRemoteSSRC(o);return void 0!==s&&s!==n})()}isPreSubScribe(t){return!1}publishDataChannel(t){return y(function*(){throw new P(v.NOT_SUPPORTED)})()}unpublishDataChannel(t){return y(function*(){throw new P(v.NOT_SUPPORTED)})()}subscribeDataChannel(t,e){return y(function*(){throw new P(v.NOT_SUPPORTED)})()}unsubscribeDataChannel(t,e){return y(function*(){throw new P(v.NOT_SUPPORTED)})()}hasPendingRemoteDataChannel(t,e){throw new P(v.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new P(v.NOT_SUPPORTED)}preConnect(t){return y(function*(){throw new P(v.NOT_SUPPORTED)})()}getEstablishParams(){throw new P(v.NOT_SUPPORTED)}reSubscribe(t){return y(function*(){throw new P(v.NOT_SUPPORTED)})()}updateVideoStreamParameter(t,e){return y(function*(){throw new P(v.NOT_SUPPORTED)})()}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===x.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,$s.LOW_STREAM):n._updateRtpTransceiver(void 0)})}},z(Jt.prototype,"p2pConnect",[gO],Object.getOwnPropertyDescriptor(Jt.prototype,"p2pConnect"),Jt.prototype),z(Jt.prototype,"unpublish",[TO],Object.getOwnPropertyDescriptor(Jt.prototype,"unpublish"),Jt.prototype),z(Jt.prototype,"unpublishLowStream",[SO],Object.getOwnPropertyDescriptor(Jt.prototype,"unpublishLowStream"),Jt.prototype),z(Jt.prototype,"subscribe",[RO],Object.getOwnPropertyDescriptor(Jt.prototype,"subscribe"),Jt.prototype),z(Jt.prototype,"mockSubscribe",[vO],Object.getOwnPropertyDescriptor(Jt.prototype,"mockSubscribe"),Jt.prototype),z(Jt.prototype,"unsubscribe",[yO],Object.getOwnPropertyDescriptor(Jt.prototype,"unsubscribe"),Jt.prototype),z(Jt.prototype,"muteRemote",[CO],Object.getOwnPropertyDescriptor(Jt.prototype,"muteRemote"),Jt.prototype),z(Jt.prototype,"unmuteRemote",[IO],Object.getOwnPropertyDescriptor(Jt.prototype,"unmuteRemote"),Jt.prototype),z(Jt.prototype,"hasRemoteMediaWithLock",[AO],Object.getOwnPropertyDescriptor(Jt.prototype,"hasRemoteMediaWithLock"),Jt.prototype),z(Jt.prototype,"disconnectForReconnect",[bO],Object.getOwnPropertyDescriptor(Jt.prototype,"disconnectForReconnect"),Jt.prototype),z(Jt.prototype,"remoteMediaSsrcChanged",[OO],Object.getOwnPropertyDescriptor(Jt.prototype,"remoteMediaSsrcChanged"),Jt.prototype),Jt);function Gr(t){return function(e,n,r){const i=e[n];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return r.value=y(function*(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];switch(t){case jr.SEND_ONLY:{const c=yield this.sendMutex.lock("From P2PChannel2.".concat(n));try{return yield i.apply(this,s)}finally{c()}}case jr.RECEIVE_ONLY:{const c=yield this.recvMutex.lock("From P2PChannel2.".concat(n));try{return yield i.apply(this,s)}finally{c()}}default:{const c=yield this.sendMutex.lock("From P2PChannel2.".concat(n)),d=yield this.recvMutex.lock("From P2PChannel2.".concat(n));try{return yield i.apply(this,s)}finally{c(),d()}}}}),r}}function NO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Jo(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?NO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):NO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class Ic{constructor(e){T(this,"store",void 0),T(this,"onStatsException",void 0),T(this,"onUploadPublishDuration",void 0),T(this,"onStatsChanged",void 0),T(this,"localStats",new Map),T(this,"remoteStats",new Map),T(this,"updateStatsInterval",void 0),T(this,"trafficStats",void 0),T(this,"trafficStatsPeerList",[]),T(this,"uplinkStats",void 0),T(this,"exceptionMonitor",void 0),T(this,"p2pChannel",void 0),T(this,"scalabilityMode",J_.L1T1),T(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.exceptionMonitor=new U3,this.exceptionMonitor.on("exception",(n,r,i)=>{this.onStatsException&&this.onStatsException(n,r,i)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(x.LocalAudioTrack)||Jo({},NE)}getLocalVideoTrackStats(){return this.localStats.get(x.LocalVideoTrack)||Jo({},DE)}getRemoteAudioTrackStats(e){const n=(o,s)=>{if(!this.trafficStats)return s;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},r={};if(e){var i;const o=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.audioStats;o&&(r[e]=n(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:a}]=o;a&&(r[s]=n(s,a))});return r}getRemoteNetworkQualityStats(e){const n={};if(e){var r;const i=null===(r=this.remoteStats.get(e))||void 0===r?void 0:r.networkStats;i&&(n[e]=i)}else Array.from(this.remoteStats.entries()).forEach(i=>{let[o,{networkStats:s}]=i;s&&(n[o]=s)});return n}getRemoteVideoTrackStats(e){const n=(o,s)=>{if(!this.trafficStats)return s;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},r={};if(e){var i;const o=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.videoStats;o&&(r[e]=n(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:a}]=o;a&&(r[s]=n(s,a))});return r}getRTCStats(){let e=0,n=0,r=0,i=0;const o=this.localStats.get(x.LocalAudioTrack);o&&(e+=o.sendBytes,n+=o.sendBitrate);const s=this.localStats.get(x.LocalVideoTrack);s&&(e+=s.sendBytes,n+=s.sendBitrate);const a=this.localStats.get(x.LocalVideoLowTrack);a&&(e+=a.sendBytes,n+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:u,videoStats:l}=d;u&&(r+=u.receiveBytes,i+=u.receiveBitrate),l&&(r+=l.receiveBytes,i+=l.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:n,SendBytes:e,RecvBytes:r,RecvBitrate:i,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(n=>void 0!==n.B_ppad||void 0!==n.B_ppvd),e.peer_delay.filter(n=>-1===this.trafficStatsPeerList.indexOf(n.peer_uid)).forEach(n=>{var r;const i=null===(r=this.p2pChannel)||void 0===r?void 0:r.getRemoteMedia(n.peer_uid),o=null!=i&&i.videoSSRC?Qe.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?Qe.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==n.B_ppad&&void 0!==n.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(n.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&_.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,n,r){return!!e&&(!!r&&n.framesDecodeFreezeTime>r.framesDecodeFreezeTime||!(!r||n.framesDecodeCount>r.framesDecodeCount))}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(n=>{let[r,i]=n;switch(r){case x.LocalVideoTrack:case x.LocalVideoLowTrack:{const s=i,a=Jo({},DE),c=e.getStats(),d=e.getLocalMedia(r);if(c){const u=c.videoSend.find(l=>l.ssrc===d?.ssrcs[0].ssrcId);if(u){const l=e.getLocalVideoSize(),p=e.getEncoderConfig(x.LocalVideoTrack);"H264"!==u.codec&&"H265"!==u.codec&&"VP8"!==u.codec&&"VP9"!==u.codec&&"AV1X"!==u.codec&&"AV1"!==u.codec||(a.codecType=u.codec),a.sendBytes=u.bytes,a.sendBitrate=s?8*Math.max(0,a.sendBytes-s.sendBytes):0,u.inputFrame?(a.captureFrameRate=u.inputFrame.frameRate,a.captureResolutionHeight=u.inputFrame.height,a.captureResolutionWidth=u.inputFrame.width):l&&(a.captureResolutionWidth=l.width,a.captureResolutionHeight=l.height),u.sentFrame?(a.sendFrameRate=u.sentFrame.frameRate,a.sendResolutionHeight=u.sentFrame.height,a.sendResolutionWidth=u.sentFrame.width):l&&(a.sendResolutionWidth=l.width,a.sendResolutionHeight=l.height),u.avgEncodeMs&&(a.encodeDelay=u.avgEncodeMs),p&&p.bitrateMax&&(a.targetSendBitrate=1e3*p.bitrateMax),a.sendPackets=u.packets,a.sendPacketsLost=u.packetsLost,a.sendJitterMs=u.jitterMs,a.sendRttMs=u.rttMs,a.totalDuration=s?s.totalDuration+1:1,a.totalFreezeTime=s?s.totalFreezeTime:0,this.isLocalVideoFreeze(u)&&(a.totalFreezeTime+=1),u.scalabilityMode&&this.scalabilityMode!==u.scalabilityMode&&(_.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(u.scalabilityMode)),this.scalabilityMode=u.scalabilityMode)}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(r,a),(s?.sendResolutionWidth!==a.sendResolutionWidth||s?.sendResolutionHeight!==a.sendResolutionHeight)&&(null===(o=this.onStatsChanged)||void 0===o||o.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight})),a&&d&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,d.track,a);break}case x.LocalAudioTrack:{const s=i,a=Jo({},NE),c=e.getStats(),d=e.getLocalMedia(r);if(c){const u=c.audioSend.find(l=>l.ssrc===d?.ssrcs[0].ssrcId);if(u){if("opus"!==u.codec&&"aac"!==u.codec&&"PCMU"!==u.codec&&"PCMA"!==u.codec&&"G722"!==u.codec||(a.codecType=u.codec),u.inputLevel)a.sendVolumeLevel=Math.round(32767*u.inputLevel);else{const l=e.getLocalAudioVolume();l&&(a.sendVolumeLevel=Math.round(32767*l))}a.sendBytes=u.bytes,a.sendPackets=u.packets,a.sendPacketsLost=u.packetsLost,a.sendJitterMs=u.jitterMs,a.sendRttMs=u.rttMs,a.sendBitrate=s?8*Math.max(0,a.sendBytes-s.sendBytes):0}}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(x.LocalAudioTrack,a),a&&d&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,d.track,a);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(n=>{var r,i;let[o,{videoStats:s,audioStats:a,videoPcStats:c}]=n;const d=a,u=s,l=c,p=Jo({},SI),h=Jo({},RI),S=Jo({},h3),{audioTrack:m,videoTrack:f,audioSSRC:g,videoSSRC:R}=e.getRemoteMedia(o);let C;C=e instanceof Dn?e.getStats(!0):e.getStats();const b=null===(r=C)||void 0===r?void 0:r.audioRecv.find(V=>V.ssrc===g),w=null===(i=C)||void 0===i?void 0:i.videoRecv.find(V=>V.ssrc===R),D=this.trafficStats&&this.trafficStats.peer_delay.find(V=>V.peer_uid===o);if(b&&("opus"!==b.codec&&"aac"!==b.codec&&"PCMU"!==b.codec&&"PCMA"!==b.codec&&"G722"!==b.codec||(p.codecType=b.codec),b.outputLevel?p.receiveLevel=Math.round(32767*b.outputLevel):m&&(p.receiveLevel=Math.round(32767*m.getVolumeLevel())),p.receiveBytes=b.bytes,p.receivePackets=b.packets,p.receivePacketsLost=b.packetsLost,p.receivePacketsDiscarded=b.packetsDiscarded,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.receiveBitrate=d?8*Math.max(0,p.receiveBytes-d.receiveBytes):0,p.totalDuration=d?d.totalDuration+1:1,p.totalFreezeTime=d?d.totalFreezeTime:0,p.freezeRate=p.totalFreezeTime/p.totalDuration,p.receiveDelay=b.jitterBufferMs,p.totalDuration>10&&Ic.isRemoteAudioFreeze(m)&&(p.totalFreezeTime+=1)),w){"H264"!==w.codec&&"H265"!==w.codec&&"VP8"!==w.codec&&"VP9"!==w.codec&&"AV1X"!==w.codec&&"AV1"!==w.codec||(h.codecType=w.codec),h.receiveBytes=w.bytes,h.receiveBitrate=u?8*Math.max(0,h.receiveBytes-u.receiveBytes):0,h.decodeFrameRate=w.decodeFrameRate<0?0:w.decodeFrameRate,h.renderFrameRate=w.decodeFrameRate<0?0:w.decodeFrameRate,w.outputFrame&&(h.renderFrameRate=w.outputFrame.frameRate),w.receivedFrame?(h.receiveFrameRate=w.receivedFrame.frameRate,h.receiveResolutionHeight=w.receivedFrame.height,h.receiveResolutionWidth=w.receivedFrame.width):f&&(h.receiveResolutionHeight=f._videoHeight||0,h.receiveResolutionWidth=f._videoWidth||0),void 0!==w.framesRateFirefox&&(h.receiveFrameRate=Math.round(w.framesRateFirefox)),h.receivePackets=w.packets,h.receivePacketsLost=w.packetsLost,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.totalDuration=u?u.totalDuration+1:1,h.totalFreezeTime=u?u.totalFreezeTime:0,h.receiveDelay=w.jitterBufferMs||0;const V=!!R&&e.getRemoteVideoIsReady(R);f&&V&&Ic.isRemoteVideoFreeze(f,w,l)&&(h.totalFreezeTime+=1),h.freezeRate=h.totalFreezeTime/h.totalDuration}D&&(p.end2EndDelay=D.B_ad,h.end2EndDelay=D.B_vd,p.transportDelay=D.B_ed,h.transportDelay=D.B_ed,p.currentPacketLossRate=D.B_ealr4/100,h.currentPacketLossRate=D.B_evlr4/100,S.uplinkNetworkQuality=D.B_punq?D.B_punq:0,S.downlinkNetworkQuality=D.B_pdnq?D.B_pdnq:0),this.remoteStats.set(o,{audioStats:p,videoStats:h,videoPcStats:w,networkStats:S}),m&&this.exceptionMonitor.setRemoteAudioStats(m,p),f&&this.exceptionMonitor.setRemoteVideoStats(f,h)})}}class DO{constructor(){T(this,"destChannelMediaInfos",new Map),T(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){IC(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){IC(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Pu(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function PO(t){if(!(t instanceof DO))return new N(v.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=t.getSrcChannelMediaInfo(),n=t.getDestChannelMediaInfo();return e?0===n.size?new N(v.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new N(v.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}function LO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function kO(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?LO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):LO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}var Vt;function MO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function pl(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?MO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):MO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let Ac=(Vt=class Zc extends OC{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return W(n=Object.keys(wu)).call(n,e)}))]}constructor(e,n){super(e,n),T(this,"store",void 0),T(this,"peerConnection",void 0),T(this,"remoteSDP",void 0),T(this,"initialOffer",void 0),T(this,"statsFilter",void 0),T(this,"useRTX",!1),T(this,"localCapabilities",void 0),T(this,"localCandidateCount",0),T(this,"allCandidatesReceived",!1),T(this,"establishPromise",void 0),T(this,"mutex",void 0),this.store=n,this.mutex=new Je("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Zc.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=vm(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,ee()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}establish(){var e=this;return y(function*(){try{const n=yield e.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=oo(n.sdp),i=Tc(n.sdp,{filterRTX:!e.useRTX,filterVideoFec:A("FILTER_VIDEO_FEC"),filterAudioFec:A("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return e.localCapabilities=i,e.initialOffer=n,pl(pl({},r),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:n.sdp})}catch(n){throw new P(v.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}})()}updateRemoteConnect(){return y(function*(){})()}connect(e){var n=this;return y(function*(){try{if(!n.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");n.remoteSDP=new class{constructor(i){T(this,"sessionDesc",void 0),T(this,"localCapabilities",void 0),T(this,"rtpCapabilities",void 0),T(this,"candidates",void 0),T(this,"iceParameters",void 0),T(this,"dtlsParameters",void 0),T(this,"setup",void 0),T(this,"currentMidIndex",void 0),T(this,"cname",void 0),i=ae(i);const{iceParameters:o,dtlsParameters:s,candidates:a,rtpCapabilities:c,setup:d,localCapabilities:u,sdkCodec:l,cname:p}=i,h=Fe.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=c,this.candidates=a,this.iceParameters=o,this.dtlsParameters=s,this.setup=d,this.localCapabilities=u,this.cname=p;for(let S=0;S<h.mediaDescriptions.length;S++){const m=h.mediaDescriptions[S];if(m.attributes.iceUfrag=o.iceUfrag,m.attributes.icePwd=o.icePwd,m.attributes.fingerprints=s.fingerprints,m.attributes.candidates=a,m.attributes.setup=d,"video"===m.media.mediaType){m.media.fmts=c.videoCodecs.map(g=>g.payloadType.toString(10));let f=c.videoCodecs.filter(g=>{var R,C;return null===(R=g.rtpMap)||void 0===R?void 0:W(C=R.encodingName.toLowerCase()).call(C,l)});0===f.length&&(f=c.videoCodecs),m.attributes.payloads=f,m.attributes.extmaps=c.videoExtensions}"audio"===m.media.mediaType&&(m.media.fmts=c.audioCodecs.map(f=>f.payloadType.toString(10)),m.attributes.payloads=c.audioCodecs,m.attributes.extmaps=c.audioExtensions),h.mediaDescriptions[S]=this.mungMediaDesc(m)}this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}toString(){return Fe.print(this.sessionDesc)}send(i,o,s){const{ssrcs:a,ssrcGroups:c}=Ko(o,this.cname),d=this.sessionDesc.mediaDescriptions.find(p=>i===q.VIDEO?"video"===p.media.mediaType:"audio"===p.media.mediaType),u=a[0].attributes.label,l=a[0].attributes.mslabel;return d.attributes.ssrcs=d.attributes.ssrcs.concat(a),d.attributes.ssrcGroups=d.attributes.ssrcGroups.concat(c),{id:u,mslabel:l}}batchSend(i){return i.map(o=>{let{kind:s,ssrcMsg:a}=o;return this.send(s,a,void 0)})}stopSending(i){this.sessionDesc.mediaDescriptions.forEach(o=>{const s=[],a=[],c=[];o.attributes.ssrcs.forEach(d=>{W(i).call(i,d.attributes.label||"")?c.push(d):s.push(d)}),o.attributes.ssrcGroups.forEach(d=>{var u;W(u=c.map(l=>l.ssrcId)).call(u,d.ssrcIds[0])||a.push(d)}),o.attributes.ssrcs=s,o.attributes.ssrcGroups=a})}mute(i){const o=this.sessionDesc.mediaDescriptions.find(s=>s.attributes.mid===i);if(!o)throw new Error("mediaDescription not found with ".concat(i," in remote SDP when calling RemoteSDP.mute."));o.attributes.direction="inactive"}unmute(i){const o=this.sessionDesc.mediaDescriptions.find(s=>s.attributes.mid===i);if(!o)throw new Error("mediaDescription not found with ".concat(i," in remote SDP when calling RemoteSDP.unmute."));o.attributes.direction="sendonly"}receive(i,o,s){i.forEach((a,c)=>{const d=a._mediaStreamTrack,u=this.sessionDesc.mediaDescriptions.findIndex(p=>p.attributes.mid===d.kind),l=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[u],a);this.sessionDesc.mediaDescriptions[u]=l})}stopReceiving(i){}updateCandidates(i){i===bn.TCP?this.candidates.forEach(o=>{-1===this.candidates.findIndex(s=>"tcp"===s.transport&&s.connectionAddress===o.connectionAddress&&s.port===o.port)&&this.candidates.push(kO(kO({},o),{},{foundation:"tcpcandidate",priority:Number(o.priority)-1+"",transport:"tcp",port:Number(o.port)+90+""}))}):this.candidates=this.candidates.filter(o=>"tcp"!==o.transport);for(const o of this.sessionDesc.mediaDescriptions)o.attributes.candidates=this.candidates}restartICE(i){i=ae(i),this.iceParameters=i,this.sessionDesc.mediaDescriptions.forEach(o=>{o.attributes.iceUfrag=i.iceUfrag,o.attributes.icePwd=i.icePwd})}predictReceivingMids(i){const o=[];for(let s=0;s<i;s++)o.push((this.currentMidIndex+s+1).toString(10));return o}mungRecvMediaDsec(i,o){const s=ae(i);return da(s,o),XE(s,o),s}updateRecvMedia(i,o){const s=this.sessionDesc.mediaDescriptions.findIndex(a=>a.attributes.mid===i);if(-1!==s){const a=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[s],o);this.sessionDesc.mediaDescriptions[s]=a}}bumpMid(i){this.currentMidIndex+=i}updateTrackLabel(i,o,s){const a=this.sessionDesc.mediaDescriptions.find(d=>i===q.VIDEO?"video"===d.attributes.mid:"audio"===d.attributes.mid);if(a){const d=a.attributes.ssrcs.find(u=>u.attributes.label===o);var c;d&&(d.attributes.label=s,null===(c=d.attributes.msid)||void 0===c||c.replace(o,s))}}mungMediaDesc(i){const o=ae(i);return JE(o),function(s){const a=s.attributes.extmaps.find(c=>nl(c.extensionName));a&&s.attributes.extmaps.splice(s.attributes.extmaps.indexOf(a),1),s.attributes.payloads.forEach(c=>{const d=c.rtcpFeedbacks.findIndex(u=>"transport-cc"===u.type);-1!==d&&c.rtcpFeedbacks.splice(d,1)})}(o),o}getSSRC(i){for(const o of this.sessionDesc.mediaDescriptions)for(const s of o.attributes.ssrcs)if(s.attributes.label===i)return[s]}}(pl(pl({},e),{},{rtpCapabilities:e.rtpCapabilities.send,localCapabilities:n.localCapabilities,sdkCodec:n.store.codec}));const r=n.remoteSDP.toString();yield n.peerConnection.setLocalDescription(n.initialOffer),yield n.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(r.toString()))}})()}updateRemoteRTPCapabilities(e,n){return y(function*(){throw new P(v.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")})()}getPreMedia(e){}send(e,n){var r=this;return Zn(function*(){const i=yield mt(r.mutex.lock());try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=e.map(p=>r.peerConnection.addTrack(p._mediaStreamTrack)),s=yield mt(r.peerConnection.createOffer()),a=Fe.parse(s.sdp),c=e.map(p=>{const h=p._mediaStreamTrack,S=a.mediaDescriptions.find(m=>m.attributes.mid===h.kind);if(!S)throw new Error("Cannot extract ssrc from mediaDescription.");return function(m,f,g){const R=m.attributes.ssrcs.filter(b=>b.attributes.label===f),C=m.attributes.ssrcGroups;if(0===R.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(C&&R.length>1){const b=C.find(w=>-1!==w.ssrcIds.indexOf(R[0].ssrcId));return b?[{ssrcId:b.ssrcIds[0],rtx:g?b.ssrcIds[1]:void 0}]:[{ssrcId:R[0].ssrcId}]}return[{ssrcId:R[0].ssrcId}]}(S,h.id,r.useRTX)});let d;try{d=yield c}catch(p){throw o.forEach(h=>{Ge()&&h.replaceTrack(null),r.peerConnection.removeTrack(h)}),p}const u=r.mungSendOfferSDP(s.sdp,e);r.remoteSDP.receive(e,n,d);const l=r.remoteSDP.toString();return yield mt(r.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield mt(r.applySendEncodings(o,e)),yield mt(r.peerConnection.setRemoteDescription({type:"answer",sdp:l})),e.map((p,h)=>({localSSRC:c[h],id:p._mediaStreamTrack.id}))}catch(o){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{i()}})()}stopSending(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=n.peerConnection.getSenders().filter(s=>{var a;return-1!==e.indexOf((null===(a=s.track)||void 0===a?void 0:a.id)||"")});if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(s=>{Ge()&&s.replaceTrack(null),n.peerConnection.removeTrack(s)});const i=yield n.peerConnection.createOffer();yield n.peerConnection.setLocalDescription(i),n.remoteSDP.stopReceiving(e);const o=n.remoteSDP.toString();yield n.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}})()}receive(e,n,r,i){var o=this;return y(function*(){try{if(!o.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:s,mslabel:a}=o.remoteSDP.send(e,n,i),c=new H((l,p)=>{const h=setTimeout(()=>{p(new Error("Cannot receive track, id: ".concat(s)))},1e4),S=m=>{const f=Tt();if(("Safari"===f.name&&11===Number(f.version)||an())&&m.track.id!==s&&m.streams[0].id===a){var g;const R=m.streams[0].getTracks()[0];return null===(g=o.remoteSDP)||void 0===g||g.updateTrackLabel(e,s,m.track.id),o.peerConnection.removeEventListener("track",S),clearTimeout(h),void l(R)}if(m.track.id===s)return o.peerConnection.removeEventListener("track",S),clearTimeout(h),void l(m.track)};o.peerConnection.addEventListener("track",S)}),d=o.remoteSDP.toString();yield o.peerConnection.setRemoteDescription({type:"offer",sdp:d});const u=yield o.peerConnection.createAnswer();return yield o.peerConnection.setLocalDescription(u),{track:yield c,id:s}}catch(s){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}})()}stopReceiving(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");n.remoteSDP.stopSending(e);const r=n.remoteSDP.toString();yield n.peerConnection.setRemoteDescription({type:"offer",sdp:r});const i=yield n.peerConnection.createAnswer();yield n.peerConnection.setLocalDescription(i)}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}})()}muteRemote(e){return y(function*(){})()}unmuteRemote(e){return y(function*(){})()}muteLocal(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const r=n.peerConnection.getSenders().filter(i=>{var o;return-1!==e.indexOf((null===(o=i.track)||void 0===o?void 0:o.id)||"")});if(r.length!==e.length)throw new Error("sender' length doesn't match mids' length.");r.map(i=>{if(Ge()&&i.track)i.track.enabled=!1;else{const o=i.getParameters();o.encodings.forEach(s=>s.active=!1),i.setParameters(o)}})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(r.toString()))}})()}unmuteLocal(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const r=n.peerConnection.getSenders().filter(s=>{var a;return-1!==e.indexOf((null===(a=s.track)||void 0===a?void 0:a.id)||"")});if(r.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");r.map(function(){var s=y(function*(a){if(Ge()&&a.track)a.track.enabled=!0;else{const c=a.getParameters();c.encodings.forEach(d=>d.active=!0),yield a.setParameters(c)}});return function(a){return s.apply(this,arguments)}}());const i=yield n.peerConnection.createOffer();yield n.peerConnection.setLocalDescription(i);const o=n.remoteSDP.toString();yield n.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(r.toString()))}})()}restartICE(e){var n=this;return Zn(function*(){const r=yield mt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(St().supportPCSetConfiguration){const c=n.peerConnection.getConfiguration(),d=e===bn.RELAY?"relay":"all";c.iceTransportPolicy!==d&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(c.iceTransportPolicy,"] to [").concat(d,"]")),c.iceTransportPolicy=d,n.peerConnection.setConfiguration(c))}else if(e===bn.RELAY)return;e!==bn.RELAY&&n.remoteSDP.updateCandidates(e);const i=yield mt(n.peerConnection.createOffer({iceRestart:!0}));if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=oo(i.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);const a=n.remoteSDP.toString();yield mt(n.peerConnection.setLocalDescription(i)),yield mt(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(i){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),i)}finally{r()}})()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}updateEncoderConfig(e,n){var r=this;return y(function*(){try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=yield r.peerConnection.createOffer(),o=r.mungSendOfferSDP(i.sdp,[n]);r.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const s=r.remoteSDP.toString();yield r.peerConnection.setLocalDescription({type:"offer",sdp:o}),yield r.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new P(v.EXCHANGE_SDP_FAILED,i.toString())}})()}updateSendParameters(e,n){var r=this;return y(function*(){const i=r.peerConnection.getSenders().filter(o=>{var s;return(null===(s=o.track)||void 0===s?void 0:s.id)===e});1===i.length&&(yield r.applySendEncodings(i,[n]))})()}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}replaceTrack(e,n){var r=this;return y(function*(){const i=r.peerConnection.getSenders().find(o=>{var s;return(null===(s=o.track)||void 0===s?void 0:s.id)===n});i&&(yield i.replaceTrack(e._mediaStreamTrack))})()}createDataChannels(e,n){throw new P(v.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new P(v.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},A("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(yu(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...Zc.turnServerConfigToIceServers(e.turnServer.servers)),A("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Zc.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(r=>{r.security?r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),n}updateRtpSenderEncodings(e,n){var r=this;return y(function*(){var i;if(n||(n=r.peerConnection.getSenders().find(u=>{var l;return(null===(l=u.track)||void 0===l?void 0:l.id)===e._mediaStreamTrack.id})),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!St().supportSetRtpSenderParameters)return _.warn("Browser not support set rtp-sender parameters");const o={},s={};if(e instanceof Kt)switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;default:o.degradationPreference="balanced"}if(A("DSCP_TYPE")&&Xi()){var a;const u=A("DSCP_TYPE");W(a=["very-low","low","medium","high"]).call(a,u)&&(s.networkPriority=u)}const c=n.getParameters(),d=null===(i=c.encodings)||void 0===i?void 0:i[0];d&&Object.assign(d,s),Object.assign(c,o),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),yield n.setParameters(c)})()}applySendEncodings(e,n){var r=this;return y(function*(){try{if(!St().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const o=e[i],s=n[i];o&&s&&(yield r.updateRtpSenderEncodings(s,o))}}catch{_.debug("[".concat(r.store.clientId,"] Apply RTPSendEncodings failed."))}})()}mungSendOfferSDP(e,n){const r=Fe.parse(e);return n.forEach((i,o)=>{const s=i._mediaStreamTrack,a=r.mediaDescriptions.find(c=>c.attributes.mid===s.kind);a&&da(a,i)}),Fe.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;null===(n=this.onFirstAudioReceived)||void 0===n||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;null===(n=this.onFirstVideoReceived)||void 0===n||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;null===(n=this.onFirstAudioDecoded)||void 0===n||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,r)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var r;null===(r=this.onSelectedLocalCandidateChanged)||void 0===r||r.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var r;null===(r=this.onSelectedRemoteCandidateChanged)||void 0===r||r.call(this,e,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}batchReceive(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const r=n.remoteSDP.batchSend(e).map((s,a)=>{let{id:c,mslabel:d}=s;const{kind:u}=e[a];return new H((l,p)=>{const h=setTimeout(()=>{p(new Error("Cannot receive track, id: ".concat(c)))},1e4),S=m=>{const f=Tt();if("Safari"===f.name&&11===Number(f.version)&&m.track.id!==c&&m.streams[0].id===d){var g;const R=m.streams[0].getTracks()[0];return null===(g=n.remoteSDP)||void 0===g||g.updateTrackLabel(u,c,m.track.id),n.peerConnection.removeEventListener("track",S),clearTimeout(h),void l({track:R,id:c})}if(m.track.id===c)return n.peerConnection.removeEventListener("track",S),clearTimeout(h),void l({track:m.track,id:c})};n.peerConnection.addEventListener("track",S)})}),i=n.remoteSDP.toString();yield n.peerConnection.setRemoteDescription({type:"offer",sdp:i});const o=yield n.peerConnection.createAnswer();return yield n.peerConnection.setLocalDescription(o),yield H.all(r)}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(r.toString()))}})()}getRemoteSSRC(e){var n=this;return y(function*(){if(!n.remoteSDP)return;const r=n.remoteSDP.getSSRC(e);return r?.[0].ssrcId})()}setConfiguration(e){if(St().supportPCSetConfiguration){const n=Zc.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},z(Vt.prototype,"connect",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"connect"),Vt.prototype),z(Vt.prototype,"stopSending",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"stopSending"),Vt.prototype),z(Vt.prototype,"receive",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"receive"),Vt.prototype),z(Vt.prototype,"stopReceiving",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"stopReceiving"),Vt.prototype),z(Vt.prototype,"muteRemote",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"muteRemote"),Vt.prototype),z(Vt.prototype,"unmuteRemote",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"unmuteRemote"),Vt.prototype),z(Vt.prototype,"muteLocal",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"muteLocal"),Vt.prototype),z(Vt.prototype,"unmuteLocal",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"unmuteLocal"),Vt.prototype),z(Vt.prototype,"close",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"close"),Vt.prototype),z(Vt.prototype,"updateEncoderConfig",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"updateEncoderConfig"),Vt.prototype),z(Vt.prototype,"updateSendParameters",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"updateSendParameters"),Vt.prototype),z(Vt.prototype,"replaceTrack",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"replaceTrack"),Vt.prototype),z(Vt.prototype,"getRemoteSSRC",[ir],Object.getOwnPropertyDescriptor(Vt.prototype,"getRemoteSSRC"),Vt.prototype),Vt);function ir(t,e,n){const r=t[e];if("function"!=typeof r)throw new Error("Cannot use mutex on object property.");return n.value=y(function*(){const i=this.mutex,o=yield i.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return yield r.apply(this,a)}finally{o()}}),n}function UO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function lo(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?UO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):UO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class X3{get localCapabilities(){return ae(this._localCapabilities)}get rtpCapabilities(){return ae(this._rtpCapabilities)}get candidates(){return ae(this._candidates)}get iceParameters(){return ae(this._iceParameters)}get dtlsParameters(){return ae(this._dtlsParameters)}constructor(e){T(this,"sessionDesc",void 0),T(this,"_localCapabilities",void 0),T(this,"_rtpCapabilities",void 0),T(this,"_candidates",void 0),T(this,"_iceParameters",void 0),T(this,"_dtlsParameters",void 0),T(this,"setup",void 0),T(this,"currentMidIndex",void 0),T(this,"cname",void 0),T(this,"firefoxSsrcMidMap",new Map),e=ae(e);const{iceParameters:n,dtlsParameters:r,candidates:i,rtpCapabilities:o,setup:s,localCapabilities:a,cname:c}=e;this._rtpCapabilities=o,this._candidates=i,this._iceParameters=n,this._dtlsParameters=r,this._localCapabilities=a,this.setup=s,this.cname=c,this.sessionDesc=this.updateRemoteRTPCapabilities(o),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}preloadRemoteMedia(e){const n=this.candidates,r=this.dtlsParameters,i=this.iceParameters,o=this.rtpCapabilities.send;let s=this.sessionDesc.mediaDescriptions.length-1;for(let a=1;a<e;a++){const c=2*a+2e4,d=2*a+4e4,{ssrcs:u,ssrcGroups:l}=Ko([{ssrcId:c}],this.cname),{ssrcs:p,ssrcGroups:h}=Ko([{ssrcId:d,rtx:A("USE_SUB_RTX")?d+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:o.videoCodecs.map(S=>S.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:n,extmaps:o.videoExtensions,fingerprints:r.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:p,ssrcGroups:h,rtcpFeedbackWildcards:[],payloads:o.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++s)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:o.audioCodecs.map(S=>S.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:n,extmaps:o.audioExtensions,fingerprints:r.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:u,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:o.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++s)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Fe.print(this.sessionDesc)}send(e,n,r,i){const{ssrcs:o,ssrcGroups:s}=Ko(n,this.cname,A("SYNC_GROUP")?r:void 0),a=this.findPreloadMediaDesc(o);if(a){if(ee()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),i&&(i.twcc||i.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,i),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,o);let d;return-1===c||1===c&&(Ge()||function(){const u=Tt();return!(u.name!==It.CHROME||!u.osVersion)&&Number(u.version)<=90}())||0===c&&A("USE_SUB_RTX")||jy()?(d=this.createOrRecycleSendMedia(e,o,s,"sendonly",i),this.updateBundleMids()):(d=ae(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,i)),ee()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:n}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:n}}batchSend(e){const n=e.map(o=>{let{kind:s,ssrcMsg:a,mslabel:c}=o;return this.send(s,a,c)}),r=[];let i=!1;return n.forEach(o=>{let{mid:s,needExchangeSDP:a}=o;a&&(i=!0),r.push(s)}),{mids:r,needExchangeSDP:i}}stopSending(e){const n=this.sessionDesc.mediaDescriptions.filter(r=>r.attributes.mid&&-1!==e.indexOf(r.attributes.mid));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");n.forEach(r=>{"0"===r.attributes.mid||ee()||jy()?r.attributes.ssrcs=[]:(r.attributes.ssrcs=[],r.attributes.direction="inactive",r.media.port="0")}),this.updateBundleMids()}mute(e){const n=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(e){const n=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===e);if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}muteRemote(e){const n=this.sessionDesc.mediaDescriptions.filter(r=>W(e).call(e,r.attributes.mid||""));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(r=>{r.attributes.direction="inactive"})}unmuteRemote(e){const n=this.sessionDesc.mediaDescriptions.filter(r=>W(e).call(e,r.attributes.mid||""));if(n.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(r=>{r.attributes.direction="recvonly"})}receive(e,n,r,i){e.forEach((o,s)=>{this.createOrRecycleRecvMedia(o,[],"recvonly",n,r,i[s])}),this.updateBundleMids()}stopReceiving(e){const n=this.sessionDesc.mediaDescriptions.filter(r=>-1!==e.indexOf(r.attributes.mid));if(n.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");n.forEach(r=>{r.media.port="0",r.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const n=this.sessionDesc||Fe.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=e;const r=this.rtpCapabilities.send,i=this.localCapabilities.send;for(const o of n.mediaDescriptions){if(o.attributes.iceUfrag=this._iceParameters.iceUfrag,o.attributes.icePwd=this._iceParameters.icePwd,o.attributes.fingerprints=this._dtlsParameters.fingerprints,o.attributes.candidates=this._candidates,o.attributes.setup=this.setup,"application"===o.media.mediaType&&(o.attributes.sctpPort="5000"),"video"===o.media.mediaType)if(0===r.videoCodecs.length){const s=i.videoCodecs.filter(a=>{var c,d;return null===(c=a.rtpMap)||void 0===c?void 0:W(d=c.encodingName.toLowerCase()).call(d,"vp8")})||[i.videoCodecs[0]];o.media.fmts=s.map(a=>a.payloadType.toString(10)),o.attributes.payloads=s,o.attributes.extmaps=[]}else if(o.media.fmts=r.videoCodecs.map(s=>s.payloadType.toString(10)),o.attributes.payloads=r.videoCodecs,o.attributes.extmaps=r.videoExtensions,A("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:s,ssrcGroups:a}=Ko([{ssrcId:4e4,rtx:A("USE_SUB_RTX")?40001:void 0}],this.cname);o.attributes.ssrcs=s,o.attributes.ssrcGroups=a}if("audio"===o.media.mediaType)if(0===r.audioCodecs.length){const s=i.audioCodecs.filter(a=>{var c,d;return null===(c=a.rtpMap)||void 0===c?void 0:W(d=c.encodingName.toLowerCase()).call(d,"opus")})||[i.audioCodecs[0]];o.media.fmts=s.map(a=>a.payloadType.toString(10)),o.attributes.payloads=s,o.attributes.extmaps=[]}else if(o.media.fmts=r.audioCodecs.map(s=>s.payloadType.toString(10)),o.attributes.payloads=r.audioCodecs,o.attributes.extmaps=r.audioExtensions,ua(o),A("PRELOAD_MEDIA_COUNT")>0){const{ssrcs:s,ssrcGroups:a}=Ko([{ssrcId:2e4}],this.cname);o.attributes.ssrcs=s,o.attributes.ssrcGroups=a}}return this.sessionDesc=n,this.currentMidIndex=n.mediaDescriptions.length-1,this.sessionDesc}updateCandidates(e){const n=this._candidates.filter(r=>"udp"===r.transport);if(e===bn.TCP){if(0===n.length)return;if(A("TCP_CANDIDATE_ONLY")){const r=this._candidates.filter(i=>"tcp"===i.transport);n.forEach(i=>{-1===r.findIndex(o=>o.connectionAddress===i.connectionAddress)&&r.push(lo(lo({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}),this._candidates=r}else{const r=[];n.forEach(i=>{r.push(lo(lo({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}),this._candidates=[...n,...r]}}else if(e===bn.RELAY){if(0!==n.length)return;{const r=this._candidates.filter(i=>"tcp"===i.transport);r.forEach(i=>{n.push(lo(lo({},i),{},{foundation:"udpcandidate",priority:Number(i.priority)+1+"",transport:"udp",port:Number(i.port)-90+""}))}),this._candidates=[...n,...r]}}else 0===n.length?(this._candidates.filter(r=>"tcp"===r.transport).forEach(r=>{n.push(lo(lo({},r),{},{foundation:"udpcandidate",priority:Number(r.priority)+1+"",transport:"udp",port:Number(r.port)-90+""}))}),this._candidates=n):this._candidates=this._candidates.filter(r=>"tcp"!==r.transport);for(const r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}restartICE(e){e=ae(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=e.iceUfrag,n.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const n=[];for(let r=0;r<e;r++)n.push((this.currentMidIndex+r+1).toString(10));return n}findAvailableMediaIndex(e,n){return this.sessionDesc.mediaDescriptions.findIndex(r=>{const i=r.media.mediaType===e&&"0"!==r.media.port&&("sendonly"===r.attributes.direction||"sendrecv"===r.attributes.direction)&&0===r.attributes.ssrcs.length;if(ee()){if(i){const o=this.firefoxSsrcMidMap.get(n[0].ssrcId);return!(o||"0"!==r.attributes.mid&&"1"!==r.attributes.mid)||!(!o||o!==r.attributes.mid)}return!1}return i})}createOrRecycleDataChannel(){for(const r of this.sessionDesc.mediaDescriptions)if("application"===r.media.mediaType)return{mediaDesc:r,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),n={media:{mediaType:"application",port:"9",protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(n),{mediaDesc:n,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,n,r,i,o,s){const a=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=Sc(a,c,this.localCapabilities.send,a===q.VIDEO?i:o),u=a===q.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let p={media:{mediaType:a,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(S=>S.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};p=this.mungRecvMediaDsec(p,e,s);const h=this.findFirstClosedMedia(a);if(h){const S=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[S]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateRemoteCodec(e,n,r){const i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").filter(p=>{var h;return W(h=Object.keys(wu)).call(h,p)}))],o=new Set(n);if(i.every(p=>o.has(p)))return _.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(n)),!1;const s=this._rtpCapabilities.recv.videoCodecs.filter(p=>n.some(h=>{var S;return W(S=p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||"").call(S,h)}));if(0===s.length)return _.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(n)),!1;const a=[...new Set(s.map(p=>p.rtpMap&&p.rtpMap.encodingName.toLowerCase()||""))];let c;if(_.debug("updateRemoteCodec, from ".concat(i," to ").concat(a)),0===e.length)c=this.sessionDesc.mediaDescriptions.filter(p=>"video"===p.media.mediaType&&"recvonly"===p.attributes.direction);else if(c=this.sessionDesc.mediaDescriptions.filter(p=>p.attributes.mid&&W(e).call(e,p.attributes.mid)&&"recvonly"===p.attributes.direction),c.length!==e.length)return _.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(n)),!1;if(A("USE_PUB_RTX")||A("USE_SUB_RTX")){const p=ZE(s,this.rtpCapabilities.recv.videoCodecs);s.push(...p)}this._rtpCapabilities.recv.videoCodecs=s;const l=Sc(q.VIDEO,this.rtpCapabilities.recv,this.localCapabilities.send,r);return c.forEach(p=>{const h=l.map(S=>S.payloadType.toString(10));_.debug("updateRemoteCodec mid: ".concat(p.attributes.mid,", from"),p.attributes.payloads,"to",l),p.attributes.payloads=l,p.media.fmts=h}),!0}createOrRecycleSendMedia(e,n,r,i,o){const s=this.rtpCapabilities.send,a=e===q.VIDEO?s.videoCodecs:s.audioCodecs,c=e===q.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let u={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:r,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungSendMediaDesc(u,o);const l=this.findFirstClosedMedia(e);if(l){const p=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>"0"!==e.media.port).map(e=>e.attributes.mid)}mungRecvMediaDsec(e,n,r){const i=ae(e);return JE(i),da(i,n),XE(i,n),Ob(i),rl(i,r,this.localCapabilities.send),i}mungSendMediaDesc(e,n){const r=ae(e);return rl(r,n,this.localCapabilities.recv),ua(r),r}updateRecvMedia(e,n){const r=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===e);if(-1!==r){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[r],n);this.sessionDesc.mediaDescriptions[r]=i}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(n=>ee()?"0"===n.media.port&&n.media.mediaType===e:"0"===n.media.port)}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(n=>{var r;return(null===(r=n.attributes)||void 0===r||null===(r=r.ssrcs[0])||void 0===r?void 0:r.ssrcId)===e[0].ssrcId})}getSSRC(e){var n;return null===(n=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===e))||void 0===n?void 0:n.attributes.ssrcs}}function VO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function wi(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?VO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):VO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let Oc=function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t}({});var _a=function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t}(_a||{});const hl=new Map;function FO(t,e,n,r){let{scale:i}=t;if(0===i&&r===_a.UP||i>=e.length-1&&r===_a.DOWN)return t;let o=wi(wi({},t),{},{scale:r===_a.DOWN?++i:--i});switch(n){case"maintain-framerate":o=wi(wi({},o),e[i].motion);break;case"maintain-resolution":o=wi(wi({},o),e[i].detail);break;case"balanced":o=wi(wi({},o),e[i].balanced)}return o}function BO(t,e){if(e){const n={overUse:0,underUse:0,adaptationList:jO(e)};hl.set(t,n)}else hl.delete(t)}function jO(t){const e=wi({},t),{bitrateMax:n,frameRate:r,scaleResolutionDownBy:i,bitrateMin:o}=e,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:u,BWE_SCALE_UP_THRESHOLD:l,BWE_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_UP_THRESHOLD:S,BALANCE_BITRATE_FACTOR:m,BALANCE_FRAMERATE_FACTOR:f,BALANCE_RESOLUTION_FACTOR:g,MOTION_RESOLUTION_FACTOR:R,MOTION_BITRATE_FACTOR:C,DETAIL_FRAMERATE_FACTOR:b,DETAIL_BITRATE_FACTOR:w}=G_,D=Math.min(e.frameRate,a),V=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(p,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(h,1)*D),fps_up:r},balanced:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o}}];for(let U=1;U<=c;U++){const k={bwe_up:Math.round(Math.pow(l,U)*n),bwe_down:Math.round(Math.pow(p,U+1)*n),fps_up:Math.round(Math.pow(S,U)*D),fps_down:Math.round(Math.pow(h,U+1)*D)},Z={scaleResolutionDownBy:i/Math.pow(g,U),frameRate:Math.max(Math.round(Math.pow(f,U)*r),s),bitrateMax:Math.max(Math.round(Math.pow(m,U)*n),u),bitrateMin:Math.max(Math.round(Math.pow(m,U)*o),d)},$={scaleResolutionDownBy:i/Math.pow(R,U),frameRate:r,bitrateMax:Math.max(Math.round(Math.pow(C,U)*n),u),bitrateMin:Math.max(Math.round(Math.pow(C,U)*o),d)},Rt={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(b,U)*r),s),bitrateMax:Math.max(Math.round(Math.pow(w,U)*n),u),bitrateMin:Math.max(Math.round(Math.pow(w,U)*o),d)};V.push({scale:U,threshold:k,balanced:Z,motion:$,detail:Rt})}return V}function GO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Am(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?GO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):GO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const _l=new Map;function El(t,e){const n=_l.get(t);if(n){const{timer:r}=n;window.clearTimeout(r),_l.delete(t)}e.qualityLimitationReason=Oc.NONE,BO(t)}var Et;function WO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function ci(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?WO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):WO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}let Wr=(Et=class $c extends OC{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return null!==(e=null===(n=this.peerConnection.getReceivers()[0])||void 0===n||null===(n=n.transport)||void 0===n?void 0:n.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var n;return W(n=Object.keys(wu)).call(n,e)}))]}constructor(e,n){super(e,n),T(this,"store",void 0),T(this,"peerConnection",void 0),T(this,"id",Ft(5,"connection-")),T(this,"remoteSDP",void 0),T(this,"initialOffer",void 0),T(this,"transportEventReceiver",void 0),T(this,"statsFilter",void 0),T(this,"extension",{useXR:A("USE_XR")}),T(this,"localCapabilities",void 0),T(this,"remoteCodecs",void 0),T(this,"localCandidateCount",0),T(this,"allCandidatesReceived",!1),T(this,"isPreallocation",!1),T(this,"preSSRCMap",new Map),T(this,"dataStreamChannelMap",new Map),T(this,"establishPromise",void 0),T(this,"recoveredDataChannelIds",[]),T(this,"currentDataChannelId",1),T(this,"mutex",void 0),T(this,"qualityLimitationReason",Oc.NONE),this.store=n,this.mutex=new Je("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection($c.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=vm(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,ee()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}getPreMedia(e){const n=this.preSSRCMap.get(e);if(void 0!==n){const r=this.peerConnection.getTransceivers().find(i=>i.mid===n);if(r)return{transceiver:r,track:r.receiver.track,id:n}}}updateRemoteRTPCapabilities(e,n){var r=this;return y(function*(){if(r.remoteCodecs=n,r.remoteSDP)if(r.remoteSDP.updateRemoteCodec(e,n,r.store.codec)){const i=yield r.peerConnection.createOffer(),o=r.logSDPExchange(i.sdp||"","offer","local","muteLocal");yield r.peerConnection.setLocalDescription(i);const s=r.remoteSDP.toString();o?.(s),yield r.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else _.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else _.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(r.localCodecs,", codecs: ").concat(n))})()}establish(){var e=this;return y(function*(){try{e.peerConnection.addTransceiver("video",{direction:"recvonly"}),e.peerConnection.addTransceiver("audio",{direction:"recvonly"});const r=yield e.peerConnection.createOffer();if(!r.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=oo(r.sdp),o=yield Nb({filterRTX:!A("USE_PUB_RTX")&&!A("USE_SUB_RTX"),filterVideoFec:A("FILTER_VIDEO_FEC"),filterAudioFec:A("FILTER_AUDIO_FEC"),filterVideoCodec:A("FILTER_VIDEO_CODEC")},e.extension);let s;return e.localCapabilities=il(o),e.initialOffer=r,r.sdp&&kb(r.sdp)&&(s=ae(o),(n=s).send&&(ca(q.VIDEO,n.send.videoExtensions),ca(q.AUDIO,n.send.audioExtensions)),n.recv&&(ca(q.VIDEO,n.recv.videoExtensions),ca(q.AUDIO,n.recv.audioExtensions)),n.sendrecv&&(ca(q.VIDEO,n.sendrecv.videoExtensions),ca(q.AUDIO,n.sendrecv.audioExtensions))),ci(ci({},i),{},{rtpCapabilities:s||o,offerSDP:r.sdp})}catch(r){throw new P(v.GET_LOCAL_CONNECTION_PARAMS_FAILED,r.toString())}var n})()}connect(e){var n=this;return y(function*(){try{if(!n.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");n.initialOffer.sdp&&kb(n.initialOffer.sdp)&&(i=n.localCapabilities,(r=e.rtpCapabilities).send&&(el(q.VIDEO,r.send.videoExtensions,i.send.videoExtensions),el(q.AUDIO,r.send.audioExtensions,i.send.audioExtensions)),r.recv&&(el(q.VIDEO,r.recv.videoExtensions,i.recv.videoExtensions),el(q.AUDIO,r.recv.audioExtensions,i.recv.audioExtensions))),n.remoteSDP=new X3(ci(ci({},e),{},{localCapabilities:n.localCapabilities})),e.preallocation&&(n.isPreallocation=!0),Array.isArray(n.remoteCodecs)&&n.remoteCodecs.length>0&&n.remoteSDP.updateRemoteCodec([],n.remoteCodecs,n.store.codec);const o=n.remoteSDP.toString(),s=Pb(n.initialOffer.sdp,n.extension),a=n.logSDPExchange(s||"","offer","local","connect");n.store.descriptionStart(),yield n.peerConnection.setLocalDescription({type:"offer",sdp:s}),a?.(o),yield n.peerConnection.setRemoteDescription({type:"answer",sdp:o});const c=n.peerConnection.getTransceivers()[0];if(null!=c&&c.receiver&&n.tryBindTransportEvents(c.receiver),A("PRELOAD_MEDIA_COUNT")>0){n.remoteSDP.preloadRemoteMedia(A("PRELOAD_MEDIA_COUNT"));const u=n.remoteSDP.toString();yield n.peerConnection.setRemoteDescription({type:"offer",sdp:u});const l=yield n.peerConnection.createAnswer();yield n.peerConnection.setLocalDescription(l)}const{preSSRCs:d}=e;if(Array.isArray(d)&&d.length>0){const{mids:u}=n.remoteSDP.batchSend(d.map(l=>({kind:l.kind,ssrcMsg:[{ssrcId:l.ssrcId,rtx:l.rtx}],mslabel:l.mslabel})));u.forEach((l,p)=>{n.preSSRCMap.set(d[p].ssrcId,l)}),yield ol(n.peerConnection,n.remoteSDP,n.extension),_.debug("[".concat(n.store.clientId,"] [P2PConnection] pre-batchReceive exchange SDP."))}}catch(o){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(o.toString()))}var r,i})()}updateRemoteConnect(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");const{rtpCapabilities:r}=e;n.remoteSDP.updateRemoteRTPCapabilities(r),Array.isArray(n.remoteCodecs)&&n.remoteCodecs.length>0&&n.remoteSDP.updateRemoteCodec([],n.remoteCodecs,n.store.codec);const{preSSRCs:i}=e;if(Array.isArray(i)&&i.length>0){const{mids:o}=n.remoteSDP.batchSend(i.map(s=>Object.assign({},{kind:s.kind,ssrcMsg:[{ssrcId:s.ssrcId,rtx:s.rtx}],mslabel:s.mslabel})));o.forEach((s,a)=>{n.preSSRCMap.set(i[a].ssrcId,s)})}yield ol(n.peerConnection,n.remoteSDP,n.extension),_.debug("[P2PConnection] updateRemoteRTPCapabilities by exchanging SDP.")}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(r.toString()))}})()}send(e,n,r){var i=this;return Zn(function*(){const o=yield mt(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[];e.forEach(m=>{const f=i.peerConnection.addTransceiver(m._mediaStreamTrack,{direction:"sendonly"});s.push(f),m._updateRtpTransceiver(f)}),ee()&&!0===A("SIMULCAST")&&(yield mt(i.applySimulcastForFirefox(s,e)));const a=yield mt(i.peerConnection.createOffer()),c=i.remoteSDP.predictReceivingMids(e.length),d=i.mungSendOfferSDP(a.sdp,e,c),u=Fe.parse(d),l=c.map(m=>{const f=u.mediaDescriptions.find(g=>g.attributes.mid===m);if(!f)throw new Error("Cannot extract ssrc from mediaDescription.");return Ib(f,A("USE_PUB_RTX"))});let p;try{p=yield l}catch(m){p=[],i.remoteSDP.receive(e,n,r,p);const f=i.remoteSDP.toString();throw yield mt(i.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield mt(i.peerConnection.setRemoteDescription({type:"answer",sdp:f})),yield mt(i.stopSending(c,!0)),m}i.remoteSDP.receive(e,n,r,p);const h=i.remoteSDP.toString(),S=i.logSDPExchange(d,"offer","local","send");return yield mt(i.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield mt(i.applySimulcastEncodings(s,e)),yield mt(i.applySendEncodings(s,e)),S?.(h),yield mt(i.peerConnection.setRemoteDescription({type:"answer",sdp:h})),s.map((m,f)=>({localSSRC:l[f],id:c[f],transceiver:m}))}catch(s){throw s instanceof P?s:new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}createDataChannels(e,n){var r=this;return y(function*(){try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=r.dataStreamChannelMap.get(e);if(i&&"open"===i.readyState)_.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const s=r.currentDataChannelId<1023?r.currentDataChannelId++:r.recoveredDataChannelIds.shift();if("number"!=typeof s)throw new Error("create DataChannel error, because cannot get dc id");i=r.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:A("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",r.dataStreamChannelMap.set(e,i)}n.forEach(s=>{s._updateOriginDataChannel(i)});const{needExchangeSDP:o}=r.remoteSDP.sendDataChannel();if(o){const s=r.remoteSDP.toString();yield r.peerConnection.setRemoteDescription({type:"offer",sdp:s});const a=yield r.peerConnection.createAnswer();yield r.peerConnection.setLocalDescription(a),_.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else _.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof P?i:new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}})()}stopDataChannels(e){var n=this;return y(function*(){try{const r=n.dataStreamChannelMap.get(e);return r&&(r.id&&n.recoveredDataChannelIds.push(r.id),r.close()),void n.dataStreamChannelMap.delete(e)}catch(r){throw r instanceof P?r:new P(v.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(r.toString()))}})()}stopSending(e,n){var r=this;return y(function*(){const i=n?void 0:yield r.mutex.lock("From P2PConnection.stopSending");try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const o=r.peerConnection.getTransceivers().filter(d=>-1!==e.indexOf(d.mid));if(o.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");o.map(d=>{var u;El(r.id+d.mid,r),d.direction="inactive",null===(u=d.stop)||void 0===u||u.call(d)});const s=yield r.peerConnection.createOffer(),a=r.logSDPExchange(s.sdp||"","offer","local","stopSending");yield r.peerConnection.setLocalDescription(s),r.remoteSDP.stopReceiving(e);const c=r.remoteSDP.toString();a?.(c),yield r.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(o){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(o.toString()))}finally{i&&i()}})()}receive(e,n,r,i){var o=this;return y(function*(){try{if(!o.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:a}=o.remoteSDP.send(e,n,r,i);a&&(yield ol(o.peerConnection,o.remoteSDP,o.extension),_.debug("[".concat(o.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));const c=o.peerConnection.getTransceivers().find(d=>d.mid===s);if(!c)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,id:s,transceiver:c}}catch(s){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}})()}batchReceive(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:r,needExchangeSDP:i}=n.remoteSDP.batchSend(e);return i&&(yield ol(n.peerConnection,n.remoteSDP,n.extension),_.debug("[".concat(n.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),r.map(o=>{const s=n.peerConnection.getTransceivers().find(a=>a.mid===o);if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:o,transceiver:s}})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(r.toString()))}})()}stopReceiving(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach(s=>{Array.from(n.preSSRCMap.entries()).some(a=>{let[c,d]=a;if(d===s)return n.preSSRCMap.delete(c),!0})}),n.remoteSDP.stopSending(e);const r=n.remoteSDP.toString(),i=n.logSDPExchange(r,"offer","remote","stopReceiving");yield n.peerConnection.setRemoteDescription({type:"offer",sdp:r});const o=yield n.peerConnection.createAnswer();i?.(o.sdp||""),yield n.peerConnection.setLocalDescription(o)}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(r.toString()))}})()}muteRemote(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));n.remoteSDP.mute(e);const r=n.remoteSDP.toString(),i=n.logSDPExchange(r,"offer","remote","muteRemote");yield n.peerConnection.setRemoteDescription({type:"offer",sdp:r});const o=yield n.peerConnection.createAnswer();i?.(o.sdp||""),yield n.peerConnection.setLocalDescription(o)}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(r.toString()))}})()}unmuteRemote(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));n.remoteSDP.unmute(e);const r=n.remoteSDP.toString(),i=n.logSDPExchange(r,"offer","remote","unmuteRemote");yield n.peerConnection.setRemoteDescription({type:"offer",sdp:r});const o=yield n.peerConnection.createAnswer();i?.(o.sdp||""),yield n.peerConnection.setLocalDescription(o)}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(r.toString()))}})()}muteLocal(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const r=n.peerConnection.getTransceivers().filter(a=>a.mid&&-1!==e.indexOf(a.mid));if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");r.map(a=>{a.direction="inactive"});const i=yield n.peerConnection.createOffer(),o=n.logSDPExchange(i.sdp||"","offer","local","muteLocal");yield n.peerConnection.setLocalDescription(i),n.remoteSDP.muteRemote(e);const s=n.remoteSDP.toString();o?.(s),yield n.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(r.toString()))}})()}unmuteLocal(e){var n=this;return y(function*(){try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const r=n.peerConnection.getTransceivers().filter(a=>a.mid&&-1!==e.indexOf(a.mid));if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");r.map(function(){var a=y(function*(c,d){c.direction="sendonly"});return function(c,d){return a.apply(this,arguments)}}());const i=yield n.peerConnection.createOffer(),o=n.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");yield n.peerConnection.setLocalDescription(i),n.remoteSDP.unmuteRemote(e);const s=n.remoteSDP.toString();o?.(s),yield n.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(r){throw new P(v.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(r.toString()))}})()}restartICE(e){var n=this;return Zn(function*(){const r=yield mt(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(St().supportPCSetConfiguration){const d=n.peerConnection.getConfiguration(),u=e===bn.RELAY?"relay":"all";d.iceTransportPolicy!==u&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(u,"]")),d.iceTransportPolicy=u,n.peerConnection.setConfiguration(d))}else if(e===bn.RELAY)return;n.remoteSDP.updateCandidates(e);const i=yield mt(n.peerConnection.createOffer({iceRestart:!0}));if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=oo(i.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);const a=n.remoteSDP.toString(),c=n.logSDPExchange(i.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield mt(n.peerConnection.setLocalDescription(i)),c?.(a),yield mt(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(i){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),i)}finally{r()}})()}close(){var e;this.peerConnection.getTransceivers().forEach(n=>{El(this.id+n.mid,this)}),this.preSSRCMap.clear(),this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return ci(ci({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}updateEncoderConfig(e,n){var r=this;return y(function*(){try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=yield r.peerConnection.createOffer(),o=r.mungSendOfferSDP(i.sdp,[n],[e]);r.remoteSDP.updateRecvMedia(e,n);const s=r.remoteSDP.toString(),a=r.logSDPExchange(o,"offer","local","updateEncoderConfig");yield r.peerConnection.setLocalDescription({type:"offer",sdp:o}),a?.(s),yield r.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new P(v.EXCHANGE_SDP_FAILED,i.toString())}})()}updateSendParameters(e,n){var r=this;return y(function*(){const i=r.peerConnection.getTransceivers().filter(o=>o.mid===e);1===i.length&&(r.isVP8Simulcast(n)?ee()||(yield r.applySimulcastEncodings(i,[n])):yield r.applySendEncodings(i,[n]))})()}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}replaceTrack(e,n){var r=this;return y(function*(){const i=r.peerConnection.getTransceivers().find(o=>o.mid===n);i&&(yield i.sender.replaceTrack(e._mediaStreamTrack))})()}getSelectedCandidatePair(){var e=this;return y(function*(){const n=e.peerConnection.getReceivers();if(n.length>0&&n[0].transport&&n[0].transport.iceTransport&&n[0].transport.iceTransport.getSelectedCandidatePair&&n[0].transport.iceTransport.getSelectedCandidatePair()){const r=n[0].transport.iceTransport,{local:i,remote:o}=r.getSelectedCandidatePair();return{local:ci(ci({},ai),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:ci(ci({},ai),{},{candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})}}return e.statsFilter.getSelectedCandidatePair()})()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},A("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(yu(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...$c.turnServerConfigToIceServers(e.turnServer.servers)),A("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...$c.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),A("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(n.iceTransportPolicy="relay")}))),A("ENABLE_ENCODED_TRANSFORM")&&St().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach(r=>{r.security?r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(Hs(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!A("FORCE_TURN_TCP")&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),n}tryBindTransportEvents(e){const n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var i;null!=n&&n.state&&(null===(i=this.onDTLSTransportStateChange)||void 0===i||i.call(this,n.state))},n.onerror=i=>{var o;null===(o=this.onDTLSTransportError)||void 0===o||o.call(this,"error"in i?i.error:i)};const r=n.iceTransport;r&&(r.onstatechange=()=>{const i=n?.iceTransport.state;var o;i&&(null===(o=this.onICETransportStateChange)||void 0===o||o.call(this,i))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){const{local:i,remote:o}=r.getSelectedCandidatePair();_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol}),", remote ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}updateRtpSenderEncodings(e,n){var r=this;return y(function*(){var i,o;if(n||(n=r.peerConnection.getSenders().find(g=>g.track===e._mediaStreamTrack)),!n)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(r.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!St().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},a={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const c=(g=e._mediaStreamTrack,r.peerConnection.getTransceivers().find(R=>R.sender.track===g||R.receiver.track===g)),d=(t=>{const e=t._encoderConfig;if(!e)return;const{frameRate:n,width:r,height:i}=t.getMediaStreamTrackSettings();let{frameRate:o=n,width:s=r,height:a=i}=e;if(!o||!s||!a)return;s=U_(s),a=U_(a),o=U_(o);const{max:c,min:d}=function(h,S,m){const f=200*Math.pow(m/15,.6)*Math.pow(h*S/640/360,.75);return{min:Math.floor(f),max:Math.floor(4*f)}}(s,a,o),{bitrateMax:u,bitrateMin:l}=e||{};u||_.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(a,", fps: ").concat(o,"] => [brMax: ").concat(u,", brMin: ").concat(l,"]"));const{maxFramerate:p}=A("ENCODER_CONFIG_LIMIT");return p&&"number"==typeof p&&(o=Math.min(o,p)),{frameRate:o,bitrateMax:u||c,bitrateMin:l||d,scaleResolutionDownBy:1,scale:0}})(e);var g;if(function Z3(t){var e;return!(!A("ENABLE_AG_ADAPTATION")||!(t instanceof KE||W(e=t._hints).call(e,Bt.CUSTOM_TRACK))||!A("FORCE_SUPPORT_AG_ADAPTATION")&&!(function(){const r=Tt();if(r.os!==we.IOS||!r.osVersion)return!1;const i=r.osVersion.split(".");return Number(i[0])>=14}()&&Vy(17,4,!0)||xy(14)&&Fy(17,4,!0)))}(e)&&c&&n&&d&&r.getLocalVideoStats&&W(i=["vp8","vp9"]).call(i,r.store.codec)){var u;const f=s.degradationPreference||(W(u=e._hints).call(u,Bt.CUSTOM_TRACK)?A("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");!function(g,R,C,b,w,D){if(El(g,C),w(R),"balanced"!==b&&"maintain-framerate"!==b&&"maintain-resolution"!==b)return;let V=-1;BO(g,R);const U=window.setInterval(()=>{const Z=_l.get(g);if(!A("ENABLE_AG_ADAPTATION")||!Z)return El(g,C),void w(R);const $=D();if($.sendPackets>0&&$.OutgoingAvailableBandwidth>0){if(-1===V)return void(V=Date.now());if(Date.now()-V<1e3)return;const Rt=$.sendFrameRate,Nt=$.OutgoingAvailableBandwidth,[oe,Yt]=function Q3(t,e,n,r,i,o){const s=hl.get(t)||{overUse:0,underUse:0,adaptationList:jO(i)},{adaptationList:a}=s;hl.set(t,s);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=G_,{scale:u}=r;let l,p;return"number"==typeof e&&e>0&&function(h,S,m,f){if(S>=m.length)return!1;let{threshold:{fps_down:g}}=m[S];return A("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===f&&(g=m[0].threshold.fps_down),h<g}(e,u,a,o)&&(s.overUse++,p=Oc.CPU,s.overUse>c)||"number"==typeof n&&n>0&&function(h,S,m){if(S>=m.length)return!1;const{threshold:{bwe_down:f}}=m[S];return h<f}(n,u,a)&&(s.overUse++,p=Oc.BANDWIDTH,s.overUse>c)?(s.overUse=0,s.underUse=0,l=FO(r,a,o,_a.DOWN),[l,p]):("number"==typeof e&&e>0&&"number"==typeof n&&n>0&&function(h,S,m,f){if(0===S)return;let{threshold:{fps_up:g}}=m[S];return A("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===f&&(g=m[1].threshold.fps_up),h>g}(e,u,a,o)&&function(h,S,m){if(0===S)return;const{threshold:{bwe_up:f}}=m[S];return h>f}(n,u,a)&&(s.underUse++,s.underUse>d&&(s.overUse=0,s.underUse=0,l=FO(r,a,o,_a.UP),0===l.scale&&(p=Oc.NONE))),[l,p])}(g,Rt,Nt,Z.adaptationConfig,R,b);Yt&&(C.qualityLimitationReason=Yt),oe&&Z.adaptationConfig.scale!==oe.scale&&(_.debug("[".concat(g,"] applyAdaptation: ").concat(C.qualityLimitationReason,"\n           sendFps ").concat(Rt,", bwe ").concat(Nt,", switch from ").concat(Z.adaptationConfig.scale," to ").concat(oe.scale," ")),Z.adaptationConfig=Am(Am({},Z.adaptationConfig),oe),w(oe))}},A("CHECK_LOCAL_STATS_INTERVAL")),k=Am({},R);_l.set(g,{timer:U,adaptationConfig:k,originConfig:R,adaptationFunc:w}),_.debug("[".concat(g,"] start adaptation, originConfig: ").concat(JSON.stringify(R),", degradationPreference: ").concat(b))}(r.id+c.mid,d,r,f,g=>{n&&r.updateAdaptation(n,g)},r.getLocalVideoStats.bind(r))}if(e._encoderConfig){var l;const{bitrateMax:f,frameRate:g,scaleResolutionDownBy:R}=e._encoderConfig;f&&(a.maxBitrate=1e3*f),(W(l=e._hints).call(l,Bt.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(g&&(a.maxFramerate=On(g)),R&&R>=1&&(a.scaleResolutionDownBy=R))}const{maxFramerate:p}=A("ENCODER_CONFIG_LIMIT");if(p&&"number"==typeof p&&(a.maxFramerate=a.maxFramerate?Math.min(a.maxFramerate,p):p),A("DSCP_TYPE")&&Xi()){var h;const f=A("DSCP_TYPE");W(h=["very-low","low","medium","high"]).call(h,f)&&(a.networkPriority=f)}const S=n.getParameters(),m=null===(o=S.encodings)||void 0===o?void 0:o[0];var f;ee()&&!m&&(s.encodings=[a]),m&&Object.assign(m,a),Object.assign(S,s),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(S.encodings))),yield n.setParameters(S),yield(f=y(function*(g,R,C){try{var b;if(!St().supportSetRtpSenderParameters||!function(k){return"vp9"===k}(g)||!A("ENABLE_SVC"))return;const w={},D={},V=R.getParameters(),U=null===(b=V.encodings)||void 0===b?void 0:b[0];D.scalabilityMode=zE(C),U&&Object.assign(U,D),Object.assign(V,w),yield R.setParameters(V),_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(V.encodings)))}catch(w){_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",w)}}),function(g,R,C){return f.apply(this,arguments)})(r.store.codec,n,A("SVC_MODE"))})()}updateAdaptation(e,n){var r=this;return y(function*(){var i,o;if(!e)return _.debug("[updateAdaptation] no rtpSender found");if(!St().supportSetRtpSenderParameters)return _.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:a,frameRate:c,scaleResolutionDownBy:d}=n;a&&(s.maxBitrate=1e3*a),c&&(s.maxFramerate=On(c)),d&&d>=1&&W(i=["vp8","vp9"]).call(i,r.store.codec)&&(s.scaleResolutionDownBy=d);const u=e.getParameters(),l=null===(o=u.encodings)||void 0===o?void 0:o[0];l&&Object.assign(l,s),Object.assign(u,{});try{yield e.setParameters(u),_.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(u.encodings)))}catch(p){!("transport"in e)||e.transport&&"connected"===e.transport.state?"connected"!==r.peerConnectionState?_.debug("[updateAdaptation] peerConnection not connected}"):_.debug("[updateAdaptation] updateRtpSenderEncodings failed",p):_.debug("[updateAdaptation] rtpSender transport not connected}")}})()}applySendEncodings(e,n){var r=this;return y(function*(){try{if(!St().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const o=e[i],s=n[i];s instanceof Kt&&!r.isVP8Simulcast(s)&&(yield r.updateRtpSenderEncodings(s,o.sender))}}catch{_.debug("[".concat(r.store.clientId,"] Apply RTPSendEncodings failed."))}})()}mungSendOfferSDP(e,n,r){const i=Fe.parse(e);return n.forEach((o,s)=>{const a=r[s],c=i.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(da(c,o),wb(c,o,this.store.codec))}),Fe.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;null===(n=this.onFirstAudioReceived)||void 0===n||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;null===(n=this.onFirstVideoReceived)||void 0===n||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;null===(n=this.onFirstAudioDecoded)||void 0===n||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,r)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var r;null===(r=this.onSelectedLocalCandidateChanged)||void 0===r||r.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var r;null===(r=this.onSelectedRemoteCandidateChanged)||void 0===r||r.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;null===(n=this.onFirstVideoDecodedTimeout)||void 0===n||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}applySimulcastForFirefox(e,n){var r=this;return y(function*(){if(e.length===n.length)for(let d=0;d<e.length;d++){var i,o,s,a,c;const u=e[d],l=n[d];if(l instanceof Kt&&!W(i=l._hints).call(i,Bt.LOW_STREAM)&&null!==(o=l._encoderConfig)&&void 0!==o&&o.bitrateMax&&(null===(s=l._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(a=l._scalabilityMode)&&void 0!==a&&a.numSpatialLayers&&(null===(c=l._scalabilityMode)||void 0===c?void 0:c.numSpatialLayers)>1&&"vp8"===r.store.codec){const p={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};p.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];const S=u.sender.getParameters();yield u.sender.setParameters(Object.assign(S,p))}}})()}applySimulcastEncodings(e,n){var r=this;return y(function*(){if(!ee()&&e.length===n.length)for(let i=0;i<e.length;i++){const o=n[i];if(o instanceof Kt&&r.isVP8Simulcast(o)){const s=e[i],a={},c={high:1e3*(o._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const d=s.sender.getParameters();yield s.sender.setParameters(Object.assign(d,a))}}})()}isVP8Simulcast(e){var n,r,i,o,s;return!!(e instanceof Kt&&A("SIMULCAST")&&"vp8"===this.store.codec&&!W(n=e._hints).call(n,Bt.LOW_STREAM)&&null!==(r=e._encoderConfig)&&void 0!==r&&r.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(o=e._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,n,r,i){if(A("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(n," SDP during P2PConnection.").concat(i,"\n"),e),"offer"===n?o=>{this.logSDPExchange(o,"answer","local"===r?"remote":"local",i)}:void 0}getRemoteSSRC(e){var n=this;return y(function*(){if(!n.remoteSDP)return;const r=n.remoteSDP.getSSRC(e);return r&&0!==r.length?r[0].ssrcId:void 0})()}setConfiguration(e){if(St().supportPCSetConfiguration){const n=$c.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},z(Et.prototype,"updateRemoteRTPCapabilities",[En],Object.getOwnPropertyDescriptor(Et.prototype,"updateRemoteRTPCapabilities"),Et.prototype),z(Et.prototype,"connect",[En],Object.getOwnPropertyDescriptor(Et.prototype,"connect"),Et.prototype),z(Et.prototype,"updateRemoteConnect",[En],Object.getOwnPropertyDescriptor(Et.prototype,"updateRemoteConnect"),Et.prototype),z(Et.prototype,"createDataChannels",[En],Object.getOwnPropertyDescriptor(Et.prototype,"createDataChannels"),Et.prototype),z(Et.prototype,"receive",[En],Object.getOwnPropertyDescriptor(Et.prototype,"receive"),Et.prototype),z(Et.prototype,"batchReceive",[En],Object.getOwnPropertyDescriptor(Et.prototype,"batchReceive"),Et.prototype),z(Et.prototype,"stopReceiving",[En],Object.getOwnPropertyDescriptor(Et.prototype,"stopReceiving"),Et.prototype),z(Et.prototype,"muteRemote",[En],Object.getOwnPropertyDescriptor(Et.prototype,"muteRemote"),Et.prototype),z(Et.prototype,"unmuteRemote",[En],Object.getOwnPropertyDescriptor(Et.prototype,"unmuteRemote"),Et.prototype),z(Et.prototype,"muteLocal",[En],Object.getOwnPropertyDescriptor(Et.prototype,"muteLocal"),Et.prototype),z(Et.prototype,"unmuteLocal",[En],Object.getOwnPropertyDescriptor(Et.prototype,"unmuteLocal"),Et.prototype),z(Et.prototype,"close",[En],Object.getOwnPropertyDescriptor(Et.prototype,"close"),Et.prototype),z(Et.prototype,"updateEncoderConfig",[En],Object.getOwnPropertyDescriptor(Et.prototype,"updateEncoderConfig"),Et.prototype),z(Et.prototype,"updateSendParameters",[En],Object.getOwnPropertyDescriptor(Et.prototype,"updateSendParameters"),Et.prototype),z(Et.prototype,"replaceTrack",[En],Object.getOwnPropertyDescriptor(Et.prototype,"replaceTrack"),Et.prototype),z(Et.prototype,"updateAdaptation",[En],Object.getOwnPropertyDescriptor(Et.prototype,"updateAdaptation"),Et.prototype),z(Et.prototype,"getRemoteSSRC",[En],Object.getOwnPropertyDescriptor(Et.prototype,"getRemoteSSRC"),Et.prototype),Et);function En(t,e,n){const r=t[e];if("function"!=typeof r)throw new Error("Cannot use mutex on object property.");return n.value=y(function*(){const i=this.mutex,o=yield i.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return yield r.apply(this,a)}finally{o()}}),n}var ut;function HO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function di(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?HO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):HO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}function KO(t){var e,n,r,i=2;for(typeof Symbol<"u"&&(n=f_,r=Symbol.iterator);i--;){if(n&&null!=(e=t[n]))return e.call(t);if(r&&null!=(e=t[r]))return new ml(e.call(t));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function ml(t){function e(n){if(Object(n)!==n)return H.reject(new TypeError(n+" is not an object."));var r=n.done;return H.resolve(n.value).then(function(i){return{value:i,done:r}})}return(ml=function(n){this.s=n,this.n=n.next}).prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return void 0===r?H.resolve({value:n,done:!0}):e(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return void 0===r?H.reject(n):e(r.apply(this.s,arguments))}},new ml(t)}let fl=(ut=class extends Zt{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(nt.StateChange,e,this._state)}constructor(t,e){var n;super(),n=this,T(this,"isPlanB",void 0),T(this,"store",void 0),T(this,"statsUploader",void 0),T(this,"connection",void 0),T(this,"localTrackMap",new Map),T(this,"remoteUserMap",new Map),T(this,"localDataChannels",[]),T(this,"remoteDataChannelMap",new Map),T(this,"pendingLocalTracks",[]),T(this,"pendingRemoteTracks",[]),T(this,"pendingLocalDataChannels",[]),T(this,"pendingRemoteDataChannels",[]),T(this,"statsCollector",void 0),T(this,"shouldForwardP2PCreation",void 0),T(this,"iceFailedCount",0),T(this,"dtlsFailedCount",0),T(this,"mutex",void 0),T(this,"_state",bt.Disconnected),T(this,"_pcStatsUploadType",A("NEW_ICE_RESTART")?yi.FIRST_CONNECTION:yi.OLD_FIRST_CONNECTION),T(this,"_isInRestartIce",!1),T(this,"_isStartRestartIce",!1),T(this,"_restartStates",["disconnected","failed"]),T(this,"_restartTimer",void 0),T(this,"_isFirstConnected",!0),T(this,"handleMuteLocalTrack",function(){var r=y(function*(i,o,s){const a=yield n.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!n.connection||n.state!==bt.Connected)return void s(new P(v.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const c=n.filterTobeMutedTracks(i);if(0===c.length)return void o();const d=c.find(l=>"videoLowTrack"===l[0]);d&&d[1].track._originMediaStreamTrack.stop(),yield n.connection.muteLocal(c.map(l=>{let[,{id:p}]=l;return p}));const u=n.createMuteMessage(c);yield xt(n,nt.RequestMuteLocal,u),o()}catch(c){s(c)}finally{a()}});return function(i,o,s){return r.apply(this,arguments)}}()),T(this,"handleUnmuteLocalTrack",function(){var r=y(function*(i,o,s){const a=yield n.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!n.connection||n.state!==bt.Connected)return void s(new P(v.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const c=n.filterTobeUnmutedTracks(i);if(0===c.length)return void o();const d=c.find(l=>"videoLowTrack"===l[0]);if(d){const l=d[1];if(l.track._originMediaStreamTrack.stop(),!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding){const p=i._mediaStreamTrack.clone();l.track._mediaStreamTrack=p,l.track._originMediaStreamTrack=p}else{const p=ym(i,sc(n,nt.RequestLowStreamParameter));l.track._mediaStreamTrack=p,l.track._originMediaStreamTrack=p}yield new H((p,h)=>{n.handleReplaceTrack(l.track,p,h,!0)})}yield n.connection.unmuteLocal(c.map(l=>{let[,{id:p}]=l;return p}));const u=n.createUnmuteMessage(c);yield xt(n,nt.RequestUnmuteLocal,u),o()}catch(c){s(c)}finally{a()}});return function(i,o,s){return r.apply(this,arguments)}}()),T(this,"handleUpdateVideoEncoder",function(){var r=y(function*(i,o,s){const a=yield n.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const c=n.localTrackMap.get(x.LocalVideoTrack);if(!n.connection||!c||c.track!==i||n.state!==bt.Connected)return void o();const{id:d,track:u}=c;yield n.connection.updateSendParameters(d,u),yield n.connection.updateEncoderConfig(d,u),n.emit(nt.UpdateVideoEncoder,u),o()}catch(c){s(c)}finally{a()}});return function(i,o,s){return r.apply(this,arguments)}}()),T(this,"handleUpdateVideoSendParameters",function(){var r=y(function*(i,o,s){const a=yield n.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const c=n.localTrackMap.get(x.LocalVideoTrack);if(!n.connection||!c||c.track!==i||n.state!==bt.Connected)return void o();const{id:d,track:u}=c;yield n.connection.updateSendParameters(d,u),o()}catch(c){s(c)}finally{a()}});return function(i,o,s){return r.apply(this,arguments)}}()),T(this,"handleReplaceMixingTrack",function(){var r=y(function*(i,o,s,a){if(!n.connection||n.state!==bt.Connected)return void o();const c=Im([i]);let d;_.debug("[".concat(n.store.clientId,"] [p2pId: ").concat(n.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(c.getTrackId(),"]")),"boolean"==typeof a&&a||(d=yield n.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{yield n.replaceTrack(i,c),o()}catch(l){s(l)}finally{var u;null===(u=d)||void 0===u||u()}});return function(i,o,s,a){return r.apply(this,arguments)}}()),T(this,"handleReplaceTrack",function(){var r=y(function*(i,o,s,a){let c;_.debug("[".concat(n.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),"boolean"==typeof a&&a||(c=yield n.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var d;const l=Array.from(n.localTrackMap.entries()).find(p=>{let[,{track:h}]=p;return i===h});if(!n.connection||!l||n.state!==bt.Connected)return void o();if(yield null===(d=n.connection)||void 0===d?void 0:d.replaceTrack(i,l[1].id),n.isPlanB){const p=l[1];p.id=i._mediaStreamTrack.id,n.localTrackMap.set(l[0],p)}if(l[0]===x.LocalVideoTrack&&!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding){const p=n.localTrackMap.get(x.LocalVideoLowTrack);if(p){const h=i._mediaStreamTrack.clone();p.track._originMediaStreamTrack.stop(),p.track._mediaStreamTrack=h,p.track._originMediaStreamTrack=h,yield new H((S,m)=>{n.handleReplaceTrack(p.track,S,m,!0)})}}o()}catch(l){s(l)}finally{var u;null===(u=c)||void 0===u||u()}});return function(i,o,s,a){return r.apply(this,arguments)}}()),T(this,"handleGetRTCStats",r=>{r(this.statsCollector.getRTCStats())}),T(this,"handleGetLocalVideoStats",r=>{r(this.statsCollector.getLocalVideoTrackStats())}),T(this,"handleGetLocalAudioStats",r=>{r(this.statsCollector.getLocalAudioTrackStats())}),T(this,"handleGetRemoteVideoStats",r=>this.statsCollector.getRemoteVideoTrackStats(r.uid)[r.uid]),T(this,"handleGetRemoteAudioStats",r=>this.statsCollector.getRemoteAudioTrackStats(r.uid)[r.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new fO(this.store),this.bindStatsUploaderEvents(),this.mutex=new Je("P2PChannel-mutex",this.store.clientId),this.isPlanB=!St().supportUnifiedPlan||A("CHROME_FORCE_PLAN_B")&&Xi(),this.shouldForwardP2PCreation=A("FORWARD_P2P_CREATION")&&St().supportPCSetConfiguration&&N_(),this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new Ac({},this.store):new Wr({},this.store),this.bindConnectionEvents(this.connection))}startP2PConnection(t){var e=this;return y(function*(){var n;e.state=bt.New;const r=e.shouldForwardP2PCreation&&"closed"===(null===(n=e.connection)||void 0===n?void 0:n.peerConnectionState);if(e.shouldForwardP2PCreation&&!r||(r&&e.connection&&(_.warning("[".concat(e.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),e.connection.close(),e.unbindConnectionEvents(e.connection)),e.connection=e.isPlanB?new Ac(t,e.store):new Wr(t,e.store),e.bindConnectionEvents(e.connection)),!e.connection)throw new P(v.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return e._pcStatsUploadType=A("NEW_ICE_RESTART")?yi.FIRST_CONNECTION:yi.OLD_FIRST_CONNECTION,e._isFirstConnected=!0,e._isInRestartIce=!1,e._isStartRestartIce=!1,e.connection.setConfiguration(t),e.connection.establishPromise})()}connect(t){var e=this;return y(function*(){if(!e.connection)throw new P(v.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");A("ENABLE_PREALLOC_PC")&&e.state===bt.Connected?yield e.connection.updateRemoteConnect(t):(e.store.peerConnectionStart(),yield e.connection.connect(t),e.statsUploader.startUploadTransportStats(),e.statsUploader.startUploadExtensionUsageStats(),e.state=bt.Connected)})()}updateRemoteRTPCapabilities(t){const e=Array.from(this.localTrackMap.entries()).filter(i=>{var o;let[s]=i;return W(o=[x.LocalVideoLowTrack,x.LocalVideoTrack]).call(o,s)}),n=e.map(i=>{let[,{id:o}]=i;return o}),r=e.map(i=>{let[o]=i;return o});if(this.connection instanceof Wr){if(Q.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(r),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!W(t).call(t,this.store.codec)){const i=["vp9","vp8","h264"].find(o=>W(t).call(t,o));i&&(this.store.codec=i,_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(i,".")))}this.connection.updateRemoteRTPCapabilities(n,t)}}getEstablishParams(){var t=this;return y(function*(){var e;if(t.connection instanceof Wr&&"closed"!==t.connection.peerConnectionState&&W(e=[bt.New,bt.Connected]).call(e,t.state))return t.connection.establishPromise})()}publishDataChannel(t){var e=this;return y(function*(){if(!e.connection||e.state!==bt.Connected){if(e.state===bt.Disconnected)throw new P(v.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return t.forEach(r=>{var i;W(i=e.pendingLocalDataChannels).call(i,r)||e.pendingLocalDataChannels.push(r)}),[]}const n=e.filterTobePublishedDataChannels(t);return 0===n.length?[]:(n.forEach(r=>{const i=Date.now();e.store.publish(r.id.toString(),"datachannel",i)}),yield e.connection.createDataChannels(e.store.uid,n),n.forEach(r=>{e.localDataChannels.push(r);const i=Date.now();e.store.publish(r.id+"","datachannel",void 0,i)}),t.map(r=>({streamId:r.id,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:r.metadata,channelId:r._originDataChannelId})))})()}publish(t,e,n){var r=this;return Zn(function*(){const i=yield mt(r.mutex.lock("From P2PChannel.publish"));try{if(!r.connection||r.state!==bt.Connected){if(r.state===bt.Disconnected)throw new P(v.UNEXPECTED_ERROR,"PeerConnection already disconnected.");r.throwIfTrackTypeNotMatch(t);const s=t.filter(a=>-1===r.pendingLocalTracks.indexOf(a));return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(s))}r.store.pubId=r.store.pubId+1,Qe.markPublishStart(r.store.clientId,r.store.pubId);const o=r.filterTobePublishedTracks(t,e,n);if(0===o.length)return void(yield mt(r.tryToUnmuteAudio(t)));yield*pu(KO(r.doPublish(r.connection,o)))}finally{i()}})()}doPublish(t,e){var n=this;return Zn(function*(){e.forEach(l=>{let{track:p,type:h}=l;const S=Date.now();n.store.publish(p.getTrackId(),h===x.LocalAudioTrack?"audio":"video",S)}),n.bindLocalTrackEvents(e);const r=e.map(l=>{let{track:p}=l;return p}),i=yield mt(t.send(r,n.store.codec,n.store.audioCodec)),o=(yield mt(i.next())).value,s=n.createGatewayPublishMessage(e,o);let a;try{a=yield s}catch(l){throw i.throw(l),l?.code===v.WS_ABORT&&e.forEach(p=>{let{track:h}=p;-1===n.pendingLocalTracks.indexOf(h)&&n.pendingLocalTracks.push(h)}),n.unbindLocalTrackEvents(e),l}const c=n.mapPubResToRemoteConfig(s,a,r),d=(yield mt(i.next(c))).value,u=A("ENABLE_VIDEO_SEI");r.forEach(function(){var l=y(function*(p){const h=p.getRTCRtpTransceiver();var S;h&&u&&(p.trackMediaType===q.VIDEO?yield function C3(t,e){return qE.apply(this,arguments)}(h.sender,p):p.trackMediaType===q.AUDIO&&(yield(S=y(function*(m){if(!St().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(Zu.has(m)||!m.track)return;const f={track:m.track};if(Ji()){if(!m.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let R=null;try{R=m.createEncodedStreams()}catch(b){return void _.error("create audio-encoded-streams error",b&&b.message)}const C=new TransformStream({transform(b,w){f.controller||(f.controller=w),m.track&&m.track.id!==f.track.id&&(_.debug("audio track changed: ".concat(f.track.id," => ").concat(m.track.id)),f.track.removeEventListener("ended",g),f.track=m.track,f.track.addEventListener("ended",g)),w.enqueue(b)}});R.readable.pipeThrough(C).pipeTo(R.writable)}else if(Ge()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const R=Qu(),C=new MessageChannel;yield new H(w=>R.onmessage=D=>{"registered"===D.data&&w(void 0)});const b=new RTCRtpScriptTransform(R,{name:"tx",port:C.port2},[C.port2]);m.transform=b,yield new H(w=>R.onmessage=D=>{"started"===D.data&&w(void 0)}),C.port1.onmessage=w=>{var D;w.data.transformed&&m.track&&(null===(D=m.track)||void 0===D?void 0:D.id)!==f.track.id&&(_.debug("audio track changed: ".concat(f.track.id," => ").concat(m.track.id)),f.track.removeEventListener("ended",g),f.track=m.track,f.track.addEventListener("ended",g))},f.worker=R}function g(){if(m.track){if(this.id!==m.track.id)return;m.track.removeEventListener("ended",g)}const R=Zu.get(m);if(R){Zu.delete(m);try{var C,b;null===(C=R.controller)||void 0===C||C.terminate(),null===(b=R.worker)||void 0===b||b.terminate()}catch(w){_.warning(w&&w.message)}}}Zu.set(m,f),m.track.addEventListener("ended",g)}),function(m){return S.apply(this,arguments)})(h.sender)))});return function(p){return l.apply(this,arguments)}}()),e.forEach(l=>{let{type:p}=l;n.statsCollector.addLocalStats(p)}),n.assignLocalTracks(e,d),n.statsUploader.startUploadOutboundStats(),e.forEach(l=>{let{track:p,type:h}=l;const S=Date.now();n.store.publish(p.getTrackId(),h===x.LocalAudioTrack?"audio":"video",void 0,S)})})()}updateVideoStreamParameter(t,e){var n=this;return y(function*(){const r=n.localTrackMap.get(e);if(!r)return;if(!(r.track instanceof Kt))return _.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(n.connection instanceof Wr||n.connection instanceof Ac))return _.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:i}=r,o=function(s,a){const c={};return s.height&&s.width&&(c.scaleResolutionDownBy=oE(s,a)),c.maxFramerate=s.framerate?On(s.framerate):void 0,c.maxBitrate=s.bitrate?1e3*s.bitrate:void 0,c}(t,i);if(i._encoderConfig||(i._encoderConfig={}),e!==x.LocalVideoLowTrack||!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding)null!=o.scaleResolutionDownBy&&(i._encoderConfig.scaleResolutionDownBy=o.scaleResolutionDownBy);else{const s=i._originMediaStreamTrack;if(!s.canvas)return _.warn("[".concat(i.getTrackId(),"] no canvas on track"));!function(a,c){const d=a.canvas;c.width&&(d.width=On(c.width)),c.height&&(d.height=On(c.height)),c.framerate&&(d.stopCapture&&d.stopCapture(),d.stopCapture=kE(()=>{!d.startCapture&&d.stopCapture&&d.stopCapture(),d.startCapture&&d.startCapture()},On(c.framerate)))}(s,t)}null!=o.maxBitrate&&(i._encoderConfig.bitrateMax=o.maxBitrate/1e3),null!=o.maxFramerate&&(i._encoderConfig.frameRate&&"object"==typeof i._encoderConfig.frameRate?i._encoderConfig.frameRate.max=o.maxFramerate:i._encoderConfig.frameRate={max:o.maxFramerate}),_.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),yield n.connection.updateRtpSenderEncodings(i)})()}publishLowStream(t){var e=this;return Zn(function*(){if(!e.connection||e.state!==bt.Connected)return;const n=yield mt(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const i=e.localTrackMap.get(x.LocalVideoTrack);if(!i)throw new P(v.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(x.LocalVideoLowTrack))throw new P(v.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:e.getLowVideoTrack(i.track,t),type:x.LocalVideoLowTrack}];if(yield*pu(KO(e.doPublish(e.connection,o))),i.track.muted||!i.track.enabled){var r;const s=null===(r=e.localTrackMap.get(x.LocalVideoLowTrack))||void 0===r?void 0:r.id;void 0!==s&&(yield mt(e.connection.muteLocal([s])))}}finally{n()}})()}republish(){var t=this;return y(function*(){t.pendingLocalTracks.length>0&&(_.debug("[".concat(t.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),yield He(t,nt.RequestRePublish,t.pendingLocalTracks),t.emit(nt.MediaReconnectEnd,t.store.uid),t.pendingLocalTracks=[]),t.pendingLocalDataChannels.length>0&&(_.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),yield He(t,nt.RequestRePublishDataChannel,t.pendingLocalDataChannels),t.pendingLocalDataChannels=[])})()}reSubscribe(t){var e=this;return y(function*(){for(let n=e.pendingRemoteTracks.length-1;n>=0;n--){const{user:r,kind:i}=e.pendingRemoteTracks[n];(i!==q.AUDIO||r._audio_added_&&r._audioSSRC)&&(i!==q.VIDEO||r._video_added_&&r._videoSSRC)||e.pendingRemoteTracks.splice(n,1)}if(t)yield He(e,nt.RequestReSubscribe,e.pendingRemoteTracks);else for(const{user:n,kind:r}of e.pendingRemoteTracks)yield e.subscribe(n,r,r===q.VIDEO?n._videoSSRC:n._audioSSRC);e.pendingRemoteTracks.forEach(n=>{let{user:r}=n;e.emit(nt.MediaReconnectEnd,r.uid)}),e.pendingRemoteTracks=[]})()}unpublish(t){var e=this;return y(function*(){if(!e.connection||e.state!==bt.Connected)return void t.forEach(i=>{const o=e.pendingLocalTracks.indexOf(i);-1!==o&&e.pendingLocalTracks.splice(o,1)});const n=e.filterTobeUnpublishedTracks(t);if(0===n.length)return;const r=n.find(i=>"videoLowTrack"===i[0]);return r&&r[1].track.close(),e.doUnpublish(e.connection,n)})()}unpublishDataChannel(t){var e=this;return y(function*(){if(!e.connection||e.state!==bt.Connected)return void t.forEach(r=>{const i=e.pendingLocalDataChannels.indexOf(r);-1!==i&&e.pendingLocalDataChannels.splice(i,1)});const n=e.filterTobeUnpublishedDataChannels(t);return 0!==n.length?(n.forEach(r=>{const i=e.localDataChannels.indexOf(r);-1!==i&&e.localDataChannels.splice(i,1)}),0===e.localDataChannels.length&&(yield e.connection.stopDataChannels(e.store.uid)),n.map(r=>r.id)):void 0})()}unpublishLowStream(){var t=this;return y(function*(){if(!t.connection||t.state!==bt.Connected)return;const e=t.localTrackMap.get(x.LocalVideoLowTrack);return e?(e.track.close(),t.doUnpublish(t.connection,[[x.LocalVideoLowTrack,e]])):void 0})()}doUnpublish(t,e){var n=this;return y(function*(){const r=n.createGatewayUnpublishMessage(e);return yield t.stopSending(e.map(i=>{let[,{id:o}]=i;return o})),n.withdrawLocalTracks(e),n.unbindLocalTrackEvents(e.map(i=>{let[o,{track:s}]=i;return{type:o,track:s}})),e.forEach(i=>{let[o]=i;n.statsCollector.removeLocalStats(o)}),0===n.localTrackMap.size&&n.statsUploader.stopUploadOutboundStats(),r})()}subscribeDataChannel(t,e){var n=this;return y(function*(){if(!n.connection||n.state!==bt.Connected)throw new P(v.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const r=e.filter(i=>{var o;return!(null!==(o=n.remoteDataChannelMap.get(t))&&void 0!==o&&o.get(i.id))});if(0!==r.length)return yield n.connection.createDataChannels(t.uid,r),r.forEach(i=>{var o;n.remoteDataChannelMap.has(t)?null===(o=n.remoteDataChannelMap.get(t))||void 0===o||o.set(i.id,i):n.remoteDataChannelMap.set(t,new Map([[i.id,i]]));const s=n.pendingRemoteDataChannels.findIndex(a=>{let{user:c,id:d}=a;return c.uid===t.uid&&d===i.id});-1!==s&&n.pendingRemoteDataChannels.splice(s,1)}),r.map(i=>i.id)})()}subscribe(t,e,n,r,i){var o=this;return y(function*(){var s;if(!o.connection||o.state!==bt.Connected)throw new P(v.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(s=o.remoteUserMap.get(t))&&void 0!==s&&s.has(e))return;let a,c,d;const u=o.connection.getPreMedia(n);if(u)_.debug("[".concat(o.store.clientId,"] [").concat(o.store.p2pId,"] preSSRCMap has ssrcId: ").concat(n,", no need to send sub to gateway.")),d=u.transceiver,a=u.track,c=u.id;else if(i){const h=i.find(m=>{let{stream_type:f}=m;return f===e});if(!h)throw new P(v.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const S=yield o.connection.receive(e,h.ssrcs,String(t._uintid),h.attributes);o.connection instanceof Wr&&(d=S.transceiver),a=S.track,c=S.id}else{const h=yield o.connection.receive(e,[{ssrcId:n,rtx:r}],String(t._uintid),void 0);o.connection instanceof Wr&&(d=h.transceiver),a=h.track,c=h.id}var h;e===q.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(a):(t._audioTrack=new aa(a,t.uid,t._uintid,o.store),_.info("[".concat(o.store.clientId,"] [").concat(o.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),d&&t._audioTrack._updateRtpTransceiver(d),o.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(a):(t._videoTrack=new sa(a,t.uid,t._uintid,o.store),_.info("[".concat(o.store.clientId,"] [").concat(o.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),d&&t._videoTrack._updateRtpTransceiver(d),o.bindRemoteTrackEvents(t,t._videoTrack)),A("ENABLE_VIDEO_SEI")&&d&&(e==q.VIDEO?yield(h=y(function*(S){let m=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!St().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(!S.track)return;if(gc.has(S)){const R=gc.get(S);return void(R&&(R.onSei=m.onSei))}const f={track:S.track,onSei:m.onSei};if(Ji()){if(!S.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let R=null;try{R=S.createEncodedStreams()}catch(b){return void _.error("create video-encoded-streams error",b&&b.message)}const C=new TransformStream({transform(b,w){f.controller||(f.controller=w),S.track&&S.track.id!==f.track.id&&(_.debug("video track changed: ".concat(f.track.id," => ").concat(S.track.id)),f.track.removeEventListener("ended",g),f.track=S.track,f.track.addEventListener("ended",g));const D=function(V){const U=new DataView(V.data);let k=0;for(;k+4<V.data.byteLength;){if(0===U.getUint8(k+0)&&0===U.getUint8(k+1)&&0===U.getUint8(k+2)&&1===U.getUint8(k+3)&&6===U.getUint8(k+4)){let Z=k+6,$=0,Rt=0;for(;255===(Rt=U.getUint8(Z++));)$+=255;$+=Rt;const Nt=y3(V.data,Z,$);return new Uint8Array(Nt)}k++}return null}(b);D&&f.onSei&&f.onSei(D),w.enqueue(b)}});R.readable.pipeThrough(C).pipeTo(R.writable)}else if(Ge()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const R=Qu(),C=new MessageChannel;yield new H(w=>R.onmessage=D=>{"registered"===D.data&&w(void 0)});const b=new RTCRtpScriptTransform(R,{name:"rx",port:C.port2},[C.port2]);S.transform=b,yield new H(w=>R.onmessage=D=>{"started"===D.data&&w(void 0)}),C.port1.onmessage=w=>{var D;w.data.transformed&&S.track&&(null===(D=S.track)||void 0===D?void 0:D.id)!==f.track.id?(_.debug("video track changed: ".concat(f.track.id," => ").concat(S.track.id)),f.track.removeEventListener("ended",g),f.track=S.track,f.track.addEventListener("ended",g)):w.data.sei&&f.onSei&&f.onSei(w.data.sei)},f.worker=R}function g(){if(S.track){if(this.id!==S.track.id)return;S.track.removeEventListener("ended",g)}!function(R){const C=gc.get(R);if(C){gc.delete(R);try{var b,w;null===(b=C.controller)||void 0===b||b.terminate(),null===(w=C.worker)||void 0===w||w.terminate()}catch(D){_.warning(D&&D.message)}}}(S)}gc.set(S,f),S.track.addEventListener("ended",g)}),function(S){return h.apply(this,arguments)})(d.receiver,{onSei:h=>{var S;null===(S=t._videoTrack)||void 0===S||S._onSei(h)}}):e==q.AUDIO&&(yield function(){var h=y(function*(S){if(!St().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if($u.has(S))return;const m={track:S.track};if(Ji()){if(!S.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let g=null;try{g=S.createEncodedStreams()}catch(C){return void _.error("create audio-encoded-streams error",C&&C.message)}const R=new TransformStream({transform(C,b){m.controller||(m.controller=b),S.track&&S.track.id!==m.track.id&&(_.debug("audio track changed: ".concat(m.track.id," => ").concat(S.track.id)),m.track.removeEventListener("ended",f),m.track=S.track,m.track.addEventListener("ended",f)),b.enqueue(C)}});g.readable.pipeThrough(R).pipeTo(g.writable)}else if(Ge()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const g=Qu(),R=new MessageChannel;yield new H(b=>g.onmessage=w=>{"registered"===w.data&&b(void 0)});const C=new RTCRtpScriptTransform(g,{name:"rx",port:R.port2},[R.port2]);S.transform=C,yield new H(b=>g.onmessage=w=>{"started"===w.data&&b(void 0)}),R.port1.onmessage=b=>{var w;b.data.transformed&&S.track&&(null===(w=S.track)||void 0===w?void 0:w.id)!==m.track.id&&(_.debug("audio track changed: ".concat(m.track.id," => ").concat(S.track.id)),m.track.removeEventListener("ended",f),m.track=S.track,m.track.addEventListener("ended",f))},m.worker=g}function f(){S.track.removeEventListener("ended",f),function(g){const R=$u.get(g);if(R){$u.delete(g);try{var C,b;null===(C=R.controller)||void 0===C||C.terminate(),null===(b=R.worker)||void 0===b||b.terminate()}catch(w){_.warning(w&&w.message)}}}(S)}$u.set(S,m),S.track.addEventListener("ended",f)});return function(S){return h.apply(this,arguments)}}()(d.receiver)));const l=o.remoteUserMap.get(t);l?l.set(e,c):o.remoteUserMap.set(t,new Map([[e,c]])),o.statsCollector.addRemoteStats(t.uid),o.statsUploader.startUploadInboundStats();const p=o.pendingRemoteTracks.findIndex(h=>{let{user:S,kind:m}=h;return S.uid===t.uid&&e===m});-1!==p&&(o.pendingRemoteTracks.splice(p,1),o.emit(nt.MediaReconnectEnd,t.uid))})()}massSubscribe(t){var e=this;return y(function*(){return e.massSubscribeNoLock(t)})()}massSubscribeNoLock(t){var e=this;return y(function*(){if(!e.connection||e.state!==bt.Connected)throw new P(v.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(o=>{var s;let{user:a,mediaType:c}=o;return!(null!==(s=e.remoteUserMap.get(a))&&void 0!==s&&s.has(c))});const n=[],r=new Map;t.forEach(o=>{if(!e.connection)return;const s=e.connection.getPreMedia(o.ssrcId);s?r.set(o.ssrcId,s):n.push(o)});const i=yield e.connection.batchReceive(n.map(o=>{let{user:s,mediaType:a,ssrcId:c,rtxSsrcId:d}=o;return{kind:a,ssrcMsg:[{ssrcId:c,rtx:d}],mslabel:String(s._uintid)}}));n.forEach((o,s)=>{r.set(o.ssrcId,i[s])}),t.forEach(o=>{let{user:s,mediaType:a,ssrcId:c}=o;const d=r.get(c);if(!d)return void _.debug("[".concat(e.store.clientId,"] [").concat(e.store.p2pId,"] cannot find ").concat(s.uid," subscribe data,").concat(a,", ").concat(c));const{track:u,id:l,transceiver:p}=d;a===q.AUDIO?(s._audioTrack?s._audioTrack._updateOriginMediaStreamTrack(u):(s._audioTrack=new aa(u,s.uid,s._uintid,e.store),_.info("[".concat(e.store.clientId,"] [").concat(e.store.p2pId,"] create remote audio track: ").concat(s._audioTrack.getTrackId()))),p&&s._audioTrack._updateRtpTransceiver(p),e.bindRemoteTrackEvents(s,s._audioTrack)):(s._videoTrack?s._videoTrack._updateOriginMediaStreamTrack(u):(s._videoTrack=new sa(u,s.uid,s._uintid,e.store),_.info("[".concat(e.store.clientId,"] [").concat(e.store.p2pId,"] create remote video track: ").concat(s._videoTrack.getTrackId()))),p&&s._videoTrack._updateRtpTransceiver(p),e.bindRemoteTrackEvents(s,s._videoTrack));const h=e.remoteUserMap.get(s);h?h.set(a,l):e.remoteUserMap.set(s,new Map([[a,l]])),e.statsCollector.addRemoteStats(s.uid),e.statsUploader.startUploadInboundStats();const S=e.pendingRemoteTracks.findIndex(m=>{let{user:f,kind:g}=m;return f.uid===s.uid&&a===g});-1!==S&&(e.pendingRemoteTracks.splice(S,1),e.emit(nt.MediaReconnectEnd,s.uid))})})()}unsubscribe(t,e,n){var r=this;return y(function*(){const i=r.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return void 0!==e?c.uid===t.uid&&e===d:c.uid===t.uid});if(i.forEach(a=>{const c=r.pendingRemoteTracks.indexOf(a);r.pendingRemoteTracks.splice(c,1)}),r.connection&&r.state===bt.Connected||n||i.forEach(a=>{let{kind:c}=a;var d;if(c===q.AUDIO)null===(d=t._audioTrack)||void 0===d||d._destroy(),t._audioTrack=void 0;else if(c===q.VIDEO){var u;null===(u=t._videoTrack)||void 0===u||u._destroy(),t._videoTrack=void 0}}),!r.connection||r.state!==bt.Connected)return;const o=r.filterTobeUnSubscribedTracks(t,e);if(0===o.length)return;yield r.connection.stopReceiving(o.map(a=>{let[,{id:c}]=a;return c}));const s=r.createUnsubscribeMessage(o);return r.withdrawRemoteTracks(o),0===r.remoteUserMap.size&&r.statsUploader.stopUploadInboundStats(),o.forEach(a=>{let[c,{kind:d}]=a;var u,l;if(d===q.VIDEO&&c._videoSSRC&&(null===(u=r.connection)||void 0===u||u.setStatsRemoteVideoIsReady(c._videoSSRC,!1)),d===q.VIDEO)r.unbindRemoteTrackEvents(c._videoTrack),n||(null===(l=c._videoTrack)||void 0===l||l._destroy(),c._videoTrack=void 0);else if(d===q.AUDIO){var p;r.unbindRemoteTrackEvents(c._audioTrack),!n&&(null===(p=c._audioTrack)||void 0===p||p._destroy(),c._audioTrack=void 0)}}),s})()}unsubscribeDataChannel(t,e){var n=this;return y(function*(){if(e.forEach(o=>{const s=n.pendingRemoteDataChannels.findIndex(a=>a.id===o.id);-1!==s&&n.pendingRemoteDataChannels.splice(s,1)}),!n.connection)return;const r=n.filterTobeUnSubscribedDataChannels(t,e);if(0===r.length)return;e.forEach(o=>{o._close()});const i=n.remoteDataChannelMap.get(t);return r.forEach(o=>{i&&i.delete(o.id)}),i&&0===i.size&&(n.remoteDataChannelMap.delete(t),yield n.connection.stopDataChannels(t.uid)),r.map(o=>o.id)})()}massUnsubscribe(t){var e=this;return y(function*(){return e.massUnsubscribeNoLock(t)})()}massUnsubscribeNoLock(t){var e=this;return y(function*(){let n=[];for(const{user:o,mediaType:s}of t){const a=e.pendingRemoteTracks.filter(c=>{let{user:d,kind:u}=c;return void 0!==s?d.uid===o.uid&&s===u:d.uid===o.uid});a.forEach(c=>{const d=e.pendingRemoteTracks.indexOf(c);e.pendingRemoteTracks.splice(d,1)}),n=n.concat(a)}if(!e.connection||e.state!==bt.Connected)return void n.forEach(o=>{let{user:s,kind:a}=o;var c;if(a===q.AUDIO)null===(c=s._audioTrack)||void 0===c||c._destroy(),s._audioTrack=void 0;else if(a===q.VIDEO){var d;null===(d=s._videoTrack)||void 0===d||d._destroy(),s._videoTrack=void 0}});const r=Nr(t).call(t,(o,s)=>{let{user:a,mediaType:c}=s;const d=e.filterTobeUnSubscribedTracks(a,c);return o.concat(d)},[]);if(0===r.length)return;yield e.connection.stopReceiving(r.map(o=>{let[,{id:s}]=o;return s}));const i=e.createUnsubscribeAllMessage(r);return e.withdrawRemoteTracks(r),0===e.remoteUserMap.size&&e.statsUploader.stopUploadInboundStats(),r.forEach(o=>{let[s,{kind:a}]=o;var c,d;if(a===q.VIDEO&&s._videoSSRC&&(null===(c=e.connection)||void 0===c||c.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),a===q.VIDEO)e.unbindRemoteTrackEvents(s._videoTrack),null===(d=s._videoTrack)||void 0===d||d._destroy(),s._videoTrack=void 0;else if(a===q.AUDIO){var u;e.unbindRemoteTrackEvents(s._audioTrack),null===(u=s._audioTrack)||void 0===u||u._destroy(),s._audioTrack=void 0}}),i})()}isPreSubScribe(t){return!(!this.connection||this.state!==bt.Connected||!this.connection.getPreMedia(t))}muteRemote(t,e){var n=this;return y(function*(){if(!n.connection)return;const r=n.remoteUserMap.get(t);if(!r)return void _.warning("[".concat(n.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!r.get(e))return void _.warning("[".concat(n.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const i=e===q.VIDEO?t._videoSSRC:t._audioSSRC;void 0!==i&&n.connection.setStatsRemoteVideoIsReady(i,!1)})()}unmuteRemote(t,e){var n=this;return y(function*(){return n.unmuteRemoteNoLock(t,e)})()}unmuteRemoteNoLock(t,e){var n=this;return y(function*(){if(!n.connection)return;const r=n.remoteUserMap.get(t);r?r.get(e)||_.warning("[".concat(n.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,".")):_.warning("[".concat(n.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."))})()}getAllTracks(t){const e=this.localTrackMap.get(x.LocalAudioTrack);if(e?.track instanceof Ie){const n=e.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[i]=r;return i!==x.LocalAudioTrack}).filter(r=>{let[i]=r;return!(t&&i===x.LocalVideoLowTrack)}).map(r=>{let[,{track:i}]=r;return i}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return!(t&&r===x.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,n,r,i){if(t){const s=this.localTrackMap.get(x.LocalAudioTrack),a=this.localTrackMap.get(r?x.LocalVideoLowTrack:x.LocalVideoTrack);Q.publish(this.store.sessionId,{eventElapse:Qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:-1!==a?.track._hints.indexOf(Bt.SCREEN_TRACK),audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}else{var o;n||(n=[]);const s=n.find(c=>c instanceof ie),a=r?null===(o=this.localTrackMap.get(x.LocalVideoTrack))||void 0===o?void 0:o.track:n.find(c=>c instanceof Kt);Q.publish(this.store.sessionId,{eventElapse:Qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:-1!==a?._hints.indexOf(Bt.SCREEN_TRACK),audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}}reportSubscribeEvent(t,e,n,r){const i=r===q.VIDEO?n._videoSSRC:n._audioSSRC;i&&Q.subscribe(this.store.sessionId,{succ:t,ec:e,video:r===q.VIDEO,audio:r===q.AUDIO,peerid:n.uid,subscribeRequestid:i,p2pid:this.store.p2pId,eventElapse:Qe.measureFromSubscribeStart(this.store.clientId,i),preSsrc:this.isPreSubScribe(i)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Je("P2PChannel-mutex",this.store.clientId),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.isPlanB?new Ac({},this.store):new Wr({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(x.LocalAudioTrack);if(t?.track instanceof Ie){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach(n=>{e.removeAudioTrack(n)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=bt.Disconnected}getStats(){var t;return null===(t=this.connection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return(null===(e=this.connection)||void 0===e?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(x.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(x.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof Kt||e&&e.track instanceof ie?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}hasRemoteMediaWithLock(t,e){var n=this;return y(function*(){if(!t)return n.remoteUserMap.size>0;const r=n.remoteUserMap.get(t);return!!r&&(!e||r.has(e))})()}getRemoteMedia(t){var e;const n=Array.from(kn(e=this.remoteUserMap).call(e)).find(r=>r.uid===t);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(n=>{let[r]=n;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const e=this.localTrackMap.get(x.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Ga(t).call(t,(n,r)=>n.level-r.level),t}disconnectForReconnect(){var t=this;return y(function*(){t.connection&&(_.debug("[".concat(t.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),t.state=bt.Reconnecting,A("KEEP_LAST_FRAME")&&0!==t.remoteUserMap.size&&Array.from(t.remoteUserMap.entries()).forEach(e=>{let[n]=e;var r;n._videoTrack&&n._videoTrack._player&&(null===(r=n._videoTrack._player.getVideoElement())||void 0===r||r.pause(),n._videoTrack._player.isKeepLastFrame=!0,n._videoTrack._originMediaStreamTrack.stop())}),t.connection.close(),t.unbindConnectionEvents(t.connection),t.connection=void 0,t.shouldForwardP2PCreation&&(t.connection=t.isPlanB?new Ac({},t.store):new Wr({},t.store),t.bindConnectionEvents(t.connection)),0!==t.localTrackMap.size&&(Array.from(t.localTrackMap.entries()).forEach(e=>{var n;let[r,{track:i}]=e;switch(r){case x.LocalVideoTrack:W(n=i._hints).call(n,Bt.LOW_STREAM)?i.close():t.pendingLocalTracks.push(i);break;case x.LocalAudioTrack:i instanceof Ie?t.pendingLocalTracks=t.pendingLocalTracks.concat(i.trackList):t.pendingLocalTracks.push(i)}}),t.emit(nt.MediaReconnectStart,t.store.uid)),t.unbindLocalTrackEvents(),t.localTrackMap.clear(),0!==t.remoteUserMap.size&&Array.from(t.remoteUserMap.entries()).forEach(e=>{let[n,r]=e;Array.from(kn(r).call(r)).forEach(i=>{t.setPendingRemoteMedia(n,i)}),t.emit(nt.MediaReconnectStart,n.uid)}),t.unbindAllRemoteTrackEvents(),t.remoteUserMap.clear(),0!==t.localDataChannels.length&&(t.localDataChannels.forEach(e=>{t.pendingLocalDataChannels.push(e)}),t.localDataChannels.length=0),0!==t.remoteDataChannelMap.size&&(Array.from(t.remoteDataChannelMap.entries()).forEach(e=>{let[n,r]=e;Array.from(kn(r).call(r)).forEach(i=>{t.setPendingRemoteDataChannel(n,i)})}),t.remoteDataChannelMap.clear()),t.statsUploader.stopUploadOutboundStats(),t.statsUploader.stopUploadInboundStats(),t.statsUploader.stopUploadTransportStats(),_.debug("[".concat(t.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))})()}hasPendingRemoteDataChannel(t,e){for(const n of this.pendingRemoteDataChannels){const{user:r,id:i}=n;if((t instanceof uo?t.uid:t)===r.uid&&i===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:r,kind:i}=n;if((t instanceof uo?t.uid:t)===r.uid&&e===i)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return Zn(function*(){if(!e.connection||e.state!==bt.Connected)return;const n=yield mt(e.mutex.lock("From P2PChannel.restartICE"));let r;try{r=yield mt(e.connection.restartICE(t));const o=yield mt(r.next());if(o.done)return;const s=o.value,a=yield s;switch(e.reportPCDisconnectedOrFailed(t),t){case bn.TCP:e._pcStatsUploadType=yi.TCP_RESTART;break;case bn.RELAY:e._pcStatsUploadType=yi.RELAY_RESTART;break;default:e._pcStatsUploadType=yi.OLD_RESTART}e._isInRestartIce=!0,r.next(a)}catch(o){var i;null===(i=r)||void 0===i||i.throw(o)}finally{n()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(x.LocalVideoTrack),n=this.localTrackMap.get(x.LocalAudioTrack),r=t.videoSend.find(h=>h.ssrc===e?.ssrcs[0].ssrcId),i=t.audioSend.find(h=>h.ssrc===n?.ssrcs[0].ssrcId);if(!r||!i)return 1;const o=$n(this,nt.NeedSignalRTT),s=r?r.rttMs:void 0,a=i?i.rttMs:void 0,c=s&&a?(s+a)/2:s||a,u=100*t.sendPacketLossRate*.7/50+.3*((c&&o?(c+o)/2:c||o)||0)/1500,l=u<.17?1:u<.36?2:u<.59?3:u<.1?4:5,p=e?.track;if(p&&p._encoderConfig&&-1===p._hints.indexOf(Bt.SCREEN_TRACK)){const h=p._encoderConfig.bitrateMax,S=t.bitrate.actualEncoded;if(h&&S){const m=(1e3*h-S)/(1e3*h);return fC[m<.15?0:m<.3?1:m<.45?2:m<.6?3:4][l]}}return l}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[r]=n;const i=r._audioSSRC,o=r._videoSSRC,s=t.audioRecv.find(S=>S.ssrc===i),a=t.videoRecv.find(S=>S.ssrc===o);if(!s&&!a)return void(e+=1);const c=$n(this,nt.NeedSignalRTT),d=t.rtt,u=(d&&c?(d+c)/2:d||c)||0,l=s?s.jitterMs:void 0,p=t.recvPacketLossRate;let h=.7*p*100/50+.3*u/1500;l&&(h=.6*p*100/50+.2*u/1500+.2*l/400),e+=h<.1?1:h<.17?2:h<.36?3:h<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}muteLocalTrack(t){var e=this;return y(function*(){return new H((n,r)=>{e.handleMuteLocalTrack(t,n,r)})})()}replaceTrack(t,e){var n=this;return y(function*(){var r;if(_.debug("[".concat(n.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!n.connection||n.state!==bt.Connected)return;const i=Array.from(n.localTrackMap.entries()).find(s=>{let[,{track:a}]=s;return t===a});if(!i)return;const o=i[0];if(t!==e&&(n.unbindLocalTrackEvents([{track:t,type:o}]),n.bindLocalTrackEvents([{track:e,type:o}]),i[1].track=e),yield null===(r=n.connection)||void 0===r?void 0:r.replaceTrack(e,i[1].id),n.isPlanB){const s=i[1];s.id=e._mediaStreamTrack.id,n.localTrackMap.set(o,s)}if(o===x.LocalVideoTrack&&!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding){const s=n.localTrackMap.get(x.LocalVideoLowTrack);if(s){const a=t._mediaStreamTrack.clone();s.track._originMediaStreamTrack.stop(),s.track._mediaStreamTrack=a,s.track._originMediaStreamTrack=a,yield new H((c,d)=>{n.handleReplaceTrack(s.track,c,d,!0)})}}})()}filterTobePublishedTracks(t,e,n){const r=[],i=this.getAllTracks();t=Us(t=t.filter(c=>-1===i.indexOf(c)));let o,s=!1;const a=this.localTrackMap.get(x.LocalAudioTrack);for(const c of t){if(c instanceof Kt&&(this.localTrackMap.has(x.LocalVideoTrack)||s?new P(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:c,type:x.LocalVideoTrack}),s=!0),e)){const d=this.getLowVideoTrack(c,n);r.push({track:d,type:x.LocalVideoLowTrack})}if(c instanceof ie)if(a){const d=a.track;if(d instanceof Ie)Cm([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{const u=Im([d,c]);_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(u.getTrackId(),"]")),this.replaceTrack(d,u)}}else o instanceof Ie?(Cm([c]),o.addAudioTrack(c)):o=o||!c._useAudioElement&&St().webAudioMediaStreamDest&&!c._bypassWebAudio?Im(o?[c,o]:[c]):c}return o&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),r.push({track:o,type:x.LocalAudioTrack})),r}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=Us(t=t.filter(r=>-1!==n.indexOf(r)));for(const r of t){if(r instanceof ie){const i=this.localTrackMap.get(x.LocalAudioTrack);if(!i)continue;i.track instanceof Ie?(i.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),0===i.track.trackList.length&&(e.push([x.LocalAudioTrack,i]),i.track.close())):e.push([x.LocalAudioTrack,i])}if(r instanceof Kt){const i=this.localTrackMap.get(x.LocalVideoTrack);if(!i)continue;e.push([x.LocalVideoTrack,i]);const o=this.localTrackMap.get(x.LocalVideoLowTrack);o&&e.push([x.LocalVideoLowTrack,o])}}return e}filterTobePublishedDataChannels(t){return(t=Us(t)).filter(e=>-1===this.localDataChannels.findIndex(n=>n.id===e.id))}filterTobeUnpublishedDataChannels(t){return(t=(t=Us(t)).filter(e=>-1!==this.localDataChannels.indexOf(e))).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:n,type:r}=e;switch(r){case x.LocalVideoTrack:n.addListener(Y.GET_STATS,this.handleGetLocalVideoStats),n.addListener(Y.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Y.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(Y.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(Y.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case x.LocalAudioTrack:this.bindLocalAudioTrackEvents(n)}})}bindLocalAudioTrackEvents(t,e){t instanceof Ie?t.trackList.forEach(n=>{n.addListener(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(Y.GET_STATS,this.handleGetLocalAudioStats),n.addListener(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(Y.GET_STATS,this.handleGetLocalAudioStats),t.addListener(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(t.addListener(Y.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Y.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[n,{track:r}]=e;return{track:r,type:n}})),t.forEach(e=>{let{track:n,type:r}=e;switch(r){case x.LocalVideoTrack:n.off(Y.GET_STATS,this.handleGetLocalVideoStats),n.off(Y.GET_RTC_STATS,this.handleGetRTCStats),n.off(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(Y.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(Y.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(Y.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case x.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n)}})}unbindLocalAudioTrackEvents(t){t instanceof Ie?t.trackList.forEach(e=>{e.off(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Y.GET_STATS,this.handleGetLocalAudioStats),e.off(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(Y.GET_STATS,this.handleGetLocalAudioStats),t.off(Y.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Y.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Y.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Y.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(Y.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Y.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof sa&&e.addListener(Y.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(t))}),e instanceof aa&&e.addListener(Y.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(Y.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,n]=t;n.has(q.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(q.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((n,r)=>{var i;let o,s,{track:a,type:c}=n;switch(c){case x.LocalAudioTrack:o=At.Audio,s={dtx:a instanceof Xu&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case x.LocalVideoTrack:o=W(i=a._hints).call(i,Bt.SCREEN_TRACK)?At.Screen:At.High,s=di(di({},UC(a)),{},{codec:this.store.codec,svc_mode:zE()});break;case x.LocalVideoLowTrack:o=At.Low,s=di(di({},UC(a)),{},{codec:this.store.codec,svc_mode:zE()})}return{stream_type:o,attributes:s,ssrcs:e[r]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:s,id:a}]=e;switch(i){case x.LocalVideoTrack:r=W(n=o._hints).call(n,Bt.SCREEN_TRACK)?At.Screen:At.High;break;case x.LocalAudioTrack:r=At.Audio;break;case x.LocalVideoLowTrack:r=At.Low}return{stream_type:r,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((n,r)=>{let{track:i,type:o}=n;this.localTrackMap.set(o,{track:i,id:e[r].id,ssrcs:e[r].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[n]=e;this.localTrackMap.delete(n)})}bindConnectionEvents(t){var e=this;t.onConnectionStateChange=function(){var n=y(function*(r){if(_.info("[".concat(e.store.clientId,"] [p2pId: ").concat(e.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(r,")")),e.emit(nt.PeerConnectionStateChange,r),"connected"!==r||e.store.keyMetrics.peerConnectionEnd||e.store.peerConnectionEnd(),"connected"===r&&(e._restartTimer&&(clearTimeout(e._restartTimer),e._restartTimer=void 0),(e._isFirstConnected||e._isInRestartIce)&&e.reportPCStats(Date.now(),!0,e._pcStatsUploadType),e._isInRestartIce=!1,e._isFirstConnected=!1,e._isStartRestartIce=!1),A("NEW_ICE_RESTART")){var i;if(W(i=e._restartStates).call(i,r)){if(e._isStartRestartIce)return;e._isStartRestartIce=!0;const o=c=>{("disconnected"===t.iceConnectionState||"checking"===t.iceConnectionState||"failed"===t.iceConnectionState)&&(_.debug("[".concat(e.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(c)),"CONNECTED"===$n(e,nt.QueryClientConnectionState)&&e.emit(nt.RequestRestartICE,c))},s=()=>{"disconnected"!==t.iceConnectionState&&"checking"!==t.iceConnectionState&&"failed"!==t.iceConnectionState||(e.reportPCStats(Date.now(),!1,e._pcStatsUploadType),_.debug("[".concat(e.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>e.emit(nt.P2PLost),0),e.iceFailedCount+=1,e.requestReconnect())},a=A("ICE_RESTART_INTERVAL");return void(e._restartTimer=window.setTimeout(()=>{if(A("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&St().supportPCSetConfiguration)o(bn.RELAY),e._restartTimer=window.setTimeout(s,a);else if(ee())o(bn.UDP),e._restartTimer=window.setTimeout(s,4e3);else{if(o(bn.TCP),St().supportPCSetConfiguration)return void(e._restartTimer=window.setTimeout(()=>{o(bn.RELAY),e._restartTimer=window.setTimeout(s,a)},a));e._restartTimer=window.setTimeout(s,a)}},800))}}else{if("disconnected"===r&&"disconnected"===t.iceConnectionState)return setTimeout(()=>{"disconnected"===t.iceConnectionState&&A("ICE_RESTART")&&"CONNECTED"===$n(e,nt.QueryClientConnectionState)&&e.emit(nt.RequestRestartICE)},800),void setTimeout(()=>{"disconnected"===t.peerConnectionState&&(_.debug("[".concat(e.store.clientId,"] [p2pId: ").concat(e.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),e.reportPCStats(Date.now(),!1,e._pcStatsUploadType),e._isInRestartIce=!1,setTimeout(()=>e.emit(nt.P2PLost),0),e.iceFailedCount+=1,e.requestReconnect())},4e3);"failed"===r&&(_.debug("[".concat(e.store.clientId,"] [p2pId: ").concat(e.store.p2pId,"]: P2PConnection state failed, force reconnect")),e.reportPCDisconnectedOrFailed(),setTimeout(()=>e.emit(nt.P2PLost),0),e.iceFailedCount+=1,yield e.requestReconnect())}});return function(r){return n.apply(this,arguments)}}(),t.onICEConnectionStateChange=n=>{"connected"!==n||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(n,")")),Q.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:n,tag:ne.TRACER}).onSuccess(),this.emit(nt.IceConnectionStateChange,n)},t.onICETransportStateChange=n=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(n,")"))},t.onDTLSTransportStateChange=n=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(n,")"))},t.onDTLSTransportError=n=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(n,")"))},t.onFirstAudioDecoded=n=>{var r;const i=Array.from(kn(r=this.remoteUserMap).call(r)).find(s=>s._audioSSRC===n);var o;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),null===(o=i.audioTrack)||void 0===o||o.emit(ea.FIRST_FRAME_DECODED),Q.firstRemoteFrame(this.store.sessionId,Ue.FIRST_AUDIO_DECODE,$t.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:Qe.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=n=>{var r;const i=Array.from(kn(r=this.remoteUserMap).call(r)).find(o=>o._audioSSRC===n);i&&Q.firstRemoteFrame(this.store.sessionId,Ue.FIRST_AUDIO_RECEIVED,$t.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:Qe.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(n,r,i)=>{this.reportVideoFirstFrameDecoded(n,r,i)},t.onFirstVideoReceived=n=>{var r;const i=Array.from(kn(r=this.remoteUserMap).call(r)).find(o=>o._videoSSRC===n);i&&Q.firstRemoteFrame(this.store.sessionId,Ue.FIRST_VIDEO_RECEIVED,$t.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:Qe.measureFromSubscribeStart(this.store.clientId,n),subscribeRequestid:n,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(n,r)=>{const i="relay"===n.candidateType;"unknown"!==r.candidateType&&i===("relay"===r.candidateType)||this.emit(nt.ConnectionTypeChange,i),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(no(r))," -> ").concat(JSON.stringify(no(n)),")"))},t.onSelectedRemoteCandidateChanged=(n,r)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(no(r))," -> ").concat(JSON.stringify(no(n)),")"))},t.onFirstVideoDecodedTimeout=n=>{this.reportVideoFirstFrameDecoded(n,void 0,void 0,!0)},t.getLocalVideoStats=()=>{const n=this.statsCollector.getLocalVideoTrackStats(),r=this.statsCollector.getRTCStats();return di(di({},n),r)}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0}filterTobeMutedTracks(t){const e=[];if(-1===this.getAllTracks().indexOf(t))return e;const n=this.localTrackMap.get(x.LocalAudioTrack);if(t instanceof ie&&n?.track instanceof Ie)return n.track.isActive||e.push([x.LocalAudioTrack,n]),e;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return t===o});if(r&&(e.push(r),r[0]===x.LocalVideoTrack)){const i=this.localTrackMap.get(x.LocalVideoLowTrack);i&&e.push([x.LocalVideoLowTrack,i])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(x.LocalAudioTrack);if(t instanceof ie&&n?.track instanceof Ie)return n.track.isActive&&e.push([x.LocalAudioTrack,n]),e;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return t===o});if(r)if(r[0]===x.LocalVideoTrack){e.push(r);const i=this.localTrackMap.get(x.LocalVideoLowTrack);i&&e.push([x.LocalVideoLowTrack,i])}else e.push(r);return e}createMuteMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:s,id:a}]=e;switch(i){case x.LocalAudioTrack:r=At.Audio;break;case x.LocalVideoTrack:r=W(n=o._hints).call(n,Bt.SCREEN_TRACK)?At.Screen:At.High;break;case x.LocalVideoLowTrack:r=At.Low}return{stream_type:r,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var n;let r,[i,{track:o,ssrcs:s,id:a}]=e;switch(i){case x.LocalAudioTrack:r=At.Audio;break;case x.LocalVideoTrack:r=W(n=o._hints).call(n,Bt.SCREEN_TRACK)?At.Screen:At.High;break;case x.LocalVideoLowTrack:r=At.Low}return{stream_type:r,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){const n=[],r=this.remoteUserMap.get(t);if(!r)return n;if(e){const i=r.get(e);if(!i)return n;n.push([t,{kind:e,id:i}])}else Array.from(r.entries()).forEach(i=>{let[o,s]=i;n.push([t,{kind:o,id:s}])});return n}filterTobeUnSubscribedDataChannels(t,e){const n=[];return e.forEach(r=>{var i;null!==(i=this.remoteDataChannelMap.get(t))&&void 0!==i&&i.has(r.id)&&n.push(r)}),n}createUnsubscribeMessage(t){const e=[];return t.forEach(n=>{let[r,{kind:i}]=n;switch(i){case q.VIDEO:return void(r._videoSSRC&&e.push({stream_type:q.VIDEO,ssrcId:r._videoSSRC}));case q.AUDIO:return void(r._audioSSRC&&e.push({stream_type:q.AUDIO,ssrcId:r._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach(n=>{let[r,{kind:i}]=n;if(e.has(r)){let o=e.get(r);o|=i===q.VIDEO?Ne.Video:Ne.Audio,e.set(r,o)}else e.set(r,i===q.VIDEO?Ne.Video:Ne.Audio)}),{users:Array.from(e.entries()).map(n=>{let[r,i]=n;return{stream_id:r.uid,stream_type:i}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[n,{kind:r}]=e;const i=this.remoteUserMap.get(n);i&&(i.delete(r),0===Array.from(i.entries()).length&&this.remoteUserMap.delete(n))})}updateBitrateLimit(t){var e=this;return y(function*(){const n=e.localTrackMap.get(x.LocalVideoTrack),r=e.localTrackMap.get(x.LocalVideoLowTrack);n&&(yield n.track.setBitrateLimit(t.uplink)),r&&t.low_stream_uplink&&(yield r.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}))})()}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}mapPubResToRemoteConfig(t,e,n){return t.map((r,i)=>{var o;let{stream_type:s}=r;const a=null===(o=e.find(c=>{let{stream_type:d}=c;return s===d}))||void 0===o?void 0:o.attributes;if(a&&A("DISABLE_SCREEN_SHARE_REMB")){const c=n[i]._hints;(W(c).call(c,Bt.SCREEN_TRACK)||W(c).call(c,Bt.SCREEN_LOW_TRACK))&&(a.remb=!1,_.debug("disable remb for screen share, hints:",c))}return a})}tryToUnmuteAudio(t){var e=this;return y(function*(){for(let r=0;r<t.length;r++)if(t[r]instanceof ie){var n;const i=e.filterTobeUnmutedTracks(t[r]);if(0===i.length)continue;yield null===(n=e.connection)||void 0===n?void 0:n.unmuteLocal(i.map(s=>{let[,{id:a}]=s;return a}));const o=e.createUnmuteMessage(i);return void(yield xt(e,nt.RequestUnmuteLocal,o))}})()}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!(null===(e=this.connection)||void 0===e||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(nt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(nt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}requestReconnect(){var t=this;return y(function*(){t.dtlsFailedCount+=1,yield Me(x_(t.dtlsFailedCount,Se)),t.emit(nt.RequestReconnect)})()}reconnectP2P(){var t=this;return y(function*(){const e=Array.from(t.localTrackMap.entries()),n=t.createGatewayUnpublishMessage(e);Array.from(t.remoteUserMap.entries()),n.length>0&&(yield He(t,nt.RequestUnpublishForReconnectPC,n)),t.disconnectForReconnect(),t.emit(nt.RequestReconnectPC)})()}canPublishLowStream(){return this.localTrackMap.has(x.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof Kt)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof Kt).length>1)throw new P(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof ie).length>1&&(t.some(e=>e instanceof ie&&e._bypassWebAudio)||!St().webAudioMediaStreamDest))throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof Kt&&this.pendingLocalTracks.some(n=>n instanceof Kt))throw new P(v.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ie&&this.pendingLocalTracks.some(n=>n instanceof ie)&&(!St().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof ie&&n._bypassWebAudio)))throw new P(v.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){var n;const r=!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&St().supportDualStreamEncoding,i=di(di({},{width:160,height:120,framerate:15,bitrate:50}),e);let o;o=r?t._mediaStreamTrack.clone():ym(t,i);const s=Ft(8,"track-low-"),a=new Kt(o,di(di({},r&&{scaleResolutionDownBy:oE(i,t)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,s);return a.on(jo.TRANSCEIVER_UPDATED,c=>{t._updateRtpTransceiver(c,$s.LOW_STREAM)}),a._hints.push(Bt.LOW_STREAM),W(n=t._hints).call(n,Bt.SCREEN_TRACK)&&a._hints.push(Bt.SCREEN_LOW_TRACK),t.on("sei-to-send",c=>{a.emit("sei-to-send",c)}),t.addListener(Y.NEED_CLOSE,()=>{a.close()}),a}globalLock(){var t=this;return y(function*(){return t.mutex.lock("From P2PChannel.globalLock")})()}reportPCStats(t,e,n){var r=arguments,i=this;return y(function*(){let o=r.length>3&&void 0!==r[3]?r[3]:null;if(i.connection&&i.connection instanceof Wr){var s,a,c,d;const u=i.store.keyMetrics.descriptionStart||0,{iceConnectionState:l,dtlsTransportState:p,peerConnectionState:h}=i.connection,{local:S,remote:m}=yield i.connection.getSelectedCandidatePair();Q.pcStats(i.store.sessionId,{startTime:u,eventElapse:t-u||0,iceconnectionsate:l,dtlsstate:p,connectionstate:h,intSucc:e?1:2,error:o,selectedLocalCandidateProtocol:null!==(s=S?.protocol)&&void 0!==s?s:"",selectedLocalCandidateType:null!==(a=S.candidateType)&&void 0!==a?a:"",selectedLocalCandidateAddress:"".concat(S.address,":").concat(S.port),selectedRemoteCandidateProtocol:null!==(c=m.protocol)&&void 0!==c?c:"",selectedRemoteCandidateType:null!==(d=m.candidateType)&&void 0!==d?d:"",selectedRemoteCandidateAddress:"".concat(m.address,":").concat(m.port),restartCnt:n,preallocation:i.connection.isPreallocation})}})()}reportVideoFirstFrameDecoded(t,e,n,r){var i;const o=Array.from(kn(i=this.remoteUserMap).call(i)).find(s=>s._videoSSRC===t);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&"video"===c.type);Q.firstRemoteVideoDecode(this.store.sessionId,Ue.FIRST_VIDEO_DECODE,$t.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:n,subscribeElapse:Qe.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:r?1:0,firstFrame:a?.firstFrame||0})}}remoteMediaSsrcChanged(t,e,n){var r=this;return y(function*(){if(!r.connection)return!1;const i=r.remoteUserMap.get(t);if(!i)return!1;const o=i.get(e);if(!o)return!1;const s=yield r.connection.getRemoteSSRC(o);return void 0!==s&&s!==n})()}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:n}]=t;e===x.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,$s.LOW_STREAM):n._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(t){this.connection&&this.connection instanceof Wr&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this.reportPCStats(Date.now(),!1,this._pcStatsUploadType===yi.TCP_RESTART&&t===bn.RELAY?this._pcStatsUploadType:yi.DISCONNECTED_OR_FAILED)))}},z(ut.prototype,"startP2PConnection",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"startP2PConnection"),ut.prototype),z(ut.prototype,"connect",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"connect"),ut.prototype),z(ut.prototype,"updateRemoteRTPCapabilities",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"updateRemoteRTPCapabilities"),ut.prototype),z(ut.prototype,"publishDataChannel",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"publishDataChannel"),ut.prototype),z(ut.prototype,"unpublish",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"unpublish"),ut.prototype),z(ut.prototype,"unpublishDataChannel",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"unpublishDataChannel"),ut.prototype),z(ut.prototype,"unpublishLowStream",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"unpublishLowStream"),ut.prototype),z(ut.prototype,"subscribeDataChannel",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"subscribeDataChannel"),ut.prototype),z(ut.prototype,"subscribe",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"subscribe"),ut.prototype),z(ut.prototype,"massSubscribe",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"massSubscribe"),ut.prototype),z(ut.prototype,"unsubscribe",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"unsubscribe"),ut.prototype),z(ut.prototype,"unsubscribeDataChannel",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"unsubscribeDataChannel"),ut.prototype),z(ut.prototype,"massUnsubscribe",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"massUnsubscribe"),ut.prototype),z(ut.prototype,"muteRemote",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"muteRemote"),ut.prototype),z(ut.prototype,"unmuteRemote",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"unmuteRemote"),ut.prototype),z(ut.prototype,"hasRemoteMediaWithLock",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"hasRemoteMediaWithLock"),ut.prototype),z(ut.prototype,"disconnectForReconnect",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"disconnectForReconnect"),ut.prototype),z(ut.prototype,"updateBitrateLimit",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"updateBitrateLimit"),ut.prototype),z(ut.prototype,"remoteMediaSsrcChanged",[nn],Object.getOwnPropertyDescriptor(ut.prototype,"remoteMediaSsrcChanged"),ut.prototype),ut);function nn(t,e,n){const r=t[e];if("function"!=typeof r)throw new Error("Cannot use mutex on object property.");return n.value=y(function*(){const i=this.mutex,o=yield i.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return yield r.apply(this,a)}finally{o()}}),n}const YO={};function wc(t){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&_.debug("install service ".concat(t.name)),YO[t.name]=t}function Nc(t){const e=YO[t];if(!e)throw new P(v.INVALID_OPERATION,"".concat(t," not found, please use AgoraRTC.use(").concat(t,"Service) to load it first"));return e}function qO(t,e){return Nc("DataStream").create(t,e)}function zO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function JO(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?zO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):zO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const $3=Date.now(),tW=20,bm=new Map,gl=new Map;function XO(t){return Om.apply(this,arguments)}function Om(){return Om=y(function*(t){const e=bm.get(t),n=Array.isArray(e)&&e[e.length-1],r=gl.get(t);if(!n)return void(r.isSyncing=!1);const i={uid:n.uid,payload:n.payload};0===r.firstRecvTs&&(r.firstRecvTs=n.recvTs,r.firstSendTs=n.sendTs);const o=n.sendTs-r.firstSendTs,s=o-(Date.now()-r.firstRecvTs);s>0&&(r.firstRecvTs=Date.now()-o);let a=n.mediaDelay+s;a<=0?(e.pop(),QO(n.context,i),a=0):a=Math.min(a,tW),setTimeout(()=>e.length&&XO(t),a)}),Om.apply(this,arguments)}function QO(t,e){t.safeEmit(ht.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e)}const nW=Tt().name;function ZO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function $O(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ZO(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ZO(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const Ea="websdk_ng_cache_parameter",rW=A("MAX_PRELOAD_ASYNC_LENGTH"),iW=1e4,Xo=new Map,Qo=[];let wm=null,Nm=0,Dm=0;const Tl=new Map,oW=function(t,e){const n=[];let r=0;const i=function(){var o=y(function*(){const s=n.shift();s&&(yield s()),n.length>0&&r<e?i():r--});return function(){return o.apply(this,arguments)}}();return y(function*(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return new H(function(){var c=y(function*(d,u){n.push(y(function*(){try{const l=yield t(...s);d(l)}catch(l){u(l)}})),r<e&&(r++,i())});return function(d,u){return c.apply(this,arguments)}}())})}(t0,rW),Pm=hn.CancelToken.source();function t0(t,e,n,r,i,o){return Lm.apply(this,arguments)}function Lm(){return Lm=y(function*(t,e,n,r,i,o){try{if(!A("ENABLE_PRELOAD"))return;if(!St().supportWebCrypto)return void Qi(()=>{_.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!n&&null!==n)throw new P(v.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&ke(n,"token",1,2047),ke(t,"appid",1,2047),Pu(e),r&&Lu(r);const s=xs();_.debug("preload channel ".concat(e,", uid is ").concat(r));const a={appId:t,cname:e,token:n||t,uid:"string"!=typeof r?r:null,sid:s,proxyServer:i};let c,d;"string"==typeof r?(a.stringUid=r,[d,c]=yield H.all([D3(r,{sid:s,appId:t},Pm.token),Yb($O($O({},a),{},{token:n||t,uid:0}),Pm.token)]),a.uid=d.uid,c.gatewayInfo.uid=a.uid,c.gatewayInfo.res.uid=a.uid):(o&&(a.stringUid=o),c=yield Yb(a,Pm.token));const u={sid:s,appId:t,cname:e,token:n||t,uid:a.stringUid||r,intUid:a.uid||c.gatewayInfo.uid,stringUid:a.stringUid,ts:Date.now(),sua:d,ap:c};yield(l=y(function*(p){let h;try{p.uid&&n0({appId:p.appId,cname:p.cname,token:p.token,uid:p.uid,stringUid:p.stringUid});const S=s0(p),m=yield(g=y(function*(R,C){try{const b=yield window.crypto.subtle.importKey("raw",tC(C),"AES-GCM",!1,["encrypt"]),w=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},b,ko(window.btoa(JSON.stringify(R))));return Zi(new Uint8Array(w))}catch{return}}),function(R,C){return g.apply(this,arguments)})(p,p.token||p.appId);if(!m)return;h=o0(Ea);const f=h?JSON.parse(h):[];f.push({[S]:m}),f.length>A("AP_CACHE_NUM")&&f.shift(),Sl(Ea,JSON.stringify(f))}catch(S){_.warn("Error caching server parameters:",S.message),Sl(Ea,"")}var g}),function(p){return l.apply(this,arguments)})(u),Nm++}catch(s){throw Dm++,function(a){wm||(wm=window.setTimeout(()=>{let d="";Tl.forEach((u,l)=>{d+="".concat(l,": ").concat(u," ;")}),Q.reportApiInvoke(null,{name:ye.PRELOAD,options:{success:Nm,failed:Dm,err:d}}).onError(a),Nm=0,Dm=0,Tl.clear(),wm=null},iW));const c=Tl.get(a.code)||0;Tl.set(a.code,c+1)}(s),s}var l}),Lm.apply(this,arguments)}function e0(t){return km.apply(this,arguments)}function km(){return km=y(function*(t){try{if(A("AP_REQUEST_DETAIL"))return;const e=n0(t);if(!e||"disabled"!==t.cloudProxyServer)return;const n=yield(r=y(function*(i,o){try{const s=yield window.crypto.subtle.importKey("raw",tC(o),"AES-GCM",!1,["decrypt"]),a=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},s,ko(i));return JSON.parse(window.atob(Zi(new Uint8Array(a))))}catch{return}}),function(i,o){return r.apply(this,arguments)})(e,t.token||t.appId);if(!n||!function(r,i){return r.cname===i.cname&&r.appId===i.appId&&r.token===i.token&&(i.stringUid?r.stringUid===i.stringUid:"number"==typeof i.uid?r.uid===i.uid:r.uid==i.uid)}(n,t))return;if(n&&Date.now()-n.ts<A("AP_CACHE_LIFETIME"))return n}catch(e){_.warn("Error get preloadInfo",e.message)}var r}),km.apply(this,arguments)}function n0(t){let e;try{if(e=o0(Ea),!e)return;const n=JSON.parse(e),r=s0(t),i=function(s,a){for(let c=s.length-1;c>=0;c--)if(a(s[c]))return c;return-1}(n,s=>r in s);if(-1===i)return;const o=n.splice(i,1)[0];return Sl(Ea,JSON.stringify(n)),o[r]}catch(n){_.warn("Error delete preload info: ".concat(e),n.message),Sl(Ea,"")}}function Mm(t){if(t){let e=Xo.get(t);e&&(window.clearTimeout(e),e=null,Xo.delete(t)),W(Qo).call(Qo,t)||"disabled"!==t.cloudProxyServer||Qo.push(t)}if(Xo.size<A("AP_CACHE_NUM")&&Qo.length>0){const e=Qo.shift();Xo.set(e,window.setTimeout(y(function*(){const{appId:n,cname:r,token:i,stringUid:o,uid:s,proxyServer:a}=e;try{yield oW(n,r,i,s,a,o),Xo.has(e)&&Mm(e)}catch(c){_.warn("update preload failed",c.message),r0(e)}}),A("AP_UPDATE_INTERVAL")))}}function r0(t){const e=Qo.indexOf(t);-1!==e&&Qo.splice(e,1);let n=Xo.get(t);n&&(window.clearTimeout(n),n=null,Xo.delete(t),Mm())}function i0(t,e){const n=t.sua,r=t.ap;e&&n&&Q.reqUserAccount(t.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:e,uid:t.intUid,errorCode:null,extend:n.req}),Q.reportResourceTiming(t.ap.url,t.sid),Q.joinWebProxyAP(t.sid,{lts:r.requestTime,elapse:r.elapse,sucess:1,apServerAddr:r.url,turnServerAddrList:r.proxyInfo.addresses.map(i=>i.ip).join(","),eventType:"disabled",unilbsServerIds:[Ee.CHOOSE_SERVER,Ee.CLOUD_PROXY_FALLBACK].toString()}),Q.joinChooseServer(t.sid,{lts:r.requestTime,elapse:r.elapse,succ:!0,csAddr:r.url,opid:r.opid,serverList:r.gatewayInfo.gatewayAddrs.map(i=>i.address),ec:null,cid:r.gatewayInfo.cid.toString(),uid:r.gatewayInfo.uid.toString(),csIp:r.gatewayInfo.csIp,unilbsServerIds:[Ee.CHOOSE_SERVER].toString(),isHttp3:r.isHttp3})}function o0(t){return window.atob(window.localStorage.getItem(t)||"")}function Sl(t,e){window.localStorage.setItem(t,window.btoa(e))}function s0(t){let e="".concat(t.appId,"_").concat(t.cname);return"string"==typeof t.uid&&(e+="_s_".concat(t.uid)),"number"==typeof t.uid&&(e+="_".concat(t.uid)),t.token&&(e+="_".concat(t.token)),aC(e)}function cW(t,e){switch(e){case 0:for(;128&Ir(t););break;case 2:Um(t,Dc(t));break;case 5:Um(t,4);break;case 1:Um(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function ma(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let dW=[];function Um(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function uW(t){return t.offset>=t.limit}function Rl(t,e){let n=t.bytes,r=t.offset,i=t.limit,o=r+e;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),t.bytes=s}return t.offset=o,o>i&&(t.limit=o),r}function a0(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function c0(t,e){let n=Rl(t,e.length);t.bytes.set(e,n)}function d0(t,e){let n=a0(t,e),r=String.fromCharCode,i=t.bytes,o="\ufffd",s="";for(let a=0;a<e;a++){let c,d,u,l,p=i[a+n];128&p?192==(224&p)?a+1>=e?s+=o:(c=i[a+n+1],128!=(192&c)?s+=o:(l=(31&p)<<6|63&c,l<128?s+=o:(s+=r(l),a++))):224==(240&p)?a+2>=e?s+=o:(c=i[a+n+1],d=i[a+n+2],32896!=(49344&(c|d<<8))?s+=o:(l=(15&p)<<12|(63&c)<<6|63&d,l<2048||l>=55296&&l<=57343?s+=o:(s+=r(l),a+=2))):240==(248&p)?a+3>=e?s+=o:(c=i[a+n+1],d=i[a+n+2],u=i[a+n+3],8421504!=(12632256&(c|d<<8|u<<16))?s+=o:(l=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&u,l<65536||l>1114111?s+=o:(l-=65536,s+=r(55296+(l>>10),56320+(1023&l)),a+=3))):s+=o:s+=r(p)}return s}function po(t,e){let n=e.length,r=0;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),r+=a<128?1:a<2048?2:a<65536?3:4}ge(t,r);let i=Rl(t,r),o=t.bytes;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[i++]=a:(a<2048?o[i++]=a>>6&31|192:(a<65536?o[i++]=a>>12&15|224:(o[i++]=a>>18&7|240,o[i++]=a>>12&63|128),o[i++]=a>>6&63|128),o[i++]=63&a|128)}}function Ir(t){return t.bytes[a0(t,1)]}function u0(t,e){let n=Rl(t,1);t.bytes[n]=e}function Dc(t){let e,n=0,r=0;do{e=Ir(t),n<32&&(r|=(127&e)<<n),n+=7}while(128&e);return r}function ge(t,e){for(e>>>=0;e>=128;)u0(t,127&e|128),e>>>=7;u0(t,e)}function lW(t,e){let n,r=0,i=0,o=0;return n=Ir(t),r=127&n,128&n&&(n=Ir(t),r|=(127&n)<<7,128&n&&(n=Ir(t),r|=(127&n)<<14,128&n&&(n=Ir(t),r|=(127&n)<<21,128&n&&(n=Ir(t),i=127&n,128&n&&(n=Ir(t),i|=(127&n)<<7,128&n&&(n=Ir(t),i|=(127&n)<<14,128&n&&(n=Ir(t),i|=(127&n)<<21,128&n&&(n=Ir(t),o=127&n,128&n&&(n=Ir(t),o|=(127&n)<<7))))))))),{low:r|i<<28,high:i>>>4|o<<24,unsigned:e}}function ho(t,e){let n=e.low>>>0,r=(e.low>>>28|e.high<<4)>>>0,i=e.high>>>24,o=0===i?0===r?n<16384?n<128?1:2:n<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:i<128?9:10,s=Rl(t,o),a=t.bytes;switch(o){case 10:a[s+9]=i>>>7&1;case 9:a[s+8]=9!==o?128|i:127&i;case 8:a[s+7]=8!==o?r>>>21|128:r>>>21&127;case 7:a[s+6]=7!==o?r>>>14|128:r>>>14&127;case 6:a[s+5]=6!==o?r>>>7|128:r>>>7&127;case 5:a[s+4]=5!==o?128|r:127&r;case 4:a[s+3]=4!==o?n>>>21|128:n>>>21&127;case 3:a[s+2]=3!==o?n>>>14|128:n>>>14&127;case 2:a[s+1]=2!==o?n>>>7|128:n>>>7&127;case 1:a[s]=1!==o?128|n:127&n}}const l0={},p0={},vl=4294967296,h0=vl*vl,_0=h0/2,xm=m0(0,!0),E0=m0(0),pW=fa(0,-2147483648,!1),hW=fa(-1,2147483647,!1),_W=fa(-1,-1,!0);function m0(t,e){let n,r,i;return e?(i=0<=(t>>>=0)&&t<256)&&(r=p0[t],r)?r:(n=fa(t,0,!0),i&&(p0[t]=n),n):(i=-128<=(t|=0)&&t<128)&&(r=l0[t],r)?r:(n=fa(t,t<0?-1:0,!1),i&&(l0[t]=n),n)}function fa(t,e,n){return{low:0|t,high:0|e,unsigned:!!n}}function EW(t,e){if(isNaN(t))return e?xm:E0;if(e){if(t<0)return xm;if(t>=h0)return _W}else{if(t<=-_0)return pW;if(t+1>=_0)return hW}return t<0?e?xm:E0:fa(t%vl|0,t/vl|0,e)}function f0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}class Vm extends Zt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(Ur.CONNECTION_STATE_CHANGE,e,n)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var n;super(),T(this,"name","AgoraRTCImageModeration"),T(this,"_connectionState",nr.CONNECTING),T(this,"_sequence",0),T(this,"_moderationStartTime",void 0),T(this,"_workerConnection",void 0),T(this,"_workerMessageLengthLimit",void 0),T(this,"_qualityRatio",void 0),T(this,"_connectInfo",void 0),T(this,"_cancelTokenSource",hn.CancelToken.source()),T(this,"_retryConfig",void 0),T(this,"_moderationInterval",void 0),T(this,"_moderationTimer",null),T(this,"_moderationMode",1),T(this,"_quality",1),T(this,"_qualityTimer",null),T(this,"_ticket",void 0),T(this,"_moderationIntervalMinimum",void 0),T(this,"_uploadFailedNum",0),T(this,"_uploadNum",0),T(this,"_uploadTimer",null),T(this,"_extraInfo",void 0),T(this,"_vendor",""),T(this,"_encoder",new TextEncoder),T(this,"_moderationId",void 0),T(this,"inspectImage",()=>{if(this.connectionState!==nr.CONNECTED)throw new N(v.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===nr.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=Ft(5,"image-moderation-"),this._workerMessageLengthLimit=A("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=A("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(n=e.interval)&&void 0!==n?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=A("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new uc("worker-"+this._moderationId,Se),this.on(Ur.STATE_CHANGE,(r,i)=>{_.debug("[".concat(this._moderationId,"] Moderation operation :").concat(js[r]," ").concat(i||""))}),this.handleWorkerEvents()}init(e,n){var r=this;return y(function*(){r.emit(Ur.STATE_CHANGE,js.CONNECT_AP),r._connectInfo=e;const i=r._cancelTokenSource.token;return r._retryConfig=n,new H((o,s)=>{r.on(Ur.CONNECTION_STATE_CHANGE,(a,c)=>{a===nr.CONNECTED&&o()}),r.requestAP(e,i,n).then(a=>{r.connectWorker(a)}).catch(a=>{s(a)})})})()}updateConfig(e){var n;this._moderationInterval=null!==(n=e.interval)&&void 0!==n?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),_.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===nr.CONNECTED&&this.inspectImage()}requestAP(e,n,r){var i=this;return y(function*(){const o=A("WEBCS_DOMAIN").map(d=>"https://".concat(d,"/api/v1")),s=yield function(d,u,l,p){let{appId:h,areaCode:S,cname:m,sid:f,token:g,uid:R}=u;la++;const C="moderation_plugin",b={service_name:C,json_body:JSON.stringify({appId:h,areaCode:S,cname:m,command:"allocateEdge",requestId:la,seq:la,sid:f,appToken:g,ts:Date.now(),uid:R+""})};let w,D,V=d[0];return Mr(y(function*(){w=Date.now();const U=yield Fr(V,{data:b,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(D=Date.now()-w,0!==U.code){const $=new N(v.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+U.code,{retry:!0,responseTime:D});throw _.error($.toString()),$}const k=JSON.parse(U.json_body);if(200!==k.code){const $=new N(v.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(k.code,", reason: ").concat(k.reason),{code:k.code,responseTime:D});throw _.error($.toString()),$}if(!k.servers||!Array.isArray(k.servers)||0===k.servers.length){const $=new N(v.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:k.code,responseTime:D});throw _.error($.toString()),$}if(!k.servers.some($=>!!$.wss)){const $=new N(v.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:k.code,responseTime:D});throw _.error($.toString()),$}const Z=A("IMAGE_MODERATION_WORKER_HOST");return{addressList:k.servers.map($=>{let{address:Rt,wss:Nt}=$;if(Rt&&Nt)return"wss://".concat(Rt.replace(/\./g,"-"),".").concat(Z,":").concat(Nt,"/moderation")}).filter($=>!!$),workerToken:k.workerToken,vid:k.vid,ticket:k.appTicket,responseTime:D}}),(U,k)=>(Q.apworkerEvent(f,{success:!0,sc:200,serviceName:C,responseDetail:JSON.stringify(U.addressList),firstSuccess:0===k,responseTime:D,serverIp:d[k%d.length]}),!1),(U,k)=>(Q.apworkerEvent(f,{success:!1,sc:U.data&&U.data.code||200,serviceName:C,responseTime:D,serverIp:d[k%d.length]}),!!(U.code!==v.OPERATION_ABORTED&&U.code!==v.UNEXPECTED_RESPONSE||U.data&&U.data.retry)&&(V=d[(k+1)%d.length],!0)),p)}(o,e,n,r);i.emit(Ur.STATE_CHANGE,js.AP_CONNECTED);const{addressList:a,ticket:c}=s;return i._ticket=c,a})()}connectWorker(e){var n=this;return y(function*(){n.emit(Ur.STATE_CHANGE,js.CONNECT_WORKER),yield n._workerConnection.init(e,1e4)})()}handleWorkerEvents(){var e=this;this._workerConnection.on(ct.CONNECTED,y(function*(){e.emit(Ur.STATE_CHANGE,js.WORKER_CONNECTED,e._workerConnection.url),e.connectionState=nr.CONNECTED})),this._workerConnection.on(ct.CLOSED,()=>{this.connectionState=nr.CLOSED}),this._workerConnection.on(ct.FAILED,()=>{this.connectionState=nr.CLOSED}),this._workerConnection.on(ct.RECONNECTING,()=>{this.connectionState=this.connectionState===nr.CONNECTED?nr.RECONNECTING:nr.CONNECTING}),this._workerConnection.on(ct.ON_MESSAGE,function(){var n=y(function*(r){if(r.data instanceof ArrayBuffer){const i=function aW(t){return function(n){let r={};t:for(;!uW(n);){let i=Dc(n);switch(i>>>3){case 0:break t;case 1:r.code=Dc(n);break;case 2:r.msg=d0(n,Dc(n));break;case 3:r.requestId=d0(n,Dc(n));break;case 4:r.timestamp=lW(n,!1);break;default:cW(n,7&i)}}return r}({bytes:e=t,offset:0,limit:e.length});var e}(new Uint8Array(r.data));A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("[".concat(e._moderationId,"] Response message for worker of image moderation "),JSON.stringify(i)),e._uploadNum++,void 0===i.code||0===i.code||(e._uploadFailedNum++,_.error("[".concat(e._moderationId,"] Error response from worke, code is ").concat(i.code,", msg is ").concat(i.msg)),e._uploadTimer||(e._uploadTimer=window.setTimeout(()=>{Q.reportApiInvoke(e._connectInfo.sid||null,{name:ye.IMAGE_MODERATION_UPLOAD,options:[e._uploadFailedNum,e._uploadNum,i.code],tag:ne.TRACER}).onError(new N(v.IMAGE_MODERATION_UPLOAD_FAILED,i.msg)),e._uploadTimer=null},A("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else _.error("[".concat(e._moderationId,"] Unexpected message type from worker"))});return function(r){return n.apply(this,arguments)}}()),this._workerConnection.on(ct.WILL_RECONNECT,(n,r,i)=>{"recover"===n&&i(n),i("tryNext")}),this._workerConnection.on(ct.REQUEST_NEW_URLS,(n,r)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n).catch(r)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}requestToInspectImage(){var e=this;return y(function*(){const n=$n(e,Ur.CLIENT_LOCAL_VIDEO_TRACK),r={appId:e._connectInfo.appId,cname:e._connectInfo.cname,cid:e._connectInfo.cid,sid:e._connectInfo.sid,uid:e._connectInfo.uid,vid:e._connectInfo.vid};if(n){if(!n.isPlaying)return void(A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being played can be inspected"));e._sequence++;const i=yield e.generateRequestData(n,r);e._workerConnection.sendMessage(i,!0,!0)}else A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being published can be inspected")})()}generateRequestData(e,n){var r=this;return y(function*(){let{appId:i,cname:o,cid:s,vid:a,sid:c,uid:d}=n;const u=Date.now(),l=yield e.getCurrentFrameImage("image/jpeg",r.quality),p=yield jI(l,i,o),h=r._sequence+"-"+s+"-"+d+"-"+u+"-"+Ft(12,""),S={appId:i,cid:s,cname:o,deviceId:"",elapse:Vm.intToLong(Number(u-r._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:p,networkType:6,osType:7,requestId:h,sdkVersion:"4.22.2",sequence:r._sequence,sid:c,timestamp:EW(u),uid:d,vid:a,service:r._moderationMode,ticket:r._ticket,callbackData:r._extraInfo,vendorConfigs:r._vendor};void 0===r._extraInfo&&delete S.callbackData;const m=function sW(t){let e=function(){const n=dW.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(n,r){let i=n.appId;void 0!==i&&(ge(r,10),po(r,i));let o=n.cid;void 0!==o&&(ge(r,16),ge(r,o));let s=n.cname;void 0!==s&&(ge(r,26),po(r,s));let a=n.deviceId;void 0!==a&&(ge(r,34),po(r,a));let c=n.elapse;void 0!==c&&(ge(r,40),ho(r,c));let d=n.fileSize;void 0!==d&&(ge(r,48),ho(r,ma(d)));let u=n.height;void 0!==u&&(ge(r,56),ho(r,ma(u)));let l=n.jpg;void 0!==l&&(ge(r,66),ge(r,l.length),c0(r,l));let p=n.networkType;void 0!==p&&(ge(r,72),ho(r,ma(p)));let h=n.osType;void 0!==h&&(ge(r,80),ho(r,ma(h)));let S=n.requestId;void 0!==S&&(ge(r,90),po(r,S));let m=n.sdkVersion;void 0!==m&&(ge(r,98),po(r,m));let f=n.sequence;void 0!==f&&(ge(r,104),ho(r,ma(f)));let g=n.sid;void 0!==g&&(ge(r,114),po(r,g));let R=n.timestamp;void 0!==R&&(ge(r,120),ho(r,R));let C=n.uid;void 0!==C&&(ge(r,128),ge(r,C));let b=n.vid;void 0!==b&&(ge(r,136),ge(r,b));let w=n.width;void 0!==w&&(ge(r,144),ho(r,ma(w)));let D=n.service;void 0!==D&&(ge(r,152),ge(r,D));let V=n.callbackData;void 0!==V&&(ge(r,162),ge(r,V.length),c0(r,V));let U=n.ticket;void 0!==U&&(ge(r,170),po(r,U));let k=n.vendorConfigs;void 0!==k&&(ge(r,178),po(r,k))}(t,e),function(n){let r=n.bytes,i=n.limit;return r.length===i?r:r.subarray(0,i)}(e)}(S);if(m.byteLength<r._workerMessageLengthLimit){if(A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const f=function(g){for(var R=1;R<arguments.length;R++){var C=null!=arguments[R]?arguments[R]:{};R%2?f0(Object(C),!0).forEach(function(b){T(g,b,C[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(C)):f0(Object(C)).forEach(function(b){Object.defineProperty(g,b,Object.getOwnPropertyDescriptor(C,b))})}return g}({},S);delete f.jpg,_.debug("[".concat(r._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(f))}return m}return r.quality=r.quality*r._qualityRatio,yield r.generateRequestData(e,{appId:i,cname:o,cid:s,vid:a,sid:c,uid:d})})()}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=hn.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=nr.CLOSED,this.emit(Ur.STATE_CHANGE,js.CLOSED)}}function g0(t){if(Mt(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new N(v.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(t&&t.vendor&&t.vendor.length>1024)throw new N(v.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const mW={name:"ImageModeration",create:function(t){let{config:e}=t;return g0(e),new Vm(e)}};var T0,S0,R0,v0,y0,C0,I0,A0,b0,O0,w0,N0,D0,P0,L0,k0,M0,U0,x0,V0,F0,B0,j0,G0,W0,H0,K0,Y0,q0,z0,J0,X0,Q0,Z0,$0,tw,ew,nw,rw,iw,K;function ow(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Ar(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ow(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ow(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}Je.setLogger(_);let fW=(T0=et(),S0=et({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof ra))return[e];e=[e]}return e.map(n=>n?Object(n).toString():"null")}}),R0=et({argsMap:(t,e)=>(e||(e=[]),Array.isArray(e)||e.trackMediaType!==na.DATA?(Array.isArray(e)||(e=[e]),e.map(n=>n.getTrackId())):[e.getChannelId()])}),v0=et({argsMap:(t,e,n,r)=>["object"==typeof e?e.uid:e,n,r]}),y0=et({argsMap:(t,e,n)=>[e,n]}),C0=et({argsMap:(t,e)=>e.map(n=>{let{user:r,mediaType:i}=n;return[r?.uid,i]})}),I0=et({argsMap:(t,e,n,r)=>["object"==typeof e?e.uid:e,n,r]}),A0=et({argsMap:(t,e)=>e.map(n=>{let{user:r,mediaType:i}=n;return{uid:r?.uid,mediaType:i}})}),b0=et(),O0=et(),w0=et(),N0=et(),D0=et(),P0=et(),L0=et(),k0=et(),M0=et(),U0=et(),x0=et(),V0=et(),F0=et(),B0=et(),j0=et({argsMap:(t,e)=>[e]}),G0=et(),W0=et(),H0=et(),K0=et(),Y0=et(),q0=et(),z0=et(),J0=et(),X0=et({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),Q0=et(),Z0=et(),$0=et(),tw=et(),ew=et(),nw=et(),rw=et({reportResult:!0}),iw=et(),K=class extends Zt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return(null===(t=this._config)||void 0===t?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t,e){var n;let r;if(super(),n=this,T(this,"store",void 0),T(this,"_uid",void 0),T(this,"_channelName",void 0),T(this,"_uintUid",void 0),T(this,"_users",[]),T(this,"_config",void 0),T(this,"_clientId",void 0),T(this,"_appId",void 0),T(this,"_sessionId",null),T(this,"_key",void 0),T(this,"_rtmConfig",{}),T(this,"_joinInfo",void 0),T(this,"_gateway",void 0),T(this,"_statsCollector",void 0),T(this,"_configDistribute",void 0),T(this,"_leaveMutex",void 0),T(this,"_publishMutex",void 0),T(this,"_renewTokenMutex",void 0),T(this,"_subscribeMutex",void 0),T(this,"_encryptionMode","none"),T(this,"_encryptionSecret",null),T(this,"_encryptionSalt",null),T(this,"_encryptDataStream",!1),T(this,"_encryptDataStreamKey",null),T(this,"_encryptDataStreamIv",null),T(this,"_proxyServer",void 0),T(this,"_turnServer",{servers:[],mode:"auto"}),T(this,"_cloudProxyServerMode","disabled"),T(this,"_isDualStreamEnabled",!1),T(this,"_defaultStreamFallbackType",void 0),T(this,"_lowStreamParameter",void 0),T(this,"_streamFallbackTypeCacheMap",new Map),T(this,"_remoteStreamTypeCacheMap",new Map),T(this,"_axiosCancelSource",hn.CancelToken.source()),T(this,"_audioVolumeIndicationInterval",void 0),T(this,"_networkQualityInterval",void 0),T(this,"_userOfflineTimeout",void 0),T(this,"_streamRemovedTimeout",void 0),T(this,"_liveTranscodeStreamingClient",void 0),T(this,"_liveRawStreamingClient",void 0),T(this,"_channelMediaRelayClient",void 0),T(this,"_networkQualitySensitivity","normal"),T(this,"_p2pChannel",void 0),T(this,"_useLocalAccessPoint",!1),T(this,"_setLocalAPVersion",void 0),T(this,"_joinAndNotLeaveYet",!1),T(this,"_numberOfJoinCount",0),T(this,"_remoteDefaultVideoStreamType",void 0),T(this,"_inspect",void 0),T(this,"_moderation",void 0),T(this,"_license",void 0),T(this,"_pendingPublishedUsers",[]),T(this,"ntpAlignErrorCount",0),T(this,"remoteInboundOffset",0),T(this,"_handleLocalTrackEnable",(i,o,s)=>{this.publish(i,!1).then(o).catch(s)}),T(this,"_handleLocalTrackDisable",(i,o,s)=>{this.unpublish(i).then(o).catch(s)}),T(this,"_handleUserOnline",i=>{if(A("BLOCK_LOCAL_CLIENT")&&xo(i.uid,this.channelName))return void _.debug("[".concat(i.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof i.uid&&_.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const o=this._users.find(s=>s.uid===i.uid);if(o)o._trust_in_room_=!0,o._is_pre_created&&(o._is_pre_created=!1,this.safeEmit(ht.USER_JOINED,o));else{const s=new uo(i.uid,i.uint_id||i.uid);this._users.push(s),_.debug("[".concat(this._clientId,"] user online"),i.uid),this.safeEmit(ht.USER_JOINED,s)}}),T(this,"_handleUserOffline",i=>{if(A("BLOCK_LOCAL_CLIENT")&&xo(i.uid,this.channelName))return;const o=this._users.find(s=>s.uid===i.uid);o&&(this._handleRemoveStream(i),this._handleRemoveDataChannels(i),o._audio_pre_subscribed||o._video_pre_subscribed?o._is_pre_created=!0:Cu(this._users,o),this._remoteStreamTypeCacheMap.delete(o.uid),this._streamFallbackTypeCacheMap.delete(o.uid),_.debug("[".concat(this._clientId,"] user offline"),i.uid,"reason:",i.reason),this.safeEmit(ht.USER_LEAVED,o,i.reason))}),T(this,"_handleAddAudioOrVideoStream",(i,o,s,a,c,d,u)=>{if(A("BLOCK_LOCAL_CLIENT")&&xo(o,this.channelName))return;const l=this._users.find(h=>h.uid===o);if(!l)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(i)),this.store.subscribe(l.uid,i,void 0,void 0,void 0,Date.now());const p="audio"===i?l.hasAudio:l.hasVideo;l._uintid||(l._uintid=c||o),"audio"===i?l._trust_audio_stream_added_state_=!0:l._trust_video_stream_added_state_=!0,"audio"===i?(l._audio_added_=!0,void 0!==s&&(l._audioSSRC=s),void 0!==a&&(l._cname=a),d&&(l._audioOrtc=d)):(l._video_added_=!0,void 0!==s&&(l._videoSSRC=s),void 0!==a&&(l._cname=a),void 0!==u&&(l._rtxSsrcId=u),d&&(l._videoOrtc=d)),("audio"===i?l.hasAudio:l.hasVideo)&&!p&&(_.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published ").concat(i)),this.safeEmit(ht.USER_PUBLISHED,l,i)),"video"===i?Q.onGatewayStream(this._sessionId,Ue.ON_ADD_VIDEO_STREAM,$t.ON_ADD_VIDEO_STREAM,{peer:c||o,ssrc:l._videoSSRC}):Q.onGatewayStream(this._sessionId,Ue.ON_ADD_AUDIO_STREAM,$t.ON_ADD_AUDIO_STREAM,{peer:c||o,ssrc:l._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(l,i,s).then(h=>{if(h&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(l.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof fl))return this._p2pChannel.unsubscribe(l,i,!0).then(()=>this._subscribe(l,i,!0).catch(S=>{_.error("[".concat(this._clientId,"] resubscribe error"),S.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(l,i)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(l.uid," after reconnect.")),this._subscribe(l,i,!0).catch(h=>{_.error("[".concat(this._clientId,"] resubscribe error"),h.toString())}))}),T(this,"_handleRemoveStream",i=>{if(A("BLOCK_LOCAL_CLIENT")&&xo(i.uid,this.channelName))return;const o=this._users.find(a=>a.uid===i.uid);if(!o)return void _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));_.debug("[".concat(this._clientId,"] stream removed with uid ").concat(i.uid));let s=()=>{};o.hasAudio&&o.hasVideo?s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(ht.USER_UNPUBLISHED,o,"audio"),_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(ht.USER_UNPUBLISHED,o,"video")}:o.hasVideo?s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(ht.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(ht.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof fl&&this._p2pChannel.unsubscribe(o).then(a=>{if(a)return this._gateway.unsubscribe(a,o.uid)}),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),Q.onGatewayStream(this._sessionId,Ue.ON_REMOVE_STREAM,$t.ON_REMOVE_STREAM,{peer:i.uint_id||i.uid}),s()}),T(this,"_handleSetStreamLocalEnable",(i,o,s)=>{if(A("BLOCK_LOCAL_CLIENT")&&xo(o,this.channelName))return;const a=this._users.find(u=>u.uid===o);if(!a)return void _.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));_.debug("[".concat(this._clientId,"] local ").concat(i," ").concat(s?"enabled":"disabled"," with uid ").concat(o));const c="audio"===i?a.hasAudio:a.hasVideo;if("audio"===i){a._trust_audio_enabled_state_=!0;const u=a._audio_enabled_;if(a._audio_enabled_=s,a._audio_enabled_===u)return;{const l=a._audio_enabled_?"enable-local-audio":"disable-local-audio";_.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(o,", msg: ").concat(l)),this.safeEmit(ht.USER_INFO_UPDATED,o,l)}}else{a._trust_video_enabled_state_=!0;const u=a._video_enabled_;if(a._video_enabled_=s,a._video_enabled_===u)return;{const l=a._video_enabled_?"enable-local-video":"disable-local-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(l)),this.safeEmit(ht.USER_INFO_UPDATED,o,l)}}const d="audio"===i?a.hasAudio:a.hasVideo;return c!==d?!c&&d?(_.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(i)),void this.safeEmit(ht.USER_PUBLISHED,a,i)):("video"===i&&a._videoTrack&&a._videoTrack._destroy(),this._p2pChannel.muteRemote(a,i),_.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(i)),void this.safeEmit(ht.USER_UNPUBLISHED,a,i)):void 0}),T(this,"_handleMuteStream",(i,o,s)=>{if(A("BLOCK_LOCAL_CLIENT")&&xo(i,this.channelName))return;_.debug("[".concat(this._clientId,"] receive mute message"),i,o,s);const a=this._users.find(u=>u.uid===i);if(!a)return void _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(i));const c="audio"===o?a.hasAudio:a.hasVideo;if("audio"===o){a._trust_audio_mute_state_=!0;const u=a._audio_muted_;if(a._audio_muted_=s,a._audio_muted_===u)return;{const l=a._audio_muted_?"mute-audio":"unmute-audio";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(l)),this.safeEmit(ht.USER_INFO_UPDATED,i,l)}}else{a._trust_video_mute_state_=!0;const u=a._video_muted_;if(a._video_muted_=s,a._video_muted_===u)return;{const l=a._video_muted_?"mute-video":"unmute-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(l)),this.safeEmit(ht.USER_INFO_UPDATED,i,l)}}const d="audio"===o?a.hasAudio:a.hasVideo;if(c!==d){if(!c&&d)return("audio"===o?a._audioSSRC:a._videoSSRC)?(_.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(o)),void this.safeEmit(ht.USER_PUBLISHED,a,o)):void _.warning("[".concat(this._clientId,"] remote user ").concat(i," receive ").concat(o," unmute message  before add stream message, ").concat(o," SSRC doesn't exist yet."));"video"===o&&a._videoTrack&&!a._video_pre_subscribed&&a._videoTrack._destroy(),this._p2pChannel.muteRemote(a,o),_.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(o)),this.safeEmit(ht.USER_UNPUBLISHED,a,o)}}),T(this,"_handleP2PLost",function(){var i=y(function*(o){_.debug("[".concat(n._clientId,"] receive p2p lost"),o),parseInt(o.p2pid,10)===n.store.p2pId?yield n._p2pChannel.requestReconnect():_.warning("[".concat(n._clientId,"] P2PLost stream not found"),o)});return function(o){return i.apply(this,arguments)}}()),T(this,"_handleTokenWillExpire",()=>{_.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(ht.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),T(this,"_handleBeforeUnload",i=>{"beforeunload"===i.type&&void 0!==i.returnValue&&""!==i.returnValue||(this.leave(),_.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),T(this,"_handleUpdateNetworkQuality",()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(ht.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const i={downlinkNetworkQuality:0,uplinkNetworkQuality:0};i.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),i.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(ht.NETWORK_QUALITY,i)}),T(this,"_handleP2PAddAudioOrVideoStream",(i,o,s,a)=>{const c=this._users.find(u=>u.uid===o);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(i)),this.store.subscribe(c.uid,i,void 0,void 0,void 0,Date.now());const d="audio"===i?c.hasAudio:c.hasVideo;"audio"===i?c._trust_audio_stream_added_state_=!0:c._trust_video_stream_added_state_=!0,"audio"===i?(c._audio_added_=!0,void 0!==s&&(c._audioSSRC=s),void 0!==a&&(c._audioMid=a)):(c._video_added_=!0,void 0!==s&&(c._videoSSRC=s),void 0!==a&&(c._videoMid=a)),("audio"===i?c.hasAudio:c.hasVideo)&&!d&&(_.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published ").concat(i)),this.safeEmit(ht.USER_PUBLISHED,c,i)),this._p2pChannel.hasPendingRemoteMedia(c,i)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(c.uid," after reconnect.")),this._subscribe(c,i,!0).catch(u=>{_.error("[".concat(this._clientId,"] resubscribe error"),u.toString())}))}),this._config=t,this._clientId=e||Ft(5,"client-"),this.store=new JB(t.codec,t.audioCodec,t.mode,this._clientId),this._leaveMutex=new Je("client-leave",this._clientId),this._publishMutex=new Je("client-publish",this._clientId),this._renewTokenMutex=new Je("client-renewtoken",this._clientId),this._subscribeMutex=new Je("client-subscribe",this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),_.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(tr," build: ").concat(W_,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{Zy(t.clientRoleOptions),r=Object.assign({},t.clientRoleOptions)}catch(i){_.warning("[".concat(this._clientId,"] ").concat(i.toString()))}this._statsCollector=new Ic(this.store),this._statsCollector.onStatsException=(i,o,s)=>{_.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(i,", msg: ").concat(o,", uid: ").concat(s)),this.safeEmit(ht.EXCEPTION,{code:i,msg:o,uid:s})},this._statsCollector.onUploadPublishDuration=(i,o,s,a)=>{const c=this._users.find(d=>d.uid===i);c&&Q.peerPublishStatus(this._sessionId,{subscribeElapse:a,audioPublishDuration:o,videoPublishDuration:s,peer:c._uintid})},this.store.useP2P="p2p"===t.mode,this._gateway=new I3(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||Se,httpRetryConfig:t.httpRetryConfig||Se,forceWaitGatewayResponse:void 0===t.forceWaitGatewayResponse||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:r}),this._configDistribute=new M3(this._clientId),this.store.useP2P?(this._p2pChannel=new Dn(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new fl(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}joinMeta(t,e,n,r,i){var o=arguments,s=this;return y(function*(){let a=!(o.length>5&&void 0!==o[5])||o[5],c=o.length>6&&void 0!==o[6]&&o[6];Ut("JOIN_GATEWAY_USE_443PORT_ONLY",a),Ut("JOIN_GATEWAY_USE_DUAL_DOMAIN",c);const d=s._gateway.signal.websocket;return d instanceof nE&&(d.use443PortOnly=a,d.tryDoubleDomain=c),(u=y(function*(l,p,h){gu.get(l)||gu.set(l,[]),Tu.get(l)||Tu.set(l,p),Zr.get(l)||Zr.set(l,0);const S=gu.get(l),m=Tu.get(l);if(!S||!m)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Zr.get(l)===m){const b=nc();S.push(b),yield b.promise}Zr.set(l,Zr.get(l)+1);for(var f=arguments.length,g=new Array(f>3?f-3:0),R=3;R<f;R++)g[R-3]=arguments[R];const C=yield h(...g);return Zr.set(l,Zr.get(l)-1),Zr.get(l)===m-1&&S.length>0&&(S[0].resolve(),S.shift()),0===Zr.get(l)&&(gu.set(l,[]),Tu.set(l,0),Zr.set(l,0)),C}),function(l,p,h){return u.apply(this,arguments)})("client.join",A("JOIN_MAX_CONCURRENCY"),s.join.bind(s),t,e,n,r,i);var u})()}join(t,e,n,r,i){var o=this;return y(function*(){const s=++o._numberOfJoinCount;o.store.joinStart(),r&&(o.store.uid=r);const a="HTTPS"===(bu||bu||(bu=(window.location.protocol.split(":")[0]||"").toUpperCase(),bu)),c=uC()?window.isSecureContext:"Browser Not Support";(!uC()&&!a||!window.isSecureContext)&&_.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser"),"DISCONNECTED"===o.connectionState&&(o.store.avoidJoinStart=Math.round(Date.now()),_.debug("[".concat(o._clientId,"] set avoidJoinStart to ").concat(o.store.avoidJoinStart))),Q.setAppId(t);try{if(!n&&null!==n)throw new N(v.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&ke(n,"token",1,2047),ke(t,"appid",1,2047),Pu(e),r&&Lu(r),i&&ke(i,"optionalInfo",1,2047)}catch(f){throw Q.reportApiInvoke(xs(),{name:ye.JOIN,options:[t,e,n,r],states:{isHttps:a,isSecureContext:c},tag:ne.TRACER}).onError(f),f}if(o._leaveMutex.isLocked&&(_.debug("[".concat(o._clientId,"] join: waiting leave operation")),(yield o._leaveMutex.lock())(),_.debug("[".concat(o._clientId,"] join: continue"))),o._joinAndNotLeaveYet=!0,"DISCONNECTED"!==o.connectionState){const f=new N(v.INVALID_OPERATION,"[".concat(o._clientId,"] Client already in connecting/connected state"));throw Q.reportApiInvoke(xs(),{name:ye.JOIN,options:[t,e,n,r],states:{isHttps:a,isSecureContext:c},tag:ne.TRACER}).onError(f),f}o._gateway.state="CONNECTING";const d=yield e0({appId:t,cname:e,uid:r,stringUid:"string"==typeof r?r:void 0,token:n||t,cloudProxyServer:o._cloudProxyServerMode});if(!o._joinAndNotLeaveYet)throw new N(v.INVALID_OPERATION,"[".concat(o._clientId,"] Client already left"));const u=d?.sid||xs();_.info("[".concat(o._clientId,"] start join channel ").concat(e,", join number: ").concat(s)),o._sessionId||(o._sessionId=u,o.store.sessionId=o._sessionId);const l=Q.reportApiInvoke(u,{id:o._clientId,name:ye.JOIN,options:[t,e,n,r],states:{isHttps:a,isSecureContext:c},tag:ne.TRACER}),p=Ar(Ar(Ar({},o._rtmConfig),{},{clientId:o._clientId,appId:t,sid:o._sessionId,cname:e,uid:"string"!=typeof r?r:null,turnServer:o._turnServer,proxyServer:o._proxyServer,token:n||t,cloudProxyServer:o._cloudProxyServerMode,optionalInfo:i,license:o._license,useLocalAccessPoint:o._useLocalAccessPoint,preload:!!d},void 0!==o._remoteDefaultVideoStreamType&&{defaultVideoStream:o._remoteDefaultVideoStreamType}),{},{apRequestDetail:A("AP_REQUEST_DETAIL")||void 0});if(o._useLocalAccessPoint&&(p.setLocalAPVersion=o._setLocalAPVersion),"string"==typeof r&&(p.stringUid=r,o._uintUid?(p.uid=o._uintUid,o._uintUid=void 0):p.uid=0),"none"!==o._encryptionMode&&o._encryptionSecret){if(p.aesmode=o._encryptionMode,p.aespassword=yield(f=y(function*(g){const R=function(){const V=window.atob("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),U=new Uint8Array(new ArrayBuffer(V.length));for(let k=0;k<V.length;k+=1)U[k]=V.charCodeAt(k);return U}(),C=yield window.crypto.subtle.importKey("spki",R,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),b=L_(g),w=yield window.crypto.subtle.encrypt({name:"RSA-OAEP"},C,b);return function(D){let V="";for(let U=0;U<D.length;U+=1)V+=String.fromCharCode(D[U]);return window.btoa(V)}(new Uint8Array(w))}),function(g){return f.apply(this,arguments)})(o._encryptionSecret),!o._joinAndNotLeaveYet)throw new N(v.INVALID_OPERATION,"[".concat(o._clientId,"] Client already left"));o._encryptionSalt&&(p.aessalt=o._encryptionSalt)}var f,R;if(o._encryptDataStream&&("aes-128-gcm2"===o._encryptionMode||"aes-256-gcm2"===o._encryptionMode))if(o._encryptionSalt&&o._encryptionSecret)if(window.crypto.subtle){const f=new TextEncoder,g=A("USE_PURE_ENCRYPTION_MASTER_KEY")?f.encode(p.appId+o._encryptionSecret+o._encryptionSecret):f.encode(p.appId+p.cname+o._encryptionSecret);o._encryptDataStreamIv=yield(R=y(function*(C,b,w){const D=yield window.crypto.subtle.importKey("raw",b,"PBKDF2",!1,["deriveBits","deriveKey"]),V="aes-128-gcm2"===C?128:256,U=yield window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:1e3,hash:"SHA-256",salt:w},D,V+96);return new Uint8Array(U).subarray(V/8)}),function(C,b,w){return R.apply(this,arguments)})(o._encryptionMode,g,ko(o._encryptionSalt)),o._encryptDataStreamKey=yield function(){var R=y(function*(C,b,w){const D=yield window.crypto.subtle.importKey("raw",b,"PBKDF2",!1,["deriveBits","deriveKey"]),V="aes-128-gcm2"===C?128:256;return yield window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:1e3,hash:"SHA-256",salt:w},D,{name:"AES-GCM",length:V},!0,["encrypt","decrypt"])});return function(C,b,w){return R.apply(this,arguments)}}()(o._encryptionMode,g,ko(o._encryptionSalt))}else _.warning("[".concat(o._clientId,c?"] encrypt datastream must be running in a secure context, fallback to plain data stream":"] current browser do not support WebCrypto ,fallback to plain data stream")),o._encryptDataStream=!1;else o._encryptDataStream=!1,_.debug("[".concat(o._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));o._startSession(o._sessionId,{channel:e,appId:t,stringUid:p.stringUid});const h=o._sessionId;setTimeout(()=>{"CONNECTING"===o.connectionState&&h===o._sessionId&&Q.joinChannelTimeout(o._sessionId,5)},5e3);try{var S;let f;const g=p.cloudProxyServer;if(W(S=["proxy3","proxy4","proxy5"]).call(S,g)){const D=A("PROXY_SERVER_TYPE3");p.proxyServer=Array.isArray(D)?D[0]:D}if(Q.setProxyServer(p.proxyServer),_.setProxyServer(p.proxyServer),o.store.requestAPStart(),d){if(_.debug("[".concat(o._clientId,"] get serverInfo Success from Preload Cache ").concat(p.stringUid?", ".concat(p.stringUid," => ").concat(d.intUid):""," ")),p.stringUid&&!p.uid&&(p.uid=d.intUid),f={gatewayInfo:d.ap.gatewayInfo},A("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&"auto"===p.turnServer.mode)if(0===d.ap.proxyInfo.addresses.length)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const D=(yield VC(d.ap.proxyInfo,d.ap.gatewayInfo.uid)).map(V=>({turnServerURL:V.address,tcpport:V.tcpport||Ke.tcpport,udpport:V.udpport||Ke.udpport,username:V.username||Ke.username,password:V.password||Ke.password,forceturn:!1,security:!0}));p.turnServer={mode:"manual",servers:D}}i0(d,p.stringUid)}else{if(p.stringUid&&!p.uid){let D;[D,f]=yield H.all([Kb(p.stringUid,p,o._axiosCancelSource.token,o._config.httpRetryConfig||Se,o.store),Hb(p,o._axiosCancelSource.token,o._config.httpRetryConfig||Se,!0,o.store)]),_.debug("[".concat(o._clientId,"] getUserAccount Success ").concat(p.stringUid," => ").concat(D)),p.uid=D,f.gatewayInfo.uid=D,f.gatewayInfo.res.uid=D}else f=yield Hb(p,o._axiosCancelSource.token,o._config.httpRetryConfig||Se,!0,o.store);if(!o._joinAndNotLeaveYet)throw new N(v.INVALID_OPERATION,"[".concat(o._clientId,"] Client already left"))}o.store.requestAPEnd(),setTimeout(()=>{o._configDistribute.startGetConfigDistribute(p,o._axiosCancelSource.token),o._configDistribute.on(tE.UPDATE_BITRATE_LIMIT,D=>{o._p2pChannel.updateBitrateLimit(D)})},0),o._key=n||t;const R=f.gatewayInfo,C=p.uid?p.uid:R.uid;o._joinInfo=Ar(Ar({},p),{},{cid:R.cid,uid:C,vid:R.vid,apResponse:R.res,apGatewayAddress:R.apGatewayAddress,uni_lbs_ip:R.uni_lbs_ip,gatewayAddrs:R.gatewayAddrs}),o.store.intUid=C;const b=yield o._joinGateway();if(!o._joinAndNotLeaveYet)throw new N(v.INVALID_OPERATION,"[".concat(o._clientId,"] Client already left"));l.onSuccess(b),o._appId=t,o._channelName=p.cname,o._uid=b,o.store.uid=b,setTimeout(()=>{o._networkQualityInterval&&window.clearInterval(o._networkQualityInterval),o._networkQualityInterval=window.setInterval(o._handleUpdateNetworkQuality,2e3),window.addEventListener(Ge()?"beforeunload":"pagehide",o._handleBeforeUnload),o._statsCollector.startUpdateStats()},0);const w=p.stringUid?"string uid: ".concat(p.stringUid,",uid: ").concat(p.uid):"uid: ".concat(o._uid);return _.info("[".concat(o._clientId,"] Joining channel success: channel: ").concat(e,",").concat(w)),setTimeout(()=>{_.startUpload()},5e3),o.store.joinEnd(),m=o,W(Uo).call(Uo,m)||Uo.push(m),"disabled"===o._cloudProxyServerMode&&St().supportWebCrypto&&A("ENABLE_PRELOAD")&&Mm(o._joinInfo),b}catch(f){const g=Array.isArray(f)?f[0]:f;throw g&&g.code===v.OPERATION_ABORTED?_.warning("[".concat(o._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),g):_.error("[".concat(o._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),g),g.code!==v.OPERATION_ABORTED&&o._numberOfJoinCount===s&&(o._gateway.state="DISCONNECTED",o._reset()),l.onError(g),g}var m})()}_joinGateway(){if(!this._joinInfo||!this._key)throw new N(v.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!A("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}leave(){var t=this;return y(function*(){_.info("[".concat(t._clientId,"] Leaving channel")),window.removeEventListener(Ge()?"beforeunload":"pagehide",t._handleBeforeUnload),t._reset(),function(n){const r=Uo.indexOf(n);-1!==r&&Uo.splice(r,1)}(t),t._statsCollector.stopUpdateStats();const e=yield t._leaveMutex.lock();if("DISCONNECTED"===t.connectionState)return _.info("[".concat(t._clientId,"] Leaving channel repeated, success")),void e();yield t._gateway.leave("CONNECTED"!==t.connectionState),_.info("[".concat(t._clientId,"] Leaving channel success")),t._joinAndNotLeaveYet=!1,t.store.resetJoinChannelServiceRecords(),e()})()}publish(t){var e=arguments,n=this;return y(function*(){let r=!(e.length>1&&void 0!==e[1])||e[1];if(!Array.isArray(t)){if(!(t instanceof ra))return n._publishDataChannel(t);t=[t]}if(0===t.length)throw new N(v.INVALID_PARAMS,"param list is empty");const i=t;if("audience"===n._gateway.role)throw new N(v.INVALID_OPERATION,"audience can not publish stream");for(const s of i){if(!(s instanceof ra))throw new N(v.INVALID_PARAMS,"parameter is not local track");if(!s._enabled&&r)throw new N(v.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(s.getTrackId()))}_.info("[".concat(n._clientId,"] Publishing tracks, id ").concat(i.map(s=>"".concat(s.getTrackId()," "))));const o=yield n._publishMutex.lock();yield n._configDistribute.awaitConfigDistributeComplete(),r&&i.forEach(s=>{const a=n._configDistribute.getBitrateLimit();s instanceof Kt&&a&&s.setBitrateLimit(a.uplink)});try{yield n._publishHighStream(i),_.info("[".concat(n._clientId,"] Publish success, id ").concat(i.map(s=>"".concat(s.getTrackId()," "))))}catch(s){throw _.error("[".concat(n._clientId,"] publish error"),s.toString()),s}finally{o()}})()}_publishDataChannel(t){var e=this;return y(function*(){Mt(t.id,"id",0,65535,!0),Si(t.ordered,"ordered"),ke(t.metadata,"metadata",0,512),_.info("[".concat(e._clientId,"] Publishing datachannels, id ").concat(t.id));const n=yield e._publishMutex.lock();try{if(-1!==e._p2pChannel.getAllDataChannels().findIndex(o=>o.id===t.id))throw new N(v.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!e._joinInfo||void 0===e._uid)throw new N(v.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==e.connectionState&&"RECONNECTING"!==e.connectionState)throw new N(v.INVALID_OPERATION,"can not publish datachannel in ".concat(e.connectionState," state"));if("auto"===e._turnServer.mode&&A("FORCE_TURN")&&!A("TURN_ENABLE_TCP")&&!A("TURN_ENABLE_UDP"))throw new N(v.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const r=qO(o=t,!1),i=yield e._p2pChannel.publishDataChannel([r]);if(i.length>0){if("number"!=typeof r._originDataChannelId)throw _.error("[".concat(e._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new N(v.CREATE_DATACHANNEL_ERROR);try{yield H.all(i.map(o=>e._uid&&e._gateway.publishDataChannel(e._uid,o,!0))),yield r._waitTillOpen()}catch(o){if(o.code!==v.DISCONNECT_P2P)throw o}}return _.info("[".concat(e._clientId,"] Publish dataChannels success, id ").concat(r.id)),r}catch(r){throw _.error("[".concat(e._clientId,"] publish datachannels error"),r.toString()),r}finally{n()}var o})()}unpublish(t){var e=this;return y(function*(){if(!e._joinInfo||void 0===e._uid)throw new N(v.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let n=[];if(t)if(Array.isArray(t))n=t;else{if(!(t instanceof ra))return e._unpublishDataChannel([t]);n=[t]}else e.store.useP2P||(yield e._unpublishDataChannel()),n=e._p2pChannel.getAllTracks(!0);_.info("[".concat(e._clientId,"] Unpublish tracks, tracks ").concat(n.map(i=>"".concat(i.getTrackId()," "))," "));const r=yield e._publishMutex.lock();try{if(e._p2pChannel instanceof Dn){const i=yield e._p2pChannel.unpublish(n);i&&(yield e._gateway.sendExtensionMessage(de.UNPUBLISH,{unpubMsg:i},!0))}else{const i=yield e._p2pChannel.unpublish(n);i&&(yield e._gateway.unpublish(i,e._uid)),_.info("[".concat(e._clientId,"] Unpublish success,tracks ").concat(n.map(o=>"".concat(o.getTrackId()))))}}catch(i){throw _.error("[".concat(e._clientId,"] unpublish error"),i.toString()),i}finally{r&&r()}})()}_unpublishDataChannel(t){var e=this;return y(function*(){void 0!==t&&0!==t.length||(t=e._p2pChannel.getAllDataChannels()),_.info("[".concat(e._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(r=>"".concat(r.id," "))," "));const n=yield e._publishMutex.lock();try{const r=yield e._p2pChannel.unpublishDataChannel(t);r&&(yield e._gateway.unpublishDataChannel(r)),_.info("[".concat(e._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(i=>"".concat(i.id))))}catch(r){throw _.error("[".concat(e._clientId,"] unpublish dataChannel error"),r.toString()),r}finally{n&&n()}})()}subscribe(t,e,n){var r=this;return y(function*(){if(!(t instanceof uo)){const i=r.remoteUsers.find(o=>o.uid===t);if(!i)throw new N(v.INVALID_REMOTE_USER,"user is not in the channel");t=i}return"datachannel"===e?r._subscribeDataChannel(t,n):r._subscribe(t,e)})()}presubscribe(t,e){var n=this;return y(function*(){if(be(e,"mediaType",["audio","video"]),n._p2pChannel instanceof Dn)throw new N(v.INVALID_OPERATION,"can't presub at p2p mode");if(!n._joinInfo)throw new N(v.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==n.connectionState&&"RECONNECTING"!==n.connectionState)throw new N(v.INVALID_OPERATION,"can't presub in ".concat(n.connectionState," state"));const r=e===q.AUDIO,i=e===q.VIDEO,o=yield n._subscribeMutex.lock();try{const{ssrcId:s,ortc:a,rtxSsrcId:c,cname:d,uint_id:u}=yield n._gateway.presubscribe(t,e,!0);if(null==s)throw new N(v.UNEXPECTED_RESPONSE,"no ssrc id");let l=n._users.find(h=>h.uid===t);l||(l=new uo(t,u||t),l._is_pre_created=!0,n._users.push(l)),d&&(l._cname=d),l._uintid||(l._uintid=u||t),r&&(l._audioSSRC=s,l._audio_pre_subscribed=!0,a&&(l._audioOrtc=a)),i&&(l._videoSSRC=s,l._video_pre_subscribed=!0,a&&(l._videoOrtc=a),null!=c&&(l._rtxSsrcId=c)),_.info("[".concat(n._clientId,"] presub succeed ssrc: ").concat(s)),yield n._p2pChannel.subscribe(l,e,s,c,a);const p=r?l._audioTrack:l._videoTrack;if(!p)throw new N(v.UNEXPECTED_ERROR,"can not find remote track in user");return r&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),i&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),p}catch(s){throw _.error("[".concat(n._clientId,"] presub user ").concat(t," error"),s),s}finally{o()}})()}_subscribeDataChannel(t,e){var n=this;return y(function*(){var r;if(Mt(e,"channelId",0,65535,!0),!n._joinInfo)throw new N(v.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==n.connectionState&&"RECONNECTING"!==n.connectionState)throw new N(v.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(n.connectionState," state"));if(!n._users.find(c=>c===t))throw _.error("[".concat(n._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new N(v.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&0===t._dataChannels.length)throw _.error("[".concat(n._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new N(v.INVALID_REMOTE_USER,"user is not published");const o=null===(r=t._dataChannels)||void 0===r?void 0:r.find(c=>c.id===e);if(!o)throw _.error("[".concat(n._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new N(v.REMOTE_USER_IS_NOT_PUBLISHED);const s=yield n._subscribeMutex.lock();_.info("[".concat(n._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const c=yield n._p2pChannel.subscribeDataChannel(t,[o]);if(c&&W(c).call(c,o.id))try{var a;if("number"!=typeof o._originDataChannelId)throw _.error("[".concat(n._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new N(v.CREATE_DATACHANNEL_ERROR);const d={id:o.id,datachannelId:o._originDataChannelId,ordered:o.ordered,maxRetransmits:o.maxRetransmits,metadata:null!==(a=o.metadata)&&void 0!==a?a:""};yield n._gateway.subscribeDataChannel(t.uid,d,!0),yield o._waitTillOpen()}catch(d){if(d?.code!==v.WS_ABORT)throw yield n._p2pChannel.unsubscribeDataChannel(t,[o]),d;yield n._p2pChannel.unsubscribeDataChannel(t,[o]),n._p2pChannel.setPendingRemoteDataChannel(t,o.id)}return _.info("[".concat(n._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),o}finally{s()}})()}_p2pSubscribe(t,e,n){var r=this;return y(function*(){if(be(e,"mediaType",["audio","video"]),!r._joinInfo)throw new N(v.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==r.connectionState&&"RECONNECTING"!==r.connectionState)throw new N(v.INVALID_OPERATION,"Can't subscribe stream in ".concat(r.connectionState," state"));if(!r._users.find(s=>s===t)){const s=new N(v.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(r._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),s}if(!t.hasAudio&&!t.hasVideo){const s=new N(v.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(r._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),s}if(!n&&("audio"===e&&!t.hasAudio||"video"===e&&!t.hasVideo)){const s=new N(v.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(r._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),s}const o=yield r._subscribeMutex.lock();_.info("[".concat(r._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(yield r._p2pChannel.hasRemoteMediaWithLock(t,e))yield r._p2pChannel.unmuteRemote(t,e);else try{const a="audio"===e?t._audioSSRC:t._videoSSRC,c="audio"===e?t._audioMid:t._videoMid;r.store.subscribe(t.uid,e,Date.now()),r._p2pChannel instanceof Dn&&(yield r._p2pChannel.subscribe(t,e,a,c))}catch(a){throw a}_.info("[".concat(r._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),r._defaultStreamFallbackType&&r.setStreamFallbackOption(t.uid,r._defaultStreamFallbackType).catch(a=>{_.warning("[".concat(r._clientId,"] auto set fallback failed"),a)});const s="audio"===e?t._audioTrack:t._videoTrack;if(!s)throw new N(v.UNEXPECTED_ERROR,"can not find remote track in user object");return s}catch(s){throw _.error("[".concat(r._clientId,"] subscribe user ").concat(t.uid," error"),s),s}finally{o()}})()}_subscribe(t,e,n){var r=this;return y(function*(){if(r._p2pChannel instanceof Dn)return r._p2pSubscribe(t,e);if(be(e,"mediaType",["audio","video"]),!r._joinInfo)throw new N(v.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==r.connectionState&&"RECONNECTING"!==r.connectionState)throw new N(v.INVALID_OPERATION,"Can't subscribe stream in ".concat(r.connectionState," state"));if(!r._users.find(u=>u===t)){const u=new N(v.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(r._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),u}if(!t.hasAudio&&!t.hasVideo){const u=new N(v.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(r._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),u}if(!(n||("audio"!==e||t.hasAudio&&void 0!==t._audioSSRC)&&("video"!==e||t.hasVideo&&void 0!==t._videoSSRC))){const u=new N(v.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(r._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),u}let o="audio"===e?t._audioSSRC:t._videoSSRC,s="audio"===e?t._audioOrtc:t._videoOrtc,a="video"===e?t._rtxSsrcId:void 0,c={stream_type:"audio"===e?q.AUDIO:q.VIDEO,ssrcId:o};const d=yield r._subscribeMutex.lock();_.info("[".concat(r._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(yield r._p2pChannel.hasRemoteMediaWithLock(t,e))yield r._p2pChannel.unmuteRemote(t,e);else try{const l="audio"===e?t._audioSSRC:t._videoSSRC;void 0!==l&&l!==o&&(o=l,s="audio"===e?t._audioOrtc:t._videoOrtc,a="video"===e?t._rtxSsrcId:void 0,c={stream_type:"audio"===e?q.AUDIO:q.VIDEO,ssrcId:o}),Qe.markSubscribeStart(r.store.clientId,o),r.store.subscribe(t.uid,e,Date.now()),yield r._p2pChannel.subscribe(t,e,o,a,s);try{r._p2pChannel.isPreSubScribe(o)||(yield r._gateway.subscribe(t.uid,c,!0))}catch(p){if(p?.code!==v.WS_ABORT)throw yield r._p2pChannel.unsubscribe(t,e),p;yield r._p2pChannel.unsubscribe(t,e,!0),r._p2pChannel.setPendingRemoteMedia(t,e)}r.store.subscribe(t.uid,e,void 0,Date.now()),r._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(l){throw r._p2pChannel.reportSubscribeEvent(!1,l?.code,t,e),l}_.info("[".concat(r._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),r._defaultStreamFallbackType&&r.setStreamFallbackOption(t.uid,r._defaultStreamFallbackType).catch(l=>{_.warning("[".concat(r._clientId,"] auto set fallback failed"),l)});const u="audio"===e?t._audioTrack:t._videoTrack;if(!u)throw new N(v.UNEXPECTED_ERROR,"can not find remote track in user object");return u}catch(u){throw _.error("[".concat(r._clientId,"] subscribe user ").concat(t.uid," error"),u),u}finally{d()}})()}massSubscribe(t){var e=this;return y(function*(){if(Ri(t,"subscribeList"),!e._joinInfo)throw new N(v.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==e.connectionState&&"RECONNECTING"!==e.connectionState)throw new N(v.INVALID_OPERATION,"Can't subscribe stream in ".concat(e.connectionState," state"));const n=Date.now(),r=new Map,i=yield e._subscribeMutex.lock();_.info("[".concat(e._clientId,"]start massSubscribe user ").concat(t.map(c=>{let{user:d,mediaType:u}=c;return"user: ".concat(d?.uid,", mediaType: ").concat(u)}).join("; ")));const o=(t=[...t]).map(c=>{let{user:d,mediaType:u}=c;return{user:d,mediaType:u}}),s=yield e._p2pChannel.globalLock();try{var a;for(let d=t.length-1;d>=0;d--){const u=t[d],{user:l,mediaType:p}=u;if(be(p,"mediaType",["audio","video"]),!l){const f=new N(v.INVALID_PARAMS,"user property does not exist in subscribeList item");throw _.error("[".concat(e._clientId,"] user property does not exist in subscribeList item")),f}if(!e._users.find(f=>f===l)){const f=new N(v.INVALID_REMOTE_USER,"user is not in the channel");_.error("[".concat(e._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),o[d].error=f,t.splice(d,1);continue}if("audio"===p&&(!l.hasAudio||void 0===l._audioSSRC)||"video"===p&&(!l.hasVideo||void 0===l._videoSSRC)){const f=new N(v.REMOTE_USER_IS_NOT_PUBLISHED);_.error("[".concat(e._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(p,", remote user is not published")),o[d].error=f,t.splice(d,1);continue}const S=Ne.Video|Ne.LwoVideo,m=r.get(l);if(m){if("video"===p?m&S:m&Ne.Audio){t.splice(d,1),_.warning("[".concat(e._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(p," twice"));continue}r.set(l,m|("video"===p?S:Ne.Audio))}else r.set(l,"video"===p?S:Ne.Audio)}for(let d=t.length-1;d>=0;d--){const u=t[d],{user:l,mediaType:p}=u,h=Ne.Video|Ne.LwoVideo;if(e._p2pChannel.hasRemoteMedia(l,p)){yield e._p2pChannel.unmuteRemoteNoLock(l,p);const S=r.get(l);r.set(l,"video"===p?S^h:S^Ne.Audio),t.splice(d,1)}}e.store.massSubscribe(t.map(d=>({userId:d.user.uid,type:d.mediaType})),n);let c=Nr(a=Array.from(r.entries())).call(a,(d,u)=>{let[l,p]=u;if(0===p)return d;const h={stream_id:l.uid,stream_type:p};return p&Ne.Audio&&(h.audio_ssrc=l._audioSSRC),p&Ne.Video&&(h.video_ssrc=l._videoSSRC),d.push(h),d},[]);try{t.length>0&&(yield e._p2pChannel.massSubscribeNoLock(t.map(u=>{let{user:l,mediaType:p}=u;return{user:l,mediaType:p,ssrcId:p===q.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:p===q.VIDEO?l._rtxSsrcId:void 0}})));const d=new Map;if(c=c.filter(u=>u.video_ssrc&&!e._p2pChannel.isPreSubScribe(u.video_ssrc)||u.audio_ssrc&&!e._p2pChannel.isPreSubScribe(u.audio_ssrc)||!u.video_ssrc&&!u.audio_ssrc),c.length>0){const u=yield e._gateway.subscribeAll(c,!0);(u?.users||[]).forEach(l=>{let{stream_id:p,video_error_code:h,audio_error_code:S,error_code:m}=l;(h||S||m)&&d.set(p,{video_error_code:h,audio_error_code:S,error_code:m})})}if(Array.from(d.entries()).length>0){const u=[];Array.from(d.entries()).forEach(l=>{let[p,h]=l;const S=e.remoteUsers.find(m=>m.uid===p);if(S){let m;h.error_code||h.video_error_code&&h.audio_error_code?m=void 0:h.video_error_code?m=q.VIDEO:h.audio_error_code&&(m=q.AUDIO),u.push({user:S,mediaType:m})}}),u.length>0&&(yield e._p2pChannel.massUnsubscribeNoLock(u))}for(const u of o){const l=d.get(u.user.uid);if(l){const p=l.error_code||"audio"===u.mediaType&&l.audio_error_code||"video"===u.mediaType&&l.video_error_code;if(p){const h=dc(p);_.error("user:".concat(u.user.uid," mediaType:").concat(u.mediaType," has massSubscribe error ").concat(h.desc)),u.error=new N(v.SUBSCRIBE_FAILED,"code ".concat(p,": ").concat(h.desc))}}u.error||(u.track="video"===u.mediaType?u.user.videoTrack:u.user.audioTrack)}return e.store.massSubscribe(o.filter(u=>!u.error).map(u=>({userId:u.user.uid,type:u.mediaType})),void 0,Date.now()),o.forEach(u=>{var l;Q.subscribe(e.store.sessionId,{succ:!!u.error,ec:(null===(l=u.error)||void 0===l?void 0:l.code)||null,video:u.mediaType===q.VIDEO,audio:u.mediaType===q.AUDIO,peerid:u.user.uid,subscribeRequestid:u.mediaType===q.VIDEO?u.user._videoSSRC:u.user._audioSSRC,p2pid:e.store.p2pId,eventElapse:Math.floor(performance.now()-n),preSsrc:e._p2pChannel.isPreSubScribe(u.user._videoSSRC)},!0)}),_.info("[".concat(e._clientId,"] massSubscribe success ").concat(t.map(u=>{let{user:l,mediaType:p}=u;return"user: ".concat(l?.uid,", mediaType: ").concat(p)}).join("; "))),o}catch(d){throw yield e._p2pChannel.massUnsubscribeNoLock(t),d}}finally{s(),i()}})()}unsubscribe(t,e,n){var r=this;return y(function*(){if(!(t instanceof uo)){const s=r.remoteUsers.find(a=>a.uid===t);if(!s)throw new N(v.INVALID_REMOTE_USER,"user is not in the channel");t=s}if(e||r.store.useP2P){if("datachannel"===e)return r._unsubscribeDataChannel(t,n)}else yield r._unsubscribeDataChannel(t,n);if(e&&be(e,"mediaType",["audio","video"]),!r._joinInfo)throw new N(v.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!r._users.find(s=>s===t)){const s=new N(v.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(r._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),s}_.info("[".concat(r._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const o=yield r._subscribeMutex.lock();try{if(r._p2pChannel instanceof Dn)yield r._p2pChannel.unsubscribe(t,e);else{const s=yield r._p2pChannel.unsubscribe(t,e);s&&(yield r._gateway.unsubscribe(s,t.uid)),e&&"audio"!==e||(t._audio_pre_subscribed=!1),e&&"video"!==e||(t._video_pre_subscribed=!1),t._is_pre_created&&Cu(r._users,t),_.info("[".concat(r._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(s){if(s.code===v.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(r._clientId,"] unsubscribe user ").concat(t.uid," error"),s.toString()),s}finally{o()}})()}_unsubscribeDataChannel(t,e){var n=this;return y(function*(){if(e&&Mt(e,"id",0,65535,!0),!n._joinInfo)throw new N(v.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!n._users.find(o=>o===t)){const o=new N(v.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(n._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),o}let i;if("number"==typeof e){const o=t._dataChannels.find(s=>s.id===e);o&&(i=[o])}else i=t._dataChannels;if(void 0===i){const o=new N(v.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(n._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),o}_.info("[".concat(n._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i.map(o=>o.id)));try{const o=yield n._p2pChannel.unsubscribeDataChannel(t,i);o&&(yield n._gateway.unsubscribeDataChannel(o,t.uid)),_.info("[".concat(n._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(o))}catch(o){if(o.code===v.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(n._clientId,"] unsubscribe user ").concat(t.uid," error"),o.toString()),o}})()}massUnsubscribe(t){var e=this;return y(function*(){if(Ri(t,"unsubscribeList"),!e._joinInfo)throw new N(v.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");_.info("[".concat(e._clientId,"] start massUnsubscribe ").concat(t.map(r=>{let{user:i,mediaType:o}=r;return"user: ".concat(i?.uid,", mediaType: ").concat(o,";")}).join())),t=[...t];const n=new Map;for(let r=t.length-1;r>=0;r--){const{user:i,mediaType:o}=t[r];if(!i){const c=new N(v.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw _.error("[".concat(e._clientId,"] user property does not exist in unsubscribeList item")),c}if(be(o,"mediaType",["video","audio",void 0]),!e._users.find(c=>c===i)){_.warning("[".concat(e._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),t.splice(r,1);continue}const a=Ne.Video|Ne.LwoVideo;if(n.has(i)){const c=n.get(i);let d;switch(o){case"video":d=c&a;break;case"audio":d=c&Ne.Audio;break;default:d=c&(Ne.Audio|a)}if(d){_.warning("[".concat(e._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(o," twice.")),t.splice(r,1);continue}o?"audio"===o?n.set(i,c|Ne.Audio):"video"===o&&n.set(i,c|a):n.set(i,c|Ne.Audio|a)}else o?"audio"===o?n.set(i,Ne.Audio):"video"===o&&n.set(i,a):n.set(i,Ne.Audio|a)}try{const r=yield e._p2pChannel.massUnsubscribe(t);r&&(yield e._gateway.massUnsubscribe(r)),_.info("[".concat(e._clientId,"] massUnsubscribe success ").concat(t.map(i=>{let{user:o,mediaType:s}=i;return"user: ".concat(o?.uid,", mediaType: ").concat(s,";")}).join()))}catch(r){if(r.code===v.DISCONNECT_P2P)return void _.warning("[".concat(e._clientId,"] disconnecting p2p, abort unsubscribe request."));throw _.error("[".concat(e._clientId,"] massUnsubscribe error"),r.toString()),r}})()}setLowStreamParameter(t){var e=this;return y(function*(){(function(r){if(!r)throw new P(v.INVALID_PARAMS);Qt(r.width)||D_(r.width,"streamParameter.width"),Qt(r.height)||D_(r.height,"streamParameter.height"),Qt(r.framerate)||D_(r.framerate,"streamParameter.framerate"),Qt(r.bitrate)||Mt(r.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&_.warning("[".concat(e._clientId,"] The width and height parameters take effect only when both are set")),_.info("[".concat(e._clientId,"] set low stream parameter to"),JSON.stringify(t));const n=e._configDistribute.getLowStreamConfigDistribute();if(n&&n.bitrate&&t.bitrate&&n.bitrate<t.bitrate&&(t.bitrate=n.bitrate),e._lowStreamParameter=t,e._isDualStreamEnabled)return e._p2pChannel.updateVideoStreamParameter(t,x.LocalVideoLowTrack)})()}enableDualStream(){var t=this;return y(function*(){if(!St().supportDualStream)throw Q.streamSwitch(t._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new N(v.NOT_SUPPORTED,"Your browser is not support dual stream");if(t._isDualStreamEnabled)throw new N(v.INVALID_OPERATION,"Dual stream is already enabled");if(t._p2pChannel.canPublishLowStream())try{yield t._publishLowStream()}catch(e){throw Q.streamSwitch(t._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}t._isDualStreamEnabled=!0,Q.streamSwitch(t._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),_.info("[".concat(t._clientId,"] enable dual stream"))})()}disableDualStream(){var t=this;return y(function*(){if(t._isDualStreamEnabled){if(!t._joinInfo)throw new N(v.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(t._p2pChannel.getLocalMedia(x.LocalVideoLowTrack))try{const e=yield t._p2pChannel.unpublishLowStream();e&&(yield t._gateway.unpublish(e,t._joinInfo.stringUid||t._joinInfo.uid))}catch(e){throw Q.streamSwitch(t._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}t._isDualStreamEnabled=!1,Q.streamSwitch(t._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),_.info("[".concat(t._clientId,"] disable dual stream"))}})()}setClientRole(t,e){var n=this;return y(function*(){if(be(t,"role",["audience","host"]),e&&Zy(e),"rtc"===n.mode||"p2p"===n.mode)throw _.warning("[".concat(n._clientId,"]").concat(n.mode," mode can not use setClientRole")),new N(v.INVALID_OPERATION,"".concat(n.mode," mode can not use setClientRole"));if(e&&e.level&&"host"===t)throw new N(v.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===t&&n._p2pChannel.hasLocalMedia())throw new N(v.INVALID_OPERATION,"can not set client role to audience when publishing stream");yield n._gateway.setClientRole(t,e),n._config.role=t,_.info("[".concat(n._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))})()}getRemoteInboundOffset(){var t;const e=null===(t=this._p2pChannel.getStats())||void 0===t?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;const n=e.timestamp-Date.now();return Math.abs(n)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(ke(t,"proxyServer"),!e){if("DISCONNECTED"!==this.connectionState)throw new N(v.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new N(v.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,Q.setProxyServer(this._proxyServer),_.setProxyServer(this._proxyServer),_.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if("DISCONNECTED"!==this.connectionState)throw new N(v.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new N(v.INVALID_OPERATION,"You have already set the proxy")}if(yu(t))return this._turnServer={servers:t,mode:"original-manual"},void _.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(n=>n.urls).join(","),"."));t.forEach(n=>Qy(n)),this._turnServer={servers:t,mode:"manual"},_.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if("DISCONNECTED"!==this.connectionState)throw new N(v.INVALID_OPERATION,"you should set license before join channel");if(ke(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new N(v.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,_.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if("DISCONNECTED"!==this.connectionState)throw new N(v.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new N(v.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let n;switch(void 0===t&&(t=3),t){case 1:case 2:throw new N(v.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new N(v.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new N(v.INVALID_OPERATION,"Stop proxy server after leave channel");Q.setProxyServer(),_.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new N(v.INVALID_PARAMS,"accessPoints is required.");Ri(t.accessPoints.serverList,"accessPoints.serverList"),ke(t.accessPoints.domain,"accessPoints.domain");const e=(p,h)=>{Mt(p,h,0,65535,!0)};let n=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),n=t.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new N(v.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");A("CLOSE_AFB_FOR_LOCAL_AP")&&(Ut("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Ut("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const r=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,i=t.accessPoints.domain,o=t.accessPoints.serverList.map(p=>r.test(p)?"".concat(p.replace(/\./g,"-"),".").concat(i):p),s=o.map(p=>"".concat(p,":").concat(n));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Ut("WEBCS_DOMAIN",s),Ut("WEBCS_DOMAIN_BACKUP_LIST",s),Ut("GATEWAY_DOMAINS",[i]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(Ri(t.report.hostname,"report.hostname"),Ut("EVENT_REPORT_DOMAIN",t.report.hostname[0]),Ut("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(Ut("EVENT_REPORT_DOMAIN",o[0]),Ut("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),Ut("STATS_COLLECTOR_PORT",a),Ut("ENABLE_EVENT_REPORT",!!t.report);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(Ri(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=o[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),Ut("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let u=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(Ri(t.cds.hostname,"cds.hostname"),u=t.cds.hostname):u=o;let l=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),l=t.cds.port),Ut("CDS_AP",u.map(p=>"".concat(p,":").concat(l))),Ut("ENABLE_CONFIG_DISTRIBUTE",!!t.cds),_.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(Ri(t,"serverList"),ke(e,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new N(v.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(r=>n.test(r)?"".concat(r.replace(/\./g,"-"),".").concat(e):r),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Ut("WEBCS_DOMAIN",t),Ut("WEBCS_DOMAIN_BACKUP_LIST",t),Ut("GATEWAY_DOMAINS",[e]),Ut("EVENT_REPORT_DOMAIN",t[0]),Ut("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),Ut("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),_.info("[".concat(this._clientId,"] set local access point success"))}setRemoteDefaultVideoStreamType(t){var e=this;return y(function*(){if(be(t,"streamType",[0,1,4,5,6,7,8,9]),e._remoteDefaultVideoStreamType=t,e._joinInfo)try{yield e._gateway.setDefaultRemoteVideoStreamType(t),e._joinInfo.defaultVideoStream=e._remoteDefaultVideoStreamType}catch(n){throw _.error("[".concat(e._clientId,"] set default remote video stream type error"),n.toString()),n}else _.debug("[".concat(e._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))})()}setRemoteVideoStreamType(t,e){var n=this;return y(function*(){be(e,"streamType",[0,1,4,5,6,7,8,9]);try{yield n._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{const r=n._users.find(i=>i.uid===t);r&&r.videoTrack&&r.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(r){throw _.error("[".concat(n._clientId,"] set remote video stream type error"),r.toString()),r}_.info("[".concat(n._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),n._remoteStreamTypeCacheMap.set(t,e)})()}setStreamFallbackOption(t,e){var n=this;return y(function*(){be(e,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{yield n._gateway.setStreamFallbackOption(t,e)}catch(r){throw _.error("[".concat(n._clientId,"] set stream fallback option"),r.toString()),r}_.info("[".concat(n._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),n._streamFallbackTypeCacheMap.set(t,e)})()}setEncryptionConfig(t,e,n,r){be(t,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"]),ke(e,"secret");const i=["aes-128-gcm2","aes-256-gcm2"];if(W(i).call(i,t)){if(!n||!(n instanceof Uint8Array&&32===n.length))throw new N(v.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new N(v.INVALID_PARAMS,"current encrypt mode does not need salt");if(r){if(Si(r,"encryptDataStream"),!W(i).call(i,t))throw new N(v.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(e)||_.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=t,this._encryptionSecret=e,n&&(this._encryptionSalt=Zi(n))}renewToken(t){var e=this;return y(function*(){if(ke(t,"token",1,2047),!e._key||!e._joinInfo)throw new N(v.INVALID_OPERATION,"renewToken should not be called before user join");const n=e._key;e._key=t,e._joinInfo&&(e._joinInfo.token=t);const r=yield e._renewTokenMutex.lock();try{if(A("USE_NEW_TOKEN")){_.debug("[".concat(e._clientId,"] start renew token with ticket from unilbs"));const i=yield function k3(t,e,n){return fm.apply(this,arguments)}(e._joinInfo,e._axiosCancelSource.token,e._config.httpRetryConfig||Se);_.debug("[".concat(e._clientId,"] get ticket from unilbs success")),yield e._gateway.renewToken({token:t,ticket:i})}else _.debug("[".concat(e._clientId,"] start renew token without ticket")),yield e._gateway.renewToken({token:t});_.debug("[".concat(e._clientId,"] renewToken success"))}catch(i){throw e._key=n,e._joinInfo.token=n,_.error("[".concat(e._clientId,"] renewToken failed"),i.toString()),i}finally{r()}})()}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?_.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(ht.VOLUME_INDICATOR,t)},A("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}startLiveStreaming(t,e){var n=this;return y(function*(){if(!e){if("h264"!==n.codec)throw new N(v.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!n._p2pChannel.hasLocalMedia())throw new N(v.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(n._liveRawStreamingClient&&n._liveRawStreamingClient.hasUrl(t)||n._liveTranscodeStreamingClient&&n._liveTranscodeStreamingClient.hasUrl(t))throw new N(v.LIVE_STREAMING_TASK_CONFLICT);const r=e?ti.TRANSCODE:ti.RAW;return n._createLiveStreamingClient(r).startLiveStreamingTask(t,r)})()}setLiveTranscoding(t){return this._createLiveStreamingClient(ti.TRANSCODE).setTranscodingConfig(t)}stopLiveStreaming(t){var e=this;return y(function*(){const n=[e._liveRawStreamingClient,e._liveTranscodeStreamingClient].filter(r=>r&&r.hasUrl(t));if(!n.length)throw new N(v.INVALID_PARAMS,"can not find live streaming url to stop");yield H.all(n.map(r=>r&&r.stopLiveStreamingTask(t)))})()}startChannelMediaRelay(t){var e=this;return y(function*(){PO(t),yield e._createChannelMediaRelayClient().startChannelMediaRelay(t)})()}updateChannelMediaRelay(t){var e=this;return y(function*(){PO(t),yield e._createChannelMediaRelayClient().updateChannelMediaRelay(t)})()}stopChannelMediaRelay(){var t=this;return y(function*(){yield t._createChannelMediaRelayClient().stopChannelMediaRelay(),t._statsCollector.onStatsChanged&&(t._statsCollector.onStatsChanged=void 0)})()}sendStreamMessage(t){var e=arguments,n=this;return y(function*(){var r;let i=!(e.length>1&&void 0!==e[1])||e[1];if(!n._joinInfo)throw new N(v.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof t||t instanceof Uint8Array)&&(t={payload:t}),"string"==typeof t.payload){const s=new TextEncoder;t.payload=s.encode(t.payload)}let o=!1;if(n._encryptDataStream&&n._encryptDataStreamIv&&n._encryptDataStreamKey&&window.crypto.subtle&&W(r=["aes-128-gcm2","aes-256-gcm2"]).call(r,n._encryptionMode)&&(o=!0,t.payload=yield(s=y(function*(a,c,d){var u;const l=Nr(u=Array.from(d)).call(u,(R,C)=>R+C,0),p={serverTs:0,seq:QB++,length:d.length,checkSum:l},h=new Uint8Array(sC(l,2)),S=new ArrayBuffer(10),m=new DataView(S);m.setUint32(0,p.serverTs),m.setUint16(4,p.seq),m.setUint16(6,p.length),m.setUint16(8,p.checkSum),d=eC(d,new Uint8Array(16-d.length%16));const g=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:a,tagLength:128,additionalData:h},c,d);return eC(new Uint8Array(S),new Uint8Array(g))}),function(a,c,d){return s.apply(this,arguments)})(n._encryptDataStreamIv,n._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new N(v.INVALID_PARAMS,o?"encrypted stream message out of range.":"stream message out of range.");var s;return n._gateway.signal.request(it.DATA_STREAM,{payload:Zi(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-$3},!i)})()}sendMetadata(t){if(!this._joinInfo)throw new N(v.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new N(v.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(it.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Zi(t)})}sendCustomReportMessage(t){var e=this;return y(function*(){if(Array.isArray(t)||(t=[t]),t.forEach($B),!e._joinInfo)throw new N(v.INVALID_OPERATION,"can not send custom report, not joined");yield Q.sendCustomReportMessage(e._joinInfo.sid,t)})()}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}pickSVCLayer(t,e){var n=this;return y(function*(){be(e.spatialLayer,"spatialLayer",[0,1,2,3]),be(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{yield n._gateway.pickSVCLayer(t,e)}catch(r){throw _.error("[".concat(n._clientId,"] pick SVC layer failed"),r.toString()),r}})()}setRTMConfig(t){var e=this;return y(function*(){const{apRTM:n=!1,rtmFlag:r}=t;if(Si(n,"apRTM"),Mt(r,"rtmFlag",0),e._rtmConfig.apRTM=n,e._rtmConfig.rtmFlag=r,_.debug("[".concat(e._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(e.connectionState," state")),("CONNECTED"===e.connectionState||"RECONNECTING"===e.connectionState)&&e._joinInfo)return e._joinInfo.apRTM=n,e._joinInfo.rtmFlag=r,e._gateway.setRTM2Flag(r)})()}_reset(){if(_.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=hn.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&r0(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&Q.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Je("client-publish",this._clientId),this._subscribeMutex=new Je("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var n;const r=t||xs();_.debug(t?"[".concat(this._clientId,"] new Session ").concat(r):"[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(r));const i=t?"":this._sessionId||"";this._sessionId=r,this.store.sessionId=r,Q.addSid(r);const o={lts:(new Date).getTime(),mode:this.mode,buildFormat:1,stringUid:e?.stringUid||(null===(n=this._joinInfo)||void 0===n?void 0:n.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:i,clientRole:"audience"===this.role?2:1};Q.sessionInit(this._sessionId,Ar({cname:e.channel,appid:e.appId},o)),this._joinInfo&&(this._joinInfo.sid=r),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=r)}_publishHighStream(t){var e=this;return y(function*(){if(!e._joinInfo||void 0===e._uid)throw new N(v.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==e.connectionState&&"RECONNECTING"!==e.connectionState)throw new N(v.INVALID_OPERATION,"can not publish stream in ".concat(e.connectionState," state"));if("auto"===e._turnServer.mode&&A("FORCE_TURN")&&!A("TURN_ENABLE_TCP")&&!A("TURN_ENABLE_UDP"))throw new N(v.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");_.debug("[".concat(e._clientId,"] publish high stream"));try{const r=yield e._p2pChannel.publish(t,e._isDualStreamEnabled,e._lowStreamParameter);if(e._p2pChannel instanceof Dn){const i=(yield r.next()).value;if(i){try{yield e._gateway.sendExtensionMessage(de.PUBLISH,i,!0)}catch(o){throw r.throw(o),o}yield r.next()}e._p2pChannel.reportPublishEvent(!0,null)}else{const i=(yield r.next()).value;if(i){var n;let o;try{o=yield e._gateway.publish(e._uid,i,!0)}catch(s){if(s.code!==v.DISCONNECT_P2P)throw r.throw(s),s}yield r.next((null===(n=o)||void 0===n?void 0:n.ortc)||[])}e._p2pChannel.reportPublishEvent(!0,null);for(const o of t)o instanceof Kt&&o._encoderConfig&&e._gateway.setVideoProfile(o._encoderConfig),!o.muted&&o.enabled||(yield e._p2pChannel.muteLocalTrack(o))}}catch(r){if(e._p2pChannel.reportPublishEvent(!1,r?.code,t),r?.code===v.WS_ABORT)return;throw r}})()}_publishLowStream(){var t=this;return y(function*(){if(!t._joinInfo||void 0===t._uid)throw new N(v.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==t.connectionState&&"RECONNECTING"!==t.connectionState)throw new N(v.INVALID_OPERATION,"can not publish stream in ".concat(t.connectionState," state"));_.debug("[".concat(t._clientId,"] publish low stream"));const e=t._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(t._lowStreamParameter||(t._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),t._lowStreamParameter&&t._lowStreamParameter.bitrate&&e.bitrate<t._lowStreamParameter.bitrate&&(t._lowStreamParameter.bitrate=e.bitrate));try{const r=yield t._p2pChannel.publishLowStream(t._lowStreamParameter),i=(yield r.next()).value;if(i){var n;let o;try{o=yield t._gateway.publish(t._uid,i,!0)}catch(s){if(s.code!==v.DISCONNECT_P2P)throw r.throw(s),s}r.next((null===(n=o)||void 0===n?void 0:n.ortc)||[]),t._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(r){if(t._p2pChannel.reportPublishEvent(!1,r?.code,void 0,!0),r?.code===v.WS_ABORT)return;throw r}})()}_createLiveStreamingClient(t){const e=()=>{if(!this._joinInfo||!this._appId)return new N(v.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const n=(r={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},Nc("LiveStreaming").create(r));var r;return n.onLiveStreamError=(i,o)=>{Q.reportApiInvoke(this._sessionId,{name:ye.ON_LIVE_STREAM_ERROR,options:[i,o],tag:ne.TRACER}).onSuccess(),this.safeEmit(ht.LIVE_STREAMING_ERROR,i,o)},n.onLiveStreamWarning=(i,o)=>{Q.reportApiInvoke(this._sessionId,{name:ye.ON_LIVE_STREAM_WARNING,options:[i,o],tag:ne.TRACER}).onSuccess(),this.safeEmit(ht.LIVE_STREAMING_WARNING,i,o)},n.on($_.REQUEST_WORKER_MANAGER_LIST,(i,o,s)=>{if(!this._joinInfo)return s(new N(v.INVALID_OPERATION,"can not find join info to get worker manager"));var a;(a=y(function*(c,d,u,l){const p=A("UAP_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(h=>d.proxyServer?"https://".concat(d.proxyServer,"/ap/?url=").concat(h+"/api/v1?action=uap"):"https://".concat(h,"/api/v1?action=uap"));return yield function O3(t,e,n,r,i){im+=1;const o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:im,requestId:im,version:tr,cname:n.cname},s={service_name:e,json_body:JSON.stringify(o)};let a,c,d=t[0];return Mr(y(function*(){a=Date.now();const u=yield Fr(d,{data:s,cancelToken:r,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,0!==u.code){const h=new N(v.UNEXPECTED_RESPONSE,"live streaming ap error, code"+u.code,{retry:!0,responseTime:c});throw _.error(h.toString()),h}const l=JSON.parse(u.json_body);if(200!==l.code){const h=new N(v.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(l.code,", reason: ").concat(l.reason),{code:l.code,responseTime:c});throw _.error(h.toString()),h}if(!l.servers||0===l.servers.length){const h=new N(v.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:l.code,responseTime:c});throw _.error(h.toString()),h}const p=(S=e,{addressList:(h=l).servers.map(m=>"wss://".concat(m.address.replace(/\./g,"-"),".").concat(A("WORKER_DOMAIN"),":").concat(m.wss,"?serviceName=").concat(encodeURIComponent(S))),workerToken:h.workerToken,vid:h.vid});var h,S;return A("LIVE_STREAMING_ADDRESS")&&(p.addressList=A("LIVE_STREAMING_ADDRESS")instanceof Array?A("LIVE_STREAMING_ADDRESS"):[A("LIVE_STREAMING_ADDRESS")]),dl(dl({},p),{},{responseTime:c})}),(u,l)=>(Q.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(u.addressList),firstSuccess:0===l,responseTime:c,serverIp:t[l%t.length]}),!1),(u,l)=>(Q.apworkerEvent(n.sid,{success:!1,sc:u.data&&u.data.code||200,serviceName:e,responseTime:c,serverIp:t[l%t.length]}),!!(u.code!==v.OPERATION_ABORTED&&u.code!==v.UNEXPECTED_RESPONSE||u.data&&u.data.retry)&&(d=t[(l+1)%t.length],!0)),i)}(p,c,d,u,l)}),function(c,d,u,l){return a.apply(this,arguments)})(i,this._joinInfo,this._axiosCancelSource.token,Se).then(o).catch(s)}),n};return t===ti.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||e(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||e(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new N(v.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:n}=this.getLocalVideoStats(),r=(t={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:e,height:n}},Nc("ChannelMediaRelay").create(t));r.on("state",i=>{i===gn.RELAY_STATE_FAILURE&&r&&r.dispose(),this.safeEmit(ht.CHANNEL_MEDIA_RELAY_STATE,i)}),r.on("event",i=>{this.safeEmit(ht.CHANNEL_MEDIA_RELAY_EVENT,i)}),this._channelMediaRelayClient=r,this._statsCollector.onStatsChanged=(i,o)=>{var s;"resolution"===i&&(null===(s=this._channelMediaRelayClient)||void 0===s||s.setVideoProfile(o))}}var t;return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){const{added:n,deleted:r}=t,i=[];if(e){const o=[];this._users.forEach(s=>{s._dataChannels.forEach(a=>{n.every(c=>c.uid!==s._uintid||c.stream_id!==a.id)&&o.push({uid:s._uintid,stream_id:a.id,ordered:a.ordered,max_retrans_times:a.maxRetransmits,metadata:a.metadata})})}),o.length>0&&this._handleUpdateDataChannel({added:[],deleted:o})}Array.isArray(n)&&n.length>0&&n.forEach(o=>{const{uid:s,stream_id:a,ordered:c,max_retrans_times:d,metadata:u}=o,l=this._users.find(p=>p._uintid===s);if(l){if(_.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(s)),W(i).call(i,l)||i.push(l),l._uintid||(l._uintid=s),-1===l._dataChannels.findIndex(p=>p.id===o.stream_id)){const p={id:a,ordered:!!c,maxRetransmits:d,metadata:u},h=qO(p,!0);l._dataChannels.push(h),_.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published datachannel")),e||this.safeEmit(ht.USER_PUBLISHED,l,"datachannel",p)}this._p2pChannel.hasPendingRemoteDataChannel(l,o.stream_id)&&(_.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(l.uid," after reconnect.")),this._subscribeDataChannel(l,o.stream_id).catch(p=>{_.error("[".concat(this._clientId,"] resubscribe datachannel error"),p.toString())}))}else _.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"))}),e&&(this.safeEmit(ht.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(r)&&r.length>0&&r.forEach(o=>{const{uid:s}=o,c=this._users.find(u=>u._uintid===s);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const d=c._dataChannels.find(u=>u.id===o.stream_id);d&&(_.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(s)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then(u=>{if(c._dataChannels=c._dataChannels.filter(l=>l!==d),u)return this._gateway.unsubscribeDataChannel(u,c.uid)}),_.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(ht.USER_UNPUBLISHED,c,"datachannel",d._config))})}_handleRemoveDataChannels(t){const e=this._users.find(n=>n.uid===t.uid);if(e){if(void 0!==e._dataChannels&&e._dataChannels.length>0){_.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const n=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(r=>{this.safeEmit(ht.USER_UNPUBLISHED,e,"datachannel",r._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(r=>{if(r)return this._gateway.unsubscribeDataChannel(r,e.uid)}),n()}}else _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){var t=this;this._gateway.on(Ye.DISCONNECT_P2P,y(function*(){yield t._p2pChannel.disconnectForReconnect()})),this._gateway.on(Ye.CONNECTION_STATE_CHANGE,(e,n,r)=>{var i;if(r===Ot.FALLBACK)return;const o=()=>{this.safeEmit(ht.CONNECTION_STATE_CHANGE,e,n,r)};if(Q.reportApiInvoke(this._sessionId||(null===(i=this._gateway.joinInfo)||void 0===i?void 0:i.sid)||null,{name:ye.CONNECTION_STATE_CHANGE,options:[e,n,r],tag:ne.TRACER}).onSuccess(JSON.stringify({cur:e,prev:n,reason:r})),_.info("[".concat(this._clientId,"] signal connection state change: ").concat(n," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void o();if("RECONNECTING"===e)this._users.forEach(a=>{a._trust_in_room_=!1,a._trust_audio_enabled_state_=!1,a._trust_video_enabled_state_=!1,a._trust_audio_mute_state_=!1,a._trust_video_mute_state_=!1,a._trust_audio_stream_added_state_=!1,a._trust_video_stream_added_state_=!1,a._is_pre_created||(a._audio_pre_subscribed||(a._audioSSRC=void 0,a._audioOrtc=void 0),a._video_pre_subscribed||(a._videoSSRC=void 0,a._videoOrtc=void 0,a._rtxSsrcId=void 0),a._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var s;this._streamFallbackTypeCacheMap.forEach((a,c)=>{this._gateway.setStreamFallbackOption(c,a).catch(d=>{_.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),d)})}),this._remoteStreamTypeCacheMap.forEach((a,c)=>{this._gateway.setRemoteVideoStreamType(c,a).catch(d=>{_.warning("[".concat(this._clientId,"] auto set remote stream type failed"),d)})}),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(s=this._joinInfo)||void 0===s?void 0:s.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{_.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(a=>{_.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(a))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter(a=>!a._trust_in_room_).forEach(a=>{_.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(a.uid)),this._handleUserOffline({uid:a.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach(a=>{a._trust_audio_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,q.AUDIO,!1)),a._trust_video_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,q.VIDEO,!1)),a._trust_audio_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(a.uid)),this._handleSetStreamLocalEnable("audio",a.uid,!0)),a._trust_video_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(a.uid)),this._handleSetStreamLocalEnable("video",a.uid,!0)),a._trust_video_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(a.uid)),this._handleResetAddStream(a,"video")),a._trust_audio_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(a.uid)),this._handleResetAddStream(a,"audio")),a._video_added_||a._audio_added_||(_.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(a.uid)),this._handleRemoveStream({uid:a.uid,uint_id:a._uintid}))}))},1e3))}o()}),this._gateway.on(Ye.REQUEST_NEW_GATEWAY_LIST,function(){var e=y(function*(n,r){if(!t._joinInfo)return r(new N(v.UNEXPECTED_ERROR,"can not recover, no join info"));try{let i;const o=yield e0(Ar(Ar({},t._joinInfo),{},{uid:t._joinInfo.uid,stringUid:void 0}));o?(i=o.ap,i0(o),t._joinInfo.preload=!0):(i=yield cm(t._joinInfo,t._axiosCancelSource.token,t._config.httpRetryConfig||Se,t.store),t._joinInfo.preload=!1),t._joinInfo&&(t._joinInfo.apResponse=i.gatewayInfo.res,t._joinInfo.gatewayAddrs=i.gatewayInfo.gatewayAddrs,t._joinInfo.uni_lbs_ip=i.gatewayInfo.uni_lbs_ip);const s=[];i.gatewayInfo.gatewayAddrs.forEach(a=>{let{address:c}=a;const[d,u]=c.split(":");s.push(t._joinInfo&&t._joinInfo.proxyServer?{proxy:t._joinInfo.proxyServer,host:d,port:u}:{host:d,port:u})}),n(s)}catch(i){r(i)}});return function(n,r){return e.apply(this,arguments)}}()),this._gateway.on(Ye.NETWORK_QUALITY,e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(ht.NETWORK_QUALITY,e)}),this._gateway.on(Ye.STREAM_TYPE_CHANGE,(e,n)=>{this.safeEmit(ht.STREAM_TYPE_CHANGED,e,n),Q.reportApiInvoke(this._sessionId,{name:ye.STREAM_TYPE_CHANGE,options:[e,n],tag:ne.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:n}))}),this._gateway.on(Ye.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(Ye.REQUEST_P2P_CONNECTION_PARAMS,function(){var e=y(function*(n,r,i){try{let o=yield t._p2pChannel.getEstablishParams();A("ENABLE_PREALLOC_PC")&&o||(o=yield t._p2pChannel.startP2PConnection(n)),r(o)}catch(o){i(o)}});return function(n,r,i){return e.apply(this,arguments)}}()),this._gateway.on(Ye.JOIN_RESPONSE,(e,n)=>{if(this.store.useP2P)return;let r;e.attributes?r=e.attributes.userAttributes.preSubSsrcs:_.debug("no attributes in joinResponse");const i=Ab(e.ortc,n,r);this._p2pChannel.connect(i)}),this._gateway.on(Ye.PRE_CONNECT_PC,function(){var e=y(function*(n){const{candidates:r,fingerprint:i}=n;if(t._joinInfo&&r.length>0&&!t._p2pChannel.isPlanB){var o;yield t._p2pChannel.startP2PConnection({turnServer:t._joinInfo.turnServer});const{cert:s,cid:a}=t._joinInfo.apResponse;yield t._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(a,"_").concat(s),icePwd:"".concat(a,"_").concat(s)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(o=A("FINGERPRINT"))&&void 0!==o?o:i}]},candidates:r,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0})}});return function(n){return e.apply(this,arguments)}}())}_handleGatewaySignalEvents(){var t=this;this._gateway.signal.on(pt.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(pt.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(pt.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc)),this._gateway.signal.on(pt.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(pt.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(pt.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(pt.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(pt.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(pt.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,q.AUDIO,!0)),this._gateway.signal.on(pt.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,q.AUDIO,!1)),this._gateway.signal.on(pt.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,q.VIDEO,!0)),this._gateway.signal.on(pt.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,q.VIDEO,!1)),this._gateway.signal.on(pt.RECEIVE_METADATA,e=>{const n=ko(e.metadata);this.safeEmit(ht.RECEIVE_METADATA,e.uid,n)}),this._gateway.signal.on(pt.ON_DATA_STREAM,function(){var e=y(function*(n){var r;if(!n)return;let i=ko(n.payload);if(t._encryptDataStream&&t._encryptDataStreamIv&&t._encryptDataStreamKey&&window.crypto.subtle&&W(r=["aes-128-gcm2","aes-256-gcm2"]).call(r,t._encryptionMode)){if(n.payload.length<10)throw new N(v.UNEXPECTED_RESPONSE,"payload length ".concat(n.payload.length," is less than header length ").concat(10));i=yield(a=y(function*(c,d,u){const l=u.subarray(0,10),p=l.slice(8,10),h=(p[0]<<8)+p[1],S=(l[6]<<8)+l[7],m=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:c,tagLength:128,additionalData:new Uint8Array(sC(h,2))},d,u.subarray(10));return new Uint8Array(m).subarray(0,S)}),function(c,d,u){return a.apply(this,arguments)})(t._encryptDataStreamIv,t._encryptDataStreamKey,i)}var a;let o=0;if(n.ordered||n.syncWithAudio){const s=t._p2pChannel.getStats(),a=t.remoteUsers.find(d=>d.uid===n.uid),c=s?.audioRecv.find(d=>d.ssrc===a?._audioSSRC);o=c?.jitterBufferMs}null==o&&(o=0),function eW(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return QO(n,{uid:t.uid,payload:t.payload});const r="".concat(n.id,"-").concat(t.uid),i=bm.get(r)||[],o=i.findIndex(d=>t.sendTs>=d.sendTs),s=JO(JO({},t),{},{context:n,mediaDelay:e,recvTs:Date.now()});-1===o?i.push(s):i.splice(o,0,s),bm.set(r,i);let a=!1;var c;gl.has(r)?a=!(null===(c=gl.get(r))||void 0===c||!c.isSyncing):gl.set(r,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||XO(r)}(Ar(Ar({},n),{},{payload:i}),o,{id:t._clientId,onStreamMessage:"function"==typeof t.onStreamMessage?t.onStreamMessage.bind(t):void 0,safeEmit:t.safeEmit.bind(t)})});return function(n){return e.apply(this,arguments)}}()),this._gateway.signal.on(pt.ON_CRYPT_ERROR,()=>{Qi(()=>{_.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(ht.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(pt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(pt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{_.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ot.TOKEN_EXPIRE),this.safeEmit(ht.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(pt.ON_STREAM_FALLBACK_UPDATE,e=>{_.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(ht.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")}),this._gateway.signal.on(pt.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),_.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(pt.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(pt.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(ot.REQUEST_TIMEOUT,(e,n)=>{if(this._joinInfo)switch(e){case it.PUBLISH:{if(!n)return;const o=n.ortc;if(o){var r,i;const s=o.some(d=>{let{stream_type:u}=d;return u===At.Audio}),a=o.some(d=>{let{stream_type:u}=d;return u!==At.Audio}),c=o.some(d=>{let{stream_type:u}=d;return u===At.Screen||u===At.ScreenLow});"offer"===n.state&&Q.publish(this._joinInfo.sid,{eventElapse:Qe.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:v.TIMEOUT,audio:s,video:a,p2pid:n.p2p_id,publishRequestid:this.store.pubId,screenshare:c,audioName:s?null===(r=o.find(d=>{let{stream_type:u}=d;return u===At.Audio}))||void 0===r||null===(r=r.ssrcs[0])||void 0===r?void 0:r.ssrcId.toString():void 0,videoName:a?null===(i=o.find(d=>{let{stream_type:u}=d;return u!==At.Audio}))||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId.toString():void 0})}break}case it.SUBSCRIBE:n&&Q.subscribe(this._joinInfo.sid,{succ:!1,ec:v.TIMEOUT,audio:n.stream_type===q.AUDIO,video:n.stream_type===q.VIDEO,peerid:n.stream_id,subscribeRequestid:n.ssrcId,p2pid:this.store.p2pId,eventElapse:Qe.measureFromSubscribeStart(this.store.clientId,n.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(n.ssrcId)})}}),this._gateway.signal.on(pt.ON_P2P_OK,e=>{}),this._gateway.signal.on(pt.ON_PUBLISHED_USER_LIST,e=>{if(null==e||!e.users)return;A("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(i=>!xo(i.string_id||i.stream_id,this.channelName)));const n=[],r=[];for(const i of e.users){let o=this._users.find(l=>l._uintid===i.stream_id);o?o._trust_in_room_=!0:(o=new uo(i.string_id||i.stream_id,i.stream_id),this._users.push(o),0===this.getListeners(ht.PUBLISHED_USER_LIST).length&&(_.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(ht.USER_JOINED,o)));const s=Ne.Audio&i.stream_type,a=(Ne.Video|Ne.LwoVideo)&i.stream_type,c=!!(65280&i.stream_type),d=s&&o.hasAudio,u=a&&o.hasVideo;a&&(o._trust_video_stream_added_state_=!0,o._video_added_=!0,o._videoSSRC=i.video_ssrc,o._rtxSsrcId=i.video_rtx),s&&(o._trust_audio_stream_added_state_=!0,o._audio_added_=!0,o._audioSSRC=i.audio_ssrc),s&&!d&&0===this.getListeners(ht.PUBLISHED_USER_LIST).length&&(_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," published audio")),this.safeEmit(ht.USER_PUBLISHED,o,"audio")),a&&!u&&0===this.getListeners(ht.PUBLISHED_USER_LIST).length&&(_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," published video")),this.safeEmit(ht.USER_PUBLISHED,o,"video")),(s&&!d||a&&!u||c)&&n.push(o),a&&this._p2pChannel.hasPendingRemoteMedia(o,"video")&&r.push({user:o,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(o,"audio")&&r.push({user:o,mediaType:"audio"})}r.length>0&&(_.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(r.map(i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType)).join("; ")," ")),this.massSubscribe(r).catch(i=>{_.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString())})),this.getListeners(ht.PUBLISHED_USER_LIST).length>0?A("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=n:(_.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(n.map(i=>i.uid).join(", "))),this.safeEmit(ht.PUBLISHED_USER_LIST,n)):_.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(n.map(i=>i.uid).join(", ")))}),this._gateway.signal.on(pt.ON_RTP_CAPABILITY_CHANGE,e=>{const{video_codec:n}=e;this._p2pChannel instanceof fl&&this._p2pChannel.updateRemoteRTPCapabilities(n.map(r=>r.toLowerCase()).filter(r=>{var i;return W(i=Object.keys(wu)).call(i,r)}))})}_handleP2PEvents(){var t=this;this._gateway.signal.on(pt.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(de.PUBLISH,(e,n,r)=>{const{uid:i}=e;e.forEach(o=>{const{kind:s,ssrcs:a,mid:c,isMuted:d}=o;this._handleP2PAddAudioOrVideoStream(s,i,a[0].ssrcId,c);const u=this._users.find(l=>l.uid===i);return u&&this._p2pChannel instanceof Dn?this._p2pChannel.mockSubscribe(u,s,a[0].ssrcId,c).then(()=>{n()}).catch(r):n(),this._handleMuteStream(i,s,!!d)})}),this._gateway.signal.on(de.CALL,function(){var e=y(function*(n,r,i){if(t._p2pChannel instanceof Dn)try{var o;r(yield t._p2pChannel.startP2P({turnServer:null===(o=t._joinInfo)||void 0===o?void 0:o.turnServer},n))}catch(s){i(s)}});return function(n,r,i){return e.apply(this,arguments)}}()),this._gateway.signal.on(ot.P2P_CONNECTION,function(){var e=y(function*(n){t._p2pChannel instanceof Dn&&(yield t._p2pChannel.p2pConnect(n))});return function(n){return e.apply(this,arguments)}}()),this._gateway.signal.on(de.UNPUBLISH,function(){var e=y(function*(n,r,i){if(t._p2pChannel instanceof Dn){const{unpubMsg:o,uid:s}=n,a=t._users.find(c=>c.uid===s);if(!a)return _.warning("[".concat(t._clientId,"] can not find remote user, ignore mute event, uid: ").concat(s)),void r();try{o.forEach(function(){var c=y(function*(d){let{stream_type:u}=d;const l=u===At.Audio?q.AUDIO:q.VIDEO;yield t._p2pChannel.unsubscribe(a,l),t._handleMuteStream(s,l,!0)});return function(d){return c.apply(this,arguments)}}()),r()}catch(c){i(c)}}});return function(n,r,i){return e.apply(this,arguments)}}()),this._gateway.signal.on(de.CONTROL,function(){var e=y(function*(n,r){const{action:i}=n;switch(i){case eo.MUTE_LOCAL_VIDEO:t._handleMuteStream(r,q.VIDEO,!0);break;case eo.MUTE_LOCAL_AUDIO:t._handleMuteStream(r,q.AUDIO,!0);break;case eo.UNMUTE_LOCAL_VIDEO:t._handleP2PAddAudioOrVideoStream("video",r),t._handleMuteStream(r,q.VIDEO,!1);break;case eo.UNMUTE_LOCAL_AUDIO:t._handleP2PAddAudioOrVideoStream("audio",r),t._handleMuteStream(r,q.AUDIO,!1)}});return function(n,r){return e.apply(this,arguments)}}()),this._gateway.signal.on(de.RESTART_ICE,function(){var e=y(function*(n,r,i){if(t._p2pChannel instanceof Dn)try{const{direction:o,iceParameter:s}=n;o!==dn.SEND_ONLY||s?r(yield t._p2pChannel.restartICE(o,s)):(t._p2pChannel.handleDisconnect(o),r())}catch(o){i(o)}});return function(n,r,i){return e.apply(this,arguments)}}()),this._gateway.signal.on(de.CANDIDATE,e=>{if(this._p2pChannel instanceof Dn){const{candidate:n,direction:r}=e;this._p2pChannel.addRemoteCandidate(n,r)}}),this._p2pChannel.on(nt.RequestP2PRestartICE,function(){var e=y(function*(n,r,i){try{const{direction:o}=n;r(yield t._gateway.sendExtensionMessage(de.RESTART_ICE,n,o===dn.SEND_ONLY))}catch(o){i(o)}});return function(n,r,i){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.LocalCandidate,e=>{this._gateway.sendExtensionMessage(de.CANDIDATE,JSON.stringify(e),!0)}),this._p2pChannel.on(nt.RequestP2PMuteLocal,function(){var e=y(function*(n,r,i){try{yield t._gateway.sendExtensionMessage(de.CONTROL,n,!0),r()}catch(o){i(o)}});return function(n,r,i){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.RequestP2PUnmuteRemote,function(){var e=y(function*(n,r,i){if(t._joinInfo)try{yield t._gateway.unmuteRemote(n,t._joinInfo.stringUid||t._joinInfo.uid),r()}catch(o){o.code===v.DISCONNECT_P2P?r():i(o)}else r()});return function(n,r,i){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.RequestP2PMuteRemote,function(){var e=y(function*(n,r,i){if(t._joinInfo)try{yield t._gateway.muteRemote(n,t._joinInfo.stringUid||t._joinInfo.uid),r()}catch(o){o.code===v.DISCONNECT_P2P?r():i(o)}else r()});return function(n,r,i){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.StateChange,(e,n)=>{n===bt.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){var t=this;this._p2pChannel.on(nt.RequestMuteLocal,function(){var e=y(function*(n,r,i){if(t._joinInfo)try{yield t._gateway.muteLocal(n,t._joinInfo.stringUid||t._joinInfo.uid),r()}catch(o){o.code===v.DISCONNECT_P2P?r():i(o)}else r()});return function(n,r,i){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.RequestUnmuteLocal,function(){var e=y(function*(n,r,i){if(t._joinInfo)try{yield t._gateway.unmuteLocal(n,t._joinInfo.stringUid||t._joinInfo.uid),r()}catch(o){o.code===v.DISCONNECT_P2P?r():i(o)}else r()});return function(n,r,i){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.RequestRePublish,(e,n,r)=>{this.publish(e,!1).then(n).catch(r)}),this._p2pChannel.on(nt.RequestRePublishDataChannel,(e,n,r)=>{H.all(e.map(function(){var i=y(function*(o){const s=yield t._p2pChannel.publishDataChannel([o]);try{s.forEach(a=>{t._uid&&t._gateway.publishDataChannel(t._uid,a,!0)})}catch(a){if(a.code!==v.DISCONNECT_P2P)throw a}});return function(o){return i.apply(this,arguments)}}())).then(n).catch(r)}),this._p2pChannel.on(nt.RequestReSubscribe,function(){var e=y(function*(n,r,i){try{for(const{user:o,kind:s}of n)s===q.VIDEO?yield t.subscribe(o,"video"):yield t.subscribe(o,"audio");r()}catch(o){i(o)}});return function(n,r,i){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.RequestUpload,(e,n)=>{this._gateway.upload(e,n)}),this._p2pChannel.on(nt.RequestUploadStats,e=>{this._gateway.uploadWRTCStats(e)}),this._p2pChannel.on(nt.MediaReconnectStart,e=>{this.safeEmit(ht.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(nt.MediaReconnectEnd,e=>{this.safeEmit(ht.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(nt.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(nt.RequestRestartICE,function(){var e=y(function*(n){if(t._p2pChannel instanceof Dn)return;const r=yield t._p2pChannel.restartICE(n),i=yield r.next();if(i.done)return;const o=i.value;let s;try{s=yield t._gateway.restartICE({iceParameters:o})}catch(c){return void r.throw(c)}const{iceParameters:a}=function(c){const d=c.iceParameters;return{iceParameters:{iceUfrag:d.iceUfrag,icePwd:d.icePwd}}}(s);yield r.next({remoteIceParameters:a})});return function(n){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.RequestReconnect,y(function*(){t._gateway.reconnect()})),this._p2pChannel.on(nt.RequestReconnectPC,y(function*(){var e;const{iceParameters:n,dtlsParameters:r,rtpCapabilities:i}=yield t._p2pChannel.startP2PConnection({turnServer:null===(e=t._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:o,gatewayAddress:s}=yield t._gateway.reconnectPC({iceParameters:n,dtlsParameters:r,rtpCapabilities:i}),a=Ab(o,s);yield t._p2pChannel.connect(a),yield t._p2pChannel.republish(),yield t._p2pChannel.reSubscribe()})),this._p2pChannel.on(nt.RequestUnpublishForReconnectPC,function(){var e=y(function*(n,r,i){t._joinInfo&&void 0!==t._uid?(yield t._gateway.unpublish(n,t._uid),r()):i()});return function(n,r,i){return e.apply(this,arguments)}}()),this._p2pChannel.on(nt.P2PLost,()=>{this.safeEmit(ht.P2P_LOST,this.store.uid)}),this._p2pChannel.on(nt.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(nt.ConnectionTypeChange,e=>{this.safeEmit(ht.IS_USING_CLOUD_PROXY,e)}),this._p2pChannel.on(nt.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(nt.QueryClientConnectionState,e=>{e(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}enableContentInspect(t){var e=this;return y(function*(){if(!e._joinInfo||"CONNECTED"!==e.connectionState)throw new N(v.INVALID_OPERATION,"[".concat(e._clientId,"] can not create content inspect, please join channel first"));if(e._inspect)throw new N(v.INVALID_OPERATION,"[".concat(e._clientId,"] Inspect content service already in connecting/connected state"));try{const r=(n={config:t},Nc("ContentInspect").create(n));e._inspect=r,e.handleVideoInspectEvents(r);const{appId:i,cname:o,sid:s,token:a,uid:c,cid:d,vid:u}=e._joinInfo;yield r.init({appId:i,areaCode:"",cname:o,sid:s,token:a,uid:c,cid:d,vid:u?Number(u):0},Se)}catch(r){throw Array.isArray(r)?r[0]:r}var n})()}handleVideoInspectEvents(t){t.on(De.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(ht.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,n),n===_r.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(ht.CONTENT_INSPECT_ERROR,new N(v.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(De.INSPECT_RESULT,(e,n)=>{var r;if(n?.code===v.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return _.debug("Stop inspect content because that has left channel"),null==this||null===(r=this._inspect)||void 0===r||r.close(),void(this._inspect=void 0);this.safeEmit(ht.CONTENT_INSPECT_RESULT,e,n)}),t.on(De.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>"video"===n.trackMediaType)[0])})}disableContentInspect(){var t=this;return y(function*(){if(!t._inspect)throw new N(v.INVALID_OPERATION,"[".concat(t._clientId,"] inspectVideoContent not started"));try{t._inspect.close(),t._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}})()}setImageModeration(t,e){var n=this;return y(function*(){if(Si(t,"enabled"),t){if(!e)throw new N(v.INVALID_PARAMS,"config is required");if(g0(e),!n._joinInfo)throw new N(v.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(n._moderation)n._moderation.updateConfig(e);else{const i=(r={config:e},Nc("ImageModeration").create(r));n._moderation=i,n.handleImageModerationEvents(i);const{appId:o,cname:s,sid:a,token:c,uid:d,cid:u,vid:l}=n._joinInfo;yield i.init({appId:o,areaCode:"",cname:s,sid:a,token:c,uid:d,cid:u,vid:l?Number(l):0},Se)}}catch(i){throw Array.isArray(i)?i[0]:i}}else{var r;if(!n._moderation)throw new N(v.INVALID_OPERATION,"[".concat(n._clientId,"] image moderation not started"));try{n._moderation.close(),n._moderation.removeAllListeners(),n._moderation=void 0}catch(i){throw Array.isArray(i)?i[0]:i}}})()}handleImageModerationEvents(t){t.on(Ur.CONNECTION_STATE_CHANGE,(e,n)=>{if(this.safeEmit(ht.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,n),e===nr.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new N(v.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(Ur.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(n=>"video"===n.trackMediaType)[0])})}setP2PTransport(t){if(be(t,"transport",["default","auto","relay","sd-rtn"]),"p2p"!==this.mode)throw new N(v.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,_.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}getJoinChannelServiceRecords(){return _.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}setPublishAudioFilterEnabled(t){var e=this;return y(function*(){Si(t,"enabled"),Ut("ENABLE_PUBLISH_AUDIO_FILTER",t),e._joinInfo&&(yield e._gateway.setPublishAudioFilterEnabled(t))})()}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}},z(K.prototype,"leave",[T0],Object.getOwnPropertyDescriptor(K.prototype,"leave"),K.prototype),z(K.prototype,"publish",[S0],Object.getOwnPropertyDescriptor(K.prototype,"publish"),K.prototype),z(K.prototype,"unpublish",[R0],Object.getOwnPropertyDescriptor(K.prototype,"unpublish"),K.prototype),z(K.prototype,"subscribe",[v0],Object.getOwnPropertyDescriptor(K.prototype,"subscribe"),K.prototype),z(K.prototype,"presubscribe",[y0],Object.getOwnPropertyDescriptor(K.prototype,"presubscribe"),K.prototype),z(K.prototype,"massSubscribe",[C0],Object.getOwnPropertyDescriptor(K.prototype,"massSubscribe"),K.prototype),z(K.prototype,"unsubscribe",[I0],Object.getOwnPropertyDescriptor(K.prototype,"unsubscribe"),K.prototype),z(K.prototype,"massUnsubscribe",[A0],Object.getOwnPropertyDescriptor(K.prototype,"massUnsubscribe"),K.prototype),z(K.prototype,"setLowStreamParameter",[b0],Object.getOwnPropertyDescriptor(K.prototype,"setLowStreamParameter"),K.prototype),z(K.prototype,"enableDualStream",[O0],Object.getOwnPropertyDescriptor(K.prototype,"enableDualStream"),K.prototype),z(K.prototype,"disableDualStream",[w0],Object.getOwnPropertyDescriptor(K.prototype,"disableDualStream"),K.prototype),z(K.prototype,"setClientRole",[N0],Object.getOwnPropertyDescriptor(K.prototype,"setClientRole"),K.prototype),z(K.prototype,"setProxyServer",[D0],Object.getOwnPropertyDescriptor(K.prototype,"setProxyServer"),K.prototype),z(K.prototype,"setTurnServer",[P0],Object.getOwnPropertyDescriptor(K.prototype,"setTurnServer"),K.prototype),z(K.prototype,"setLicense",[L0],Object.getOwnPropertyDescriptor(K.prototype,"setLicense"),K.prototype),z(K.prototype,"startProxyServer",[k0],Object.getOwnPropertyDescriptor(K.prototype,"startProxyServer"),K.prototype),z(K.prototype,"stopProxyServer",[M0],Object.getOwnPropertyDescriptor(K.prototype,"stopProxyServer"),K.prototype),z(K.prototype,"setLocalAccessPointsV2",[U0],Object.getOwnPropertyDescriptor(K.prototype,"setLocalAccessPointsV2"),K.prototype),z(K.prototype,"setLocalAccessPoints",[x0],Object.getOwnPropertyDescriptor(K.prototype,"setLocalAccessPoints"),K.prototype),z(K.prototype,"setRemoteDefaultVideoStreamType",[V0],Object.getOwnPropertyDescriptor(K.prototype,"setRemoteDefaultVideoStreamType"),K.prototype),z(K.prototype,"setRemoteVideoStreamType",[F0],Object.getOwnPropertyDescriptor(K.prototype,"setRemoteVideoStreamType"),K.prototype),z(K.prototype,"setStreamFallbackOption",[B0],Object.getOwnPropertyDescriptor(K.prototype,"setStreamFallbackOption"),K.prototype),z(K.prototype,"setEncryptionConfig",[j0],Object.getOwnPropertyDescriptor(K.prototype,"setEncryptionConfig"),K.prototype),z(K.prototype,"renewToken",[G0],Object.getOwnPropertyDescriptor(K.prototype,"renewToken"),K.prototype),z(K.prototype,"enableAudioVolumeIndicator",[W0],Object.getOwnPropertyDescriptor(K.prototype,"enableAudioVolumeIndicator"),K.prototype),z(K.prototype,"startLiveStreaming",[H0],Object.getOwnPropertyDescriptor(K.prototype,"startLiveStreaming"),K.prototype),z(K.prototype,"setLiveTranscoding",[K0],Object.getOwnPropertyDescriptor(K.prototype,"setLiveTranscoding"),K.prototype),z(K.prototype,"stopLiveStreaming",[Y0],Object.getOwnPropertyDescriptor(K.prototype,"stopLiveStreaming"),K.prototype),z(K.prototype,"startChannelMediaRelay",[q0],Object.getOwnPropertyDescriptor(K.prototype,"startChannelMediaRelay"),K.prototype),z(K.prototype,"updateChannelMediaRelay",[z0],Object.getOwnPropertyDescriptor(K.prototype,"updateChannelMediaRelay"),K.prototype),z(K.prototype,"stopChannelMediaRelay",[J0],Object.getOwnPropertyDescriptor(K.prototype,"stopChannelMediaRelay"),K.prototype),z(K.prototype,"sendCustomReportMessage",[X0],Object.getOwnPropertyDescriptor(K.prototype,"sendCustomReportMessage"),K.prototype),z(K.prototype,"pickSVCLayer",[Q0],Object.getOwnPropertyDescriptor(K.prototype,"pickSVCLayer"),K.prototype),z(K.prototype,"setRTMConfig",[Z0],Object.getOwnPropertyDescriptor(K.prototype,"setRTMConfig"),K.prototype),z(K.prototype,"enableContentInspect",[$0],Object.getOwnPropertyDescriptor(K.prototype,"enableContentInspect"),K.prototype),z(K.prototype,"disableContentInspect",[tw],Object.getOwnPropertyDescriptor(K.prototype,"disableContentInspect"),K.prototype),z(K.prototype,"setImageModeration",[ew],Object.getOwnPropertyDescriptor(K.prototype,"setImageModeration"),K.prototype),z(K.prototype,"setP2PTransport",[nw],Object.getOwnPropertyDescriptor(K.prototype,"setP2PTransport"),K.prototype),z(K.prototype,"getJoinChannelServiceRecords",[rw],Object.getOwnPropertyDescriptor(K.prototype,"getJoinChannelServiceRecords"),K.prototype),z(K.prototype,"setPublishAudioFilterEnabled",[iw],Object.getOwnPropertyDescriptor(K.prototype,"setPublishAudioFilterEnabled"),K.prototype),K);class Pc{constructor(e,n){T(this,"id",0),T(this,"element",void 0),T(this,"peerPair",void 0),T(this,"context",void 0),T(this,"audioPlayerElement",void 0),T(this,"audioTrack",void 0),Pc.count+=1,this.id=Pc.count,this.element=e,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const n=document.createElement("audio");n.srcObject=new MediaStream([e.track]),n.play(),this.audioPlayerElement=n}}switchSdp(){var e=this;return y(function*(){if(!e.peerPair)return;const n=function(){var i=y(function*(o,s){const a="offer"===s?yield o.createOffer():yield o.createAnswer();return yield o.setLocalDescription(a),"complete"===o.iceGatheringState?o.localDescription:new H(c=>{o.onicegatheringstatechange=()=>{"complete"===o.iceGatheringState&&c(o.localDescription)}})});return function(s,a){return i.apply(this,arguments)}}(),r=function(){var i=y(function*(o,s){return yield o.setRemoteDescription(s)});return function(s,a){return i.apply(this,arguments)}}();try{const i=yield n(e.peerPair[0],"offer");yield r(e.peerPair[1],i);const o=yield n(e.peerPair[1],"answer");yield r(e.peerPair[0],o)}catch(i){throw new N(v.LOCAL_AEC_ERROR,i.toString()).print()}})()}getTracksFromMediaElement(e){var n=this;return y(function*(){if(n.audioTrack)return n.audioTrack;let r;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),r=n.context.createMediaStreamDestination(),n.context.createMediaElementSource(e).connect(r)}catch(o){throw new N(v.LOCAL_AEC_ERROR,o.toString()).print()}if(!r)throw new N(v.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=r.stream.getAudioTracks()[0];return n.audioTrack=i,i})()}getElement(){return this.element}startEchoCancellation(){var e=this;return y(function*(){e.context.resume(),e.peerPair&&e.close(),e.initPeers();const n=e.element,r=yield e.getTracksFromMediaElement(n);e.peerPair&&e.peerPair[0].addTrack(r),yield e.switchSdp()})()}close(){_.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var sw,yl;T(Pc,"count",0);const gW=window.AudioContext||window.webkitAudioContext,TW=new(sw=et({report:Q}),z((yl=class{constructor(){T(this,"units",[]),T(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return _.debug("the system does not need to process local aec"),-1;this.context||(this.context=new gW);let e=this.units.find(n=>n&&n.getElement()===t);return e||(e=new Pc(t,this.context),this.units.push(e)),e.startEchoCancellation(),_.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return Tt().name!==It.SAFARI}}).prototype,"processExternalMediaAEC",[sw],Object.getOwnPropertyDescriptor(yl.prototype,"processExternalMediaAEC"),yl.prototype),yl);function aw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function cw(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?aw(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):aw(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}const Fm=window||document;function dw(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Fm)return;const n=Re._cspEventHandlerPointer;if(n&&e)return void console.error(n,e);const r=i=>{if(!(i&&i.blockedURI&&(Re.onSecurityPolicyViolation||Re.getListeners(ei.SECURITY_POLICY_VIOLATION).length>0)))return;const o=i.blockedURI;A("CSP_DETECTED_HOSTNAME_LIST").some(s=>W(o).call(o,s))&&(Re.onSecurityPolicyViolation&&"function"==typeof Re.onSecurityPolicyViolation&&Re.onSecurityPolicyViolation(i),Re.getListeners(ei.SECURITY_POLICY_VIOLATION).length>0&&Re.safeEmit(ei.SECURITY_POLICY_VIOLATION,i))};n&&Fm.removeEventListener("securitypolicyviolation",n),(e||t&&"function"==typeof t||Re.getListeners(ei.SECURITY_POLICY_VIOLATION).length>0)&&Fm.addEventListener("securitypolicyviolation",r),Re._cspEventHandlerPointer=r}var SW=on,RW=Zv,uw=RegExp.prototype,rn=Wt(function(t){return t===uw||SW(uw,t)?RW(t):t.flags});function ga(t){let e=t.length;for(;--e>=0;)t[e]=0}const jm=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Cl=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),yW=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),pw=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ni=new Array(576);ga(Ni);const Mc=new Array(60);ga(Mc);const Uc=new Array(512);ga(Uc);const xc=new Array(256);ga(xc);const Gm=new Array(29);ga(Gm);const Il=new Array(30);function Wm(t,e,n,r,i){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=r,this.max_length=i,this.has_stree=t&&t.length}let hw,_w,Ew;function Hm(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}ga(Il);const mw=t=>t<256?Uc[t]:Uc[256+(t>>>7)],Vc=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},Kn=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,Vc(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n)},ui=(t,e,n)=>{Kn(t,n[2*e],n[2*e+1])},fw=(t,e)=>{let n=0;do{n|=1&t,t>>>=1,n<<=1}while(--e>0);return n>>>1},gw=(t,e,n)=>{const r=new Array(16);let i,o,s=0;for(i=1;i<=15;i++)s=s+n[i-1]<<1,r[i]=s;for(o=0;o<=e;o++){let a=t[2*o+1];0!==a&&(t[2*o]=fw(r[a]++,a))}},Tw=t=>{let e;for(e=0;e<286;e++)t.dyn_ltree[2*e]=0;for(e=0;e<30;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},Sw=t=>{t.bi_valid>8?Vc(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},Rw=(t,e,n,r)=>{const i=2*e,o=2*n;return t[i]<t[o]||t[i]===t[o]&&r[e]<=r[n]},Km=(t,e,n)=>{const r=t.heap[n];let i=n<<1;for(;i<=t.heap_len&&(i<t.heap_len&&Rw(e,t.heap[i+1],t.heap[i],t.depth)&&i++,!Rw(e,r,t.heap[i],t.depth));)t.heap[n]=t.heap[i],n=i,i<<=1;t.heap[n]=r},vw=(t,e,n)=>{let r,i,o,s,a=0;if(0!==t.sym_next)do{r=255&t.pending_buf[t.sym_buf+a++],r+=(255&t.pending_buf[t.sym_buf+a++])<<8,i=t.pending_buf[t.sym_buf+a++],0===r?ui(t,i,e):(o=xc[i],ui(t,o+256+1,e),s=jm[o],0!==s&&(i-=Gm[o],Kn(t,i,s)),r--,o=mw(r),ui(t,o,n),s=Cl[o],0!==s&&(r-=Il[o],Kn(t,r,s)))}while(a<t.sym_next);ui(t,256,e)},Ym=(t,e)=>{const n=e.dyn_tree,r=e.stat_desc.static_tree,i=e.stat_desc.has_stree,o=e.stat_desc.elems;let s,a,c,d=-1;for(t.heap_len=0,t.heap_max=573,s=0;s<o;s++)0!==n[2*s]?(t.heap[++t.heap_len]=d=s,t.depth[s]=0):n[2*s+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=d<2?++d:0,n[2*c]=1,t.depth[c]=0,t.opt_len--,i&&(t.static_len-=r[2*c+1]);for(e.max_code=d,s=t.heap_len>>1;s>=1;s--)Km(t,n,s);c=o;do{s=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Km(t,n,1),a=t.heap[1],t.heap[--t.heap_max]=s,t.heap[--t.heap_max]=a,n[2*c]=n[2*s]+n[2*a],t.depth[c]=(t.depth[s]>=t.depth[a]?t.depth[s]:t.depth[a])+1,n[2*s+1]=n[2*a+1]=c,t.heap[1]=c++,Km(t,n,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((u,l)=>{const p=l.dyn_tree,h=l.max_code,S=l.stat_desc.static_tree,m=l.stat_desc.has_stree,f=l.stat_desc.extra_bits,g=l.stat_desc.extra_base,R=l.stat_desc.max_length;let C,b,w,D,V,U,k=0;for(D=0;D<=15;D++)u.bl_count[D]=0;for(p[2*u.heap[u.heap_max]+1]=0,C=u.heap_max+1;C<573;C++)b=u.heap[C],D=p[2*p[2*b+1]+1]+1,D>R&&(D=R,k++),p[2*b+1]=D,b>h||(u.bl_count[D]++,V=0,b>=g&&(V=f[b-g]),U=p[2*b],u.opt_len+=U*(D+V),m&&(u.static_len+=U*(S[2*b+1]+V)));if(0!==k){do{for(D=R-1;0===u.bl_count[D];)D--;u.bl_count[D]--,u.bl_count[D+1]+=2,u.bl_count[R]--,k-=2}while(k>0);for(D=R;0!==D;D--)for(b=u.bl_count[D];0!==b;)w=u.heap[--C],w>h||(p[2*w+1]!==D&&(u.opt_len+=(D-p[2*w+1])*p[2*w],p[2*w+1]=D),b--)}})(t,e),gw(n,d,t.bl_count)},yw=(t,e,n)=>{let r,i,o=-1,s=e[1],a=0,c=7,d=4;for(0===s&&(c=138,d=3),e[2*(n+1)+1]=65535,r=0;r<=n;r++)i=s,s=e[2*(r+1)+1],++a<c&&i===s||(a<d?t.bl_tree[2*i]+=a:0!==i?(i!==o&&t.bl_tree[2*i]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,o=i,0===s?(c=138,d=3):i===s?(c=6,d=3):(c=7,d=4))},Cw=(t,e,n)=>{let r,i,o=-1,s=e[1],a=0,c=7,d=4;for(0===s&&(c=138,d=3),r=0;r<=n;r++)if(i=s,s=e[2*(r+1)+1],!(++a<c&&i===s)){if(a<d)do{ui(t,i,t.bl_tree)}while(0!=--a);else 0!==i?(i!==o&&(ui(t,i,t.bl_tree),a--),ui(t,16,t.bl_tree),Kn(t,a-3,2)):a<=10?(ui(t,17,t.bl_tree),Kn(t,a-3,3)):(ui(t,18,t.bl_tree),Kn(t,a-11,7));a=0,o=i,0===s?(c=138,d=3):i===s?(c=6,d=3):(c=7,d=4)}};let Iw=!1;const Aw=(t,e,n,r)=>{Kn(t,0+(r?1:0),3),Sw(t),Vc(t,n),Vc(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n};var OW={_tr_init:t=>{Iw||((()=>{let e,n,r,i,o;const s=new Array(16);for(r=0,i=0;i<28;i++)for(Gm[i]=r,e=0;e<1<<jm[i];e++)xc[r++]=i;for(xc[r-1]=i,o=0,i=0;i<16;i++)for(Il[i]=o,e=0;e<1<<Cl[i];e++)Uc[o++]=i;for(o>>=7;i<30;i++)for(Il[i]=o<<7,e=0;e<1<<Cl[i]-7;e++)Uc[256+o++]=i;for(n=0;n<=15;n++)s[n]=0;for(e=0;e<=143;)Ni[2*e+1]=8,e++,s[8]++;for(;e<=255;)Ni[2*e+1]=9,e++,s[9]++;for(;e<=279;)Ni[2*e+1]=7,e++,s[7]++;for(;e<=287;)Ni[2*e+1]=8,e++,s[8]++;for(gw(Ni,287,s),e=0;e<30;e++)Mc[2*e+1]=5,Mc[2*e]=fw(e,5);hw=new Wm(Ni,jm,257,286,15),_w=new Wm(Mc,Cl,0,30,15),Ew=new Wm(new Array(0),yW,0,19,7)})(),Iw=!0),t.l_desc=new Hm(t.dyn_ltree,hw),t.d_desc=new Hm(t.dyn_dtree,_w),t.bl_desc=new Hm(t.bl_tree,Ew),t.bi_buf=0,t.bi_valid=0,Tw(t)},_tr_stored_block:Aw,_tr_flush_block:(t,e,n,r)=>{let i,o,s=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&0!==a.dyn_ltree[2*c])return 0;if(0!==a.dyn_ltree[18]||0!==a.dyn_ltree[20]||0!==a.dyn_ltree[26])return 1;for(c=32;c<256;c++)if(0!==a.dyn_ltree[2*c])return 1;return 0})(t)),Ym(t,t.l_desc),Ym(t,t.d_desc),s=(a=>{let c;for(yw(a,a.dyn_ltree,a.l_desc.max_code),yw(a,a.dyn_dtree,a.d_desc.max_code),Ym(a,a.bl_desc),c=18;c>=3&&0===a.bl_tree[2*pw[c]+1];c--);return a.opt_len+=3*(c+1)+5+5+4,c})(t),i=t.opt_len+3+7>>>3,o=t.static_len+3+7>>>3,o<=i&&(i=o)):i=o=n+5,n+4<=i&&-1!==e?Aw(t,e,n,r):4===t.strategy||o===i?(Kn(t,2+(r?1:0),3),vw(t,Ni,Mc)):(Kn(t,4+(r?1:0),3),((a,c,d,u)=>{let l;for(Kn(a,c-257,5),Kn(a,d-1,5),Kn(a,u-4,4),l=0;l<u;l++)Kn(a,a.bl_tree[2*pw[l]+1],3);Cw(a,a.dyn_ltree,c-1),Cw(a,a.dyn_dtree,d-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,s+1),vw(t,t.dyn_ltree,t.dyn_dtree)),Tw(t),r&&Sw(t)},_tr_tally:(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,0===e?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(xc[n]+256+1)]++,t.dyn_dtree[2*mw(e)]++),t.sym_next===t.sym_end),_tr_align:t=>{var e;Kn(t,2,3),ui(t,256,Ni),16===(e=t).bi_valid?(Vc(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}},Fc=(t,e,n,r)=>{let i=65535&t,o=t>>>16&65535,s=0;for(;0!==n;){s=n>2e3?2e3:n,n-=s;do{i=i+e[r++]|0,o=o+i|0}while(--s);i%=65521,o%=65521}return i|o<<16};const wW=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var r=0;r<8;r++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})());var pn=(t,e,n,r)=>{const i=wW,o=r+n;t^=-1;for(let s=r;s<o;s++)t=t>>>8^i[255&(t^e[s])];return~t},Zo={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Ta={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:NW,_tr_stored_block:qm,_tr_flush_block:DW,_tr_tally:_o,_tr_align:PW}=OW,{Z_NO_FLUSH:Eo,Z_PARTIAL_FLUSH:LW,Z_FULL_FLUSH:kW,Z_FINISH:br,Z_BLOCK:bw,Z_OK:mn,Z_STREAM_END:Ow,Z_STREAM_ERROR:li,Z_DATA_ERROR:MW,Z_BUF_ERROR:zm,Z_DEFAULT_COMPRESSION:UW,Z_FILTERED:xW,Z_HUFFMAN_ONLY:Al,Z_RLE:VW,Z_FIXED:FW,Z_DEFAULT_STRATEGY:BW,Z_UNKNOWN:jW,Z_DEFLATED:bl}=Ta,pi=262,es=(t,e)=>(t.msg=Zo[e],e),ww=t=>2*t-(t>4?9:0),mo=t=>{let e=t.length;for(;--e>=0;)t[e]=0},YW=t=>{let e,n,r,i=t.w_size;e=t.hash_size,r=e;do{n=t.head[--r],t.head[r]=n>=i?n-i:0}while(--e);e=i,r=e;do{n=t.prev[--r],t.prev[r]=n>=i?n-i:0}while(--e)};let fo=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask;const or=t=>{const e=t.state;let n=e.pending;n>t.avail_out&&(n=t.avail_out),0!==n&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,0===e.pending&&(e.pending_out=0))},sr=(t,e)=>{DW(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,or(t.strm)},se=(t,e)=>{t.pending_buf[t.pending++]=e},jc=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},Xm=(t,e,n,r)=>{let i=t.avail_in;return i>r&&(i=r),0===i?0:(t.avail_in-=i,e.set(t.input.subarray(t.next_in,t.next_in+i),n),1===t.state.wrap?t.adler=Fc(t.adler,e,i,n):2===t.state.wrap&&(t.adler=pn(t.adler,e,i,n)),t.next_in+=i,t.total_in+=i,i)},Nw=(t,e)=>{let n,r,i=t.max_chain_length,o=t.strstart,s=t.prev_length,a=t.nice_match;const c=t.strstart>t.w_size-pi?t.strstart-(t.w_size-pi):0,d=t.window,u=t.w_mask,l=t.prev,p=t.strstart+258;let h=d[o+s-1],S=d[o+s];t.prev_length>=t.good_match&&(i>>=2),a>t.lookahead&&(a=t.lookahead);do{if(n=e,d[n+s]===S&&d[n+s-1]===h&&d[n]===d[o]&&d[++n]===d[o+1]){o+=2,n++;do{}while(d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&d[++o]===d[++n]&&o<p);if(r=258-(p-o),o=p-258,r>s){if(t.match_start=e,s=r,r>=a)break;h=d[o+s-1],S=d[o+s]}}}while((e=l[e&u])>c&&0!=--i);return s<=t.lookahead?s:t.lookahead},Ra=t=>{const e=t.w_size;let n,r,i;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-pi)&&(t.window.set(t.window.subarray(e,e+e-r),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),YW(t),r+=e),0===t.strm.avail_in)break;if(n=Xm(t.strm,t.window,t.strstart+t.lookahead,r),t.lookahead+=n,t.lookahead+t.insert>=3)for(i=t.strstart-t.insert,t.ins_h=t.window[i],t.ins_h=fo(t,t.ins_h,t.window[i+1]);t.insert&&(t.ins_h=fo(t,t.ins_h,t.window[i+3-1]),t.prev[i&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=i,i++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<pi&&0!==t.strm.avail_in)},Dw=(t,e)=>{let n,r,i,o=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,s=0,a=t.strm.avail_in;do{if(n=65535,i=t.bi_valid+42>>3,t.strm.avail_out<i||(i=t.strm.avail_out-i,r=t.strstart-t.block_start,n>r+t.strm.avail_in&&(n=r+t.strm.avail_in),n>i&&(n=i),n<o&&(0===n&&e!==br||e===Eo||n!==r+t.strm.avail_in)))break;s=e===br&&n===r+t.strm.avail_in?1:0,qm(t,0,0,s),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,or(t.strm),r&&(r>n&&(r=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+r),t.strm.next_out),t.strm.next_out+=r,t.strm.avail_out-=r,t.strm.total_out+=r,t.block_start+=r,n-=r),n&&(Xm(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(0===s);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),s?4:e!==Eo&&e!==br&&0===t.strm.avail_in&&t.strstart===t.block_start?2:(i=t.window_size-t.strstart,t.strm.avail_in>i&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,i+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),i>t.strm.avail_in&&(i=t.strm.avail_in),i&&(Xm(t.strm,t.window,t.strstart,i),t.strstart+=i,t.insert+=i>t.w_size-t.insert?t.w_size-t.insert:i),t.high_water<t.strstart&&(t.high_water=t.strstart),i=t.bi_valid+42>>3,i=t.pending_buf_size-i>65535?65535:t.pending_buf_size-i,o=i>t.w_size?t.w_size:i,r=t.strstart-t.block_start,(r>=o||(r||e===br)&&e!==Eo&&0===t.strm.avail_in&&r<=i)&&(n=r>i?i:r,s=e===br&&0===t.strm.avail_in&&n===r?1:0,qm(t,t.block_start,n,s),t.block_start+=n,or(t.strm)),s?3:1)},Qm=(t,e)=>{let n,r;for(;;){if(t.lookahead<pi){if(Ra(t),t.lookahead<pi&&e===Eo)return 1;if(0===t.lookahead)break}if(n=0,t.lookahead>=3&&(t.ins_h=fo(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==n&&t.strstart-n<=t.w_size-pi&&(t.match_length=Nw(t,n)),t.match_length>=3)if(r=_o(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=fo(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=fo(t,t.ins_h,t.window[t.strstart+1]);else r=_o(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(r&&(sr(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,e===br?(sr(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(sr(t,!1),0===t.strm.avail_out)?1:2},va=(t,e)=>{let n,r,i;for(;;){if(t.lookahead<pi){if(Ra(t),t.lookahead<pi&&e===Eo)return 1;if(0===t.lookahead)break}if(n=0,t.lookahead>=3&&(t.ins_h=fo(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==n&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-pi&&(t.match_length=Nw(t,n),t.match_length<=5&&(t.strategy===xW||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){i=t.strstart+t.lookahead-3,r=_o(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=i&&(t.ins_h=fo(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,r&&(sr(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if(r=_o(t,0,t.window[t.strstart-1]),r&&sr(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(r=_o(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===br?(sr(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(sr(t,!1),0===t.strm.avail_out)?1:2};function hi(t,e,n,r,i){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=r,this.func=i}const Gc=[new hi(0,0,0,0,Dw),new hi(4,4,8,4,Qm),new hi(4,5,16,8,Qm),new hi(4,6,32,32,Qm),new hi(4,4,16,16,va),new hi(8,16,32,32,va),new hi(8,16,128,128,va),new hi(8,32,128,256,va),new hi(32,128,258,1024,va),new hi(32,258,258,4096,va)];function qW(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=bl,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),mo(this.dyn_ltree),mo(this.dyn_dtree),mo(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),mo(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),mo(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Wc=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||42!==e.status&&57!==e.status&&69!==e.status&&73!==e.status&&91!==e.status&&103!==e.status&&113!==e.status&&666!==e.status?1:0},Pw=t=>{if(Wc(t))return es(t,li);t.total_in=t.total_out=0,t.data_type=jW;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=2===e.wrap?57:e.wrap?42:113,t.adler=2===e.wrap?0:1,e.last_flush=-2,NW(e),mn},Lw=t=>{const e=Pw(t);return e===mn&&((n=t.state).window_size=2*n.w_size,mo(n.head),n.max_lazy_match=Gc[n.level].max_lazy,n.good_match=Gc[n.level].good_length,n.nice_match=Gc[n.level].nice_length,n.max_chain_length=Gc[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0),e;var n},kw=(t,e,n,r,i,o)=>{if(!t)return li;let s=1;if(e===UW&&(e=6),r<0?(s=0,r=-r):r>15&&(s=2,r-=16),i<1||i>9||n!==bl||r<8||r>15||e<0||e>9||o<0||o>FW||8===r&&1!==s)return es(t,li);8===r&&(r=9);const a=new qW;return t.state=a,a.strm=t,a.status=42,a.wrap=s,a.gzhead=null,a.w_bits=r,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=i+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<i+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=o,a.method=n,Lw(t)};var Hc={deflateInit:(t,e)=>kw(t,e,bl,15,8,BW),deflateInit2:kw,deflateReset:Lw,deflateResetKeep:Pw,deflateSetHeader:(t,e)=>Wc(t)||2!==t.state.wrap?li:(t.state.gzhead=e,mn),deflate:(t,e)=>{if(Wc(t)||e>bw||e<0)return t?es(t,li):li;const n=t.state;if(!t.output||0!==t.avail_in&&!t.input||666===n.status&&e!==br)return es(t,0===t.avail_out?zm:li);const r=n.last_flush;if(n.last_flush=e,0!==n.pending){if(or(t),0===t.avail_out)return n.last_flush=-1,mn}else if(0===t.avail_in&&ww(e)<=ww(r)&&e!==br)return es(t,zm);if(666===n.status&&0!==t.avail_in)return es(t,zm);if(42===n.status&&0===n.wrap&&(n.status=113),42===n.status){let i=bl+(n.w_bits-8<<4)<<8,o=-1;if(o=n.strategy>=Al||n.level<2?0:n.level<6?1:6===n.level?2:3,i|=o<<6,0!==n.strstart&&(i|=32),i+=31-i%31,jc(n,i),0!==n.strstart&&(jc(n,t.adler>>>16),jc(n,65535&t.adler)),t.adler=1,n.status=113,or(t),0!==n.pending)return n.last_flush=-1,mn}if(57===n.status)if(t.adler=0,se(n,31),se(n,139),se(n,8),n.gzhead)se(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),se(n,255&n.gzhead.time),se(n,n.gzhead.time>>8&255),se(n,n.gzhead.time>>16&255),se(n,n.gzhead.time>>24&255),se(n,9===n.level?2:n.strategy>=Al||n.level<2?4:0),se(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(se(n,255&n.gzhead.extra.length),se(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=pn(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(se(n,0),se(n,0),se(n,0),se(n,0),se(n,0),se(n,9===n.level?2:n.strategy>=Al||n.level<2?4:0),se(n,3),n.status=113,or(t),0!==n.pending)return n.last_flush=-1,mn;if(69===n.status){if(n.gzhead.extra){let i=n.pending,o=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+o>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>i&&(t.adler=pn(t.adler,n.pending_buf,n.pending-i,i)),n.gzindex+=a,or(t),0!==n.pending)return n.last_flush=-1,mn;i=0,o-=a}let s=new Uint8Array(n.gzhead.extra);n.pending_buf.set(s.subarray(n.gzindex,n.gzindex+o),n.pending),n.pending+=o,n.gzhead.hcrc&&n.pending>i&&(t.adler=pn(t.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=73}if(73===n.status){if(n.gzhead.name){let i,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=pn(t.adler,n.pending_buf,n.pending-o,o)),or(t),0!==n.pending)return n.last_flush=-1,mn;o=0}i=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,se(n,i)}while(0!==i);n.gzhead.hcrc&&n.pending>o&&(t.adler=pn(t.adler,n.pending_buf,n.pending-o,o)),n.gzindex=0}n.status=91}if(91===n.status){if(n.gzhead.comment){let i,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(t.adler=pn(t.adler,n.pending_buf,n.pending-o,o)),or(t),0!==n.pending)return n.last_flush=-1,mn;o=0}i=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,se(n,i)}while(0!==i);n.gzhead.hcrc&&n.pending>o&&(t.adler=pn(t.adler,n.pending_buf,n.pending-o,o))}n.status=103}if(103===n.status){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(or(t),0!==n.pending))return n.last_flush=-1,mn;se(n,255&t.adler),se(n,t.adler>>8&255),t.adler=0}if(n.status=113,or(t),0!==n.pending)return n.last_flush=-1,mn}if(0!==t.avail_in||0!==n.lookahead||e!==Eo&&666!==n.status){let i=0===n.level?Dw(n,e):n.strategy===Al?((o,s)=>{let a;for(;;){if(0===o.lookahead&&(Ra(o),0===o.lookahead)){if(s===Eo)return 1;break}if(o.match_length=0,a=_o(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,a&&(sr(o,!1),0===o.strm.avail_out))return 1}return o.insert=0,s===br?(sr(o,!0),0===o.strm.avail_out?3:4):o.sym_next&&(sr(o,!1),0===o.strm.avail_out)?1:2})(n,e):n.strategy===VW?((o,s)=>{let a,c,d,u;const l=o.window;for(;;){if(o.lookahead<=258){if(Ra(o),o.lookahead<=258&&s===Eo)return 1;if(0===o.lookahead)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(d=o.strstart-1,c=l[d],c===l[++d]&&c===l[++d]&&c===l[++d])){u=o.strstart+258;do{}while(c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&c===l[++d]&&d<u);o.match_length=258-(u-d),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=3?(a=_o(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(a=_o(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),a&&(sr(o,!1),0===o.strm.avail_out))return 1}return o.insert=0,s===br?(sr(o,!0),0===o.strm.avail_out?3:4):o.sym_next&&(sr(o,!1),0===o.strm.avail_out)?1:2})(n,e):Gc[n.level].func(n,e);if(3!==i&&4!==i||(n.status=666),1===i||3===i)return 0===t.avail_out&&(n.last_flush=-1),mn;if(2===i&&(e===LW?PW(n):e!==bw&&(qm(n,0,0,!1),e===kW&&(mo(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),or(t),0===t.avail_out))return n.last_flush=-1,mn}return e!==br?mn:n.wrap<=0?Ow:(2===n.wrap?(se(n,255&t.adler),se(n,t.adler>>8&255),se(n,t.adler>>16&255),se(n,t.adler>>24&255),se(n,255&t.total_in),se(n,t.total_in>>8&255),se(n,t.total_in>>16&255),se(n,t.total_in>>24&255)):(jc(n,t.adler>>>16),jc(n,65535&t.adler)),or(t),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?mn:Ow)},deflateEnd:t=>{if(Wc(t))return li;const e=t.state.status;return t.state=null,113===e?es(t,MW):mn},deflateSetDictionary:(t,e)=>{let n=e.length;if(Wc(t))return li;const r=t.state,i=r.wrap;if(2===i||1===i&&42!==r.status||r.lookahead)return li;if(1===i&&(t.adler=Fc(t.adler,e,n,0)),r.wrap=0,n>=r.w_size){0===i&&(mo(r.head),r.strstart=0,r.block_start=0,r.insert=0);let c=new Uint8Array(r.w_size);c.set(e.subarray(n-r.w_size,n),0),e=c,n=r.w_size}const o=t.avail_in,s=t.next_in,a=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,Ra(r);r.lookahead>=3;){let c=r.strstart,d=r.lookahead-2;do{r.ins_h=fo(r,r.ins_h,r.window[c+3-1]),r.prev[c&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=c,c++}while(--d);r.strstart=c,r.lookahead=2,Ra(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,t.next_in=s,t.input=a,t.avail_in=o,r.wrap=i,mn},deflateInfo:"pako deflate (from Nodeca project)"};const XW=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var Ol={assign:function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const n=e.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(const r in n)XW(n,r)&&(t[r]=n[r])}}return t},flattenChunks:t=>{let e=0;for(let r=0,i=t.length;r<i;r++)e+=t[r].length;const n=new Uint8Array(e);for(let r=0,i=0,o=t.length;r<o;r++){let s=t[r];n.set(s,i),i+=s.length}return n}};let Mw=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Mw=!1}const Kc=new Uint8Array(256);for(let t=0;t<256;t++)Kc[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;Kc[254]=Kc[254]=1;var Yc={string2buf:t=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(t);let e,n,r,i,o,s=t.length,a=0;for(i=0;i<s;i++)n=t.charCodeAt(i),55296==(64512&n)&&i+1<s&&(r=t.charCodeAt(i+1),56320==(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(a),o=0,i=0;o<a;i++)n=t.charCodeAt(i),55296==(64512&n)&&i+1<s&&(r=t.charCodeAt(i+1),56320==(64512&r)&&(n=65536+(n-55296<<10)+(r-56320),i++)),n<128?e[o++]=n:n<2048?(e[o++]=192|n>>>6,e[o++]=128|63&n):n<65536?(e[o++]=224|n>>>12,e[o++]=128|n>>>6&63,e[o++]=128|63&n):(e[o++]=240|n>>>18,e[o++]=128|n>>>12&63,e[o++]=128|n>>>6&63,e[o++]=128|63&n);return e},buf2string:(t,e)=>{const n=e||t.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(t.subarray(0,e));let r,i;const o=new Array(2*n);for(i=0,r=0;r<n;){let s=t[r++];if(s<128){o[i++]=s;continue}let a=Kc[s];if(a>4)o[i++]=65533,r+=a-1;else{for(s&=2===a?31:3===a?15:7;a>1&&r<n;)s=s<<6|63&t[r++],a--;a>1?o[i++]=65533:s<65536?o[i++]=s:(s-=65536,o[i++]=55296|s>>10&1023,o[i++]=56320|1023&s)}}return((s,a)=>{if(a<65534&&s.subarray&&Mw)return String.fromCharCode.apply(null,s.length===a?s:s.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(s[d]);return c})(o,i)},utf8border:(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&128==(192&t[n]);)n--;return n<0||0===n?e:n+Kc[t[n]]>e?n:e}},Uw=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const xw=Object.prototype.toString,{Z_NO_FLUSH:QW,Z_SYNC_FLUSH:ZW,Z_FULL_FLUSH:$W,Z_FINISH:t5,Z_OK:wl,Z_STREAM_END:e5,Z_DEFAULT_COMPRESSION:n5,Z_DEFAULT_STRATEGY:r5,Z_DEFLATED:i5}=Ta;function qc(t){this.options=Ol.assign({level:n5,method:i5,chunkSize:16384,windowBits:15,memLevel:8,strategy:r5},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Uw,this.strm.avail_out=0;let n=Hc.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==wl)throw new Error(Zo[n]);if(e.header&&Hc.deflateSetHeader(this.strm,e.header),e.dictionary){let r;if(r="string"==typeof e.dictionary?Yc.string2buf(e.dictionary):"[object ArrayBuffer]"===xw.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,n=Hc.deflateSetDictionary(this.strm,r),n!==wl)throw new Error(Zo[n]);this._dict_set=!0}}function Zm(t,e){const n=new qc(e);if(n.push(t,!0),n.err)throw n.msg||Zo[n.err];return n.result}qc.prototype.push=function(t,e){const n=this.strm,r=this.options.chunkSize;let i,o;if(this.ended)return!1;for(o=e===~~e?e:!0===e?t5:QW,n.input="string"==typeof t?Yc.string2buf(t):"[object ArrayBuffer]"===xw.call(t)?new Uint8Array(t):t,n.next_in=0,n.avail_in=n.input.length;;)if(0===n.avail_out&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),(o===ZW||o===$W)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(i=Hc.deflate(n,o),i===e5)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),i=Hc.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===wl;if(0!==n.avail_out){if(o>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(0===n.avail_in)break}else this.onData(n.output)}return!0},qc.prototype.onData=function(t){this.chunks.push(t)},qc.prototype.onEnd=function(t){t===wl&&(this.result=Ol.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var o5={Deflate:qc,deflate:Zm,deflateRaw:function(t,e){return(e=e||{}).raw=!0,Zm(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,Zm(t,e)},constants:Ta};const Nl=16209;var s5=function(t,e){let n,r,i,o,s,a,c,d,u,l,p,h,S,m,f,g,R,C,b,w,D,V,U,k;const Z=t.state;n=t.next_in,U=t.input,r=n+(t.avail_in-5),i=t.next_out,k=t.output,o=i-(e-t.avail_out),s=i+(t.avail_out-257),a=Z.dmax,c=Z.wsize,d=Z.whave,u=Z.wnext,l=Z.window,p=Z.hold,h=Z.bits,S=Z.lencode,m=Z.distcode,f=(1<<Z.lenbits)-1,g=(1<<Z.distbits)-1;t:do{h<15&&(p+=U[n++]<<h,h+=8,p+=U[n++]<<h,h+=8),R=S[p&f];e:for(;;){if(C=R>>>24,p>>>=C,h-=C,C=R>>>16&255,0===C)k[i++]=65535&R;else{if(!(16&C)){if(!(64&C)){R=S[(65535&R)+(p&(1<<C)-1)];continue e}if(32&C){Z.mode=16191;break t}t.msg="invalid literal/length code",Z.mode=Nl;break t}b=65535&R,C&=15,C&&(h<C&&(p+=U[n++]<<h,h+=8),b+=p&(1<<C)-1,p>>>=C,h-=C),h<15&&(p+=U[n++]<<h,h+=8,p+=U[n++]<<h,h+=8),R=m[p&g];n:for(;;){if(C=R>>>24,p>>>=C,h-=C,C=R>>>16&255,!(16&C)){if(!(64&C)){R=m[(65535&R)+(p&(1<<C)-1)];continue n}t.msg="invalid distance code",Z.mode=Nl;break t}if(w=65535&R,C&=15,h<C&&(p+=U[n++]<<h,h+=8,h<C&&(p+=U[n++]<<h,h+=8)),w+=p&(1<<C)-1,w>a){t.msg="invalid distance too far back",Z.mode=Nl;break t}if(p>>>=C,h-=C,C=i-o,w>C){if(C=w-C,C>d&&Z.sane){t.msg="invalid distance too far back",Z.mode=Nl;break t}if(D=0,V=l,0===u){if(D+=c-C,C<b){b-=C;do{k[i++]=l[D++]}while(--C);D=i-w,V=k}}else if(u<C){if(D+=c+u-C,C-=u,C<b){b-=C;do{k[i++]=l[D++]}while(--C);if(D=0,u<b){C=u,b-=C;do{k[i++]=l[D++]}while(--C);D=i-w,V=k}}}else if(D+=u-C,C<b){b-=C;do{k[i++]=l[D++]}while(--C);D=i-w,V=k}for(;b>2;)k[i++]=V[D++],k[i++]=V[D++],k[i++]=V[D++],b-=3;b&&(k[i++]=V[D++],b>1&&(k[i++]=V[D++]))}else{D=i-w;do{k[i++]=k[D++],k[i++]=k[D++],k[i++]=k[D++],b-=3}while(b>2);b&&(k[i++]=k[D++],b>1&&(k[i++]=k[D++]))}break}}break}}while(n<r&&i<s);b=h>>3,n-=b,h-=b<<3,p&=(1<<h)-1,t.next_in=n,t.next_out=i,t.avail_in=n<r?r-n+5:5-(n-r),t.avail_out=i<s?s-i+257:257-(i-s),Z.hold=p,Z.bits=h};const a5=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),c5=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),d5=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),u5=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var zc=(t,e,n,r,i,o,s,a)=>{const c=a.bits;let d,u,l,p,h,S,m=0,f=0,g=0,R=0,C=0,b=0,w=0,D=0,V=0,U=0,k=null;const Z=new Uint16Array(16),$=new Uint16Array(16);let Rt,Nt,oe,Yt=null;for(m=0;m<=15;m++)Z[m]=0;for(f=0;f<r;f++)Z[e[n+f]]++;for(C=c,R=15;R>=1&&0===Z[R];R--);if(C>R&&(C=R),0===R)return i[o++]=20971520,i[o++]=20971520,a.bits=1,0;for(g=1;g<R&&0===Z[g];g++);for(C<g&&(C=g),D=1,m=1;m<=15;m++)if(D<<=1,D-=Z[m],D<0)return-1;if(D>0&&(0===t||1!==R))return-1;for($[1]=0,m=1;m<15;m++)$[m+1]=$[m]+Z[m];for(f=0;f<r;f++)0!==e[n+f]&&(s[$[e[n+f]]++]=f);if(0===t?(k=Yt=s,S=20):1===t?(k=a5,Yt=c5,S=257):(k=d5,Yt=u5,S=0),U=0,f=0,m=g,h=o,b=C,w=0,l=-1,V=1<<C,p=V-1,1===t&&V>852||2===t&&V>592)return 1;for(;;){Rt=m-w,s[f]+1<S?(Nt=0,oe=s[f]):s[f]>=S?(Nt=Yt[s[f]-S],oe=k[s[f]-S]):(Nt=96,oe=0),d=1<<m-w,u=1<<b,g=u;do{u-=d,i[h+(U>>w)+u]=Rt<<24|Nt<<16|oe}while(0!==u);for(d=1<<m-1;U&d;)d>>=1;if(0!==d?(U&=d-1,U+=d):U=0,f++,0==--Z[m]){if(m===R)break;m=e[n+s[f]]}if(m>C&&(U&p)!==l){for(0===w&&(w=C),h+=g,b=m-w,D=1<<b;b+w<R&&(D-=Z[b+w],!(D<=0));)b++,D<<=1;if(V+=1<<b,1===t&&V>852||2===t&&V>592)return 1;l=U&p,i[l]=C<<24|b<<16|h-o}}return 0!==U&&(i[h+U]=m-w<<24|64<<16),a.bits=C,0};const{Z_FINISH:Vw,Z_BLOCK:l5,Z_TREES:Pl,Z_OK:ns,Z_STREAM_END:p5,Z_NEED_DICT:h5,Z_STREAM_ERROR:Or,Z_DATA_ERROR:Fw,Z_MEM_ERROR:Bw,Z_BUF_ERROR:_5,Z_DEFLATED:jw}=Ta,Ll=16180,kl=16190,Di=16191,Ml=16199,Ul=16200,Pe=16209,Gw=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function E5(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const rs=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<Ll||e.mode>16211?1:0},Ww=t=>{if(rs(t))return Or;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=Ll,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,ns},Hw=t=>{if(rs(t))return Or;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,Ww(t)},Kw=(t,e)=>{let n;if(rs(t))return Or;const r=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?Or:(null!==r.window&&r.wbits!==e&&(r.window=null),r.wrap=n,r.wbits=e,Hw(t))},Yw=(t,e)=>{if(!t)return Or;const n=new E5;t.state=n,n.strm=t,n.window=null,n.mode=Ll;const r=Kw(t,e);return r!==ns&&(t.state=null),r};let nf,rf,qw=!0;const m5=t=>{if(qw){nf=new Int32Array(512),rf=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(zc(1,t.lens,0,288,nf,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;zc(2,t.lens,0,32,rf,0,t.work,{bits:5}),qw=!1}t.lencode=nf,t.lenbits=9,t.distcode=rf,t.distbits=5},zw=(t,e,n,r)=>{let i;const o=t.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),r>=o.wsize?(o.window.set(e.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(i=o.wsize-o.wnext,i>r&&(i=r),o.window.set(e.subarray(n-r,n-r+i),o.wnext),(r-=i)?(o.window.set(e.subarray(n-r,n),0),o.wnext=r,o.whave=o.wsize):(o.wnext+=i,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=i))),0};var Pi={inflateReset:Hw,inflateReset2:Kw,inflateResetKeep:Ww,inflateInit:t=>Yw(t,15),inflateInit2:Yw,inflate:(t,e)=>{let n,r,i,o,s,a,c,d,u,l,p,h,S,m,f,g,R,C,b,w,D,V,U=0;const k=new Uint8Array(4);let Z,$;const Rt=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(rs(t)||!t.output||!t.input&&0!==t.avail_in)return Or;n=t.state,n.mode===Di&&(n.mode=16192),s=t.next_out,i=t.output,c=t.avail_out,o=t.next_in,r=t.input,a=t.avail_in,d=n.hold,u=n.bits,l=a,p=c,V=ns;t:for(;;)switch(n.mode){case Ll:if(0===n.wrap){n.mode=16192;break}for(;u<16;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(2&n.wrap&&35615===d){0===n.wbits&&(n.wbits=15),n.check=0,k[0]=255&d,k[1]=d>>>8&255,n.check=pn(n.check,k,2,0),d=0,u=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){t.msg="incorrect header check",n.mode=Pe;break}if((15&d)!==jw){t.msg="unknown compression method",n.mode=Pe;break}if(d>>>=4,u-=4,D=8+(15&d),0===n.wbits&&(n.wbits=D),D>15||D>n.wbits){t.msg="invalid window size",n.mode=Pe;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&d?16189:Di,d=0,u=0;break;case 16181:for(;u<16;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(n.flags=d,(255&rn(n))!==jw){t.msg="unknown compression method",n.mode=Pe;break}if(57344&rn(n)){t.msg="unknown header flags set",n.mode=Pe;break}n.head&&(n.head.text=d>>8&1),512&rn(n)&&4&n.wrap&&(k[0]=255&d,k[1]=d>>>8&255,n.check=pn(n.check,k,2,0)),d=0,u=0,n.mode=16182;case 16182:for(;u<32;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}n.head&&(n.head.time=d),512&rn(n)&&4&n.wrap&&(k[0]=255&d,k[1]=d>>>8&255,k[2]=d>>>16&255,k[3]=d>>>24&255,n.check=pn(n.check,k,4,0)),d=0,u=0,n.mode=16183;case 16183:for(;u<16;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&rn(n)&&4&n.wrap&&(k[0]=255&d,k[1]=d>>>8&255,n.check=pn(n.check,k,2,0)),d=0,u=0,n.mode=16184;case 16184:if(1024&rn(n)){for(;u<16;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}n.length=d,n.head&&(n.head.extra_len=d),512&rn(n)&&4&n.wrap&&(k[0]=255&d,k[1]=d>>>8&255,n.check=pn(n.check,k,2,0)),d=0,u=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&rn(n)&&(h=n.length,h>a&&(h=a),h&&(n.head&&(D=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(r.subarray(o,o+h),D)),512&rn(n)&&4&n.wrap&&(n.check=pn(n.check,r,h,o)),a-=h,o+=h,n.length-=h),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&rn(n)){if(0===a)break t;h=0;do{D=r[o+h++],n.head&&D&&n.length<65536&&(n.head.name+=String.fromCharCode(D))}while(D&&h<a);if(512&rn(n)&&4&n.wrap&&(n.check=pn(n.check,r,h,o)),a-=h,o+=h,D)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&rn(n)){if(0===a)break t;h=0;do{D=r[o+h++],n.head&&D&&n.length<65536&&(n.head.comment+=String.fromCharCode(D))}while(D&&h<a);if(512&rn(n)&&4&n.wrap&&(n.check=pn(n.check,r,h,o)),a-=h,o+=h,D)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&rn(n)){for(;u<16;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(4&n.wrap&&d!==(65535&n.check)){t.msg="header crc mismatch",n.mode=Pe;break}d=0,u=0}n.head&&(n.head.hcrc=rn(n)>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=Di;break;case 16189:for(;u<32;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}t.adler=n.check=Gw(d),d=0,u=0,n.mode=kl;case kl:if(0===n.havedict)return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=u,h5;t.adler=n.check=1,n.mode=Di;case Di:if(e===l5||e===Pl)break t;case 16192:if(n.last){d>>>=7&u,u-=7&u,n.mode=16206;break}for(;u<3;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}switch(n.last=1&d,d>>>=1,u-=1,3&d){case 0:n.mode=16193;break;case 1:if(m5(n),n.mode=Ml,e===Pl){d>>>=2,u-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=Pe}d>>>=2,u-=2;break;case 16193:for(d>>>=7&u,u-=7&u;u<32;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if((65535&d)!=(d>>>16^65535)){t.msg="invalid stored block lengths",n.mode=Pe;break}if(n.length=65535&d,d=0,u=0,n.mode=16194,e===Pl)break t;case 16194:n.mode=16195;case 16195:if(h=n.length,h){if(h>a&&(h=a),h>c&&(h=c),0===h)break t;i.set(r.subarray(o,o+h),s),a-=h,o+=h,c-=h,s+=h,n.length-=h;break}n.mode=Di;break;case 16196:for(;u<14;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(n.nlen=257+(31&d),d>>>=5,u-=5,n.ndist=1+(31&d),d>>>=5,u-=5,n.ncode=4+(15&d),d>>>=4,u-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=Pe;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;u<3;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}n.lens[Rt[n.have++]]=7&d,d>>>=3,u-=3}for(;n.have<19;)n.lens[Rt[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,Z={bits:n.lenbits},V=zc(0,n.lens,0,19,n.lencode,0,n.work,Z),n.lenbits=Z.bits,V){t.msg="invalid code lengths set",n.mode=Pe;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;U=n.lencode[d&(1<<n.lenbits)-1],f=U>>>24,g=U>>>16&255,R=65535&U,!(f<=u);){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(R<16)d>>>=f,u-=f,n.lens[n.have++]=R;else{if(16===R){for($=f+2;u<$;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(d>>>=f,u-=f,0===n.have){t.msg="invalid bit length repeat",n.mode=Pe;break}D=n.lens[n.have-1],h=3+(3&d),d>>>=2,u-=2}else if(17===R){for($=f+3;u<$;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}d>>>=f,u-=f,D=0,h=3+(7&d),d>>>=3,u-=3}else{for($=f+7;u<$;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}d>>>=f,u-=f,D=0,h=11+(127&d),d>>>=7,u-=7}if(n.have+h>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=Pe;break}for(;h--;)n.lens[n.have++]=D}}if(n.mode===Pe)break;if(0===n.lens[256]){t.msg="invalid code -- missing end-of-block",n.mode=Pe;break}if(n.lenbits=9,Z={bits:n.lenbits},V=zc(1,n.lens,0,n.nlen,n.lencode,0,n.work,Z),n.lenbits=Z.bits,V){t.msg="invalid literal/lengths set",n.mode=Pe;break}if(n.distbits=6,n.distcode=n.distdyn,Z={bits:n.distbits},V=zc(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,Z),n.distbits=Z.bits,V){t.msg="invalid distances set",n.mode=Pe;break}if(n.mode=Ml,e===Pl)break t;case Ml:n.mode=Ul;case Ul:if(a>=6&&c>=258){t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=u,s5(t,p),s=t.next_out,i=t.output,c=t.avail_out,o=t.next_in,r=t.input,a=t.avail_in,d=n.hold,u=n.bits,n.mode===Di&&(n.back=-1);break}for(n.back=0;U=n.lencode[d&(1<<n.lenbits)-1],f=U>>>24,g=U>>>16&255,R=65535&U,!(f<=u);){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(g&&!(240&g)){for(C=f,b=g,w=R;U=n.lencode[w+((d&(1<<C+b)-1)>>C)],f=U>>>24,g=U>>>16&255,R=65535&U,!(C+f<=u);){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}d>>>=C,u-=C,n.back+=C}if(d>>>=f,u-=f,n.back+=f,n.length=R,0===g){n.mode=16205;break}if(32&g){n.back=-1,n.mode=Di;break}if(64&g){t.msg="invalid literal/length code",n.mode=Pe;break}n.extra=15&g,n.mode=16201;case 16201:if(n.extra){for($=n.extra;u<$;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,u-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;U=n.distcode[d&(1<<n.distbits)-1],f=U>>>24,g=U>>>16&255,R=65535&U,!(f<=u);){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(!(240&g)){for(C=f,b=g,w=R;U=n.distcode[w+((d&(1<<C+b)-1)>>C)],f=U>>>24,g=U>>>16&255,R=65535&U,!(C+f<=u);){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}d>>>=C,u-=C,n.back+=C}if(d>>>=f,u-=f,n.back+=f,64&g){t.msg="invalid distance code",n.mode=Pe;break}n.offset=R,n.extra=15&g,n.mode=16203;case 16203:if(n.extra){for($=n.extra;u<$;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,u-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=Pe;break}n.mode=16204;case 16204:if(0===c)break t;if(h=p-c,n.offset>h){if(h=n.offset-h,h>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=Pe;break}h>n.wnext?(h-=n.wnext,S=n.wsize-h):S=n.wnext-h,h>n.length&&(h=n.length),m=n.window}else m=i,S=s-n.offset,h=n.length;h>c&&(h=c),c-=h,n.length-=h;do{i[s++]=m[S++]}while(--h);0===n.length&&(n.mode=Ul);break;case 16205:if(0===c)break t;i[s++]=n.length,c--,n.mode=Ul;break;case 16206:if(n.wrap){for(;u<32;){if(0===a)break t;a--,d|=r[o++]<<u,u+=8}if(p-=c,t.total_out+=p,n.total+=p,4&n.wrap&&p&&(t.adler=n.check=rn(n)?pn(n.check,i,p,s-p):Fc(n.check,i,p,s-p)),p=c,4&n.wrap&&(rn(n)?d:Gw(d))!==n.check){t.msg="incorrect data check",n.mode=Pe;break}d=0,u=0}n.mode=16207;case 16207:if(n.wrap&&rn(n)){for(;u<32;){if(0===a)break t;a--,d+=r[o++]<<u,u+=8}if(4&n.wrap&&d!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=Pe;break}d=0,u=0}n.mode=16208;case 16208:V=p5;break t;case Pe:V=Fw;break t;case 16210:return Bw;default:return Or}return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,n.hold=d,n.bits=u,(n.wsize||p!==t.avail_out&&n.mode<Pe&&(n.mode<16206||e!==Vw))&&zw(t,t.output,t.next_out,p-t.avail_out),l-=t.avail_in,p-=t.avail_out,t.total_in+=l,t.total_out+=p,n.total+=p,4&n.wrap&&p&&(t.adler=n.check=rn(n)?pn(n.check,i,p,t.next_out-p):Fc(n.check,i,p,t.next_out-p)),t.data_type=n.bits+(n.last?64:0)+(n.mode===Di?128:0)+(n.mode===Ml||16194===n.mode?256:0),(0===l&&0===p||e===Vw)&&V===ns&&(V=_5),V},inflateEnd:t=>{if(rs(t))return Or;let e=t.state;return e.window&&(e.window=null),t.state=null,ns},inflateGetHeader:(t,e)=>{if(rs(t))return Or;const n=t.state;return 2&n.wrap?(n.head=e,e.done=!1,ns):Or},inflateSetDictionary:(t,e)=>{const n=e.length;let r,i,o;return rs(t)?Or:(r=t.state,0!==r.wrap&&r.mode!==kl?Or:r.mode===kl&&(i=1,i=Fc(i,e,n,0),i!==r.check)?Fw:(o=zw(t,e,n,n),o?(r.mode=16210,Bw):(r.havedict=1,ns)))},inflateInfo:"pako inflate (from Nodeca project)"},g5=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Jw=Object.prototype.toString,{Z_NO_FLUSH:T5,Z_FINISH:S5,Z_OK:Jc,Z_STREAM_END:of,Z_NEED_DICT:sf,Z_STREAM_ERROR:R5,Z_DATA_ERROR:Xw,Z_MEM_ERROR:v5}=Ta;function Xc(t){this.options=Ol.assign({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&!(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Uw,this.strm.avail_out=0;let n=Pi.inflateInit2(this.strm,e.windowBits);if(n!==Jc)throw new Error(Zo[n]);if(this.header=new g5,Pi.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=Yc.string2buf(e.dictionary):"[object ArrayBuffer]"===Jw.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=Pi.inflateSetDictionary(this.strm,e.dictionary),n!==Jc)))throw new Error(Zo[n])}function af(t,e){const n=new Xc(e);if(n.push(t),n.err)throw n.msg||Zo[n.err];return n.result}Xc.prototype.push=function(t,e){const n=this.strm,r=this.options.chunkSize,i=this.options.dictionary;let o,s,a;if(this.ended)return!1;for(s=e===~~e?e:!0===e?S5:T5,n.input="[object ArrayBuffer]"===Jw.call(t)?new Uint8Array(t):t,n.next_in=0,n.avail_in=n.input.length;;){for(0===n.avail_out&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),o=Pi.inflate(n,s),o===sf&&i&&(o=Pi.inflateSetDictionary(n,i),o===Jc?o=Pi.inflate(n,s):o===Xw&&(o=sf));n.avail_in>0&&o===of&&n.state.wrap>0&&0!==t[n.next_in];)Pi.inflateReset(n),o=Pi.inflate(n,s);switch(o){case R5:case Xw:case sf:case v5:return this.onEnd(o),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(0===n.avail_out||o===of))if("string"===this.options.to){let c=Yc.utf8border(n.output,n.next_out),d=n.next_out-c,u=Yc.buf2string(n.output,c);n.next_out=d,n.avail_out=r-d,d&&n.output.set(n.output.subarray(c,c+d),0),this.onData(u)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(o!==Jc||0!==a){if(o===of)return o=Pi.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===n.avail_in)break}}return!0},Xc.prototype.onData=function(t){this.chunks.push(t)},Xc.prototype.onEnd=function(t){t===Jc&&(this.result="string"===this.options.to?this.chunks.join(""):Ol.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var y5={Inflate:Xc,inflate:af,inflateRaw:function(t,e){return(e=e||{}).raw=!0,af(t,e)},ungzip:af,constants:Ta};const{deflate:C5}=o5,{inflate:I5}=y5;var A5=C5,b5=I5,Qw=function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t}(Qw||{});class O5{constructor(){T(this,"_sequence",0),T(this,"_startTime",Date.now()),T(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[{id:0,length:4,data:a.buffer}]};n.commonPacketHeader.extension=1,n.extension=d,n.payload=this.compress(e),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;A("SHOW_DATASTREAM2_LOG")&&_.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const r=new ArrayBuffer(n.commonPacketHeader.length),i=new Uint8Array(r),o=new DataView(r);let s=0;if(o.setUint16(s,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),s+=2,o.setUint32(s,n.commonPacketHeader.sequence,!0),s+=4,o.setUint16(s,n.commonStreamHeader,!0),s+=2,n.extension){const a=this.serializeExtension(n.extension);i.set(new Uint8Array(a),s),s+=a.byteLength}if(i.set(new Uint8Array(n.payload),s),s+=n.payload.byteLength,s!==n.commonPacketHeader.length)throw Error("serialize error!");return r}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const n=new DataView(e);let r=0;const i=n.getUint16(r,!0);r+=2;const o={length:16383&i,reserved:(16384&i)>>14,extension:(32768&i)>>15,sequence:n.getUint16(r+2,!0)<<16|n.getUint16(r,!0)};let s,a;if(r+=4,A("SHOW_DATASTREAM2_LOG")&&_.debug("receive data header: ".concat(JSON.stringify(o))),n.getUint16(r,!0),r+=2,o.extension){a=this.deserializeExtension(e.slice(r)),r+=2+a.length,s=e.slice(r);let c=!1;if(a.datas.length>0){const d=a.datas.find(u=>0===u.id);d&&(c=!(1&~new DataView(d.data).getUint32(0,!0)))}s=c?this.decompress(s):s}else s=e.slice(8);return s}serializeExtension(e){const{profile:n,length:r,datas:i}=e,o=new ArrayBuffer(r+2),s=new Uint8Array(o),a=new DataView(o);let c=0;if(a.setUint8(c++,n),a.setUint8(c++,r),i.forEach(d=>{n?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==r+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(r+2));return o}deserializeExtension(e){const n=new DataView(e);let r=0;const i=n.getUint8(r);r++;const o=n.getUint8(r);r++;const s=i===Qw.TWO_BYTE,a=[],c=new DataView(e,2);let d=0;for(;d<o;){let u=0,l=0,p=new ArrayBuffer(0);s?(u=c.getUint8(d),d++,l=c.getUint8(d),d++):(u=15&c.getUint8(d),l=c.getUint8(d)>>4,d++),l>0&&(p=c.buffer.slice(d+2,d+2+l),d+=p.byteLength),a.push({id:u,length:l,data:p})}if(d!==o)throw Error("parse error");return{profile:i,length:o,datas:a}}decompress(e){return b5(new Uint8Array(e))}compress(e){return A5(new Uint8Array(e))}}const w5={name:"DataStream",create:(t,e)=>{const n=e?new R3(t):new v3(t);return n.useDataStream(new O5),n}};class N5 extends Zt{constructor(e,n,r){super(),T(this,"ws",void 0),T(this,"requestId",1),T(this,"heartBeatTimer",void 0),T(this,"joinInfo",void 0),T(this,"clientId",void 0),T(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),T(this,"onClose",i=>{this.emit("close"),this.dispose()}),T(this,"onMessage",i=>{const o=JSON.parse(i.data);if(!o||"serverResponse"!==o.command||!o.requestId)return o&&"serverStatus"===o.command&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=e,this.clientId=n,this.ws=new uc("cross-channel-".concat(this.clientId),r),this.ws.on(ct.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(ct.CONNECTED,this.onOpen),this.ws.on(ct.ON_MESSAGE,this.onMessage),this.ws.on(ct.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const n=this.requestId++;return e.requestId=n,e.seq=n,this.ws.sendMessage(e),n}waitStatus(e){return new H((n,r)=>{const i=window.setTimeout(()=>{r(new N(v.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,o=>{window.clearTimeout(i),o.state&&0!==o.state?r(new N(v.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):n(void 0)}),this.once("dispose",()=>{window.clearTimeout(i),r(new N(v.WS_ABORT))})})}request(e){var n=this;return y(function*(){if("closed"===n.ws.state)throw new N(v.WS_DISCONNECT);"connected"!==n.ws.state&&(yield new H((a,c)=>{n.ws.once(ct.CLOSED,()=>c(new N(v.WS_ABORT))),n.ws.once(ct.CONNECTED,a)}));const i=n.sendMessage(e),o=new H((a,c)=>{const d=()=>{c(new N(v.WS_ABORT))};n.ws.once(ct.RECONNECTING,d),n.ws.once(ct.CLOSED,d),n.once("req_".concat(i),a),Me(3e3).then(()=>{n.removeAllListeners("req_".concat(i)),n.ws.off(ct.RECONNECTING,d),n.ws.off(ct.CLOSED,d),c(new N(v.TIMEOUT,"cross channel ws request timeout"))})}),s=yield o;if(!s||200!==s.code)throw new N(v.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s})()}connect(e){var n=this;return y(function*(){n.ws.removeAllListeners(ct.REQUEST_NEW_URLS),n.ws.on(ct.REQUEST_NEW_URLS,r=>{r(e)}),yield n.ws.init(e)})()}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const n=this.requestId++;return e.requestId=n,this.ws.sendMessage(e),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class D5 extends Zt{set state(e){e!==this._state&&(e!==gn.RELAY_STATE_FAILURE&&(this.errorCode=Bs.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,n,r,i,o){var s;super(),s=this,T(this,"joinInfo",void 0),T(this,"sid",void 0),T(this,"clientId",void 0),T(this,"cancelToken",hn.CancelToken.source()),T(this,"workerToken",void 0),T(this,"requestId",0),T(this,"signal",void 0),T(this,"prevChannelMediaConfig",void 0),T(this,"httpRetryConfig",void 0),T(this,"_resolution",void 0),T(this,"_state",gn.RELAY_STATE_IDLE),T(this,"errorCode",Bs.RELAY_OK),T(this,"onStatus",a=>{_.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(a))),a&&a.command&&("onAudioPacketReceived"===a.command&&this.emit("event",vi.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===a.command&&this.emit("event",vi.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===a.command&&(this.errorCode=Bs.SRC_TOKEN_EXPIRED,this.state=gn.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===a.command&&(this.errorCode=Bs.DEST_TOKEN_EXPIRED,this.state=gn.RELAY_STATE_FAILURE))}),T(this,"onReconnect",y(function*(){_.debug("[".concat(s.clientId,"] ChannelMediaSocket disconnect, reconnecting")),s.emit("event",vi.NETWORK_DISCONNECTED),s.state=gn.RELAY_STATE_IDLE,s.prevChannelMediaConfig&&s.sendStartRelayMessage(s.prevChannelMediaConfig).catch(a=>{s.state!==gn.RELAY_STATE_IDLE&&(_.error("auto restart channel media relay failed",a.toString()),s.errorCode=Bs.SERVER_CONNECTION_LOST,s.state=gn.RELAY_STATE_FAILURE)})})),this.joinInfo=e,this.clientId=n,this.sid=xs(),this.signal=new N5(this.joinInfo,this.clientId,r),this.httpRetryConfig=i,this._resolution=o}startChannelMediaRelay(e){var n=this;return y(function*(){if(n.state!==gn.RELAY_STATE_IDLE)throw new N(v.INVALID_OPERATION);n.state=gn.RELAY_STATE_CONNECTING,yield n.connect(),_.debug("[".concat(n.clientId,"] startChannelMediaRelay: connect success"));try{yield n.sendStartRelayMessage(e)}catch(r){throw r.data&&r.data.serverResponse&&"SetSourceChannel"===r.data.serverResponse.command?new N(v.CROSS_CHANNEL_FAILED_JOIN_SRC):r.data&&r.data.serverResponse&&"SetDestChannelStatus"===r.serverResponse.command?new N(v.CROSS_CHANNEL_FAILED_JOIN_DEST):r.data&&r.data.serverResponse&&"StartPacketTransfer"===r.serverResponse.command?new N(v.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):r}n.prevChannelMediaConfig=e})()}updateChannelMediaRelay(e){var n=this;return y(function*(){if(n.state!==gn.RELAY_STATE_RUNNING)throw new N(v.INVALID_OPERATION);yield n.sendUpdateMessage(e),n.prevChannelMediaConfig=e})()}setVideoProfile(e){var n=this;return y(function*(){if(n._resolution=e,n.state!==gn.RELAY_STATE_RUNNING)throw new N(v.INVALID_OPERATION);const r=n.genMessage(un.SetVideoProfile);yield n.signal.request(r),_.debug("[".concat(n.clientId,"] startChannelMediaRelay: setVideoProfile success"))})()}stopChannelMediaRelay(){var e=this;return y(function*(){yield e.sendStopRelayMessage(),_.debug("[".concat(e.clientId,"] stopChannelMediaRelay: send stop message success")),e.state=gn.RELAY_STATE_IDLE,e.dispose()})()}dispose(){_.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=hn.CancelToken.source(),this.state=gn.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}connect(){var e=this;return y(function*(){const n=yield function L3(t,e,n){return mm.apply(this,arguments)}(e.joinInfo,e.cancelToken.token,e.httpRetryConfig);e.workerToken=n.workerToken,yield e.signal.connect(n.addressList),e.emit("event",vi.NETWORK_CONNECTED),e.signal.on("status",e.onStatus),e.signal.on("reconnecting",e.onReconnect)})()}sendStartRelayMessage(e){var n=this;return y(function*(){const r=n.genMessage(un.StopPacketTransfer);yield n.signal.request(r),yield n.signal.waitStatus("Normal Quit"),_.debug("[".concat(n.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const i=n.genMessage(un.SetSdkProfile,e);yield n.signal.request(i),_.debug("[".concat(n.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const o=n.genMessage(un.SetSourceChannel,e);yield n.signal.request(o),yield n.signal.waitStatus("SetSourceChannelStatus"),n.emit("event",vi.PACKET_JOINED_SRC_CHANNEL),_.debug("[".concat(n.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const s=n.genMessage(un.SetSourceUserId,e);yield n.signal.request(s),_.debug("[".concat(n.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const a=n.genMessage(un.SetDestChannel,e);yield n.signal.request(a),yield n.signal.waitStatus("SetDestChannelStatus"),n.emit("event",vi.PACKET_JOINED_DEST_CHANNEL),_.debug("[".concat(n.clientId,"] startChannelMediaRelay: SetDestChannel success"));const c=n.genMessage(un.StartPacketTransfer,e);yield n.signal.request(c),n.emit("event",vi.PACKET_SENT_TO_DEST_CHANNEL),n.state=gn.RELAY_STATE_RUNNING,_.debug("[".concat(n.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),n.setVideoProfile(n._resolution)})()}sendUpdateMessage(e){var n=this;return y(function*(){const r=n.genMessage(un.UpdateDestChannel,e);yield n.signal.request(r),n.emit("event",vi.PACKET_UPDATE_DEST_CHANNEL),_.debug("[".concat(n.clientId,"] sendUpdateMessage: UpdateDestChannel success"))})()}sendStopRelayMessage(){var e=this;return y(function*(){const n=e.genMessage(un.StopPacketTransfer);yield e.signal.request(n),_.debug("[".concat(e.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))})()}genMessage(e,n){const r=[],i=[],o=[];this.requestId+=1;const s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:tr,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.22.2"===s.sdkVersion&&(s.sdkVersion="0.0.1");let a=null,c=null;switch(e){case un.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case un.SetSourceChannel:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new N(v.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},s;case un.SetSourceUserId:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new N(v.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:c.uid+""},s;case un.SetDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new N(v.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{r.push(d.channelName),i.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"SetDestChannel",channelName:r,uid:i,token:o},s;case un.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case un.Reconnect:return s.clientRequest={command:"Reconnect"},s;case un.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case un.UpdateDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new N(v.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{r.push(d.channelName),i.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"UpdateDestChannel",channelName:r,uid:i,token:o},s;case un.SetVideoProfile:s.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return s}}const P5={name:"ChannelMediaRelay",create:function(t){return new D5(t.joinInfo,t.clientId,t.websocketRetryConfig||Se,t.httpRetryConfig||Se,t.resolution)}};function Zw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Qc(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Zw(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Zw(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class L5 extends Zt{constructor(e,n,r,i){super(),T(this,"spec",void 0),T(this,"token",void 0),T(this,"websocket",void 0),T(this,"pingpongTimer",void 0),T(this,"reconnectMode","retry"),T(this,"serviceMode",void 0),T(this,"reqId",0),T(this,"commandReqId",0),T(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),T(this,"handleWebSocketMessage",o=>{if(!o.data)return;const s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):(Q.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===ti.TRANSCODE?1:2}),this.emit(to.PUBLISH_STREAM_STATUS,s))}),this.spec=n,this.token=e,this.serviceMode=i,this.websocket=new uc("live-streaming",r),this.websocket.on(ct.CONNECTED,this.handleWebSocketOpen),this.websocket.on(ct.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(ct.REQUEST_NEW_URLS,(o,s)=>{He(this,to.REQUEST_NEW_ADDRESS).then(o).catch(s)}),this.websocket.on(ct.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}request(e,n,r,i){var o=this;return y(function*(){o.reqId+=1,"request"===e&&(o.commandReqId+=1);const s=o.commandReqId,a=o.reqId;if(!a||!o.websocket)throw new N(v.UNEXPECTED_ERROR);const c=Qc({command:e,sdkVersion:"4.22.2"===tr?"0.0.1":tr,seq:a,requestId:a,allocate:r,cname:o.spec.cname,appId:o.spec.appId,sid:o.spec.sid,uid:o.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if("closed"===o.websocket.state)throw new N(v.WS_DISCONNECT);const d=()=>new H((h,S)=>{o.websocket.once(ct.CLOSED,()=>S(new N(v.WS_ABORT))),o.websocket.once(ct.CONNECTED,h)});"connected"!==o.websocket.state&&(yield d()),c.clientRequest&&(c.clientRequest.workerToken=o.token);const u=new H((h,S)=>{const m=()=>{S(new N(v.WS_ABORT))};o.websocket.once(ct.RECONNECTING,m),o.websocket.once(ct.CLOSED,m),o.once("@".concat(a,"-").concat(o.spec.sid),f=>{h(f)})});i&&Q.workerEvent(o.spec.sid,Qc(Qc({},i),{},{requestId:s,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const l=Date.now();o.websocket.sendMessage(c);let p=null;try{p=yield u}catch(h){if("closed"===o.websocket.state)throw h;return yield d(),yield o.request(e,n,r)}return i&&Q.workerEvent(o.spec.sid,Qc(Qc({},i),{},{requestId:s,actionType:"response",payload:JSON.stringify(p.serverResponse),serverCode:p.code,success:200===p.code,responseTime:Date.now()-l})),200!==p.code&&o.handleResponseError(p),p})()}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.22.2"===tr?"0.0.1":tr;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case Ce.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void _.warning("live stream response already exists stream");case Ce.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Ce.LIVE_STREAM_RESPONSE_BAD_STREAM:case Ce.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new N(v.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Ce.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===e.serverResponse.command)return;throw new N(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Ce.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new N(v.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Ce.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new N(v.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(to.WARNING,n,e.serverResponse.url)}case Ce.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new N(v.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(to.WARNING,n,e.serverResponse.url)}case Ce.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new N(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Ce.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new N(v.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Ce.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new N(v.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(to.WARNING,n,e.serverResponse.url)}case Ce.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new N(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Ce.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new N(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Ce.LIVE_STREAM_RESPONSE_WORKER_LOST:case Ce.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===e.serverResponse.command)return;throw new N(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Ce.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===e.serverResponse.command)return;if("UpdateTranscoding"===e.serverResponse.command||"ControlStream"===e.serverResponse.command)return new N(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new N(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Ce.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Ce.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Ce.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Ce.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new N(v.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(Au)},6e3)}}function $w(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}function Sn(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?$w(Object(n),!0).forEach(function(r){T(t,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):$w(Object(n)).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(n,r))})}return t}class k5 extends Zt{constructor(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Se,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Se;super(),T(this,"onLiveStreamWarning",void 0),T(this,"onLiveStreamError",void 0),T(this,"spec",void 0),T(this,"retryTimeout",1e4),T(this,"connection",void 0),T(this,"httpRetryConfig",void 0),T(this,"wsRetryConfig",void 0),T(this,"streamingTasks",new Map),T(this,"isStartingStreamingTask",!1),T(this,"taskMutex",new Je("live-streaming")),T(this,"cancelToken",hn.CancelToken.source()),T(this,"transcodingConfig",void 0),T(this,"uapResponse",void 0),T(this,"lastTaskId",1),T(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=r,this.wsRetryConfig=n}setTranscodingConfig(e){var n=this;return y(function*(){const r=Sn(Sn({},Fj),e);var a;66!==r.videoCodecProfile&&77!==r.videoCodecProfile&&100!==r.videoCodecProfile&&(_.debug("[".concat(n.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(r.videoCodecProfile," -> 100")),r.videoCodecProfile=100),r.transcodingUsers||(r.transcodingUsers=r.userConfigs),r.transcodingUsers&&(r.transcodingUsers=r.transcodingUsers.map(a=>Sn(Sn(Sn({},Vj),a),{},{zOrder:a.zOrder?a.zOrder+1:1}))),Qt((a=r).width)||Mt(a.width,"config.width",0,1e4),Qt(a.height)||Mt(a.height,"config.height",0,1e4),Qt(a.videoBitrate)||Mt(a.videoBitrate,"config.videoBitrate",1,1e6),Qt(a.videoFrameRate)||Mt(a.videoFrameRate,"config.videoFrameRate"),Qt(a.lowLatency)||Si(a.lowLatency,"config.lowLatency"),Qt(a.audioSampleRate)||be(a.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Qt(a.audioBitrate)||Mt(a.audioBitrate,"config.audioBitrate",1,128),Qt(a.audioChannels)||be(a.audioChannels,"config.audioChannels",[1,2,3,4,5]),Qt(a.videoGop)||Mt(a.videoGop,"config.videoGop"),Qt(a.videoCodecProfile)||be(a.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Qt(a.userCount)||Mt(a.userCount,"config.userCount",0,17),Qt(a.backgroundColor)||Mt(a.backgroundColor,"config.backgroundColor",0,16777215),Qt(a.userConfigExtraInfo)||ke(a.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),a.transcodingUsers&&!Qt(a.transcodingUsers)&&(Ri(a.transcodingUsers,"config.transcodingUsers"),a.transcodingUsers.forEach((c,d)=>{Lu(c.uid),Qt(c.x)||Mt(c.x,"transcodingUser[".concat(d,"].x"),0,1e4),Qt(c.y)||Mt(c.y,"transcodingUser[".concat(d,"].y"),0,1e4),Qt(c.width)||Mt(c.width,"transcodingUser[".concat(d,"].width"),0,1e4),Qt(c.height)||Mt(c.height,"transcodingUser[".concat(d,"].height"),0,1e4),Qt(c.zOrder)||Mt(c.zOrder-1,"transcodingUser[".concat(d,"].zOrder"),0,100),Qt(c.alpha)||Mt(c.alpha,"transcodingUser[".concat(d,"].alpha"),0,1,!1)})),Qt(a.watermark)||Z_(a.watermark,"watermark"),Qt(a.backgroundImage)||Z_(a.backgroundImage,"backgroundImage"),a.images&&!Qt(a.images)&&(Ri(a.images,"config.images"),a.images.forEach((c,d)=>{Z_(c,"images[".concat(d,"]"))}));const i=[];r.images&&i.push(...r.images.map(a=>Sn(Sn(Sn({},Q_),a),{},{zOrder:255}))),r.backgroundImage&&(i.push(Sn(Sn(Sn({},Q_),r.backgroundImage),{},{zOrder:0})),delete r.backgroundImage),r.watermark&&(i.push(Sn(Sn(Sn({},Q_),r.watermark),{},{zOrder:255})),delete r.watermark),r.images=i,r.transcodingUsers&&(r.userConfigs=r.transcodingUsers.map(a=>Sn({},a)),r.userCount=r.transcodingUsers.length,delete r.transcodingUsers);const o=(r.userConfigs||[]).map(a=>"number"==typeof a.uid?H.resolve(a.uid):Kb(a.uid,n.spec,n.cancelToken.token,n.httpRetryConfig));if((yield H.all(o)).forEach((a,c)=>{r.userConfigs&&r.userConfigs[c]&&(r.userConfigs[c].uid=a)}),n.transcodingConfig=r,n.connection)try{var s;const a=yield n.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:n.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Ci(s=n.streamingTasks).call(s)).map(c=>c.taskId).join("#")});_.debug("[".concat(n.spec.clientId,"] update live transcoding config success, code: ").concat(a.code,", config:"),JSON.stringify(n.transcodingConfig))}catch(a){if(!a.data||!a.data.retry)throw a;a.data.changeAddress&&n.connection.tryNextAddress(),n.streamingTasks.forEach(c=>{_.warning("[".concat(n.spec.clientId,"] live streaming receive error"),a.toString(),"try to republish",c.url),n.startLiveStreamingTask(c.url,c.mode,a).then(()=>{_.debug("[".concat(n.spec.clientId,"] live streaming republish ").concat(c.url," success"))}).catch(d=>{_.error("[".concat(n.spec.clientId,"] live streaming republish failed"),c.url,d.toString()),n.onLiveStreamError&&n.onLiveStreamError(c.url,d)})})}})()}startLiveStreamingTask(e,n,r){var i=this;return y(function*(){if(!i.transcodingConfig&&n===ti.TRANSCODE)throw new N(v.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const o={command:"PublishStream",ts:Date.now(),url:e,uid:i.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};_.debug("[".concat(i.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(n));const s=yield i.taskMutex.lock();if(!i.connection&&r)return void s();if(i.streamingTasks.get(e)&&!r)return s(),new N(v.LIVE_STREAMING_TASK_CONFLICT).throw();try{i.connection||(i.connection=yield i.connect(n))}catch(c){throw s(),c}n===ti.TRANSCODE&&(o.transcodingConfig=Sn({},i.transcodingConfig)),i.uapResponse&&i.uapResponse.vid&&(o.vid=i.uapResponse.vid),i.isStartingStreamingTask=!0;const a=i.lastTaskId++;try{const c=new H((u,l)=>{Me(i.retryTimeout).then(()=>{if(r)return l(r);const p=i.statusError.get(e);return p?(i.statusError.delete(e),l(p)):void 0})}),d=yield H.race([i.connection.request("request",{clientRequest:o},!0,{url:e,command:"PublishStream",workerType:n===ti.TRANSCODE?1:2,requestByUser:!r,tid:a.toString()}),c]);i.isStartingStreamingTask=!1,_.debug("[".concat(i.spec.clientId,"] live streaming started, code: ").concat(d.code)),i.streamingTasks.set(e,{clientRequest:o,mode:n,url:e,taskId:a}),s()}catch(c){if(s(),i.isStartingStreamingTask=!1,!c.data||!c.data.retry||r)throw c;return c.data.changeAddress?(i.connection.tryNextAddress(),yield i.startLiveStreamingTask(e,n,c)):yield i.startLiveStreamingTask(e,n,c)}})()}stopLiveStreamingTask(e){return new H((n,r)=>{const i=this.streamingTasks.get(e);if(!i||!this.connection)return new N(v.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=i.mode;i.abortTask=()=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),n()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:i.url}},!1,{url:e,command:"UnPublishStream",workerType:o===ti.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(e),0===this.streamingTasks.size&&(this.connection&&this.connection.close(),this.connection=void 0),n()}).catch(r)})}resetAllTask(){var e;const n=Array.from(Ci(e=this.streamingTasks).call(e));this.terminate();for(const r of n)this.startLiveStreamingTask(r.url,r.mode).catch(i=>{this.onLiveStreamError&&this.onLiveStreamError(r.url,i)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=hn.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}connect(e){var n=this;return y(function*(){if(n.connection)throw new N(v.UNEXPECTED_ERROR,"live streaming connection has already connected");const r=yield He(n,$_.REQUEST_WORKER_MANAGER_LIST,e);return n.uapResponse=r,n.connection=new L5(r.workerToken,n.spec,n.wsRetryConfig,e),n.connection.on(to.WARNING,(i,o)=>n.onLiveStreamWarning&&n.onLiveStreamWarning(o,i)),n.connection.on(to.PUBLISH_STREAM_STATUS,i=>n.handlePublishStreamServer(i)),n.connection.on(to.REQUEST_NEW_ADDRESS,(i,o)=>{if(!n.connection)return o(new N(v.UNEXPECTED_ERROR,"can not get new live streaming address list"));He(n,$_.REQUEST_WORKER_MANAGER_LIST,e).then(s=>{n.uapResponse=s,i(s.addressList)}).catch(o)}),yield n.connection.init(r.addressList),n.connection})()}handlePublishStreamServer(e){const n=e.serverStatus&&e.serverStatus.url||"empty_url",r=this.streamingTasks.get(n),i=e.reason;switch(e.code){case Ce.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Ce.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Ce.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Ce.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const s=new N(v.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(r)return _.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,s);if(!this.isStartingStreamingTask)return;this.statusError.set(n,s)}case Ce.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const s=new N(v.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,i);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,s)}case Ce.LIVE_STREAM_RESPONSE_WORKER_LOST:case Ce.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();const s=Array.from(Ci(o=this.streamingTasks).call(o));for(const a of s)a.abortTask?a.abortTask():(_.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new N(v.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{_.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{_.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}hasUrl(e){return this.streamingTasks.has(e)}}const M5={name:"LiveStreaming",create:function(t){return new k5(t.joinInfo,t.websocketRetryConfig||Se,t.httpRetryConfig||Se)}};function V5(t){let e={};t:for(;!rN(t);){let n=Ei(t);switch(n>>>3){case 0:break t;case 1:e.requestId=iN(t,Ei(t));break;case 2:e.requestType=Ei(t)>>>0;break;case 3:e.scorePorn=lf(t);break;case 4:e.scoreSexy=lf(t);break;case 5:e.scoreNeutral=lf(t);break;case 6:e.requestScene=Ei(t)>>>0;break;case 7:e.scene=Ei(t)>>>0;break;default:tN(t,7&n)}}return e}function F5(t,e){let n=t.service;void 0!==n&&(wt(e,8),wt(e,n));let r=t.vendor;void 0!==r&&(wt(e,16),wt(e,r));let i=t.token;void 0!==i&&(wt(e,26),_i(e,i));let o=t.callbackUrl;void 0!==o&&(wt(e,34),_i(e,o))}function B5(t){let e=Ei(t),n=t.limit;return t.limit=t.offset+e,n}function tN(t,e){switch(e){case 0:for(;128&oN(t););break;case 2:df(t,Ei(t));break;case 5:df(t,4);break;case 1:df(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let j5=new Float32Array(1);new Uint8Array(j5.buffer);let cf=new Float64Array(1),Rn=new Uint8Array(cf.buffer);function ya(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let eN=[];function nN(){const t=eN.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function G5(t){eN.push(t)}function df(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function rN(t){return t.offset>=t.limit}function Ca(t,e){let n=t.bytes,r=t.offset,i=t.limit,o=r+e;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),t.bytes=s}return t.offset=o,o>i&&(t.limit=o),r}function uf(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function iN(t,e){let n=uf(t,e),r=String.fromCharCode,i=t.bytes,o="\ufffd",s="";for(let a=0;a<e;a++){let c,d,u,l,p=i[a+n];128&p?192==(224&p)?a+1>=e?s+=o:(c=i[a+n+1],128!=(192&c)?s+=o:(l=(31&p)<<6|63&c,l<128?s+=o:(s+=r(l),a++))):224==(240&p)?a+2>=e?s+=o:(c=i[a+n+1],d=i[a+n+2],32896!=(49344&(c|d<<8))?s+=o:(l=(15&p)<<12|(63&c)<<6|63&d,l<2048||l>=55296&&l<=57343?s+=o:(s+=r(l),a+=2))):240==(248&p)?a+3>=e?s+=o:(c=i[a+n+1],d=i[a+n+2],u=i[a+n+3],8421504!=(12632256&(c|d<<8|u<<16))?s+=o:(l=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&u,l<65536||l>1114111?s+=o:(l-=65536,s+=r(55296+(l>>10),56320+(1023&l)),a+=3))):s+=o:s+=r(p)}return s}function _i(t,e){let n=e.length,r=0;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),r+=a<128?1:a<2048?2:a<65536?3:4}wt(t,r);let i=Ca(t,r),o=t.bytes;for(let s=0;s<n;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[i++]=a:(a<2048?o[i++]=a>>6&31|192:(a<65536?o[i++]=a>>12&15|224:(o[i++]=a>>18&7|240,o[i++]=a>>12&63|128),o[i++]=a>>6&63|128),o[i++]=63&a|128)}}function W5(t,e){let n=Ca(t,e.limit),r=t.bytes,i=e.bytes;for(let o=0,s=e.limit;o<s;o++)r[o+n]=i[o]}function oN(t){return t.bytes[uf(t,1)]}function sN(t,e){let n=Ca(t,1);t.bytes[n]=e}function lf(t){let e=uf(t,8),n=t.bytes;return Rn[0]=n[e++],Rn[1]=n[e++],Rn[2]=n[e++],Rn[3]=n[e++],Rn[4]=n[e++],Rn[5]=n[e++],Rn[6]=n[e++],Rn[7]=n[e++],cf[0]}function pf(t,e){let n=Ca(t,8),r=t.bytes;cf[0]=e,r[n++]=Rn[0],r[n++]=Rn[1],r[n++]=Rn[2],r[n++]=Rn[3],r[n++]=Rn[4],r[n++]=Rn[5],r[n++]=Rn[6],r[n++]=Rn[7]}function Ei(t){let e,n=0,r=0;do{e=oN(t),n<32&&(r|=(127&e)<<n),n+=7}while(128&e);return r}function wt(t,e){for(e>>>=0;e>=128;)sN(t,127&e|128),e>>>=7;sN(t,e)}function go(t,e){let n=e.low>>>0,r=(e.low>>>28|e.high<<4)>>>0,i=e.high>>>24,o=0===i?0===r?n<16384?n<128?1:2:n<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:i<128?9:10,s=Ca(t,o),a=t.bytes;switch(o){case 10:a[s+9]=i>>>7&1;case 9:a[s+8]=9!==o?128|i:127&i;case 8:a[s+7]=8!==o?r>>>21|128:r>>>21&127;case 7:a[s+6]=7!==o?r>>>14|128:r>>>14&127;case 6:a[s+5]=6!==o?r>>>7|128:r>>>7&127;case 5:a[s+4]=5!==o?128|r:127&r;case 4:a[s+3]=4!==o?n>>>21|128:n>>>21&127;case 3:a[s+2]=3!==o?n>>>14|128:n>>>14&127;case 2:a[s+1]=2!==o?n>>>7|128:n>>>7&127;case 1:a[s]=1!==o?128|n:127&n}}function aN(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable})),n.push.apply(n,r)}return n}const H5=new Map([["moderation",1],["supervise",2]]);function cN(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}class K5 extends Zt{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(De.CONNECTION_STATE_CHANGE,n,e)}get inspectType(){return this._inspectType}set inspectType(e){var n;this._inspectMode=Nr(n=e.map(r=>H5.get(r)||0)).call(n,(r,i)=>r+i),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),T(this,"name","AgoraRTCVideoContentInspect"),T(this,"_connectionState",_r.CONNECTING),T(this,"_innerConnectionState",void 0),T(this,"sequence",0),T(this,"inspectStartTime",void 0),T(this,"workerManagerConnection",void 0),T(this,"workerConnection",void 0),T(this,"workerMessageLengthLimit",void 0),T(this,"inspectIntervalMinimum",void 0),T(this,"qualityRatio",void 0),T(this,"_connectInfo",void 0),T(this,"_cancelTokenSource",hn.CancelToken.source()),T(this,"_retryConfig",void 0),T(this,"wmSequence",0),T(this,"inspectInterval",void 0),T(this,"inspectTimer",null),T(this,"ossFilePrefix",void 0),T(this,"extraInfo",void 0),T(this,"_inspectType",void 0),T(this,"_inspectMode",void 0),T(this,"_quality",1),T(this,"qualityTimer",null),T(this,"_inspectId",void 0),T(this,"_needWorkUrlOnly",!1),T(this,"inspectImage",()=>{if(this.connectionState!==_r.CONNECTED)throw new N(v.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===_r.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=Ft(5,"inspect-"),this.workerMessageLengthLimit=A("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=A("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=A("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new uc("worker-manager-"+this._inspectId,Se),this.on(De.STATE_CHANGE,(n,r)=>{this._innerConnectionState=n,_.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Er[n]," ").concat(r||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new uc("worker-"+this._inspectId,Se),this.handleWorkerEvents()}init(e,n){var r=this;return y(function*(){r.emit(De.STATE_CHANGE,Er.CONNECT_AP),r._connectInfo=e;const i=r._cancelTokenSource.token;return r._retryConfig=n,new H((o,s)=>{r.on(De.CONNECTION_STATE_CHANGE,(a,c)=>{c===_r.CONNECTED&&o()}),r.requestAP(e,i,n).then(a=>{r.connectWorkerManager(a)}).catch(a=>{s(a)})})})()}requestAP(e,n,r){var i=this;return y(function*(){const o=A("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),s=yield function(c,d,u,l){let{appId:p,areaCode:h,cname:S,sid:m,token:f,uid:g}=d;la++;const R="image_moderation_api",C={service_name:R,json_body:JSON.stringify({appId:p,areaCode:h,cname:S,command:"allocateEdge",requestId:la,seq:la,sid:m,token:f,ts:Date.now(),uid:g+""})};let b,w,D=c[0];return Mr(y(function*(){b=Date.now();const V=yield Fr(D,{data:C,cancelToken:u,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(w=Date.now()-b,0!==V.code){const $=new N(v.UNEXPECTED_RESPONSE,"image inspect ap error, code"+V.code,{retry:!0,responseTime:w});throw _.error($.toString()),$}const U=JSON.parse(V.json_body);if(200!==U.code){const $=new N(v.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(U.code,", reason: ").concat(U.reason),{code:U.code,responseTime:w});throw _.error($.toString()),$}if(!U.servers||!Array.isArray(U.servers)||0===U.servers.length){const $=new N(v.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:U.code,responseTime:w});throw _.error($.toString()),$}const k=A("VIDEO_INSPECT_WORKER_MANAGER_HOST"),Z=A("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:U.servers.map($=>{let{address:Rt,wss:Nt}=$;if(Rt&&Nt)return"wss://".concat(Rt.replace(/\./g,"-"),".").concat(k,":").concat(Z||Nt)}).filter($=>!!$),workerToken:U.workerToken,vid:U.vid,responseTime:w}}),(V,U)=>(Q.apworkerEvent(m,{success:!0,sc:200,serviceName:R,responseDetail:JSON.stringify(V.addressList),firstSuccess:0===U,responseTime:w,serverIp:c[U%c.length]}),!1),(V,U)=>(Q.apworkerEvent(m,{success:!1,sc:V.data&&V.data.code||200,serviceName:R,responseTime:w,serverIp:c[U%c.length]}),!!(V.code!==v.OPERATION_ABORTED&&V.code!==v.UNEXPECTED_RESPONSE||V.data&&V.data.retry)&&(D=c[(U+1)%c.length],!0)),l)}(o,e,n,r);i.emit(De.STATE_CHANGE,Er.AP_CONNECTED);const{addressList:a}=s;return i.wmSequence++,a})()}connectWorkerManager(e){var n=arguments,r=this;return y(function*(){r._needWorkUrlOnly=n.length>1&&void 0!==n[1]&&n[1],r.emit(De.STATE_CHANGE,Er.CONNECT_WORKER_MANAGER),yield r.workerManagerConnection.init(e,1e4)})()}connectWorker(e){var n=this;return y(function*(){yield n.workerConnection.init([e])})()}handleWorkerManagerEvents(){var e=this;this.workerManagerConnection.on(ct.CONNECTED,y(function*(){e.emit(De.STATE_CHANGE,Er.WORKER_MANAGER_CONNECTED,e.workerManagerConnection.url),e.workerManagerConnection.sendMessage({appId:e._connectInfo.appId,cname:e._connectInfo.cname,uid:e._connectInfo.uid+"",sdkVersion:"4.22.2",sid:e._connectInfo.sid,seq:e.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(ct.CLOSED,()=>{this._innerConnectionState<Er.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(ct.FAILED,()=>{this._innerConnectionState<Er.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(ct.RECONNECTING,()=>{this._innerConnectionState<Er.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(ct.ON_MESSAGE,function(){var n=y(function*(r){e.emit(De.STATE_CHANGE,Er.GET_WORKER_MANAGER_RESPONSE);const i=e.workerManagerConnection.url;e.workerManagerConnection.close();const o=JSON.parse(r.data);if(200!==o.code)throw _.error("[".concat(e._inspectId,"] Unexpected code ").concat(o.code," from worker manager")),new N(v.UNEXPECTED_RESPONSE,"response code of worker is unexpected",o);if(!(o.serverResponse&&o.serverResponse.portWss&&i))throw _.error("[".concat(e._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(o))),new N(v.UNEXPECTED_RESPONSE,"response content of worker is unexpected",o);{const s=A("VIDEO_INSPECT_WORKER_PORT")||o.serverResponse.portWss,a=i.replace(/:\d+\/?$/,":".concat(s));e.emit(De.STATE_CHANGE,Er.CONNECT_WORKER,a),e._needWorkUrlOnly?e.emit(De.REQUEST_NEW_WORKER_URL,a):yield e.connectWorker(a)}});return function(r){return n.apply(this,arguments)}}()),this.workerManagerConnection.on(ct.WILL_RECONNECT,(n,r,i)=>{i(n)}),this.workerManagerConnection.on(ct.REQUEST_NEW_URLS,(n,r)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n).catch(r)})}handleWorkerEvents(){var e=this;this.workerConnection.on(ct.CONNECTED,y(function*(){e.emit(De.STATE_CHANGE,Er.WORKER_CONNECTED,e.workerConnection.url),e.connectionState=_r.CONNECTED})),this.workerConnection.on(ct.ON_MESSAGE,function(){var n=y(function*(r){if(r.data instanceof ArrayBuffer){const o=function x5(t){return function(n){let r={};t:for(;!rN(n);){let i=Ei(n);switch(i>>>3){case 0:break t;case 1:r.code=Ei(n);break;case 2:r.msg=iN(n,Ei(n));break;case 3:{let o=B5(n);r.data=V5(n),n.limit=o;break}default:tN(n,7&i)}}return r}({bytes:e=t,offset:0,limit:e.length});var e}(new Uint8Array(r.data));if(A("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&_.debug("[".concat(e._inspectId,"] Response message for worker of inspect content "),JSON.stringify(o)),200===o.code){if(Array.isArray(e.inspectType)&&1===e.inspectType.length&&"supervise"===e.inspectType[0])return void e.emit(De.INSPECT_RESULT,void 0,void 0);if(o.data&&o.data.scorePorn&&o.data.scoreSexy&&o.data.scoreNeutral){var i;const s={porn:o.data.scorePorn,sexy:o.data.scoreSexy,neutral:o.data.scoreNeutral},a=Nr(i=Object.keys(s)).call(i,(d,u)=>s[d]>s[u]?d:u,"porn"),c=Object.keys(s).find(d=>d===a);e.emit(De.INSPECT_RESULT,c)}else e.emit(De.INSPECT_RESULT,void 0,new N(v.UNEXPECTED_RESPONSE,o.code+"","There is an unexpected data on message"))}else e.emit(De.INSPECT_RESULT,void 0,new N(v.UNEXPECTED_RESPONSE,o.code+"",o.msg))}else _.error("[".concat(e._inspectId,"] Unexpected message type from worker")),e.emit(De.INSPECT_RESULT,void 0,new N(v.UNEXPECTED_RESPONSE,"invalid worker message type"))});return function(r){return n.apply(this,arguments)}}()),this.workerConnection.on(ct.CLOSED,()=>{this.connectionState=_r.CLOSED}),this.workerConnection.on(ct.FAILED,()=>{this.connectionState=_r.CLOSED}),this.workerConnection.on(ct.RECONNECTING,()=>{this.connectionState=this.connectionState===_r.CONNECTED?_r.RECONNECTING:_r.CONNECTING}),this.workerConnection.on(ct.WILL_RECONNECT,(n,r,i)=>{"recover"===n&&i(n),i("tryNext")}),this.workerConnection.on(ct.REQUEST_NEW_URLS,(n,r)=>{this.workerManagerConnection.close(),this.once(De.REQUEST_NEW_WORKER_URL,i=>{n([i])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(i=>{this.connectWorkerManager(i,!0)}).catch(i=>{r(i)})})}requestToInspectImage(){var e=this;return y(function*(){e.sequence++;const n=$n(e,De.CLIENT_LOCAL_VIDEO_TRACK),r={appId:e._connectInfo.appId,cname:e._connectInfo.cname,cid:e._connectInfo.cid,sid:e._connectInfo.sid,uid:e._connectInfo.uid,vid:e._connectInfo.vid};if(n){if(!n.isPlaying)return void e.emit(De.INSPECT_RESULT,void 0,new N(v.INVALID_OPERATION,"Only the track being played can be inspected"));const i=yield e.generateRequestData(n,r);e.workerConnection.sendMessage(i,!0,!0)}else e.emit(De.INSPECT_RESULT,void 0,new N(v.INVALID_OPERATION,"Only the track being published can be inspected"))})()}generateRequestData(e,n){var r=this;return y(function*(){let{appId:i,cname:o,cid:s,vid:a,sid:c,uid:d}=n;const u=Date.now(),l=yield e.getCurrentFrameImage("image/jpeg",r.quality),p=yield jI(l,i,o),h=r.sequence+"-"+s+"-"+d+"-"+u+"-"+Ft(12,""),S={appId:i,cid:s,cname:o,deviceId:"",elapse:cN(Number(u-r.inspectStartTime)),fileSize:p.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:p,networkType:6,osType:7,requestId:h,sdkVersion:"4.22.2",sequence:r.sequence,sid:c,timestamp:cN(u),uid:d,vid:a,service:r._inspectMode,callbackData:r.extraInfo,ossFilePrefix:r.ossFilePrefix};void 0===r.extraInfo&&delete S.callbackData,void 0===r.ossFilePrefix&&delete S.ossFilePrefix;const m=function U5(t){let e=nN();return function(n,r){let i=n.appId;void 0!==i&&(wt(r,10),_i(r,i));let o=n.cid;void 0!==o&&(wt(r,16),wt(r,o));let s=n.cname;void 0!==s&&(wt(r,26),_i(r,s));let a=n.deviceId;void 0!==a&&(wt(r,34),_i(r,a));let c=n.elapse;void 0!==c&&(wt(r,40),go(r,c));let d=n.fileSize;void 0!==d&&(wt(r,48),go(r,ya(d)));let u=n.height;void 0!==u&&(wt(r,56),go(r,ya(u)));let l=n.jpg;void 0!==l&&(wt(r,66),wt(r,l.length),function(wr,M){let B=Ca(wr,M.length);wr.bytes.set(M,B)}(r,l));let p=n.networkType;void 0!==p&&(wt(r,72),go(r,ya(p)));let h=n.osType;void 0!==h&&(wt(r,80),go(r,ya(h)));let S=n.requestId;void 0!==S&&(wt(r,90),_i(r,S));let m=n.sdkVersion;void 0!==m&&(wt(r,98),_i(r,m));let f=n.sequence;void 0!==f&&(wt(r,104),go(r,ya(f)));let g=n.sid;void 0!==g&&(wt(r,114),_i(r,g));let R=n.timestamp;void 0!==R&&(wt(r,120),go(r,R));let C=n.uid;void 0!==C&&(wt(r,128),wt(r,C));let b=n.vid;void 0!==b&&(wt(r,136),wt(r,b));let w=n.width;void 0!==w&&(wt(r,144),go(r,ya(w)));let D=n.service;void 0!==D&&(wt(r,152),wt(r,D));let V=n.callbackData;void 0!==V&&(wt(r,162),_i(r,V));let U=n.jpgEncryption;void 0!==U&&(wt(r,168),wt(r,U));let k=n.requestType;void 0!==k&&(wt(r,176),wt(r,k));let Z=n.scorePorn;void 0!==Z&&(wt(r,185),pf(r,Z));let $=n.scoreSexy;void 0!==$&&(wt(r,193),pf(r,$));let Rt=n.scoreNeutral;void 0!==Rt&&(wt(r,201),pf(r,Rt));let Nt=n.scene;void 0!==Nt&&(wt(r,208),wt(r,Nt));let oe=n.ossFilePrefix;void 0!==oe&&(wt(r,218),_i(r,oe));let Yt=n.serviceVendor;if(void 0!==Yt)for(let wr of Yt){wt(r,226);let M=nN();F5(wr,M),wt(r,M.limit),W5(r,M),G5(M)}}(t,e),function(n){let r=n.bytes,i=n.limit;return r.length===i?r:r.subarray(0,i)}(e)}(S);if(m.byteLength<r.workerMessageLengthLimit){if(A("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const f=function(g){for(var R=1;R<arguments.length;R++){var C=null!=arguments[R]?arguments[R]:{};R%2?aN(Object(C),!0).forEach(function(b){T(g,b,C[b])}):Object.getOwnPropertyDescriptors?Object.defineProperties(g,Object.getOwnPropertyDescriptors(C)):aN(Object(C)).forEach(function(b){Object.defineProperty(g,b,Object.getOwnPropertyDescriptor(C,b))})}return g}({},S);delete f.jpg,_.debug("[".concat(r._inspectId,"] Request message for worker of inspect content "),JSON.stringify(f))}return m}return r.quality=r.quality*r.qualityRatio,yield r.generateRequestData(e,{appId:i,cname:o,cid:s,vid:a,sid:c,uid:d})})()}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=hn.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=_r.CLOSED,this.emit(De.STATE_CHANGE,Er.CLOSED)}}const Y5={name:"ContentInspect",create:function(t){let{config:e}=t;return function(n){if(!n)throw new N(v.INVALID_PARAMS,"inspectConfig is necessary.");if(!n.inspectType||!Array.isArray(n.inspectType))throw new N(v.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const r=[...new Set(n.inspectType)];r.forEach(i=>{var o;if(!W(o=["supervise","moderation"]).call(o,i))throw new N(v.INVALID_PARAMS,"".concat(i," is not a valid inspect type."))}),n.inspectType=r}if(n&&n.extraInfo&&n.extraInfo.length>1024)throw new N(v.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(e),new K5(e)}};Ut("PROCESS_ID","process-".concat(Ft(8,""),"-").concat(Ft(4,""),"-").concat(Ft(4,""),"-").concat(Ft(4,""),"-").concat(Ft(12,""))),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),n=Date.now();_.debug("Loading global parameters from cache",e),Object.keys(e).forEach(r=>{if(Object.prototype.hasOwnProperty.call(ce,r)){const{value:i,expires:o}=e[r];if(o&&o<=n)return;$i[r]=i,ce[r]=i}})}catch(e){_.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray($i.AREAS)&&$i.AREAS.length>0&&rm($i.AREAS,!0);const dN=(t,e,n)=>{_.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),Ut(t,e,n)};wc(P5,!1),wc(M5,!1),wc(mW,!1),wc(Y5,!1),wc(w5,!1);const Re=function(t){const e=new Zt,n=t,r={getListeners:e.getListeners.bind(e),on:(i,o)=>(i===ei.SECURITY_POLICY_VIOLATION&&dw(o,!0),e.on.bind(e)(i,o)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return cw(cw({},n),r)}({__TRACK_LIST__:Zs,VERSION:tr,BUILD:W_,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:dN,getParameter:A,getSupportedCodec:function(){var t=y(function*(){let e={audio:[],video:[]};try{let n=new RTCPeerConnection;const r=yield(i=y(function*(o){let s;return St().supportUnifiedPlan?(o.addTransceiver("video",{direction:"recvonly"}),o.addTransceiver("audio",{direction:"recvonly"}),s=(yield o.createOffer()).sdp):s=(yield o.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,s}),function(o){return i.apply(this,arguments)})(n);if(!r)return e;n.close(),n=null,e=function(i){const o={video:[],audio:[]};return i.match(/ VP8/i)&&o.video.push("VP8"),i.match(/ VP9/i)&&o.video.push("VP9"),i.match(/ AV1/i)&&o.video.push("AV1"),i.match(/ H264/i)&&o.video.push("H264"),i.match(/ H265/i)&&o.video.push("H265"),i.match(/ opus/i)&&o.audio.push("OPUS"),i.match(/ PCMU/i)&&o.audio.push("PCMU"),i.match(/ PCMA/i)&&o.audio.push("PCMA"),i.match(/ G722/i)&&o.audio.push("G722"),o}(r)}catch(n){throw new N(v.CREATE_OFFER_FAILED,n.toString&&n.toString()).print()}var i;return e});return function(){return t.apply(this,arguments)}}(),checkSystemRequirements:function(){const t=Q.reportApiInvoke(null,{name:ye.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:ne.TRACER});let e=!1;try{const o=window.RTCPeerConnection,s=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,a=window.WebSocket;e=!!(o&&s&&a),e&&N_()&&My(75)&&(new o).close()}catch(o){return _.error("check system requirement failed: ",o),!1}let n=!1;const r=Tt();r.name===It.CHROME&&Number(r.version)>=58&&("WebKit"!==kr.engine.name||function(){const o=Tt();if(Ru()){if(o.os===we.MAC_OS)return!0;if(o.os===we.IOS){const s=kr.os.version&&kr.os.version.split(".");if(s&&14===Number(s[0])&&s[1]&&Number(s[1])>=3||s&&Number(s[0])>14)return!0}}return!1}())&&(n=!0),(r.name===It.FIREFOX&&Number(r.version)>=56||r.name===It.OPERA&&Number(r.version)>=45||r.name===It.SAFARI&&Number(r.version)>=11||"WebKit"===r.name&&(an()||pr())&&r.osVersion&&Number(r.osVersion.split(".")[0])>=11||Wy()||Tt().name===It.QQ)&&(n=!0),_.debug("checkSystemRequirements, api:",e,"browser",n);const i=e&&n;return t.onSuccess(i),i},getDevices:function(t){return Gn.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return Gn.getRecordingDevices(t)},getCameras:function(t){return Gn.getCamerasDevices(t)},getElectronScreenSources:wI,getPlaybackDevices:function(t){return Gn.getSpeakers(t)},createClient:function(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=Ft(5,"client-"),r=Q.reportApiInvoke(null,{id:n,name:ye.CREATE_CLIENT,options:[e],tag:ne.TRACER});try{be((i=e).codec,"config.codec",["vp8","vp9","av1","h264","h265"]),be(i.mode,"config.mode",["rtc","live","p2p"]),void 0!==i.audioCodec&&be(i.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==i.proxyServer&&ke(i.proxyServer,"config.proxyServer",1,1e4),void 0!==i.turnServer&&Qy(i.turnServer),void 0!==i.httpRetryConfig&&Xy(i.httpRetryConfig),void 0!==i.websocketRetryConfig&&Xy(i.websocketRetryConfig)}catch(i){throw r.onError(i),i}var i;return(Vy(16,0,!0)||Fy(16,0,!0))&&("vp9"===e.codec&&(e.codec="vp8",_.debug("browser not support vp9, force use vp8")),Ut("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===e.audioCodec&&(e.audioCodec="opus"),r.onSuccess(),new fW(Ar(Ar({forceWaitGatewayResponse:!0},e),{},{role:W(t=["rtc","p2p"]).call(t,e.mode)?"host":e.role||"audience"}),n)},createCameraVideoTrack:function(){var t=y(function*(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const n=A("CAMERA_CAPTURE_CONFIG"),r=Ft(8,"track-cam-"),i=Q.reportApiInvoke(null,{id:r,tag:ne.TRACER,name:ye.CREATE_CAM_VIDEO_TRACK,options:[zt({},e),n]});n&&(e.encoderConfig=n);const o=Ju(e);let s=null;_.info("start create camera video track with config",JSON.stringify(e),"trackId",r);try{s=(yield jn({video:o},r)).getVideoTracks()[0]||null}catch(c){throw i.onError(c),c}if(!s){const c=new P(v.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(c),c.throw(_)}e.optimizationMode&&YE(r,s,e,ri(e.encoderConfig));const a=new KE(s,e,o,e.scalabiltyMode?Ku(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return i.onSuccess(a.getTrackId()),_.info("create camera video success, trackId:",r),a});return function(){return t.apply(this,arguments)}}(),createCustomVideoTrack:function(t){const e=Ft(8,"track-cus-"),n=Q.reportApiInvoke(null,{id:e,tag:ne.TRACER,name:ye.CREATE_CUSTOM_VIDEO_TRACK,options:[t]}),r=new Kt(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Ku(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,e,[Bt.CUSTOM_TRACK]);return n.onSuccess(r.getTrackId()),_.info("create custom video track success with config",t,"trackId",r.getTrackId()),r},createScreenVideoTrack:function(){var t=y(function*(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"disable";const r="object"==typeof n?FI(h=n):void 0;var h;r&&(n="auto");const i=Ft(8,"track-scr-v-"),o=Q.reportApiInvoke(null,{id:i,tag:ne.TRACER,name:ye.CREATE_SCREEN_VIDEO_TRACK,options:[zt({},e),n]});e.encoderConfig?"string"==typeof e.encoderConfig||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const s=function(h){const S={};h.screenSourceType&&(S.mediaSource=h.screenSourceType),h.extensionId&&Ji()&&(S.extensionId=h.extensionId);const{displaySurface:m,selfBrowserSurface:f,surfaceSwitching:g,systemAudio:R}=h;(O_(107)||Uy(107)||By(93))&&(m&&(be(m,"displaySurface",["browser","window","monitor"]),S.displaySurface=m),f?(be(f,"selfBrowserSurface",["exclude","include"]),S.selfBrowserSurface=f):S.selfBrowserSurface="include",g&&(be(g,"surfaceSwitching",["exclude","include"]),S.surfaceSwitching=g)),(O_(105)||Uy(105)||By(91))&&R&&(be(R,"systemAudio",["exclude","include"]),S.systemAudio=R),h.electronScreenSourceId&&(S.sourceId=h.electronScreenSourceId);const C=h.encoderConfig?wE(h.encoderConfig):null;return S.mandatory={chromeMediaSource:"desktop",maxWidth:C?C.width:void 0,maxHeight:C?C.height:void 0},C&&(C.frameRate&&("number"==typeof C.frameRate?(S.mandatory.maxFrameRate=C.frameRate,S.mandatory.minFrameRate=C.frameRate):(S.mandatory.maxFrameRate=C.frameRate.max||C.frameRate.ideal||C.frameRate.exact||void 0,S.mandatory.minFrameRate=C.frameRate.min||C.frameRate.ideal||C.frameRate.exact||void 0),S.frameRate=C.frameRate),C.width&&(S.width=C.width),C.height&&(S.height=C.height)),S}(e);let a=null,c=null;const d=St();if(!d.supportShareAudio&&"enable"===n){const h=new P(v.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return o.onError(h),h.throw(_)}_.info("start create screen video track with config",e,"withAudio",n,"trackId",i);const u=d.supportShareAudio&&"disable"!==n;try{const h=yield jn({screen:s,screenAudio:u?r||!0:void 0},i);a=h.getVideoTracks()[0]||null,c=h.getAudioTracks()[0]||null}catch(h){throw o.onError(h),h}if(!a){const h=new P(v.UNEXPECTED_ERROR,"can not find track in media stream");return o.onError(h),h.throw(_)}if(!c&&"enable"===n){a&&a.stop();const h=new P(v.SHARE_AUDIO_NOT_ALLOWED);return o.onError(h),h.throw(_)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(YE(i,a,e,e.encoderConfig&&wE(e.encoderConfig)||void 0),e.encoderConfig&&"string"!=typeof e.encoderConfig&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const l=new Kt(a,e.encoderConfig?wE(e.encoderConfig):{},e.scalabiltyMode?Ku(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,i,[Bt.SCREEN_TRACK]);if(!c)return o.onSuccess(l.getTrackId()),_.info("create screen video track success","video:",l.getTrackId()),l;const p=new ie(c,void 0,Ft(8,"track-scr-a-"),!1);return o.onSuccess([l.getTrackId(),p.getTrackId()]),_.info("create screen video track success","video:",l.getTrackId(),"audio:",p.getTrackId()),[l,p]});return function(){return t.apply(this,arguments)}}(),createMicrophoneAndCameraTracks:function(){var t=y(function*(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=A("CAMERA_CAPTURE_CONFIG"),i=Ft(8,"track-mic-"),o=Ft(8,"track-cam-"),s=Q.reportApiInvoke(null,{id:"".concat(i,"-").concat(o),tag:ne.TRACER,name:ye.CREATE_MIC_AND_CAM_TRACKS,options:[e,n,r]});r&&(n.encoderConfig=r);const a=Ju(n),c=BI(e);let d=null,u=null;_.info("start create camera video track(".concat(o,") and microphone audio track(").concat(i,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(n)));try{const h=yield jn({audio:c,video:a},"".concat(i,"-").concat(o));d=h.getAudioTracks()[0],u=h.getVideoTracks()[0]}catch(h){throw s.onError(h),h}if(!d||!u){const h=new P(v.UNEXPECTED_ERROR,"can not find tracks in media stream");return s.onError(h),h.throw(_)}n.optimizationMode&&YE(o,u,n,ri(n.encoderConfig));const l=new Xu(d,e,c,i),p=new KE(u,n,a,n.scalabiltyMode?Ku(n.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},n.optimizationMode,o);return s.onSuccess([l.getTrackId(),p.getTrackId()]),_.info("create camera video track(".concat(o,") and microphone audio track(").concat(i,") success")),[l,p]});return function(){return t.apply(this,arguments)}}(),createMicrophoneAudioTrack:function(){var t=y(function*(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const n=Ft(8,"track-mic-"),r=Q.reportApiInvoke(null,{id:n,tag:ne.TRACER,name:ye.CREATE_MIC_AUDIO_TRACK,options:[e]}),i=BI(e);let o=null;_.info("start create microphone audio track with config",JSON.stringify(e),"trackId",n);try{o=(yield jn({audio:i},n)).getAudioTracks()[0]||null}catch(a){throw r.onError(a),a}if(!o){const a=new P(v.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(a),a.throw(_)}const s=new Xu(o,e,i,n);return r.onSuccess(s.getTrackId()),_.info("create microphone audio track success, trackId:",n),s});return function(){return t.apply(this,arguments)}}(),createCustomAudioTrack:function(t){const e=Ft(8,"track-cus-"),n=Q.reportApiInvoke(null,{id:e,tag:ne.TRACER,name:ye.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),r=new ie(t.mediaStreamTrack,t.encoderConfig?Yu(t.encoderConfig):{},e,!1);return _.info("create custom audio track success with config",t,"trackId",r.getTrackId()),n.onSuccess(r.getTrackId()),r},createBufferSourceAudioTrack:function(){var t=y(function*(e){var n;const{cacheOnlineFile:r,encoderConfig:i}=e;let{source:o}=e;const s={source:o instanceof AudioBuffer?"AudioBuffer":o instanceof File?null!==(n=File.name)&&void 0!==n?n:"File":o,cacheOnlineFile:r,encoderConfig:i},a=Ft(8,"track-buf-"),c=Q.reportApiInvoke(null,{id:a,tag:ne.TRACER,name:ye.CREATE_BUFFER_AUDIO_TRACK,options:[s]});if(A("DISABLE_WEBAUDIO"))throw new P(v.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");_.info("start create buffer source audio track with config",JSON.stringify(s),"trackId",a);const d=o;if(!(o instanceof AudioBuffer))try{o=yield(p=y(function*(h,S){let m=null;if("string"==typeof h){const g=AA.get(h);if(g)return _.debug("use cached audio resource: ",h),g;try{m=(yield Mr(()=>hn.get(h,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(R){throw new P(v.FETCH_AUDIO_FILE_FAILED,R.toString())}}else m=yield new H((R,C)=>{const b=new FileReader;b.onload=w=>{w.target?R(w.target.result):C(new P(v.READ_LOCAL_AUDIO_FILE_ERROR))},b.onerror=()=>{C(new P(v.READ_LOCAL_AUDIO_FILE_ERROR))},b.readAsArrayBuffer(h)});const f=yield function(g){const R=ia();return new H((C,b)=>{R.decodeAudioData(g,w=>{C(w)},w=>{b(new P(v.DECODE_AUDIO_FILE_FAILED,w.toString()))})})}(m);return"string"==typeof h&&S&&AA.set(h,f),f}),function(h,S){return p.apply(this,arguments)})(o,r)}catch(p){return c.onError(p),p.throw(_)}var p;const u=new S3(o),l=new T3(d,u,i?Yu(i):{},a);return _.info("create buffer source audio track success, trackId:",a),c.onSuccess(l.getTrackId()),l});return function(n){return t.apply(this,arguments)}}(),setAppType:function(t){if(_.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw _.debug("Invalid appType"),new N(v.INVALID_PARAMS,"invalid app type",t);Ut("APP_TYPE",Math.floor(t))},setLogLevel:function(t){_.setLogLevel(t)},enableLogUpload:function(){A("USE_NEW_LOG")?Ut("UPLOAD_LOG",!0):_.enableLogUpload()},disableLogUpload:function(){A("USE_NEW_LOG")?Ut("UPLOAD_LOG",!1):_.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new DO},checkAudioTrackIsActive:function(){var t=y(function*(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const r=Q.reportApiInvoke(null,{tag:ne.TRACER,name:ye.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof ie||e instanceof aa)){const d=new N(v.INVALID_TRACK,"the parameter is not a audio track");return r.onError(d),d.throw()}n&&n<1e3&&(n=1e3);const i=e instanceof ie?e.getTrackLabel():"remote_track",o=e.getVolumeLevel();let s=o,a=o;const c=Date.now();return new H(d=>{const u=setInterval(()=>{const l=e.getVolumeLevel();s=l>s?l:s,a=l<a?l:a;const p=s-a>1e-4,h=Date.now()-c;if(p||h>n){clearInterval(u);const S=p,m={duration:h,deviceLabel:i,maxVolumeLevel:s,result:S};_.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(m))),r.onSuccess(m),d(S)}},200)})});return function(n){return t.apply(this,arguments)}}(),checkVideoTrackIsActive:function(){var t=y(function*(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const r=Q.reportApiInvoke(null,{tag:ne.TRACER,name:ye.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof Kt||e instanceof sa)){const p=new N(v.INVALID_TRACK,"the parameter is not a video track");return r.onError(p),p.throw()}n&&n<1e3&&(n=1e3);const i=e instanceof Kt?e.getTrackLabel():"remote_track",o=e.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(Ge()||Ru())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([o]),s.play();const a=document.createElement("canvas");a.width=160,a.height=120;let c=0,d=0;try{const p=Date.now();c=yield function(h,S,m){let g,R=0,C=null;return new H((b,w)=>{setTimeout(()=>{g&&(g(),b(R))},S),g=kE(()=>{!function D(){R>4&&g&&(g(),b(R));const V=m.getContext("2d");if(!V){const Z=new N(v.UNEXPECTED_ERROR,"can not get canvas 2d context.");return _.error(Z.toString()),void w(Z)}V.drawImage(h,0,0,160,120);const U=V.getImageData(0,0,m.width,m.height),k=Math.floor(U.data.length/3);if(C){for(let Z=0;Z<k;Z+=3)if(U.data[Z]!==C[Z])return R+=1,void(C=U.data);C=U.data}else C=U.data}()},30)})}(s,n,a),d=Date.now()-p}catch(p){throw r.onError(p),p}nW===It.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;const u=c>4,l={duration:d,changedPicNum:c,deviceLabel:i,result:u};return _.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),r.onSuccess(l),u});return function(n){return t.apply(this,arguments)}}(),setArea:rm,audioElementPlayCenter:_n,resumeAudioContext:function(){_n.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(t){TW.processExternalMediaAEC(t)},registerExtensions:function(t){const e=A("PLUGIN_INFO")||[];t.forEach(n=>{"name"in n&&!W(e).call(e,n.name)&&e.push(n.name);const r=n;r.__registered__=!0,r.logger.hookLog=_.extLog,r.reporter.hookApiInvoke=Q.extApiInvoke,r.parameters&&Object.keys(r.parameters).forEach(i=>{r.parameters[i]=A(i)})}),dN("PLUGIN_INFO",e)},ChannelMediaRelayError:Bs,ChannelMediaRelayEvent:vi,ChannelMediaRelayState:gn,RemoteStreamFallbackType:p3,RemoteStreamType:l3,ConnectionDisconnectedReason:Ot,AudienceLatencyLevelType:KB,AREAS:vt,preload:function(){var t=y(function*(e,n,r,i){return t0(e,n,r,i)});return function(n,r,i,o){return t.apply(this,arguments)}}()});return Object.defineProperties(Re,{onAudioAutoplayFailed:{get:()=>Wn.onAudioAutoplayFailed,set:t=>{Wn.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>Wn.onAutoplayFailed,set:t=>{Wn.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Re._onSecurityPolicyViolation,set(t){Re._onSecurityPolicyViolation=t,dw(t)}},__CLIENT_LIST__:{get:()=>A("SHOW_GLOBAL_CLIENT_LIST")?Uo:[]}}),Gn.on(Go.CAMERA_DEVICE_CHANGED,t=>{_.info("camera device changed",JSON.stringify(t)),Re.onCameraChanged&&Re.onCameraChanged(t),Re.safeEmit(ei.CAMERA_CHANGED,t)}),Gn.on(Go.RECORDING_DEVICE_CHANGED,t=>{_.info("microphone device changed",JSON.stringify(t)),Re.onMicrophoneChanged&&Re.onMicrophoneChanged(t),Re.safeEmit(ei.MICROPHONE_CHANGED,t)}),Gn.on(Go.PLAYOUT_DEVICE_CHANGED,t=>{_.debug("playout device changed",JSON.stringify(t)),Re.onPlaybackDeviceChanged&&Re.onPlaybackDeviceChanged(t),Re.safeEmit(ei.PLAYBACK_DEVICE_CHANGED,t)}),_n.onAutoplayFailed=()=>{_.info("detect audio element autoplay failed"),Wn.onAudioAutoplayFailed&&Wn.onAudioAutoplayFailed()},Dt.on("autoplay-failed",()=>{_.info("detect webaudio autoplay failed"),Wn.onAudioAutoplayFailed&&Wn.onAudioAutoplayFailed(),Re.safeEmit(ei.AUTOPLAY_FAILED)}),Dt.on(Ve.STATE_CHANGE,(t,e)=>{_.info("audio context state changed: ".concat(e," => ").concat(t)),Re.onAudioContextStateChanged&&Re.onAudioContextStateChanged(t,e),Re.safeEmit(ei.AUDIO_CONTEXT_STATE_CHANGED,t,e)}),_e.on(Ms.NETWORK_STATE_CHANGE,(t,e)=>{_.info("[network-indicator] network state changed, ".concat(e," => ").concat(t))}),window&&(window.__ARTC__=Re),Re}()},293:is=>{function Fl(y,os,cr,Wt,te,fi,ki){try{var Mi=y[fi](ki),Kr=Mi.value}catch(jl){return void cr(jl)}Mi.done?os(Kr):Promise.resolve(Kr).then(Wt,te)}is.exports=function Bl(y){return function(){var os=this,cr=arguments;return new Promise(function(Wt,te){var fi=y.apply(os,cr);function ki(Kr){Fl(fi,Wt,te,ki,Mi,"next",Kr)}function Mi(Kr){Fl(fi,Wt,te,ki,Mi,"throw",Kr)}ki(void 0)})}},is.exports.__esModule=!0,is.exports.default=is.exports}}]);